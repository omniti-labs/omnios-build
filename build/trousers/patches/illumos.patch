diff -ru trousers-0.3.8-orig/aclocal.m4 trousers-0.3.8/aclocal.m4
--- trousers-0.3.8-orig/aclocal.m4	2011-12-24 06:19:31.000000000 +0000
+++ trousers-0.3.8/aclocal.m4	2012-02-14 20:34:56.439021918 +0000
@@ -13,8 +13,8 @@
 
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
-m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.67],,
-[m4_warning([this file was generated for autoconf 2.67.
+m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.68],,
+[m4_warning([this file was generated for autoconf 2.68.
 You have another version of autoconf.  It may work, but is not guaranteed to.
 If you have problems, you may need to regenerate the build system entirely.
 To do so, use the procedure documented by the package, typically `autoreconf'.])])
@@ -22,7 +22,8 @@
 # libtool.m4 - Configure libtool for the host system. -*-Autoconf-*-
 #
 #   Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005,
-#                 2006, 2007, 2008 Free Software Foundation, Inc.
+#                 2006, 2007, 2008, 2009, 2010 Free Software Foundation,
+#                 Inc.
 #   Written by Gordon Matzigkeit, 1996
 #
 # This file is free software; the Free Software Foundation gives
@@ -31,7 +32,8 @@
 
 m4_define([_LT_COPYING], [dnl
 #   Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005,
-#                 2006, 2007, 2008 Free Software Foundation, Inc.
+#                 2006, 2007, 2008, 2009, 2010 Free Software Foundation,
+#                 Inc.
 #   Written by Gordon Matzigkeit, 1996
 #
 #   This file is part of GNU Libtool.
@@ -58,7 +60,7 @@
 # 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 ])
 
-# serial 56 LT_INIT
+# serial 57 LT_INIT
 
 
 # LT_PREREQ(VERSION)
@@ -87,6 +89,7 @@
 # ------------------
 AC_DEFUN([LT_INIT],
 [AC_PREREQ([2.58])dnl We use AC_INCLUDES_DEFAULT
+AC_REQUIRE([AC_CONFIG_AUX_DIR_DEFAULT])dnl
 AC_BEFORE([$0], [LT_LANG])dnl
 AC_BEFORE([$0], [LT_OUTPUT])dnl
 AC_BEFORE([$0], [LTDL_INIT])dnl
@@ -103,6 +106,8 @@
 AC_REQUIRE([LTOBSOLETE_VERSION])dnl
 m4_require([_LT_PROG_LTMAIN])dnl
 
+_LT_SHELL_INIT([SHELL=${CONFIG_SHELL-/bin/sh}])
+
 dnl Parse OPTIONS
 _LT_SET_OPTIONS([$0], [$1])
 
@@ -139,7 +144,7 @@
     *) break;;
   esac
 done
-cc_basename=`$ECHO "X$cc_temp" | $Xsed -e 's%.*/%%' -e "s%^$host_alias-%%"`
+cc_basename=`$ECHO "$cc_temp" | $SED "s%.*/%%; s%^$host_alias-%%"`
 ])
 
 
@@ -159,6 +164,9 @@
 m4_defun([_LT_SETUP],
 [AC_REQUIRE([AC_CANONICAL_HOST])dnl
 AC_REQUIRE([AC_CANONICAL_BUILD])dnl
+AC_REQUIRE([_LT_PREPARE_SED_QUOTE_VARS])dnl
+AC_REQUIRE([_LT_PROG_ECHO_BACKSLASH])dnl
+
 _LT_DECL([], [host_alias], [0], [The host system])dnl
 _LT_DECL([], [host], [0])dnl
 _LT_DECL([], [host_os], [0])dnl
@@ -181,10 +189,13 @@
 dnl
 m4_require([_LT_FILEUTILS_DEFAULTS])dnl
 m4_require([_LT_CHECK_SHELL_FEATURES])dnl
+m4_require([_LT_PATH_CONVERSION_FUNCTIONS])dnl
 m4_require([_LT_CMD_RELOAD])dnl
 m4_require([_LT_CHECK_MAGIC_METHOD])dnl
+m4_require([_LT_CHECK_SHAREDLIB_FROM_LINKLIB])dnl
 m4_require([_LT_CMD_OLD_ARCHIVE])dnl
 m4_require([_LT_CMD_GLOBAL_SYMBOLS])dnl
+m4_require([_LT_WITH_SYSROOT])dnl
 
 _LT_CONFIG_LIBTOOL_INIT([
 # See if we are running on zsh, and set the options which allow our
@@ -200,7 +211,6 @@
 _LT_CHECK_OBJDIR
 
 m4_require([_LT_TAG_COMPILER])dnl
-_LT_PROG_ECHO_BACKSLASH
 
 case $host_os in
 aix3*)
@@ -214,23 +224,6 @@
   ;;
 esac
 
-# Sed substitution that helps us do robust quoting.  It backslashifies
-# metacharacters that are still active within double-quoted strings.
-sed_quote_subst='s/\([["`$\\]]\)/\\\1/g'
-
-# Same as above, but do not quote variable references.
-double_quote_subst='s/\([["`\\]]\)/\\\1/g'
-
-# Sed substitution to delay expansion of an escaped shell variable in a
-# double_quote_subst'ed string.
-delay_variable_subst='s/\\\\\\\\\\\$/\\\\\\$/g'
-
-# Sed substitution to delay expansion of an escaped single quote.
-delay_single_quote_subst='s/'\''/'\'\\\\\\\'\''/g'
-
-# Sed substitution to avoid accidental globbing in evaled expressions
-no_glob_subst='s/\*/\\\*/g'
-
 # Global variables:
 ofile=libtool
 can_build_shared=yes
@@ -271,6 +264,28 @@
 ])# _LT_SETUP
 
 
+# _LT_PREPARE_SED_QUOTE_VARS
+# --------------------------
+# Define a few sed substitution that help us do robust quoting.
+m4_defun([_LT_PREPARE_SED_QUOTE_VARS],
+[# Backslashify metacharacters that are still active within
+# double-quoted strings.
+sed_quote_subst='s/\([["`$\\]]\)/\\\1/g'
+
+# Same as above, but do not quote variable references.
+double_quote_subst='s/\([["`\\]]\)/\\\1/g'
+
+# Sed substitution to delay expansion of an escaped shell variable in a
+# double_quote_subst'ed string.
+delay_variable_subst='s/\\\\\\\\\\\$/\\\\\\$/g'
+
+# Sed substitution to delay expansion of an escaped single quote.
+delay_single_quote_subst='s/'\''/'\'\\\\\\\'\''/g'
+
+# Sed substitution to avoid accidental globbing in evaled expressions
+no_glob_subst='s/\*/\\\*/g'
+])
+
 # _LT_PROG_LTMAIN
 # ---------------
 # Note that this code is called both from `configure', and `config.status'
@@ -423,7 +438,7 @@
 # declaration there will have the same value as in `configure'.  VARNAME
 # must have a single quote delimited value for this to work.
 m4_define([_LT_CONFIG_STATUS_DECLARE],
-[$1='`$ECHO "X$][$1" | $Xsed -e "$delay_single_quote_subst"`'])
+[$1='`$ECHO "$][$1" | $SED "$delay_single_quote_subst"`'])
 
 
 # _LT_CONFIG_STATUS_DECLARATIONS
@@ -433,7 +448,7 @@
 # embedded single quotes properly.  In configure, this macro expands
 # each variable declared with _LT_DECL (and _LT_TAGDECL) into:
 #
-#    <var>='`$ECHO "X$<var>" | $Xsed -e "$delay_single_quote_subst"`'
+#    <var>='`$ECHO "$<var>" | $SED "$delay_single_quote_subst"`'
 m4_defun([_LT_CONFIG_STATUS_DECLARATIONS],
 [m4_foreach([_lt_var], m4_quote(lt_decl_all_varnames),
     [m4_n([_LT_CONFIG_STATUS_DECLARE(_lt_var)])])])
@@ -532,12 +547,20 @@
 LTCFLAGS='$LTCFLAGS'
 compiler='$compiler_DEFAULT'
 
+# A function that is used when there is no print builtin or printf.
+func_fallback_echo ()
+{
+  eval 'cat <<_LTECHO_EOF
+\$[]1
+_LTECHO_EOF'
+}
+
 # Quote evaled strings.
 for var in lt_decl_all_varnames([[ \
 ]], lt_decl_quote_varnames); do
-    case \`eval \\\\\$ECHO "X\\\\\$\$var"\` in
+    case \`eval \\\\\$ECHO \\\\""\\\\\$\$var"\\\\"\` in
     *[[\\\\\\\`\\"\\\$]]*)
-      eval "lt_\$var=\\\\\\"\\\`\\\$ECHO \\"X\\\$\$var\\" | \\\$Xsed -e \\"\\\$sed_quote_subst\\"\\\`\\\\\\""
+      eval "lt_\$var=\\\\\\"\\\`\\\$ECHO \\"\\\$\$var\\" | \\\$SED \\"\\\$sed_quote_subst\\"\\\`\\\\\\""
       ;;
     *)
       eval "lt_\$var=\\\\\\"\\\$\$var\\\\\\""
@@ -548,9 +571,9 @@
 # Double-quote double-evaled strings.
 for var in lt_decl_all_varnames([[ \
 ]], lt_decl_dquote_varnames); do
-    case \`eval \\\\\$ECHO "X\\\\\$\$var"\` in
+    case \`eval \\\\\$ECHO \\\\""\\\\\$\$var"\\\\"\` in
     *[[\\\\\\\`\\"\\\$]]*)
-      eval "lt_\$var=\\\\\\"\\\`\\\$ECHO \\"X\\\$\$var\\" | \\\$Xsed -e \\"\\\$double_quote_subst\\" -e \\"\\\$sed_quote_subst\\" -e \\"\\\$delay_variable_subst\\"\\\`\\\\\\""
+      eval "lt_\$var=\\\\\\"\\\`\\\$ECHO \\"\\\$\$var\\" | \\\$SED -e \\"\\\$double_quote_subst\\" -e \\"\\\$sed_quote_subst\\" -e \\"\\\$delay_variable_subst\\"\\\`\\\\\\""
       ;;
     *)
       eval "lt_\$var=\\\\\\"\\\$\$var\\\\\\""
@@ -558,16 +581,38 @@
     esac
 done
 
-# Fix-up fallback echo if it was mangled by the above quoting rules.
-case \$lt_ECHO in
-*'\\\[$]0 --fallback-echo"')dnl "
-  lt_ECHO=\`\$ECHO "X\$lt_ECHO" | \$Xsed -e 's/\\\\\\\\\\\\\\\[$]0 --fallback-echo"\[$]/\[$]0 --fallback-echo"/'\`
-  ;;
-esac
-
 _LT_OUTPUT_LIBTOOL_INIT
 ])
 
+# _LT_GENERATED_FILE_INIT(FILE, [COMMENT])
+# ------------------------------------
+# Generate a child script FILE with all initialization necessary to
+# reuse the environment learned by the parent script, and make the
+# file executable.  If COMMENT is supplied, it is inserted after the
+# `#!' sequence but before initialization text begins.  After this
+# macro, additional text can be appended to FILE to form the body of
+# the child script.  The macro ends with non-zero status if the
+# file could not be fully written (such as if the disk is full).
+m4_ifdef([AS_INIT_GENERATED],
+[m4_defun([_LT_GENERATED_FILE_INIT],[AS_INIT_GENERATED($@)])],
+[m4_defun([_LT_GENERATED_FILE_INIT],
+[m4_require([AS_PREPARE])]dnl
+[m4_pushdef([AS_MESSAGE_LOG_FD])]dnl
+[lt_write_fail=0
+cat >$1 <<_ASEOF || lt_write_fail=1
+#! $SHELL
+# Generated by $as_me.
+$2
+SHELL=\${CONFIG_SHELL-$SHELL}
+export SHELL
+_ASEOF
+cat >>$1 <<\_ASEOF || lt_write_fail=1
+AS_SHELL_SANITIZE
+_AS_PREPARE
+exec AS_MESSAGE_FD>&1
+_ASEOF
+test $lt_write_fail = 0 && chmod +x $1[]dnl
+m4_popdef([AS_MESSAGE_LOG_FD])])])# _LT_GENERATED_FILE_INIT
 
 # LT_OUTPUT
 # ---------
@@ -577,20 +622,11 @@
 AC_DEFUN([LT_OUTPUT],
 [: ${CONFIG_LT=./config.lt}
 AC_MSG_NOTICE([creating $CONFIG_LT])
-cat >"$CONFIG_LT" <<_LTEOF
-#! $SHELL
-# Generated by $as_me.
-# Run this file to recreate a libtool stub with the current configuration.
-
-lt_cl_silent=false
-SHELL=\${CONFIG_SHELL-$SHELL}
-_LTEOF
+_LT_GENERATED_FILE_INIT(["$CONFIG_LT"],
+[# Run this file to recreate a libtool stub with the current configuration.])
 
 cat >>"$CONFIG_LT" <<\_LTEOF
-AS_SHELL_SANITIZE
-_AS_PREPARE
-
-exec AS_MESSAGE_FD>&1
+lt_cl_silent=false
 exec AS_MESSAGE_LOG_FD>>config.log
 {
   echo
@@ -616,7 +652,7 @@
 m4_ifset([AC_PACKAGE_VERSION], [ AC_PACKAGE_VERSION])
 configured by $[0], generated by m4_PACKAGE_STRING.
 
-Copyright (C) 2008 Free Software Foundation, Inc.
+Copyright (C) 2010 Free Software Foundation, Inc.
 This config.lt script is free software; the Free Software Foundation
 gives unlimited permision to copy, distribute and modify it."
 
@@ -661,15 +697,13 @@
 # appending to config.log, which fails on DOS, as config.log is still kept
 # open by configure.  Here we exec the FD to /dev/null, effectively closing
 # config.log, so it can be properly (re)opened and appended to by config.lt.
-if test "$no_create" != yes; then
-  lt_cl_success=:
-  test "$silent" = yes &&
-    lt_config_lt_args="$lt_config_lt_args --quiet"
-  exec AS_MESSAGE_LOG_FD>/dev/null
-  $SHELL "$CONFIG_LT" $lt_config_lt_args || lt_cl_success=false
-  exec AS_MESSAGE_LOG_FD>>config.log
-  $lt_cl_success || AS_EXIT(1)
-fi
+lt_cl_success=:
+test "$silent" = yes &&
+  lt_config_lt_args="$lt_config_lt_args --quiet"
+exec AS_MESSAGE_LOG_FD>/dev/null
+$SHELL "$CONFIG_LT" $lt_config_lt_args || lt_cl_success=false
+exec AS_MESSAGE_LOG_FD>>config.log
+$lt_cl_success || AS_EXIT(1)
 ])# LT_OUTPUT
 
 
@@ -732,15 +766,12 @@
   # if finds mixed CR/LF and LF-only lines.  Since sed operates in
   # text mode, it properly converts lines to CR/LF.  This bash problem
   # is reportedly fixed, but why not run on old versions too?
-  sed '/^# Generated shell functions inserted here/q' "$ltmain" >> "$cfgfile" \
-    || (rm -f "$cfgfile"; exit 1)
+  sed '$q' "$ltmain" >> "$cfgfile" \
+     || (rm -f "$cfgfile"; exit 1)
 
-  _LT_PROG_XSI_SHELLFNS
+  _LT_PROG_REPLACE_SHELLFNS
 
-  sed -n '/^# Generated shell functions inserted here/,$p' "$ltmain" >> "$cfgfile" \
-    || (rm -f "$cfgfile"; exit 1)
-
-  mv -f "$cfgfile" "$ofile" ||
+   mv -f "$cfgfile" "$ofile" ||
     (rm -f "$ofile" && cp "$cfgfile" "$ofile" && rm -f "$cfgfile")
   chmod +x "$ofile"
 ],
@@ -846,11 +877,13 @@
 AU_DEFUN([AC_LIBTOOL_F77], [LT_LANG(Fortran 77)])
 AU_DEFUN([AC_LIBTOOL_FC], [LT_LANG(Fortran)])
 AU_DEFUN([AC_LIBTOOL_GCJ], [LT_LANG(Java)])
+AU_DEFUN([AC_LIBTOOL_RC], [LT_LANG(Windows Resource)])
 dnl aclocal-1.4 backwards compatibility:
 dnl AC_DEFUN([AC_LIBTOOL_CXX], [])
 dnl AC_DEFUN([AC_LIBTOOL_F77], [])
 dnl AC_DEFUN([AC_LIBTOOL_FC], [])
 dnl AC_DEFUN([AC_LIBTOOL_GCJ], [])
+dnl AC_DEFUN([AC_LIBTOOL_RC], [])
 
 
 # _LT_TAG_COMPILER
@@ -955,6 +988,31 @@
 	[lt_cv_ld_exported_symbols_list=no])
 	LDFLAGS="$save_LDFLAGS"
     ])
+    AC_CACHE_CHECK([for -force_load linker flag],[lt_cv_ld_force_load],
+      [lt_cv_ld_force_load=no
+      cat > conftest.c << _LT_EOF
+int forced_loaded() { return 2;}
+_LT_EOF
+      echo "$LTCC $LTCFLAGS -c -o conftest.o conftest.c" >&AS_MESSAGE_LOG_FD
+      $LTCC $LTCFLAGS -c -o conftest.o conftest.c 2>&AS_MESSAGE_LOG_FD
+      echo "$AR cru libconftest.a conftest.o" >&AS_MESSAGE_LOG_FD
+      $AR cru libconftest.a conftest.o 2>&AS_MESSAGE_LOG_FD
+      echo "$RANLIB libconftest.a" >&AS_MESSAGE_LOG_FD
+      $RANLIB libconftest.a 2>&AS_MESSAGE_LOG_FD
+      cat > conftest.c << _LT_EOF
+int main() { return 0;}
+_LT_EOF
+      echo "$LTCC $LTCFLAGS $LDFLAGS -o conftest conftest.c -Wl,-force_load,./libconftest.a" >&AS_MESSAGE_LOG_FD
+      $LTCC $LTCFLAGS $LDFLAGS -o conftest conftest.c -Wl,-force_load,./libconftest.a 2>conftest.err
+      _lt_result=$?
+      if test -f conftest && test ! -s conftest.err && test $_lt_result = 0 && $GREP forced_load conftest 2>&1 >/dev/null; then
+	lt_cv_ld_force_load=yes
+      else
+	cat conftest.err >&AS_MESSAGE_LOG_FD
+      fi
+        rm -f conftest.err libconftest.a conftest conftest.c
+        rm -rf conftest.dSYM
+    ])
     case $host_os in
     rhapsody* | darwin1.[[012]])
       _lt_dar_allow_undefined='${wl}-undefined ${wl}suppress' ;;
@@ -982,7 +1040,7 @@
     else
       _lt_dar_export_syms='~$NMEDIT -s $output_objdir/${libname}-symbols.expsym ${lib}'
     fi
-    if test "$DSYMUTIL" != ":"; then
+    if test "$DSYMUTIL" != ":" && test "$lt_cv_ld_force_load" = "no"; then
       _lt_dsymutil='~$DSYMUTIL $lib || :'
     else
       _lt_dsymutil=
@@ -1002,7 +1060,11 @@
   _LT_TAGVAR(hardcode_direct, $1)=no
   _LT_TAGVAR(hardcode_automatic, $1)=yes
   _LT_TAGVAR(hardcode_shlibpath_var, $1)=unsupported
-  _LT_TAGVAR(whole_archive_flag_spec, $1)=''
+  if test "$lt_cv_ld_force_load" = "yes"; then
+    _LT_TAGVAR(whole_archive_flag_spec, $1)='`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience ${wl}-force_load,$conv\"; done; func_echo_all \"$new_convenience\"`'
+  else
+    _LT_TAGVAR(whole_archive_flag_spec, $1)=''
+  fi
   _LT_TAGVAR(link_all_deplibs, $1)=yes
   _LT_TAGVAR(allow_undefined_flag, $1)="$_lt_dar_allow_undefined"
   case $cc_basename in
@@ -1010,7 +1072,7 @@
      *) _lt_dar_can_shared=$GCC ;;
   esac
   if test "$_lt_dar_can_shared" = "yes"; then
-    output_verbose_link_cmd=echo
+    output_verbose_link_cmd=func_echo_all
     _LT_TAGVAR(archive_cmds, $1)="\$CC -dynamiclib \$allow_undefined_flag -o \$lib \$libobjs \$deplibs \$compiler_flags -install_name \$rpath/\$soname \$verstring $_lt_dar_single_mod${_lt_dsymutil}"
     _LT_TAGVAR(module_cmds, $1)="\$CC \$allow_undefined_flag -o \$lib -bundle \$libobjs \$deplibs \$compiler_flags${_lt_dsymutil}"
     _LT_TAGVAR(archive_expsym_cmds, $1)="sed 's,^,_,' < \$export_symbols > \$output_objdir/\${libname}-symbols.expsym~\$CC -dynamiclib \$allow_undefined_flag -o \$lib \$libobjs \$deplibs \$compiler_flags -install_name \$rpath/\$soname \$verstring ${_lt_dar_single_mod}${_lt_dar_export_syms}${_lt_dsymutil}"
@@ -1026,203 +1088,142 @@
   fi
 ])
 
-# _LT_SYS_MODULE_PATH_AIX
-# -----------------------
+# _LT_SYS_MODULE_PATH_AIX([TAGNAME])
+# ----------------------------------
 # Links a minimal program and checks the executable
 # for the system default hardcoded library path. In most cases,
 # this is /usr/lib:/lib, but when the MPI compilers are used
 # the location of the communication and MPI libs are included too.
 # If we don't find anything, use the default library path according
 # to the aix ld manual.
+# Store the results from the different compilers for each TAGNAME.
+# Allow to override them for all tags through lt_cv_aix_libpath.
 m4_defun([_LT_SYS_MODULE_PATH_AIX],
 [m4_require([_LT_DECL_SED])dnl
-AC_LINK_IFELSE(AC_LANG_PROGRAM,[
-lt_aix_libpath_sed='
-    /Import File Strings/,/^$/ {
-	/^0/ {
-	    s/^0  *\(.*\)$/\1/
-	    p
-	}
-    }'
-aix_libpath=`dump -H conftest$ac_exeext 2>/dev/null | $SED -n -e "$lt_aix_libpath_sed"`
-# Check for a 64-bit object if we didn't find anything.
-if test -z "$aix_libpath"; then
-  aix_libpath=`dump -HX64 conftest$ac_exeext 2>/dev/null | $SED -n -e "$lt_aix_libpath_sed"`
-fi],[])
-if test -z "$aix_libpath"; then aix_libpath="/usr/lib:/lib"; fi
+if test "${lt_cv_aix_libpath+set}" = set; then
+  aix_libpath=$lt_cv_aix_libpath
+else
+  AC_CACHE_VAL([_LT_TAGVAR([lt_cv_aix_libpath_], [$1])],
+  [AC_LINK_IFELSE([AC_LANG_PROGRAM],[
+  lt_aix_libpath_sed='[
+      /Import File Strings/,/^$/ {
+	  /^0/ {
+	      s/^0  *\([^ ]*\) *$/\1/
+	      p
+	  }
+      }]'
+  _LT_TAGVAR([lt_cv_aix_libpath_], [$1])=`dump -H conftest$ac_exeext 2>/dev/null | $SED -n -e "$lt_aix_libpath_sed"`
+  # Check for a 64-bit object if we didn't find anything.
+  if test -z "$_LT_TAGVAR([lt_cv_aix_libpath_], [$1])"; then
+    _LT_TAGVAR([lt_cv_aix_libpath_], [$1])=`dump -HX64 conftest$ac_exeext 2>/dev/null | $SED -n -e "$lt_aix_libpath_sed"`
+  fi],[])
+  if test -z "$_LT_TAGVAR([lt_cv_aix_libpath_], [$1])"; then
+    _LT_TAGVAR([lt_cv_aix_libpath_], [$1])="/usr/lib:/lib"
+  fi
+  ])
+  aix_libpath=$_LT_TAGVAR([lt_cv_aix_libpath_], [$1])
+fi
 ])# _LT_SYS_MODULE_PATH_AIX
 
 
 # _LT_SHELL_INIT(ARG)
 # -------------------
 m4_define([_LT_SHELL_INIT],
-[ifdef([AC_DIVERSION_NOTICE],
-	     [AC_DIVERT_PUSH(AC_DIVERSION_NOTICE)],
-	 [AC_DIVERT_PUSH(NOTICE)])
-$1
-AC_DIVERT_POP
-])# _LT_SHELL_INIT
+[m4_divert_text([M4SH-INIT], [$1
+])])# _LT_SHELL_INIT
+
 
 
 # _LT_PROG_ECHO_BACKSLASH
 # -----------------------
-# Add some code to the start of the generated configure script which
-# will find an echo command which doesn't interpret backslashes.
+# Find how we can fake an echo command that does not interpret backslash.
+# In particular, with Autoconf 2.60 or later we add some code to the start
+# of the generated configure script which will find a shell with a builtin
+# printf (which we can use as an echo command).
 m4_defun([_LT_PROG_ECHO_BACKSLASH],
-[_LT_SHELL_INIT([
-# Check that we are running under the correct shell.
-SHELL=${CONFIG_SHELL-/bin/sh}
-
-case X$lt_ECHO in
-X*--fallback-echo)
-  # Remove one level of quotation (which was required for Make).
-  ECHO=`echo "$lt_ECHO" | sed 's,\\\\\[$]\\[$]0,'[$]0','`
-  ;;
-esac
-
-ECHO=${lt_ECHO-echo}
-if test "X[$]1" = X--no-reexec; then
-  # Discard the --no-reexec flag, and continue.
-  shift
-elif test "X[$]1" = X--fallback-echo; then
-  # Avoid inline document here, it may be left over
-  :
-elif test "X`{ $ECHO '\t'; } 2>/dev/null`" = 'X\t' ; then
-  # Yippee, $ECHO works!
-  :
+[ECHO='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
+ECHO=$ECHO$ECHO$ECHO$ECHO$ECHO
+ECHO=$ECHO$ECHO$ECHO$ECHO$ECHO$ECHO
+
+AC_MSG_CHECKING([how to print strings])
+# Test print first, because it will be a builtin if present.
+if test "X`( print -r -- -n ) 2>/dev/null`" = X-n && \
+   test "X`print -r -- $ECHO 2>/dev/null`" = "X$ECHO"; then
+  ECHO='print -r --'
+elif test "X`printf %s $ECHO 2>/dev/null`" = "X$ECHO"; then
+  ECHO='printf %s\n'
 else
-  # Restart under the correct shell.
-  exec $SHELL "[$]0" --no-reexec ${1+"[$]@"}
-fi
-
-if test "X[$]1" = X--fallback-echo; then
-  # used as fallback echo
-  shift
-  cat <<_LT_EOF
-[$]*
-_LT_EOF
-  exit 0
+  # Use this function as a fallback that always works.
+  func_fallback_echo ()
+  {
+    eval 'cat <<_LTECHO_EOF
+$[]1
+_LTECHO_EOF'
+  }
+  ECHO='func_fallback_echo'
 fi
 
-# The HP-UX ksh and POSIX shell print the target directory to stdout
-# if CDPATH is set.
-(unset CDPATH) >/dev/null 2>&1 && unset CDPATH
-
-if test -z "$lt_ECHO"; then
-  if test "X${echo_test_string+set}" != Xset; then
-    # find a string as large as possible, as long as the shell can cope with it
-    for cmd in 'sed 50q "[$]0"' 'sed 20q "[$]0"' 'sed 10q "[$]0"' 'sed 2q "[$]0"' 'echo test'; do
-      # expected sizes: less than 2Kb, 1Kb, 512 bytes, 16 bytes, ...
-      if { echo_test_string=`eval $cmd`; } 2>/dev/null &&
-	 { test "X$echo_test_string" = "X$echo_test_string"; } 2>/dev/null
-      then
-        break
-      fi
-    done
-  fi
-
-  if test "X`{ $ECHO '\t'; } 2>/dev/null`" = 'X\t' &&
-     echo_testing_string=`{ $ECHO "$echo_test_string"; } 2>/dev/null` &&
-     test "X$echo_testing_string" = "X$echo_test_string"; then
-    :
-  else
-    # The Solaris, AIX, and Digital Unix default echo programs unquote
-    # backslashes.  This makes it impossible to quote backslashes using
-    #   echo "$something" | sed 's/\\/\\\\/g'
-    #
-    # So, first we look for a working echo in the user's PATH.
-
-    lt_save_ifs="$IFS"; IFS=$PATH_SEPARATOR
-    for dir in $PATH /usr/ucb; do
-      IFS="$lt_save_ifs"
-      if (test -f $dir/echo || test -f $dir/echo$ac_exeext) &&
-         test "X`($dir/echo '\t') 2>/dev/null`" = 'X\t' &&
-         echo_testing_string=`($dir/echo "$echo_test_string") 2>/dev/null` &&
-         test "X$echo_testing_string" = "X$echo_test_string"; then
-        ECHO="$dir/echo"
-        break
-      fi
-    done
-    IFS="$lt_save_ifs"
-
-    if test "X$ECHO" = Xecho; then
-      # We didn't find a better echo, so look for alternatives.
-      if test "X`{ print -r '\t'; } 2>/dev/null`" = 'X\t' &&
-         echo_testing_string=`{ print -r "$echo_test_string"; } 2>/dev/null` &&
-         test "X$echo_testing_string" = "X$echo_test_string"; then
-        # This shell has a builtin print -r that does the trick.
-        ECHO='print -r'
-      elif { test -f /bin/ksh || test -f /bin/ksh$ac_exeext; } &&
-	   test "X$CONFIG_SHELL" != X/bin/ksh; then
-        # If we have ksh, try running configure again with it.
-        ORIGINAL_CONFIG_SHELL=${CONFIG_SHELL-/bin/sh}
-        export ORIGINAL_CONFIG_SHELL
-        CONFIG_SHELL=/bin/ksh
-        export CONFIG_SHELL
-        exec $CONFIG_SHELL "[$]0" --no-reexec ${1+"[$]@"}
-      else
-        # Try using printf.
-        ECHO='printf %s\n'
-        if test "X`{ $ECHO '\t'; } 2>/dev/null`" = 'X\t' &&
-	   echo_testing_string=`{ $ECHO "$echo_test_string"; } 2>/dev/null` &&
-	   test "X$echo_testing_string" = "X$echo_test_string"; then
-	  # Cool, printf works
-	  :
-        elif echo_testing_string=`($ORIGINAL_CONFIG_SHELL "[$]0" --fallback-echo '\t') 2>/dev/null` &&
-	     test "X$echo_testing_string" = 'X\t' &&
-	     echo_testing_string=`($ORIGINAL_CONFIG_SHELL "[$]0" --fallback-echo "$echo_test_string") 2>/dev/null` &&
-	     test "X$echo_testing_string" = "X$echo_test_string"; then
-	  CONFIG_SHELL=$ORIGINAL_CONFIG_SHELL
-	  export CONFIG_SHELL
-	  SHELL="$CONFIG_SHELL"
-	  export SHELL
-	  ECHO="$CONFIG_SHELL [$]0 --fallback-echo"
-        elif echo_testing_string=`($CONFIG_SHELL "[$]0" --fallback-echo '\t') 2>/dev/null` &&
-	     test "X$echo_testing_string" = 'X\t' &&
-	     echo_testing_string=`($CONFIG_SHELL "[$]0" --fallback-echo "$echo_test_string") 2>/dev/null` &&
-	     test "X$echo_testing_string" = "X$echo_test_string"; then
-	  ECHO="$CONFIG_SHELL [$]0 --fallback-echo"
-        else
-	  # maybe with a smaller string...
-	  prev=:
-
-	  for cmd in 'echo test' 'sed 2q "[$]0"' 'sed 10q "[$]0"' 'sed 20q "[$]0"' 'sed 50q "[$]0"'; do
-	    if { test "X$echo_test_string" = "X`eval $cmd`"; } 2>/dev/null
-	    then
-	      break
-	    fi
-	    prev="$cmd"
-	  done
+# func_echo_all arg...
+# Invoke $ECHO with all args, space-separated.
+func_echo_all ()
+{
+    $ECHO "$*" 
+}
 
-	  if test "$prev" != 'sed 50q "[$]0"'; then
-	    echo_test_string=`eval $prev`
-	    export echo_test_string
-	    exec ${ORIGINAL_CONFIG_SHELL-${CONFIG_SHELL-/bin/sh}} "[$]0" ${1+"[$]@"}
-	  else
-	    # Oops.  We lost completely, so just stick with echo.
-	    ECHO=echo
-	  fi
-        fi
-      fi
-    fi
-  fi
-fi
+case "$ECHO" in
+  printf*) AC_MSG_RESULT([printf]) ;;
+  print*) AC_MSG_RESULT([print -r]) ;;
+  *) AC_MSG_RESULT([cat]) ;;
+esac
 
-# Copy echo and quote the copy suitably for passing to libtool from
-# the Makefile, instead of quoting the original, which is used later.
-lt_ECHO=$ECHO
-if test "X$lt_ECHO" = "X$CONFIG_SHELL [$]0 --fallback-echo"; then
-   lt_ECHO="$CONFIG_SHELL \\\$\[$]0 --fallback-echo"
-fi
+m4_ifdef([_AS_DETECT_SUGGESTED],
+[_AS_DETECT_SUGGESTED([
+  test -n "${ZSH_VERSION+set}${BASH_VERSION+set}" || (
+    ECHO='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
+    ECHO=$ECHO$ECHO$ECHO$ECHO$ECHO
+    ECHO=$ECHO$ECHO$ECHO$ECHO$ECHO$ECHO
+    PATH=/empty FPATH=/empty; export PATH FPATH
+    test "X`printf %s $ECHO`" = "X$ECHO" \
+      || test "X`print -r -- $ECHO`" = "X$ECHO" )])])
 
-AC_SUBST(lt_ECHO)
-])
 _LT_DECL([], [SHELL], [1], [Shell to use when invoking shell scripts])
-_LT_DECL([], [ECHO], [1],
-    [An echo program that does not interpret backslashes])
+_LT_DECL([], [ECHO], [1], [An echo program that protects backslashes])
 ])# _LT_PROG_ECHO_BACKSLASH
 
 
+# _LT_WITH_SYSROOT
+# ----------------
+AC_DEFUN([_LT_WITH_SYSROOT],
+[AC_MSG_CHECKING([for sysroot])
+AC_ARG_WITH([sysroot],
+[  --with-sysroot[=DIR] Search for dependent libraries within DIR
+                        (or the compiler's sysroot if not specified).],
+[], [with_sysroot=no])
+
+dnl lt_sysroot will always be passed unquoted.  We quote it here
+dnl in case the user passed a directory name.
+lt_sysroot=
+case ${with_sysroot} in #(
+ yes)
+   if test "$GCC" = yes; then
+     lt_sysroot=`$CC --print-sysroot 2>/dev/null`
+   fi
+   ;; #(
+ /*)
+   lt_sysroot=`echo "$with_sysroot" | sed -e "$sed_quote_subst"`
+   ;; #(
+ no|'')
+   ;; #(
+ *)
+   AC_MSG_RESULT([${with_sysroot}])
+   AC_MSG_ERROR([The sysroot must be an absolute path.])
+   ;;
+esac
+
+ AC_MSG_RESULT([${lt_sysroot:-no}])
+_LT_DECL([], [lt_sysroot], [0], [The root where to search for ]dnl
+[dependent libraries, and in which our libraries should be installed.])])
+
 # _LT_ENABLE_LOCK
 # ---------------
 m4_defun([_LT_ENABLE_LOCK],
@@ -1251,7 +1252,7 @@
   ;;
 *-*-irix6*)
   # Find out which ABI we are using.
-  echo '[#]line __oline__ "configure"' > conftest.$ac_ext
+  echo '[#]line '$LINENO' "configure"' > conftest.$ac_ext
   if AC_TRY_EVAL(ac_compile); then
     if test "$lt_cv_prog_gnu_ld" = yes; then
       case `/usr/bin/file conftest.$ac_objext` in
@@ -1369,14 +1370,47 @@
 ])# _LT_ENABLE_LOCK
 
 
+# _LT_PROG_AR
+# -----------
+m4_defun([_LT_PROG_AR],
+[AC_CHECK_TOOLS(AR, [ar], false)
+: ${AR=ar}
+: ${AR_FLAGS=cru}
+_LT_DECL([], [AR], [1], [The archiver])
+_LT_DECL([], [AR_FLAGS], [1], [Flags to create an archive])
+
+AC_CACHE_CHECK([for archiver @FILE support], [lt_cv_ar_at_file],
+  [lt_cv_ar_at_file=no
+   AC_COMPILE_IFELSE([AC_LANG_PROGRAM],
+     [echo conftest.$ac_objext > conftest.lst
+      lt_ar_try='$AR $AR_FLAGS libconftest.a @conftest.lst >&AS_MESSAGE_LOG_FD'
+      AC_TRY_EVAL([lt_ar_try])
+      if test "$ac_status" -eq 0; then
+	# Ensure the archiver fails upon bogus file names.
+	rm -f conftest.$ac_objext libconftest.a
+	AC_TRY_EVAL([lt_ar_try])
+	if test "$ac_status" -ne 0; then
+          lt_cv_ar_at_file=@
+        fi
+      fi
+      rm -f conftest.* libconftest.a
+     ])
+  ])
+
+if test "x$lt_cv_ar_at_file" = xno; then
+  archiver_list_spec=
+else
+  archiver_list_spec=$lt_cv_ar_at_file
+fi
+_LT_DECL([], [archiver_list_spec], [1],
+  [How to feed a file listing to the archiver])
+])# _LT_PROG_AR
+
+
 # _LT_CMD_OLD_ARCHIVE
 # -------------------
 m4_defun([_LT_CMD_OLD_ARCHIVE],
-[AC_CHECK_TOOL(AR, ar, false)
-test -z "$AR" && AR=ar
-test -z "$AR_FLAGS" && AR_FLAGS=cru
-_LT_DECL([], [AR], [1], [The archiver])
-_LT_DECL([], [AR_FLAGS], [1])
+[_LT_PROG_AR
 
 AC_CHECK_TOOL(STRIP, strip, :)
 test -z "$STRIP" && STRIP=:
@@ -1403,10 +1437,19 @@
   esac
   old_archive_cmds="$old_archive_cmds~\$RANLIB \$oldlib"
 fi
+
+case $host_os in
+  darwin*)
+    lock_old_archive_extraction=yes ;;
+  *)
+    lock_old_archive_extraction=no ;;
+esac
 _LT_DECL([], [old_postinstall_cmds], [2])
 _LT_DECL([], [old_postuninstall_cmds], [2])
 _LT_TAGDECL([], [old_archive_cmds], [2],
     [Commands used to build an old-style archive])
+_LT_DECL([], [lock_old_archive_extraction], [0],
+    [Whether to use a lock for old archive extraction])
 ])# _LT_CMD_OLD_ARCHIVE
 
 
@@ -1431,15 +1474,15 @@
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [[^ ]]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:__oline__: $lt_compile\"" >&AS_MESSAGE_LOG_FD)
+   (eval echo "\"\$as_me:$LINENO: $lt_compile\"" >&AS_MESSAGE_LOG_FD)
    (eval "$lt_compile" 2>conftest.err)
    ac_status=$?
    cat conftest.err >&AS_MESSAGE_LOG_FD
-   echo "$as_me:__oline__: \$? = $ac_status" >&AS_MESSAGE_LOG_FD
+   echo "$as_me:$LINENO: \$? = $ac_status" >&AS_MESSAGE_LOG_FD
    if (exit $ac_status) && test -s "$ac_outfile"; then
      # The compiler can only warn and ignore the option if not recognized
      # So say no if there are warnings other than the usual output.
-     $ECHO "X$_lt_compiler_boilerplate" | $Xsed -e '/^$/d' >conftest.exp
+     $ECHO "$_lt_compiler_boilerplate" | $SED '/^$/d' >conftest.exp
      $SED '/^$/d; /^ *+/d' conftest.err >conftest.er2
      if test ! -s conftest.er2 || diff conftest.exp conftest.er2 >/dev/null; then
        $2=yes
@@ -1479,7 +1522,7 @@
      if test -s conftest.err; then
        # Append any errors to the config.log.
        cat conftest.err 1>&AS_MESSAGE_LOG_FD
-       $ECHO "X$_lt_linker_boilerplate" | $Xsed -e '/^$/d' > conftest.exp
+       $ECHO "$_lt_linker_boilerplate" | $SED '/^$/d' > conftest.exp
        $SED '/^$/d; /^ *+/d' conftest.err >conftest.er2
        if diff conftest.exp conftest.er2 >/dev/null; then
          $2=yes
@@ -1542,6 +1585,11 @@
     lt_cv_sys_max_cmd_len=8192;
     ;;
 
+  mint*)
+    # On MiNT this can take a long time and run out of memory.
+    lt_cv_sys_max_cmd_len=8192;
+    ;;
+
   amigaos*)
     # On AmigaOS with pdksh, this test takes hours, literally.
     # So we just punt and use a minimum line length of 8192.
@@ -1606,8 +1654,8 @@
       # If test is not a shell built-in, we'll probably end up computing a
       # maximum length that is only half of the actual maximum length, but
       # we can't tell.
-      while { test "X"`$SHELL [$]0 --fallback-echo "X$teststring$teststring" 2>/dev/null` \
-	         = "XX$teststring$teststring"; } >/dev/null 2>&1 &&
+      while { test "X"`func_fallback_echo "$teststring$teststring" 2>/dev/null` \
+	         = "X$teststring$teststring"; } >/dev/null 2>&1 &&
 	      test $i != 17 # 1/2 MB should be enough
       do
         i=`expr $i + 1`
@@ -1658,7 +1706,7 @@
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-[#line __oline__ "configure"
+[#line $LINENO "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -1699,7 +1747,13 @@
 #  endif
 #endif
 
-void fnord() { int i=42;}
+/* When -fvisbility=hidden is used, assume the code has been annotated
+   correspondingly for the symbols needed.  */
+#if defined(__GNUC__) && (((__GNUC__ == 3) && (__GNUC_MINOR__ >= 3)) || (__GNUC__ > 3))
+int fnord () __attribute__((visibility("default")));
+#endif
+
+int fnord () { return 42; }
 int main ()
 {
   void *self = dlopen (0, LT_DLGLOBAL|LT_DLLAZY_OR_NOW);
@@ -1708,7 +1762,11 @@
   if (self)
     {
       if (dlsym (self,"fnord"))       status = $lt_dlno_uscore;
-      else if (dlsym( self,"_fnord")) status = $lt_dlneed_uscore;
+      else
+        {
+	  if (dlsym( self,"_fnord"))  status = $lt_dlneed_uscore;
+          else puts (dlerror ());
+	}
       /* dlclose (self); */
     }
   else
@@ -1884,16 +1942,16 @@
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [[^ ]]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:__oline__: $lt_compile\"" >&AS_MESSAGE_LOG_FD)
+   (eval echo "\"\$as_me:$LINENO: $lt_compile\"" >&AS_MESSAGE_LOG_FD)
    (eval "$lt_compile" 2>out/conftest.err)
    ac_status=$?
    cat out/conftest.err >&AS_MESSAGE_LOG_FD
-   echo "$as_me:__oline__: \$? = $ac_status" >&AS_MESSAGE_LOG_FD
+   echo "$as_me:$LINENO: \$? = $ac_status" >&AS_MESSAGE_LOG_FD
    if (exit $ac_status) && test -s out/conftest2.$ac_objext
    then
      # The compiler can only warn and ignore the option if not recognized
      # So say no if there are warnings
-     $ECHO "X$_lt_compiler_boilerplate" | $Xsed -e '/^$/d' > out/conftest.exp
+     $ECHO "$_lt_compiler_boilerplate" | $SED '/^$/d' > out/conftest.exp
      $SED '/^$/d; /^ *+/d' out/conftest.err >out/conftest.er2
      if test ! -s out/conftest.er2 || diff out/conftest.exp out/conftest.er2 >/dev/null; then
        _LT_TAGVAR(lt_cv_prog_compiler_c_o, $1)=yes
@@ -2052,6 +2110,7 @@
 m4_require([_LT_FILEUTILS_DEFAULTS])dnl
 m4_require([_LT_DECL_OBJDUMP])dnl
 m4_require([_LT_DECL_SED])dnl
+m4_require([_LT_CHECK_SHELL_FEATURES])dnl
 AC_MSG_CHECKING([dynamic linker characteristics])
 m4_if([$1],
 	[], [
@@ -2060,16 +2119,23 @@
     darwin*) lt_awk_arg="/^libraries:/,/LR/" ;;
     *) lt_awk_arg="/^libraries:/" ;;
   esac
-  lt_search_path_spec=`$CC -print-search-dirs | awk $lt_awk_arg | $SED -e "s/^libraries://" -e "s,=/,/,g"`
-  if $ECHO "$lt_search_path_spec" | $GREP ';' >/dev/null ; then
+  case $host_os in
+    mingw* | cegcc*) lt_sed_strip_eq="s,=\([[A-Za-z]]:\),\1,g" ;;
+    *) lt_sed_strip_eq="s,=/,/,g" ;;
+  esac
+  lt_search_path_spec=`$CC -print-search-dirs | awk $lt_awk_arg | $SED -e "s/^libraries://" -e $lt_sed_strip_eq`
+  case $lt_search_path_spec in
+  *\;*)
     # if the path contains ";" then we assume it to be the separator
     # otherwise default to the standard path separator (i.e. ":") - it is
     # assumed that no part of a normal pathname contains ";" but that should
     # okay in the real world where ";" in dirpaths is itself problematic.
-    lt_search_path_spec=`$ECHO "$lt_search_path_spec" | $SED -e 's/;/ /g'`
-  else
-    lt_search_path_spec=`$ECHO "$lt_search_path_spec" | $SED  -e "s/$PATH_SEPARATOR/ /g"`
-  fi
+    lt_search_path_spec=`$ECHO "$lt_search_path_spec" | $SED 's/;/ /g'`
+    ;;
+  *)
+    lt_search_path_spec=`$ECHO "$lt_search_path_spec" | $SED "s/$PATH_SEPARATOR/ /g"`
+    ;;
+  esac
   # Ok, now we have the path, separated by spaces, we can step through it
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
@@ -2082,7 +2148,7 @@
 	lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path"
     fi
   done
-  lt_search_path_spec=`$ECHO $lt_tmp_lt_search_path_spec | awk '
+  lt_search_path_spec=`$ECHO "$lt_tmp_lt_search_path_spec" | awk '
 BEGIN {RS=" "; FS="/|\n";} {
   lt_foo="";
   lt_count=0;
@@ -2102,7 +2168,13 @@
   if (lt_foo != "") { lt_freq[[lt_foo]]++; }
   if (lt_freq[[lt_foo]] == 1) { print lt_foo; }
 }'`
-  sys_lib_search_path_spec=`$ECHO $lt_search_path_spec`
+  # AWK program above erroneously prepends '/' to C:/dos/paths
+  # for these hosts.
+  case $host_os in
+    mingw* | cegcc*) lt_search_path_spec=`$ECHO "$lt_search_path_spec" |\
+      $SED 's,/\([[A-Za-z]]:\),\1,g'` ;;
+  esac
+  sys_lib_search_path_spec=`$ECHO "$lt_search_path_spec" | $lt_NL2SP`
 else
   sys_lib_search_path_spec="/lib /usr/lib /usr/local/lib"
 fi])
@@ -2190,7 +2262,7 @@
   m68k)
     library_names_spec='$libname.ixlibrary $libname.a'
     # Create ${libname}_ixlibrary.a entries in /sys/libs.
-    finish_eval='for lib in `ls $libdir/*.ixlibrary 2>/dev/null`; do libname=`$ECHO "X$lib" | $Xsed -e '\''s%^.*/\([[^/]]*\)\.ixlibrary$%\1%'\''`; test $RM /sys/libs/${libname}_ixlibrary.a; $show "cd /sys/libs && $LN_S $lib ${libname}_ixlibrary.a"; cd /sys/libs && $LN_S $lib ${libname}_ixlibrary.a || exit 1; done'
+    finish_eval='for lib in `ls $libdir/*.ixlibrary 2>/dev/null`; do libname=`func_echo_all "$lib" | $SED '\''s%^.*/\([[^/]]*\)\.ixlibrary$%\1%'\''`; test $RM /sys/libs/${libname}_ixlibrary.a; $show "cd /sys/libs && $LN_S $lib ${libname}_ixlibrary.a"; cd /sys/libs && $LN_S $lib ${libname}_ixlibrary.a || exit 1; done'
     ;;
   esac
   ;;
@@ -2221,8 +2293,9 @@
   need_version=no
   need_lib_prefix=no
 
-  case $GCC,$host_os in
-  yes,cygwin* | yes,mingw* | yes,pw32* | yes,cegcc*)
+  case $GCC,$cc_basename in
+  yes,*)
+    # gcc
     library_names_spec='$libname.dll.a'
     # DLL is installed to $(libdir)/../bin by postinstall_cmds
     postinstall_cmds='base_file=`basename \${file}`~
@@ -2243,36 +2316,83 @@
     cygwin*)
       # Cygwin DLLs use 'cyg' prefix rather than 'lib'
       soname_spec='`echo ${libname} | sed -e 's/^lib/cyg/'``echo ${release} | $SED -e 's/[[.]]/-/g'`${versuffix}${shared_ext}'
-      sys_lib_search_path_spec="/usr/lib /lib/w32api /lib /usr/local/lib"
+m4_if([$1], [],[
+      sys_lib_search_path_spec="$sys_lib_search_path_spec /usr/lib/w32api"])
       ;;
     mingw* | cegcc*)
       # MinGW DLLs use traditional 'lib' prefix
       soname_spec='${libname}`echo ${release} | $SED -e 's/[[.]]/-/g'`${versuffix}${shared_ext}'
-      sys_lib_search_path_spec=`$CC -print-search-dirs | $GREP "^libraries:" | $SED -e "s/^libraries://" -e "s,=/,/,g"`
-      if $ECHO "$sys_lib_search_path_spec" | [$GREP ';[c-zC-Z]:/' >/dev/null]; then
-        # It is most probably a Windows format PATH printed by
-        # mingw gcc, but we are running on Cygwin. Gcc prints its search
-        # path with ; separators, and with drive letters. We can handle the
-        # drive letters (cygwin fileutils understands them), so leave them,
-        # especially as we might pass files found there to a mingw objdump,
-        # which wouldn't understand a cygwinified path. Ahh.
-        sys_lib_search_path_spec=`$ECHO "$sys_lib_search_path_spec" | $SED -e 's/;/ /g'`
-      else
-        sys_lib_search_path_spec=`$ECHO "$sys_lib_search_path_spec" | $SED  -e "s/$PATH_SEPARATOR/ /g"`
-      fi
       ;;
     pw32*)
       # pw32 DLLs use 'pw' prefix rather than 'lib'
       library_names_spec='`echo ${libname} | sed -e 's/^lib/pw/'``echo ${release} | $SED -e 's/[[.]]/-/g'`${versuffix}${shared_ext}'
       ;;
     esac
+    dynamic_linker='Win32 ld.exe'
+    ;;
+
+  *,cl*)
+    # Native MSVC
+    libname_spec='$name'
+    soname_spec='${libname}`echo ${release} | $SED -e 's/[[.]]/-/g'`${versuffix}${shared_ext}'
+    library_names_spec='${libname}.dll.lib'
+
+    case $build_os in
+    mingw*)
+      sys_lib_search_path_spec=
+      lt_save_ifs=$IFS
+      IFS=';'
+      for lt_path in $LIB
+      do
+        IFS=$lt_save_ifs
+        # Let DOS variable expansion print the short 8.3 style file name.
+        lt_path=`cd "$lt_path" 2>/dev/null && cmd //C "for %i in (".") do @echo %~si"`
+        sys_lib_search_path_spec="$sys_lib_search_path_spec $lt_path"
+      done
+      IFS=$lt_save_ifs
+      # Convert to MSYS style.
+      sys_lib_search_path_spec=`$ECHO "$sys_lib_search_path_spec" | sed -e 's|\\\\|/|g' -e 's| \\([[a-zA-Z]]\\):| /\\1|g' -e 's|^ ||'`
+      ;;
+    cygwin*)
+      # Convert to unix form, then to dos form, then back to unix form
+      # but this time dos style (no spaces!) so that the unix form looks
+      # like /cygdrive/c/PROGRA~1:/cygdr...
+      sys_lib_search_path_spec=`cygpath --path --unix "$LIB"`
+      sys_lib_search_path_spec=`cygpath --path --dos "$sys_lib_search_path_spec" 2>/dev/null`
+      sys_lib_search_path_spec=`cygpath --path --unix "$sys_lib_search_path_spec" | $SED -e "s/$PATH_SEPARATOR/ /g"`
+      ;;
+    *)
+      sys_lib_search_path_spec="$LIB"
+      if $ECHO "$sys_lib_search_path_spec" | [$GREP ';[c-zC-Z]:/' >/dev/null]; then
+        # It is most probably a Windows format PATH.
+        sys_lib_search_path_spec=`$ECHO "$sys_lib_search_path_spec" | $SED -e 's/;/ /g'`
+      else
+        sys_lib_search_path_spec=`$ECHO "$sys_lib_search_path_spec" | $SED -e "s/$PATH_SEPARATOR/ /g"`
+      fi
+      # FIXME: find the short name or the path components, as spaces are
+      # common. (e.g. "Program Files" -> "PROGRA~1")
+      ;;
+    esac
+
+    # DLL is installed to $(libdir)/../bin by postinstall_cmds
+    postinstall_cmds='base_file=`basename \${file}`~
+      dlpath=`$SHELL 2>&1 -c '\''. $dir/'\''\${base_file}'\''i; echo \$dlname'\''`~
+      dldir=$destdir/`dirname \$dlpath`~
+      test -d \$dldir || mkdir -p \$dldir~
+      $install_prog $dir/$dlname \$dldir/$dlname'
+    postuninstall_cmds='dldll=`$SHELL 2>&1 -c '\''. $file; echo \$dlname'\''`~
+      dlpath=$dir/\$dldll~
+       $RM \$dlpath'
+    shlibpath_overrides_runpath=yes
+    dynamic_linker='Win32 link.exe'
     ;;
 
   *)
+    # Assume MSVC wrapper
     library_names_spec='${libname}`echo ${release} | $SED -e 's/[[.]]/-/g'`${versuffix}${shared_ext} $libname.lib'
+    dynamic_linker='Win32 ld.exe'
     ;;
   esac
-  dynamic_linker='Win32 ld.exe'
   # FIXME: first we should search . and the directory the executable is in
   shlibpath_var=PATH
   ;;
@@ -2359,6 +2479,19 @@
   hardcode_into_libs=yes
   ;;
 
+haiku*)
+  version_type=linux
+  need_lib_prefix=no
+  need_version=no
+  dynamic_linker="$host_os runtime_loader"
+  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
+  soname_spec='${libname}${release}${shared_ext}$major'
+  shlibpath_var=LIBRARY_PATH
+  shlibpath_overrides_runpath=yes
+  sys_lib_dlsearch_path_spec='/boot/home/config/lib /boot/common/lib /boot/system/lib'
+  hardcode_into_libs=yes
+  ;;
+
 hpux9* | hpux10* | hpux11*)
   # Give a soname corresponding to the major version so that dld.sl refuses to
   # link against other versions.
@@ -2401,8 +2534,10 @@
     soname_spec='${libname}${release}${shared_ext}$major'
     ;;
   esac
-  # HP-UX runs *really* slowly unless shared libraries are mode 555.
+  # HP-UX runs *really* slowly unless shared libraries are mode 555, ...
   postinstall_cmds='chmod 555 $lib'
+  # or fails outright, so override atomically:
+  install_override_mode=555
   ;;
 
 interix[[3-9]]*)
@@ -2469,16 +2604,21 @@
   finish_cmds='PATH="\$PATH:/sbin" ldconfig -n $libdir'
   shlibpath_var=LD_LIBRARY_PATH
   shlibpath_overrides_runpath=no
+
   # Some binutils ld are patched to set DT_RUNPATH
-  save_LDFLAGS=$LDFLAGS
-  save_libdir=$libdir
-  eval "libdir=/foo; wl=\"$_LT_TAGVAR(lt_prog_compiler_wl, $1)\"; \
-       LDFLAGS=\"\$LDFLAGS $_LT_TAGVAR(hardcode_libdir_flag_spec, $1)\""
-  AC_LINK_IFELSE([AC_LANG_PROGRAM([],[])],
-    [AS_IF([ ($OBJDUMP -p conftest$ac_exeext) 2>/dev/null | grep "RUNPATH.*$libdir" >/dev/null],
-       [shlibpath_overrides_runpath=yes])])
-  LDFLAGS=$save_LDFLAGS
-  libdir=$save_libdir
+  AC_CACHE_VAL([lt_cv_shlibpath_overrides_runpath],
+    [lt_cv_shlibpath_overrides_runpath=no
+    save_LDFLAGS=$LDFLAGS
+    save_libdir=$libdir
+    eval "libdir=/foo; wl=\"$_LT_TAGVAR(lt_prog_compiler_wl, $1)\"; \
+	 LDFLAGS=\"\$LDFLAGS $_LT_TAGVAR(hardcode_libdir_flag_spec, $1)\""
+    AC_LINK_IFELSE([AC_LANG_PROGRAM([],[])],
+      [AS_IF([ ($OBJDUMP -p conftest$ac_exeext) 2>/dev/null | grep "RUNPATH.*$libdir" >/dev/null],
+	 [lt_cv_shlibpath_overrides_runpath=yes])])
+    LDFLAGS=$save_LDFLAGS
+    libdir=$save_libdir
+    ])
+  shlibpath_overrides_runpath=$lt_cv_shlibpath_overrides_runpath
 
   # This implies no fast_install, which is unacceptable.
   # Some rework will be needed to allow for fast_install
@@ -2487,7 +2627,7 @@
 
   # Append ld.so.conf contents to the search path
   if test -f /etc/ld.so.conf; then
-    lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \[$]2)); skip = 1; } { if (!skip) print \[$]0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;/^$/d' | tr '\n' ' '`
+    lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \[$]2)); skip = 1; } { if (!skip) print \[$]0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;s/"//g;/^$/d' | tr '\n' ' '`
     sys_lib_dlsearch_path_spec="/lib /usr/lib $lt_ld_extra"
   fi
 
@@ -2500,18 +2640,6 @@
   dynamic_linker='GNU/Linux ld.so'
   ;;
 
-netbsdelf*-gnu)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
-  hardcode_into_libs=yes
-  dynamic_linker='NetBSD ld.elf_so'
-  ;;
-
 netbsd*)
   version_type=sunos
   need_lib_prefix=no
@@ -2732,6 +2860,8 @@
     The last name is the one that the linker finds with -lNAME]])
 _LT_DECL([], [soname_spec], [1],
     [[The coded name of the library, if different from the real name]])
+_LT_DECL([], [install_override_mode], [1],
+    [Permission mode override for installation of shared libraries])
 _LT_DECL([], [postinstall_cmds], [2],
     [Command to use after installation of a shared archive])
 _LT_DECL([], [postuninstall_cmds], [2],
@@ -2844,6 +2974,7 @@
 AC_REQUIRE([AC_CANONICAL_BUILD])dnl
 m4_require([_LT_DECL_SED])dnl
 m4_require([_LT_DECL_EGREP])dnl
+m4_require([_LT_PROG_ECHO_BACKSLASH])dnl
 
 AC_ARG_WITH([gnu-ld],
     [AS_HELP_STRING([--with-gnu-ld],
@@ -2965,6 +3096,11 @@
 esac
 reload_cmds='$LD$reload_flag -o $output$reload_objs'
 case $host_os in
+  cygwin* | mingw* | pw32* | cegcc*)
+    if test "$GCC" != yes; then
+      reload_cmds=false
+    fi
+    ;;
   darwin*)
     if test "$GCC" = yes; then
       reload_cmds='$LTCC $LTCFLAGS -nostdlib ${wl}-r -o $output$reload_objs'
@@ -2973,8 +3109,8 @@
     fi
     ;;
 esac
-_LT_DECL([], [reload_flag], [1], [How to create reloadable object files])dnl
-_LT_DECL([], [reload_cmds], [2])dnl
+_LT_TAGDECL([], [reload_flag], [1], [How to create reloadable object files])dnl
+_LT_TAGDECL([], [reload_cmds], [2])dnl
 ])# _LT_CMD_RELOAD
 
 
@@ -3026,16 +3162,18 @@
   # Base MSYS/MinGW do not provide the 'file' command needed by
   # func_win32_libid shell function, so use a weaker test based on 'objdump',
   # unless we find 'file', for example because we are cross-compiling.
-  if ( file / ) >/dev/null 2>&1; then
+  # func_win32_libid assumes BSD nm, so disallow it if using MS dumpbin.
+  if ( test "$lt_cv_nm_interface" = "BSD nm" && file / ) >/dev/null 2>&1; then
     lt_cv_deplibs_check_method='file_magic ^x86 archive import|^x86 DLL'
     lt_cv_file_magic_cmd='func_win32_libid'
   else
-    lt_cv_deplibs_check_method='file_magic file format pei*-i386(.*architecture: i386)?'
+    # Keep this pattern in sync with the one in func_win32_libid.
+    lt_cv_deplibs_check_method='file_magic file format (pei*-i386(.*architecture: i386)?|pe-arm-wince|pe-x86-64)'
     lt_cv_file_magic_cmd='$OBJDUMP -f'
   fi
   ;;
 
-cegcc)
+cegcc*)
   # use the weaker test based on 'objdump'. See mingw*.
   lt_cv_deplibs_check_method='file_magic file format pe-arm-.*little(.*architecture: arm)?'
   lt_cv_file_magic_cmd='$OBJDUMP -f'
@@ -3065,6 +3203,10 @@
   lt_cv_deplibs_check_method=pass_all
   ;;
 
+haiku*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
+
 hpux10.20* | hpux11*)
   lt_cv_file_magic_cmd=/usr/bin/file
   case $host_cpu in
@@ -3073,11 +3215,11 @@
     lt_cv_file_magic_test_file=/usr/lib/hpux32/libc.so
     ;;
   hppa*64*)
-    [lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|ELF-[0-9][0-9]) shared object file - PA-RISC [0-9].[0-9]']
+    [lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|ELF[ -][0-9][0-9])(-bit)?( [LM]SB)? shared object( file)?[, -]* PA-RISC [0-9]\.[0-9]']
     lt_cv_file_magic_test_file=/usr/lib/pa20_64/libc.sl
     ;;
   *)
-    lt_cv_deplibs_check_method='file_magic (s[[0-9]][[0-9]][[0-9]]|PA-RISC[[0-9]].[[0-9]]) shared library'
+    lt_cv_deplibs_check_method='file_magic (s[[0-9]][[0-9]][[0-9]]|PA-RISC[[0-9]]\.[[0-9]]) shared library'
     lt_cv_file_magic_test_file=/usr/lib/libc.sl
     ;;
   esac
@@ -3103,7 +3245,7 @@
   lt_cv_deplibs_check_method=pass_all
   ;;
 
-netbsd* | netbsdelf*-gnu)
+netbsd*)
   if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
     lt_cv_deplibs_check_method='match_pattern /lib[[^/]]+(\.so\.[[0-9]]+\.[[0-9]]+|_pic\.a)$'
   else
@@ -3177,6 +3319,21 @@
   ;;
 esac
 ])
+
+file_magic_glob=
+want_nocaseglob=no
+if test "$build" = "$host"; then
+  case $host_os in
+  mingw* | pw32*)
+    if ( shopt | grep nocaseglob ) >/dev/null 2>&1; then
+      want_nocaseglob=yes
+    else
+      file_magic_glob=`echo aAbBcCdDeEfFgGhHiIjJkKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ | $SED -e "s/\(..\)/s\/[[\1]]\/[[\1]]\/g;/g"`
+    fi
+    ;;
+  esac
+fi
+
 file_magic_cmd=$lt_cv_file_magic_cmd
 deplibs_check_method=$lt_cv_deplibs_check_method
 test -z "$deplibs_check_method" && deplibs_check_method=unknown
@@ -3184,7 +3341,11 @@
 _LT_DECL([], [deplibs_check_method], [1],
     [Method to check whether dependent libraries are shared objects])
 _LT_DECL([], [file_magic_cmd], [1],
-    [Command to use when deplibs_check_method == "file_magic"])
+    [Command to use when deplibs_check_method = "file_magic"])
+_LT_DECL([], [file_magic_glob], [1],
+    [How to find potential files when deplibs_check_method = "file_magic"])
+_LT_DECL([], [want_nocaseglob], [1],
+    [Find potential files using nocaseglob when deplibs_check_method = "file_magic"])
 ])# _LT_CHECK_MAGIC_METHOD
 
 
@@ -3241,7 +3402,19 @@
   NM="$lt_cv_path_NM"
 else
   # Didn't find any BSD compatible name lister, look for dumpbin.
-  AC_CHECK_TOOLS(DUMPBIN, ["dumpbin -symbols" "link -dump -symbols"], :)
+  if test -n "$DUMPBIN"; then :
+    # Let the user override the test.
+  else
+    AC_CHECK_TOOLS(DUMPBIN, [dumpbin "link -dump"], :)
+    case `$DUMPBIN -symbols /dev/null 2>&1 | sed '1q'` in
+    *COFF*)
+      DUMPBIN="$DUMPBIN -symbols"
+      ;;
+    *)
+      DUMPBIN=:
+      ;;
+    esac
+  fi
   AC_SUBST([DUMPBIN])
   if test "$DUMPBIN" != ":"; then
     NM="$DUMPBIN"
@@ -3254,13 +3427,13 @@
 AC_CACHE_CHECK([the name lister ($NM) interface], [lt_cv_nm_interface],
   [lt_cv_nm_interface="BSD nm"
   echo "int some_variable = 0;" > conftest.$ac_ext
-  (eval echo "\"\$as_me:__oline__: $ac_compile\"" >&AS_MESSAGE_LOG_FD)
+  (eval echo "\"\$as_me:$LINENO: $ac_compile\"" >&AS_MESSAGE_LOG_FD)
   (eval "$ac_compile" 2>conftest.err)
   cat conftest.err >&AS_MESSAGE_LOG_FD
-  (eval echo "\"\$as_me:__oline__: $NM \\\"conftest.$ac_objext\\\"\"" >&AS_MESSAGE_LOG_FD)
+  (eval echo "\"\$as_me:$LINENO: $NM \\\"conftest.$ac_objext\\\"\"" >&AS_MESSAGE_LOG_FD)
   (eval "$NM \"conftest.$ac_objext\"" 2>conftest.err > conftest.out)
   cat conftest.err >&AS_MESSAGE_LOG_FD
-  (eval echo "\"\$as_me:__oline__: output\"" >&AS_MESSAGE_LOG_FD)
+  (eval echo "\"\$as_me:$LINENO: output\"" >&AS_MESSAGE_LOG_FD)
   cat conftest.out >&AS_MESSAGE_LOG_FD
   if $GREP 'External.*some_variable' conftest.out > /dev/null; then
     lt_cv_nm_interface="MS dumpbin"
@@ -3275,18 +3448,79 @@
 dnl AC_DEFUN([AM_PROG_NM], [])
 dnl AC_DEFUN([AC_PROG_NM], [])
 
+# _LT_CHECK_SHAREDLIB_FROM_LINKLIB
+# --------------------------------
+# how to determine the name of the shared library
+# associated with a specific link library.
+#  -- PORTME fill in with the dynamic library characteristics
+m4_defun([_LT_CHECK_SHAREDLIB_FROM_LINKLIB],
+[m4_require([_LT_DECL_EGREP])
+m4_require([_LT_DECL_OBJDUMP])
+m4_require([_LT_DECL_DLLTOOL])
+AC_CACHE_CHECK([how to associate runtime and link libraries],
+lt_cv_sharedlib_from_linklib_cmd,
+[lt_cv_sharedlib_from_linklib_cmd='unknown'
 
-# LT_LIB_M
-# --------
-# check for math library
-AC_DEFUN([LT_LIB_M],
-[AC_REQUIRE([AC_CANONICAL_HOST])dnl
-LIBM=
-case $host in
-*-*-beos* | *-*-cygwin* | *-*-pw32* | *-*-darwin*)
-  # These system don't have libm, or don't need it
+case $host_os in
+cygwin* | mingw* | pw32* | cegcc*)
+  # two different shell functions defined in ltmain.sh
+  # decide which to use based on capabilities of $DLLTOOL
+  case `$DLLTOOL --help 2>&1` in
+  *--identify-strict*)
+    lt_cv_sharedlib_from_linklib_cmd=func_cygming_dll_for_implib
+    ;;
+  *)
+    lt_cv_sharedlib_from_linklib_cmd=func_cygming_dll_for_implib_fallback
+    ;;
+  esac
   ;;
-*-ncr-sysv4.3*)
+*)
+  # fallback: assume linklib IS sharedlib
+  lt_cv_sharedlib_from_linklib_cmd="$ECHO"
+  ;;
+esac
+])
+sharedlib_from_linklib_cmd=$lt_cv_sharedlib_from_linklib_cmd
+test -z "$sharedlib_from_linklib_cmd" && sharedlib_from_linklib_cmd=$ECHO
+
+_LT_DECL([], [sharedlib_from_linklib_cmd], [1],
+    [Command to associate shared and link libraries])
+])# _LT_CHECK_SHAREDLIB_FROM_LINKLIB
+
+
+# _LT_PATH_MANIFEST_TOOL
+# ----------------------
+# locate the manifest tool
+m4_defun([_LT_PATH_MANIFEST_TOOL],
+[AC_CHECK_TOOL(MANIFEST_TOOL, mt, :)
+test -z "$MANIFEST_TOOL" && MANIFEST_TOOL=mt
+AC_CACHE_CHECK([if $MANIFEST_TOOL is a manifest tool], [lt_cv_path_mainfest_tool],
+  [lt_cv_path_mainfest_tool=no
+  echo "$as_me:$LINENO: $MANIFEST_TOOL '-?'" >&AS_MESSAGE_LOG_FD
+  $MANIFEST_TOOL '-?' 2>conftest.err > conftest.out
+  cat conftest.err >&AS_MESSAGE_LOG_FD
+  if $GREP 'Manifest Tool' conftest.out > /dev/null; then
+    lt_cv_path_mainfest_tool=yes
+  fi
+  rm -f conftest*])
+if test "x$lt_cv_path_mainfest_tool" != xyes; then
+  MANIFEST_TOOL=:
+fi
+_LT_DECL([], [MANIFEST_TOOL], [1], [Manifest tool])dnl
+])# _LT_PATH_MANIFEST_TOOL
+
+
+# LT_LIB_M
+# --------
+# check for math library
+AC_DEFUN([LT_LIB_M],
+[AC_REQUIRE([AC_CANONICAL_HOST])dnl
+LIBM=
+case $host in
+*-*-beos* | *-*-cegcc* | *-*-cygwin* | *-*-haiku* | *-*-pw32* | *-*-darwin*)
+  # These system don't have libm, or don't need it
+  ;;
+*-ncr-sysv4.3*)
   AC_CHECK_LIB(mw, _mwvalidcheckl, LIBM="-lmw")
   AC_CHECK_LIB(m, cos, LIBM="$LIBM -lm")
   ;;
@@ -3311,7 +3545,12 @@
 _LT_TAGVAR(lt_prog_compiler_no_builtin_flag, $1)=
 
 if test "$GCC" = yes; then
-  _LT_TAGVAR(lt_prog_compiler_no_builtin_flag, $1)=' -fno-builtin'
+  case $cc_basename in
+  nvcc*)
+    _LT_TAGVAR(lt_prog_compiler_no_builtin_flag, $1)=' -Xcompiler -fno-builtin' ;;
+  *)
+    _LT_TAGVAR(lt_prog_compiler_no_builtin_flag, $1)=' -fno-builtin' ;;
+  esac
 
   _LT_COMPILER_OPTION([if $compiler supports -fno-rtti -fno-exceptions],
     lt_cv_prog_compiler_rtti_exceptions,
@@ -3328,6 +3567,7 @@
 m4_defun([_LT_CMD_GLOBAL_SYMBOLS],
 [AC_REQUIRE([AC_CANONICAL_HOST])dnl
 AC_REQUIRE([AC_PROG_CC])dnl
+AC_REQUIRE([AC_PROG_AWK])dnl
 AC_REQUIRE([LT_PATH_NM])dnl
 AC_REQUIRE([LT_PATH_LD])dnl
 m4_require([_LT_DECL_SED])dnl
@@ -3395,8 +3635,8 @@
 lt_cv_sys_global_symbol_to_cdecl="sed -n -e 's/^T .* \(.*\)$/extern int \1();/p' -e 's/^$symcode* .* \(.*\)$/extern char \1;/p'"
 
 # Transform an extracted symbol line into symbol name and symbol address
-lt_cv_sys_global_symbol_to_c_name_address="sed -n -e 's/^: \([[^ ]]*\) $/  {\\\"\1\\\", (void *) 0},/p' -e 's/^$symcode* \([[^ ]]*\) \([[^ ]]*\)$/  {\"\2\", (void *) \&\2},/p'"
-lt_cv_sys_global_symbol_to_c_name_address_lib_prefix="sed -n -e 's/^: \([[^ ]]*\) $/  {\\\"\1\\\", (void *) 0},/p' -e 's/^$symcode* \([[^ ]]*\) \(lib[[^ ]]*\)$/  {\"\2\", (void *) \&\2},/p' -e 's/^$symcode* \([[^ ]]*\) \([[^ ]]*\)$/  {\"lib\2\", (void *) \&\2},/p'"
+lt_cv_sys_global_symbol_to_c_name_address="sed -n -e 's/^: \([[^ ]]*\)[[ ]]*$/  {\\\"\1\\\", (void *) 0},/p' -e 's/^$symcode* \([[^ ]]*\) \([[^ ]]*\)$/  {\"\2\", (void *) \&\2},/p'"
+lt_cv_sys_global_symbol_to_c_name_address_lib_prefix="sed -n -e 's/^: \([[^ ]]*\)[[ ]]*$/  {\\\"\1\\\", (void *) 0},/p' -e 's/^$symcode* \([[^ ]]*\) \(lib[[^ ]]*\)$/  {\"\2\", (void *) \&\2},/p' -e 's/^$symcode* \([[^ ]]*\) \([[^ ]]*\)$/  {\"lib\2\", (void *) \&\2},/p'"
 
 # Handle CRLF in mingw tool chain
 opt_cr=
@@ -3432,6 +3672,7 @@
   else
     lt_cv_sys_global_symbol_pipe="sed -n -e 's/^.*[[	 ]]\($symcode$symcode*\)[[	 ]][[	 ]]*$ac_symprfx$sympat$opt_cr$/$symxfrm/p'"
   fi
+  lt_cv_sys_global_symbol_pipe="$lt_cv_sys_global_symbol_pipe | sed '/ __gnu_lto/d'"
 
   # Check to see that the pipe works correctly.
   pipe_works=no
@@ -3453,7 +3694,7 @@
   if AC_TRY_EVAL(ac_compile); then
     # Now try to grab the symbols.
     nlist=conftest.nm
-    if AC_TRY_EVAL(NM conftest.$ac_objext \| $lt_cv_sys_global_symbol_pipe \> $nlist) && test -s "$nlist"; then
+    if AC_TRY_EVAL(NM conftest.$ac_objext \| "$lt_cv_sys_global_symbol_pipe" \> $nlist) && test -s "$nlist"; then
       # Try sorting and uniquifying the output.
       if sort "$nlist" | uniq > "$nlist"T; then
 	mv -f "$nlist"T "$nlist"
@@ -3465,6 +3706,18 @@
       if $GREP ' nm_test_var$' "$nlist" >/dev/null; then
 	if $GREP ' nm_test_func$' "$nlist" >/dev/null; then
 	  cat <<_LT_EOF > conftest.$ac_ext
+/* Keep this code in sync between libtool.m4, ltmain, lt_system.h, and tests.  */
+#if defined(_WIN32) || defined(__CYGWIN__) || defined(_WIN32_WCE)
+/* DATA imports from DLLs on WIN32 con't be const, because runtime
+   relocations are performed -- see ld's documentation on pseudo-relocs.  */
+# define LT@&t@_DLSYM_CONST
+#elif defined(__osf__)
+/* This system does not cope well with relocations in const data.  */
+# define LT@&t@_DLSYM_CONST
+#else
+# define LT@&t@_DLSYM_CONST const
+#endif
+
 #ifdef __cplusplus
 extern "C" {
 #endif
@@ -3476,7 +3729,7 @@
 	  cat <<_LT_EOF >> conftest.$ac_ext
 
 /* The mapping between symbol names and symbols.  */
-const struct {
+LT@&t@_DLSYM_CONST struct {
   const char *name;
   void       *address;
 }
@@ -3502,15 +3755,15 @@
 _LT_EOF
 	  # Now try linking the two files.
 	  mv conftest.$ac_objext conftstm.$ac_objext
-	  lt_save_LIBS="$LIBS"
-	  lt_save_CFLAGS="$CFLAGS"
+	  lt_globsym_save_LIBS=$LIBS
+	  lt_globsym_save_CFLAGS=$CFLAGS
 	  LIBS="conftstm.$ac_objext"
 	  CFLAGS="$CFLAGS$_LT_TAGVAR(lt_prog_compiler_no_builtin_flag, $1)"
 	  if AC_TRY_EVAL(ac_link) && test -s conftest${ac_exeext}; then
 	    pipe_works=yes
 	  fi
-	  LIBS="$lt_save_LIBS"
-	  CFLAGS="$lt_save_CFLAGS"
+	  LIBS=$lt_globsym_save_LIBS
+	  CFLAGS=$lt_globsym_save_CFLAGS
 	else
 	  echo "cannot find nm_test_func in $nlist" >&AS_MESSAGE_LOG_FD
 	fi
@@ -3543,6 +3796,13 @@
   AC_MSG_RESULT(ok)
 fi
 
+# Response file support.
+if test "$lt_cv_nm_interface" = "MS dumpbin"; then
+  nm_file_list_spec='@'
+elif $NM --help 2>/dev/null | grep '[[@]]FILE' >/dev/null; then
+  nm_file_list_spec='@'
+fi
+
 _LT_DECL([global_symbol_pipe], [lt_cv_sys_global_symbol_pipe], [1],
     [Take the output of nm and produce a listing of raw symbols and C names])
 _LT_DECL([global_symbol_to_cdecl], [lt_cv_sys_global_symbol_to_cdecl], [1],
@@ -3553,6 +3813,8 @@
 _LT_DECL([global_symbol_to_c_name_address_lib_prefix],
     [lt_cv_sys_global_symbol_to_c_name_address_lib_prefix], [1],
     [Transform the output of nm in a C name address pair when lib prefix is needed])
+_LT_DECL([], [nm_file_list_spec], [1],
+    [Specify filename containing input files for $NM])
 ]) # _LT_CMD_GLOBAL_SYMBOLS
 
 
@@ -3564,7 +3826,6 @@
 _LT_TAGVAR(lt_prog_compiler_pic, $1)=
 _LT_TAGVAR(lt_prog_compiler_static, $1)=
 
-AC_MSG_CHECKING([for $compiler option to produce PIC])
 m4_if([$1], [CXX], [
   # C++ specific cases for pic, static, wl, etc.
   if test "$GXX" = yes; then
@@ -3615,6 +3876,11 @@
       # DJGPP does not support shared libraries at all
       _LT_TAGVAR(lt_prog_compiler_pic, $1)=
       ;;
+    haiku*)
+      # PIC is the default for Haiku.
+      # The "-static" flag exists, but is broken.
+      _LT_TAGVAR(lt_prog_compiler_static, $1)=
+      ;;
     interix[[3-9]]*)
       # Interix 3.x gcc -fpic/-fPIC options generate broken code.
       # Instead, we relocate shared libraries at runtime.
@@ -3664,6 +3930,12 @@
 	  ;;
 	esac
 	;;
+      mingw* | cygwin* | os2* | pw32* | cegcc*)
+	# This hack is so that the source file can tell whether it is being
+	# built for inclusion in a dll (and should export symbols for example).
+	m4_if([$1], [GCJ], [],
+	  [_LT_TAGVAR(lt_prog_compiler_pic, $1)='-DDLL_EXPORT'])
+	;;
       dgux*)
 	case $cc_basename in
 	  ec++*)
@@ -3753,8 +4025,8 @@
 	    _LT_TAGVAR(lt_prog_compiler_pic, $1)=
 	    _LT_TAGVAR(lt_prog_compiler_static, $1)='-non_shared'
 	    ;;
-	  xlc* | xlC*)
-	    # IBM XL 8.0 on PPC
+	  xlc* | xlC* | bgxl[[cC]]* | mpixl[[cC]]*)
+	    # IBM XL 8.0, 9.0 on PPC and BlueGene
 	    _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
 	    _LT_TAGVAR(lt_prog_compiler_pic, $1)='-qpic'
 	    _LT_TAGVAR(lt_prog_compiler_static, $1)='-qstaticlink'
@@ -3784,7 +4056,7 @@
 	    ;;
 	esac
 	;;
-      netbsd* | netbsdelf*-gnu)
+      netbsd*)
 	;;
       *qnx* | *nto*)
         # QNX uses GNU C++, but need to define -shared option too, otherwise
@@ -3816,7 +4088,7 @@
 	;;
       solaris*)
 	case $cc_basename in
-	  CC*)
+	  CC* | sunCC*)
 	    # Sun C++ 4.2, 5.x and Centerline C++
 	    _LT_TAGVAR(lt_prog_compiler_pic, $1)='-KPIC'
 	    _LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
@@ -3920,6 +4192,12 @@
       _LT_TAGVAR(lt_prog_compiler_pic, $1)='-fno-common'
       ;;
 
+    haiku*)
+      # PIC is the default for Haiku.
+      # The "-static" flag exists, but is broken.
+      _LT_TAGVAR(lt_prog_compiler_static, $1)=
+      ;;
+
     hpux*)
       # PIC is the default for 64-bit PA HP-UX, but not for 32-bit
       # PA HP-UX.  On IA64 HP-UX, PIC is the default but the pic flag
@@ -3962,6 +4240,13 @@
       _LT_TAGVAR(lt_prog_compiler_pic, $1)='-fPIC'
       ;;
     esac
+
+    case $cc_basename in
+    nvcc*) # Cuda Compiler Driver 2.2
+      _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Xlinker '
+      _LT_TAGVAR(lt_prog_compiler_pic, $1)='-Xcompiler -fPIC'
+      ;;
+    esac
   else
     # PORTME Check for flag to pass linker flags through the system compiler.
     case $host_os in
@@ -4025,7 +4310,13 @@
 	_LT_TAGVAR(lt_prog_compiler_pic, $1)='--shared'
 	_LT_TAGVAR(lt_prog_compiler_static, $1)='--static'
 	;;
-      pgcc* | pgf77* | pgf90* | pgf95*)
+      nagfor*)
+	# NAG Fortran compiler
+	_LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,-Wl,,'
+	_LT_TAGVAR(lt_prog_compiler_pic, $1)='-PIC'
+	_LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
+	;;
+      pgcc* | pgf77* | pgf90* | pgf95* | pgfortran*)
         # Portland Group compilers (*not* the Pentium gcc compiler,
 	# which looks to be a dead project)
 	_LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
@@ -4037,25 +4328,25 @@
         # All Alpha code is PIC.
         _LT_TAGVAR(lt_prog_compiler_static, $1)='-non_shared'
         ;;
-      xl*)
-	# IBM XL C 8.0/Fortran 10.1 on PPC
+      xl* | bgxl* | bgf* | mpixl*)
+	# IBM XL C 8.0/Fortran 10.1, 11.1 on PPC and BlueGene
 	_LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
 	_LT_TAGVAR(lt_prog_compiler_pic, $1)='-qpic'
 	_LT_TAGVAR(lt_prog_compiler_static, $1)='-qstaticlink'
 	;;
       *)
 	case `$CC -V 2>&1 | sed 5q` in
-	*Sun\ C*)
-	  # Sun C 5.9
+	*Sun\ F* | *Sun*Fortran*)
+	  # Sun Fortran 8.3 passes all unrecognized flags to the linker
 	  _LT_TAGVAR(lt_prog_compiler_pic, $1)='-KPIC'
 	  _LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
-	  _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
+	  _LT_TAGVAR(lt_prog_compiler_wl, $1)=''
 	  ;;
-	*Sun\ F*)
-	  # Sun Fortran 8.3 passes all unrecognized flags to the linker
+	*Sun\ C*)
+	  # Sun C 5.9
 	  _LT_TAGVAR(lt_prog_compiler_pic, $1)='-KPIC'
 	  _LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
-	  _LT_TAGVAR(lt_prog_compiler_wl, $1)=''
+	  _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
 	  ;;
 	esac
 	;;
@@ -4087,7 +4378,7 @@
       _LT_TAGVAR(lt_prog_compiler_pic, $1)='-KPIC'
       _LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
       case $cc_basename in
-      f77* | f90* | f95*)
+      f77* | f90* | f95* | sunf77* | sunf90* | sunf95*)
 	_LT_TAGVAR(lt_prog_compiler_wl, $1)='-Qoption ld ';;
       *)
 	_LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,';;
@@ -4144,9 +4435,11 @@
     _LT_TAGVAR(lt_prog_compiler_pic, $1)="$_LT_TAGVAR(lt_prog_compiler_pic, $1)@&t@m4_if([$1],[],[ -DPIC],[m4_if([$1],[CXX],[ -DPIC],[])])"
     ;;
 esac
-AC_MSG_RESULT([$_LT_TAGVAR(lt_prog_compiler_pic, $1)])
-_LT_TAGDECL([wl], [lt_prog_compiler_wl], [1],
-	[How to pass a linker flag through the compiler])
+
+AC_CACHE_CHECK([for $compiler option to produce PIC],
+  [_LT_TAGVAR(lt_cv_prog_compiler_pic, $1)],
+  [_LT_TAGVAR(lt_cv_prog_compiler_pic, $1)=$_LT_TAGVAR(lt_prog_compiler_pic, $1)])
+_LT_TAGVAR(lt_prog_compiler_pic, $1)=$_LT_TAGVAR(lt_cv_prog_compiler_pic, $1)
 
 #
 # Check to make sure the PIC flag actually works.
@@ -4165,6 +4458,8 @@
 _LT_TAGDECL([pic_flag], [lt_prog_compiler_pic], [1],
 	[Additional compiler flags for building library objects])
 
+_LT_TAGDECL([wl], [lt_prog_compiler_wl], [1],
+	[How to pass a linker flag through the compiler])
 #
 # Check to make sure the static flag actually works.
 #
@@ -4185,6 +4480,7 @@
 m4_defun([_LT_LINKER_SHLIBS],
 [AC_REQUIRE([LT_PATH_LD])dnl
 AC_REQUIRE([LT_PATH_NM])dnl
+m4_require([_LT_PATH_MANIFEST_TOOL])dnl
 m4_require([_LT_FILEUTILS_DEFAULTS])dnl
 m4_require([_LT_DECL_EGREP])dnl
 m4_require([_LT_DECL_SED])dnl
@@ -4193,30 +4489,35 @@
 AC_MSG_CHECKING([whether the $compiler linker ($LD) supports shared libraries])
 m4_if([$1], [CXX], [
   _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED '\''s/.* //'\'' | sort | uniq > $export_symbols'
+  _LT_TAGVAR(exclude_expsyms, $1)=['_GLOBAL_OFFSET_TABLE_|_GLOBAL__F[ID]_.*']
   case $host_os in
   aix[[4-9]]*)
     # If we're using GNU nm, then we don't want the "-C" option.
     # -C means demangle to AIX nm, but means don't demangle with GNU nm
+    # Also, AIX nm treats weak defined symbols like other global defined
+    # symbols, whereas GNU nm marks them as "W".
     if $NM -V 2>&1 | $GREP 'GNU' > /dev/null; then
-      _LT_TAGVAR(export_symbols_cmds, $1)='$NM -Bpg $libobjs $convenience | awk '\''{ if (((\$ 2 == "T") || (\$ 2 == "D") || (\$ 2 == "B")) && ([substr](\$ 3,1,1) != ".")) { print \$ 3 } }'\'' | sort -u > $export_symbols'
+      _LT_TAGVAR(export_symbols_cmds, $1)='$NM -Bpg $libobjs $convenience | awk '\''{ if (((\$ 2 == "T") || (\$ 2 == "D") || (\$ 2 == "B") || (\$ 2 == "W")) && ([substr](\$ 3,1,1) != ".")) { print \$ 3 } }'\'' | sort -u > $export_symbols'
     else
       _LT_TAGVAR(export_symbols_cmds, $1)='$NM -BCpg $libobjs $convenience | awk '\''{ if (((\$ 2 == "T") || (\$ 2 == "D") || (\$ 2 == "B")) && ([substr](\$ 3,1,1) != ".")) { print \$ 3 } }'\'' | sort -u > $export_symbols'
     fi
     ;;
   pw32*)
     _LT_TAGVAR(export_symbols_cmds, $1)="$ltdll_cmds"
-  ;;
+    ;;
   cygwin* | mingw* | cegcc*)
-    _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[[BCDGRS]][[ ]]/s/.*[[ ]]\([[^ ]]*\)/\1 DATA/;/^.*[[ ]]__nm__/s/^.*[[ ]]__nm__\([[^ ]]*\)[[ ]][[^ ]]*/\1 DATA/;/^I[[ ]]/d;/^[[AITW]][[ ]]/s/.* //'\'' | sort | uniq > $export_symbols'
-  ;;
-  linux* | k*bsd*-gnu)
-    _LT_TAGVAR(link_all_deplibs, $1)=no
-  ;;
+    case $cc_basename in
+    cl*) ;;
+    *)
+      _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[[BCDGRS]][[ ]]/s/.*[[ ]]\([[^ ]]*\)/\1 DATA/;s/^.*[[ ]]__nm__\([[^ ]]*\)[[ ]][[^ ]]*/\1 DATA/;/^I[[ ]]/d;/^[[AITW]][[ ]]/s/.* //'\'' | sort | uniq > $export_symbols'
+      _LT_TAGVAR(exclude_expsyms, $1)=['[_]+GLOBAL_OFFSET_TABLE_|[_]+GLOBAL__[FID]_.*|[_]+head_[A-Za-z0-9_]+_dll|[A-Za-z0-9_]+_dll_iname']
+      ;;
+    esac
+    ;;
   *)
     _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED '\''s/.* //'\'' | sort | uniq > $export_symbols'
-  ;;
+    ;;
   esac
-  _LT_TAGVAR(exclude_expsyms, $1)=['_GLOBAL_OFFSET_TABLE_|_GLOBAL__F[ID]_.*']
 ], [
   runpath_var=
   _LT_TAGVAR(allow_undefined_flag, $1)=
@@ -4276,13 +4577,36 @@
   openbsd*)
     with_gnu_ld=no
     ;;
-  linux* | k*bsd*-gnu)
-    _LT_TAGVAR(link_all_deplibs, $1)=no
-    ;;
   esac
 
   _LT_TAGVAR(ld_shlibs, $1)=yes
+
+  # On some targets, GNU ld is compatible enough with the native linker
+  # that we're better off using the native interface for both.
+  lt_use_gnu_ld_interface=no
   if test "$with_gnu_ld" = yes; then
+    case $host_os in
+      aix*)
+	# The AIX port of GNU ld has always aspired to compatibility
+	# with the native linker.  However, as the warning in the GNU ld
+	# block says, versions before 2.19.5* couldn't really create working
+	# shared libraries, regardless of the interface used.
+	case `$LD -v 2>&1` in
+	  *\ \(GNU\ Binutils\)\ 2.19.5*) ;;
+	  *\ \(GNU\ Binutils\)\ 2.[[2-9]]*) ;;
+	  *\ \(GNU\ Binutils\)\ [[3-9]]*) ;;
+	  *)
+	    lt_use_gnu_ld_interface=yes
+	    ;;
+	esac
+	;;
+      *)
+	lt_use_gnu_ld_interface=yes
+	;;
+    esac
+  fi
+
+  if test "$lt_use_gnu_ld_interface" = yes; then
     # If archive_cmds runs LD, not CC, wlarc should be empty
     wlarc='${wl}'
 
@@ -4316,11 +4640,12 @@
 	_LT_TAGVAR(ld_shlibs, $1)=no
 	cat <<_LT_EOF 1>&2
 
-*** Warning: the GNU linker, at least up to release 2.9.1, is reported
+*** Warning: the GNU linker, at least up to release 2.19, is reported
 *** to be unable to reliably create shared libraries on AIX.
 *** Therefore, libtool is disabling shared libraries support.  If you
-*** really care for shared libraries, you may want to modify your PATH
-*** so that a non-GNU linker is found, and then restart.
+*** really care for shared libraries, you may want to install binutils
+*** 2.20 or above, or modify your PATH so that a non-GNU linker is found.
+*** You will then need to restart the configuration process.
 
 _LT_EOF
       fi
@@ -4356,10 +4681,12 @@
       # _LT_TAGVAR(hardcode_libdir_flag_spec, $1) is actually meaningless,
       # as there is no search path for DLLs.
       _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='-L$libdir'
+      _LT_TAGVAR(export_dynamic_flag_spec, $1)='${wl}--export-all-symbols'
       _LT_TAGVAR(allow_undefined_flag, $1)=unsupported
       _LT_TAGVAR(always_export_symbols, $1)=no
       _LT_TAGVAR(enable_shared_with_static_runtimes, $1)=yes
-      _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[[BCDGRS]][[ ]]/s/.*[[ ]]\([[^ ]]*\)/\1 DATA/'\'' | $SED -e '\''/^[[AITW]][[ ]]/s/.*[[ ]]//'\'' | sort | uniq > $export_symbols'
+      _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[[BCDGRS]][[ ]]/s/.*[[ ]]\([[^ ]]*\)/\1 DATA/;s/^.*[[ ]]__nm__\([[^ ]]*\)[[ ]][[^ ]]*/\1 DATA/;/^I[[ ]]/d;/^[[AITW]][[ ]]/s/.* //'\'' | sort | uniq > $export_symbols'
+      _LT_TAGVAR(exclude_expsyms, $1)=['[_]+GLOBAL_OFFSET_TABLE_|[_]+GLOBAL__[FID]_.*|[_]+head_[A-Za-z0-9_]+_dll|[A-Za-z0-9_]+_dll_iname']
 
       if $LD --help 2>&1 | $GREP 'auto-import' > /dev/null; then
         _LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags -o $output_objdir/$soname ${wl}--enable-auto-image-base -Xlinker --out-implib -Xlinker $lib'
@@ -4377,6 +4704,11 @@
       fi
       ;;
 
+    haiku*)
+      _LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
+      _LT_TAGVAR(link_all_deplibs, $1)=yes
+      ;;
+
     interix[[3-9]]*)
       _LT_TAGVAR(hardcode_direct, $1)=no
       _LT_TAGVAR(hardcode_shlibpath_var, $1)=no
@@ -4402,15 +4734,16 @@
       if $LD --help 2>&1 | $EGREP ': supported targets:.* elf' > /dev/null \
 	 && test "$tmp_diet" = no
       then
-	tmp_addflag=
+	tmp_addflag=' $pic_flag'
 	tmp_sharedflag='-shared'
 	case $cc_basename,$host_cpu in
         pgcc*)				# Portland Group C compiler
-	  _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; $ECHO \"$new_convenience\"` ${wl}--no-whole-archive'
+	  _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` ${wl}--no-whole-archive'
 	  tmp_addflag=' $pic_flag'
 	  ;;
-	pgf77* | pgf90* | pgf95*)	# Portland Group f77 and f90 compilers
-	  _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; $ECHO \"$new_convenience\"` ${wl}--no-whole-archive'
+	pgf77* | pgf90* | pgf95* | pgfortran*)
+					# Portland Group f77 and f90 compilers
+	  _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` ${wl}--no-whole-archive'
 	  tmp_addflag=' $pic_flag -Mnomain' ;;
 	ecc*,ia64* | icc*,ia64*)	# Intel C compiler on ia64
 	  tmp_addflag=' -i_dynamic' ;;
@@ -4421,13 +4754,17 @@
 	lf95*)				# Lahey Fortran 8.1
 	  _LT_TAGVAR(whole_archive_flag_spec, $1)=
 	  tmp_sharedflag='--shared' ;;
-	xl[[cC]]*)			# IBM XL C 8.0 on PPC (deal with xlf below)
+	xl[[cC]]* | bgxl[[cC]]* | mpixl[[cC]]*) # IBM XL C 8.0 on PPC (deal with xlf below)
 	  tmp_sharedflag='-qmkshrobj'
 	  tmp_addflag= ;;
+	nvcc*)	# Cuda Compiler Driver 2.2
+	  _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` ${wl}--no-whole-archive'
+	  _LT_TAGVAR(compiler_needs_object, $1)=yes
+	  ;;
 	esac
 	case `$CC -V 2>&1 | sed 5q` in
 	*Sun\ C*)			# Sun C 5.9
-	  _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`new_convenience=; for conv in $convenience\"\"; do test -z \"$conv\" || new_convenience=\"$new_convenience,$conv\"; done; $ECHO \"$new_convenience\"` ${wl}--no-whole-archive'
+	  _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`new_convenience=; for conv in $convenience\"\"; do test -z \"$conv\" || new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` ${wl}--no-whole-archive'
 	  _LT_TAGVAR(compiler_needs_object, $1)=yes
 	  tmp_sharedflag='-G' ;;
 	*Sun\ F*)			# Sun Fortran 8.3
@@ -4443,17 +4780,17 @@
         fi
 
 	case $cc_basename in
-	xlf*)
+	xlf* | bgf* | bgxlf* | mpixlf*)
 	  # IBM XL Fortran 10.1 on PPC cannot create shared libs itself
 	  _LT_TAGVAR(whole_archive_flag_spec, $1)='--whole-archive$convenience --no-whole-archive'
 	  _LT_TAGVAR(hardcode_libdir_flag_spec, $1)=
 	  _LT_TAGVAR(hardcode_libdir_flag_spec_ld, $1)='-rpath $libdir'
-	  _LT_TAGVAR(archive_cmds, $1)='$LD -shared $libobjs $deplibs $compiler_flags -soname $soname -o $lib'
+	  _LT_TAGVAR(archive_cmds, $1)='$LD -shared $libobjs $deplibs $linker_flags -soname $soname -o $lib'
 	  if test "x$supports_anon_versioning" = xyes; then
 	    _LT_TAGVAR(archive_expsym_cmds, $1)='echo "{ global:" > $output_objdir/$libname.ver~
 	      cat $export_symbols | sed -e "s/\(.*\)/\1;/" >> $output_objdir/$libname.ver~
 	      echo "local: *; };" >> $output_objdir/$libname.ver~
-	      $LD -shared $libobjs $deplibs $compiler_flags -soname $soname -version-script $output_objdir/$libname.ver -o $lib'
+	      $LD -shared $libobjs $deplibs $linker_flags -soname $soname -version-script $output_objdir/$libname.ver -o $lib'
 	  fi
 	  ;;
 	esac
@@ -4462,13 +4799,13 @@
       fi
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	_LT_TAGVAR(archive_cmds, $1)='$LD -Bshareable $libobjs $deplibs $linker_flags -o $lib'
 	wlarc=
       else
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
-	_LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
+	_LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
       fi
       ;;
 
@@ -4486,8 +4823,8 @@
 
 _LT_EOF
       elif $LD --help 2>&1 | $GREP ': supported targets:.* elf' > /dev/null; then
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
-	_LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
+	_LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
       else
 	_LT_TAGVAR(ld_shlibs, $1)=no
       fi
@@ -4533,8 +4870,8 @@
 
     *)
       if $LD --help 2>&1 | $GREP ': supported targets:.* elf' > /dev/null; then
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
-	_LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
+	_LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
       else
 	_LT_TAGVAR(ld_shlibs, $1)=no
       fi
@@ -4574,8 +4911,10 @@
       else
 	# If we're using GNU nm, then we don't want the "-C" option.
 	# -C means demangle to AIX nm, but means don't demangle with GNU nm
+	# Also, AIX nm treats weak defined symbols like other global
+	# defined symbols, whereas GNU nm marks them as "W".
 	if $NM -V 2>&1 | $GREP 'GNU' > /dev/null; then
-	  _LT_TAGVAR(export_symbols_cmds, $1)='$NM -Bpg $libobjs $convenience | awk '\''{ if (((\$ 2 == "T") || (\$ 2 == "D") || (\$ 2 == "B")) && ([substr](\$ 3,1,1) != ".")) { print \$ 3 } }'\'' | sort -u > $export_symbols'
+	  _LT_TAGVAR(export_symbols_cmds, $1)='$NM -Bpg $libobjs $convenience | awk '\''{ if (((\$ 2 == "T") || (\$ 2 == "D") || (\$ 2 == "B") || (\$ 2 == "W")) && ([substr](\$ 3,1,1) != ".")) { print \$ 3 } }'\'' | sort -u > $export_symbols'
 	else
 	  _LT_TAGVAR(export_symbols_cmds, $1)='$NM -BCpg $libobjs $convenience | awk '\''{ if (((\$ 2 == "T") || (\$ 2 == "D") || (\$ 2 == "B")) && ([substr](\$ 3,1,1) != ".")) { print \$ 3 } }'\'' | sort -u > $export_symbols'
 	fi
@@ -4637,7 +4976,6 @@
 	if test "$aix_use_runtimelinking" = yes; then
 	  shared_flag="$shared_flag "'${wl}-G'
 	fi
-	_LT_TAGVAR(link_all_deplibs, $1)=no
       else
 	# not using gcc
 	if test "$host_cpu" = ia64; then
@@ -4663,9 +5001,9 @@
 	_LT_TAGVAR(allow_undefined_flag, $1)='-berok'
         # Determine the default libpath from the value encoded in an
         # empty executable.
-        _LT_SYS_MODULE_PATH_AIX
+        _LT_SYS_MODULE_PATH_AIX([$1])
         _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-blibpath:$libdir:'"$aix_libpath"
-        _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -o $output_objdir/$soname $libobjs $deplibs '"\${wl}$no_entry_flag"' $compiler_flags `if test "x${allow_undefined_flag}" != "x"; then $ECHO "X${wl}${allow_undefined_flag}" | $Xsed; else :; fi` '"\${wl}$exp_sym_flag:\$export_symbols $shared_flag"
+        _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -o $output_objdir/$soname $libobjs $deplibs '"\${wl}$no_entry_flag"' $compiler_flags `if test "x${allow_undefined_flag}" != "x"; then func_echo_all "${wl}${allow_undefined_flag}"; else :; fi` '"\${wl}$exp_sym_flag:\$export_symbols $shared_flag"
       else
 	if test "$host_cpu" = ia64; then
 	  _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-R $libdir:/usr/lib:/lib'
@@ -4674,14 +5012,19 @@
 	else
 	 # Determine the default libpath from the value encoded in an
 	 # empty executable.
-	 _LT_SYS_MODULE_PATH_AIX
+	 _LT_SYS_MODULE_PATH_AIX([$1])
 	 _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-blibpath:$libdir:'"$aix_libpath"
 	  # Warning - without using the other run time loading flags,
 	  # -berok will link without error, but may produce a broken library.
 	  _LT_TAGVAR(no_undefined_flag, $1)=' ${wl}-bernotok'
 	  _LT_TAGVAR(allow_undefined_flag, $1)=' ${wl}-berok'
-	  # Exported symbols can be pulled into shared objects from archives
-	  _LT_TAGVAR(whole_archive_flag_spec, $1)='$convenience'
+	  if test "$with_gnu_ld" = yes; then
+	    # We only use this code for GNU lds that support --whole-archive.
+	    _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive$convenience ${wl}--no-whole-archive'
+	  else
+	    # Exported symbols can be pulled into shared objects from archives
+	    _LT_TAGVAR(whole_archive_flag_spec, $1)='$convenience'
+	  fi
 	  _LT_TAGVAR(archive_cmds_need_lc, $1)=yes
 	  # This is similar to how AIX traditionally builds its shared libraries.
 	  _LT_TAGVAR(archive_expsym_cmds, $1)="\$CC $shared_flag"' -o $output_objdir/$soname $libobjs $deplibs ${wl}-bnoentry $compiler_flags ${wl}-bE:$export_symbols${allow_undefined_flag}~$AR $AR_FLAGS $output_objdir/$libname$release.a $output_objdir/$soname'
@@ -4713,20 +5056,63 @@
       # Microsoft Visual C++.
       # hardcode_libdir_flag_spec is actually meaningless, as there is
       # no search path for DLLs.
-      _LT_TAGVAR(hardcode_libdir_flag_spec, $1)=' '
-      _LT_TAGVAR(allow_undefined_flag, $1)=unsupported
-      # Tell ltmain to make .lib files, not .a files.
-      libext=lib
-      # Tell ltmain to make .dll files, not .so files.
-      shrext_cmds=".dll"
-      # FIXME: Setting linknames here is a bad hack.
-      _LT_TAGVAR(archive_cmds, $1)='$CC -o $lib $libobjs $compiler_flags `$ECHO "X$deplibs" | $Xsed -e '\''s/ -lc$//'\''` -link -dll~linknames='
-      # The linker will automatically build a .lib file if we build a DLL.
-      _LT_TAGVAR(old_archive_from_new_cmds, $1)='true'
-      # FIXME: Should let the user specify the lib program.
-      _LT_TAGVAR(old_archive_cmds, $1)='lib -OUT:$oldlib$oldobjs$old_deplibs'
-      _LT_TAGVAR(fix_srcfile_path, $1)='`cygpath -w "$srcfile"`'
-      _LT_TAGVAR(enable_shared_with_static_runtimes, $1)=yes
+      case $cc_basename in
+      cl*)
+	# Native MSVC
+	_LT_TAGVAR(hardcode_libdir_flag_spec, $1)=' '
+	_LT_TAGVAR(allow_undefined_flag, $1)=unsupported
+	_LT_TAGVAR(always_export_symbols, $1)=yes
+	_LT_TAGVAR(file_list_spec, $1)='@'
+	# Tell ltmain to make .lib files, not .a files.
+	libext=lib
+	# Tell ltmain to make .dll files, not .so files.
+	shrext_cmds=".dll"
+	# FIXME: Setting linknames here is a bad hack.
+	_LT_TAGVAR(archive_cmds, $1)='$CC -o $output_objdir/$soname $libobjs $compiler_flags $deplibs -Wl,-dll~linknames='
+	_LT_TAGVAR(archive_expsym_cmds, $1)='if test "x`$SED 1q $export_symbols`" = xEXPORTS; then
+	    sed -n -e 's/\\\\\\\(.*\\\\\\\)/-link\\\ -EXPORT:\\\\\\\1/' -e '1\\\!p' < $export_symbols > $output_objdir/$soname.exp;
+	  else
+	    sed -e 's/\\\\\\\(.*\\\\\\\)/-link\\\ -EXPORT:\\\\\\\1/' < $export_symbols > $output_objdir/$soname.exp;
+	  fi~
+	  $CC -o $tool_output_objdir$soname $libobjs $compiler_flags $deplibs "@$tool_output_objdir$soname.exp" -Wl,-DLL,-IMPLIB:"$tool_output_objdir$libname.dll.lib"~
+	  linknames='
+	# The linker will not automatically build a static lib if we build a DLL.
+	# _LT_TAGVAR(old_archive_from_new_cmds, $1)='true'
+	_LT_TAGVAR(enable_shared_with_static_runtimes, $1)=yes
+	_LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[[BCDGRS]][[ ]]/s/.*[[ ]]\([[^ ]]*\)/\1,DATA/'\'' | $SED -e '\''/^[[AITW]][[ ]]/s/.*[[ ]]//'\'' | sort | uniq > $export_symbols'
+	# Don't use ranlib
+	_LT_TAGVAR(old_postinstall_cmds, $1)='chmod 644 $oldlib'
+	_LT_TAGVAR(postlink_cmds, $1)='lt_outputfile="@OUTPUT@"~
+	  lt_tool_outputfile="@TOOL_OUTPUT@"~
+	  case $lt_outputfile in
+	    *.exe|*.EXE) ;;
+	    *)
+	      lt_outputfile="$lt_outputfile.exe"
+	      lt_tool_outputfile="$lt_tool_outputfile.exe"
+	      ;;
+	  esac~
+	  if test "$MANIFEST_TOOL" != ":" && test -f "$lt_outputfile.manifest"; then
+	    $MANIFEST_TOOL -manifest "$lt_tool_outputfile.manifest" -outputresource:"$lt_tool_outputfile" || exit 1;
+	    $RM "$lt_outputfile.manifest";
+	  fi'
+	;;
+      *)
+	# Assume MSVC wrapper
+	_LT_TAGVAR(hardcode_libdir_flag_spec, $1)=' '
+	_LT_TAGVAR(allow_undefined_flag, $1)=unsupported
+	# Tell ltmain to make .lib files, not .a files.
+	libext=lib
+	# Tell ltmain to make .dll files, not .so files.
+	shrext_cmds=".dll"
+	# FIXME: Setting linknames here is a bad hack.
+	_LT_TAGVAR(archive_cmds, $1)='$CC -o $lib $libobjs $compiler_flags `func_echo_all "$deplibs" | $SED '\''s/ -lc$//'\''` -link -dll~linknames='
+	# The linker will automatically build a .lib file if we build a DLL.
+	_LT_TAGVAR(old_archive_from_new_cmds, $1)='true'
+	# FIXME: Should let the user specify the lib program.
+	_LT_TAGVAR(old_archive_cmds, $1)='lib -OUT:$oldlib$oldobjs$old_deplibs'
+	_LT_TAGVAR(enable_shared_with_static_runtimes, $1)=yes
+	;;
+      esac
       ;;
 
     darwin* | rhapsody*)
@@ -4764,7 +5150,7 @@
 
     # FreeBSD 3 and greater uses gcc -shared to do shared libraries.
     freebsd* | dragonfly*)
-      _LT_TAGVAR(archive_cmds, $1)='$CC -shared -o $lib $libobjs $deplibs $compiler_flags'
+      _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag -o $lib $libobjs $deplibs $compiler_flags'
       _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='-R$libdir'
       _LT_TAGVAR(hardcode_direct, $1)=yes
       _LT_TAGVAR(hardcode_shlibpath_var, $1)=no
@@ -4772,7 +5158,7 @@
 
     hpux9*)
       if test "$GCC" = yes; then
-	_LT_TAGVAR(archive_cmds, $1)='$RM $output_objdir/$soname~$CC -shared -fPIC ${wl}+b ${wl}$install_libdir -o $output_objdir/$soname $libobjs $deplibs $compiler_flags~test $output_objdir/$soname = $lib || mv $output_objdir/$soname $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$RM $output_objdir/$soname~$CC -shared $pic_flag ${wl}+b ${wl}$install_libdir -o $output_objdir/$soname $libobjs $deplibs $compiler_flags~test $output_objdir/$soname = $lib || mv $output_objdir/$soname $lib'
       else
 	_LT_TAGVAR(archive_cmds, $1)='$RM $output_objdir/$soname~$LD -b +b $install_libdir -o $output_objdir/$soname $libobjs $deplibs $linker_flags~test $output_objdir/$soname = $lib || mv $output_objdir/$soname $lib'
       fi
@@ -4787,8 +5173,8 @@
       ;;
 
     hpux10*)
-      if test "$GCC" = yes -a "$with_gnu_ld" = no; then
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared -fPIC ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $libobjs $deplibs $compiler_flags'
+      if test "$GCC" = yes && test "$with_gnu_ld" = no; then
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $libobjs $deplibs $compiler_flags'
       else
 	_LT_TAGVAR(archive_cmds, $1)='$LD -b +h $soname +b $install_libdir -o $lib $libobjs $deplibs $linker_flags'
       fi
@@ -4806,16 +5192,16 @@
       ;;
 
     hpux11*)
-      if test "$GCC" = yes -a "$with_gnu_ld" = no; then
+      if test "$GCC" = yes && test "$with_gnu_ld" = no; then
 	case $host_cpu in
 	hppa*64*)
 	  _LT_TAGVAR(archive_cmds, $1)='$CC -shared ${wl}+h ${wl}$soname -o $lib $libobjs $deplibs $compiler_flags'
 	  ;;
 	ia64*)
-	  _LT_TAGVAR(archive_cmds, $1)='$CC -shared -fPIC ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $libobjs $deplibs $compiler_flags'
+	  _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $libobjs $deplibs $compiler_flags'
 	  ;;
 	*)
-	  _LT_TAGVAR(archive_cmds, $1)='$CC -shared -fPIC ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $libobjs $deplibs $compiler_flags'
+	  _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $libobjs $deplibs $compiler_flags'
 	  ;;
 	esac
       else
@@ -4827,7 +5213,14 @@
 	  _LT_TAGVAR(archive_cmds, $1)='$CC -b ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $libobjs $deplibs $compiler_flags'
 	  ;;
 	*)
-	  _LT_TAGVAR(archive_cmds, $1)='$CC -b ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $libobjs $deplibs $compiler_flags'
+	m4_if($1, [], [
+	  # Older versions of the 11.00 compiler do not understand -b yet
+	  # (HP92453-01 A.11.01.20 doesn't, HP92453-01 B.11.X.35175-35176.GP does)
+	  _LT_LINKER_OPTION([if $CC understands -b],
+	    _LT_TAGVAR(lt_cv_prog_compiler__b, $1), [-b],
+	    [_LT_TAGVAR(archive_cmds, $1)='$CC -b ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $libobjs $deplibs $compiler_flags'],
+	    [_LT_TAGVAR(archive_cmds, $1)='$LD -b +h $soname +b $install_libdir -o $lib $libobjs $deplibs $linker_flags'])],
+	  [_LT_TAGVAR(archive_cmds, $1)='$CC -b ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $libobjs $deplibs $compiler_flags'])
 	  ;;
 	esac
       fi
@@ -4855,19 +5248,34 @@
 
     irix5* | irix6* | nonstopux*)
       if test "$GCC" = yes; then
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && $ECHO "X${wl}-set_version ${wl}$verstring" | $Xsed` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
 	# Try to use the -exported_symbol ld option, if it does not
 	# work, assume that -exports_file does not work either and
 	# implicitly export all symbols.
-        save_LDFLAGS="$LDFLAGS"
-        LDFLAGS="$LDFLAGS -shared ${wl}-exported_symbol ${wl}foo ${wl}-update_registry ${wl}/dev/null"
-        AC_LINK_IFELSE(int foo(void) {},
-          _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && $ECHO "X${wl}-set_version ${wl}$verstring" | $Xsed` ${wl}-update_registry ${wl}${output_objdir}/so_locations ${wl}-exports_file ${wl}$export_symbols -o $lib'
-        )
-        LDFLAGS="$save_LDFLAGS"
+	# This should be the same for all languages, so no per-tag cache variable.
+	AC_CACHE_CHECK([whether the $host_os linker accepts -exported_symbol],
+	  [lt_cv_irix_exported_symbol],
+	  [save_LDFLAGS="$LDFLAGS"
+	   LDFLAGS="$LDFLAGS -shared ${wl}-exported_symbol ${wl}foo ${wl}-update_registry ${wl}/dev/null"
+	   AC_LINK_IFELSE(
+	     [AC_LANG_SOURCE(
+	        [AC_LANG_CASE([C], [[int foo (void) { return 0; }]],
+			      [C++], [[int foo (void) { return 0; }]],
+			      [Fortran 77], [[
+      subroutine foo
+      end]],
+			      [Fortran], [[
+      subroutine foo
+      end]])])],
+	      [lt_cv_irix_exported_symbol=yes],
+	      [lt_cv_irix_exported_symbol=no])
+           LDFLAGS="$save_LDFLAGS"])
+	if test "$lt_cv_irix_exported_symbol" = yes; then
+          _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations ${wl}-exports_file ${wl}$export_symbols -o $lib'
+	fi
       else
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags -soname $soname `test -n "$verstring" && $ECHO "X-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -o $lib'
-	_LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags -soname $soname `test -n "$verstring" && $ECHO "X-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -exports_file $export_symbols -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags -soname $soname `test -n "$verstring" && func_echo_all "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
+	_LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags -soname $soname `test -n "$verstring" && func_echo_all "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -exports_file $export_symbols -o $lib'
       fi
       _LT_TAGVAR(archive_cmds_need_lc, $1)='no'
       _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath ${wl}$libdir'
@@ -4876,7 +5284,7 @@
       _LT_TAGVAR(link_all_deplibs, $1)=yes
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	_LT_TAGVAR(archive_cmds, $1)='$LD -Bshareable -o $lib $libobjs $deplibs $linker_flags'  # a.out
       else
@@ -4929,17 +5337,17 @@
       _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='-L$libdir'
       _LT_TAGVAR(hardcode_minus_L, $1)=yes
       _LT_TAGVAR(allow_undefined_flag, $1)=unsupported
-      _LT_TAGVAR(archive_cmds, $1)='$ECHO "LIBRARY $libname INITINSTANCE" > $output_objdir/$libname.def~$ECHO "DESCRIPTION \"$libname\"" >> $output_objdir/$libname.def~$ECHO DATA >> $output_objdir/$libname.def~$ECHO " SINGLE NONSHARED" >> $output_objdir/$libname.def~$ECHO EXPORTS >> $output_objdir/$libname.def~emxexp $libobjs >> $output_objdir/$libname.def~$CC -Zdll -Zcrtdll -o $lib $libobjs $deplibs $compiler_flags $output_objdir/$libname.def'
+      _LT_TAGVAR(archive_cmds, $1)='$ECHO "LIBRARY $libname INITINSTANCE" > $output_objdir/$libname.def~$ECHO "DESCRIPTION \"$libname\"" >> $output_objdir/$libname.def~echo DATA >> $output_objdir/$libname.def~echo " SINGLE NONSHARED" >> $output_objdir/$libname.def~echo EXPORTS >> $output_objdir/$libname.def~emxexp $libobjs >> $output_objdir/$libname.def~$CC -Zdll -Zcrtdll -o $lib $libobjs $deplibs $compiler_flags $output_objdir/$libname.def'
       _LT_TAGVAR(old_archive_from_new_cmds, $1)='emximp -o $output_objdir/$libname.a $output_objdir/$libname.def'
       ;;
 
     osf3*)
       if test "$GCC" = yes; then
 	_LT_TAGVAR(allow_undefined_flag, $1)=' ${wl}-expect_unresolved ${wl}\*'
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $libobjs $deplibs $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && $ECHO "X${wl}-set_version ${wl}$verstring" | $Xsed` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $libobjs $deplibs $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
       else
 	_LT_TAGVAR(allow_undefined_flag, $1)=' -expect_unresolved \*'
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $libobjs $deplibs $compiler_flags -soname $soname `test -n "$verstring" && $ECHO "X-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $libobjs $deplibs $compiler_flags -soname $soname `test -n "$verstring" && func_echo_all "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
       fi
       _LT_TAGVAR(archive_cmds_need_lc, $1)='no'
       _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath ${wl}$libdir'
@@ -4949,13 +5357,13 @@
     osf4* | osf5*)	# as osf3* with the addition of -msym flag
       if test "$GCC" = yes; then
 	_LT_TAGVAR(allow_undefined_flag, $1)=' ${wl}-expect_unresolved ${wl}\*'
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $libobjs $deplibs $compiler_flags ${wl}-msym ${wl}-soname ${wl}$soname `test -n "$verstring" && $ECHO "X${wl}-set_version ${wl}$verstring" | $Xsed` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $pic_flag $libobjs $deplibs $compiler_flags ${wl}-msym ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
 	_LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath ${wl}$libdir'
       else
 	_LT_TAGVAR(allow_undefined_flag, $1)=' -expect_unresolved \*'
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $libobjs $deplibs $compiler_flags -msym -soname $soname `test -n "$verstring" && $ECHO "X-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -o $lib'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $libobjs $deplibs $compiler_flags -msym -soname $soname `test -n "$verstring" && func_echo_all "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
 	_LT_TAGVAR(archive_expsym_cmds, $1)='for i in `cat $export_symbols`; do printf "%s %s\\n" -exported_symbol "\$i" >> $lib.exp; done; printf "%s\\n" "-hidden">> $lib.exp~
-	$CC -shared${allow_undefined_flag} ${wl}-input ${wl}$lib.exp $compiler_flags $libobjs $deplibs -soname $soname `test -n "$verstring" && $ECHO "X-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -o $lib~$RM $lib.exp'
+	$CC -shared${allow_undefined_flag} ${wl}-input ${wl}$lib.exp $compiler_flags $libobjs $deplibs -soname $soname `test -n "$verstring" && $ECHO "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib~$RM $lib.exp'
 
 	# Both c and cxx compiler support -rpath directly
 	_LT_TAGVAR(hardcode_libdir_flag_spec, $1)='-rpath $libdir'
@@ -4968,9 +5376,9 @@
       _LT_TAGVAR(no_undefined_flag, $1)=' -z defs'
       if test "$GCC" = yes; then
 	wlarc='${wl}'
-	_LT_TAGVAR(archive_cmds, $1)='$CC -shared ${wl}-z ${wl}text ${wl}-h ${wl}$soname -o $lib $libobjs $deplibs $compiler_flags'
+	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag ${wl}-z ${wl}text ${wl}-h ${wl}$soname -o $lib $libobjs $deplibs $compiler_flags'
 	_LT_TAGVAR(archive_expsym_cmds, $1)='echo "{ global:" > $lib.exp~cat $export_symbols | $SED -e "s/\(.*\)/\1;/" >> $lib.exp~echo "local: *; };" >> $lib.exp~
-	  $CC -shared ${wl}-z ${wl}text ${wl}-M ${wl}$lib.exp ${wl}-h ${wl}$soname -o $lib $libobjs $deplibs $compiler_flags~$RM $lib.exp'
+	  $CC -shared $pic_flag ${wl}-z ${wl}text ${wl}-M ${wl}$lib.exp ${wl}-h ${wl}$soname -o $lib $libobjs $deplibs $compiler_flags~$RM $lib.exp'
       else
 	case `$CC -V 2>&1` in
 	*"Compilers 5.0"*)
@@ -5146,36 +5554,38 @@
       # Test whether the compiler implicitly links with -lc since on some
       # systems, -lgcc has to come before -lc. If gcc already passes -lc
       # to ld, don't add -lc before -lgcc.
-      AC_MSG_CHECKING([whether -lc should be explicitly linked in])
-      $RM conftest*
-      echo "$lt_simple_compile_test_code" > conftest.$ac_ext
-
-      if AC_TRY_EVAL(ac_compile) 2>conftest.err; then
-        soname=conftest
-        lib=conftest
-        libobjs=conftest.$ac_objext
-        deplibs=
-        wl=$_LT_TAGVAR(lt_prog_compiler_wl, $1)
-	pic_flag=$_LT_TAGVAR(lt_prog_compiler_pic, $1)
-        compiler_flags=-v
-        linker_flags=-v
-        verstring=
-        output_objdir=.
-        libname=conftest
-        lt_save_allow_undefined_flag=$_LT_TAGVAR(allow_undefined_flag, $1)
-        _LT_TAGVAR(allow_undefined_flag, $1)=
-        if AC_TRY_EVAL(_LT_TAGVAR(archive_cmds, $1) 2\>\&1 \| $GREP \" -lc \" \>/dev/null 2\>\&1)
-        then
-	  _LT_TAGVAR(archive_cmds_need_lc, $1)=no
-        else
-	  _LT_TAGVAR(archive_cmds_need_lc, $1)=yes
-        fi
-        _LT_TAGVAR(allow_undefined_flag, $1)=$lt_save_allow_undefined_flag
-      else
-        cat conftest.err 1>&5
-      fi
-      $RM conftest*
-      AC_MSG_RESULT([$_LT_TAGVAR(archive_cmds_need_lc, $1)])
+      AC_CACHE_CHECK([whether -lc should be explicitly linked in],
+	[lt_cv_]_LT_TAGVAR(archive_cmds_need_lc, $1),
+	[$RM conftest*
+	echo "$lt_simple_compile_test_code" > conftest.$ac_ext
+
+	if AC_TRY_EVAL(ac_compile) 2>conftest.err; then
+	  soname=conftest
+	  lib=conftest
+	  libobjs=conftest.$ac_objext
+	  deplibs=
+	  wl=$_LT_TAGVAR(lt_prog_compiler_wl, $1)
+	  pic_flag=$_LT_TAGVAR(lt_prog_compiler_pic, $1)
+	  compiler_flags=-v
+	  linker_flags=-v
+	  verstring=
+	  output_objdir=.
+	  libname=conftest
+	  lt_save_allow_undefined_flag=$_LT_TAGVAR(allow_undefined_flag, $1)
+	  _LT_TAGVAR(allow_undefined_flag, $1)=
+	  if AC_TRY_EVAL(_LT_TAGVAR(archive_cmds, $1) 2\>\&1 \| $GREP \" -lc \" \>/dev/null 2\>\&1)
+	  then
+	    lt_cv_[]_LT_TAGVAR(archive_cmds_need_lc, $1)=no
+	  else
+	    lt_cv_[]_LT_TAGVAR(archive_cmds_need_lc, $1)=yes
+	  fi
+	  _LT_TAGVAR(allow_undefined_flag, $1)=$lt_save_allow_undefined_flag
+	else
+	  cat conftest.err 1>&5
+	fi
+	$RM conftest*
+	])
+      _LT_TAGVAR(archive_cmds_need_lc, $1)=$lt_cv_[]_LT_TAGVAR(archive_cmds_need_lc, $1)
       ;;
     esac
   fi
@@ -5240,8 +5650,6 @@
     to runtime path list])
 _LT_TAGDECL([], [link_all_deplibs], [0],
     [Whether libtool must link a program against all its dependency libraries])
-_LT_TAGDECL([], [fix_srcfile_path], [1],
-    [Fix the shell variable $srcfile for the compiler])
 _LT_TAGDECL([], [always_export_symbols], [0],
     [Set to "yes" if exported symbols are required])
 _LT_TAGDECL([], [export_symbols_cmds], [2],
@@ -5252,6 +5660,8 @@
     [Symbols that must always be exported])
 _LT_TAGDECL([], [prelink_cmds], [2],
     [Commands necessary for linking programs (against libraries) with templates])
+_LT_TAGDECL([], [postlink_cmds], [2],
+    [Commands necessary for finishing linking programs])
 _LT_TAGDECL([], [file_list_spec], [1],
     [Specify filename containing input files])
 dnl FIXME: Not yet implemented
@@ -5341,37 +5751,22 @@
 ])# _LT_LANG_C_CONFIG
 
 
-# _LT_PROG_CXX
-# ------------
-# Since AC_PROG_CXX is broken, in that it returns g++ if there is no c++
-# compiler, we have our own version here.
-m4_defun([_LT_PROG_CXX],
-[
-pushdef([AC_MSG_ERROR], [_lt_caught_CXX_error=yes])
-AC_PROG_CXX
-if test -n "$CXX" && ( test "X$CXX" != "Xno" &&
-    ( (test "X$CXX" = "Xg++" && `g++ -v >/dev/null 2>&1` ) ||
-    (test "X$CXX" != "Xg++"))) ; then
-  AC_PROG_CXXCPP
-else
-  _lt_caught_CXX_error=yes
-fi
-popdef([AC_MSG_ERROR])
-])# _LT_PROG_CXX
-
-dnl aclocal-1.4 backwards compatibility:
-dnl AC_DEFUN([_LT_PROG_CXX], [])
-
-
 # _LT_LANG_CXX_CONFIG([TAG])
 # --------------------------
 # Ensure that the configuration variables for a C++ compiler are suitably
 # defined.  These variables are subsequently used by _LT_CONFIG to write
 # the compiler configuration to `libtool'.
 m4_defun([_LT_LANG_CXX_CONFIG],
-[AC_REQUIRE([_LT_PROG_CXX])dnl
-m4_require([_LT_FILEUTILS_DEFAULTS])dnl
+[m4_require([_LT_FILEUTILS_DEFAULTS])dnl
 m4_require([_LT_DECL_EGREP])dnl
+m4_require([_LT_PATH_MANIFEST_TOOL])dnl
+if test -n "$CXX" && ( test "X$CXX" != "Xno" &&
+    ( (test "X$CXX" = "Xg++" && `g++ -v >/dev/null 2>&1` ) ||
+    (test "X$CXX" != "Xg++"))) ; then
+  AC_PROG_CXXCPP
+else
+  _lt_caught_CXX_error=yes
+fi
 
 AC_LANG_PUSH(C++)
 _LT_TAGVAR(archive_cmds_need_lc, $1)=no
@@ -5393,6 +5788,8 @@
 _LT_TAGVAR(module_expsym_cmds, $1)=
 _LT_TAGVAR(link_all_deplibs, $1)=unknown
 _LT_TAGVAR(old_archive_cmds, $1)=$old_archive_cmds
+_LT_TAGVAR(reload_flag, $1)=$reload_flag
+_LT_TAGVAR(reload_cmds, $1)=$reload_cmds
 _LT_TAGVAR(no_undefined_flag, $1)=
 _LT_TAGVAR(whole_archive_flag_spec, $1)=
 _LT_TAGVAR(enable_shared_with_static_runtimes, $1)=no
@@ -5424,6 +5821,7 @@
 
   # Allow CC to be a program name with arguments.
   lt_save_CC=$CC
+  lt_save_CFLAGS=$CFLAGS
   lt_save_LD=$LD
   lt_save_GCC=$GCC
   GCC=$GXX
@@ -5441,6 +5839,7 @@
   fi
   test -z "${LDCXX+set}" || LD=$LDCXX
   CC=${CXX-"c++"}
+  CFLAGS=$CXXFLAGS
   compiler=$CC
   _LT_TAGVAR(compiler, $1)=$CC
   _LT_CC_BASENAME([$compiler])
@@ -5462,8 +5861,8 @@
       # Check if GNU C++ uses GNU ld as the underlying linker, since the
       # archiving commands below assume that GNU ld is being used.
       if test "$with_gnu_ld" = yes; then
-        _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname -o $lib'
-        _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
+        _LT_TAGVAR(archive_cmds, $1)='$CC $pic_flag -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname -o $lib'
+        _LT_TAGVAR(archive_expsym_cmds, $1)='$CC $pic_flag -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
 
         _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath ${wl}$libdir'
         _LT_TAGVAR(export_dynamic_flag_spec, $1)='${wl}--export-dynamic'
@@ -5495,7 +5894,7 @@
       # Commands to make compiler produce verbose output that lists
       # what "hidden" libraries, object files and flags are used when
       # linking a shared library.
-      output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "\-L"'
+      output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP -v "^Configured with:" | $GREP "\-L"'
 
     else
       GXX=no
@@ -5604,10 +6003,10 @@
           _LT_TAGVAR(allow_undefined_flag, $1)='-berok'
           # Determine the default libpath from the value encoded in an empty
           # executable.
-          _LT_SYS_MODULE_PATH_AIX
+          _LT_SYS_MODULE_PATH_AIX([$1])
           _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-blibpath:$libdir:'"$aix_libpath"
 
-          _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -o $output_objdir/$soname $libobjs $deplibs '"\${wl}$no_entry_flag"' $compiler_flags `if test "x${allow_undefined_flag}" != "x"; then $ECHO "X${wl}${allow_undefined_flag}" | $Xsed; else :; fi` '"\${wl}$exp_sym_flag:\$export_symbols $shared_flag"
+          _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -o $output_objdir/$soname $libobjs $deplibs '"\${wl}$no_entry_flag"' $compiler_flags `if test "x${allow_undefined_flag}" != "x"; then func_echo_all "${wl}${allow_undefined_flag}"; else :; fi` '"\${wl}$exp_sym_flag:\$export_symbols $shared_flag"
         else
           if test "$host_cpu" = ia64; then
 	    _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-R $libdir:/usr/lib:/lib'
@@ -5616,14 +6015,19 @@
           else
 	    # Determine the default libpath from the value encoded in an
 	    # empty executable.
-	    _LT_SYS_MODULE_PATH_AIX
+	    _LT_SYS_MODULE_PATH_AIX([$1])
 	    _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-blibpath:$libdir:'"$aix_libpath"
 	    # Warning - without using the other run time loading flags,
 	    # -berok will link without error, but may produce a broken library.
 	    _LT_TAGVAR(no_undefined_flag, $1)=' ${wl}-bernotok'
 	    _LT_TAGVAR(allow_undefined_flag, $1)=' ${wl}-berok'
-	    # Exported symbols can be pulled into shared objects from archives
-	    _LT_TAGVAR(whole_archive_flag_spec, $1)='$convenience'
+	    if test "$with_gnu_ld" = yes; then
+	      # We only use this code for GNU lds that support --whole-archive.
+	      _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive$convenience ${wl}--no-whole-archive'
+	    else
+	      # Exported symbols can be pulled into shared objects from archives
+	      _LT_TAGVAR(whole_archive_flag_spec, $1)='$convenience'
+	    fi
 	    _LT_TAGVAR(archive_cmds_need_lc, $1)=yes
 	    # This is similar to how AIX traditionally builds its shared
 	    # libraries.
@@ -5653,28 +6057,75 @@
         ;;
 
       cygwin* | mingw* | pw32* | cegcc*)
-        # _LT_TAGVAR(hardcode_libdir_flag_spec, $1) is actually meaningless,
-        # as there is no search path for DLLs.
-        _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='-L$libdir'
-        _LT_TAGVAR(allow_undefined_flag, $1)=unsupported
-        _LT_TAGVAR(always_export_symbols, $1)=no
-        _LT_TAGVAR(enable_shared_with_static_runtimes, $1)=yes
-
-        if $LD --help 2>&1 | $GREP 'auto-import' > /dev/null; then
-          _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -o $output_objdir/$soname ${wl}--enable-auto-image-base -Xlinker --out-implib -Xlinker $lib'
-          # If the export-symbols file already is a .def file (1st line
-          # is EXPORTS), use it as is; otherwise, prepend...
-          _LT_TAGVAR(archive_expsym_cmds, $1)='if test "x`$SED 1q $export_symbols`" = xEXPORTS; then
-	    cp $export_symbols $output_objdir/$soname.def;
-          else
-	    echo EXPORTS > $output_objdir/$soname.def;
-	    cat $export_symbols >> $output_objdir/$soname.def;
-          fi~
-          $CC -shared -nostdlib $output_objdir/$soname.def $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -o $output_objdir/$soname ${wl}--enable-auto-image-base -Xlinker --out-implib -Xlinker $lib'
-        else
-          _LT_TAGVAR(ld_shlibs, $1)=no
-        fi
-        ;;
+	case $GXX,$cc_basename in
+	,cl* | no,cl*)
+	  # Native MSVC
+	  # hardcode_libdir_flag_spec is actually meaningless, as there is
+	  # no search path for DLLs.
+	  _LT_TAGVAR(hardcode_libdir_flag_spec, $1)=' '
+	  _LT_TAGVAR(allow_undefined_flag, $1)=unsupported
+	  _LT_TAGVAR(always_export_symbols, $1)=yes
+	  _LT_TAGVAR(file_list_spec, $1)='@'
+	  # Tell ltmain to make .lib files, not .a files.
+	  libext=lib
+	  # Tell ltmain to make .dll files, not .so files.
+	  shrext_cmds=".dll"
+	  # FIXME: Setting linknames here is a bad hack.
+	  _LT_TAGVAR(archive_cmds, $1)='$CC -o $output_objdir/$soname $libobjs $compiler_flags $deplibs -Wl,-dll~linknames='
+	  _LT_TAGVAR(archive_expsym_cmds, $1)='if test "x`$SED 1q $export_symbols`" = xEXPORTS; then
+	      $SED -n -e 's/\\\\\\\(.*\\\\\\\)/-link\\\ -EXPORT:\\\\\\\1/' -e '1\\\!p' < $export_symbols > $output_objdir/$soname.exp;
+	    else
+	      $SED -e 's/\\\\\\\(.*\\\\\\\)/-link\\\ -EXPORT:\\\\\\\1/' < $export_symbols > $output_objdir/$soname.exp;
+	    fi~
+	    $CC -o $tool_output_objdir$soname $libobjs $compiler_flags $deplibs "@$tool_output_objdir$soname.exp" -Wl,-DLL,-IMPLIB:"$tool_output_objdir$libname.dll.lib"~
+	    linknames='
+	  # The linker will not automatically build a static lib if we build a DLL.
+	  # _LT_TAGVAR(old_archive_from_new_cmds, $1)='true'
+	  _LT_TAGVAR(enable_shared_with_static_runtimes, $1)=yes
+	  # Don't use ranlib
+	  _LT_TAGVAR(old_postinstall_cmds, $1)='chmod 644 $oldlib'
+	  _LT_TAGVAR(postlink_cmds, $1)='lt_outputfile="@OUTPUT@"~
+	    lt_tool_outputfile="@TOOL_OUTPUT@"~
+	    case $lt_outputfile in
+	      *.exe|*.EXE) ;;
+	      *)
+		lt_outputfile="$lt_outputfile.exe"
+		lt_tool_outputfile="$lt_tool_outputfile.exe"
+		;;
+	    esac~
+	    func_to_tool_file "$lt_outputfile"~
+	    if test "$MANIFEST_TOOL" != ":" && test -f "$lt_outputfile.manifest"; then
+	      $MANIFEST_TOOL -manifest "$lt_tool_outputfile.manifest" -outputresource:"$lt_tool_outputfile" || exit 1;
+	      $RM "$lt_outputfile.manifest";
+	    fi'
+	  ;;
+	*)
+	  # g++
+	  # _LT_TAGVAR(hardcode_libdir_flag_spec, $1) is actually meaningless,
+	  # as there is no search path for DLLs.
+	  _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='-L$libdir'
+	  _LT_TAGVAR(export_dynamic_flag_spec, $1)='${wl}--export-all-symbols'
+	  _LT_TAGVAR(allow_undefined_flag, $1)=unsupported
+	  _LT_TAGVAR(always_export_symbols, $1)=no
+	  _LT_TAGVAR(enable_shared_with_static_runtimes, $1)=yes
+
+	  if $LD --help 2>&1 | $GREP 'auto-import' > /dev/null; then
+	    _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -o $output_objdir/$soname ${wl}--enable-auto-image-base -Xlinker --out-implib -Xlinker $lib'
+	    # If the export-symbols file already is a .def file (1st line
+	    # is EXPORTS), use it as is; otherwise, prepend...
+	    _LT_TAGVAR(archive_expsym_cmds, $1)='if test "x`$SED 1q $export_symbols`" = xEXPORTS; then
+	      cp $export_symbols $output_objdir/$soname.def;
+	    else
+	      echo EXPORTS > $output_objdir/$soname.def;
+	      cat $export_symbols >> $output_objdir/$soname.def;
+	    fi~
+	    $CC -shared -nostdlib $output_objdir/$soname.def $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -o $output_objdir/$soname ${wl}--enable-auto-image-base -Xlinker --out-implib -Xlinker $lib'
+	  else
+	    _LT_TAGVAR(ld_shlibs, $1)=no
+	  fi
+	  ;;
+	esac
+	;;
       darwin* | rhapsody*)
         _LT_DARWIN_LINKER_FEATURES($1)
 	;;
@@ -5716,6 +6167,11 @@
       gnu*)
         ;;
 
+      haiku*)
+        _LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
+        _LT_TAGVAR(link_all_deplibs, $1)=yes
+        ;;
+
       hpux9*)
         _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}+b ${wl}$libdir'
         _LT_TAGVAR(hardcode_libdir_separator, $1)=:
@@ -5740,11 +6196,11 @@
             # explicitly linking system object files so we need to strip them
             # from the output so that they don't get included in the library
             # dependencies.
-            output_verbose_link_cmd='templist=`($CC -b $CFLAGS -v conftest.$objext 2>&1) | $EGREP "\-L"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; $ECHO "X$list" | $Xsed'
+            output_verbose_link_cmd='templist=`($CC -b $CFLAGS -v conftest.$objext 2>&1) | $EGREP "\-L"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "$list"'
             ;;
           *)
             if test "$GXX" = yes; then
-              _LT_TAGVAR(archive_cmds, $1)='$RM $output_objdir/$soname~$CC -shared -nostdlib -fPIC ${wl}+b ${wl}$install_libdir -o $output_objdir/$soname $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~test $output_objdir/$soname = $lib || mv $output_objdir/$soname $lib'
+              _LT_TAGVAR(archive_cmds, $1)='$RM $output_objdir/$soname~$CC -shared -nostdlib $pic_flag ${wl}+b ${wl}$install_libdir -o $output_objdir/$soname $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~test $output_objdir/$soname = $lib || mv $output_objdir/$soname $lib'
             else
               # FIXME: insert proper C++ library support
               _LT_TAGVAR(ld_shlibs, $1)=no
@@ -5805,7 +6261,7 @@
 	    # explicitly linking system object files so we need to strip them
 	    # from the output so that they don't get included in the library
 	    # dependencies.
-	    output_verbose_link_cmd='templist=`($CC -b $CFLAGS -v conftest.$objext 2>&1) | $GREP "\-L"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; $ECHO "X$list" | $Xsed'
+	    output_verbose_link_cmd='templist=`($CC -b $CFLAGS -v conftest.$objext 2>&1) | $GREP "\-L"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "$list"'
 	    ;;
           *)
 	    if test "$GXX" = yes; then
@@ -5815,10 +6271,10 @@
 	            _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib -fPIC ${wl}+h ${wl}$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
 	            ;;
 	          ia64*)
-	            _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib -fPIC ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
+	            _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib $pic_flag ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
 	            ;;
 	          *)
-	            _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib -fPIC ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
+	            _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib $pic_flag ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
 	            ;;
 	        esac
 	      fi
@@ -5848,7 +6304,7 @@
         case $cc_basename in
           CC*)
 	    # SGI C++
-	    _LT_TAGVAR(archive_cmds, $1)='$CC -shared -all -multigot $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -soname $soname `test -n "$verstring" && $ECHO "X-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -o $lib'
+	    _LT_TAGVAR(archive_cmds, $1)='$CC -shared -all -multigot $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -soname $soname `test -n "$verstring" && func_echo_all "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
 
 	    # Archives containing C++ object files must be created using
 	    # "CC -ar", where "CC" is the IRIX C++ compiler.  This is
@@ -5859,9 +6315,9 @@
           *)
 	    if test "$GXX" = yes; then
 	      if test "$with_gnu_ld" = no; then
-	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && $ECHO "X${wl}-set_version ${wl}$verstring" | $Xsed` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
+	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
 	      else
-	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && $ECHO "X${wl}-set_version ${wl}$verstring" | $Xsed` -o $lib'
+	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` -o $lib'
 	      fi
 	    fi
 	    _LT_TAGVAR(link_all_deplibs, $1)=yes
@@ -5890,7 +6346,7 @@
 	    # explicitly linking system object files so we need to strip them
 	    # from the output so that they don't get included in the library
 	    # dependencies.
-	    output_verbose_link_cmd='templist=`$CC $CFLAGS -v conftest.$objext -o libconftest$shared_ext 2>&1 | $GREP "ld"`; rm -f libconftest$shared_ext; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; $ECHO "X$list" | $Xsed'
+	    output_verbose_link_cmd='templist=`$CC $CFLAGS -v conftest.$objext -o libconftest$shared_ext 2>&1 | $GREP "ld"`; rm -f libconftest$shared_ext; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "$list"'
 
 	    _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath,$libdir'
 	    _LT_TAGVAR(export_dynamic_flag_spec, $1)='${wl}--export-dynamic'
@@ -5927,26 +6383,26 @@
           pgCC* | pgcpp*)
             # Portland Group C++ compiler
 	    case `$CC -V` in
-	    *pgCC\ [[1-5]]* | *pgcpp\ [[1-5]]*)
+	    *pgCC\ [[1-5]].* | *pgcpp\ [[1-5]].*)
 	      _LT_TAGVAR(prelink_cmds, $1)='tpldir=Template.dir~
 		rm -rf $tpldir~
 		$CC --prelink_objects --instantiation_dir $tpldir $objs $libobjs $compile_deplibs~
-		compile_command="$compile_command `find $tpldir -name \*.o | $NL2SP`"'
+		compile_command="$compile_command `find $tpldir -name \*.o | sort | $NL2SP`"'
 	      _LT_TAGVAR(old_archive_cmds, $1)='tpldir=Template.dir~
 		rm -rf $tpldir~
 		$CC --prelink_objects --instantiation_dir $tpldir $oldobjs$old_deplibs~
-		$AR $AR_FLAGS $oldlib$oldobjs$old_deplibs `find $tpldir -name \*.o | $NL2SP`~
+		$AR $AR_FLAGS $oldlib$oldobjs$old_deplibs `find $tpldir -name \*.o | sort | $NL2SP`~
 		$RANLIB $oldlib'
 	      _LT_TAGVAR(archive_cmds, $1)='tpldir=Template.dir~
 		rm -rf $tpldir~
 		$CC --prelink_objects --instantiation_dir $tpldir $predep_objects $libobjs $deplibs $convenience $postdep_objects~
-		$CC -shared $pic_flag $predep_objects $libobjs $deplibs `find $tpldir -name \*.o | $NL2SP` $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname -o $lib'
+		$CC -shared $pic_flag $predep_objects $libobjs $deplibs `find $tpldir -name \*.o | sort | $NL2SP` $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname -o $lib'
 	      _LT_TAGVAR(archive_expsym_cmds, $1)='tpldir=Template.dir~
 		rm -rf $tpldir~
 		$CC --prelink_objects --instantiation_dir $tpldir $predep_objects $libobjs $deplibs $convenience $postdep_objects~
-		$CC -shared $pic_flag $predep_objects $libobjs $deplibs `find $tpldir -name \*.o | $NL2SP` $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname ${wl}-retain-symbols-file ${wl}$export_symbols -o $lib'
+		$CC -shared $pic_flag $predep_objects $libobjs $deplibs `find $tpldir -name \*.o | sort | $NL2SP` $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname ${wl}-retain-symbols-file ${wl}$export_symbols -o $lib'
 	      ;;
-	    *) # Version 6 will use weak symbols
+	    *) # Version 6 and above use weak symbols
 	      _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname -o $lib'
 	      _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -shared $pic_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname ${wl}-retain-symbols-file ${wl}$export_symbols -o $lib'
 	      ;;
@@ -5954,7 +6410,7 @@
 
 	    _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}--rpath ${wl}$libdir'
 	    _LT_TAGVAR(export_dynamic_flag_spec, $1)='${wl}--export-dynamic'
-	    _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; $ECHO \"$new_convenience\"` ${wl}--no-whole-archive'
+	    _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` ${wl}--no-whole-archive'
             ;;
 	  cxx*)
 	    # Compaq C++
@@ -5973,9 +6429,9 @@
 	    # explicitly linking system object files so we need to strip them
 	    # from the output so that they don't get included in the library
 	    # dependencies.
-	    output_verbose_link_cmd='templist=`$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "ld"`; templist=`$ECHO "X$templist" | $Xsed -e "s/\(^.*ld.*\)\( .*ld .*$\)/\1/"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; $ECHO "X$list" | $Xsed'
+	    output_verbose_link_cmd='templist=`$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "ld"`; templist=`func_echo_all "$templist" | $SED "s/\(^.*ld.*\)\( .*ld .*$\)/\1/"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "X$list" | $Xsed'
 	    ;;
-	  xl*)
+	  xl* | mpixl* | bgxl*)
 	    # IBM XL 8.0 on PPC, with GNU ld
 	    _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath ${wl}$libdir'
 	    _LT_TAGVAR(export_dynamic_flag_spec, $1)='${wl}--export-dynamic'
@@ -5995,13 +6451,13 @@
 	      _LT_TAGVAR(archive_cmds, $1)='$CC -G${allow_undefined_flag} -h$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
 	      _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -G${allow_undefined_flag} -h$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-retain-symbols-file ${wl}$export_symbols'
 	      _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='-R$libdir'
-	      _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`new_convenience=; for conv in $convenience\"\"; do test -z \"$conv\" || new_convenience=\"$new_convenience,$conv\"; done; $ECHO \"$new_convenience\"` ${wl}--no-whole-archive'
+	      _LT_TAGVAR(whole_archive_flag_spec, $1)='${wl}--whole-archive`new_convenience=; for conv in $convenience\"\"; do test -z \"$conv\" || new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` ${wl}--no-whole-archive'
 	      _LT_TAGVAR(compiler_needs_object, $1)=yes
 
 	      # Not sure whether something based on
 	      # $CC $CFLAGS -v conftest.$objext -o libconftest$shared_ext 2>&1
 	      # would be better.
-	      output_verbose_link_cmd='echo'
+	      output_verbose_link_cmd='func_echo_all'
 
 	      # Archives containing C++ object files must be created using
 	      # "CC -xar", where "CC" is the Sun C++ compiler.  This is
@@ -6070,7 +6526,7 @@
 	    _LT_TAGVAR(export_dynamic_flag_spec, $1)='${wl}-E'
 	    _LT_TAGVAR(whole_archive_flag_spec, $1)="$wlarc"'--whole-archive$convenience '"$wlarc"'--no-whole-archive'
 	  fi
-	  output_verbose_link_cmd=echo
+	  output_verbose_link_cmd=func_echo_all
 	else
 	  _LT_TAGVAR(ld_shlibs, $1)=no
 	fi
@@ -6105,15 +6561,15 @@
 	    case $host in
 	      osf3*)
 	        _LT_TAGVAR(allow_undefined_flag, $1)=' ${wl}-expect_unresolved ${wl}\*'
-	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $soname `test -n "$verstring" && $ECHO "X${wl}-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -o $lib'
+	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $soname `test -n "$verstring" && func_echo_all "${wl}-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
 	        _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath ${wl}$libdir'
 		;;
 	      *)
 	        _LT_TAGVAR(allow_undefined_flag, $1)=' -expect_unresolved \*'
-	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -msym -soname $soname `test -n "$verstring" && $ECHO "X-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -o $lib'
+	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -msym -soname $soname `test -n "$verstring" && func_echo_all "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
 	        _LT_TAGVAR(archive_expsym_cmds, $1)='for i in `cat $export_symbols`; do printf "%s %s\\n" -exported_symbol "\$i" >> $lib.exp; done~
 	          echo "-hidden">> $lib.exp~
-	          $CC -shared$allow_undefined_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -msym -soname $soname ${wl}-input ${wl}$lib.exp  `test -n "$verstring" && $ECHO "X-set_version $verstring" | $Xsed` -update_registry ${output_objdir}/so_locations -o $lib~
+	          $CC -shared$allow_undefined_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -msym -soname $soname ${wl}-input ${wl}$lib.exp  `test -n "$verstring" && $ECHO "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib~
 	          $RM $lib.exp'
 	        _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='-rpath $libdir'
 		;;
@@ -6129,17 +6585,17 @@
 	    # explicitly linking system object files so we need to strip them
 	    # from the output so that they don't get included in the library
 	    # dependencies.
-	    output_verbose_link_cmd='templist=`$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "ld" | $GREP -v "ld:"`; templist=`$ECHO "X$templist" | $Xsed -e "s/\(^.*ld.*\)\( .*ld.*$\)/\1/"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; $ECHO "X$list" | $Xsed'
+	    output_verbose_link_cmd='templist=`$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "ld" | $GREP -v "ld:"`; templist=`func_echo_all "$templist" | $SED "s/\(^.*ld.*\)\( .*ld.*$\)/\1/"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "$list"'
 	    ;;
 	  *)
 	    if test "$GXX" = yes && test "$with_gnu_ld" = no; then
 	      _LT_TAGVAR(allow_undefined_flag, $1)=' ${wl}-expect_unresolved ${wl}\*'
 	      case $host in
 	        osf3*)
-	          _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib ${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && $ECHO "X${wl}-set_version ${wl}$verstring" | $Xsed` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
+	          _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib ${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
 		  ;;
 	        *)
-	          _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib ${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-msym ${wl}-soname ${wl}$soname `test -n "$verstring" && $ECHO "${wl}-set_version ${wl}$verstring" | $Xsed` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
+	          _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag -nostdlib ${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-msym ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
 		  ;;
 	      esac
 
@@ -6149,7 +6605,7 @@
 	      # Commands to make compiler produce verbose output that lists
 	      # what "hidden" libraries, object files and flags are used when
 	      # linking a shared library.
-	      output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "\-L"'
+	      output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP -v "^Configured with:" | $GREP "\-L"'
 
 	    else
 	      # FIXME: insert proper C++ library support
@@ -6185,7 +6641,7 @@
 
       solaris*)
         case $cc_basename in
-          CC*)
+          CC* | sunCC*)
 	    # Sun C++ 4.2, 5.x and Centerline C++
             _LT_TAGVAR(archive_cmds_need_lc,$1)=yes
 	    _LT_TAGVAR(no_undefined_flag, $1)=' -zdefs'
@@ -6206,7 +6662,7 @@
 	    esac
 	    _LT_TAGVAR(link_all_deplibs, $1)=yes
 
-	    output_verbose_link_cmd='echo'
+	    output_verbose_link_cmd='func_echo_all'
 
 	    # Archives containing C++ object files must be created using
 	    # "CC -xar", where "CC" is the Sun C++ compiler.  This is
@@ -6226,14 +6682,14 @@
 	    if test "$GXX" = yes && test "$with_gnu_ld" = no; then
 	      _LT_TAGVAR(no_undefined_flag, $1)=' ${wl}-z ${wl}defs'
 	      if $CC --version | $GREP -v '^2\.7' > /dev/null; then
-	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared -nostdlib $LDFLAGS $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-h $wl$soname -o $lib'
+	        _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag -nostdlib $LDFLAGS $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-h $wl$soname -o $lib'
 	        _LT_TAGVAR(archive_expsym_cmds, $1)='echo "{ global:" > $lib.exp~cat $export_symbols | $SED -e "s/\(.*\)/\1;/" >> $lib.exp~echo "local: *; };" >> $lib.exp~
-		  $CC -shared -nostdlib ${wl}-M $wl$lib.exp -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~$RM $lib.exp'
+		  $CC -shared $pic_flag -nostdlib ${wl}-M $wl$lib.exp -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~$RM $lib.exp'
 
 	        # Commands to make compiler produce verbose output that lists
 	        # what "hidden" libraries, object files and flags are used when
 	        # linking a shared library.
-	        output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "\-L"'
+	        output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP -v "^Configured with:" | $GREP "\-L"'
 	      else
 	        # g++ 2.7 appears to require `-G' NOT `-shared' on this
 	        # platform.
@@ -6244,7 +6700,7 @@
 	        # Commands to make compiler produce verbose output that lists
 	        # what "hidden" libraries, object files and flags are used when
 	        # linking a shared library.
-	        output_verbose_link_cmd='$CC -G $CFLAGS -v conftest.$objext 2>&1 | $GREP "\-L"'
+	        output_verbose_link_cmd='$CC -G $CFLAGS -v conftest.$objext 2>&1 | $GREP -v "^Configured with:" | $GREP "\-L"'
 	      fi
 
 	      _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-R $wl$libdir'
@@ -6298,6 +6754,10 @@
           CC*)
 	    _LT_TAGVAR(archive_cmds, $1)='$CC -G ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
 	    _LT_TAGVAR(archive_expsym_cmds, $1)='$CC -G ${wl}-Bexport:$export_symbols ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
+	    _LT_TAGVAR(old_archive_cmds, $1)='$CC -Tprelink_objects $oldobjs~
+	      '"$_LT_TAGVAR(old_archive_cmds, $1)"
+	    _LT_TAGVAR(reload_cmds, $1)='$CC -Tprelink_objects $reload_objs~
+	      '"$_LT_TAGVAR(reload_cmds, $1)"
 	    ;;
 	  *)
 	    _LT_TAGVAR(archive_cmds, $1)='$CC -shared ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
@@ -6353,6 +6813,7 @@
   fi # test -n "$compiler"
 
   CC=$lt_save_CC
+  CFLAGS=$lt_save_CFLAGS
   LDCXX=$LD
   LD=$lt_save_LD
   GCC=$lt_save_GCC
@@ -6367,6 +6828,29 @@
 ])# _LT_LANG_CXX_CONFIG
 
 
+# _LT_FUNC_STRIPNAME_CNF
+# ----------------------
+# func_stripname_cnf prefix suffix name
+# strip PREFIX and SUFFIX off of NAME.
+# PREFIX and SUFFIX must not contain globbing or regex special
+# characters, hashes, percent signs, but SUFFIX may contain a leading
+# dot (in which case that matches only a dot).
+#
+# This function is identical to the (non-XSI) version of func_stripname,
+# except this one can be used by m4 code that may be executed by configure,
+# rather than the libtool script.
+m4_defun([_LT_FUNC_STRIPNAME_CNF],[dnl
+AC_REQUIRE([_LT_DECL_SED])
+AC_REQUIRE([_LT_PROG_ECHO_BACKSLASH])
+func_stripname_cnf ()
+{
+  case ${2} in
+  .*) func_stripname_result=`$ECHO "${3}" | $SED "s%^${1}%%; s%\\\\${2}\$%%"`;;
+  *)  func_stripname_result=`$ECHO "${3}" | $SED "s%^${1}%%; s%${2}\$%%"`;;
+  esac
+} # func_stripname_cnf
+])# _LT_FUNC_STRIPNAME_CNF
+
 # _LT_SYS_HIDDEN_LIBDEPS([TAGNAME])
 # ---------------------------------
 # Figure out "hidden" library dependencies from verbose
@@ -6375,6 +6859,7 @@
 # objects, libraries and library flags.
 m4_defun([_LT_SYS_HIDDEN_LIBDEPS],
 [m4_require([_LT_FILEUTILS_DEFAULTS])dnl
+AC_REQUIRE([_LT_FUNC_STRIPNAME_CNF])dnl
 # Dependencies to place before and after the object being linked:
 _LT_TAGVAR(predep_objects, $1)=
 _LT_TAGVAR(postdep_objects, $1)=
@@ -6425,6 +6910,13 @@
 };
 _LT_EOF
 ])
+
+_lt_libdeps_save_CFLAGS=$CFLAGS
+case "$CC $CFLAGS " in #(
+*\ -flto*\ *) CFLAGS="$CFLAGS -fno-lto" ;;
+*\ -fwhopr*\ *) CFLAGS="$CFLAGS -fno-whopr" ;;
+esac
+
 dnl Parse the compiler output and extract the necessary
 dnl objects, libraries and library flags.
 if AC_TRY_EVAL(ac_compile); then
@@ -6436,7 +6928,7 @@
   pre_test_object_deps_done=no
 
   for p in `eval "$output_verbose_link_cmd"`; do
-    case $p in
+    case ${prev}${p} in
 
     -L* | -R* | -l*)
        # Some compilers place space between "-{L,R}" and the path.
@@ -6445,13 +6937,22 @@
           test $p = "-R"; then
 	 prev=$p
 	 continue
-       else
-	 prev=
        fi
 
+       # Expand the sysroot to ease extracting the directories later.
+       if test -z "$prev"; then
+         case $p in
+         -L*) func_stripname_cnf '-L' '' "$p"; prev=-L; p=$func_stripname_result ;;
+         -R*) func_stripname_cnf '-R' '' "$p"; prev=-R; p=$func_stripname_result ;;
+         -l*) func_stripname_cnf '-l' '' "$p"; prev=-l; p=$func_stripname_result ;;
+         esac
+       fi
+       case $p in
+       =*) func_stripname_cnf '=' '' "$p"; p=$lt_sysroot$func_stripname_result ;;
+       esac
        if test "$pre_test_object_deps_done" = no; then
-	 case $p in
-	 -L* | -R*)
+	 case ${prev} in
+	 -L | -R)
 	   # Internal compiler library paths should come after those
 	   # provided the user.  The postdeps already come after the
 	   # user supplied libs so there is no need to process them.
@@ -6471,8 +6972,10 @@
 	   _LT_TAGVAR(postdeps, $1)="${_LT_TAGVAR(postdeps, $1)} ${prev}${p}"
 	 fi
        fi
+       prev=
        ;;
 
+    *.lto.$objext) ;; # Ignore GCC LTO objects
     *.$objext)
        # This assumes that the test object file only shows up
        # once in the compiler output.
@@ -6508,6 +7011,7 @@
 fi
 
 $RM -f confest.$objext
+CFLAGS=$_lt_libdeps_save_CFLAGS
 
 # PORTME: override above test on systems where it is broken
 m4_if([$1], [CXX],
@@ -6544,7 +7048,7 @@
 
 solaris*)
   case $cc_basename in
-  CC*)
+  CC* | sunCC*)
     # The more standards-conforming stlport4 library is
     # incompatible with the Cstd library. Avoid specifying
     # it if it's in CXXFLAGS. Ignore libCrun as
@@ -6588,32 +7092,16 @@
 ])# _LT_SYS_HIDDEN_LIBDEPS
 
 
-# _LT_PROG_F77
-# ------------
-# Since AC_PROG_F77 is broken, in that it returns the empty string
-# if there is no fortran compiler, we have our own version here.
-m4_defun([_LT_PROG_F77],
-[
-pushdef([AC_MSG_ERROR], [_lt_disable_F77=yes])
-AC_PROG_F77
-if test -z "$F77" || test "X$F77" = "Xno"; then
-  _lt_disable_F77=yes
-fi
-popdef([AC_MSG_ERROR])
-])# _LT_PROG_F77
-
-dnl aclocal-1.4 backwards compatibility:
-dnl AC_DEFUN([_LT_PROG_F77], [])
-
-
 # _LT_LANG_F77_CONFIG([TAG])
 # --------------------------
 # Ensure that the configuration variables for a Fortran 77 compiler are
 # suitably defined.  These variables are subsequently used by _LT_CONFIG
 # to write the compiler configuration to `libtool'.
 m4_defun([_LT_LANG_F77_CONFIG],
-[AC_REQUIRE([_LT_PROG_F77])dnl
-AC_LANG_PUSH(Fortran 77)
+[AC_LANG_PUSH(Fortran 77)
+if test -z "$F77" || test "X$F77" = "Xno"; then
+  _lt_disable_F77=yes
+fi
 
 _LT_TAGVAR(archive_cmds_need_lc, $1)=no
 _LT_TAGVAR(allow_undefined_flag, $1)=
@@ -6632,6 +7120,8 @@
 _LT_TAGVAR(module_expsym_cmds, $1)=
 _LT_TAGVAR(link_all_deplibs, $1)=unknown
 _LT_TAGVAR(old_archive_cmds, $1)=$old_archive_cmds
+_LT_TAGVAR(reload_flag, $1)=$reload_flag
+_LT_TAGVAR(reload_cmds, $1)=$reload_cmds
 _LT_TAGVAR(no_undefined_flag, $1)=
 _LT_TAGVAR(whole_archive_flag_spec, $1)=
 _LT_TAGVAR(enable_shared_with_static_runtimes, $1)=no
@@ -6671,7 +7161,9 @@
   # Allow CC to be a program name with arguments.
   lt_save_CC="$CC"
   lt_save_GCC=$GCC
+  lt_save_CFLAGS=$CFLAGS
   CC=${F77-"f77"}
+  CFLAGS=$FFLAGS
   compiler=$CC
   _LT_TAGVAR(compiler, $1)=$CC
   _LT_CC_BASENAME([$compiler])
@@ -6725,38 +7217,24 @@
 
   GCC=$lt_save_GCC
   CC="$lt_save_CC"
+  CFLAGS="$lt_save_CFLAGS"
 fi # test "$_lt_disable_F77" != yes
 
 AC_LANG_POP
 ])# _LT_LANG_F77_CONFIG
 
 
-# _LT_PROG_FC
-# -----------
-# Since AC_PROG_FC is broken, in that it returns the empty string
-# if there is no fortran compiler, we have our own version here.
-m4_defun([_LT_PROG_FC],
-[
-pushdef([AC_MSG_ERROR], [_lt_disable_FC=yes])
-AC_PROG_FC
-if test -z "$FC" || test "X$FC" = "Xno"; then
-  _lt_disable_FC=yes
-fi
-popdef([AC_MSG_ERROR])
-])# _LT_PROG_FC
-
-dnl aclocal-1.4 backwards compatibility:
-dnl AC_DEFUN([_LT_PROG_FC], [])
-
-
 # _LT_LANG_FC_CONFIG([TAG])
 # -------------------------
 # Ensure that the configuration variables for a Fortran compiler are
 # suitably defined.  These variables are subsequently used by _LT_CONFIG
 # to write the compiler configuration to `libtool'.
 m4_defun([_LT_LANG_FC_CONFIG],
-[AC_REQUIRE([_LT_PROG_FC])dnl
-AC_LANG_PUSH(Fortran)
+[AC_LANG_PUSH(Fortran)
+
+if test -z "$FC" || test "X$FC" = "Xno"; then
+  _lt_disable_FC=yes
+fi
 
 _LT_TAGVAR(archive_cmds_need_lc, $1)=no
 _LT_TAGVAR(allow_undefined_flag, $1)=
@@ -6775,6 +7253,8 @@
 _LT_TAGVAR(module_expsym_cmds, $1)=
 _LT_TAGVAR(link_all_deplibs, $1)=unknown
 _LT_TAGVAR(old_archive_cmds, $1)=$old_archive_cmds
+_LT_TAGVAR(reload_flag, $1)=$reload_flag
+_LT_TAGVAR(reload_cmds, $1)=$reload_cmds
 _LT_TAGVAR(no_undefined_flag, $1)=
 _LT_TAGVAR(whole_archive_flag_spec, $1)=
 _LT_TAGVAR(enable_shared_with_static_runtimes, $1)=no
@@ -6814,7 +7294,9 @@
   # Allow CC to be a program name with arguments.
   lt_save_CC="$CC"
   lt_save_GCC=$GCC
+  lt_save_CFLAGS=$CFLAGS
   CC=${FC-"f95"}
+  CFLAGS=$FCFLAGS
   compiler=$CC
   GCC=$ac_cv_fc_compiler_gnu
 
@@ -6870,7 +7352,8 @@
   fi # test -n "$compiler"
 
   GCC=$lt_save_GCC
-  CC="$lt_save_CC"
+  CC=$lt_save_CC
+  CFLAGS=$lt_save_CFLAGS
 fi # test "$_lt_disable_FC" != yes
 
 AC_LANG_POP
@@ -6907,10 +7390,12 @@
 _LT_LINKER_BOILERPLATE
 
 # Allow CC to be a program name with arguments.
-lt_save_CC="$CC"
+lt_save_CC=$CC
+lt_save_CFLAGS=$CFLAGS
 lt_save_GCC=$GCC
 GCC=yes
 CC=${GCJ-"gcj"}
+CFLAGS=$GCJFLAGS
 compiler=$CC
 _LT_TAGVAR(compiler, $1)=$CC
 _LT_TAGVAR(LD, $1)="$LD"
@@ -6920,6 +7405,8 @@
 _LT_TAGVAR(archive_cmds_need_lc, $1)=no
 
 _LT_TAGVAR(old_archive_cmds, $1)=$old_archive_cmds
+_LT_TAGVAR(reload_flag, $1)=$reload_flag
+_LT_TAGVAR(reload_cmds, $1)=$reload_cmds
 
 if test -n "$compiler"; then
   _LT_COMPILER_NO_RTTI($1)
@@ -6935,7 +7422,8 @@
 AC_LANG_RESTORE
 
 GCC=$lt_save_GCC
-CC="$lt_save_CC"
+CC=$lt_save_CC
+CFLAGS=$lt_save_CFLAGS
 ])# _LT_LANG_GCJ_CONFIG
 
 
@@ -6970,9 +7458,11 @@
 
 # Allow CC to be a program name with arguments.
 lt_save_CC="$CC"
+lt_save_CFLAGS=$CFLAGS
 lt_save_GCC=$GCC
 GCC=
 CC=${RC-"windres"}
+CFLAGS=
 compiler=$CC
 _LT_TAGVAR(compiler, $1)=$CC
 _LT_CC_BASENAME([$compiler])
@@ -6985,7 +7475,8 @@
 
 GCC=$lt_save_GCC
 AC_LANG_RESTORE
-CC="$lt_save_CC"
+CC=$lt_save_CC
+CFLAGS=$lt_save_CFLAGS
 ])# _LT_LANG_RC_CONFIG
 
 
@@ -7044,6 +7535,15 @@
 AC_SUBST([OBJDUMP])
 ])
 
+# _LT_DECL_DLLTOOL
+# ----------------
+# Ensure DLLTOOL variable is set.
+m4_defun([_LT_DECL_DLLTOOL],
+[AC_CHECK_TOOL(DLLTOOL, dlltool, false)
+test -z "$DLLTOOL" && DLLTOOL=dlltool
+_LT_DECL([], [DLLTOOL], [1], [DLL creation program])
+AC_SUBST([DLLTOOL])
+])
 
 # _LT_DECL_SED
 # ------------
@@ -7135,8 +7635,8 @@
 # Try some XSI features
 xsi_shell=no
 ( _lt_dummy="a/b/c"
-  test "${_lt_dummy##*/},${_lt_dummy%/*},"${_lt_dummy%"$_lt_dummy"}, \
-      = c,a/b,, \
+  test "${_lt_dummy##*/},${_lt_dummy%/*},${_lt_dummy#??}"${_lt_dummy%"$_lt_dummy"}, \
+      = c,a/b,b/c, \
     && eval 'test $(( 1 + 1 )) -eq 2 \
     && test "${#_lt_dummy}" -eq 5' ) >/dev/null 2>&1 \
   && xsi_shell=yes
@@ -7175,222 +7675,177 @@
 ])# _LT_CHECK_SHELL_FEATURES
 
 
-# _LT_PROG_XSI_SHELLFNS
-# ---------------------
-# Bourne and XSI compatible variants of some useful shell functions.
-m4_defun([_LT_PROG_XSI_SHELLFNS],
-[case $xsi_shell in
-  yes)
-    cat << \_LT_EOF >> "$cfgfile"
-
-# func_dirname file append nondir_replacement
-# Compute the dirname of FILE.  If nonempty, add APPEND to the result,
-# otherwise set result to NONDIR_REPLACEMENT.
-func_dirname ()
-{
-  case ${1} in
-    */*) func_dirname_result="${1%/*}${2}" ;;
-    *  ) func_dirname_result="${3}" ;;
-  esac
-}
-
-# func_basename file
-func_basename ()
-{
-  func_basename_result="${1##*/}"
-}
-
-# func_dirname_and_basename file append nondir_replacement
-# perform func_basename and func_dirname in a single function
-# call:
-#   dirname:  Compute the dirname of FILE.  If nonempty,
-#             add APPEND to the result, otherwise set result
-#             to NONDIR_REPLACEMENT.
-#             value returned in "$func_dirname_result"
-#   basename: Compute filename of FILE.
-#             value retuned in "$func_basename_result"
-# Implementation must be kept synchronized with func_dirname
-# and func_basename. For efficiency, we do not delegate to
-# those functions but instead duplicate the functionality here.
-func_dirname_and_basename ()
-{
-  case ${1} in
-    */*) func_dirname_result="${1%/*}${2}" ;;
-    *  ) func_dirname_result="${3}" ;;
-  esac
-  func_basename_result="${1##*/}"
-}
-
-# func_stripname prefix suffix name
-# strip PREFIX and SUFFIX off of NAME.
-# PREFIX and SUFFIX must not contain globbing or regex special
-# characters, hashes, percent signs, but SUFFIX may contain a leading
-# dot (in which case that matches only a dot).
-func_stripname ()
-{
-  # pdksh 5.2.14 does not do ${X%$Y} correctly if both X and Y are
-  # positional parameters, so assign one to ordinary parameter first.
-  func_stripname_result=${3}
-  func_stripname_result=${func_stripname_result#"${1}"}
-  func_stripname_result=${func_stripname_result%"${2}"}
-}
-
-# func_opt_split
-func_opt_split ()
-{
-  func_opt_split_opt=${1%%=*}
-  func_opt_split_arg=${1#*=}
-}
-
-# func_lo2o object
-func_lo2o ()
-{
-  case ${1} in
-    *.lo) func_lo2o_result=${1%.lo}.${objext} ;;
-    *)    func_lo2o_result=${1} ;;
-  esac
-}
-
-# func_xform libobj-or-source
-func_xform ()
-{
-  func_xform_result=${1%.*}.lo
-}
-
-# func_arith arithmetic-term...
-func_arith ()
-{
-  func_arith_result=$(( $[*] ))
-}
+# _LT_PROG_FUNCTION_REPLACE (FUNCNAME, REPLACEMENT-BODY)
+# ------------------------------------------------------
+# In `$cfgfile', look for function FUNCNAME delimited by `^FUNCNAME ()$' and
+# '^} FUNCNAME ', and replace its body with REPLACEMENT-BODY.
+m4_defun([_LT_PROG_FUNCTION_REPLACE],
+[dnl {
+sed -e '/^$1 ()$/,/^} # $1 /c\
+$1 ()\
+{\
+m4_bpatsubsts([$2], [$], [\\], [^\([	 ]\)], [\\\1])
+} # Extended-shell $1 implementation' "$cfgfile" > $cfgfile.tmp \
+  && mv -f "$cfgfile.tmp" "$cfgfile" \
+    || (rm -f "$cfgfile" && cp "$cfgfile.tmp" "$cfgfile" && rm -f "$cfgfile.tmp")
+test 0 -eq $? || _lt_function_replace_fail=:
+])
 
-# func_len string
-# STRING may not start with a hyphen.
-func_len ()
-{
-  func_len_result=${#1}
-}
 
-_LT_EOF
-    ;;
-  *) # Bourne compatible functions.
-    cat << \_LT_EOF >> "$cfgfile"
+# _LT_PROG_REPLACE_SHELLFNS
+# -------------------------
+# Replace existing portable implementations of several shell functions with
+# equivalent extended shell implementations where those features are available..
+m4_defun([_LT_PROG_REPLACE_SHELLFNS],
+[if test x"$xsi_shell" = xyes; then
+  _LT_PROG_FUNCTION_REPLACE([func_dirname], [dnl
+    case ${1} in
+      */*) func_dirname_result="${1%/*}${2}" ;;
+      *  ) func_dirname_result="${3}" ;;
+    esac])
+
+  _LT_PROG_FUNCTION_REPLACE([func_basename], [dnl
+    func_basename_result="${1##*/}"])
+
+  _LT_PROG_FUNCTION_REPLACE([func_dirname_and_basename], [dnl
+    case ${1} in
+      */*) func_dirname_result="${1%/*}${2}" ;;
+      *  ) func_dirname_result="${3}" ;;
+    esac
+    func_basename_result="${1##*/}"])
 
-# func_dirname file append nondir_replacement
-# Compute the dirname of FILE.  If nonempty, add APPEND to the result,
-# otherwise set result to NONDIR_REPLACEMENT.
-func_dirname ()
-{
-  # Extract subdirectory from the argument.
-  func_dirname_result=`$ECHO "X${1}" | $Xsed -e "$dirname"`
-  if test "X$func_dirname_result" = "X${1}"; then
-    func_dirname_result="${3}"
-  else
-    func_dirname_result="$func_dirname_result${2}"
-  fi
-}
+  _LT_PROG_FUNCTION_REPLACE([func_stripname], [dnl
+    # pdksh 5.2.14 does not do ${X%$Y} correctly if both X and Y are
+    # positional parameters, so assign one to ordinary parameter first.
+    func_stripname_result=${3}
+    func_stripname_result=${func_stripname_result#"${1}"}
+    func_stripname_result=${func_stripname_result%"${2}"}])
 
-# func_basename file
-func_basename ()
-{
-  func_basename_result=`$ECHO "X${1}" | $Xsed -e "$basename"`
-}
+  _LT_PROG_FUNCTION_REPLACE([func_split_long_opt], [dnl
+    func_split_long_opt_name=${1%%=*}
+    func_split_long_opt_arg=${1#*=}])
 
-dnl func_dirname_and_basename
-dnl A portable version of this function is already defined in general.m4sh
-dnl so there is no need for it here.
+  _LT_PROG_FUNCTION_REPLACE([func_split_short_opt], [dnl
+    func_split_short_opt_arg=${1#??}
+    func_split_short_opt_name=${1%"$func_split_short_opt_arg"}])
 
-# func_stripname prefix suffix name
-# strip PREFIX and SUFFIX off of NAME.
-# PREFIX and SUFFIX must not contain globbing or regex special
-# characters, hashes, percent signs, but SUFFIX may contain a leading
-# dot (in which case that matches only a dot).
-# func_strip_suffix prefix name
-func_stripname ()
-{
-  case ${2} in
-    .*) func_stripname_result=`$ECHO "X${3}" \
-           | $Xsed -e "s%^${1}%%" -e "s%\\\\${2}\$%%"`;;
-    *)  func_stripname_result=`$ECHO "X${3}" \
-           | $Xsed -e "s%^${1}%%" -e "s%${2}\$%%"`;;
-  esac
-}
+  _LT_PROG_FUNCTION_REPLACE([func_lo2o], [dnl
+    case ${1} in
+      *.lo) func_lo2o_result=${1%.lo}.${objext} ;;
+      *)    func_lo2o_result=${1} ;;
+    esac])
 
-# sed scripts:
-my_sed_long_opt='1s/^\(-[[^=]]*\)=.*/\1/;q'
-my_sed_long_arg='1s/^-[[^=]]*=//'
+  _LT_PROG_FUNCTION_REPLACE([func_xform], [    func_xform_result=${1%.*}.lo])
 
-# func_opt_split
-func_opt_split ()
-{
-  func_opt_split_opt=`$ECHO "X${1}" | $Xsed -e "$my_sed_long_opt"`
-  func_opt_split_arg=`$ECHO "X${1}" | $Xsed -e "$my_sed_long_arg"`
-}
+  _LT_PROG_FUNCTION_REPLACE([func_arith], [    func_arith_result=$(( $[*] ))])
 
-# func_lo2o object
-func_lo2o ()
-{
-  func_lo2o_result=`$ECHO "X${1}" | $Xsed -e "$lo2o"`
-}
+  _LT_PROG_FUNCTION_REPLACE([func_len], [    func_len_result=${#1}])
+fi
 
-# func_xform libobj-or-source
-func_xform ()
-{
-  func_xform_result=`$ECHO "X${1}" | $Xsed -e 's/\.[[^.]]*$/.lo/'`
-}
+if test x"$lt_shell_append" = xyes; then
+  _LT_PROG_FUNCTION_REPLACE([func_append], [    eval "${1}+=\\${2}"])
 
-# func_arith arithmetic-term...
-func_arith ()
-{
-  func_arith_result=`expr "$[@]"`
-}
+  _LT_PROG_FUNCTION_REPLACE([func_append_quoted], [dnl
+    func_quote_for_eval "${2}"
+dnl m4 expansion turns \\\\ into \\, and then the shell eval turns that into \
+    eval "${1}+=\\\\ \\$func_quote_for_eval_result"])
 
-# func_len string
-# STRING may not start with a hyphen.
-func_len ()
-{
-  func_len_result=`expr "$[1]" : ".*" 2>/dev/null || echo $max_cmd_len`
-}
+  # Save a `func_append' function call where possible by direct use of '+='
+  sed -e 's%func_append \([[a-zA-Z_]]\{1,\}\) "%\1+="%g' $cfgfile > $cfgfile.tmp \
+    && mv -f "$cfgfile.tmp" "$cfgfile" \
+      || (rm -f "$cfgfile" && cp "$cfgfile.tmp" "$cfgfile" && rm -f "$cfgfile.tmp")
+  test 0 -eq $? || _lt_function_replace_fail=:
+else
+  # Save a `func_append' function call even when '+=' is not available
+  sed -e 's%func_append \([[a-zA-Z_]]\{1,\}\) "%\1="$\1%g' $cfgfile > $cfgfile.tmp \
+    && mv -f "$cfgfile.tmp" "$cfgfile" \
+      || (rm -f "$cfgfile" && cp "$cfgfile.tmp" "$cfgfile" && rm -f "$cfgfile.tmp")
+  test 0 -eq $? || _lt_function_replace_fail=:
+fi
 
-_LT_EOF
-esac
+if test x"$_lt_function_replace_fail" = x":"; then
+  AC_MSG_WARN([Unable to substitute extended shell functions in $ofile])
+fi
+])
 
-case $lt_shell_append in
-  yes)
-    cat << \_LT_EOF >> "$cfgfile"
-
-# func_append var value
-# Append VALUE to the end of shell variable VAR.
-func_append ()
-{
-  eval "$[1]+=\$[2]"
-}
-_LT_EOF
+# _LT_PATH_CONVERSION_FUNCTIONS
+# -----------------------------
+# Determine which file name conversion functions should be used by
+# func_to_host_file (and, implicitly, by func_to_host_path).  These are needed
+# for certain cross-compile configurations and native mingw.
+m4_defun([_LT_PATH_CONVERSION_FUNCTIONS],
+[AC_REQUIRE([AC_CANONICAL_HOST])dnl
+AC_REQUIRE([AC_CANONICAL_BUILD])dnl
+AC_MSG_CHECKING([how to convert $build file names to $host format])
+AC_CACHE_VAL(lt_cv_to_host_file_cmd,
+[case $host in
+  *-*-mingw* )
+    case $build in
+      *-*-mingw* ) # actually msys
+        lt_cv_to_host_file_cmd=func_convert_file_msys_to_w32
+        ;;
+      *-*-cygwin* )
+        lt_cv_to_host_file_cmd=func_convert_file_cygwin_to_w32
+        ;;
+      * ) # otherwise, assume *nix
+        lt_cv_to_host_file_cmd=func_convert_file_nix_to_w32
+        ;;
+    esac
     ;;
-  *)
-    cat << \_LT_EOF >> "$cfgfile"
-
-# func_append var value
-# Append VALUE to the end of shell variable VAR.
-func_append ()
-{
-  eval "$[1]=\$$[1]\$[2]"
-}
-
-_LT_EOF
+  *-*-cygwin* )
+    case $build in
+      *-*-mingw* ) # actually msys
+        lt_cv_to_host_file_cmd=func_convert_file_msys_to_cygwin
+        ;;
+      *-*-cygwin* )
+        lt_cv_to_host_file_cmd=func_convert_file_noop
+        ;;
+      * ) # otherwise, assume *nix
+        lt_cv_to_host_file_cmd=func_convert_file_nix_to_cygwin
+        ;;
+    esac
     ;;
-  esac
+  * ) # unhandled hosts (and "normal" native builds)
+    lt_cv_to_host_file_cmd=func_convert_file_noop
+    ;;
+esac
 ])
+to_host_file_cmd=$lt_cv_to_host_file_cmd
+AC_MSG_RESULT([$lt_cv_to_host_file_cmd])
+_LT_DECL([to_host_file_cmd], [lt_cv_to_host_file_cmd],
+         [0], [convert $build file names to $host format])dnl
+
+AC_MSG_CHECKING([how to convert $build file names to toolchain format])
+AC_CACHE_VAL(lt_cv_to_tool_file_cmd,
+[#assume ordinary cross tools, or native build.
+lt_cv_to_tool_file_cmd=func_convert_file_noop
+case $host in
+  *-*-mingw* )
+    case $build in
+      *-*-mingw* ) # actually msys
+        lt_cv_to_tool_file_cmd=func_convert_file_msys_to_w32
+        ;;
+    esac
+    ;;
+esac
+])
+to_tool_file_cmd=$lt_cv_to_tool_file_cmd
+AC_MSG_RESULT([$lt_cv_to_tool_file_cmd])
+_LT_DECL([to_tool_file_cmd], [lt_cv_to_tool_file_cmd],
+         [0], [convert $build files to toolchain format])dnl
+])# _LT_PATH_CONVERSION_FUNCTIONS
 
 # Helper functions for option handling.                    -*- Autoconf -*-
 #
-#   Copyright (C) 2004, 2005, 2007, 2008 Free Software Foundation, Inc.
+#   Copyright (C) 2004, 2005, 2007, 2008, 2009 Free Software Foundation,
+#   Inc.
 #   Written by Gary V. Vaughan, 2004
 #
 # This file is free software; the Free Software Foundation gives
 # unlimited permission to copy and/or distribute it, with or without
 # modifications, as long as this notice is preserved.
 
-# serial 6 ltoptions.m4
+# serial 7 ltoptions.m4
 
 # This is to help aclocal find these macros, as it can't see m4_define.
 AC_DEFUN([LTOPTIONS_VERSION], [m4_if([1])])
@@ -7505,7 +7960,7 @@
 [enable_win32_dll=yes
 
 case $host in
-*-*-cygwin* | *-*-mingw* | *-*-pw32* | *-cegcc*)
+*-*-cygwin* | *-*-mingw* | *-*-pw32* | *-*-cegcc*)
   AC_CHECK_TOOL(AS, as, false)
   AC_CHECK_TOOL(DLLTOOL, dlltool, false)
   AC_CHECK_TOOL(OBJDUMP, objdump, false)
@@ -7513,13 +7968,13 @@
 esac
 
 test -z "$AS" && AS=as
-_LT_DECL([], [AS],      [0], [Assembler program])dnl
+_LT_DECL([], [AS],      [1], [Assembler program])dnl
 
 test -z "$DLLTOOL" && DLLTOOL=dlltool
-_LT_DECL([], [DLLTOOL], [0], [DLL creation program])dnl
+_LT_DECL([], [DLLTOOL], [1], [DLL creation program])dnl
 
 test -z "$OBJDUMP" && OBJDUMP=objdump
-_LT_DECL([], [OBJDUMP], [0], [Object dumper program])dnl
+_LT_DECL([], [OBJDUMP], [1], [Object dumper program])dnl
 ])# win32-dll
 
 AU_DEFUN([AC_LIBTOOL_WIN32_DLL],
@@ -7877,31 +8332,31 @@
 # unlimited permission to copy and/or distribute it, with or without
 # modifications, as long as this notice is preserved.
 
-# Generated from ltversion.in.
+# @configure_input@
 
-# serial 3017 ltversion.m4
+# serial 3293 ltversion.m4
 # This file is part of GNU Libtool
 
-m4_define([LT_PACKAGE_VERSION], [2.2.6b])
-m4_define([LT_PACKAGE_REVISION], [1.3017])
+m4_define([LT_PACKAGE_VERSION], [2.4])
+m4_define([LT_PACKAGE_REVISION], [1.3293])
 
 AC_DEFUN([LTVERSION_VERSION],
-[macro_version='2.2.6b'
-macro_revision='1.3017'
+[macro_version='2.4'
+macro_revision='1.3293'
 _LT_DECL(, macro_version, 0, [Which release of libtool.m4 was used?])
 _LT_DECL(, macro_revision, 0)
 ])
 
 # lt~obsolete.m4 -- aclocal satisfying obsolete definitions.    -*-Autoconf-*-
 #
-#   Copyright (C) 2004, 2005, 2007 Free Software Foundation, Inc.
+#   Copyright (C) 2004, 2005, 2007, 2009 Free Software Foundation, Inc.
 #   Written by Scott James Remnant, 2004.
 #
 # This file is free software; the Free Software Foundation gives
 # unlimited permission to copy and/or distribute it, with or without
 # modifications, as long as this notice is preserved.
 
-# serial 4 lt~obsolete.m4
+# serial 5 lt~obsolete.m4
 
 # These exist entirely to fool aclocal when bootstrapping libtool.
 #
@@ -7971,7 +8426,6 @@
 m4_ifndef([_LT_AC_LANG_CXX],		[AC_DEFUN([_LT_AC_LANG_CXX])])
 m4_ifndef([_LT_AC_LANG_F77],		[AC_DEFUN([_LT_AC_LANG_F77])])
 m4_ifndef([_LT_AC_LANG_GCJ],		[AC_DEFUN([_LT_AC_LANG_GCJ])])
-m4_ifndef([AC_LIBTOOL_RC],		[AC_DEFUN([AC_LIBTOOL_RC])])
 m4_ifndef([AC_LIBTOOL_LANG_C_CONFIG],	[AC_DEFUN([AC_LIBTOOL_LANG_C_CONFIG])])
 m4_ifndef([_LT_AC_LANG_C_CONFIG],	[AC_DEFUN([_LT_AC_LANG_C_CONFIG])])
 m4_ifndef([AC_LIBTOOL_LANG_CXX_CONFIG],	[AC_DEFUN([AC_LIBTOOL_LANG_CXX_CONFIG])])
@@ -7984,164 +8438,13 @@
 m4_ifndef([_LT_AC_LANG_RC_CONFIG],	[AC_DEFUN([_LT_AC_LANG_RC_CONFIG])])
 m4_ifndef([AC_LIBTOOL_CONFIG],		[AC_DEFUN([AC_LIBTOOL_CONFIG])])
 m4_ifndef([_LT_AC_FILE_LTDLL_C],	[AC_DEFUN([_LT_AC_FILE_LTDLL_C])])
-
-# pkg.m4 - Macros to locate and utilise pkg-config.            -*- Autoconf -*-
-# serial 1 (pkg-config-0.24)
-# 
-# Copyright  2004 Scott James Remnant <scott@netsplit.com>.
-#
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or
-# (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful, but
-# WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-# General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
-#
-# As a special exception to the GNU General Public License, if you
-# distribute this file as part of a program that contains a
-# configuration script generated by Autoconf, you may include it under
-# the same distribution terms that you use for the rest of that program.
-
-# PKG_PROG_PKG_CONFIG([MIN-VERSION])
-# ----------------------------------
-AC_DEFUN([PKG_PROG_PKG_CONFIG],
-[m4_pattern_forbid([^_?PKG_[A-Z_]+$])
-m4_pattern_allow([^PKG_CONFIG(_PATH)?$])
-AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])
-AC_ARG_VAR([PKG_CONFIG_PATH], [directories to add to pkg-config's search path])
-AC_ARG_VAR([PKG_CONFIG_LIBDIR], [path overriding pkg-config's built-in search path])
-
-if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
-	AC_PATH_TOOL([PKG_CONFIG], [pkg-config])
-fi
-if test -n "$PKG_CONFIG"; then
-	_pkg_min_version=m4_default([$1], [0.9.0])
-	AC_MSG_CHECKING([pkg-config is at least version $_pkg_min_version])
-	if $PKG_CONFIG --atleast-pkgconfig-version $_pkg_min_version; then
-		AC_MSG_RESULT([yes])
-	else
-		AC_MSG_RESULT([no])
-		PKG_CONFIG=""
-	fi
-fi[]dnl
-])# PKG_PROG_PKG_CONFIG
-
-# PKG_CHECK_EXISTS(MODULES, [ACTION-IF-FOUND], [ACTION-IF-NOT-FOUND])
-#
-# Check to see whether a particular set of modules exists.  Similar
-# to PKG_CHECK_MODULES(), but does not set variables or print errors.
-#
-# Please remember that m4 expands AC_REQUIRE([PKG_PROG_PKG_CONFIG])
-# only at the first occurence in configure.ac, so if the first place
-# it's called might be skipped (such as if it is within an "if", you
-# have to call PKG_CHECK_EXISTS manually
-# --------------------------------------------------------------
-AC_DEFUN([PKG_CHECK_EXISTS],
-[AC_REQUIRE([PKG_PROG_PKG_CONFIG])dnl
-if test -n "$PKG_CONFIG" && \
-    AC_RUN_LOG([$PKG_CONFIG --exists --print-errors "$1"]); then
-  m4_default([$2], [:])
-m4_ifvaln([$3], [else
-  $3])dnl
-fi])
-
-# _PKG_CONFIG([VARIABLE], [COMMAND], [MODULES])
-# ---------------------------------------------
-m4_define([_PKG_CONFIG],
-[if test -n "$$1"; then
-    pkg_cv_[]$1="$$1"
- elif test -n "$PKG_CONFIG"; then
-    PKG_CHECK_EXISTS([$3],
-                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`],
-		     [pkg_failed=yes])
- else
-    pkg_failed=untried
-fi[]dnl
-])# _PKG_CONFIG
-
-# _PKG_SHORT_ERRORS_SUPPORTED
-# -----------------------------
-AC_DEFUN([_PKG_SHORT_ERRORS_SUPPORTED],
-[AC_REQUIRE([PKG_PROG_PKG_CONFIG])
-if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
-        _pkg_short_errors_supported=yes
-else
-        _pkg_short_errors_supported=no
-fi[]dnl
-])# _PKG_SHORT_ERRORS_SUPPORTED
-
-
-# PKG_CHECK_MODULES(VARIABLE-PREFIX, MODULES, [ACTION-IF-FOUND],
-# [ACTION-IF-NOT-FOUND])
-#
-#
-# Note that if there is a possibility the first call to
-# PKG_CHECK_MODULES might not happen, you should be sure to include an
-# explicit call to PKG_PROG_PKG_CONFIG in your configure.ac
-#
-#
-# --------------------------------------------------------------
-AC_DEFUN([PKG_CHECK_MODULES],
-[AC_REQUIRE([PKG_PROG_PKG_CONFIG])dnl
-AC_ARG_VAR([$1][_CFLAGS], [C compiler flags for $1, overriding pkg-config])dnl
-AC_ARG_VAR([$1][_LIBS], [linker flags for $1, overriding pkg-config])dnl
-
-pkg_failed=no
-AC_MSG_CHECKING([for $1])
-
-_PKG_CONFIG([$1][_CFLAGS], [cflags], [$2])
-_PKG_CONFIG([$1][_LIBS], [libs], [$2])
-
-m4_define([_PKG_TEXT], [Alternatively, you may set the environment variables $1[]_CFLAGS
-and $1[]_LIBS to avoid the need to call pkg-config.
-See the pkg-config man page for more details.])
-
-if test $pkg_failed = yes; then
-   	AC_MSG_RESULT([no])
-        _PKG_SHORT_ERRORS_SUPPORTED
-        if test $_pkg_short_errors_supported = yes; then
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$2" 2>&1`
-        else 
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors "$2" 2>&1`
-        fi
-	# Put the nasty error message in config.log where it belongs
-	echo "$$1[]_PKG_ERRORS" >&AS_MESSAGE_LOG_FD
-
-	m4_default([$4], [AC_MSG_ERROR(
-[Package requirements ($2) were not met:
-
-$$1_PKG_ERRORS
-
-Consider adjusting the PKG_CONFIG_PATH environment variable if you
-installed software in a non-standard prefix.
-
-_PKG_TEXT])[]dnl
-        ])
-elif test $pkg_failed = untried; then
-     	AC_MSG_RESULT([no])
-	m4_default([$4], [AC_MSG_FAILURE(
-[The pkg-config script could not be found or is too old.  Make sure it
-is in your PATH or set the PKG_CONFIG environment variable to the full
-path to pkg-config.
-
-_PKG_TEXT
-
-To get pkg-config, see <http://pkg-config.freedesktop.org/>.])[]dnl
-        ])
-else
-	$1[]_CFLAGS=$pkg_cv_[]$1[]_CFLAGS
-	$1[]_LIBS=$pkg_cv_[]$1[]_LIBS
-        AC_MSG_RESULT([yes])
-	$3
-fi[]dnl
-])# PKG_CHECK_MODULES
+m4_ifndef([_LT_REQUIRED_DARWIN_CHECKS],	[AC_DEFUN([_LT_REQUIRED_DARWIN_CHECKS])])
+m4_ifndef([_LT_AC_PROG_CXXCPP],		[AC_DEFUN([_LT_AC_PROG_CXXCPP])])
+m4_ifndef([_LT_PREPARE_SED_QUOTE_VARS],	[AC_DEFUN([_LT_PREPARE_SED_QUOTE_VARS])])
+m4_ifndef([_LT_PROG_ECHO_BACKSLASH],	[AC_DEFUN([_LT_PROG_ECHO_BACKSLASH])])
+m4_ifndef([_LT_PROG_F77],		[AC_DEFUN([_LT_PROG_F77])])
+m4_ifndef([_LT_PROG_FC],		[AC_DEFUN([_LT_PROG_FC])])
+m4_ifndef([_LT_PROG_CXX],		[AC_DEFUN([_LT_PROG_CXX])])
 
 # Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
 #
Only in trousers-0.3.8: autom4te.cache
Only in trousers-0.3.8: configure
diff -ru trousers-0.3.8-orig/configure.in trousers-0.3.8/configure.in
--- trousers-0.3.8-orig/configure.in	2011-12-24 06:16:22.000000000 +0000
+++ trousers-0.3.8/configure.in	2012-02-14 20:35:00.857369364 +0000
@@ -107,38 +107,8 @@
 CFLAGS="$CFLAGS -D$MATH_DEFINE"
 
 GUI=openssl
-AC_ARG_WITH(gui,
-	    [AC_HELP_STRING([--with-gui], [type of gui popup (gtk/none) [default=gtk]])],
-	    [GUI=$withval],
-	    [])
-
-if test "x$GUI" = "xgtk"; then
-	# section imported from Glade compile
-	pkg_modules="gtk+-2.0 >= 2.0.0"
-	PKG_CHECK_MODULES(GTK,
-		[$pkg_modules],
-		AM_CONDITIONAL(HAVE_GTK, true),
-		[AM_CONDITIONAL(HAVE_GTK, false)
-		AC_MSG_ERROR([Please install the gtk2-devel package for your distro or select another gui option.]) ])
-	AM_CONDITIONAL(OPENSSL_UI, false)
-	AC_SUBST(GTK_CFLAGS)
-	AC_SUBST(GTK_LIBS)
-elif test "x$GUI" = "xopenssl"; then
-	# We know we have OpenSSL
-	AM_CONDITIONAL(OPENSSL_UI, true)
-	AM_CONDITIONAL(HAVE_GTK, false)
-elif test "x$GUI" = "xnone"; then
-	if test $SPEC_COMP -eq 1; then
-		AC_MSG_ERROR([Popups must be enabled in strict spec compliance mode])
-	fi
-	AC_MSG_RESULT([*** Disabling GUI popups at user request ***])
-	AC_MSG_RESULT([*** WARNING: This may break apps! ***])
-	CFLAGS="$CFLAGS -DTSS_NO_GUI"
-	AM_CONDITIONAL(HAVE_GTK, false)
-	AM_CONDITIONAL(OPENSSL_UI, false)
-else
-	AC_MSG_ERROR(["gtk", "openssl" and "none" are the only supported gui options for trousers])
-fi
+AM_CONDITIONAL(OPENSSL_UI, true)
+AM_CONDITIONAL(HAVE_GTK, false)
 
 #
 # The default port that the TCS daemon listens on
@@ -351,6 +321,7 @@
 
 AC_C_BIGENDIAN([AC_DEFINE(_BIG_ENDIAN, 1, [big-endian host])])
 AC_CHECK_DECL(htole32, [AC_DEFINE(HTOLE_DEFINED, 1, [htole32 function is available])])
+AC_CHECK_HEADER(endian.h, [AC_DEFINE(HAVE_ENDIAN_H, 1, [endian.h header])])
 AC_CHECK_HEADER(sys/byteorder.h, [AC_DEFINE(HAVE_BYTEORDER_H, 1, [sys/byteorder.h header])])
 AC_CHECK_FUNC(daemon, [ AC_DEFINE(HAVE_DAEMON, 1, [daemon function is available]) ])
  
Only in trousers-0.3.8: configure.rej
Only in trousers-0.3.8: configure.rej.rej
diff -ru trousers-0.3.8-orig/dist/Makefile.in trousers-0.3.8/dist/Makefile.in
--- trousers-0.3.8-orig/dist/Makefile.in	2011-12-24 06:19:32.000000000 +0000
+++ trousers-0.3.8/dist/Makefile.in	2012-02-14 20:35:05.873432900 +0000
@@ -64,6 +64,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -73,8 +74,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -89,6 +88,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -105,9 +105,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -120,6 +117,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -152,7 +150,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/dist/tcsd.conf.in trousers-0.3.8/dist/tcsd.conf.in
--- trousers-0.3.8-orig/dist/tcsd.conf.in	2010-01-28 16:27:50.000000000 +0000
+++ trousers-0.3.8/dist/tcsd.conf.in	2012-02-14 20:35:05.874038104 +0000
@@ -37,6 +37,7 @@
 #
 # firmware_log_file = /sys/kernel/security/tpm0/binary_bios_measurements
 #
+firmware_log_file=/var/tpm/system/pcrevent.log
 
 # Option: kernel_log_file
 # Values: Any absolute directory path
@@ -54,7 +55,7 @@
 # Description: A list of PCR indices that are manipulated only by the system
 #  firmware and therefore are not extended or logged by the TCSD.
 #
-# firmware_pcrs =
+firmware_pcrs =0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,20,21
 #
 
 # Option: kernel_pcrs
diff -ru trousers-0.3.8-orig/ltmain.sh trousers-0.3.8/ltmain.sh
--- trousers-0.3.8-orig/ltmain.sh	2011-12-24 06:19:31.000000000 +0000
+++ trousers-0.3.8/ltmain.sh	2012-02-14 20:35:05.900646435 +0000
@@ -1,9 +1,9 @@
-# Generated from ltmain.m4sh.
 
-# ltmain.sh (GNU libtool) 2.2.6b
+# libtool (GNU libtool) 2.4
 # Written by Gordon Matzigkeit <gord@gnu.ai.mit.edu>, 1996
 
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005, 2006, 2007 2008 Free Software Foundation, Inc.
+# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005, 2006,
+# 2007, 2008, 2009, 2010 Free Software Foundation, Inc.
 # This is free software; see the source for copying conditions.  There is NO
 # warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 
@@ -32,50 +32,56 @@
 #
 # Provide generalized library-building support services.
 #
-#     --config             show all configuration variables
-#     --debug              enable verbose shell tracing
-# -n, --dry-run            display commands without modifying any files
-#     --features           display basic configuration information and exit
-#     --mode=MODE          use operation mode MODE
-#     --preserve-dup-deps  don't remove duplicate dependency libraries
-#     --quiet, --silent    don't print informational messages
-#     --tag=TAG            use configuration variables from tag TAG
-# -v, --verbose            print informational messages (default)
-#     --version            print version information
-# -h, --help               print short or long help message
+#       --config             show all configuration variables
+#       --debug              enable verbose shell tracing
+#   -n, --dry-run            display commands without modifying any files
+#       --features           display basic configuration information and exit
+#       --mode=MODE          use operation mode MODE
+#       --preserve-dup-deps  don't remove duplicate dependency libraries
+#       --quiet, --silent    don't print informational messages
+#       --no-quiet, --no-silent
+#                            print informational messages (default)
+#       --tag=TAG            use configuration variables from tag TAG
+#   -v, --verbose            print more informational messages than default
+#       --no-verbose         don't print the extra informational messages
+#       --version            print version information
+#   -h, --help, --help-all   print short, long, or detailed help message
 #
 # MODE must be one of the following:
 #
-#       clean              remove files from the build directory
-#       compile            compile a source file into a libtool object
-#       execute            automatically set library path, then run a program
-#       finish             complete the installation of libtool libraries
-#       install            install libraries or executables
-#       link               create a library or an executable
-#       uninstall          remove libraries from an installed directory
+#         clean              remove files from the build directory
+#         compile            compile a source file into a libtool object
+#         execute            automatically set library path, then run a program
+#         finish             complete the installation of libtool libraries
+#         install            install libraries or executables
+#         link               create a library or an executable
+#         uninstall          remove libraries from an installed directory
 #
-# MODE-ARGS vary depending on the MODE.
+# MODE-ARGS vary depending on the MODE.  When passed as first option,
+# `--mode=MODE' may be abbreviated as `MODE' or a unique abbreviation of that.
 # Try `$progname --help --mode=MODE' for a more detailed description of MODE.
 #
 # When reporting a bug, please describe a test case to reproduce it and
 # include the following information:
 #
-#       host-triplet:	$host
-#       shell:		$SHELL
-#       compiler:		$LTCC
-#       compiler flags:		$LTCFLAGS
-#       linker:		$LD (gnu? $with_gnu_ld)
-#       $progname:		(GNU libtool) 2.2.6b Debian-2.2.6b-2ubuntu3
-#       automake:		$automake_version
-#       autoconf:		$autoconf_version
+#         host-triplet:	$host
+#         shell:		$SHELL
+#         compiler:		$LTCC
+#         compiler flags:		$LTCFLAGS
+#         linker:		$LD (gnu? $with_gnu_ld)
+#         $progname:	(GNU libtool) 2.4
+#         automake:	$automake_version
+#         autoconf:	$autoconf_version
 #
 # Report bugs to <bug-libtool@gnu.org>.
+# GNU libtool home page: <http://www.gnu.org/software/libtool/>.
+# General help using GNU software: <http://www.gnu.org/gethelp/>.
 
-PROGRAM=ltmain.sh
+PROGRAM=libtool
 PACKAGE=libtool
-VERSION="2.2.6b Debian-2.2.6b-2ubuntu3"
+VERSION=2.4
 TIMESTAMP=""
-package_revision=1.3017
+package_revision=1.3293
 
 # Be Bourne compatible
 if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
@@ -91,10 +97,15 @@
 BIN_SH=xpg4; export BIN_SH # for Tru64
 DUALCASE=1; export DUALCASE # for MKS sh
 
+# A function that is used when there is no print builtin or printf.
+func_fallback_echo ()
+{
+  eval 'cat <<_LTECHO_EOF
+$1
+_LTECHO_EOF'
+}
+
 # NLS nuisances: We save the old values to restore during execute mode.
-# Only set LANG and LC_ALL to C if already set.
-# These must not be set unconditionally because not all systems understand
-# e.g. LANG=C (notably SCO).
 lt_user_locale=
 lt_safe_locale=
 for lt_var in LANG LANGUAGE LC_ALL LC_CTYPE LC_COLLATE LC_MESSAGES
@@ -107,24 +118,33 @@
 	  lt_safe_locale=\"$lt_var=C; \$lt_safe_locale\"
 	fi"
 done
+LC_ALL=C
+LANGUAGE=C
+export LANGUAGE LC_ALL
 
 $lt_unset CDPATH
 
 
+# Work around backward compatibility issue on IRIX 6.5. On IRIX 6.4+, sh
+# is ksh but when the shell is invoked as "sh" and the current value of
+# the _XPG environment variable is not equal to 1 (one), the special
+# positional parameter $0, within a function call, is the name of the
+# function.
+progpath="$0"
 
 
 
 : ${CP="cp -f"}
-: ${ECHO="echo"}
-: ${EGREP="/bin/grep -E"}
-: ${FGREP="/bin/grep -F"}
-: ${GREP="/bin/grep"}
+test "${ECHO+set}" = set || ECHO=${as_echo-'printf %s\n'}
+: ${EGREP="grep -E"}
+: ${FGREP="grep -F"}
+: ${GREP="grep"}
 : ${LN_S="ln -s"}
 : ${MAKE="make"}
 : ${MKDIR="mkdir"}
 : ${MV="mv -f"}
 : ${RM="rm -f"}
-: ${SED="/bin/sed"}
+: ${SED="sed"}
 : ${SHELL="${CONFIG_SHELL-/bin/sh}"}
 : ${Xsed="$SED -e 1s/^X//"}
 
@@ -144,6 +164,27 @@
 dirname="s,/[^/]*$,,"
 basename="s,^.*/,,"
 
+# func_dirname file append nondir_replacement
+# Compute the dirname of FILE.  If nonempty, add APPEND to the result,
+# otherwise set result to NONDIR_REPLACEMENT.
+func_dirname ()
+{
+    func_dirname_result=`$ECHO "${1}" | $SED "$dirname"`
+    if test "X$func_dirname_result" = "X${1}"; then
+      func_dirname_result="${3}"
+    else
+      func_dirname_result="$func_dirname_result${2}"
+    fi
+} # func_dirname may be replaced by extended shell implementation
+
+
+# func_basename file
+func_basename ()
+{
+    func_basename_result=`$ECHO "${1}" | $SED "$basename"`
+} # func_basename may be replaced by extended shell implementation
+
+
 # func_dirname_and_basename file append nondir_replacement
 # perform func_basename and func_dirname in a single function
 # call:
@@ -158,33 +199,183 @@
 # those functions but instead duplicate the functionality here.
 func_dirname_and_basename ()
 {
-  # Extract subdirectory from the argument.
-  func_dirname_result=`$ECHO "X${1}" | $Xsed -e "$dirname"`
-  if test "X$func_dirname_result" = "X${1}"; then
-    func_dirname_result="${3}"
-  else
-    func_dirname_result="$func_dirname_result${2}"
-  fi
-  func_basename_result=`$ECHO "X${1}" | $Xsed -e "$basename"`
+    # Extract subdirectory from the argument.
+    func_dirname_result=`$ECHO "${1}" | $SED -e "$dirname"`
+    if test "X$func_dirname_result" = "X${1}"; then
+      func_dirname_result="${3}"
+    else
+      func_dirname_result="$func_dirname_result${2}"
+    fi
+    func_basename_result=`$ECHO "${1}" | $SED -e "$basename"`
+} # func_dirname_and_basename may be replaced by extended shell implementation
+
+
+# func_stripname prefix suffix name
+# strip PREFIX and SUFFIX off of NAME.
+# PREFIX and SUFFIX must not contain globbing or regex special
+# characters, hashes, percent signs, but SUFFIX may contain a leading
+# dot (in which case that matches only a dot).
+# func_strip_suffix prefix name
+func_stripname ()
+{
+    case ${2} in
+      .*) func_stripname_result=`$ECHO "${3}" | $SED "s%^${1}%%; s%\\\\${2}\$%%"`;;
+      *)  func_stripname_result=`$ECHO "${3}" | $SED "s%^${1}%%; s%${2}\$%%"`;;
+    esac
+} # func_stripname may be replaced by extended shell implementation
+
+
+# These SED scripts presuppose an absolute path with a trailing slash.
+pathcar='s,^/\([^/]*\).*$,\1,'
+pathcdr='s,^/[^/]*,,'
+removedotparts=':dotsl
+		s@/\./@/@g
+		t dotsl
+		s,/\.$,/,'
+collapseslashes='s@/\{1,\}@/@g'
+finalslash='s,/*$,/,'
+
+# func_normal_abspath PATH
+# Remove doubled-up and trailing slashes, "." path components,
+# and cancel out any ".." path components in PATH after making
+# it an absolute path.
+#             value returned in "$func_normal_abspath_result"
+func_normal_abspath ()
+{
+  # Start from root dir and reassemble the path.
+  func_normal_abspath_result=
+  func_normal_abspath_tpath=$1
+  func_normal_abspath_altnamespace=
+  case $func_normal_abspath_tpath in
+    "")
+      # Empty path, that just means $cwd.
+      func_stripname '' '/' "`pwd`"
+      func_normal_abspath_result=$func_stripname_result
+      return
+    ;;
+    # The next three entries are used to spot a run of precisely
+    # two leading slashes without using negated character classes;
+    # we take advantage of case's first-match behaviour.
+    ///*)
+      # Unusual form of absolute path, do nothing.
+    ;;
+    //*)
+      # Not necessarily an ordinary path; POSIX reserves leading '//'
+      # and for example Cygwin uses it to access remote file shares
+      # over CIFS/SMB, so we conserve a leading double slash if found.
+      func_normal_abspath_altnamespace=/
+    ;;
+    /*)
+      # Absolute path, do nothing.
+    ;;
+    *)
+      # Relative path, prepend $cwd.
+      func_normal_abspath_tpath=`pwd`/$func_normal_abspath_tpath
+    ;;
+  esac
+  # Cancel out all the simple stuff to save iterations.  We also want
+  # the path to end with a slash for ease of parsing, so make sure
+  # there is one (and only one) here.
+  func_normal_abspath_tpath=`$ECHO "$func_normal_abspath_tpath" | $SED \
+        -e "$removedotparts" -e "$collapseslashes" -e "$finalslash"`
+  while :; do
+    # Processed it all yet?
+    if test "$func_normal_abspath_tpath" = / ; then
+      # If we ascended to the root using ".." the result may be empty now.
+      if test -z "$func_normal_abspath_result" ; then
+        func_normal_abspath_result=/
+      fi
+      break
+    fi
+    func_normal_abspath_tcomponent=`$ECHO "$func_normal_abspath_tpath" | $SED \
+        -e "$pathcar"`
+    func_normal_abspath_tpath=`$ECHO "$func_normal_abspath_tpath" | $SED \
+        -e "$pathcdr"`
+    # Figure out what to do with it
+    case $func_normal_abspath_tcomponent in
+      "")
+        # Trailing empty path component, ignore it.
+      ;;
+      ..)
+        # Parent dir; strip last assembled component from result.
+        func_dirname "$func_normal_abspath_result"
+        func_normal_abspath_result=$func_dirname_result
+      ;;
+      *)
+        # Actual path component, append it.
+        func_normal_abspath_result=$func_normal_abspath_result/$func_normal_abspath_tcomponent
+      ;;
+    esac
+  done
+  # Restore leading double-slash if one was found on entry.
+  func_normal_abspath_result=$func_normal_abspath_altnamespace$func_normal_abspath_result
 }
 
-# Generated shell functions inserted here.
+# func_relative_path SRCDIR DSTDIR
+# generates a relative path from SRCDIR to DSTDIR, with a trailing
+# slash if non-empty, suitable for immediately appending a filename
+# without needing to append a separator.
+#             value returned in "$func_relative_path_result"
+func_relative_path ()
+{
+  func_relative_path_result=
+  func_normal_abspath "$1"
+  func_relative_path_tlibdir=$func_normal_abspath_result
+  func_normal_abspath "$2"
+  func_relative_path_tbindir=$func_normal_abspath_result
+
+  # Ascend the tree starting from libdir
+  while :; do
+    # check if we have found a prefix of bindir
+    case $func_relative_path_tbindir in
+      $func_relative_path_tlibdir)
+        # found an exact match
+        func_relative_path_tcancelled=
+        break
+        ;;
+      $func_relative_path_tlibdir*)
+        # found a matching prefix
+        func_stripname "$func_relative_path_tlibdir" '' "$func_relative_path_tbindir"
+        func_relative_path_tcancelled=$func_stripname_result
+        if test -z "$func_relative_path_result"; then
+          func_relative_path_result=.
+        fi
+        break
+        ;;
+      *)
+        func_dirname $func_relative_path_tlibdir
+        func_relative_path_tlibdir=${func_dirname_result}
+        if test "x$func_relative_path_tlibdir" = x ; then
+          # Have to descend all the way to the root!
+          func_relative_path_result=../$func_relative_path_result
+          func_relative_path_tcancelled=$func_relative_path_tbindir
+          break
+        fi
+        func_relative_path_result=../$func_relative_path_result
+        ;;
+    esac
+  done
 
-# Work around backward compatibility issue on IRIX 6.5. On IRIX 6.4+, sh
-# is ksh but when the shell is invoked as "sh" and the current value of
-# the _XPG environment variable is not equal to 1 (one), the special
-# positional parameter $0, within a function call, is the name of the
-# function.
-progpath="$0"
+  # Now calculate path; take care to avoid doubling-up slashes.
+  func_stripname '' '/' "$func_relative_path_result"
+  func_relative_path_result=$func_stripname_result
+  func_stripname '/' '/' "$func_relative_path_tcancelled"
+  if test "x$func_stripname_result" != x ; then
+    func_relative_path_result=${func_relative_path_result}/${func_stripname_result}
+  fi
+
+  # Normalisation. If bindir is libdir, return empty string,
+  # else relative path ending with a slash; either way, target
+  # file name can be directly appended.
+  if test ! -z "$func_relative_path_result"; then
+    func_stripname './' '' "$func_relative_path_result/"
+    func_relative_path_result=$func_stripname_result
+  fi
+}
 
 # The name of this program:
-# In the unlikely event $progname began with a '-', it would play havoc with
-# func_echo (imagine progname=-n), so we prepend ./ in that case:
 func_dirname_and_basename "$progpath"
 progname=$func_basename_result
-case $progname in
-  -*) progname=./$progname ;;
-esac
 
 # Make sure we have an absolute path for reexecution:
 case $progpath in
@@ -215,6 +406,15 @@
 # Same as above, but do not quote variable references.
 double_quote_subst='s/\(["`\\]\)/\\\1/g'
 
+# Sed substitution that turns a string into a regex matching for the
+# string literally.
+sed_make_literal_regex='s,[].[^$\\*\/],\\&,g'
+
+# Sed substitution that converts a w32 file name or path
+# which contains forward slashes, into one that contains
+# (escaped) backslashes.  A very naive implementation.
+lt_sed_naive_backslashify='s|\\\\*|\\|g;s|/|\\|g;s|\\|\\\\|g'
+
 # Re-`\' parameter expansions in output of double_quote_subst that were
 # `\'-ed in input to the same.  If an odd number of `\' preceded a '$'
 # in input to double_quote_subst, that '$' was protected from expansion.
@@ -243,7 +443,7 @@
 # name if it has been set yet.
 func_echo ()
 {
-    $ECHO "$progname${mode+: }$mode: $*"
+    $ECHO "$progname: ${opt_mode+$opt_mode: }$*"
 }
 
 # func_verbose arg...
@@ -258,18 +458,25 @@
     :
 }
 
+# func_echo_all arg...
+# Invoke $ECHO with all args, space-separated.
+func_echo_all ()
+{
+    $ECHO "$*"
+}
+
 # func_error arg...
 # Echo program name prefixed message to standard error.
 func_error ()
 {
-    $ECHO "$progname${mode+: }$mode: "${1+"$@"} 1>&2
+    $ECHO "$progname: ${opt_mode+$opt_mode: }"${1+"$@"} 1>&2
 }
 
 # func_warning arg...
 # Echo program name prefixed warning message to standard error.
 func_warning ()
 {
-    $opt_warning && $ECHO "$progname${mode+: }$mode: warning: "${1+"$@"} 1>&2
+    $opt_warning && $ECHO "$progname: ${opt_mode+$opt_mode: }warning: "${1+"$@"} 1>&2
 
     # bash bug again:
     :
@@ -326,9 +533,9 @@
         case $my_directory_path in */*) ;; *) break ;; esac
 
         # ...otherwise throw away the child directory and loop
-        my_directory_path=`$ECHO "X$my_directory_path" | $Xsed -e "$dirname"`
+        my_directory_path=`$ECHO "$my_directory_path" | $SED -e "$dirname"`
       done
-      my_dir_list=`$ECHO "X$my_dir_list" | $Xsed -e 's,:*$,,'`
+      my_dir_list=`$ECHO "$my_dir_list" | $SED 's,:*$,,'`
 
       save_mkdir_p_IFS="$IFS"; IFS=':'
       for my_dir in $my_dir_list; do
@@ -378,7 +585,7 @@
         func_fatal_error "cannot create temporary directory \`$my_tmpdir'"
     fi
 
-    $ECHO "X$my_tmpdir" | $Xsed
+    $ECHO "$my_tmpdir"
 }
 
 
@@ -392,7 +599,7 @@
 {
     case $1 in
       *[\\\`\"\$]*)
-	func_quote_for_eval_unquoted_result=`$ECHO "X$1" | $Xsed -e "$sed_quote_subst"` ;;
+	func_quote_for_eval_unquoted_result=`$ECHO "$1" | $SED "$sed_quote_subst"` ;;
       *)
         func_quote_for_eval_unquoted_result="$1" ;;
     esac
@@ -419,7 +626,7 @@
 {
     case $1 in
       *[\\\`\"]*)
-	my_arg=`$ECHO "X$1" | $Xsed \
+	my_arg=`$ECHO "$1" | $SED \
 	    -e "$double_quote_subst" -e "$sed_double_backslash"` ;;
       *)
         my_arg="$1" ;;
@@ -488,15 +695,39 @@
     fi
 }
 
-
-
+# func_tr_sh
+# Turn $1 into a string suitable for a shell variable name.
+# Result is stored in $func_tr_sh_result.  All characters
+# not in the set a-zA-Z0-9_ are replaced with '_'. Further,
+# if $1 begins with a digit, a '_' is prepended as well.
+func_tr_sh ()
+{
+  case $1 in
+  [0-9]* | *[!a-zA-Z0-9_]*)
+    func_tr_sh_result=`$ECHO "$1" | $SED 's/^\([0-9]\)/_\1/; s/[^a-zA-Z0-9_]/_/g'`
+    ;;
+  * )
+    func_tr_sh_result=$1
+    ;;
+  esac
+}
 
 
 # func_version
 # Echo version message to standard output and exit.
 func_version ()
 {
-    $SED -n '/^# '$PROGRAM' (GNU /,/# warranty; / {
+    $opt_debug
+
+    $SED -n '/(C)/!b go
+	:more
+	/\./!{
+	  N
+	  s/\n# / /
+	  b more
+	}
+	:go
+	/^# '$PROGRAM' (GNU /,/# warranty; / {
         s/^# //
 	s/^# *$//
         s/\((C)\)[ 0-9,-]*\( [1-9][0-9]*\)/\1\2/
@@ -509,22 +740,28 @@
 # Echo short help message to standard output and exit.
 func_usage ()
 {
-    $SED -n '/^# Usage:/,/# -h/ {
+    $opt_debug
+
+    $SED -n '/^# Usage:/,/^#  *.*--help/ {
         s/^# //
 	s/^# *$//
 	s/\$progname/'$progname'/
 	p
     }' < "$progpath"
-    $ECHO
+    echo
     $ECHO "run \`$progname --help | more' for full usage"
     exit $?
 }
 
-# func_help
-# Echo long help message to standard output and exit.
+# func_help [NOEXIT]
+# Echo long help message to standard output and exit,
+# unless 'noexit' is passed as argument.
 func_help ()
 {
+    $opt_debug
+
     $SED -n '/^# Usage:/,/# Report bugs to/ {
+	:print
         s/^# //
 	s/^# *$//
 	s*\$progname*'$progname'*
@@ -537,8 +774,15 @@
 	s/\$automake_version/'"`(automake --version) 2>/dev/null |$SED 1q`"'/
 	s/\$autoconf_version/'"`(autoconf --version) 2>/dev/null |$SED 1q`"'/
 	p
-     }' < "$progpath"
-    exit $?
+	d
+     }
+     /^# .* home page:/b print
+     /^# General help using/b print
+     ' < "$progpath"
+    ret=$?
+    if test -z "$1"; then
+      exit $ret
+    fi
 }
 
 # func_missing_arg argname
@@ -546,63 +790,106 @@
 # exit_cmd.
 func_missing_arg ()
 {
-    func_error "missing argument for $1"
+    $opt_debug
+
+    func_error "missing argument for $1."
     exit_cmd=exit
 }
 
-exit_cmd=:
 
+# func_split_short_opt shortopt
+# Set func_split_short_opt_name and func_split_short_opt_arg shell
+# variables after splitting SHORTOPT after the 2nd character.
+func_split_short_opt ()
+{
+    my_sed_short_opt='1s/^\(..\).*$/\1/;q'
+    my_sed_short_rest='1s/^..\(.*\)$/\1/;q'
+
+    func_split_short_opt_name=`$ECHO "$1" | $SED "$my_sed_short_opt"`
+    func_split_short_opt_arg=`$ECHO "$1" | $SED "$my_sed_short_rest"`
+} # func_split_short_opt may be replaced by extended shell implementation
+
+
+# func_split_long_opt longopt
+# Set func_split_long_opt_name and func_split_long_opt_arg shell
+# variables after splitting LONGOPT at the `=' sign.
+func_split_long_opt ()
+{
+    my_sed_long_opt='1s/^\(--[^=]*\)=.*/\1/;q'
+    my_sed_long_arg='1s/^--[^=]*=//'
+
+    func_split_long_opt_name=`$ECHO "$1" | $SED "$my_sed_long_opt"`
+    func_split_long_opt_arg=`$ECHO "$1" | $SED "$my_sed_long_arg"`
+} # func_split_long_opt may be replaced by extended shell implementation
 
+exit_cmd=:
 
 
 
-# Check that we have a working $ECHO.
-if test "X$1" = X--no-reexec; then
-  # Discard the --no-reexec flag, and continue.
-  shift
-elif test "X$1" = X--fallback-echo; then
-  # Avoid inline document here, it may be left over
-  :
-elif test "X`{ $ECHO '\t'; } 2>/dev/null`" = 'X\t'; then
-  # Yippee, $ECHO works!
-  :
-else
-  # Restart under the correct shell, and then maybe $ECHO will work.
-  exec $SHELL "$progpath" --no-reexec ${1+"$@"}
-fi
 
-if test "X$1" = X--fallback-echo; then
-  # used as fallback echo
-  shift
-  cat <<EOF
-$*
-EOF
-  exit $EXIT_SUCCESS
-fi
 
 magic="%%%MAGIC variable%%%"
 magic_exe="%%%MAGIC EXE variable%%%"
 
 # Global variables.
-# $mode is unset
 nonopt=
-execute_dlfiles=
 preserve_args=
 lo2o="s/\\.lo\$/.${objext}/"
 o2lo="s/\\.${objext}\$/.lo/"
 extracted_archives=
 extracted_serial=0
 
-opt_dry_run=false
-opt_duplicate_deps=false
-opt_silent=false
-opt_debug=:
-
 # If this variable is set in any of the actions, the command in it
 # will be execed at the end.  This prevents here-documents from being
 # left over by shells.
 exec_cmd=
 
+# func_append var value
+# Append VALUE to the end of shell variable VAR.
+func_append ()
+{
+    eval "${1}=\$${1}\${2}"
+} # func_append may be replaced by extended shell implementation
+
+# func_append_quoted var value
+# Quote VALUE and append to the end of shell variable VAR, separated
+# by a space.
+func_append_quoted ()
+{
+    func_quote_for_eval "${2}"
+    eval "${1}=\$${1}\\ \$func_quote_for_eval_result"
+} # func_append_quoted may be replaced by extended shell implementation
+
+
+# func_arith arithmetic-term...
+func_arith ()
+{
+    func_arith_result=`expr "${@}"`
+} # func_arith may be replaced by extended shell implementation
+
+
+# func_len string
+# STRING may not start with a hyphen.
+func_len ()
+{
+    func_len_result=`expr "${1}" : ".*" 2>/dev/null || echo $max_cmd_len`
+} # func_len may be replaced by extended shell implementation
+
+
+# func_lo2o object
+func_lo2o ()
+{
+    func_lo2o_result=`$ECHO "${1}" | $SED "$lo2o"`
+} # func_lo2o may be replaced by extended shell implementation
+
+
+# func_xform libobj-or-source
+func_xform ()
+{
+    func_xform_result=`$ECHO "${1}" | $SED 's/\.[^.]*$/.lo/'`
+} # func_xform may be replaced by extended shell implementation
+
+
 # func_fatal_configuration arg...
 # Echo program name prefixed message to standard error, followed by
 # a configuration failure hint, and exit.
@@ -636,16 +923,16 @@
 # Display the features supported by this script.
 func_features ()
 {
-    $ECHO "host: $host"
+    echo "host: $host"
     if test "$build_libtool_libs" = yes; then
-      $ECHO "enable shared libraries"
+      echo "enable shared libraries"
     else
-      $ECHO "disable shared libraries"
+      echo "disable shared libraries"
     fi
     if test "$build_old_libs" = yes; then
-      $ECHO "enable static libraries"
+      echo "enable static libraries"
     else
-      $ECHO "disable static libraries"
+      echo "disable static libraries"
     fi
 
     exit $?
@@ -692,117 +979,204 @@
   esac
 }
 
-# Parse options once, thoroughly.  This comes as soon as possible in
-# the script to make things like `libtool --version' happen quickly.
+# func_check_version_match
+# Ensure that we are using m4 macros, and libtool script from the same
+# release of libtool.
+func_check_version_match ()
 {
+  if test "$package_revision" != "$macro_revision"; then
+    if test "$VERSION" != "$macro_version"; then
+      if test -z "$macro_version"; then
+        cat >&2 <<_LT_EOF
+$progname: Version mismatch error.  This is $PACKAGE $VERSION, but the
+$progname: definition of this LT_INIT comes from an older release.
+$progname: You should recreate aclocal.m4 with macros from $PACKAGE $VERSION
+$progname: and run autoconf again.
+_LT_EOF
+      else
+        cat >&2 <<_LT_EOF
+$progname: Version mismatch error.  This is $PACKAGE $VERSION, but the
+$progname: definition of this LT_INIT comes from $PACKAGE $macro_version.
+$progname: You should recreate aclocal.m4 with macros from $PACKAGE $VERSION
+$progname: and run autoconf again.
+_LT_EOF
+      fi
+    else
+      cat >&2 <<_LT_EOF
+$progname: Version mismatch error.  This is $PACKAGE $VERSION, revision $package_revision,
+$progname: but the definition of this LT_INIT comes from revision $macro_revision.
+$progname: You should recreate aclocal.m4 with macros from revision $package_revision
+$progname: of $PACKAGE $VERSION and run autoconf again.
+_LT_EOF
+    fi
 
-  # Shorthand for --mode=foo, only valid as the first argument
-  case $1 in
-  clean|clea|cle|cl)
-    shift; set dummy --mode clean ${1+"$@"}; shift
-    ;;
-  compile|compil|compi|comp|com|co|c)
-    shift; set dummy --mode compile ${1+"$@"}; shift
-    ;;
-  execute|execut|execu|exec|exe|ex|e)
-    shift; set dummy --mode execute ${1+"$@"}; shift
-    ;;
-  finish|finis|fini|fin|fi|f)
-    shift; set dummy --mode finish ${1+"$@"}; shift
-    ;;
-  install|instal|insta|inst|ins|in|i)
-    shift; set dummy --mode install ${1+"$@"}; shift
-    ;;
-  link|lin|li|l)
-    shift; set dummy --mode link ${1+"$@"}; shift
-    ;;
-  uninstall|uninstal|uninsta|uninst|unins|unin|uni|un|u)
-    shift; set dummy --mode uninstall ${1+"$@"}; shift
-    ;;
-  esac
+    exit $EXIT_MISMATCH
+  fi
+}
 
-  # Parse non-mode specific arguments:
-  while test "$#" -gt 0; do
+
+# Shorthand for --mode=foo, only valid as the first argument
+case $1 in
+clean|clea|cle|cl)
+  shift; set dummy --mode clean ${1+"$@"}; shift
+  ;;
+compile|compil|compi|comp|com|co|c)
+  shift; set dummy --mode compile ${1+"$@"}; shift
+  ;;
+execute|execut|execu|exec|exe|ex|e)
+  shift; set dummy --mode execute ${1+"$@"}; shift
+  ;;
+finish|finis|fini|fin|fi|f)
+  shift; set dummy --mode finish ${1+"$@"}; shift
+  ;;
+install|instal|insta|inst|ins|in|i)
+  shift; set dummy --mode install ${1+"$@"}; shift
+  ;;
+link|lin|li|l)
+  shift; set dummy --mode link ${1+"$@"}; shift
+  ;;
+uninstall|uninstal|uninsta|uninst|unins|unin|uni|un|u)
+  shift; set dummy --mode uninstall ${1+"$@"}; shift
+  ;;
+esac
+
+
+
+# Option defaults:
+opt_debug=:
+opt_dry_run=false
+opt_config=false
+opt_preserve_dup_deps=false
+opt_features=false
+opt_finish=false
+opt_help=false
+opt_help_all=false
+opt_silent=:
+opt_verbose=:
+opt_silent=false
+opt_verbose=false
+
+
+# Parse options once, thoroughly.  This comes as soon as possible in the
+# script to make things like `--version' happen as quickly as we can.
+{
+  # this just eases exit handling
+  while test $# -gt 0; do
     opt="$1"
     shift
-
     case $opt in
-      --config)		func_config					;;
-
-      --debug)		preserve_args="$preserve_args $opt"
+      --debug|-x)	opt_debug='set -x'
 			func_echo "enabling shell trace mode"
-			opt_debug='set -x'
 			$opt_debug
 			;;
-
-      -dlopen)		test "$#" -eq 0 && func_missing_arg "$opt" && break
-			execute_dlfiles="$execute_dlfiles $1"
-			shift
+      --dry-run|--dryrun|-n)
+			opt_dry_run=:
 			;;
-
-      --dry-run | -n)	opt_dry_run=:					;;
-      --features)       func_features					;;
-      --finish)		mode="finish"					;;
-
-      --mode)		test "$#" -eq 0 && func_missing_arg "$opt" && break
-			case $1 in
-			  # Valid mode arguments:
-			  clean)	;;
-			  compile)	;;
-			  execute)	;;
-			  finish)	;;
-			  install)	;;
-			  link)		;;
-			  relink)	;;
-			  uninstall)	;;
-
-			  # Catch anything else as an error
-			  *) func_error "invalid argument for $opt"
-			     exit_cmd=exit
-			     break
-			     ;;
-		        esac
-
-			mode="$1"
+      --config)
+			opt_config=:
+func_config
+			;;
+      --dlopen|-dlopen)
+			optarg="$1"
+			opt_dlopen="${opt_dlopen+$opt_dlopen
+}$optarg"
 			shift
 			;;
-
       --preserve-dup-deps)
-			opt_duplicate_deps=:				;;
-
-      --quiet|--silent)	preserve_args="$preserve_args $opt"
-			opt_silent=:
+			opt_preserve_dup_deps=:
 			;;
-
-      --verbose| -v)	preserve_args="$preserve_args $opt"
+      --features)
+			opt_features=:
+func_features
+			;;
+      --finish)
+			opt_finish=:
+set dummy --mode finish ${1+"$@"}; shift
+			;;
+      --help)
+			opt_help=:
+			;;
+      --help-all)
+			opt_help_all=:
+opt_help=': help-all'
+			;;
+      --mode)
+			test $# = 0 && func_missing_arg $opt && break
+			optarg="$1"
+			opt_mode="$optarg"
+case $optarg in
+  # Valid mode arguments:
+  clean|compile|execute|finish|install|link|relink|uninstall) ;;
+
+  # Catch anything else as an error
+  *) func_error "invalid argument for $opt"
+     exit_cmd=exit
+     break
+     ;;
+esac
+			shift
+			;;
+      --no-silent|--no-quiet)
 			opt_silent=false
+func_append preserve_args " $opt"
 			;;
-
-      --tag)		test "$#" -eq 0 && func_missing_arg "$opt" && break
-			preserve_args="$preserve_args $opt $1"
-			func_enable_tag "$1"	# tagname is set here
+      --no-verbose)
+			opt_verbose=false
+func_append preserve_args " $opt"
+			;;
+      --silent|--quiet)
+			opt_silent=:
+func_append preserve_args " $opt"
+        opt_verbose=false
+			;;
+      --verbose|-v)
+			opt_verbose=:
+func_append preserve_args " $opt"
+opt_silent=false
+			;;
+      --tag)
+			test $# = 0 && func_missing_arg $opt && break
+			optarg="$1"
+			opt_tag="$optarg"
+func_append preserve_args " $opt $optarg"
+func_enable_tag "$optarg"
 			shift
 			;;
 
+      -\?|-h)		func_usage				;;
+      --help)		func_help				;;
+      --version)	func_version				;;
+
       # Separate optargs to long options:
-      -dlopen=*|--mode=*|--tag=*)
-			func_opt_split "$opt"
-			set dummy "$func_opt_split_opt" "$func_opt_split_arg" ${1+"$@"}
+      --*=*)
+			func_split_long_opt "$opt"
+			set dummy "$func_split_long_opt_name" "$func_split_long_opt_arg" ${1+"$@"}
 			shift
 			;;
 
-      -\?|-h)		func_usage					;;
-      --help)		opt_help=:					;;
-      --version)	func_version					;;
-
-      -*)		func_fatal_help "unrecognized option \`$opt'"	;;
-
-      *)		nonopt="$opt"
-			break
+      # Separate non-argument short options:
+      -\?*|-h*|-n*|-v*)
+			func_split_short_opt "$opt"
+			set dummy "$func_split_short_opt_name" "-$func_split_short_opt_arg" ${1+"$@"}
+			shift
 			;;
+
+      --)		break					;;
+      -*)		func_fatal_help "unrecognized option \`$opt'" ;;
+      *)		set dummy "$opt" ${1+"$@"};	shift; break  ;;
     esac
   done
 
+  # Validate options:
+
+  # save first non-option argument
+  if test "$#" -gt 0; then
+    nonopt="$opt"
+    shift
+  fi
+
+  # preserve --debug
+  test "$opt_debug" = : || func_append preserve_args " --debug"
 
   case $host in
     *cygwin* | *mingw* | *pw32* | *cegcc*)
@@ -810,82 +1184,44 @@
       opt_duplicate_compiler_generated_deps=:
       ;;
     *)
-      opt_duplicate_compiler_generated_deps=$opt_duplicate_deps
+      opt_duplicate_compiler_generated_deps=$opt_preserve_dup_deps
       ;;
   esac
 
-  # Having warned about all mis-specified options, bail out if
-  # anything was wrong.
-  $exit_cmd $EXIT_FAILURE
-}
+  $opt_help || {
+    # Sanity checks first:
+    func_check_version_match
 
-# func_check_version_match
-# Ensure that we are using m4 macros, and libtool script from the same
-# release of libtool.
-func_check_version_match ()
-{
-  if test "$package_revision" != "$macro_revision"; then
-    if test "$VERSION" != "$macro_version"; then
-      if test -z "$macro_version"; then
-        cat >&2 <<_LT_EOF
-$progname: Version mismatch error.  This is $PACKAGE $VERSION, but the
-$progname: definition of this LT_INIT comes from an older release.
-$progname: You should recreate aclocal.m4 with macros from $PACKAGE $VERSION
-$progname: and run autoconf again.
-_LT_EOF
-      else
-        cat >&2 <<_LT_EOF
-$progname: Version mismatch error.  This is $PACKAGE $VERSION, but the
-$progname: definition of this LT_INIT comes from $PACKAGE $macro_version.
-$progname: You should recreate aclocal.m4 with macros from $PACKAGE $VERSION
-$progname: and run autoconf again.
-_LT_EOF
-      fi
-    else
-      cat >&2 <<_LT_EOF
-$progname: Version mismatch error.  This is $PACKAGE $VERSION, revision $package_revision,
-$progname: but the definition of this LT_INIT comes from revision $macro_revision.
-$progname: You should recreate aclocal.m4 with macros from revision $package_revision
-$progname: of $PACKAGE $VERSION and run autoconf again.
-_LT_EOF
+    if test "$build_libtool_libs" != yes && test "$build_old_libs" != yes; then
+      func_fatal_configuration "not configured to build any kind of library"
     fi
 
-    exit $EXIT_MISMATCH
-  fi
-}
-
-
-## ----------- ##
-##    Main.    ##
-## ----------- ##
+    # Darwin sucks
+    eval std_shrext=\"$shrext_cmds\"
 
-$opt_help || {
-  # Sanity checks first:
-  func_check_version_match
+    # Only execute mode is allowed to have -dlopen flags.
+    if test -n "$opt_dlopen" && test "$opt_mode" != execute; then
+      func_error "unrecognized option \`-dlopen'"
+      $ECHO "$help" 1>&2
+      exit $EXIT_FAILURE
+    fi
 
-  if test "$build_libtool_libs" != yes && test "$build_old_libs" != yes; then
-    func_fatal_configuration "not configured to build any kind of library"
-  fi
+    # Change the help message to a mode-specific one.
+    generic_help="$help"
+    help="Try \`$progname --help --mode=$opt_mode' for more information."
+  }
 
-  test -z "$mode" && func_fatal_error "error: you must specify a MODE."
 
+  # Bail if the options were screwed
+  $exit_cmd $EXIT_FAILURE
+}
 
-  # Darwin sucks
-  eval std_shrext=\"$shrext_cmds\"
 
 
-  # Only execute mode is allowed to have -dlopen flags.
-  if test -n "$execute_dlfiles" && test "$mode" != execute; then
-    func_error "unrecognized option \`-dlopen'"
-    $ECHO "$help" 1>&2
-    exit $EXIT_FAILURE
-  fi
-
-  # Change the help message to a mode-specific one.
-  generic_help="$help"
-  help="Try \`$progname --help --mode=$mode' for more information."
-}
 
+## ----------- ##
+##    Main.    ##
+## ----------- ##
 
 # func_lalib_p file
 # True iff FILE is a libtool `.la' library or `.lo' object file.
@@ -950,12 +1286,9 @@
 # temporary ltwrapper_script.
 func_ltwrapper_scriptname ()
 {
-    func_ltwrapper_scriptname_result=""
-    if func_ltwrapper_executable_p "$1"; then
-	func_dirname_and_basename "$1" "" "."
-	func_stripname '' '.exe' "$func_basename_result"
-	func_ltwrapper_scriptname_result="$func_dirname_result/$objdir/${func_stripname_result}_ltshwrapper"
-    fi
+    func_dirname_and_basename "$1" "" "."
+    func_stripname '' '.exe' "$func_basename_result"
+    func_ltwrapper_scriptname_result="$func_dirname_result/$objdir/${func_stripname_result}_ltshwrapper"
 }
 
 # func_ltwrapper_p file
@@ -1001,6 +1334,37 @@
 }
 
 
+# func_resolve_sysroot PATH
+# Replace a leading = in PATH with a sysroot.  Store the result into
+# func_resolve_sysroot_result
+func_resolve_sysroot ()
+{
+  func_resolve_sysroot_result=$1
+  case $func_resolve_sysroot_result in
+  =*)
+    func_stripname '=' '' "$func_resolve_sysroot_result"
+    func_resolve_sysroot_result=$lt_sysroot$func_stripname_result
+    ;;
+  esac
+}
+
+# func_replace_sysroot PATH
+# If PATH begins with the sysroot, replace it with = and
+# store the result into func_replace_sysroot_result.
+func_replace_sysroot ()
+{
+  case "$lt_sysroot:$1" in
+  ?*:"$lt_sysroot"*)
+    func_stripname "$lt_sysroot" '' "$1"
+    func_replace_sysroot_result="=$func_stripname_result"
+    ;;
+  *)
+    # Including no sysroot.
+    func_replace_sysroot_result=$1
+    ;;
+  esac
+}
+
 # func_infer_tag arg
 # Infer tagged configuration to use if any are available and
 # if one wasn't chosen via the "--tag" command line option.
@@ -1013,13 +1377,15 @@
     if test -n "$available_tags" && test -z "$tagname"; then
       CC_quoted=
       for arg in $CC; do
-        func_quote_for_eval "$arg"
-	CC_quoted="$CC_quoted $func_quote_for_eval_result"
+	func_append_quoted CC_quoted "$arg"
       done
+      CC_expanded=`func_echo_all $CC`
+      CC_quoted_expanded=`func_echo_all $CC_quoted`
       case $@ in
       # Blanks in the command may have been stripped by the calling shell,
       # but not from the CC environment variable when configure was run.
-      " $CC "* | "$CC "* | " `$ECHO $CC` "* | "`$ECHO $CC` "* | " $CC_quoted"* | "$CC_quoted "* | " `$ECHO $CC_quoted` "* | "`$ECHO $CC_quoted` "*) ;;
+      " $CC "* | "$CC "* | " $CC_expanded "* | "$CC_expanded "* | \
+      " $CC_quoted"* | "$CC_quoted "* | " $CC_quoted_expanded "* | "$CC_quoted_expanded "*) ;;
       # Blanks at the start of $base_compile will cause this to fail
       # if we don't check for them as well.
       *)
@@ -1030,11 +1396,13 @@
 	    CC_quoted=
 	    for arg in $CC; do
 	      # Double-quote args containing other shell metacharacters.
-	      func_quote_for_eval "$arg"
-	      CC_quoted="$CC_quoted $func_quote_for_eval_result"
+	      func_append_quoted CC_quoted "$arg"
 	    done
+	    CC_expanded=`func_echo_all $CC`
+	    CC_quoted_expanded=`func_echo_all $CC_quoted`
 	    case "$@ " in
-	      " $CC "* | "$CC "* | " `$ECHO $CC` "* | "`$ECHO $CC` "* | " $CC_quoted"* | "$CC_quoted "* | " `$ECHO $CC_quoted` "* | "`$ECHO $CC_quoted` "*)
+	    " $CC "* | "$CC "* | " $CC_expanded "* | "$CC_expanded "* | \
+	    " $CC_quoted"* | "$CC_quoted "* | " $CC_quoted_expanded "* | "$CC_quoted_expanded "*)
 	      # The compiler in the base compile command matches
 	      # the one in the tagged configuration.
 	      # Assume this is the tagged configuration we want.
@@ -1097,6 +1465,486 @@
     }
 }
 
+
+##################################################
+# FILE NAME AND PATH CONVERSION HELPER FUNCTIONS #
+##################################################
+
+# func_convert_core_file_wine_to_w32 ARG
+# Helper function used by file name conversion functions when $build is *nix,
+# and $host is mingw, cygwin, or some other w32 environment. Relies on a
+# correctly configured wine environment available, with the winepath program
+# in $build's $PATH.
+#
+# ARG is the $build file name to be converted to w32 format.
+# Result is available in $func_convert_core_file_wine_to_w32_result, and will
+# be empty on error (or when ARG is empty)
+func_convert_core_file_wine_to_w32 ()
+{
+  $opt_debug
+  func_convert_core_file_wine_to_w32_result="$1"
+  if test -n "$1"; then
+    # Unfortunately, winepath does not exit with a non-zero error code, so we
+    # are forced to check the contents of stdout. On the other hand, if the
+    # command is not found, the shell will set an exit code of 127 and print
+    # *an error message* to stdout. So we must check for both error code of
+    # zero AND non-empty stdout, which explains the odd construction:
+    func_convert_core_file_wine_to_w32_tmp=`winepath -w "$1" 2>/dev/null`
+    if test "$?" -eq 0 && test -n "${func_convert_core_file_wine_to_w32_tmp}"; then
+      func_convert_core_file_wine_to_w32_result=`$ECHO "$func_convert_core_file_wine_to_w32_tmp" |
+        $SED -e "$lt_sed_naive_backslashify"`
+    else
+      func_convert_core_file_wine_to_w32_result=
+    fi
+  fi
+}
+# end: func_convert_core_file_wine_to_w32
+
+
+# func_convert_core_path_wine_to_w32 ARG
+# Helper function used by path conversion functions when $build is *nix, and
+# $host is mingw, cygwin, or some other w32 environment. Relies on a correctly
+# configured wine environment available, with the winepath program in $build's
+# $PATH. Assumes ARG has no leading or trailing path separator characters.
+#
+# ARG is path to be converted from $build format to win32.
+# Result is available in $func_convert_core_path_wine_to_w32_result.
+# Unconvertible file (directory) names in ARG are skipped; if no directory names
+# are convertible, then the result may be empty.
+func_convert_core_path_wine_to_w32 ()
+{
+  $opt_debug
+  # unfortunately, winepath doesn't convert paths, only file names
+  func_convert_core_path_wine_to_w32_result=""
+  if test -n "$1"; then
+    oldIFS=$IFS
+    IFS=:
+    for func_convert_core_path_wine_to_w32_f in $1; do
+      IFS=$oldIFS
+      func_convert_core_file_wine_to_w32 "$func_convert_core_path_wine_to_w32_f"
+      if test -n "$func_convert_core_file_wine_to_w32_result" ; then
+        if test -z "$func_convert_core_path_wine_to_w32_result"; then
+          func_convert_core_path_wine_to_w32_result="$func_convert_core_file_wine_to_w32_result"
+        else
+          func_append func_convert_core_path_wine_to_w32_result ";$func_convert_core_file_wine_to_w32_result"
+        fi
+      fi
+    done
+    IFS=$oldIFS
+  fi
+}
+# end: func_convert_core_path_wine_to_w32
+
+
+# func_cygpath ARGS...
+# Wrapper around calling the cygpath program via LT_CYGPATH. This is used when
+# when (1) $build is *nix and Cygwin is hosted via a wine environment; or (2)
+# $build is MSYS and $host is Cygwin, or (3) $build is Cygwin. In case (1) or
+# (2), returns the Cygwin file name or path in func_cygpath_result (input
+# file name or path is assumed to be in w32 format, as previously converted
+# from $build's *nix or MSYS format). In case (3), returns the w32 file name
+# or path in func_cygpath_result (input file name or path is assumed to be in
+# Cygwin format). Returns an empty string on error.
+#
+# ARGS are passed to cygpath, with the last one being the file name or path to
+# be converted.
+#
+# Specify the absolute *nix (or w32) name to cygpath in the LT_CYGPATH
+# environment variable; do not put it in $PATH.
+func_cygpath ()
+{
+  $opt_debug
+  if test -n "$LT_CYGPATH" && test -f "$LT_CYGPATH"; then
+    func_cygpath_result=`$LT_CYGPATH "$@" 2>/dev/null`
+    if test "$?" -ne 0; then
+      # on failure, ensure result is empty
+      func_cygpath_result=
+    fi
+  else
+    func_cygpath_result=
+    func_error "LT_CYGPATH is empty or specifies non-existent file: \`$LT_CYGPATH'"
+  fi
+}
+#end: func_cygpath
+
+
+# func_convert_core_msys_to_w32 ARG
+# Convert file name or path ARG from MSYS format to w32 format.  Return
+# result in func_convert_core_msys_to_w32_result.
+func_convert_core_msys_to_w32 ()
+{
+  $opt_debug
+  # awkward: cmd appends spaces to result
+  func_convert_core_msys_to_w32_result=`( cmd //c echo "$1" ) 2>/dev/null |
+    $SED -e 's/[ ]*$//' -e "$lt_sed_naive_backslashify"`
+}
+#end: func_convert_core_msys_to_w32
+
+
+# func_convert_file_check ARG1 ARG2
+# Verify that ARG1 (a file name in $build format) was converted to $host
+# format in ARG2. Otherwise, emit an error message, but continue (resetting
+# func_to_host_file_result to ARG1).
+func_convert_file_check ()
+{
+  $opt_debug
+  if test -z "$2" && test -n "$1" ; then
+    func_error "Could not determine host file name corresponding to"
+    func_error "  \`$1'"
+    func_error "Continuing, but uninstalled executables may not work."
+    # Fallback:
+    func_to_host_file_result="$1"
+  fi
+}
+# end func_convert_file_check
+
+
+# func_convert_path_check FROM_PATHSEP TO_PATHSEP FROM_PATH TO_PATH
+# Verify that FROM_PATH (a path in $build format) was converted to $host
+# format in TO_PATH. Otherwise, emit an error message, but continue, resetting
+# func_to_host_file_result to a simplistic fallback value (see below).
+func_convert_path_check ()
+{
+  $opt_debug
+  if test -z "$4" && test -n "$3"; then
+    func_error "Could not determine the host path corresponding to"
+    func_error "  \`$3'"
+    func_error "Continuing, but uninstalled executables may not work."
+    # Fallback.  This is a deliberately simplistic "conversion" and
+    # should not be "improved".  See libtool.info.
+    if test "x$1" != "x$2"; then
+      lt_replace_pathsep_chars="s|$1|$2|g"
+      func_to_host_path_result=`echo "$3" |
+        $SED -e "$lt_replace_pathsep_chars"`
+    else
+      func_to_host_path_result="$3"
+    fi
+  fi
+}
+# end func_convert_path_check
+
+
+# func_convert_path_front_back_pathsep FRONTPAT BACKPAT REPL ORIG
+# Modifies func_to_host_path_result by prepending REPL if ORIG matches FRONTPAT
+# and appending REPL if ORIG matches BACKPAT.
+func_convert_path_front_back_pathsep ()
+{
+  $opt_debug
+  case $4 in
+  $1 ) func_to_host_path_result="$3$func_to_host_path_result"
+    ;;
+  esac
+  case $4 in
+  $2 ) func_append func_to_host_path_result "$3"
+    ;;
+  esac
+}
+# end func_convert_path_front_back_pathsep
+
+
+##################################################
+# $build to $host FILE NAME CONVERSION FUNCTIONS #
+##################################################
+# invoked via `$to_host_file_cmd ARG'
+#
+# In each case, ARG is the path to be converted from $build to $host format.
+# Result will be available in $func_to_host_file_result.
+
+
+# func_to_host_file ARG
+# Converts the file name ARG from $build format to $host format. Return result
+# in func_to_host_file_result.
+func_to_host_file ()
+{
+  $opt_debug
+  $to_host_file_cmd "$1"
+}
+# end func_to_host_file
+
+
+# func_to_tool_file ARG LAZY
+# converts the file name ARG from $build format to toolchain format. Return
+# result in func_to_tool_file_result.  If the conversion in use is listed
+# in (the comma separated) LAZY, no conversion takes place.
+func_to_tool_file ()
+{
+  $opt_debug
+  case ,$2, in
+    *,"$to_tool_file_cmd",*)
+      func_to_tool_file_result=$1
+      ;;
+    *)
+      $to_tool_file_cmd "$1"
+      func_to_tool_file_result=$func_to_host_file_result
+      ;;
+  esac
+}
+# end func_to_tool_file
+
+
+# func_convert_file_noop ARG
+# Copy ARG to func_to_host_file_result.
+func_convert_file_noop ()
+{
+  func_to_host_file_result="$1"
+}
+# end func_convert_file_noop
+
+
+# func_convert_file_msys_to_w32 ARG
+# Convert file name ARG from (mingw) MSYS to (mingw) w32 format; automatic
+# conversion to w32 is not available inside the cwrapper.  Returns result in
+# func_to_host_file_result.
+func_convert_file_msys_to_w32 ()
+{
+  $opt_debug
+  func_to_host_file_result="$1"
+  if test -n "$1"; then
+    func_convert_core_msys_to_w32 "$1"
+    func_to_host_file_result="$func_convert_core_msys_to_w32_result"
+  fi
+  func_convert_file_check "$1" "$func_to_host_file_result"
+}
+# end func_convert_file_msys_to_w32
+
+
+# func_convert_file_cygwin_to_w32 ARG
+# Convert file name ARG from Cygwin to w32 format.  Returns result in
+# func_to_host_file_result.
+func_convert_file_cygwin_to_w32 ()
+{
+  $opt_debug
+  func_to_host_file_result="$1"
+  if test -n "$1"; then
+    # because $build is cygwin, we call "the" cygpath in $PATH; no need to use
+    # LT_CYGPATH in this case.
+    func_to_host_file_result=`cygpath -m "$1"`
+  fi
+  func_convert_file_check "$1" "$func_to_host_file_result"
+}
+# end func_convert_file_cygwin_to_w32
+
+
+# func_convert_file_nix_to_w32 ARG
+# Convert file name ARG from *nix to w32 format.  Requires a wine environment
+# and a working winepath. Returns result in func_to_host_file_result.
+func_convert_file_nix_to_w32 ()
+{
+  $opt_debug
+  func_to_host_file_result="$1"
+  if test -n "$1"; then
+    func_convert_core_file_wine_to_w32 "$1"
+    func_to_host_file_result="$func_convert_core_file_wine_to_w32_result"
+  fi
+  func_convert_file_check "$1" "$func_to_host_file_result"
+}
+# end func_convert_file_nix_to_w32
+
+
+# func_convert_file_msys_to_cygwin ARG
+# Convert file name ARG from MSYS to Cygwin format.  Requires LT_CYGPATH set.
+# Returns result in func_to_host_file_result.
+func_convert_file_msys_to_cygwin ()
+{
+  $opt_debug
+  func_to_host_file_result="$1"
+  if test -n "$1"; then
+    func_convert_core_msys_to_w32 "$1"
+    func_cygpath -u "$func_convert_core_msys_to_w32_result"
+    func_to_host_file_result="$func_cygpath_result"
+  fi
+  func_convert_file_check "$1" "$func_to_host_file_result"
+}
+# end func_convert_file_msys_to_cygwin
+
+
+# func_convert_file_nix_to_cygwin ARG
+# Convert file name ARG from *nix to Cygwin format.  Requires Cygwin installed
+# in a wine environment, working winepath, and LT_CYGPATH set.  Returns result
+# in func_to_host_file_result.
+func_convert_file_nix_to_cygwin ()
+{
+  $opt_debug
+  func_to_host_file_result="$1"
+  if test -n "$1"; then
+    # convert from *nix to w32, then use cygpath to convert from w32 to cygwin.
+    func_convert_core_file_wine_to_w32 "$1"
+    func_cygpath -u "$func_convert_core_file_wine_to_w32_result"
+    func_to_host_file_result="$func_cygpath_result"
+  fi
+  func_convert_file_check "$1" "$func_to_host_file_result"
+}
+# end func_convert_file_nix_to_cygwin
+
+
+#############################################
+# $build to $host PATH CONVERSION FUNCTIONS #
+#############################################
+# invoked via `$to_host_path_cmd ARG'
+#
+# In each case, ARG is the path to be converted from $build to $host format.
+# The result will be available in $func_to_host_path_result.
+#
+# Path separators are also converted from $build format to $host format.  If
+# ARG begins or ends with a path separator character, it is preserved (but
+# converted to $host format) on output.
+#
+# All path conversion functions are named using the following convention:
+#   file name conversion function    : func_convert_file_X_to_Y ()
+#   path conversion function         : func_convert_path_X_to_Y ()
+# where, for any given $build/$host combination the 'X_to_Y' value is the
+# same.  If conversion functions are added for new $build/$host combinations,
+# the two new functions must follow this pattern, or func_init_to_host_path_cmd
+# will break.
+
+
+# func_init_to_host_path_cmd
+# Ensures that function "pointer" variable $to_host_path_cmd is set to the
+# appropriate value, based on the value of $to_host_file_cmd.
+to_host_path_cmd=
+func_init_to_host_path_cmd ()
+{
+  $opt_debug
+  if test -z "$to_host_path_cmd"; then
+    func_stripname 'func_convert_file_' '' "$to_host_file_cmd"
+    to_host_path_cmd="func_convert_path_${func_stripname_result}"
+  fi
+}
+
+
+# func_to_host_path ARG
+# Converts the path ARG from $build format to $host format. Return result
+# in func_to_host_path_result.
+func_to_host_path ()
+{
+  $opt_debug
+  func_init_to_host_path_cmd
+  $to_host_path_cmd "$1"
+}
+# end func_to_host_path
+
+
+# func_convert_path_noop ARG
+# Copy ARG to func_to_host_path_result.
+func_convert_path_noop ()
+{
+  func_to_host_path_result="$1"
+}
+# end func_convert_path_noop
+
+
+# func_convert_path_msys_to_w32 ARG
+# Convert path ARG from (mingw) MSYS to (mingw) w32 format; automatic
+# conversion to w32 is not available inside the cwrapper.  Returns result in
+# func_to_host_path_result.
+func_convert_path_msys_to_w32 ()
+{
+  $opt_debug
+  func_to_host_path_result="$1"
+  if test -n "$1"; then
+    # Remove leading and trailing path separator characters from ARG.  MSYS
+    # behavior is inconsistent here; cygpath turns them into '.;' and ';.';
+    # and winepath ignores them completely.
+    func_stripname : : "$1"
+    func_to_host_path_tmp1=$func_stripname_result
+    func_convert_core_msys_to_w32 "$func_to_host_path_tmp1"
+    func_to_host_path_result="$func_convert_core_msys_to_w32_result"
+    func_convert_path_check : ";" \
+      "$func_to_host_path_tmp1" "$func_to_host_path_result"
+    func_convert_path_front_back_pathsep ":*" "*:" ";" "$1"
+  fi
+}
+# end func_convert_path_msys_to_w32
+
+
+# func_convert_path_cygwin_to_w32 ARG
+# Convert path ARG from Cygwin to w32 format.  Returns result in
+# func_to_host_file_result.
+func_convert_path_cygwin_to_w32 ()
+{
+  $opt_debug
+  func_to_host_path_result="$1"
+  if test -n "$1"; then
+    # See func_convert_path_msys_to_w32:
+    func_stripname : : "$1"
+    func_to_host_path_tmp1=$func_stripname_result
+    func_to_host_path_result=`cygpath -m -p "$func_to_host_path_tmp1"`
+    func_convert_path_check : ";" \
+      "$func_to_host_path_tmp1" "$func_to_host_path_result"
+    func_convert_path_front_back_pathsep ":*" "*:" ";" "$1"
+  fi
+}
+# end func_convert_path_cygwin_to_w32
+
+
+# func_convert_path_nix_to_w32 ARG
+# Convert path ARG from *nix to w32 format.  Requires a wine environment and
+# a working winepath.  Returns result in func_to_host_file_result.
+func_convert_path_nix_to_w32 ()
+{
+  $opt_debug
+  func_to_host_path_result="$1"
+  if test -n "$1"; then
+    # See func_convert_path_msys_to_w32:
+    func_stripname : : "$1"
+    func_to_host_path_tmp1=$func_stripname_result
+    func_convert_core_path_wine_to_w32 "$func_to_host_path_tmp1"
+    func_to_host_path_result="$func_convert_core_path_wine_to_w32_result"
+    func_convert_path_check : ";" \
+      "$func_to_host_path_tmp1" "$func_to_host_path_result"
+    func_convert_path_front_back_pathsep ":*" "*:" ";" "$1"
+  fi
+}
+# end func_convert_path_nix_to_w32
+
+
+# func_convert_path_msys_to_cygwin ARG
+# Convert path ARG from MSYS to Cygwin format.  Requires LT_CYGPATH set.
+# Returns result in func_to_host_file_result.
+func_convert_path_msys_to_cygwin ()
+{
+  $opt_debug
+  func_to_host_path_result="$1"
+  if test -n "$1"; then
+    # See func_convert_path_msys_to_w32:
+    func_stripname : : "$1"
+    func_to_host_path_tmp1=$func_stripname_result
+    func_convert_core_msys_to_w32 "$func_to_host_path_tmp1"
+    func_cygpath -u -p "$func_convert_core_msys_to_w32_result"
+    func_to_host_path_result="$func_cygpath_result"
+    func_convert_path_check : : \
+      "$func_to_host_path_tmp1" "$func_to_host_path_result"
+    func_convert_path_front_back_pathsep ":*" "*:" : "$1"
+  fi
+}
+# end func_convert_path_msys_to_cygwin
+
+
+# func_convert_path_nix_to_cygwin ARG
+# Convert path ARG from *nix to Cygwin format.  Requires Cygwin installed in a
+# a wine environment, working winepath, and LT_CYGPATH set.  Returns result in
+# func_to_host_file_result.
+func_convert_path_nix_to_cygwin ()
+{
+  $opt_debug
+  func_to_host_path_result="$1"
+  if test -n "$1"; then
+    # Remove leading and trailing path separator characters from
+    # ARG. msys behavior is inconsistent here, cygpath turns them
+    # into '.;' and ';.', and winepath ignores them completely.
+    func_stripname : : "$1"
+    func_to_host_path_tmp1=$func_stripname_result
+    func_convert_core_path_wine_to_w32 "$func_to_host_path_tmp1"
+    func_cygpath -u -p "$func_convert_core_path_wine_to_w32_result"
+    func_to_host_path_result="$func_cygpath_result"
+    func_convert_path_check : : \
+      "$func_to_host_path_tmp1" "$func_to_host_path_result"
+    func_convert_path_front_back_pathsep ":*" "*:" : "$1"
+  fi
+}
+# end func_convert_path_nix_to_cygwin
+
+
 # func_mode_compile arg...
 func_mode_compile ()
 {
@@ -1137,12 +1985,12 @@
 	  ;;
 
 	-pie | -fpie | -fPIE)
-          pie_flag="$pie_flag $arg"
+          func_append pie_flag " $arg"
 	  continue
 	  ;;
 
 	-shared | -static | -prefer-pic | -prefer-non-pic)
-	  later="$later $arg"
+	  func_append later " $arg"
 	  continue
 	  ;;
 
@@ -1163,15 +2011,14 @@
 	  save_ifs="$IFS"; IFS=','
 	  for arg in $args; do
 	    IFS="$save_ifs"
-	    func_quote_for_eval "$arg"
-	    lastarg="$lastarg $func_quote_for_eval_result"
+	    func_append_quoted lastarg "$arg"
 	  done
 	  IFS="$save_ifs"
 	  func_stripname ' ' '' "$lastarg"
 	  lastarg=$func_stripname_result
 
 	  # Add the arguments to base_compile.
-	  base_compile="$base_compile $lastarg"
+	  func_append base_compile " $lastarg"
 	  continue
 	  ;;
 
@@ -1187,8 +2034,7 @@
       esac    #  case $arg_mode
 
       # Aesthetically quote the previous argument.
-      func_quote_for_eval "$lastarg"
-      base_compile="$base_compile $func_quote_for_eval_result"
+      func_append_quoted base_compile "$lastarg"
     done # for arg
 
     case $arg_mode in
@@ -1213,7 +2059,7 @@
     *.[cCFSifmso] | \
     *.ada | *.adb | *.ads | *.asm | \
     *.c++ | *.cc | *.ii | *.class | *.cpp | *.cxx | \
-    *.[fF][09]? | *.for | *.java | *.obj | *.sx)
+    *.[fF][09]? | *.for | *.java | *.obj | *.sx | *.cu | *.cup)
       func_xform "$libobj"
       libobj=$func_xform_result
       ;;
@@ -1288,7 +2134,7 @@
     # Calculate the filename of the output object if compiler does
     # not support -o with -c
     if test "$compiler_c_o" = no; then
-      output_obj=`$ECHO "X$srcfile" | $Xsed -e 's%^.*/%%' -e 's%\.[^.]*$%%'`.${objext}
+      output_obj=`$ECHO "$srcfile" | $SED 's%^.*/%%; s%\.[^.]*$%%'`.${objext}
       lockfile="$output_obj.lock"
     else
       output_obj=
@@ -1319,17 +2165,16 @@
 	$opt_dry_run || $RM $removelist
 	exit $EXIT_FAILURE
       fi
-      removelist="$removelist $output_obj"
+      func_append removelist " $output_obj"
       $ECHO "$srcfile" > "$lockfile"
     fi
 
     $opt_dry_run || $RM $removelist
-    removelist="$removelist $lockfile"
+    func_append removelist " $lockfile"
     trap '$opt_dry_run || $RM $removelist; exit $EXIT_FAILURE' 1 2 15
 
-    if test -n "$fix_srcfile_path"; then
-      eval srcfile=\"$fix_srcfile_path\"
-    fi
+    func_to_tool_file "$srcfile" func_convert_file_msys_to_w32
+    srcfile=$func_to_tool_file_result
     func_quote_for_eval "$srcfile"
     qsrcfile=$func_quote_for_eval_result
 
@@ -1349,7 +2194,7 @@
 
       if test -z "$output_obj"; then
 	# Place PIC objects in $objdir
-	command="$command -o $lobj"
+	func_append command " -o $lobj"
       fi
 
       func_show_eval_locale "$command"	\
@@ -1396,11 +2241,11 @@
 	command="$base_compile $qsrcfile $pic_flag"
       fi
       if test "$compiler_c_o" = yes; then
-	command="$command -o $obj"
+	func_append command " -o $obj"
       fi
 
       # Suppress compiler output if we already did a PIC compilation.
-      command="$command$suppress_output"
+      func_append command "$suppress_output"
       func_show_eval_locale "$command" \
         '$opt_dry_run || $RM $removelist; exit $EXIT_FAILURE'
 
@@ -1445,13 +2290,13 @@
 }
 
 $opt_help || {
-test "$mode" = compile && func_mode_compile ${1+"$@"}
+  test "$opt_mode" = compile && func_mode_compile ${1+"$@"}
 }
 
 func_mode_help ()
 {
     # We need to display help for each of the modes.
-    case $mode in
+    case $opt_mode in
       "")
         # Generic help is extracted from the usage comments
         # at the start of this file.
@@ -1482,10 +2327,11 @@
 
   -o OUTPUT-FILE    set the output file name to OUTPUT-FILE
   -no-suppress      do not suppress compiler output for multiple passes
-  -prefer-pic       try to building PIC objects only
-  -prefer-non-pic   try to building non-PIC objects only
+  -prefer-pic       try to build PIC objects only
+  -prefer-non-pic   try to build non-PIC objects only
   -shared           do not build a \`.o' file suitable for static linking
   -static           only build a \`.o' file suitable for static linking
+  -Wc,FLAG          pass FLAG directly to the compiler
 
 COMPILE-COMMAND is a command to be used in creating a \`standard' object file
 from the given SOURCEFILE.
@@ -1538,7 +2384,7 @@
 
 The following components of INSTALL-COMMAND are treated specially:
 
-  -inst-prefix PREFIX-DIR  Use PREFIX-DIR as a staging area for installation
+  -inst-prefix-dir PREFIX-DIR  Use PREFIX-DIR as a staging area for installation
 
 The rest of the components are interpreted as arguments to that command (only
 BSD-compatible install options are recognized)."
@@ -1558,6 +2404,8 @@
 
   -all-static       do not do any dynamic linking at all
   -avoid-version    do not add a version suffix if possible
+  -bindir BINDIR    specify path to binaries directory (for systems where
+                    libraries must be found in the PATH setting at runtime)
   -dlopen FILE      \`-dlpreopen' FILE if it cannot be dlopened at runtime
   -dlpreopen FILE   link in FILE and add its symbols to lt_preloaded_symbols
   -export-dynamic   allow symbols from OUTPUT-FILE to be resolved with dlsym(3)
@@ -1586,6 +2434,11 @@
   -version-info CURRENT[:REVISION[:AGE]]
                     specify library version info [each variable defaults to 0]
   -weak LIBNAME     declare that the target provides the LIBNAME interface
+  -Wc,FLAG
+  -Xcompiler FLAG   pass linker-specific FLAG directly to the compiler
+  -Wl,FLAG
+  -Xlinker FLAG     pass linker-specific FLAG directly to the linker
+  -XCClinker FLAG   pass link-specific FLAG to the compiler driver (CC)
 
 All other options (arguments beginning with \`-') are ignored.
 
@@ -1619,18 +2472,44 @@
         ;;
 
       *)
-        func_fatal_help "invalid operation mode \`$mode'"
+        func_fatal_help "invalid operation mode \`$opt_mode'"
         ;;
     esac
 
-    $ECHO
+    echo
     $ECHO "Try \`$progname --help' for more information about other modes."
-
-    exit $?
 }
 
-  # Now that we've collected a possible --mode arg, show help if necessary
-  $opt_help && func_mode_help
+# Now that we've collected a possible --mode arg, show help if necessary
+if $opt_help; then
+  if test "$opt_help" = :; then
+    func_mode_help
+  else
+    {
+      func_help noexit
+      for opt_mode in compile link execute install finish uninstall clean; do
+	func_mode_help
+      done
+    } | sed -n '1p; 2,$s/^Usage:/  or: /p'
+    {
+      func_help noexit
+      for opt_mode in compile link execute install finish uninstall clean; do
+	echo
+	func_mode_help
+      done
+    } |
+    sed '1d
+      /^When reporting/,/^Report/{
+	H
+	d
+      }
+      $x
+      /information about other modes/d
+      /more detailed .*MODE/d
+      s/^Usage:.*--mode=\([^ ]*\) .*/Description of \1 mode:/'
+  fi
+  exit $?
+fi
 
 
 # func_mode_execute arg...
@@ -1643,13 +2522,16 @@
       func_fatal_help "you must specify a COMMAND"
 
     # Handle -dlopen flags immediately.
-    for file in $execute_dlfiles; do
+    for file in $opt_dlopen; do
       test -f "$file" \
 	|| func_fatal_help "\`$file' is not a file"
 
       dir=
       case $file in
       *.la)
+	func_resolve_sysroot "$file"
+	file=$func_resolve_sysroot_result
+
 	# Check to see that this really is a libtool archive.
 	func_lalib_unsafe_p "$file" \
 	  || func_fatal_help "\`$lib' is not a valid libtool archive"
@@ -1671,7 +2553,7 @@
 	dir="$func_dirname_result"
 
 	if test -f "$dir/$objdir/$dlname"; then
-	  dir="$dir/$objdir"
+	  func_append dir "/$objdir"
 	else
 	  if test ! -f "$dir/$dlname"; then
 	    func_fatal_error "cannot find \`$dlname' in \`$dir' or \`$dir/$objdir'"
@@ -1712,7 +2594,7 @@
     for file
     do
       case $file in
-      -*) ;;
+      -* | *.la | *.lo ) ;;
       *)
 	# Do a test to see if this is really a libtool program.
 	if func_ltwrapper_script_p "$file"; then
@@ -1728,8 +2610,7 @@
 	;;
       esac
       # Quote arguments (to preserve shell metacharacters).
-      func_quote_for_eval "$file"
-      args="$args $func_quote_for_eval_result"
+      func_append_quoted args "$file"
     done
 
     if test "X$opt_dry_run" = Xfalse; then
@@ -1754,29 +2635,66 @@
       # Display what would be done.
       if test -n "$shlibpath_var"; then
 	eval "\$ECHO \"\$shlibpath_var=\$$shlibpath_var\""
-	$ECHO "export $shlibpath_var"
+	echo "export $shlibpath_var"
       fi
       $ECHO "$cmd$args"
       exit $EXIT_SUCCESS
     fi
 }
 
-test "$mode" = execute && func_mode_execute ${1+"$@"}
+test "$opt_mode" = execute && func_mode_execute ${1+"$@"}
 
 
 # func_mode_finish arg...
 func_mode_finish ()
 {
     $opt_debug
-    libdirs="$nonopt"
+    libs=
+    libdirs=
     admincmds=
 
-    if test -n "$finish_cmds$finish_eval" && test -n "$libdirs"; then
-      for dir
-      do
-	libdirs="$libdirs $dir"
-      done
+    for opt in "$nonopt" ${1+"$@"}
+    do
+      if test -d "$opt"; then
+	func_append libdirs " $opt"
+
+      elif test -f "$opt"; then
+	if func_lalib_unsafe_p "$opt"; then
+	  func_append libs " $opt"
+	else
+	  func_warning "\`$opt' is not a valid libtool archive"
+	fi
 
+      else
+	func_fatal_error "invalid argument \`$opt'"
+      fi
+    done
+
+    if test -n "$libs"; then
+      if test -n "$lt_sysroot"; then
+        sysroot_regex=`$ECHO "$lt_sysroot" | $SED "$sed_make_literal_regex"`
+        sysroot_cmd="s/\([ ']\)$sysroot_regex/\1/g;"
+      else
+        sysroot_cmd=
+      fi
+
+      # Remove sysroot references
+      if $opt_dry_run; then
+        for lib in $libs; do
+          echo "removing references to $lt_sysroot and \`=' prefixes from $lib"
+        done
+      else
+        tmpdir=`func_mktempdir`
+        for lib in $libs; do
+	  sed -e "${sysroot_cmd} s/\([ ']-[LR]\)=/\1/g; s/\([ ']\)=/\1/g" $lib \
+	    > $tmpdir/tmp-la
+	  mv -f $tmpdir/tmp-la $lib
+	done
+        ${RM}r "$tmpdir"
+      fi
+    fi
+
+    if test -n "$finish_cmds$finish_eval" && test -n "$libdirs"; then
       for libdir in $libdirs; do
 	if test -n "$finish_cmds"; then
 	  # Do each command in the finish commands.
@@ -1786,7 +2704,7 @@
 	if test -n "$finish_eval"; then
 	  # Do the single finish_eval.
 	  eval cmds=\"$finish_eval\"
-	  $opt_dry_run || eval "$cmds" || admincmds="$admincmds
+	  $opt_dry_run || eval "$cmds" || func_append admincmds "
        $cmds"
 	fi
       done
@@ -1795,53 +2713,55 @@
     # Exit here if they wanted silent mode.
     $opt_silent && exit $EXIT_SUCCESS
 
-    $ECHO "X----------------------------------------------------------------------" | $Xsed
-    $ECHO "Libraries have been installed in:"
-    for libdir in $libdirs; do
-      $ECHO "   $libdir"
-    done
-    $ECHO
-    $ECHO "If you ever happen to want to link against installed libraries"
-    $ECHO "in a given directory, LIBDIR, you must either use libtool, and"
-    $ECHO "specify the full pathname of the library, or use the \`-LLIBDIR'"
-    $ECHO "flag during linking and do at least one of the following:"
-    if test -n "$shlibpath_var"; then
-      $ECHO "   - add LIBDIR to the \`$shlibpath_var' environment variable"
-      $ECHO "     during execution"
-    fi
-    if test -n "$runpath_var"; then
-      $ECHO "   - add LIBDIR to the \`$runpath_var' environment variable"
-      $ECHO "     during linking"
-    fi
-    if test -n "$hardcode_libdir_flag_spec"; then
-      libdir=LIBDIR
-      eval flag=\"$hardcode_libdir_flag_spec\"
+    if test -n "$finish_cmds$finish_eval" && test -n "$libdirs"; then
+      echo "----------------------------------------------------------------------"
+      echo "Libraries have been installed in:"
+      for libdir in $libdirs; do
+	$ECHO "   $libdir"
+      done
+      echo
+      echo "If you ever happen to want to link against installed libraries"
+      echo "in a given directory, LIBDIR, you must either use libtool, and"
+      echo "specify the full pathname of the library, or use the \`-LLIBDIR'"
+      echo "flag during linking and do at least one of the following:"
+      if test -n "$shlibpath_var"; then
+	echo "   - add LIBDIR to the \`$shlibpath_var' environment variable"
+	echo "     during execution"
+      fi
+      if test -n "$runpath_var"; then
+	echo "   - add LIBDIR to the \`$runpath_var' environment variable"
+	echo "     during linking"
+      fi
+      if test -n "$hardcode_libdir_flag_spec"; then
+	libdir=LIBDIR
+	eval flag=\"$hardcode_libdir_flag_spec\"
+
+	$ECHO "   - use the \`$flag' linker flag"
+      fi
+      if test -n "$admincmds"; then
+	$ECHO "   - have your system administrator run these commands:$admincmds"
+      fi
+      if test -f /etc/ld.so.conf; then
+	echo "   - have your system administrator add LIBDIR to \`/etc/ld.so.conf'"
+      fi
+      echo
 
-      $ECHO "   - use the \`$flag' linker flag"
-    fi
-    if test -n "$admincmds"; then
-      $ECHO "   - have your system administrator run these commands:$admincmds"
-    fi
-    if test -f /etc/ld.so.conf; then
-      $ECHO "   - have your system administrator add LIBDIR to \`/etc/ld.so.conf'"
+      echo "See any operating system documentation about shared libraries for"
+      case $host in
+	solaris2.[6789]|solaris2.1[0-9])
+	  echo "more information, such as the ld(1), crle(1) and ld.so(8) manual"
+	  echo "pages."
+	  ;;
+	*)
+	  echo "more information, such as the ld(1) and ld.so(8) manual pages."
+	  ;;
+      esac
+      echo "----------------------------------------------------------------------"
     fi
-    $ECHO
-
-    $ECHO "See any operating system documentation about shared libraries for"
-    case $host in
-      solaris2.[6789]|solaris2.1[0-9])
-        $ECHO "more information, such as the ld(1), crle(1) and ld.so(8) manual"
-	$ECHO "pages."
-	;;
-      *)
-        $ECHO "more information, such as the ld(1) and ld.so(8) manual pages."
-        ;;
-    esac
-    $ECHO "X----------------------------------------------------------------------" | $Xsed
     exit $EXIT_SUCCESS
 }
 
-test "$mode" = finish && func_mode_finish ${1+"$@"}
+test "$opt_mode" = finish && func_mode_finish ${1+"$@"}
 
 
 # func_mode_install arg...
@@ -1852,7 +2772,7 @@
     # install_prog (especially on Windows NT).
     if test "$nonopt" = "$SHELL" || test "$nonopt" = /bin/sh ||
        # Allow the use of GNU shtool's install command.
-       $ECHO "X$nonopt" | $GREP shtool >/dev/null; then
+       case $nonopt in *shtool*) :;; *) false;; esac; then
       # Aesthetically quote it.
       func_quote_for_eval "$nonopt"
       install_prog="$func_quote_for_eval_result "
@@ -1866,7 +2786,12 @@
     # The real first argument should be the name of the installation program.
     # Aesthetically quote it.
     func_quote_for_eval "$arg"
-    install_prog="$install_prog$func_quote_for_eval_result"
+    func_append install_prog "$func_quote_for_eval_result"
+    install_shared_prog=$install_prog
+    case " $install_prog " in
+      *[\\\ /]cp\ *) install_cp=: ;;
+      *) install_cp=false ;;
+    esac
 
     # We need to accept at least all the BSD install flags.
     dest=
@@ -1876,10 +2801,12 @@
     install_type=
     isdir=no
     stripme=
+    no_mode=:
     for arg
     do
+      arg2=
       if test -n "$dest"; then
-	files="$files $dest"
+	func_append files " $dest"
 	dest=$arg
 	continue
       fi
@@ -1887,10 +2814,9 @@
       case $arg in
       -d) isdir=yes ;;
       -f)
-	case " $install_prog " in
-	*[\\\ /]cp\ *) ;;
-	*) prev=$arg ;;
-	esac
+	if $install_cp; then :; else
+	  prev=$arg
+	fi
 	;;
       -g | -m | -o)
 	prev=$arg
@@ -1904,6 +2830,10 @@
       *)
 	# If the previous option needed an argument, then skip it.
 	if test -n "$prev"; then
+	  if test "x$prev" = x-m && test -n "$install_override_mode"; then
+	    arg2=$install_override_mode
+	    no_mode=false
+	  fi
 	  prev=
 	else
 	  dest=$arg
@@ -1914,7 +2844,11 @@
 
       # Aesthetically quote the argument.
       func_quote_for_eval "$arg"
-      install_prog="$install_prog $func_quote_for_eval_result"
+      func_append install_prog " $func_quote_for_eval_result"
+      if test -n "$arg2"; then
+	func_quote_for_eval "$arg2"
+      fi
+      func_append install_shared_prog " $func_quote_for_eval_result"
     done
 
     test -z "$install_prog" && \
@@ -1923,6 +2857,13 @@
     test -n "$prev" && \
       func_fatal_help "the \`$prev' option requires an argument"
 
+    if test -n "$install_override_mode" && $no_mode; then
+      if $install_cp; then :; else
+	func_quote_for_eval "$install_override_mode"
+	func_append install_shared_prog " -m $func_quote_for_eval_result"
+      fi
+    fi
+
     if test -z "$files"; then
       if test -z "$dest"; then
 	func_fatal_help "no file or destination specified"
@@ -1977,10 +2918,13 @@
       case $file in
       *.$libext)
 	# Do the static libraries later.
-	staticlibs="$staticlibs $file"
+	func_append staticlibs " $file"
 	;;
 
       *.la)
+	func_resolve_sysroot "$file"
+	file=$func_resolve_sysroot_result
+
 	# Check to see that this really is a libtool archive.
 	func_lalib_unsafe_p "$file" \
 	  || func_fatal_help "\`$file' is not a valid libtool archive"
@@ -1994,23 +2938,23 @@
 	if test "X$destdir" = "X$libdir"; then
 	  case "$current_libdirs " in
 	  *" $libdir "*) ;;
-	  *) current_libdirs="$current_libdirs $libdir" ;;
+	  *) func_append current_libdirs " $libdir" ;;
 	  esac
 	else
 	  # Note the libdir as a future libdir.
 	  case "$future_libdirs " in
 	  *" $libdir "*) ;;
-	  *) future_libdirs="$future_libdirs $libdir" ;;
+	  *) func_append future_libdirs " $libdir" ;;
 	  esac
 	fi
 
 	func_dirname "$file" "/" ""
 	dir="$func_dirname_result"
-	dir="$dir$objdir"
+	func_append dir "$objdir"
 
 	if test -n "$relink_command"; then
 	  # Determine the prefix the user has applied to our future dir.
-	  inst_prefix_dir=`$ECHO "X$destdir" | $Xsed -e "s%$libdir\$%%"`
+	  inst_prefix_dir=`$ECHO "$destdir" | $SED -e "s%$libdir\$%%"`
 
 	  # Don't allow the user to place us outside of our expected
 	  # location b/c this prevents finding dependent libraries that
@@ -2023,9 +2967,9 @@
 
 	  if test -n "$inst_prefix_dir"; then
 	    # Stick the inst_prefix_dir data into the link command.
-	    relink_command=`$ECHO "X$relink_command" | $Xsed -e "s%@inst_prefix_dir@%-inst-prefix-dir $inst_prefix_dir%"`
+	    relink_command=`$ECHO "$relink_command" | $SED "s%@inst_prefix_dir@%-inst-prefix-dir $inst_prefix_dir%"`
 	  else
-	    relink_command=`$ECHO "X$relink_command" | $Xsed -e "s%@inst_prefix_dir@%%"`
+	    relink_command=`$ECHO "$relink_command" | $SED "s%@inst_prefix_dir@%%"`
 	  fi
 
 	  func_warning "relinking \`$file'"
@@ -2043,7 +2987,7 @@
 	  test -n "$relink_command" && srcname="$realname"T
 
 	  # Install the shared library and build the symlinks.
-	  func_show_eval "$install_prog $dir/$srcname $destdir/$realname" \
+	  func_show_eval "$install_shared_prog $dir/$srcname $destdir/$realname" \
 	      'exit $?'
 	  tstripme="$stripme"
 	  case $host_os in
@@ -2083,7 +3027,7 @@
 	func_show_eval "$install_prog $instname $destdir/$name" 'exit $?'
 
 	# Maybe install the static library, too.
-	test -n "$old_library" && staticlibs="$staticlibs $dir/$old_library"
+	test -n "$old_library" && func_append staticlibs " $dir/$old_library"
 	;;
 
       *.lo)
@@ -2183,7 +3127,7 @@
 	    if test -f "$lib"; then
 	      func_source "$lib"
 	    fi
-	    libfile="$libdir/"`$ECHO "X$lib" | $Xsed -e 's%^.*/%%g'` ### testsuite: skip nested quoting test
+	    libfile="$libdir/"`$ECHO "$lib" | $SED 's%^.*/%%g'` ### testsuite: skip nested quoting test
 	    if test -n "$libdir" && test ! -f "$libfile"; then
 	      func_warning "\`$lib' has not been installed in \`$libdir'"
 	      finalize=no
@@ -2202,7 +3146,7 @@
 		file="$func_basename_result"
 	        outputname="$tmpdir/$file"
 	        # Replace the output file specification.
-	        relink_command=`$ECHO "X$relink_command" | $Xsed -e 's%@OUTPUT@%'"$outputname"'%g'`
+	        relink_command=`$ECHO "$relink_command" | $SED 's%@OUTPUT@%'"$outputname"'%g'`
 
 	        $opt_silent || {
 	          func_quote_for_expand "$relink_command"
@@ -2221,7 +3165,7 @@
 	    }
 	  else
 	    # Install the binary that we compiled earlier.
-	    file=`$ECHO "X$file$stripped_ext" | $Xsed -e "s%\([^/]*\)$%$objdir/\1%"`
+	    file=`$ECHO "$file$stripped_ext" | $SED "s%\([^/]*\)$%$objdir/\1%"`
 	  fi
 	fi
 
@@ -2280,7 +3224,7 @@
     fi
 }
 
-test "$mode" = install && func_mode_install ${1+"$@"}
+test "$opt_mode" = install && func_mode_install ${1+"$@"}
 
 
 # func_generate_dlsyms outputname originator pic_p
@@ -2323,6 +3267,22 @@
 extern \"C\" {
 #endif
 
+#if defined(__GNUC__) && (((__GNUC__ == 4) && (__GNUC_MINOR__ >= 4)) || (__GNUC__ > 4))
+#pragma GCC diagnostic ignored \"-Wstrict-prototypes\"
+#endif
+
+/* Keep this code in sync between libtool.m4, ltmain, lt_system.h, and tests.  */
+#if defined(_WIN32) || defined(__CYGWIN__) || defined(_WIN32_WCE)
+/* DATA imports from DLLs on WIN32 con't be const, because runtime
+   relocations are performed -- see ld's documentation on pseudo-relocs.  */
+# define LT_DLSYM_CONST
+#elif defined(__osf__)
+/* This system does not cope well with relocations in const data.  */
+# define LT_DLSYM_CONST
+#else
+# define LT_DLSYM_CONST const
+#endif
+
 /* External symbol declarations for the compiler. */\
 "
 
@@ -2332,10 +3292,11 @@
 	  $opt_dry_run || echo ': @PROGRAM@ ' > "$nlist"
 
 	  # Add our own program objects to the symbol list.
-	  progfiles=`$ECHO "X$objs$old_deplibs" | $SP2NL | $Xsed -e "$lo2o" | $NL2SP`
+	  progfiles=`$ECHO "$objs$old_deplibs" | $SP2NL | $SED "$lo2o" | $NL2SP`
 	  for progfile in $progfiles; do
-	    func_verbose "extracting global C symbols from \`$progfile'"
-	    $opt_dry_run || eval "$NM $progfile | $global_symbol_pipe >> '$nlist'"
+	    func_to_tool_file "$progfile" func_convert_file_msys_to_w32
+	    func_verbose "extracting global C symbols from \`$func_to_tool_file_result'"
+	    $opt_dry_run || eval "$NM $func_to_tool_file_result | $global_symbol_pipe >> '$nlist'"
 	  done
 
 	  if test -n "$exclude_expsyms"; then
@@ -2371,7 +3332,7 @@
 	      eval '$GREP -f "$output_objdir/$outputname.exp" < "$nlist" > "$nlist"T'
 	      eval '$MV "$nlist"T "$nlist"'
 	      case $host in
-	        *cygwin | *mingw* | *cegcc* )
+	        *cygwin* | *mingw* | *cegcc* )
 	          eval "echo EXPORTS "'> "$output_objdir/$outputname.def"'
 	          eval 'cat "$nlist" >> "$output_objdir/$outputname.def"'
 	          ;;
@@ -2384,10 +3345,52 @@
 	  func_verbose "extracting global C symbols from \`$dlprefile'"
 	  func_basename "$dlprefile"
 	  name="$func_basename_result"
-	  $opt_dry_run || {
-	    eval '$ECHO ": $name " >> "$nlist"'
-	    eval "$NM $dlprefile 2>/dev/null | $global_symbol_pipe >> '$nlist'"
-	  }
+          case $host in
+	    *cygwin* | *mingw* | *cegcc* )
+	      # if an import library, we need to obtain dlname
+	      if func_win32_import_lib_p "$dlprefile"; then
+	        func_tr_sh "$dlprefile"
+	        eval "curr_lafile=\$libfile_$func_tr_sh_result"
+	        dlprefile_dlbasename=""
+	        if test -n "$curr_lafile" && func_lalib_p "$curr_lafile"; then
+	          # Use subshell, to avoid clobbering current variable values
+	          dlprefile_dlname=`source "$curr_lafile" && echo "$dlname"`
+	          if test -n "$dlprefile_dlname" ; then
+	            func_basename "$dlprefile_dlname"
+	            dlprefile_dlbasename="$func_basename_result"
+	          else
+	            # no lafile. user explicitly requested -dlpreopen <import library>.
+	            $sharedlib_from_linklib_cmd "$dlprefile"
+	            dlprefile_dlbasename=$sharedlib_from_linklib_result
+	          fi
+	        fi
+	        $opt_dry_run || {
+	          if test -n "$dlprefile_dlbasename" ; then
+	            eval '$ECHO ": $dlprefile_dlbasename" >> "$nlist"'
+	          else
+	            func_warning "Could not compute DLL name from $name"
+	            eval '$ECHO ": $name " >> "$nlist"'
+	          fi
+	          func_to_tool_file "$dlprefile" func_convert_file_msys_to_w32
+	          eval "$NM \"$func_to_tool_file_result\" 2>/dev/null | $global_symbol_pipe |
+	            $SED -e '/I __imp/d' -e 's/I __nm_/D /;s/_nm__//' >> '$nlist'"
+	        }
+	      else # not an import lib
+	        $opt_dry_run || {
+	          eval '$ECHO ": $name " >> "$nlist"'
+	          func_to_tool_file "$dlprefile" func_convert_file_msys_to_w32
+	          eval "$NM \"$func_to_tool_file_result\" 2>/dev/null | $global_symbol_pipe >> '$nlist'"
+	        }
+	      fi
+	    ;;
+	    *)
+	      $opt_dry_run || {
+	        eval '$ECHO ": $name " >> "$nlist"'
+	        func_to_tool_file "$dlprefile" func_convert_file_msys_to_w32
+	        eval "$NM \"$func_to_tool_file_result\" 2>/dev/null | $global_symbol_pipe >> '$nlist'"
+	      }
+	    ;;
+          esac
 	done
 
 	$opt_dry_run || {
@@ -2415,36 +3418,19 @@
 	  if test -f "$nlist"S; then
 	    eval "$global_symbol_to_cdecl"' < "$nlist"S >> "$output_objdir/$my_dlsyms"'
 	  else
-	    $ECHO '/* NONE */' >> "$output_objdir/$my_dlsyms"
+	    echo '/* NONE */' >> "$output_objdir/$my_dlsyms"
 	  fi
 
-	  $ECHO >> "$output_objdir/$my_dlsyms" "\
+	  echo >> "$output_objdir/$my_dlsyms" "\
 
 /* The mapping between symbol names and symbols.  */
 typedef struct {
   const char *name;
   void *address;
 } lt_dlsymlist;
-"
-	  case $host in
-	  *cygwin* | *mingw* | *cegcc* )
-	    $ECHO >> "$output_objdir/$my_dlsyms" "\
-/* DATA imports from DLLs on WIN32 con't be const, because
-   runtime relocations are performed -- see ld's documentation
-   on pseudo-relocs.  */"
-	    lt_dlsym_const= ;;
-	  *osf5*)
-	    echo >> "$output_objdir/$my_dlsyms" "\
-/* This system does not cope well with relocations in const data */"
-	    lt_dlsym_const= ;;
-	  *)
-	    lt_dlsym_const=const ;;
-	  esac
-
-	  $ECHO >> "$output_objdir/$my_dlsyms" "\
-extern $lt_dlsym_const lt_dlsymlist
+extern LT_DLSYM_CONST lt_dlsymlist
 lt_${my_prefix}_LTX_preloaded_symbols[];
-$lt_dlsym_const lt_dlsymlist
+LT_DLSYM_CONST lt_dlsymlist
 lt_${my_prefix}_LTX_preloaded_symbols[] =
 {\
   { \"$my_originator\", (void *) 0 },"
@@ -2457,7 +3443,7 @@
 	    eval "$global_symbol_to_c_name_address_lib_prefix" < "$nlist" >> "$output_objdir/$my_dlsyms"
 	    ;;
 	  esac
-	  $ECHO >> "$output_objdir/$my_dlsyms" "\
+	  echo >> "$output_objdir/$my_dlsyms" "\
   {0, (void *) 0}
 };
 
@@ -2500,7 +3486,7 @@
 	for arg in $LTCFLAGS; do
 	  case $arg in
 	  -pie | -fpie | -fPIE) ;;
-	  *) symtab_cflags="$symtab_cflags $arg" ;;
+	  *) func_append symtab_cflags " $arg" ;;
 	  esac
 	done
 
@@ -2515,16 +3501,16 @@
 	case $host in
 	*cygwin* | *mingw* | *cegcc* )
 	  if test -f "$output_objdir/$my_outputname.def"; then
-	    compile_command=`$ECHO "X$compile_command" | $Xsed -e "s%@SYMFILE@%$output_objdir/$my_outputname.def $symfileobj%"`
-	    finalize_command=`$ECHO "X$finalize_command" | $Xsed -e "s%@SYMFILE@%$output_objdir/$my_outputname.def $symfileobj%"`
+	    compile_command=`$ECHO "$compile_command" | $SED "s%@SYMFILE@%$output_objdir/$my_outputname.def $symfileobj%"`
+	    finalize_command=`$ECHO "$finalize_command" | $SED "s%@SYMFILE@%$output_objdir/$my_outputname.def $symfileobj%"`
 	  else
-	    compile_command=`$ECHO "X$compile_command" | $Xsed -e "s%@SYMFILE@%$symfileobj%"`
-	    finalize_command=`$ECHO "X$finalize_command" | $Xsed -e "s%@SYMFILE@%$symfileobj%"`
+	    compile_command=`$ECHO "$compile_command" | $SED "s%@SYMFILE@%$symfileobj%"`
+	    finalize_command=`$ECHO "$finalize_command" | $SED "s%@SYMFILE@%$symfileobj%"`
 	  fi
 	  ;;
 	*)
-	  compile_command=`$ECHO "X$compile_command" | $Xsed -e "s%@SYMFILE@%$symfileobj%"`
-	  finalize_command=`$ECHO "X$finalize_command" | $Xsed -e "s%@SYMFILE@%$symfileobj%"`
+	  compile_command=`$ECHO "$compile_command" | $SED "s%@SYMFILE@%$symfileobj%"`
+	  finalize_command=`$ECHO "$finalize_command" | $SED "s%@SYMFILE@%$symfileobj%"`
 	  ;;
 	esac
 	;;
@@ -2538,8 +3524,8 @@
       # really was required.
 
       # Nullify the symbol file.
-      compile_command=`$ECHO "X$compile_command" | $Xsed -e "s% @SYMFILE@%%"`
-      finalize_command=`$ECHO "X$finalize_command" | $Xsed -e "s% @SYMFILE@%%"`
+      compile_command=`$ECHO "$compile_command" | $SED "s% @SYMFILE@%%"`
+      finalize_command=`$ECHO "$finalize_command" | $SED "s% @SYMFILE@%%"`
     fi
 }
 
@@ -2549,6 +3535,7 @@
 # Need a lot of goo to handle *both* DLLs and import libs
 # Has to be a shell function in order to 'eat' the argument
 # that is supplied when $file_magic_command is called.
+# Despite the name, also deal with 64 bit binaries.
 func_win32_libid ()
 {
   $opt_debug
@@ -2559,9 +3546,11 @@
     win32_libid_type="x86 archive import"
     ;;
   *ar\ archive*) # could be an import, or static
+    # Keep the egrep pattern in sync with the one in _LT_CHECK_MAGIC_METHOD.
     if eval $OBJDUMP -f $1 | $SED -e '10q' 2>/dev/null |
-       $EGREP 'file format pe-i386(.*architecture: i386)?' >/dev/null ; then
-      win32_nmres=`eval $NM -f posix -A $1 |
+       $EGREP 'file format (pei*-i386(.*architecture: i386)?|pe-arm-wince|pe-x86-64)' >/dev/null; then
+      func_to_tool_file "$1" func_convert_file_msys_to_w32
+      win32_nmres=`eval $NM -f posix -A \"$func_to_tool_file_result\" |
 	$SED -n -e '
 	    1,100{
 		/ I /{
@@ -2590,6 +3579,131 @@
   $ECHO "$win32_libid_type"
 }
 
+# func_cygming_dll_for_implib ARG
+#
+# Platform-specific function to extract the
+# name of the DLL associated with the specified
+# import library ARG.
+# Invoked by eval'ing the libtool variable
+#    $sharedlib_from_linklib_cmd
+# Result is available in the variable
+#    $sharedlib_from_linklib_result
+func_cygming_dll_for_implib ()
+{
+  $opt_debug
+  sharedlib_from_linklib_result=`$DLLTOOL --identify-strict --identify "$1"`
+}
+
+# func_cygming_dll_for_implib_fallback_core SECTION_NAME LIBNAMEs
+#
+# The is the core of a fallback implementation of a
+# platform-specific function to extract the name of the
+# DLL associated with the specified import library LIBNAME.
+#
+# SECTION_NAME is either .idata$6 or .idata$7, depending
+# on the platform and compiler that created the implib.
+#
+# Echos the name of the DLL associated with the
+# specified import library.
+func_cygming_dll_for_implib_fallback_core ()
+{
+  $opt_debug
+  match_literal=`$ECHO "$1" | $SED "$sed_make_literal_regex"`
+  $OBJDUMP -s --section "$1" "$2" 2>/dev/null |
+    $SED '/^Contents of section '"$match_literal"':/{
+      # Place marker at beginning of archive member dllname section
+      s/.*/====MARK====/
+      p
+      d
+    }
+    # These lines can sometimes be longer than 43 characters, but
+    # are always uninteresting
+    /:[	 ]*file format pe[i]\{,1\}-/d
+    /^In archive [^:]*:/d
+    # Ensure marker is printed
+    /^====MARK====/p
+    # Remove all lines with less than 43 characters
+    /^.\{43\}/!d
+    # From remaining lines, remove first 43 characters
+    s/^.\{43\}//' |
+    $SED -n '
+      # Join marker and all lines until next marker into a single line
+      /^====MARK====/ b para
+      H
+      $ b para
+      b
+      :para
+      x
+      s/\n//g
+      # Remove the marker
+      s/^====MARK====//
+      # Remove trailing dots and whitespace
+      s/[\. \t]*$//
+      # Print
+      /./p' |
+    # we now have a list, one entry per line, of the stringified
+    # contents of the appropriate section of all members of the
+    # archive which possess that section. Heuristic: eliminate
+    # all those which have a first or second character that is
+    # a '.' (that is, objdump's representation of an unprintable
+    # character.) This should work for all archives with less than
+    # 0x302f exports -- but will fail for DLLs whose name actually
+    # begins with a literal '.' or a single character followed by
+    # a '.'.
+    #
+    # Of those that remain, print the first one.
+    $SED -e '/^\./d;/^.\./d;q'
+}
+
+# func_cygming_gnu_implib_p ARG
+# This predicate returns with zero status (TRUE) if
+# ARG is a GNU/binutils-style import library. Returns
+# with nonzero status (FALSE) otherwise.
+func_cygming_gnu_implib_p ()
+{
+  $opt_debug
+  func_to_tool_file "$1" func_convert_file_msys_to_w32
+  func_cygming_gnu_implib_tmp=`$NM "$func_to_tool_file_result" | eval "$global_symbol_pipe" | $EGREP ' (_head_[A-Za-z0-9_]+_[ad]l*|[A-Za-z0-9_]+_[ad]l*_iname)$'`
+  test -n "$func_cygming_gnu_implib_tmp"
+}
+
+# func_cygming_ms_implib_p ARG
+# This predicate returns with zero status (TRUE) if
+# ARG is an MS-style import library. Returns
+# with nonzero status (FALSE) otherwise.
+func_cygming_ms_implib_p ()
+{
+  $opt_debug
+  func_to_tool_file "$1" func_convert_file_msys_to_w32
+  func_cygming_ms_implib_tmp=`$NM "$func_to_tool_file_result" | eval "$global_symbol_pipe" | $GREP '_NULL_IMPORT_DESCRIPTOR'`
+  test -n "$func_cygming_ms_implib_tmp"
+}
+
+# func_cygming_dll_for_implib_fallback ARG
+# Platform-specific function to extract the
+# name of the DLL associated with the specified
+# import library ARG.
+#
+# This fallback implementation is for use when $DLLTOOL
+# does not support the --identify-strict option.
+# Invoked by eval'ing the libtool variable
+#    $sharedlib_from_linklib_cmd
+# Result is available in the variable
+#    $sharedlib_from_linklib_result
+func_cygming_dll_for_implib_fallback ()
+{
+  $opt_debug
+  if func_cygming_gnu_implib_p "$1" ; then
+    # binutils import library
+    sharedlib_from_linklib_result=`func_cygming_dll_for_implib_fallback_core '.idata$7' "$1"`
+  elif func_cygming_ms_implib_p "$1" ; then
+    # ms-generated import library
+    sharedlib_from_linklib_result=`func_cygming_dll_for_implib_fallback_core '.idata$6' "$1"`
+  else
+    # unknown
+    sharedlib_from_linklib_result=""
+  fi
+}
 
 
 # func_extract_an_archive dir oldlib
@@ -2598,7 +3712,18 @@
     $opt_debug
     f_ex_an_ar_dir="$1"; shift
     f_ex_an_ar_oldlib="$1"
-    func_show_eval "(cd \$f_ex_an_ar_dir && $AR x \"\$f_ex_an_ar_oldlib\")" 'exit $?'
+    if test "$lock_old_archive_extraction" = yes; then
+      lockfile=$f_ex_an_ar_oldlib.lock
+      until $opt_dry_run || ln "$progpath" "$lockfile" 2>/dev/null; do
+	func_echo "Waiting for $lockfile to be removed"
+	sleep 2
+      done
+    fi
+    func_show_eval "(cd \$f_ex_an_ar_dir && $AR x \"\$f_ex_an_ar_oldlib\")" \
+		   'stat=$?; rm -f "$lockfile"; exit $stat'
+    if test "$lock_old_archive_extraction" = yes; then
+      $opt_dry_run || rm -f "$lockfile"
+    fi
     if ($AR t "$f_ex_an_ar_oldlib" | sort | sort -uc >/dev/null 2>&1); then
      :
     else
@@ -2669,7 +3794,7 @@
 	    darwin_file=
 	    darwin_files=
 	    for darwin_file in $darwin_filelist; do
-	      darwin_files=`find unfat-$$ -name $darwin_file -print | $NL2SP`
+	      darwin_files=`find unfat-$$ -name $darwin_file -print | sort | $NL2SP`
 	      $LIPO -create -output "$darwin_file" $darwin_files
 	    done # $darwin_filelist
 	    $RM -rf unfat-$$
@@ -2684,25 +3809,30 @@
         func_extract_an_archive "$my_xdir" "$my_xabs"
 	;;
       esac
-      my_oldobjs="$my_oldobjs "`find $my_xdir -name \*.$objext -print -o -name \*.lo -print | $NL2SP`
+      my_oldobjs="$my_oldobjs "`find $my_xdir -name \*.$objext -print -o -name \*.lo -print | sort | $NL2SP`
     done
 
     func_extract_archives_result="$my_oldobjs"
 }
 
 
-
-# func_emit_wrapper_part1 [arg=no]
+# func_emit_wrapper [arg=no]
 #
-# Emit the first part of a libtool wrapper script on stdout.
-# For more information, see the description associated with
-# func_emit_wrapper(), below.
-func_emit_wrapper_part1 ()
-{
-	func_emit_wrapper_part1_arg1=no
-	if test -n "$1" ; then
-	  func_emit_wrapper_part1_arg1=$1
-	fi
+# Emit a libtool wrapper script on stdout.
+# Don't directly open a file because we may want to
+# incorporate the script contents within a cygwin/mingw
+# wrapper executable.  Must ONLY be called from within
+# func_mode_link because it depends on a number of variables
+# set therein.
+#
+# ARG is the value that the WRAPPER_SCRIPT_BELONGS_IN_OBJDIR
+# variable will take.  If 'yes', then the emitted script
+# will assume that the directory in which it is stored is
+# the $objdir directory.  This is a cygwin/mingw-specific
+# behavior.
+func_emit_wrapper ()
+{
+	func_emit_wrapper_arg1=${1-no}
 
 	$ECHO "\
 #! $SHELL
@@ -2718,7 +3848,6 @@
 
 # Sed substitution that helps us do robust quoting.  It backslashifies
 # metacharacters that are still active within double-quoted strings.
-Xsed='${SED} -e 1s/^X//'
 sed_quote_subst='$sed_quote_subst'
 
 # Be Bourne compatible
@@ -2749,31 +3878,132 @@
 else
   # When we are sourced in execute mode, \$file and \$ECHO are already set.
   if test \"\$libtool_execute_magic\" != \"$magic\"; then
-    ECHO=\"$qecho\"
-    file=\"\$0\"
-    # Make sure echo works.
-    if test \"X\$1\" = X--no-reexec; then
-      # Discard the --no-reexec flag, and continue.
-      shift
-    elif test \"X\`{ \$ECHO '\t'; } 2>/dev/null\`\" = 'X\t'; then
-      # Yippee, \$ECHO works!
-      :
-    else
-      # Restart under the correct shell, and then maybe \$ECHO will work.
-      exec $SHELL \"\$0\" --no-reexec \${1+\"\$@\"}
-    fi
-  fi\
+    file=\"\$0\""
+
+    qECHO=`$ECHO "$ECHO" | $SED "$sed_quote_subst"`
+    $ECHO "\
+
+# A function that is used when there is no print builtin or printf.
+func_fallback_echo ()
+{
+  eval 'cat <<_LTECHO_EOF
+\$1
+_LTECHO_EOF'
+}
+    ECHO=\"$qECHO\"
+  fi
+
+# Very basic option parsing. These options are (a) specific to
+# the libtool wrapper, (b) are identical between the wrapper
+# /script/ and the wrapper /executable/ which is used only on
+# windows platforms, and (c) all begin with the string "--lt-"
+# (application programs are unlikely to have options which match
+# this pattern).
+#
+# There are only two supported options: --lt-debug and
+# --lt-dump-script. There is, deliberately, no --lt-help.
+#
+# The first argument to this parsing function should be the
+# script's $0 value, followed by "$@".
+lt_option_debug=
+func_parse_lt_options ()
+{
+  lt_script_arg0=\$0
+  shift
+  for lt_opt
+  do
+    case \"\$lt_opt\" in
+    --lt-debug) lt_option_debug=1 ;;
+    --lt-dump-script)
+        lt_dump_D=\`\$ECHO \"X\$lt_script_arg0\" | $SED -e 's/^X//' -e 's%/[^/]*$%%'\`
+        test \"X\$lt_dump_D\" = \"X\$lt_script_arg0\" && lt_dump_D=.
+        lt_dump_F=\`\$ECHO \"X\$lt_script_arg0\" | $SED -e 's/^X//' -e 's%^.*/%%'\`
+        cat \"\$lt_dump_D/\$lt_dump_F\"
+        exit 0
+      ;;
+    --lt-*)
+        \$ECHO \"Unrecognized --lt- option: '\$lt_opt'\" 1>&2
+        exit 1
+      ;;
+    esac
+  done
+
+  # Print the debug banner immediately:
+  if test -n \"\$lt_option_debug\"; then
+    echo \"${outputname}:${output}:\${LINENO}: libtool wrapper (GNU $PACKAGE$TIMESTAMP) $VERSION\" 1>&2
+  fi
+}
+
+# Used when --lt-debug. Prints its arguments to stdout
+# (redirection is the responsibility of the caller)
+func_lt_dump_args ()
+{
+  lt_dump_args_N=1;
+  for lt_arg
+  do
+    \$ECHO \"${outputname}:${output}:\${LINENO}: newargv[\$lt_dump_args_N]: \$lt_arg\"
+    lt_dump_args_N=\`expr \$lt_dump_args_N + 1\`
+  done
+}
+
+# Core function for launching the target application
+func_exec_program_core ()
+{
 "
-	$ECHO "\
+  case $host in
+  # Backslashes separate directories on plain windows
+  *-*-mingw | *-*-os2* | *-cegcc*)
+    $ECHO "\
+      if test -n \"\$lt_option_debug\"; then
+        \$ECHO \"${outputname}:${output}:\${LINENO}: newargv[0]: \$progdir\\\\\$program\" 1>&2
+        func_lt_dump_args \${1+\"\$@\"} 1>&2
+      fi
+      exec \"\$progdir\\\\\$program\" \${1+\"\$@\"}
+"
+    ;;
+
+  *)
+    $ECHO "\
+      if test -n \"\$lt_option_debug\"; then
+        \$ECHO \"${outputname}:${output}:\${LINENO}: newargv[0]: \$progdir/\$program\" 1>&2
+        func_lt_dump_args \${1+\"\$@\"} 1>&2
+      fi
+      exec \"\$progdir/\$program\" \${1+\"\$@\"}
+"
+    ;;
+  esac
+  $ECHO "\
+      \$ECHO \"\$0: cannot exec \$program \$*\" 1>&2
+      exit 1
+}
+
+# A function to encapsulate launching the target application
+# Strips options in the --lt-* namespace from \$@ and
+# launches target application with the remaining arguments.
+func_exec_program ()
+{
+  for lt_wr_arg
+  do
+    case \$lt_wr_arg in
+    --lt-*) ;;
+    *) set x \"\$@\" \"\$lt_wr_arg\"; shift;;
+    esac
+    shift
+  done
+  func_exec_program_core \${1+\"\$@\"}
+}
+
+  # Parse options
+  func_parse_lt_options \"\$0\" \${1+\"\$@\"}
 
   # Find the directory that this script lives in.
-  thisdir=\`\$ECHO \"X\$file\" | \$Xsed -e 's%/[^/]*$%%'\`
+  thisdir=\`\$ECHO \"\$file\" | $SED 's%/[^/]*$%%'\`
   test \"x\$thisdir\" = \"x\$file\" && thisdir=.
 
   # Follow symbolic links until we get to the real thisdir.
-  file=\`ls -ld \"\$file\" | ${SED} -n 's/.*-> //p'\`
+  file=\`ls -ld \"\$file\" | $SED -n 's/.*-> //p'\`
   while test -n \"\$file\"; do
-    destdir=\`\$ECHO \"X\$file\" | \$Xsed -e 's%/[^/]*\$%%'\`
+    destdir=\`\$ECHO \"\$file\" | $SED 's%/[^/]*\$%%'\`
 
     # If there was a directory component, then change thisdir.
     if test \"x\$destdir\" != \"x\$file\"; then
@@ -2783,30 +4013,13 @@
       esac
     fi
 
-    file=\`\$ECHO \"X\$file\" | \$Xsed -e 's%^.*/%%'\`
-    file=\`ls -ld \"\$thisdir/\$file\" | ${SED} -n 's/.*-> //p'\`
+    file=\`\$ECHO \"\$file\" | $SED 's%^.*/%%'\`
+    file=\`ls -ld \"\$thisdir/\$file\" | $SED -n 's/.*-> //p'\`
   done
-"
-}
-# end: func_emit_wrapper_part1
-
-# func_emit_wrapper_part2 [arg=no]
-#
-# Emit the second part of a libtool wrapper script on stdout.
-# For more information, see the description associated with
-# func_emit_wrapper(), below.
-func_emit_wrapper_part2 ()
-{
-	func_emit_wrapper_part2_arg1=no
-	if test -n "$1" ; then
-	  func_emit_wrapper_part2_arg1=$1
-	fi
-
-	$ECHO "\
 
   # Usually 'no', except on cygwin/mingw when embedded into
   # the cwrapper.
-  WRAPPER_SCRIPT_BELONGS_IN_OBJDIR=$func_emit_wrapper_part2_arg1
+  WRAPPER_SCRIPT_BELONGS_IN_OBJDIR=$func_emit_wrapper_arg1
   if test \"\$WRAPPER_SCRIPT_BELONGS_IN_OBJDIR\" = \"yes\"; then
     # special case for '.'
     if test \"\$thisdir\" = \".\"; then
@@ -2814,7 +4027,7 @@
     fi
     # remove .libs from thisdir
     case \"\$thisdir\" in
-    *[\\\\/]$objdir ) thisdir=\`\$ECHO \"X\$thisdir\" | \$Xsed -e 's%[\\\\/][^\\\\/]*$%%'\` ;;
+    *[\\\\/]$objdir ) thisdir=\`\$ECHO \"\$thisdir\" | $SED 's%[\\\\/][^\\\\/]*$%%'\` ;;
     $objdir )   thisdir=. ;;
     esac
   fi
@@ -2869,6 +4082,18 @@
 
   if test -f \"\$progdir/\$program\"; then"
 
+	# fixup the dll searchpath if we need to.
+	#
+	# Fix the DLL searchpath if we need to.  Do this before prepending
+	# to shlibpath, because on Windows, both are PATH and uninstalled
+	# libraries must come first.
+	if test -n "$dllsearchpath"; then
+	  $ECHO "\
+    # Add the dll search path components to the executable PATH
+    PATH=$dllsearchpath:\$PATH
+"
+	fi
+
 	# Export our shlibpath_var if we have one.
 	if test "$shlibpath_overrides_runpath" = yes && test -n "$shlibpath_var" && test -n "$temp_rpath"; then
 	  $ECHO "\
@@ -2877,253 +4102,28 @@
 
     # Some systems cannot cope with colon-terminated $shlibpath_var
     # The second colon is a workaround for a bug in BeOS R4 sed
-    $shlibpath_var=\`\$ECHO \"X\$$shlibpath_var\" | \$Xsed -e 's/::*\$//'\`
+    $shlibpath_var=\`\$ECHO \"\$$shlibpath_var\" | $SED 's/::*\$//'\`
 
     export $shlibpath_var
 "
 	fi
 
-	# fixup the dll searchpath if we need to.
-	if test -n "$dllsearchpath"; then
-	  $ECHO "\
-    # Add the dll search path components to the executable PATH
-    PATH=$dllsearchpath:\$PATH
-"
-	fi
-
 	$ECHO "\
     if test \"\$libtool_execute_magic\" != \"$magic\"; then
       # Run the actual program with our arguments.
-"
-	case $host in
-	# Backslashes separate directories on plain windows
-	*-*-mingw | *-*-os2* | *-cegcc*)
-	  $ECHO "\
-      exec \"\$progdir\\\\\$program\" \${1+\"\$@\"}
-"
-	  ;;
-
-	*)
-	  $ECHO "\
-      exec \"\$progdir/\$program\" \${1+\"\$@\"}
-"
-	  ;;
-	esac
-	$ECHO "\
-      \$ECHO \"\$0: cannot exec \$program \$*\" 1>&2
-      exit 1
+      func_exec_program \${1+\"\$@\"}
     fi
   else
     # The program doesn't exist.
     \$ECHO \"\$0: error: \\\`\$progdir/\$program' does not exist\" 1>&2
     \$ECHO \"This script is just a wrapper for \$program.\" 1>&2
-    $ECHO \"See the $PACKAGE documentation for more information.\" 1>&2
+    \$ECHO \"See the $PACKAGE documentation for more information.\" 1>&2
     exit 1
   fi
 fi\
 "
 }
-# end: func_emit_wrapper_part2
-
-
-# func_emit_wrapper [arg=no]
-#
-# Emit a libtool wrapper script on stdout.
-# Don't directly open a file because we may want to
-# incorporate the script contents within a cygwin/mingw
-# wrapper executable.  Must ONLY be called from within
-# func_mode_link because it depends on a number of variables
-# set therein.
-#
-# ARG is the value that the WRAPPER_SCRIPT_BELONGS_IN_OBJDIR
-# variable will take.  If 'yes', then the emitted script
-# will assume that the directory in which it is stored is
-# the $objdir directory.  This is a cygwin/mingw-specific
-# behavior.
-func_emit_wrapper ()
-{
-	func_emit_wrapper_arg1=no
-	if test -n "$1" ; then
-	  func_emit_wrapper_arg1=$1
-	fi
-
-	# split this up so that func_emit_cwrapperexe_src
-	# can call each part independently.
-	func_emit_wrapper_part1 "${func_emit_wrapper_arg1}"
-	func_emit_wrapper_part2 "${func_emit_wrapper_arg1}"
-}
-
-
-# func_to_host_path arg
-#
-# Convert paths to host format when used with build tools.
-# Intended for use with "native" mingw (where libtool itself
-# is running under the msys shell), or in the following cross-
-# build environments:
-#    $build          $host
-#    mingw (msys)    mingw  [e.g. native]
-#    cygwin          mingw
-#    *nix + wine     mingw
-# where wine is equipped with the `winepath' executable.
-# In the native mingw case, the (msys) shell automatically
-# converts paths for any non-msys applications it launches,
-# but that facility isn't available from inside the cwrapper.
-# Similar accommodations are necessary for $host mingw and
-# $build cygwin.  Calling this function does no harm for other
-# $host/$build combinations not listed above.
-#
-# ARG is the path (on $build) that should be converted to
-# the proper representation for $host. The result is stored
-# in $func_to_host_path_result.
-func_to_host_path ()
-{
-  func_to_host_path_result="$1"
-  if test -n "$1" ; then
-    case $host in
-      *mingw* )
-        lt_sed_naive_backslashify='s|\\\\*|\\|g;s|/|\\|g;s|\\|\\\\|g'
-        case $build in
-          *mingw* ) # actually, msys
-            # awkward: cmd appends spaces to result
-            lt_sed_strip_trailing_spaces="s/[ ]*\$//"
-            func_to_host_path_tmp1=`( cmd //c echo "$1" |\
-              $SED -e "$lt_sed_strip_trailing_spaces" ) 2>/dev/null || echo ""`
-            func_to_host_path_result=`echo "$func_to_host_path_tmp1" |\
-              $SED -e "$lt_sed_naive_backslashify"`
-            ;;
-          *cygwin* )
-            func_to_host_path_tmp1=`cygpath -w "$1"`
-            func_to_host_path_result=`echo "$func_to_host_path_tmp1" |\
-              $SED -e "$lt_sed_naive_backslashify"`
-            ;;
-          * )
-            # Unfortunately, winepath does not exit with a non-zero
-            # error code, so we are forced to check the contents of
-            # stdout. On the other hand, if the command is not
-            # found, the shell will set an exit code of 127 and print
-            # *an error message* to stdout. So we must check for both
-            # error code of zero AND non-empty stdout, which explains
-            # the odd construction:
-            func_to_host_path_tmp1=`winepath -w "$1" 2>/dev/null`
-            if test "$?" -eq 0 && test -n "${func_to_host_path_tmp1}"; then
-              func_to_host_path_result=`echo "$func_to_host_path_tmp1" |\
-                $SED -e "$lt_sed_naive_backslashify"`
-            else
-              # Allow warning below.
-              func_to_host_path_result=""
-            fi
-            ;;
-        esac
-        if test -z "$func_to_host_path_result" ; then
-          func_error "Could not determine host path corresponding to"
-          func_error "  '$1'"
-          func_error "Continuing, but uninstalled executables may not work."
-          # Fallback:
-          func_to_host_path_result="$1"
-        fi
-        ;;
-    esac
-  fi
-}
-# end: func_to_host_path
 
-# func_to_host_pathlist arg
-#
-# Convert pathlists to host format when used with build tools.
-# See func_to_host_path(), above. This function supports the
-# following $build/$host combinations (but does no harm for
-# combinations not listed here):
-#    $build          $host
-#    mingw (msys)    mingw  [e.g. native]
-#    cygwin          mingw
-#    *nix + wine     mingw
-#
-# Path separators are also converted from $build format to
-# $host format. If ARG begins or ends with a path separator
-# character, it is preserved (but converted to $host format)
-# on output.
-#
-# ARG is a pathlist (on $build) that should be converted to
-# the proper representation on $host. The result is stored
-# in $func_to_host_pathlist_result.
-func_to_host_pathlist ()
-{
-  func_to_host_pathlist_result="$1"
-  if test -n "$1" ; then
-    case $host in
-      *mingw* )
-        lt_sed_naive_backslashify='s|\\\\*|\\|g;s|/|\\|g;s|\\|\\\\|g'
-        # Remove leading and trailing path separator characters from
-        # ARG. msys behavior is inconsistent here, cygpath turns them
-        # into '.;' and ';.', and winepath ignores them completely.
-        func_to_host_pathlist_tmp2="$1"
-        # Once set for this call, this variable should not be
-        # reassigned. It is used in tha fallback case.
-        func_to_host_pathlist_tmp1=`echo "$func_to_host_pathlist_tmp2" |\
-          $SED -e 's|^:*||' -e 's|:*$||'`
-        case $build in
-          *mingw* ) # Actually, msys.
-            # Awkward: cmd appends spaces to result.
-            lt_sed_strip_trailing_spaces="s/[ ]*\$//"
-            func_to_host_pathlist_tmp2=`( cmd //c echo "$func_to_host_pathlist_tmp1" |\
-              $SED -e "$lt_sed_strip_trailing_spaces" ) 2>/dev/null || echo ""`
-            func_to_host_pathlist_result=`echo "$func_to_host_pathlist_tmp2" |\
-              $SED -e "$lt_sed_naive_backslashify"`
-            ;;
-          *cygwin* )
-            func_to_host_pathlist_tmp2=`cygpath -w -p "$func_to_host_pathlist_tmp1"`
-            func_to_host_pathlist_result=`echo "$func_to_host_pathlist_tmp2" |\
-              $SED -e "$lt_sed_naive_backslashify"`
-            ;;
-          * )
-            # unfortunately, winepath doesn't convert pathlists
-            func_to_host_pathlist_result=""
-            func_to_host_pathlist_oldIFS=$IFS
-            IFS=:
-            for func_to_host_pathlist_f in $func_to_host_pathlist_tmp1 ; do
-              IFS=$func_to_host_pathlist_oldIFS
-              if test -n "$func_to_host_pathlist_f" ; then
-                func_to_host_path "$func_to_host_pathlist_f"
-                if test -n "$func_to_host_path_result" ; then
-                  if test -z "$func_to_host_pathlist_result" ; then
-                    func_to_host_pathlist_result="$func_to_host_path_result"
-                  else
-                    func_to_host_pathlist_result="$func_to_host_pathlist_result;$func_to_host_path_result"
-                  fi
-                fi
-              fi
-              IFS=:
-            done
-            IFS=$func_to_host_pathlist_oldIFS
-            ;;
-        esac
-        if test -z "$func_to_host_pathlist_result" ; then
-          func_error "Could not determine the host path(s) corresponding to"
-          func_error "  '$1'"
-          func_error "Continuing, but uninstalled executables may not work."
-          # Fallback. This may break if $1 contains DOS-style drive
-          # specifications. The fix is not to complicate the expression
-          # below, but for the user to provide a working wine installation
-          # with winepath so that path translation in the cross-to-mingw
-          # case works properly.
-          lt_replace_pathsep_nix_to_dos="s|:|;|g"
-          func_to_host_pathlist_result=`echo "$func_to_host_pathlist_tmp1" |\
-            $SED -e "$lt_replace_pathsep_nix_to_dos"`
-        fi
-        # Now, add the leading and trailing path separators back
-        case "$1" in
-          :* ) func_to_host_pathlist_result=";$func_to_host_pathlist_result"
-            ;;
-        esac
-        case "$1" in
-          *: ) func_to_host_pathlist_result="$func_to_host_pathlist_result;"
-            ;;
-        esac
-        ;;
-    esac
-  fi
-}
-# end: func_to_host_pathlist
 
 # func_emit_cwrapperexe_src
 # emit the source code for a wrapper executable on stdout
@@ -3141,41 +4141,71 @@
 
    This wrapper executable should never be moved out of the build directory.
    If it is, it will not operate correctly.
-
-   Currently, it simply execs the wrapper *script* "$SHELL $output",
-   but could eventually absorb all of the scripts functionality and
-   exec $objdir/$outputname directly.
 */
 EOF
 	    cat <<"EOF"
+#ifdef _MSC_VER
+# define _CRT_SECURE_NO_DEPRECATE 1
+#endif
 #include <stdio.h>
 #include <stdlib.h>
 #ifdef _MSC_VER
 # include <direct.h>
 # include <process.h>
 # include <io.h>
-# define setmode _setmode
 #else
 # include <unistd.h>
 # include <stdint.h>
 # ifdef __CYGWIN__
 #  include <io.h>
-#  define HAVE_SETENV
-#  ifdef __STRICT_ANSI__
+# endif
+#endif
+#include <malloc.h>
+#include <stdarg.h>
+#include <assert.h>
+#include <string.h>
+#include <ctype.h>
+#include <errno.h>
+#include <fcntl.h>
+#include <sys/stat.h>
+
+/* declarations of non-ANSI functions */
+#if defined(__MINGW32__)
+# ifdef __STRICT_ANSI__
+int _putenv (const char *);
+# endif
+#elif defined(__CYGWIN__)
+# ifdef __STRICT_ANSI__
 char *realpath (const char *, char *);
 int putenv (char *);
 int setenv (const char *, const char *, int);
-#  endif
 # endif
+/* #elif defined (other platforms) ... */
+#endif
+
+/* portability defines, excluding path handling macros */
+#if defined(_MSC_VER)
+# define setmode _setmode
+# define stat    _stat
+# define chmod   _chmod
+# define getcwd  _getcwd
+# define putenv  _putenv
+# define S_IXUSR _S_IEXEC
+# ifndef _INTPTR_T_DEFINED
+#  define _INTPTR_T_DEFINED
+#  define intptr_t int
+# endif
+#elif defined(__MINGW32__)
+# define setmode _setmode
+# define stat    _stat
+# define chmod   _chmod
+# define getcwd  _getcwd
+# define putenv  _putenv
+#elif defined(__CYGWIN__)
+# define HAVE_SETENV
+# define FOPEN_WB "wb"
+/* #elif defined (other platforms) ... */
 #endif
-#include <malloc.h>
-#include <stdarg.h>
-#include <assert.h>
-#include <string.h>
-#include <ctype.h>
-#include <errno.h>
-#include <fcntl.h>
-#include <sys/stat.h>
 
 #if defined(PATH_MAX)
 # define LT_PATHMAX PATH_MAX
@@ -3192,14 +4222,7 @@
 # define S_IXGRP 0
 #endif
 
-#ifdef _MSC_VER
-# define S_IXUSR _S_IEXEC
-# define stat _stat
-# ifndef _INTPTR_T_DEFINED
-#  define intptr_t int
-# endif
-#endif
-
+/* path handling portability macros */
 #ifndef DIR_SEPARATOR
 # define DIR_SEPARATOR '/'
 # define PATH_SEPARATOR ':'
@@ -3230,10 +4253,6 @@
 # define IS_PATH_SEPARATOR(ch) ((ch) == PATH_SEPARATOR_2)
 #endif /* PATH_SEPARATOR_2 */
 
-#ifdef __CYGWIN__
-# define FOPEN_WB "wb"
-#endif
-
 #ifndef FOPEN_WB
 # define FOPEN_WB "w"
 #endif
@@ -3246,22 +4265,13 @@
   if (stale) { free ((void *) stale); stale = 0; } \
 } while (0)
 
-#undef LTWRAPPER_DEBUGPRINTF
-#if defined DEBUGWRAPPER
-# define LTWRAPPER_DEBUGPRINTF(args) ltwrapper_debugprintf args
-static void
-ltwrapper_debugprintf (const char *fmt, ...)
-{
-    va_list args;
-    va_start (args, fmt);
-    (void) vfprintf (stderr, fmt, args);
-    va_end (args);
-}
+#if defined(LT_DEBUGWRAPPER)
+static int lt_debug = 1;
 #else
-# define LTWRAPPER_DEBUGPRINTF(args)
+static int lt_debug = 0;
 #endif
 
-const char *program_name = NULL;
+const char *program_name = "libtool-wrapper"; /* in case xstrdup fails */
 
 void *xmalloc (size_t num);
 char *xstrdup (const char *string);
@@ -3271,41 +4281,27 @@
 int make_executable (const char *path);
 int check_executable (const char *path);
 char *strendzap (char *str, const char *pat);
-void lt_fatal (const char *message, ...);
+void lt_debugprintf (const char *file, int line, const char *fmt, ...);
+void lt_fatal (const char *file, int line, const char *message, ...);
+static const char *nonnull (const char *s);
+static const char *nonempty (const char *s);
 void lt_setenv (const char *name, const char *value);
 char *lt_extend_str (const char *orig_value, const char *add, int to_end);
-void lt_opt_process_env_set (const char *arg);
-void lt_opt_process_env_prepend (const char *arg);
-void lt_opt_process_env_append (const char *arg);
-int lt_split_name_value (const char *arg, char** name, char** value);
 void lt_update_exe_path (const char *name, const char *value);
 void lt_update_lib_path (const char *name, const char *value);
-
-static const char *script_text_part1 =
-EOF
-
-	    func_emit_wrapper_part1 yes |
-	        $SED -e 's/\([\\"]\)/\\\1/g' \
-	             -e 's/^/  "/' -e 's/$/\\n"/'
-	    echo ";"
-	    cat <<EOF
-
-static const char *script_text_part2 =
+char **prepare_spawn (char **argv);
+void lt_dump_script (FILE *f);
 EOF
-	    func_emit_wrapper_part2 yes |
-	        $SED -e 's/\([\\"]\)/\\\1/g' \
-	             -e 's/^/  "/' -e 's/$/\\n"/'
-	    echo ";"
 
 	    cat <<EOF
-const char * MAGIC_EXE = "$magic_exe";
+volatile const char * MAGIC_EXE = "$magic_exe";
 const char * LIB_PATH_VARNAME = "$shlibpath_var";
 EOF
 
 	    if test "$shlibpath_overrides_runpath" = yes && test -n "$shlibpath_var" && test -n "$temp_rpath"; then
-              func_to_host_pathlist "$temp_rpath"
+              func_to_host_path "$temp_rpath"
 	      cat <<EOF
-const char * LIB_PATH_VALUE   = "$func_to_host_pathlist_result";
+const char * LIB_PATH_VALUE   = "$func_to_host_path_result";
 EOF
 	    else
 	      cat <<"EOF"
@@ -3314,10 +4310,10 @@
 	    fi
 
 	    if test -n "$dllsearchpath"; then
-              func_to_host_pathlist "$dllsearchpath:"
+              func_to_host_path "$dllsearchpath:"
 	      cat <<EOF
 const char * EXE_PATH_VARNAME = "PATH";
-const char * EXE_PATH_VALUE   = "$func_to_host_pathlist_result";
+const char * EXE_PATH_VALUE   = "$func_to_host_path_result";
 EOF
 	    else
 	      cat <<"EOF"
@@ -3340,24 +4336,10 @@
 	    cat <<"EOF"
 
 #define LTWRAPPER_OPTION_PREFIX         "--lt-"
-#define LTWRAPPER_OPTION_PREFIX_LENGTH  5
 
-static const size_t opt_prefix_len         = LTWRAPPER_OPTION_PREFIX_LENGTH;
 static const char *ltwrapper_option_prefix = LTWRAPPER_OPTION_PREFIX;
-
 static const char *dumpscript_opt       = LTWRAPPER_OPTION_PREFIX "dump-script";
-
-static const size_t env_set_opt_len     = LTWRAPPER_OPTION_PREFIX_LENGTH + 7;
-static const char *env_set_opt          = LTWRAPPER_OPTION_PREFIX "env-set";
-  /* argument is putenv-style "foo=bar", value of foo is set to bar */
-
-static const size_t env_prepend_opt_len = LTWRAPPER_OPTION_PREFIX_LENGTH + 11;
-static const char *env_prepend_opt      = LTWRAPPER_OPTION_PREFIX "env-prepend";
-  /* argument is putenv-style "foo=bar", new value of foo is bar${foo} */
-
-static const size_t env_append_opt_len  = LTWRAPPER_OPTION_PREFIX_LENGTH + 10;
-static const char *env_append_opt       = LTWRAPPER_OPTION_PREFIX "env-append";
-  /* argument is putenv-style "foo=bar", new value of foo is ${foo}bar */
+static const char *debug_opt            = LTWRAPPER_OPTION_PREFIX "debug";
 
 int
 main (int argc, char *argv[])
@@ -3374,10 +4356,13 @@
   int i;
 
   program_name = (char *) xstrdup (base_name (argv[0]));
-  LTWRAPPER_DEBUGPRINTF (("(main) argv[0]      : %s\n", argv[0]));
-  LTWRAPPER_DEBUGPRINTF (("(main) program_name : %s\n", program_name));
+  newargz = XMALLOC (char *, argc + 1);
 
-  /* very simple arg parsing; don't want to rely on getopt */
+  /* very simple arg parsing; don't want to rely on getopt
+   * also, copy all non cwrapper options to newargz, except
+   * argz[0], which is handled differently
+   */
+  newargc=0;
   for (i = 1; i < argc; i++)
     {
       if (strcmp (argv[i], dumpscript_opt) == 0)
@@ -3391,25 +4376,57 @@
 	      esac
 
 	    cat <<"EOF"
-	  printf ("%s", script_text_part1);
-	  printf ("%s", script_text_part2);
+	  lt_dump_script (stdout);
 	  return 0;
 	}
+      if (strcmp (argv[i], debug_opt) == 0)
+	{
+          lt_debug = 1;
+          continue;
+	}
+      if (strcmp (argv[i], ltwrapper_option_prefix) == 0)
+        {
+          /* however, if there is an option in the LTWRAPPER_OPTION_PREFIX
+             namespace, but it is not one of the ones we know about and
+             have already dealt with, above (inluding dump-script), then
+             report an error. Otherwise, targets might begin to believe
+             they are allowed to use options in the LTWRAPPER_OPTION_PREFIX
+             namespace. The first time any user complains about this, we'll
+             need to make LTWRAPPER_OPTION_PREFIX a configure-time option
+             or a configure.ac-settable value.
+           */
+          lt_fatal (__FILE__, __LINE__,
+		    "unrecognized %s option: '%s'",
+                    ltwrapper_option_prefix, argv[i]);
+        }
+      /* otherwise ... */
+      newargz[++newargc] = xstrdup (argv[i]);
     }
+  newargz[++newargc] = NULL;
+
+EOF
+	    cat <<EOF
+  /* The GNU banner must be the first non-error debug message */
+  lt_debugprintf (__FILE__, __LINE__, "libtool wrapper (GNU $PACKAGE$TIMESTAMP) $VERSION\n");
+EOF
+	    cat <<"EOF"
+  lt_debugprintf (__FILE__, __LINE__, "(main) argv[0]: %s\n", argv[0]);
+  lt_debugprintf (__FILE__, __LINE__, "(main) program_name: %s\n", program_name);
 
-  newargz = XMALLOC (char *, argc + 1);
   tmp_pathspec = find_executable (argv[0]);
   if (tmp_pathspec == NULL)
-    lt_fatal ("Couldn't find %s", argv[0]);
-  LTWRAPPER_DEBUGPRINTF (("(main) found exe (before symlink chase) at : %s\n",
-			  tmp_pathspec));
+    lt_fatal (__FILE__, __LINE__, "couldn't find %s", argv[0]);
+  lt_debugprintf (__FILE__, __LINE__,
+                  "(main) found exe (before symlink chase) at: %s\n",
+		  tmp_pathspec);
 
   actual_cwrapper_path = chase_symlinks (tmp_pathspec);
-  LTWRAPPER_DEBUGPRINTF (("(main) found exe (after symlink chase) at : %s\n",
-			  actual_cwrapper_path));
+  lt_debugprintf (__FILE__, __LINE__,
+                  "(main) found exe (after symlink chase) at: %s\n",
+		  actual_cwrapper_path);
   XFREE (tmp_pathspec);
 
-  actual_cwrapper_name = xstrdup( base_name (actual_cwrapper_path));
+  actual_cwrapper_name = xstrdup (base_name (actual_cwrapper_path));
   strendzap (actual_cwrapper_path, actual_cwrapper_name);
 
   /* wrapper name transforms */
@@ -3427,8 +4444,9 @@
   target_name = tmp_pathspec;
   tmp_pathspec = 0;
 
-  LTWRAPPER_DEBUGPRINTF (("(main) libtool target name: %s\n",
-			  target_name));
+  lt_debugprintf (__FILE__, __LINE__,
+		  "(main) libtool target name: %s\n",
+		  target_name);
 EOF
 
 	    cat <<EOF
@@ -3478,80 +4496,19 @@
 
   lt_setenv ("BIN_SH", "xpg4"); /* for Tru64 */
   lt_setenv ("DUALCASE", "1");  /* for MSK sh */
-  lt_update_lib_path (LIB_PATH_VARNAME, LIB_PATH_VALUE);
+  /* Update the DLL searchpath.  EXE_PATH_VALUE ($dllsearchpath) must
+     be prepended before (that is, appear after) LIB_PATH_VALUE ($temp_rpath)
+     because on Windows, both *_VARNAMEs are PATH but uninstalled
+     libraries must come first. */
   lt_update_exe_path (EXE_PATH_VARNAME, EXE_PATH_VALUE);
+  lt_update_lib_path (LIB_PATH_VARNAME, LIB_PATH_VALUE);
 
-  newargc=0;
-  for (i = 1; i < argc; i++)
-    {
-      if (strncmp (argv[i], env_set_opt, env_set_opt_len) == 0)
-        {
-          if (argv[i][env_set_opt_len] == '=')
-            {
-              const char *p = argv[i] + env_set_opt_len + 1;
-              lt_opt_process_env_set (p);
-            }
-          else if (argv[i][env_set_opt_len] == '\0' && i + 1 < argc)
-            {
-              lt_opt_process_env_set (argv[++i]); /* don't copy */
-            }
-          else
-            lt_fatal ("%s missing required argument", env_set_opt);
-          continue;
-        }
-      if (strncmp (argv[i], env_prepend_opt, env_prepend_opt_len) == 0)
-        {
-          if (argv[i][env_prepend_opt_len] == '=')
-            {
-              const char *p = argv[i] + env_prepend_opt_len + 1;
-              lt_opt_process_env_prepend (p);
-            }
-          else if (argv[i][env_prepend_opt_len] == '\0' && i + 1 < argc)
-            {
-              lt_opt_process_env_prepend (argv[++i]); /* don't copy */
-            }
-          else
-            lt_fatal ("%s missing required argument", env_prepend_opt);
-          continue;
-        }
-      if (strncmp (argv[i], env_append_opt, env_append_opt_len) == 0)
-        {
-          if (argv[i][env_append_opt_len] == '=')
-            {
-              const char *p = argv[i] + env_append_opt_len + 1;
-              lt_opt_process_env_append (p);
-            }
-          else if (argv[i][env_append_opt_len] == '\0' && i + 1 < argc)
-            {
-              lt_opt_process_env_append (argv[++i]); /* don't copy */
-            }
-          else
-            lt_fatal ("%s missing required argument", env_append_opt);
-          continue;
-        }
-      if (strncmp (argv[i], ltwrapper_option_prefix, opt_prefix_len) == 0)
-        {
-          /* however, if there is an option in the LTWRAPPER_OPTION_PREFIX
-             namespace, but it is not one of the ones we know about and
-             have already dealt with, above (inluding dump-script), then
-             report an error. Otherwise, targets might begin to believe
-             they are allowed to use options in the LTWRAPPER_OPTION_PREFIX
-             namespace. The first time any user complains about this, we'll
-             need to make LTWRAPPER_OPTION_PREFIX a configure-time option
-             or a configure.ac-settable value.
-           */
-          lt_fatal ("Unrecognized option in %s namespace: '%s'",
-                    ltwrapper_option_prefix, argv[i]);
-        }
-      /* otherwise ... */
-      newargz[++newargc] = xstrdup (argv[i]);
-    }
-  newargz[++newargc] = NULL;
-
-  LTWRAPPER_DEBUGPRINTF     (("(main) lt_argv_zero : %s\n", (lt_argv_zero ? lt_argv_zero : "<NULL>")));
+  lt_debugprintf (__FILE__, __LINE__, "(main) lt_argv_zero: %s\n",
+		  nonnull (lt_argv_zero));
   for (i = 0; i < newargc; i++)
     {
-      LTWRAPPER_DEBUGPRINTF (("(main) newargz[%d]   : %s\n", i, (newargz[i] ? newargz[i] : "<NULL>")));
+      lt_debugprintf (__FILE__, __LINE__, "(main) newargz[%d]: %s\n",
+		      i, nonnull (newargz[i]));
     }
 
 EOF
@@ -3560,11 +4517,14 @@
 	      mingw*)
 		cat <<"EOF"
   /* execv doesn't actually work on mingw as expected on unix */
+  newargz = prepare_spawn (newargz);
   rval = _spawnv (_P_WAIT, lt_argv_zero, (const char * const *) newargz);
   if (rval == -1)
     {
       /* failed to start process */
-      LTWRAPPER_DEBUGPRINTF (("(main) failed to launch target \"%s\": errno = %d\n", lt_argv_zero, errno));
+      lt_debugprintf (__FILE__, __LINE__,
+		      "(main) failed to launch target \"%s\": %s\n",
+		      lt_argv_zero, nonnull (strerror (errno)));
       return 127;
     }
   return rval;
@@ -3586,7 +4546,7 @@
 {
   void *p = (void *) malloc (num);
   if (!p)
-    lt_fatal ("Memory exhausted");
+    lt_fatal (__FILE__, __LINE__, "memory exhausted");
 
   return p;
 }
@@ -3620,8 +4580,8 @@
 {
   struct stat st;
 
-  LTWRAPPER_DEBUGPRINTF (("(check_executable)  : %s\n",
-			  path ? (*path ? path : "EMPTY!") : "NULL!"));
+  lt_debugprintf (__FILE__, __LINE__, "(check_executable): %s\n",
+                  nonempty (path));
   if ((!path) || (!*path))
     return 0;
 
@@ -3638,8 +4598,8 @@
   int rval = 0;
   struct stat st;
 
-  LTWRAPPER_DEBUGPRINTF (("(make_executable)   : %s\n",
-			  path ? (*path ? path : "EMPTY!") : "NULL!"));
+  lt_debugprintf (__FILE__, __LINE__, "(make_executable): %s\n",
+                  nonempty (path));
   if ((!path) || (!*path))
     return 0;
 
@@ -3665,8 +4625,8 @@
   int tmp_len;
   char *concat_name;
 
-  LTWRAPPER_DEBUGPRINTF (("(find_executable)   : %s\n",
-			  wrapper ? (*wrapper ? wrapper : "EMPTY!") : "NULL!"));
+  lt_debugprintf (__FILE__, __LINE__, "(find_executable): %s\n",
+                  nonempty (wrapper));
 
   if ((wrapper == NULL) || (*wrapper == '\0'))
     return NULL;
@@ -3719,7 +4679,8 @@
 		{
 		  /* empty path: current directory */
 		  if (getcwd (tmp, LT_PATHMAX) == NULL)
-		    lt_fatal ("getcwd failed");
+		    lt_fatal (__FILE__, __LINE__, "getcwd failed: %s",
+                              nonnull (strerror (errno)));
 		  tmp_len = strlen (tmp);
 		  concat_name =
 		    XMALLOC (char, tmp_len + 1 + strlen (wrapper) + 1);
@@ -3744,7 +4705,8 @@
     }
   /* Relative path | not found in path: prepend cwd */
   if (getcwd (tmp, LT_PATHMAX) == NULL)
-    lt_fatal ("getcwd failed");
+    lt_fatal (__FILE__, __LINE__, "getcwd failed: %s",
+              nonnull (strerror (errno)));
   tmp_len = strlen (tmp);
   concat_name = XMALLOC (char, tmp_len + 1 + strlen (wrapper) + 1);
   memcpy (concat_name, tmp, tmp_len);
@@ -3770,8 +4732,9 @@
   int has_symlinks = 0;
   while (strlen (tmp_pathspec) && !has_symlinks)
     {
-      LTWRAPPER_DEBUGPRINTF (("checking path component for symlinks: %s\n",
-			      tmp_pathspec));
+      lt_debugprintf (__FILE__, __LINE__,
+		      "checking path component for symlinks: %s\n",
+		      tmp_pathspec);
       if (lstat (tmp_pathspec, &s) == 0)
 	{
 	  if (S_ISLNK (s.st_mode) != 0)
@@ -3793,8 +4756,9 @@
 	}
       else
 	{
-	  char *errstr = strerror (errno);
-	  lt_fatal ("Error accessing file %s (%s)", tmp_pathspec, errstr);
+	  lt_fatal (__FILE__, __LINE__,
+		    "error accessing file \"%s\": %s",
+		    tmp_pathspec, nonnull (strerror (errno)));
 	}
     }
   XFREE (tmp_pathspec);
@@ -3807,7 +4771,8 @@
   tmp_pathspec = realpath (pathspec, buf);
   if (tmp_pathspec == 0)
     {
-      lt_fatal ("Could not follow symlinks for %s", pathspec);
+      lt_fatal (__FILE__, __LINE__,
+		"could not follow symlinks for %s", pathspec);
     }
   return xstrdup (tmp_pathspec);
 #endif
@@ -3833,11 +4798,25 @@
   return str;
 }
 
+void
+lt_debugprintf (const char *file, int line, const char *fmt, ...)
+{
+  va_list args;
+  if (lt_debug)
+    {
+      (void) fprintf (stderr, "%s:%s:%d: ", program_name, file, line);
+      va_start (args, fmt);
+      (void) vfprintf (stderr, fmt, args);
+      va_end (args);
+    }
+}
+
 static void
-lt_error_core (int exit_status, const char *mode,
+lt_error_core (int exit_status, const char *file,
+	       int line, const char *mode,
 	       const char *message, va_list ap)
 {
-  fprintf (stderr, "%s: %s: ", program_name, mode);
+  fprintf (stderr, "%s:%s:%d: %s: ", program_name, file, line, mode);
   vfprintf (stderr, message, ap);
   fprintf (stderr, ".\n");
 
@@ -3846,20 +4825,32 @@
 }
 
 void
-lt_fatal (const char *message, ...)
+lt_fatal (const char *file, int line, const char *message, ...)
 {
   va_list ap;
   va_start (ap, message);
-  lt_error_core (EXIT_FAILURE, "FATAL", message, ap);
+  lt_error_core (EXIT_FAILURE, file, line, "FATAL", message, ap);
   va_end (ap);
 }
 
+static const char *
+nonnull (const char *s)
+{
+  return s ? s : "(null)";
+}
+
+static const char *
+nonempty (const char *s)
+{
+  return (s && !*s) ? "(empty)" : nonnull (s);
+}
+
 void
 lt_setenv (const char *name, const char *value)
 {
-  LTWRAPPER_DEBUGPRINTF (("(lt_setenv) setting '%s' to '%s'\n",
-                          (name ? name : "<NULL>"),
-                          (value ? value : "<NULL>")));
+  lt_debugprintf (__FILE__, __LINE__,
+		  "(lt_setenv) setting '%s' to '%s'\n",
+                  nonnull (name), nonnull (value));
   {
 #ifdef HAVE_SETENV
     /* always make a copy, for consistency with !HAVE_SETENV */
@@ -3904,95 +4895,12 @@
   return new_value;
 }
 
-int
-lt_split_name_value (const char *arg, char** name, char** value)
-{
-  const char *p;
-  int len;
-  if (!arg || !*arg)
-    return 1;
-
-  p = strchr (arg, (int)'=');
-
-  if (!p)
-    return 1;
-
-  *value = xstrdup (++p);
-
-  len = strlen (arg) - strlen (*value);
-  *name = XMALLOC (char, len);
-  strncpy (*name, arg, len-1);
-  (*name)[len - 1] = '\0';
-
-  return 0;
-}
-
-void
-lt_opt_process_env_set (const char *arg)
-{
-  char *name = NULL;
-  char *value = NULL;
-
-  if (lt_split_name_value (arg, &name, &value) != 0)
-    {
-      XFREE (name);
-      XFREE (value);
-      lt_fatal ("bad argument for %s: '%s'", env_set_opt, arg);
-    }
-
-  lt_setenv (name, value);
-  XFREE (name);
-  XFREE (value);
-}
-
-void
-lt_opt_process_env_prepend (const char *arg)
-{
-  char *name = NULL;
-  char *value = NULL;
-  char *new_value = NULL;
-
-  if (lt_split_name_value (arg, &name, &value) != 0)
-    {
-      XFREE (name);
-      XFREE (value);
-      lt_fatal ("bad argument for %s: '%s'", env_prepend_opt, arg);
-    }
-
-  new_value = lt_extend_str (getenv (name), value, 0);
-  lt_setenv (name, new_value);
-  XFREE (new_value);
-  XFREE (name);
-  XFREE (value);
-}
-
-void
-lt_opt_process_env_append (const char *arg)
-{
-  char *name = NULL;
-  char *value = NULL;
-  char *new_value = NULL;
-
-  if (lt_split_name_value (arg, &name, &value) != 0)
-    {
-      XFREE (name);
-      XFREE (value);
-      lt_fatal ("bad argument for %s: '%s'", env_append_opt, arg);
-    }
-
-  new_value = lt_extend_str (getenv (name), value, 1);
-  lt_setenv (name, new_value);
-  XFREE (new_value);
-  XFREE (name);
-  XFREE (value);
-}
-
 void
 lt_update_exe_path (const char *name, const char *value)
 {
-  LTWRAPPER_DEBUGPRINTF (("(lt_update_exe_path) modifying '%s' by prepending '%s'\n",
-                          (name ? name : "<NULL>"),
-                          (value ? value : "<NULL>")));
+  lt_debugprintf (__FILE__, __LINE__,
+		  "(lt_update_exe_path) modifying '%s' by prepending '%s'\n",
+                  nonnull (name), nonnull (value));
 
   if (name && *name && value && *value)
     {
@@ -4011,9 +4919,9 @@
 void
 lt_update_lib_path (const char *name, const char *value)
 {
-  LTWRAPPER_DEBUGPRINTF (("(lt_update_lib_path) modifying '%s' by prepending '%s'\n",
-                          (name ? name : "<NULL>"),
-                          (value ? value : "<NULL>")));
+  lt_debugprintf (__FILE__, __LINE__,
+		  "(lt_update_lib_path) modifying '%s' by prepending '%s'\n",
+                  nonnull (name), nonnull (value));
 
   if (name && *name && value && *value)
     {
@@ -4023,11 +4931,152 @@
     }
 }
 
+EOF
+	    case $host_os in
+	      mingw*)
+		cat <<"EOF"
+
+/* Prepares an argument vector before calling spawn().
+   Note that spawn() does not by itself call the command interpreter
+     (getenv ("COMSPEC") != NULL ? getenv ("COMSPEC") :
+      ({ OSVERSIONINFO v; v.dwOSVersionInfoSize = sizeof(OSVERSIONINFO);
+         GetVersionEx(&v);
+         v.dwPlatformId == VER_PLATFORM_WIN32_NT;
+      }) ? "cmd.exe" : "command.com").
+   Instead it simply concatenates the arguments, separated by ' ', and calls
+   CreateProcess().  We must quote the arguments since Win32 CreateProcess()
+   interprets characters like ' ', '\t', '\\', '"' (but not '<' and '>') in a
+   special way:
+   - Space and tab are interpreted as delimiters. They are not treated as
+     delimiters if they are surrounded by double quotes: "...".
+   - Unescaped double quotes are removed from the input. Their only effect is
+     that within double quotes, space and tab are treated like normal
+     characters.
+   - Backslashes not followed by double quotes are not special.
+   - But 2*n+1 backslashes followed by a double quote become
+     n backslashes followed by a double quote (n >= 0):
+       \" -> "
+       \\\" -> \"
+       \\\\\" -> \\"
+ */
+#define SHELL_SPECIAL_CHARS "\"\\ \001\002\003\004\005\006\007\010\011\012\013\014\015\016\017\020\021\022\023\024\025\026\027\030\031\032\033\034\035\036\037"
+#define SHELL_SPACE_CHARS " \001\002\003\004\005\006\007\010\011\012\013\014\015\016\017\020\021\022\023\024\025\026\027\030\031\032\033\034\035\036\037"
+char **
+prepare_spawn (char **argv)
+{
+  size_t argc;
+  char **new_argv;
+  size_t i;
+
+  /* Count number of arguments.  */
+  for (argc = 0; argv[argc] != NULL; argc++)
+    ;
+
+  /* Allocate new argument vector.  */
+  new_argv = XMALLOC (char *, argc + 1);
+
+  /* Put quoted arguments into the new argument vector.  */
+  for (i = 0; i < argc; i++)
+    {
+      const char *string = argv[i];
+
+      if (string[0] == '\0')
+	new_argv[i] = xstrdup ("\"\"");
+      else if (strpbrk (string, SHELL_SPECIAL_CHARS) != NULL)
+	{
+	  int quote_around = (strpbrk (string, SHELL_SPACE_CHARS) != NULL);
+	  size_t length;
+	  unsigned int backslashes;
+	  const char *s;
+	  char *quoted_string;
+	  char *p;
+
+	  length = 0;
+	  backslashes = 0;
+	  if (quote_around)
+	    length++;
+	  for (s = string; *s != '\0'; s++)
+	    {
+	      char c = *s;
+	      if (c == '"')
+		length += backslashes + 1;
+	      length++;
+	      if (c == '\\')
+		backslashes++;
+	      else
+		backslashes = 0;
+	    }
+	  if (quote_around)
+	    length += backslashes + 1;
+
+	  quoted_string = XMALLOC (char, length + 1);
+
+	  p = quoted_string;
+	  backslashes = 0;
+	  if (quote_around)
+	    *p++ = '"';
+	  for (s = string; *s != '\0'; s++)
+	    {
+	      char c = *s;
+	      if (c == '"')
+		{
+		  unsigned int j;
+		  for (j = backslashes + 1; j > 0; j--)
+		    *p++ = '\\';
+		}
+	      *p++ = c;
+	      if (c == '\\')
+		backslashes++;
+	      else
+		backslashes = 0;
+	    }
+	  if (quote_around)
+	    {
+	      unsigned int j;
+	      for (j = backslashes; j > 0; j--)
+		*p++ = '\\';
+	      *p++ = '"';
+	    }
+	  *p = '\0';
+
+	  new_argv[i] = quoted_string;
+	}
+      else
+	new_argv[i] = (char *) string;
+    }
+  new_argv[argc] = NULL;
+
+  return new_argv;
+}
+EOF
+		;;
+	    esac
+
+            cat <<"EOF"
+void lt_dump_script (FILE* f)
+{
+EOF
+	    func_emit_wrapper yes |
+              $SED -e 's/\([\\"]\)/\\\1/g' \
+	           -e 's/^/  fputs ("/' -e 's/$/\\n", f);/'
 
+            cat <<"EOF"
+}
 EOF
 }
 # end: func_emit_cwrapperexe_src
 
+# func_win32_import_lib_p ARG
+# True if ARG is an import lib, as indicated by $file_magic_cmd
+func_win32_import_lib_p ()
+{
+    $opt_debug
+    case `eval $file_magic_cmd \"\$1\" 2>/dev/null | $SED -e 10q` in
+    *import*) : ;;
+    *) false ;;
+    esac
+}
+
 # func_mode_link arg...
 func_mode_link ()
 {
@@ -4072,6 +5121,7 @@
     new_inherited_linker_flags=
 
     avoid_version=no
+    bindir=
     dlfiles=
     dlprefiles=
     dlself=no
@@ -4164,6 +5214,11 @@
 	esac
 
 	case $prev in
+	bindir)
+	  bindir="$arg"
+	  prev=
+	  continue
+	  ;;
 	dlfiles|dlprefiles)
 	  if test "$preload" = no; then
 	    # Add the symbol object into the linking commands.
@@ -4195,9 +5250,9 @@
 	    ;;
 	  *)
 	    if test "$prev" = dlfiles; then
-	      dlfiles="$dlfiles $arg"
+	      func_append dlfiles " $arg"
 	    else
-	      dlprefiles="$dlprefiles $arg"
+	      func_append dlprefiles " $arg"
 	    fi
 	    prev=
 	    continue
@@ -4221,7 +5276,7 @@
 	    *-*-darwin*)
 	      case "$deplibs " in
 		*" $qarg.ltframework "*) ;;
-		*) deplibs="$deplibs $qarg.ltframework" # this is fixed later
+		*) func_append deplibs " $qarg.ltframework" # this is fixed later
 		   ;;
 	      esac
 	      ;;
@@ -4240,7 +5295,7 @@
 	    moreargs=
 	    for fil in `cat "$save_arg"`
 	    do
-#	      moreargs="$moreargs $fil"
+#	      func_append moreargs " $fil"
 	      arg=$fil
 	      # A libtool-controlled object.
 
@@ -4269,7 +5324,7 @@
 
 		  if test "$prev" = dlfiles; then
 		    if test "$build_libtool_libs" = yes && test "$dlopen_support" = yes; then
-		      dlfiles="$dlfiles $pic_object"
+		      func_append dlfiles " $pic_object"
 		      prev=
 		      continue
 		    else
@@ -4281,7 +5336,7 @@
 		  # CHECK ME:  I think I busted this.  -Ossama
 		  if test "$prev" = dlprefiles; then
 		    # Preload the old-style object.
-		    dlprefiles="$dlprefiles $pic_object"
+		    func_append dlprefiles " $pic_object"
 		    prev=
 		  fi
 
@@ -4351,12 +5406,12 @@
 	  if test "$prev" = rpath; then
 	    case "$rpath " in
 	    *" $arg "*) ;;
-	    *) rpath="$rpath $arg" ;;
+	    *) func_append rpath " $arg" ;;
 	    esac
 	  else
 	    case "$xrpath " in
 	    *" $arg "*) ;;
-	    *) xrpath="$xrpath $arg" ;;
+	    *) func_append xrpath " $arg" ;;
 	    esac
 	  fi
 	  prev=
@@ -4368,28 +5423,28 @@
 	  continue
 	  ;;
 	weak)
-	  weak_libs="$weak_libs $arg"
+	  func_append weak_libs " $arg"
 	  prev=
 	  continue
 	  ;;
 	xcclinker)
-	  linker_flags="$linker_flags $qarg"
-	  compiler_flags="$compiler_flags $qarg"
+	  func_append linker_flags " $qarg"
+	  func_append compiler_flags " $qarg"
 	  prev=
 	  func_append compile_command " $qarg"
 	  func_append finalize_command " $qarg"
 	  continue
 	  ;;
 	xcompiler)
-	  compiler_flags="$compiler_flags $qarg"
+	  func_append compiler_flags " $qarg"
 	  prev=
 	  func_append compile_command " $qarg"
 	  func_append finalize_command " $qarg"
 	  continue
 	  ;;
 	xlinker)
-	  linker_flags="$linker_flags $qarg"
-	  compiler_flags="$compiler_flags $wl$qarg"
+	  func_append linker_flags " $qarg"
+	  func_append compiler_flags " $wl$qarg"
 	  prev=
 	  func_append compile_command " $wl$qarg"
 	  func_append finalize_command " $wl$qarg"
@@ -4425,6 +5480,11 @@
 	continue
 	;;
 
+      -bindir)
+	prev=bindir
+	continue
+	;;
+
       -dlopen)
 	prev=dlfiles
 	continue
@@ -4475,15 +5535,16 @@
 	;;
 
       -L*)
-	func_stripname '-L' '' "$arg"
-	dir=$func_stripname_result
-	if test -z "$dir"; then
+	func_stripname "-L" '' "$arg"
+	if test -z "$func_stripname_result"; then
 	  if test "$#" -gt 0; then
 	    func_fatal_error "require no space between \`-L' and \`$1'"
 	  else
 	    func_fatal_error "need path for \`-L' option"
 	  fi
 	fi
+	func_resolve_sysroot "$func_stripname_result"
+	dir=$func_resolve_sysroot_result
 	# We need an absolute path.
 	case $dir in
 	[\\/]* | [A-Za-z]:[\\/]*) ;;
@@ -4495,24 +5556,30 @@
 	  ;;
 	esac
 	case "$deplibs " in
-	*" -L$dir "*) ;;
+	*" -L$dir "* | *" $arg "*)
+	  # Will only happen for absolute or sysroot arguments
+	  ;;
 	*)
-	  deplibs="$deplibs -L$dir"
-	  lib_search_path="$lib_search_path $dir"
+	  # Preserve sysroot, but never include relative directories
+	  case $dir in
+	    [\\/]* | [A-Za-z]:[\\/]* | =*) func_append deplibs " $arg" ;;
+	    *) func_append deplibs " -L$dir" ;;
+	  esac
+	  func_append lib_search_path " $dir"
 	  ;;
 	esac
 	case $host in
 	*-*-cygwin* | *-*-mingw* | *-*-pw32* | *-*-os2* | *-cegcc*)
-	  testbindir=`$ECHO "X$dir" | $Xsed -e 's*/lib$*/bin*'`
+	  testbindir=`$ECHO "$dir" | $SED 's*/lib$*/bin*'`
 	  case :$dllsearchpath: in
 	  *":$dir:"*) ;;
 	  ::) dllsearchpath=$dir;;
-	  *) dllsearchpath="$dllsearchpath:$dir";;
+	  *) func_append dllsearchpath ":$dir";;
 	  esac
 	  case :$dllsearchpath: in
 	  *":$testbindir:"*) ;;
 	  ::) dllsearchpath=$testbindir;;
-	  *) dllsearchpath="$dllsearchpath:$testbindir";;
+	  *) func_append dllsearchpath ":$testbindir";;
 	  esac
 	  ;;
 	esac
@@ -4522,7 +5589,7 @@
       -l*)
 	if test "X$arg" = "X-lc" || test "X$arg" = "X-lm"; then
 	  case $host in
-	  *-*-cygwin* | *-*-mingw* | *-*-pw32* | *-*-beos* | *-cegcc*)
+	  *-*-cygwin* | *-*-mingw* | *-*-pw32* | *-*-beos* | *-cegcc* | *-*-haiku*)
 	    # These systems don't actually have a C or math library (as such)
 	    continue
 	    ;;
@@ -4536,7 +5603,7 @@
 	    ;;
 	  *-*-rhapsody* | *-*-darwin1.[012])
 	    # Rhapsody C and math libraries are in the System framework
-	    deplibs="$deplibs System.ltframework"
+	    func_append deplibs " System.ltframework"
 	    continue
 	    ;;
 	  *-*-sco3.2v5* | *-*-sco5v6*)
@@ -4556,7 +5623,7 @@
 	   ;;
 	 esac
 	fi
-	deplibs="$deplibs $arg"
+	func_append deplibs " $arg"
 	continue
 	;;
 
@@ -4568,8 +5635,8 @@
       # Tru64 UNIX uses -model [arg] to determine the layout of C++
       # classes, name mangling, and exception handling.
       # Darwin uses the -arch flag to determine output architecture.
-      -model|-arch|-isysroot)
-	compiler_flags="$compiler_flags $arg"
+      -model|-arch|-isysroot|--sysroot)
+	func_append compiler_flags " $arg"
 	func_append compile_command " $arg"
 	func_append finalize_command " $arg"
 	prev=xcompiler
@@ -4577,12 +5644,12 @@
 	;;
 
       -mt|-mthreads|-kthread|-Kthread|-pthread|-pthreads|--thread-safe|-threads)
-	compiler_flags="$compiler_flags $arg"
+	func_append compiler_flags " $arg"
 	func_append compile_command " $arg"
 	func_append finalize_command " $arg"
 	case "$new_inherited_linker_flags " in
 	    *" $arg "*) ;;
-	    * ) new_inherited_linker_flags="$new_inherited_linker_flags $arg" ;;
+	    * ) func_append new_inherited_linker_flags " $arg" ;;
 	esac
 	continue
 	;;
@@ -4649,13 +5716,17 @@
 	# We need an absolute path.
 	case $dir in
 	[\\/]* | [A-Za-z]:[\\/]*) ;;
+	=*)
+	  func_stripname '=' '' "$dir"
+	  dir=$lt_sysroot$func_stripname_result
+	  ;;
 	*)
 	  func_fatal_error "only absolute run-paths are allowed"
 	  ;;
 	esac
 	case "$xrpath " in
 	*" $dir "*) ;;
-	*) xrpath="$xrpath $dir" ;;
+	*) func_append xrpath " $dir" ;;
 	esac
 	continue
 	;;
@@ -4708,8 +5779,8 @@
 	for flag in $args; do
 	  IFS="$save_ifs"
           func_quote_for_eval "$flag"
-	  arg="$arg $wl$func_quote_for_eval_result"
-	  compiler_flags="$compiler_flags $func_quote_for_eval_result"
+	  func_append arg " $func_quote_for_eval_result"
+	  func_append compiler_flags " $func_quote_for_eval_result"
 	done
 	IFS="$save_ifs"
 	func_stripname ' ' '' "$arg"
@@ -4724,9 +5795,9 @@
 	for flag in $args; do
 	  IFS="$save_ifs"
           func_quote_for_eval "$flag"
-	  arg="$arg $wl$func_quote_for_eval_result"
-	  compiler_flags="$compiler_flags $wl$func_quote_for_eval_result"
-	  linker_flags="$linker_flags $func_quote_for_eval_result"
+	  func_append arg " $wl$func_quote_for_eval_result"
+	  func_append compiler_flags " $wl$func_quote_for_eval_result"
+	  func_append linker_flags " $func_quote_for_eval_result"
 	done
 	IFS="$save_ifs"
 	func_stripname ' ' '' "$arg"
@@ -4754,23 +5825,27 @@
 	arg="$func_quote_for_eval_result"
 	;;
 
-      # -64, -mips[0-9] enable 64-bit mode on the SGI compiler
-      # -r[0-9][0-9]* specifies the processor on the SGI compiler
-      # -xarch=*, -xtarget=* enable 64-bit mode on the Sun compiler
-      # +DA*, +DD* enable 64-bit mode on the HP compiler
-      # -q* pass through compiler args for the IBM compiler
-      # -m*, -t[45]*, -txscale* pass through architecture-specific
-      # compiler args for GCC
-      # -F/path gives path to uninstalled frameworks, gcc on darwin
-      # -p, -pg, --coverage, -fprofile-* pass through profiling flag for GCC
-      # @file GCC response files
+      # Flags to be passed through unchanged, with rationale:
+      # -64, -mips[0-9]      enable 64-bit mode for the SGI compiler
+      # -r[0-9][0-9]*        specify processor for the SGI compiler
+      # -xarch=*, -xtarget=* enable 64-bit mode for the Sun compiler
+      # +DA*, +DD*           enable 64-bit mode for the HP compiler
+      # -q*                  compiler args for the IBM compiler
+      # -m*, -t[45]*, -txscale* architecture-specific flags for GCC
+      # -F/path              path to uninstalled frameworks, gcc on darwin
+      # -p, -pg, --coverage, -fprofile-*  profiling flags for GCC
+      # @file                GCC response files
+      # -tp=*                Portland pgcc target processor selection
+      # --sysroot=*          for sysroot support
+      # -O*, -flto*, -fwhopr*, -fuse-linker-plugin GCC link-time optimization
       -64|-mips[0-9]|-r[0-9][0-9]*|-xarch=*|-xtarget=*|+DA*|+DD*|-q*|-m*| \
-      -t[45]*|-txscale*|-p|-pg|--coverage|-fprofile-*|-F*|@*)
+      -t[45]*|-txscale*|-p|-pg|--coverage|-fprofile-*|-F*|@*|-tp=*|--sysroot=*| \
+      -O*|-flto*|-fwhopr*|-fuse-linker-plugin)
         func_quote_for_eval "$arg"
 	arg="$func_quote_for_eval_result"
         func_append compile_command " $arg"
         func_append finalize_command " $arg"
-        compiler_flags="$compiler_flags $arg"
+        func_append compiler_flags " $arg"
         continue
         ;;
 
@@ -4782,7 +5857,7 @@
 
       *.$objext)
 	# A standard object.
-	objs="$objs $arg"
+	func_append objs " $arg"
 	;;
 
       *.lo)
@@ -4813,7 +5888,7 @@
 
 	    if test "$prev" = dlfiles; then
 	      if test "$build_libtool_libs" = yes && test "$dlopen_support" = yes; then
-		dlfiles="$dlfiles $pic_object"
+		func_append dlfiles " $pic_object"
 		prev=
 		continue
 	      else
@@ -4825,7 +5900,7 @@
 	    # CHECK ME:  I think I busted this.  -Ossama
 	    if test "$prev" = dlprefiles; then
 	      # Preload the old-style object.
-	      dlprefiles="$dlprefiles $pic_object"
+	      func_append dlprefiles " $pic_object"
 	      prev=
 	    fi
 
@@ -4870,24 +5945,25 @@
 
       *.$libext)
 	# An archive.
-	deplibs="$deplibs $arg"
-	old_deplibs="$old_deplibs $arg"
+	func_append deplibs " $arg"
+	func_append old_deplibs " $arg"
 	continue
 	;;
 
       *.la)
 	# A libtool-controlled library.
 
+	func_resolve_sysroot "$arg"
 	if test "$prev" = dlfiles; then
 	  # This library was specified with -dlopen.
-	  dlfiles="$dlfiles $arg"
+	  func_append dlfiles " $func_resolve_sysroot_result"
 	  prev=
 	elif test "$prev" = dlprefiles; then
 	  # The library was specified with -dlpreopen.
-	  dlprefiles="$dlprefiles $arg"
+	  func_append dlprefiles " $func_resolve_sysroot_result"
 	  prev=
 	else
-	  deplibs="$deplibs $arg"
+	  func_append deplibs " $func_resolve_sysroot_result"
 	fi
 	continue
 	;;
@@ -4925,7 +6001,7 @@
 
     if test -n "$shlibpath_var"; then
       # get the directories listed in $shlibpath_var
-      eval shlib_search_path=\`\$ECHO \"X\${$shlibpath_var}\" \| \$Xsed -e \'s/:/ /g\'\`
+      eval shlib_search_path=\`\$ECHO \"\${$shlibpath_var}\" \| \$SED \'s/:/ /g\'\`
     else
       shlib_search_path=
     fi
@@ -4934,6 +6010,8 @@
 
     func_dirname "$output" "/" ""
     output_objdir="$func_dirname_result$objdir"
+    func_to_tool_file "$output_objdir/"
+    tool_output_objdir=$func_to_tool_file_result
     # Create the object directory.
     func_mkdir_p "$output_objdir"
 
@@ -4954,12 +6032,12 @@
     # Find all interdependent deplibs by searching for libraries
     # that are linked more than once (e.g. -la -lb -la)
     for deplib in $deplibs; do
-      if $opt_duplicate_deps ; then
+      if $opt_preserve_dup_deps ; then
 	case "$libs " in
-	*" $deplib "*) specialdeplibs="$specialdeplibs $deplib" ;;
+	*" $deplib "*) func_append specialdeplibs " $deplib" ;;
 	esac
       fi
-      libs="$libs $deplib"
+      func_append libs " $deplib"
     done
 
     if test "$linkmode" = lib; then
@@ -4972,9 +6050,9 @@
       if $opt_duplicate_compiler_generated_deps; then
 	for pre_post_dep in $predeps $postdeps; do
 	  case "$pre_post_deps " in
-	  *" $pre_post_dep "*) specialdeplibs="$specialdeplibs $pre_post_deps" ;;
+	  *" $pre_post_dep "*) func_append specialdeplibs " $pre_post_deps" ;;
 	  esac
-	  pre_post_deps="$pre_post_deps $pre_post_dep"
+	  func_append pre_post_deps " $pre_post_dep"
 	done
       fi
       pre_post_deps=
@@ -5033,10 +6111,7 @@
 	case $pass in
 	dlopen) libs="$dlfiles" ;;
 	dlpreopen) libs="$dlprefiles" ;;
-	link)
-	  libs="$deplibs %DEPLIBS%"
-	  test "X$link_all_deplibs" != Xno && libs="$libs $dependency_libs"
-	  ;;
+	link) libs="$deplibs %DEPLIBS% $dependency_libs" ;;
 	esac
       fi
       if test "$linkmode,$pass" = "lib,dlpreopen"; then
@@ -5044,17 +6119,19 @@
 	for lib in $dlprefiles; do
 	  # Ignore non-libtool-libs
 	  dependency_libs=
+	  func_resolve_sysroot "$lib"
 	  case $lib in
-	  *.la)	func_source "$lib" ;;
+	  *.la)	func_source "$func_resolve_sysroot_result" ;;
 	  esac
 
 	  # Collect preopened libtool deplibs, except any this library
 	  # has declared as weak libs
 	  for deplib in $dependency_libs; do
-            deplib_base=`$ECHO "X$deplib" | $Xsed -e "$basename"`
+	    func_basename "$deplib"
+            deplib_base=$func_basename_result
 	    case " $weak_libs " in
 	    *" $deplib_base "*) ;;
-	    *) deplibs="$deplibs $deplib" ;;
+	    *) func_append deplibs " $deplib" ;;
 	    esac
 	  done
 	done
@@ -5075,11 +6152,11 @@
 	    compile_deplibs="$deplib $compile_deplibs"
 	    finalize_deplibs="$deplib $finalize_deplibs"
 	  else
-	    compiler_flags="$compiler_flags $deplib"
+	    func_append compiler_flags " $deplib"
 	    if test "$linkmode" = lib ; then
 		case "$new_inherited_linker_flags " in
 		    *" $deplib "*) ;;
-		    * ) new_inherited_linker_flags="$new_inherited_linker_flags $deplib" ;;
+		    * ) func_append new_inherited_linker_flags " $deplib" ;;
 		esac
 	    fi
 	  fi
@@ -5164,7 +6241,7 @@
 	    if test "$linkmode" = lib ; then
 		case "$new_inherited_linker_flags " in
 		    *" $deplib "*) ;;
-		    * ) new_inherited_linker_flags="$new_inherited_linker_flags $deplib" ;;
+		    * ) func_append new_inherited_linker_flags " $deplib" ;;
 		esac
 	    fi
 	  fi
@@ -5177,7 +6254,8 @@
 	    test "$pass" = conv && continue
 	    newdependency_libs="$deplib $newdependency_libs"
 	    func_stripname '-L' '' "$deplib"
-	    newlib_search_path="$newlib_search_path $func_stripname_result"
+	    func_resolve_sysroot "$func_stripname_result"
+	    func_append newlib_search_path " $func_resolve_sysroot_result"
 	    ;;
 	  prog)
 	    if test "$pass" = conv; then
@@ -5191,7 +6269,8 @@
 	      finalize_deplibs="$deplib $finalize_deplibs"
 	    fi
 	    func_stripname '-L' '' "$deplib"
-	    newlib_search_path="$newlib_search_path $func_stripname_result"
+	    func_resolve_sysroot "$func_stripname_result"
+	    func_append newlib_search_path " $func_resolve_sysroot_result"
 	    ;;
 	  *)
 	    func_warning "\`-L' is ignored for archives/objects"
@@ -5202,17 +6281,21 @@
 	-R*)
 	  if test "$pass" = link; then
 	    func_stripname '-R' '' "$deplib"
-	    dir=$func_stripname_result
+	    func_resolve_sysroot "$func_stripname_result"
+	    dir=$func_resolve_sysroot_result
 	    # Make sure the xrpath contains only unique directories.
 	    case "$xrpath " in
 	    *" $dir "*) ;;
-	    *) xrpath="$xrpath $dir" ;;
+	    *) func_append xrpath " $dir" ;;
 	    esac
 	  fi
 	  deplibs="$deplib $deplibs"
 	  continue
 	  ;;
-	*.la) lib="$deplib" ;;
+	*.la)
+	  func_resolve_sysroot "$deplib"
+	  lib=$func_resolve_sysroot_result
+	  ;;
 	*.$libext)
 	  if test "$pass" = conv; then
 	    deplibs="$deplib $deplibs"
@@ -5230,7 +6313,7 @@
 		match_pattern*)
 		  set dummy $deplibs_check_method; shift
 		  match_pattern_regex=`expr "$deplibs_check_method" : "$1 \(.*\)"`
-		  if eval "\$ECHO \"X$deplib\"" 2>/dev/null | $Xsed -e 10q \
+		  if eval "\$ECHO \"$deplib\"" 2>/dev/null | $SED 10q \
 		    | $EGREP "$match_pattern_regex" > /dev/null; then
 		    valid_a_lib=yes
 		  fi
@@ -5240,15 +6323,15 @@
 		;;
 	      esac
 	      if test "$valid_a_lib" != yes; then
-		$ECHO
+		echo
 		$ECHO "*** Warning: Trying to link with static lib archive $deplib."
-		$ECHO "*** I have the capability to make that library automatically link in when"
-		$ECHO "*** you link to this library.  But I can only do this if you have a"
-		$ECHO "*** shared version of the library, which you do not appear to have"
-		$ECHO "*** because the file extensions .$libext of this argument makes me believe"
-		$ECHO "*** that it is just a static archive that I should not use here."
+		echo "*** I have the capability to make that library automatically link in when"
+		echo "*** you link to this library.  But I can only do this if you have a"
+		echo "*** shared version of the library, which you do not appear to have"
+		echo "*** because the file extensions .$libext of this argument makes me believe"
+		echo "*** that it is just a static archive that I should not use here."
 	      else
-		$ECHO
+		echo
 		$ECHO "*** Warning: Linking the shared library $output against the"
 		$ECHO "*** static library $deplib is not portable!"
 		deplibs="$deplib $deplibs"
@@ -5275,11 +6358,11 @@
 	    if test "$pass" = dlpreopen || test "$dlopen_support" != yes || test "$build_libtool_libs" = no; then
 	      # If there is no dlopen support or we're linking statically,
 	      # we need to preload.
-	      newdlprefiles="$newdlprefiles $deplib"
+	      func_append newdlprefiles " $deplib"
 	      compile_deplibs="$deplib $compile_deplibs"
 	      finalize_deplibs="$deplib $finalize_deplibs"
 	    else
-	      newdlfiles="$newdlfiles $deplib"
+	      func_append newdlfiles " $deplib"
 	    fi
 	  fi
 	  continue
@@ -5321,20 +6404,20 @@
 
 	# Convert "-framework foo" to "foo.ltframework"
 	if test -n "$inherited_linker_flags"; then
-	  tmp_inherited_linker_flags=`$ECHO "X$inherited_linker_flags" | $Xsed -e 's/-framework \([^ $]*\)/\1.ltframework/g'`
+	  tmp_inherited_linker_flags=`$ECHO "$inherited_linker_flags" | $SED 's/-framework \([^ $]*\)/\1.ltframework/g'`
 	  for tmp_inherited_linker_flag in $tmp_inherited_linker_flags; do
 	    case " $new_inherited_linker_flags " in
 	      *" $tmp_inherited_linker_flag "*) ;;
-	      *) new_inherited_linker_flags="$new_inherited_linker_flags $tmp_inherited_linker_flag";;
+	      *) func_append new_inherited_linker_flags " $tmp_inherited_linker_flag";;
 	    esac
 	  done
 	fi
-	dependency_libs=`$ECHO "X $dependency_libs" | $Xsed -e 's% \([^ $]*\).ltframework% -framework \1%g'`
+	dependency_libs=`$ECHO " $dependency_libs" | $SED 's% \([^ $]*\).ltframework% -framework \1%g'`
 	if test "$linkmode,$pass" = "lib,link" ||
 	   test "$linkmode,$pass" = "prog,scan" ||
 	   { test "$linkmode" != prog && test "$linkmode" != lib; }; then
-	  test -n "$dlopen" && dlfiles="$dlfiles $dlopen"
-	  test -n "$dlpreopen" && dlprefiles="$dlprefiles $dlpreopen"
+	  test -n "$dlopen" && func_append dlfiles " $dlopen"
+	  test -n "$dlpreopen" && func_append dlprefiles " $dlpreopen"
 	fi
 
 	if test "$pass" = conv; then
@@ -5345,30 +6428,36 @@
 	      func_fatal_error "cannot find name of link library for \`$lib'"
 	    fi
 	    # It is a libtool convenience library, so add in its objects.
-	    convenience="$convenience $ladir/$objdir/$old_library"
-	    old_convenience="$old_convenience $ladir/$objdir/$old_library"
-	    tmp_libs=
-	    for deplib in $dependency_libs; do
-	      deplibs="$deplib $deplibs"
-	      if $opt_duplicate_deps ; then
-		case "$tmp_libs " in
-		*" $deplib "*) specialdeplibs="$specialdeplibs $deplib" ;;
-		esac
-	      fi
-	      tmp_libs="$tmp_libs $deplib"
-	    done
+	    func_append convenience " $ladir/$objdir/$old_library"
+	    func_append old_convenience " $ladir/$objdir/$old_library"
 	  elif test "$linkmode" != prog && test "$linkmode" != lib; then
 	    func_fatal_error "\`$lib' is not a convenience library"
 	  fi
+	  tmp_libs=
+	  for deplib in $dependency_libs; do
+	    deplibs="$deplib $deplibs"
+	    if $opt_preserve_dup_deps ; then
+	      case "$tmp_libs " in
+	      *" $deplib "*) func_append specialdeplibs " $deplib" ;;
+	      esac
+	    fi
+	    func_append tmp_libs " $deplib"
+	  done
 	  continue
 	fi # $pass = conv
 
 
 	# Get the name of the library we link against.
 	linklib=
-	for l in $old_library $library_names; do
-	  linklib="$l"
-	done
+	if test -n "$old_library" &&
+	   { test "$prefer_static_libs" = yes ||
+	     test "$prefer_static_libs,$installed" = "built,no"; }; then
+	  linklib=$old_library
+	else
+	  for l in $old_library $library_names; do
+	    linklib="$l"
+	  done
+	fi
 	if test -z "$linklib"; then
 	  func_fatal_error "cannot find name of link library for \`$lib'"
 	fi
@@ -5385,9 +6474,9 @@
 	    # statically, we need to preload.  We also need to preload any
 	    # dependent libraries so libltdl's deplib preloader doesn't
 	    # bomb out in the load deplibs phase.
-	    dlprefiles="$dlprefiles $lib $dependency_libs"
+	    func_append dlprefiles " $lib $dependency_libs"
 	  else
-	    newdlfiles="$newdlfiles $lib"
+	    func_append newdlfiles " $lib"
 	  fi
 	  continue
 	fi # $pass = dlopen
@@ -5409,14 +6498,14 @@
 
 	# Find the relevant object directory and library name.
 	if test "X$installed" = Xyes; then
-	  if test ! -f "$libdir/$linklib" && test -f "$abs_ladir/$linklib"; then
+	  if test ! -f "$lt_sysroot$libdir/$linklib" && test -f "$abs_ladir/$linklib"; then
 	    func_warning "library \`$lib' was moved."
 	    dir="$ladir"
 	    absdir="$abs_ladir"
 	    libdir="$abs_ladir"
 	  else
-	    dir="$libdir"
-	    absdir="$libdir"
+	    dir="$lt_sysroot$libdir"
+	    absdir="$lt_sysroot$libdir"
 	  fi
 	  test "X$hardcode_automatic" = Xyes && avoidtemprpath=yes
 	else
@@ -5424,12 +6513,12 @@
 	    dir="$ladir"
 	    absdir="$abs_ladir"
 	    # Remove this search path later
-	    notinst_path="$notinst_path $abs_ladir"
+	    func_append notinst_path " $abs_ladir"
 	  else
 	    dir="$ladir/$objdir"
 	    absdir="$abs_ladir/$objdir"
 	    # Remove this search path later
-	    notinst_path="$notinst_path $abs_ladir"
+	    func_append notinst_path " $abs_ladir"
 	  fi
 	fi # $installed = yes
 	func_stripname 'lib' '.la' "$laname"
@@ -5440,20 +6529,46 @@
 	  if test -z "$libdir" && test "$linkmode" = prog; then
 	    func_fatal_error "only libraries may -dlpreopen a convenience library: \`$lib'"
 	  fi
-	  # Prefer using a static library (so that no silly _DYNAMIC symbols
-	  # are required to link).
-	  if test -n "$old_library"; then
-	    newdlprefiles="$newdlprefiles $dir/$old_library"
-	    # Keep a list of preopened convenience libraries to check
-	    # that they are being used correctly in the link pass.
-	    test -z "$libdir" && \
-		dlpreconveniencelibs="$dlpreconveniencelibs $dir/$old_library"
-	  # Otherwise, use the dlname, so that lt_dlopen finds it.
-	  elif test -n "$dlname"; then
-	    newdlprefiles="$newdlprefiles $dir/$dlname"
-	  else
-	    newdlprefiles="$newdlprefiles $dir/$linklib"
-	  fi
+	  case "$host" in
+	    # special handling for platforms with PE-DLLs.
+	    *cygwin* | *mingw* | *cegcc* )
+	      # Linker will automatically link against shared library if both
+	      # static and shared are present.  Therefore, ensure we extract
+	      # symbols from the import library if a shared library is present
+	      # (otherwise, the dlopen module name will be incorrect).  We do
+	      # this by putting the import library name into $newdlprefiles.
+	      # We recover the dlopen module name by 'saving' the la file
+	      # name in a special purpose variable, and (later) extracting the
+	      # dlname from the la file.
+	      if test -n "$dlname"; then
+	        func_tr_sh "$dir/$linklib"
+	        eval "libfile_$func_tr_sh_result=\$abs_ladir/\$laname"
+	        func_append newdlprefiles " $dir/$linklib"
+	      else
+	        func_append newdlprefiles " $dir/$old_library"
+	        # Keep a list of preopened convenience libraries to check
+	        # that they are being used correctly in the link pass.
+	        test -z "$libdir" && \
+	          func_append dlpreconveniencelibs " $dir/$old_library"
+	      fi
+	    ;;
+	    * )
+	      # Prefer using a static library (so that no silly _DYNAMIC symbols
+	      # are required to link).
+	      if test -n "$old_library"; then
+	        func_append newdlprefiles " $dir/$old_library"
+	        # Keep a list of preopened convenience libraries to check
+	        # that they are being used correctly in the link pass.
+	        test -z "$libdir" && \
+	          func_append dlpreconveniencelibs " $dir/$old_library"
+	      # Otherwise, use the dlname, so that lt_dlopen finds it.
+	      elif test -n "$dlname"; then
+	        func_append newdlprefiles " $dir/$dlname"
+	      else
+	        func_append newdlprefiles " $dir/$linklib"
+	      fi
+	    ;;
+	  esac
 	fi # $pass = dlpreopen
 
 	if test -z "$libdir"; then
@@ -5471,7 +6586,7 @@
 
 
 	if test "$linkmode" = prog && test "$pass" != link; then
-	  newlib_search_path="$newlib_search_path $ladir"
+	  func_append newlib_search_path " $ladir"
 	  deplibs="$lib $deplibs"
 
 	  linkalldeplibs=no
@@ -5484,7 +6599,8 @@
 	  for deplib in $dependency_libs; do
 	    case $deplib in
 	    -L*) func_stripname '-L' '' "$deplib"
-	         newlib_search_path="$newlib_search_path $func_stripname_result"
+	         func_resolve_sysroot "$func_stripname_result"
+	         func_append newlib_search_path " $func_resolve_sysroot_result"
 		 ;;
 	    esac
 	    # Need to link against all dependency_libs?
@@ -5495,12 +6611,12 @@
 	      # or/and link against static libraries
 	      newdependency_libs="$deplib $newdependency_libs"
 	    fi
-	    if $opt_duplicate_deps ; then
+	    if $opt_preserve_dup_deps ; then
 	      case "$tmp_libs " in
-	      *" $deplib "*) specialdeplibs="$specialdeplibs $deplib" ;;
+	      *" $deplib "*) func_append specialdeplibs " $deplib" ;;
 	      esac
 	    fi
-	    tmp_libs="$tmp_libs $deplib"
+	    func_append tmp_libs " $deplib"
 	  done # for deplib
 	  continue
 	fi # $linkmode = prog...
@@ -5515,7 +6631,7 @@
 	      # Make sure the rpath contains only unique directories.
 	      case "$temp_rpath:" in
 	      *"$absdir:"*) ;;
-	      *) temp_rpath="$temp_rpath$absdir:" ;;
+	      *) func_append temp_rpath "$absdir:" ;;
 	      esac
 	    fi
 
@@ -5527,7 +6643,7 @@
 	    *)
 	      case "$compile_rpath " in
 	      *" $absdir "*) ;;
-	      *) compile_rpath="$compile_rpath $absdir"
+	      *) func_append compile_rpath " $absdir" ;;
 	      esac
 	      ;;
 	    esac
@@ -5536,7 +6652,7 @@
 	    *)
 	      case "$finalize_rpath " in
 	      *" $libdir "*) ;;
-	      *) finalize_rpath="$finalize_rpath $libdir"
+	      *) func_append finalize_rpath " $libdir" ;;
 	      esac
 	      ;;
 	    esac
@@ -5561,12 +6677,12 @@
 	  case $host in
 	  *cygwin* | *mingw* | *cegcc*)
 	      # No point in relinking DLLs because paths are not encoded
-	      notinst_deplibs="$notinst_deplibs $lib"
+	      func_append notinst_deplibs " $lib"
 	      need_relink=no
 	    ;;
 	  *)
 	    if test "$installed" = no; then
-	      notinst_deplibs="$notinst_deplibs $lib"
+	      func_append notinst_deplibs " $lib"
 	      need_relink=yes
 	    fi
 	    ;;
@@ -5583,7 +6699,7 @@
 	    fi
 	  done
 	  if test -z "$dlopenmodule" && test "$shouldnotlink" = yes && test "$pass" = link; then
-	    $ECHO
+	    echo
 	    if test "$linkmode" = prog; then
 	      $ECHO "*** Warning: Linking the executable $output against the loadable module"
 	    else
@@ -5601,7 +6717,7 @@
 	    *)
 	      case "$compile_rpath " in
 	      *" $absdir "*) ;;
-	      *) compile_rpath="$compile_rpath $absdir"
+	      *) func_append compile_rpath " $absdir" ;;
 	      esac
 	      ;;
 	    esac
@@ -5610,7 +6726,7 @@
 	    *)
 	      case "$finalize_rpath " in
 	      *" $libdir "*) ;;
-	      *) finalize_rpath="$finalize_rpath $libdir"
+	      *) func_append finalize_rpath " $libdir" ;;
 	      esac
 	      ;;
 	    esac
@@ -5664,7 +6780,7 @@
 	    linklib=$newlib
 	  fi # test -n "$old_archive_from_expsyms_cmds"
 
-	  if test "$linkmode" = prog || test "$mode" != relink; then
+	  if test "$linkmode" = prog || test "$opt_mode" != relink; then
 	    add_shlibpath=
 	    add_dir=
 	    add=
@@ -5686,9 +6802,9 @@
 		      if test "X$dlopenmodule" != "X$lib"; then
 			$ECHO "*** Warning: lib $linklib is a module, not a shared library"
 			if test -z "$old_library" ; then
-			  $ECHO
-			  $ECHO "*** And there doesn't seem to be a static archive available"
-			  $ECHO "*** The link will probably fail, sorry"
+			  echo
+			  echo "*** And there doesn't seem to be a static archive available"
+			  echo "*** The link will probably fail, sorry"
 			else
 			  add="$dir/$old_library"
 			fi
@@ -5720,7 +6836,7 @@
 		if test -n "$inst_prefix_dir"; then
 		  case $libdir in
 		    [\\/]*)
-		      add_dir="$add_dir -L$inst_prefix_dir$libdir"
+		      func_append add_dir " -L$inst_prefix_dir$libdir"
 		      ;;
 		  esac
 		fi
@@ -5742,7 +6858,7 @@
 	    if test -n "$add_shlibpath"; then
 	      case :$compile_shlibpath: in
 	      *":$add_shlibpath:"*) ;;
-	      *) compile_shlibpath="$compile_shlibpath$add_shlibpath:" ;;
+	      *) func_append compile_shlibpath "$add_shlibpath:" ;;
 	      esac
 	    fi
 	    if test "$linkmode" = prog; then
@@ -5756,13 +6872,13 @@
 		 test "$hardcode_shlibpath_var" = yes; then
 		case :$finalize_shlibpath: in
 		*":$libdir:"*) ;;
-		*) finalize_shlibpath="$finalize_shlibpath$libdir:" ;;
+		*) func_append finalize_shlibpath "$libdir:" ;;
 		esac
 	      fi
 	    fi
 	  fi
 
-	  if test "$linkmode" = prog || test "$mode" = relink; then
+	  if test "$linkmode" = prog || test "$opt_mode" = relink; then
 	    add_shlibpath=
 	    add_dir=
 	    add=
@@ -5776,7 +6892,7 @@
 	    elif test "$hardcode_shlibpath_var" = yes; then
 	      case :$finalize_shlibpath: in
 	      *":$libdir:"*) ;;
-	      *) finalize_shlibpath="$finalize_shlibpath$libdir:" ;;
+	      *) func_append finalize_shlibpath "$libdir:" ;;
 	      esac
 	      add="-l$name"
 	    elif test "$hardcode_automatic" = yes; then
@@ -5793,7 +6909,7 @@
 	      if test -n "$inst_prefix_dir"; then
 		case $libdir in
 		  [\\/]*)
-		    add_dir="$add_dir -L$inst_prefix_dir$libdir"
+		    func_append add_dir " -L$inst_prefix_dir$libdir"
 		    ;;
 		esac
 	      fi
@@ -5828,21 +6944,21 @@
 
 	    # Just print a warning and add the library to dependency_libs so
 	    # that the program can be linked against the static library.
-	    $ECHO
+	    echo
 	    $ECHO "*** Warning: This system can not link to static lib archive $lib."
-	    $ECHO "*** I have the capability to make that library automatically link in when"
-	    $ECHO "*** you link to this library.  But I can only do this if you have a"
-	    $ECHO "*** shared version of the library, which you do not appear to have."
+	    echo "*** I have the capability to make that library automatically link in when"
+	    echo "*** you link to this library.  But I can only do this if you have a"
+	    echo "*** shared version of the library, which you do not appear to have."
 	    if test "$module" = yes; then
-	      $ECHO "*** But as you try to build a module library, libtool will still create "
-	      $ECHO "*** a static module, that should work as long as the dlopening application"
-	      $ECHO "*** is linked with the -dlopen flag to resolve symbols at runtime."
+	      echo "*** But as you try to build a module library, libtool will still create "
+	      echo "*** a static module, that should work as long as the dlopening application"
+	      echo "*** is linked with the -dlopen flag to resolve symbols at runtime."
 	      if test -z "$global_symbol_pipe"; then
-		$ECHO
-		$ECHO "*** However, this would only work if libtool was able to extract symbol"
-		$ECHO "*** lists from a program, using \`nm' or equivalent, but libtool could"
-		$ECHO "*** not find such a program.  So, this module is probably useless."
-		$ECHO "*** \`nm' from GNU binutils and a full rebuild may help."
+		echo
+		echo "*** However, this would only work if libtool was able to extract symbol"
+		echo "*** lists from a program, using \`nm' or equivalent, but libtool could"
+		echo "*** not find such a program.  So, this module is probably useless."
+		echo "*** \`nm' from GNU binutils and a full rebuild may help."
 	      fi
 	      if test "$build_old_libs" = no; then
 		build_libtool_libs=module
@@ -5870,27 +6986,33 @@
 	           temp_xrpath=$func_stripname_result
 		   case " $xrpath " in
 		   *" $temp_xrpath "*) ;;
-		   *) xrpath="$xrpath $temp_xrpath";;
+		   *) func_append xrpath " $temp_xrpath";;
 		   esac;;
-	      *) temp_deplibs="$temp_deplibs $libdir";;
+	      *) func_append temp_deplibs " $libdir";;
 	      esac
 	    done
 	    dependency_libs="$temp_deplibs"
 	  fi
 
-	  newlib_search_path="$newlib_search_path $absdir"
+	  func_append newlib_search_path " $absdir"
 	  # Link against this library
 	  test "$link_static" = no && newdependency_libs="$abs_ladir/$laname $newdependency_libs"
 	  # ... and its dependency_libs
 	  tmp_libs=
 	  for deplib in $dependency_libs; do
 	    newdependency_libs="$deplib $newdependency_libs"
-	    if $opt_duplicate_deps ; then
+	    case $deplib in
+              -L*) func_stripname '-L' '' "$deplib"
+                   func_resolve_sysroot "$func_stripname_result";;
+              *) func_resolve_sysroot "$deplib" ;;
+            esac
+	    if $opt_preserve_dup_deps ; then
 	      case "$tmp_libs " in
-	      *" $deplib "*) specialdeplibs="$specialdeplibs $deplib" ;;
+	      *" $func_resolve_sysroot_result "*)
+                func_append specialdeplibs " $func_resolve_sysroot_result" ;;
 	      esac
 	    fi
-	    tmp_libs="$tmp_libs $deplib"
+	    func_append tmp_libs " $func_resolve_sysroot_result"
 	  done
 
 	  if test "$link_all_deplibs" != no; then
@@ -5900,8 +7022,10 @@
 	      case $deplib in
 	      -L*) path="$deplib" ;;
 	      *.la)
+	        func_resolve_sysroot "$deplib"
+	        deplib=$func_resolve_sysroot_result
 	        func_dirname "$deplib" "" "."
-		dir="$func_dirname_result"
+		dir=$func_dirname_result
 		# We need an absolute path.
 		case $dir in
 		[\\/]* | [A-Za-z]:[\\/]*) absdir="$dir" ;;
@@ -5928,8 +7052,8 @@
                       if test -z "$darwin_install_name"; then
                           darwin_install_name=`${OTOOL64} -L $depdepl  | awk '{if (NR == 2) {print $1;exit}}'`
                       fi
-		      compiler_flags="$compiler_flags ${wl}-dylib_file ${wl}${darwin_install_name}:${depdepl}"
-		      linker_flags="$linker_flags -dylib_file ${darwin_install_name}:${depdepl}"
+		      func_append compiler_flags " ${wl}-dylib_file ${wl}${darwin_install_name}:${depdepl}"
+		      func_append linker_flags " -dylib_file ${darwin_install_name}:${depdepl}"
 		      path=
 		    fi
 		  fi
@@ -5962,7 +7086,7 @@
 	  compile_deplibs="$new_inherited_linker_flags $compile_deplibs"
 	  finalize_deplibs="$new_inherited_linker_flags $finalize_deplibs"
 	else
-	  compiler_flags="$compiler_flags "`$ECHO "X $new_inherited_linker_flags" | $Xsed -e 's% \([^ $]*\).ltframework% -framework \1%g'`
+	  compiler_flags="$compiler_flags "`$ECHO " $new_inherited_linker_flags" | $SED 's% \([^ $]*\).ltframework% -framework \1%g'`
 	fi
       fi
       dependency_libs="$newdependency_libs"
@@ -5979,7 +7103,7 @@
 	  for dir in $newlib_search_path; do
 	    case "$lib_search_path " in
 	    *" $dir "*) ;;
-	    *) lib_search_path="$lib_search_path $dir" ;;
+	    *) func_append lib_search_path " $dir" ;;
 	    esac
 	  done
 	  newlib_search_path=
@@ -6037,10 +7161,10 @@
 	    -L*)
 	      case " $tmp_libs " in
 	      *" $deplib "*) ;;
-	      *) tmp_libs="$tmp_libs $deplib" ;;
+	      *) func_append tmp_libs " $deplib" ;;
 	      esac
 	      ;;
-	    *) tmp_libs="$tmp_libs $deplib" ;;
+	    *) func_append tmp_libs " $deplib" ;;
 	    esac
 	  done
 	  eval $var=\"$tmp_libs\"
@@ -6056,7 +7180,7 @@
 	  ;;
 	esac
 	if test -n "$i" ; then
-	  tmp_libs="$tmp_libs $i"
+	  func_append tmp_libs " $i"
 	fi
       done
       dependency_libs=$tmp_libs
@@ -6097,7 +7221,7 @@
       # Now set the variables for building old libraries.
       build_libtool_libs=no
       oldlibs="$output"
-      objs="$objs$old_deplibs"
+      func_append objs "$old_deplibs"
       ;;
 
     lib)
@@ -6130,10 +7254,10 @@
 	if test "$deplibs_check_method" != pass_all; then
 	  func_fatal_error "cannot build libtool library \`$output' from non-libtool objects on this host:$objs"
 	else
-	  $ECHO
+	  echo
 	  $ECHO "*** Warning: Linking the shared library $output against the non-libtool"
 	  $ECHO "*** objects $objs is not portable!"
-	  libobjs="$libobjs $objs"
+	  func_append libobjs " $objs"
 	fi
       fi
 
@@ -6198,7 +7322,7 @@
 	    age="$number_minor"
 	    revision="$number_revision"
 	    ;;
-	  freebsd-aout|freebsd-elf|sunos)
+	  freebsd-aout|freebsd-elf|qnx|sunos)
 	    current="$number_major"
 	    revision="$number_minor"
 	    age="0"
@@ -6210,9 +7334,6 @@
 	    revision="$number_minor"
 	    lt_irix_increment=no
 	    ;;
-	  *)
-	    func_fatal_configuration "$modename: unknown library version type \`$version_type'"
-	    ;;
 	  esac
 	  ;;
 	no)
@@ -6334,7 +7455,7 @@
 	  done
 
 	  # Make executables depend on our current version.
-	  verstring="$verstring:${current}.0"
+	  func_append verstring ":${current}.0"
 	  ;;
 
 	qnx)
@@ -6402,10 +7523,10 @@
       fi
 
       func_generate_dlsyms "$libname" "$libname" "yes"
-      libobjs="$libobjs $symfileobj"
+      func_append libobjs " $symfileobj"
       test "X$libobjs" = "X " && libobjs=
 
-      if test "$mode" != relink; then
+      if test "$opt_mode" != relink; then
 	# Remove our outputs, but don't remove object files since they
 	# may have been created when compiling PIC objects.
 	removelist=
@@ -6421,7 +7542,7 @@
 		   continue
 		 fi
 	       fi
-	       removelist="$removelist $p"
+	       func_append removelist " $p"
 	       ;;
 	    *) ;;
 	  esac
@@ -6432,27 +7553,28 @@
 
       # Now set the variables for building old libraries.
       if test "$build_old_libs" = yes && test "$build_libtool_libs" != convenience ; then
-	oldlibs="$oldlibs $output_objdir/$libname.$libext"
+	func_append oldlibs " $output_objdir/$libname.$libext"
 
 	# Transform .lo files to .o files.
-	oldobjs="$objs "`$ECHO "X$libobjs" | $SP2NL | $Xsed -e '/\.'${libext}'$/d' -e "$lo2o" | $NL2SP`
+	oldobjs="$objs "`$ECHO "$libobjs" | $SP2NL | $SED "/\.${libext}$/d; $lo2o" | $NL2SP`
       fi
 
       # Eliminate all temporary directories.
       #for path in $notinst_path; do
-      #	lib_search_path=`$ECHO "X$lib_search_path " | $Xsed -e "s% $path % %g"`
-      #	deplibs=`$ECHO "X$deplibs " | $Xsed -e "s% -L$path % %g"`
-      #	dependency_libs=`$ECHO "X$dependency_libs " | $Xsed -e "s% -L$path % %g"`
+      #	lib_search_path=`$ECHO "$lib_search_path " | $SED "s% $path % %g"`
+      #	deplibs=`$ECHO "$deplibs " | $SED "s% -L$path % %g"`
+      #	dependency_libs=`$ECHO "$dependency_libs " | $SED "s% -L$path % %g"`
       #done
 
       if test -n "$xrpath"; then
 	# If the user specified any rpath flags, then add them.
 	temp_xrpath=
 	for libdir in $xrpath; do
-	  temp_xrpath="$temp_xrpath -R$libdir"
+	  func_replace_sysroot "$libdir"
+	  func_append temp_xrpath " -R$func_replace_sysroot_result"
 	  case "$finalize_rpath " in
 	  *" $libdir "*) ;;
-	  *) finalize_rpath="$finalize_rpath $libdir" ;;
+	  *) func_append finalize_rpath " $libdir" ;;
 	  esac
 	done
 	if test "$hardcode_into_libs" != yes || test "$build_old_libs" = yes; then
@@ -6466,7 +7588,7 @@
       for lib in $old_dlfiles; do
 	case " $dlprefiles $dlfiles " in
 	*" $lib "*) ;;
-	*) dlfiles="$dlfiles $lib" ;;
+	*) func_append dlfiles " $lib" ;;
 	esac
       done
 
@@ -6476,19 +7598,19 @@
       for lib in $old_dlprefiles; do
 	case "$dlprefiles " in
 	*" $lib "*) ;;
-	*) dlprefiles="$dlprefiles $lib" ;;
+	*) func_append dlprefiles " $lib" ;;
 	esac
       done
 
       if test "$build_libtool_libs" = yes; then
 	if test -n "$rpath"; then
 	  case $host in
-	  *-*-cygwin* | *-*-mingw* | *-*-pw32* | *-*-os2* | *-*-beos* | *-cegcc*)
+	  *-*-cygwin* | *-*-mingw* | *-*-pw32* | *-*-os2* | *-*-beos* | *-cegcc* | *-*-haiku*)
 	    # these systems don't actually have a c library (as such)!
 	    ;;
 	  *-*-rhapsody* | *-*-darwin1.[012])
 	    # Rhapsody C library is in the System framework
-	    deplibs="$deplibs System.ltframework"
+	    func_append deplibs " System.ltframework"
 	    ;;
 	  *-*-netbsd*)
 	    # Don't link with libc until the a.out ld.so is fixed.
@@ -6505,7 +7627,7 @@
 	  *)
 	    # Add libc to deplibs on all other systems if necessary.
 	    if test "$build_libtool_need_lc" = "yes"; then
-	      deplibs="$deplibs -lc"
+	      func_append deplibs " -lc"
 	    fi
 	    ;;
 	  esac
@@ -6554,7 +7676,7 @@
 		if test "X$allow_libtool_libs_with_static_runtimes" = "Xyes" ; then
 		  case " $predeps $postdeps " in
 		  *" $i "*)
-		    newdeplibs="$newdeplibs $i"
+		    func_append newdeplibs " $i"
 		    i=""
 		    ;;
 		  esac
@@ -6565,21 +7687,21 @@
 		  set dummy $deplib_matches; shift
 		  deplib_match=$1
 		  if test `expr "$ldd_output" : ".*$deplib_match"` -ne 0 ; then
-		    newdeplibs="$newdeplibs $i"
+		    func_append newdeplibs " $i"
 		  else
 		    droppeddeps=yes
-		    $ECHO
+		    echo
 		    $ECHO "*** Warning: dynamic linker does not accept needed library $i."
-		    $ECHO "*** I have the capability to make that library automatically link in when"
-		    $ECHO "*** you link to this library.  But I can only do this if you have a"
-		    $ECHO "*** shared version of the library, which I believe you do not have"
-		    $ECHO "*** because a test_compile did reveal that the linker did not use it for"
-		    $ECHO "*** its dynamic dependency list that programs get resolved with at runtime."
+		    echo "*** I have the capability to make that library automatically link in when"
+		    echo "*** you link to this library.  But I can only do this if you have a"
+		    echo "*** shared version of the library, which I believe you do not have"
+		    echo "*** because a test_compile did reveal that the linker did not use it for"
+		    echo "*** its dynamic dependency list that programs get resolved with at runtime."
 		  fi
 		fi
 		;;
 	      *)
-		newdeplibs="$newdeplibs $i"
+		func_append newdeplibs " $i"
 		;;
 	      esac
 	    done
@@ -6597,7 +7719,7 @@
 		  if test "X$allow_libtool_libs_with_static_runtimes" = "Xyes" ; then
 		    case " $predeps $postdeps " in
 		    *" $i "*)
-		      newdeplibs="$newdeplibs $i"
+		      func_append newdeplibs " $i"
 		      i=""
 		      ;;
 		    esac
@@ -6608,29 +7730,29 @@
 		    set dummy $deplib_matches; shift
 		    deplib_match=$1
 		    if test `expr "$ldd_output" : ".*$deplib_match"` -ne 0 ; then
-		      newdeplibs="$newdeplibs $i"
+		      func_append newdeplibs " $i"
 		    else
 		      droppeddeps=yes
-		      $ECHO
+		      echo
 		      $ECHO "*** Warning: dynamic linker does not accept needed library $i."
-		      $ECHO "*** I have the capability to make that library automatically link in when"
-		      $ECHO "*** you link to this library.  But I can only do this if you have a"
-		      $ECHO "*** shared version of the library, which you do not appear to have"
-		      $ECHO "*** because a test_compile did reveal that the linker did not use this one"
-		      $ECHO "*** as a dynamic dependency that programs can get resolved with at runtime."
+		      echo "*** I have the capability to make that library automatically link in when"
+		      echo "*** you link to this library.  But I can only do this if you have a"
+		      echo "*** shared version of the library, which you do not appear to have"
+		      echo "*** because a test_compile did reveal that the linker did not use this one"
+		      echo "*** as a dynamic dependency that programs can get resolved with at runtime."
 		    fi
 		  fi
 		else
 		  droppeddeps=yes
-		  $ECHO
+		  echo
 		  $ECHO "*** Warning!  Library $i is needed by this library but I was not able to"
-		  $ECHO "*** make it link in!  You will probably need to install it or some"
-		  $ECHO "*** library that it depends on before this library will be fully"
-		  $ECHO "*** functional.  Installing it before continuing would be even better."
+		  echo "*** make it link in!  You will probably need to install it or some"
+		  echo "*** library that it depends on before this library will be fully"
+		  echo "*** functional.  Installing it before continuing would be even better."
 		fi
 		;;
 	      *)
-		newdeplibs="$newdeplibs $i"
+		func_append newdeplibs " $i"
 		;;
 	      esac
 	    done
@@ -6647,15 +7769,27 @@
 	      if test "X$allow_libtool_libs_with_static_runtimes" = "Xyes" ; then
 		case " $predeps $postdeps " in
 		*" $a_deplib "*)
-		  newdeplibs="$newdeplibs $a_deplib"
+		  func_append newdeplibs " $a_deplib"
 		  a_deplib=""
 		  ;;
 		esac
 	      fi
 	      if test -n "$a_deplib" ; then
 		libname=`eval "\\$ECHO \"$libname_spec\""`
+		if test -n "$file_magic_glob"; then
+		  libnameglob=`func_echo_all "$libname" | $SED -e $file_magic_glob`
+		else
+		  libnameglob=$libname
+		fi
+		test "$want_nocaseglob" = yes && nocaseglob=`shopt -p nocaseglob`
 		for i in $lib_search_path $sys_lib_search_path $shlib_search_path; do
-		  potential_libs=`ls $i/$libname[.-]* 2>/dev/null`
+		  if test "$want_nocaseglob" = yes; then
+		    shopt -s nocaseglob
+		    potential_libs=`ls $i/$libnameglob[.-]* 2>/dev/null`
+		    $nocaseglob
+		  else
+		    potential_libs=`ls $i/$libnameglob[.-]* 2>/dev/null`
+		  fi
 		  for potent_lib in $potential_libs; do
 		      # Follow soft links.
 		      if ls -lLd "$potent_lib" 2>/dev/null |
@@ -6672,13 +7806,13 @@
 			potliblink=`ls -ld $potlib | ${SED} 's/.* -> //'`
 			case $potliblink in
 			[\\/]* | [A-Za-z]:[\\/]*) potlib="$potliblink";;
-			*) potlib=`$ECHO "X$potlib" | $Xsed -e 's,[^/]*$,,'`"$potliblink";;
+			*) potlib=`$ECHO "$potlib" | $SED 's,[^/]*$,,'`"$potliblink";;
 			esac
 		      done
 		      if eval $file_magic_cmd \"\$potlib\" 2>/dev/null |
 			 $SED -e 10q |
 			 $EGREP "$file_magic_regex" > /dev/null; then
-			newdeplibs="$newdeplibs $a_deplib"
+			func_append newdeplibs " $a_deplib"
 			a_deplib=""
 			break 2
 		      fi
@@ -6687,12 +7821,12 @@
 	      fi
 	      if test -n "$a_deplib" ; then
 		droppeddeps=yes
-		$ECHO
+		echo
 		$ECHO "*** Warning: linker path does not have real file for library $a_deplib."
-		$ECHO "*** I have the capability to make that library automatically link in when"
-		$ECHO "*** you link to this library.  But I can only do this if you have a"
-		$ECHO "*** shared version of the library, which you do not appear to have"
-		$ECHO "*** because I did check the linker path looking for a file starting"
+		echo "*** I have the capability to make that library automatically link in when"
+		echo "*** you link to this library.  But I can only do this if you have a"
+		echo "*** shared version of the library, which you do not appear to have"
+		echo "*** because I did check the linker path looking for a file starting"
 		if test -z "$potlib" ; then
 		  $ECHO "*** with $libname but no candidates were found. (...for file magic test)"
 		else
@@ -6703,7 +7837,7 @@
 	      ;;
 	    *)
 	      # Add a -L argument.
-	      newdeplibs="$newdeplibs $a_deplib"
+	      func_append newdeplibs " $a_deplib"
 	      ;;
 	    esac
 	  done # Gone through all deplibs.
@@ -6719,7 +7853,7 @@
 	      if test "X$allow_libtool_libs_with_static_runtimes" = "Xyes" ; then
 		case " $predeps $postdeps " in
 		*" $a_deplib "*)
-		  newdeplibs="$newdeplibs $a_deplib"
+		  func_append newdeplibs " $a_deplib"
 		  a_deplib=""
 		  ;;
 		esac
@@ -6730,9 +7864,9 @@
 		  potential_libs=`ls $i/$libname[.-]* 2>/dev/null`
 		  for potent_lib in $potential_libs; do
 		    potlib="$potent_lib" # see symlink-check above in file_magic test
-		    if eval "\$ECHO \"X$potent_lib\"" 2>/dev/null | $Xsed -e 10q | \
+		    if eval "\$ECHO \"$potent_lib\"" 2>/dev/null | $SED 10q | \
 		       $EGREP "$match_pattern_regex" > /dev/null; then
-		      newdeplibs="$newdeplibs $a_deplib"
+		      func_append newdeplibs " $a_deplib"
 		      a_deplib=""
 		      break 2
 		    fi
@@ -6741,12 +7875,12 @@
 	      fi
 	      if test -n "$a_deplib" ; then
 		droppeddeps=yes
-		$ECHO
+		echo
 		$ECHO "*** Warning: linker path does not have real file for library $a_deplib."
-		$ECHO "*** I have the capability to make that library automatically link in when"
-		$ECHO "*** you link to this library.  But I can only do this if you have a"
-		$ECHO "*** shared version of the library, which you do not appear to have"
-		$ECHO "*** because I did check the linker path looking for a file starting"
+		echo "*** I have the capability to make that library automatically link in when"
+		echo "*** you link to this library.  But I can only do this if you have a"
+		echo "*** shared version of the library, which you do not appear to have"
+		echo "*** because I did check the linker path looking for a file starting"
 		if test -z "$potlib" ; then
 		  $ECHO "*** with $libname but no candidates were found. (...for regex pattern test)"
 		else
@@ -6757,32 +7891,32 @@
 	      ;;
 	    *)
 	      # Add a -L argument.
-	      newdeplibs="$newdeplibs $a_deplib"
+	      func_append newdeplibs " $a_deplib"
 	      ;;
 	    esac
 	  done # Gone through all deplibs.
 	  ;;
 	none | unknown | *)
 	  newdeplibs=""
-	  tmp_deplibs=`$ECHO "X $deplibs" | $Xsed \
-	      -e 's/ -lc$//' -e 's/ -[LR][^ ]*//g'`
+	  tmp_deplibs=`$ECHO " $deplibs" | $SED 's/ -lc$//; s/ -[LR][^ ]*//g'`
 	  if test "X$allow_libtool_libs_with_static_runtimes" = "Xyes" ; then
 	    for i in $predeps $postdeps ; do
 	      # can't use Xsed below, because $i might contain '/'
-	      tmp_deplibs=`$ECHO "X $tmp_deplibs" | $Xsed -e "s,$i,,"`
+	      tmp_deplibs=`$ECHO " $tmp_deplibs" | $SED "s,$i,,"`
 	    done
 	  fi
-	  if $ECHO "X $tmp_deplibs" | $Xsed -e 's/[	 ]//g' |
-	     $GREP . >/dev/null; then
-	    $ECHO
+	  case $tmp_deplibs in
+	  *[!\	\ ]*)
+	    echo
 	    if test "X$deplibs_check_method" = "Xnone"; then
-	      $ECHO "*** Warning: inter-library dependencies are not supported in this platform."
+	      echo "*** Warning: inter-library dependencies are not supported in this platform."
 	    else
-	      $ECHO "*** Warning: inter-library dependencies are not known to be supported."
+	      echo "*** Warning: inter-library dependencies are not known to be supported."
 	    fi
-	    $ECHO "*** All declared inter-library dependencies are being dropped."
+	    echo "*** All declared inter-library dependencies are being dropped."
 	    droppeddeps=yes
-	  fi
+	    ;;
+	  esac
 	  ;;
 	esac
 	versuffix=$versuffix_save
@@ -6794,23 +7928,23 @@
 	case $host in
 	*-*-rhapsody* | *-*-darwin1.[012])
 	  # On Rhapsody replace the C library with the System framework
-	  newdeplibs=`$ECHO "X $newdeplibs" | $Xsed -e 's/ -lc / System.ltframework /'`
+	  newdeplibs=`$ECHO " $newdeplibs" | $SED 's/ -lc / System.ltframework /'`
 	  ;;
 	esac
 
 	if test "$droppeddeps" = yes; then
 	  if test "$module" = yes; then
-	    $ECHO
-	    $ECHO "*** Warning: libtool could not satisfy all declared inter-library"
+	    echo
+	    echo "*** Warning: libtool could not satisfy all declared inter-library"
 	    $ECHO "*** dependencies of module $libname.  Therefore, libtool will create"
-	    $ECHO "*** a static module, that should work as long as the dlopening"
-	    $ECHO "*** application is linked with the -dlopen flag."
+	    echo "*** a static module, that should work as long as the dlopening"
+	    echo "*** application is linked with the -dlopen flag."
 	    if test -z "$global_symbol_pipe"; then
-	      $ECHO
-	      $ECHO "*** However, this would only work if libtool was able to extract symbol"
-	      $ECHO "*** lists from a program, using \`nm' or equivalent, but libtool could"
-	      $ECHO "*** not find such a program.  So, this module is probably useless."
-	      $ECHO "*** \`nm' from GNU binutils and a full rebuild may help."
+	      echo
+	      echo "*** However, this would only work if libtool was able to extract symbol"
+	      echo "*** lists from a program, using \`nm' or equivalent, but libtool could"
+	      echo "*** not find such a program.  So, this module is probably useless."
+	      echo "*** \`nm' from GNU binutils and a full rebuild may help."
 	    fi
 	    if test "$build_old_libs" = no; then
 	      oldlibs="$output_objdir/$libname.$libext"
@@ -6820,16 +7954,16 @@
 	      build_libtool_libs=no
 	    fi
 	  else
-	    $ECHO "*** The inter-library dependencies that have been dropped here will be"
-	    $ECHO "*** automatically added whenever a program is linked with this library"
-	    $ECHO "*** or is declared to -dlopen it."
+	    echo "*** The inter-library dependencies that have been dropped here will be"
+	    echo "*** automatically added whenever a program is linked with this library"
+	    echo "*** or is declared to -dlopen it."
 
 	    if test "$allow_undefined" = no; then
-	      $ECHO
-	      $ECHO "*** Since this library must not contain undefined symbols,"
-	      $ECHO "*** because either the platform does not support them or"
-	      $ECHO "*** it was explicitly requested with -no-undefined,"
-	      $ECHO "*** libtool will only create a static version of it."
+	      echo
+	      echo "*** Since this library must not contain undefined symbols,"
+	      echo "*** because either the platform does not support them or"
+	      echo "*** it was explicitly requested with -no-undefined,"
+	      echo "*** libtool will only create a static version of it."
 	      if test "$build_old_libs" = no; then
 		oldlibs="$output_objdir/$libname.$libext"
 		build_libtool_libs=module
@@ -6846,9 +7980,9 @@
       # Time to change all our "foo.ltframework" stuff back to "-framework foo"
       case $host in
 	*-*-darwin*)
-	  newdeplibs=`$ECHO "X $newdeplibs" | $Xsed -e 's% \([^ $]*\).ltframework% -framework \1%g'`
-	  new_inherited_linker_flags=`$ECHO "X $new_inherited_linker_flags" | $Xsed -e 's% \([^ $]*\).ltframework% -framework \1%g'`
-	  deplibs=`$ECHO "X $deplibs" | $Xsed -e 's% \([^ $]*\).ltframework% -framework \1%g'`
+	  newdeplibs=`$ECHO " $newdeplibs" | $SED 's% \([^ $]*\).ltframework% -framework \1%g'`
+	  new_inherited_linker_flags=`$ECHO " $new_inherited_linker_flags" | $SED 's% \([^ $]*\).ltframework% -framework \1%g'`
+	  deplibs=`$ECHO " $deplibs" | $SED 's% \([^ $]*\).ltframework% -framework \1%g'`
 	  ;;
       esac
 
@@ -6861,7 +7995,7 @@
 	*)
 	  case " $deplibs " in
 	  *" -L$path/$objdir "*)
-	    new_libs="$new_libs -L$path/$objdir" ;;
+	    func_append new_libs " -L$path/$objdir" ;;
 	  esac
 	  ;;
 	esac
@@ -6871,10 +8005,10 @@
 	-L*)
 	  case " $new_libs " in
 	  *" $deplib "*) ;;
-	  *) new_libs="$new_libs $deplib" ;;
+	  *) func_append new_libs " $deplib" ;;
 	  esac
 	  ;;
-	*) new_libs="$new_libs $deplib" ;;
+	*) func_append new_libs " $deplib" ;;
 	esac
       done
       deplibs="$new_libs"
@@ -6891,10 +8025,12 @@
 	  hardcode_libdirs=
 	  dep_rpath=
 	  rpath="$finalize_rpath"
-	  test "$mode" != relink && rpath="$compile_rpath$rpath"
+	  test "$opt_mode" != relink && rpath="$compile_rpath$rpath"
 	  for libdir in $rpath; do
 	    if test -n "$hardcode_libdir_flag_spec"; then
 	      if test -n "$hardcode_libdir_separator"; then
+		func_replace_sysroot "$libdir"
+		libdir=$func_replace_sysroot_result
 		if test -z "$hardcode_libdirs"; then
 		  hardcode_libdirs="$libdir"
 		else
@@ -6903,18 +8039,18 @@
 		  *"$hardcode_libdir_separator$libdir$hardcode_libdir_separator"*)
 		    ;;
 		  *)
-		    hardcode_libdirs="$hardcode_libdirs$hardcode_libdir_separator$libdir"
+		    func_append hardcode_libdirs "$hardcode_libdir_separator$libdir"
 		    ;;
 		  esac
 		fi
 	      else
 		eval flag=\"$hardcode_libdir_flag_spec\"
-		dep_rpath="$dep_rpath $flag"
+		func_append dep_rpath " $flag"
 	      fi
 	    elif test -n "$runpath_var"; then
 	      case "$perm_rpath " in
 	      *" $libdir "*) ;;
-	      *) perm_rpath="$perm_rpath $libdir" ;;
+	      *) func_apped perm_rpath " $libdir" ;;
 	      esac
 	    fi
 	  done
@@ -6932,7 +8068,7 @@
 	    # We should set the runpath_var.
 	    rpath=
 	    for dir in $perm_rpath; do
-	      rpath="$rpath$dir:"
+	      func_append rpath "$dir:"
 	    done
 	    eval "$runpath_var='$rpath\$$runpath_var'; export $runpath_var"
 	  fi
@@ -6940,7 +8076,7 @@
 	fi
 
 	shlibpath="$finalize_shlibpath"
-	test "$mode" != relink && shlibpath="$compile_shlibpath$shlibpath"
+	test "$opt_mode" != relink && shlibpath="$compile_shlibpath$shlibpath"
 	if test -n "$shlibpath"; then
 	  eval "$shlibpath_var='$shlibpath\$$shlibpath_var'; export $shlibpath_var"
 	fi
@@ -6966,18 +8102,18 @@
 	linknames=
 	for link
 	do
-	  linknames="$linknames $link"
+	  func_append linknames " $link"
 	done
 
 	# Use standard objects if they are pic
-	test -z "$pic_flag" && libobjs=`$ECHO "X$libobjs" | $SP2NL | $Xsed -e "$lo2o" | $NL2SP`
+	test -z "$pic_flag" && libobjs=`$ECHO "$libobjs" | $SP2NL | $SED "$lo2o" | $NL2SP`
 	test "X$libobjs" = "X " && libobjs=
 
 	delfiles=
 	if test -n "$export_symbols" && test -n "$include_expsyms"; then
 	  $opt_dry_run || cp "$export_symbols" "$output_objdir/$libname.uexp"
 	  export_symbols="$output_objdir/$libname.uexp"
-	  delfiles="$delfiles $export_symbols"
+	  func_append delfiles " $export_symbols"
 	fi
 
 	orig_export_symbols=
@@ -7008,13 +8144,45 @@
 	    $opt_dry_run || $RM $export_symbols
 	    cmds=$export_symbols_cmds
 	    save_ifs="$IFS"; IFS='~'
-	    for cmd in $cmds; do
+	    for cmd1 in $cmds; do
 	      IFS="$save_ifs"
-	      eval cmd=\"$cmd\"
-	      func_len " $cmd"
-	      len=$func_len_result
-	      if test "$len" -lt "$max_cmd_len" || test "$max_cmd_len" -le -1; then
+	      # Take the normal branch if the nm_file_list_spec branch
+	      # doesn't work or if tool conversion is not needed.
+	      case $nm_file_list_spec~$to_tool_file_cmd in
+		*~func_convert_file_noop | *~func_convert_file_msys_to_w32 | ~*)
+		  try_normal_branch=yes
+		  eval cmd=\"$cmd1\"
+		  func_len " $cmd"
+		  len=$func_len_result
+		  ;;
+		*)
+		  try_normal_branch=no
+		  ;;
+	      esac
+	      if test "$try_normal_branch" = yes \
+		 && { test "$len" -lt "$max_cmd_len" \
+		      || test "$max_cmd_len" -le -1; }
+	      then
+		func_show_eval "$cmd" 'exit $?'
+		skipped_export=false
+	      elif test -n "$nm_file_list_spec"; then
+		func_basename "$output"
+		output_la=$func_basename_result
+		save_libobjs=$libobjs
+		save_output=$output
+		output=${output_objdir}/${output_la}.nm
+		func_to_tool_file "$output"
+		libobjs=$nm_file_list_spec$func_to_tool_file_result
+		func_append delfiles " $output"
+		func_verbose "creating $NM input file list: $output"
+		for obj in $save_libobjs; do
+		  func_to_tool_file "$obj"
+		  $ECHO "$func_to_tool_file_result"
+		done > "$output"
+		eval cmd=\"$cmd1\"
 		func_show_eval "$cmd" 'exit $?'
+		output=$save_output
+		libobjs=$save_libobjs
 		skipped_export=false
 	      else
 		# The command line is too long to execute in one step.
@@ -7036,7 +8204,7 @@
 	if test -n "$export_symbols" && test -n "$include_expsyms"; then
 	  tmp_export_symbols="$export_symbols"
 	  test -n "$orig_export_symbols" && tmp_export_symbols="$orig_export_symbols"
-	  $opt_dry_run || eval '$ECHO "X$include_expsyms" | $Xsed | $SP2NL >> "$tmp_export_symbols"'
+	  $opt_dry_run || eval '$ECHO "$include_expsyms" | $SP2NL >> "$tmp_export_symbols"'
 	fi
 
 	if test "X$skipped_export" != "X:" && test -n "$orig_export_symbols"; then
@@ -7048,7 +8216,7 @@
 	  # global variables. join(1) would be nice here, but unfortunately
 	  # isn't a blessed tool.
 	  $opt_dry_run || $SED -e '/[ ,]DATA/!d;s,\(.*\)\([ \,].*\),s|^\1$|\1\2|,' < $export_symbols > $output_objdir/$libname.filter
-	  delfiles="$delfiles $export_symbols $output_objdir/$libname.filter"
+	  func_append delfiles " $export_symbols $output_objdir/$libname.filter"
 	  export_symbols=$output_objdir/$libname.def
 	  $opt_dry_run || $SED -f $output_objdir/$libname.filter < $orig_export_symbols > $export_symbols
 	fi
@@ -7058,7 +8226,7 @@
 	  case " $convenience " in
 	  *" $test_deplib "*) ;;
 	  *)
-	    tmp_deplibs="$tmp_deplibs $test_deplib"
+	    func_append tmp_deplibs " $test_deplib"
 	    ;;
 	  esac
 	done
@@ -7078,21 +8246,21 @@
 	    test "X$libobjs" = "X " && libobjs=
 	  else
 	    gentop="$output_objdir/${outputname}x"
-	    generated="$generated $gentop"
+	    func_append generated " $gentop"
 
 	    func_extract_archives $gentop $convenience
-	    libobjs="$libobjs $func_extract_archives_result"
+	    func_append libobjs " $func_extract_archives_result"
 	    test "X$libobjs" = "X " && libobjs=
 	  fi
 	fi
 
 	if test "$thread_safe" = yes && test -n "$thread_safe_flag_spec"; then
 	  eval flag=\"$thread_safe_flag_spec\"
-	  linker_flags="$linker_flags $flag"
+	  func_append linker_flags " $flag"
 	fi
 
 	# Make a backup of the uninstalled library when relinking
-	if test "$mode" = relink; then
+	if test "$opt_mode" = relink; then
 	  $opt_dry_run || eval '(cd $output_objdir && $RM ${realname}U && $MV $realname ${realname}U)' || exit $?
 	fi
 
@@ -7137,7 +8305,8 @@
 	    save_libobjs=$libobjs
 	  fi
 	  save_output=$output
-	  output_la=`$ECHO "X$output" | $Xsed -e "$basename"`
+	  func_basename "$output"
+	  output_la=$func_basename_result
 
 	  # Clear the reloadable object creation command queue and
 	  # initialize k to one.
@@ -7150,13 +8319,16 @@
 	  if test -n "$save_libobjs" && test "X$skipped_export" != "X:" && test "$with_gnu_ld" = yes; then
 	    output=${output_objdir}/${output_la}.lnkscript
 	    func_verbose "creating GNU ld script: $output"
-	    $ECHO 'INPUT (' > $output
+	    echo 'INPUT (' > $output
 	    for obj in $save_libobjs
 	    do
-	      $ECHO "$obj" >> $output
+	      func_to_tool_file "$obj"
+	      $ECHO "$func_to_tool_file_result" >> $output
 	    done
-	    $ECHO ')' >> $output
-	    delfiles="$delfiles $output"
+	    echo ')' >> $output
+	    func_append delfiles " $output"
+	    func_to_tool_file "$output"
+	    output=$func_to_tool_file_result
 	  elif test -n "$save_libobjs" && test "X$skipped_export" != "X:" && test "X$file_list_spec" != X; then
 	    output=${output_objdir}/${output_la}.lnk
 	    func_verbose "creating linker input file list: $output"
@@ -7170,10 +8342,12 @@
 	    fi
 	    for obj
 	    do
-	      $ECHO "$obj" >> $output
+	      func_to_tool_file "$obj"
+	      $ECHO "$func_to_tool_file_result" >> $output
 	    done
-	    delfiles="$delfiles $output"
-	    output=$firstobj\"$file_list_spec$output\"
+	    func_append delfiles " $output"
+	    func_to_tool_file "$output"
+	    output=$firstobj\"$file_list_spec$func_to_tool_file_result\"
 	  else
 	    if test -n "$save_libobjs"; then
 	      func_verbose "creating reloadable object files..."
@@ -7197,17 +8371,19 @@
 		  # command to the queue.
 		  if test "$k" -eq 1 ; then
 		    # The first file doesn't have a previous command to add.
-		    eval concat_cmds=\"$reload_cmds $objlist $last_robj\"
+		    reload_objs=$objlist
+		    eval concat_cmds=\"$reload_cmds\"
 		  else
 		    # All subsequent reloadable object files will link in
 		    # the last one created.
-		    eval concat_cmds=\"\$concat_cmds~$reload_cmds $objlist $last_robj~\$RM $last_robj\"
+		    reload_objs="$objlist $last_robj"
+		    eval concat_cmds=\"\$concat_cmds~$reload_cmds~\$RM $last_robj\"
 		  fi
 		  last_robj=$output_objdir/$output_la-${k}.$objext
 		  func_arith $k + 1
 		  k=$func_arith_result
 		  output=$output_objdir/$output_la-${k}.$objext
-		  objlist=$obj
+		  objlist=" $obj"
 		  func_len " $last_robj"
 		  func_arith $len0 + $func_len_result
 		  len=$func_arith_result
@@ -7217,11 +8393,12 @@
 	      # reloadable object file.  All subsequent reloadable object
 	      # files will link in the last one created.
 	      test -z "$concat_cmds" || concat_cmds=$concat_cmds~
-	      eval concat_cmds=\"\${concat_cmds}$reload_cmds $objlist $last_robj\"
+	      reload_objs="$objlist $last_robj"
+	      eval concat_cmds=\"\${concat_cmds}$reload_cmds\"
 	      if test -n "$last_robj"; then
 	        eval concat_cmds=\"\${concat_cmds}~\$RM $last_robj\"
 	      fi
-	      delfiles="$delfiles $output"
+	      func_append delfiles " $output"
 
 	    else
 	      output=
@@ -7255,7 +8432,7 @@
 		lt_exit=$?
 
 		# Restore the uninstalled library and exit
-		if test "$mode" = relink; then
+		if test "$opt_mode" = relink; then
 		  ( cd "$output_objdir" && \
 		    $RM "${realname}T" && \
 		    $MV "${realname}U" "$realname" )
@@ -7276,7 +8453,7 @@
 	    if test -n "$export_symbols" && test -n "$include_expsyms"; then
 	      tmp_export_symbols="$export_symbols"
 	      test -n "$orig_export_symbols" && tmp_export_symbols="$orig_export_symbols"
-	      $opt_dry_run || eval '$ECHO "X$include_expsyms" | $Xsed | $SP2NL >> "$tmp_export_symbols"'
+	      $opt_dry_run || eval '$ECHO "$include_expsyms" | $SP2NL >> "$tmp_export_symbols"'
 	    fi
 
 	    if test -n "$orig_export_symbols"; then
@@ -7288,7 +8465,7 @@
 	      # global variables. join(1) would be nice here, but unfortunately
 	      # isn't a blessed tool.
 	      $opt_dry_run || $SED -e '/[ ,]DATA/!d;s,\(.*\)\([ \,].*\),s|^\1$|\1\2|,' < $export_symbols > $output_objdir/$libname.filter
-	      delfiles="$delfiles $export_symbols $output_objdir/$libname.filter"
+	      func_append delfiles " $export_symbols $output_objdir/$libname.filter"
 	      export_symbols=$output_objdir/$libname.def
 	      $opt_dry_run || $SED -f $output_objdir/$libname.filter < $orig_export_symbols > $export_symbols
 	    fi
@@ -7329,10 +8506,10 @@
 	# Add any objects from preloaded convenience libraries
 	if test -n "$dlprefiles"; then
 	  gentop="$output_objdir/${outputname}x"
-	  generated="$generated $gentop"
+	  func_append generated " $gentop"
 
 	  func_extract_archives $gentop $dlprefiles
-	  libobjs="$libobjs $func_extract_archives_result"
+	  func_append libobjs " $func_extract_archives_result"
 	  test "X$libobjs" = "X " && libobjs=
 	fi
 
@@ -7348,7 +8525,7 @@
 	    lt_exit=$?
 
 	    # Restore the uninstalled library and exit
-	    if test "$mode" = relink; then
+	    if test "$opt_mode" = relink; then
 	      ( cd "$output_objdir" && \
 	        $RM "${realname}T" && \
 		$MV "${realname}U" "$realname" )
@@ -7360,7 +8537,7 @@
 	IFS="$save_ifs"
 
 	# Restore the uninstalled library and exit
-	if test "$mode" = relink; then
+	if test "$opt_mode" = relink; then
 	  $opt_dry_run || eval '(cd $output_objdir && $RM ${realname}T && $MV $realname ${realname}T && $MV ${realname}U $realname)' || exit $?
 
 	  if test -n "$convenience"; then
@@ -7441,18 +8618,21 @@
       if test -n "$convenience"; then
 	if test -n "$whole_archive_flag_spec"; then
 	  eval tmp_whole_archive_flags=\"$whole_archive_flag_spec\"
-	  reload_conv_objs=$reload_objs\ `$ECHO "X$tmp_whole_archive_flags" | $Xsed -e 's|,| |g'`
+	  reload_conv_objs=$reload_objs\ `$ECHO "$tmp_whole_archive_flags" | $SED 's|,| |g'`
 	else
 	  gentop="$output_objdir/${obj}x"
-	  generated="$generated $gentop"
+	  func_append generated " $gentop"
 
 	  func_extract_archives $gentop $convenience
 	  reload_conv_objs="$reload_objs $func_extract_archives_result"
 	fi
       fi
 
+      # If we're not building shared, we need to use non_pic_objs
+      test "$build_libtool_libs" != yes && libobjs="$non_pic_objects"
+
       # Create the old-style object.
-      reload_objs="$objs$old_deplibs "`$ECHO "X$libobjs" | $SP2NL | $Xsed -e '/\.'${libext}$'/d' -e '/\.lib$/d' -e "$lo2o" | $NL2SP`" $reload_conv_objs" ### testsuite: skip nested quoting test
+      reload_objs="$objs$old_deplibs "`$ECHO "$libobjs" | $SP2NL | $SED "/\.${libext}$/d; /\.lib$/d; $lo2o" | $NL2SP`" $reload_conv_objs" ### testsuite: skip nested quoting test
 
       output="$obj"
       func_execute_cmds "$reload_cmds" 'exit $?'
@@ -7512,8 +8692,8 @@
       case $host in
       *-*-rhapsody* | *-*-darwin1.[012])
 	# On Rhapsody replace the C library is the System framework
-	compile_deplibs=`$ECHO "X $compile_deplibs" | $Xsed -e 's/ -lc / System.ltframework /'`
-	finalize_deplibs=`$ECHO "X $finalize_deplibs" | $Xsed -e 's/ -lc / System.ltframework /'`
+	compile_deplibs=`$ECHO " $compile_deplibs" | $SED 's/ -lc / System.ltframework /'`
+	finalize_deplibs=`$ECHO " $finalize_deplibs" | $SED 's/ -lc / System.ltframework /'`
 	;;
       esac
 
@@ -7524,14 +8704,14 @@
 	if test "$tagname" = CXX ; then
 	  case ${MACOSX_DEPLOYMENT_TARGET-10.0} in
 	    10.[0123])
-	      compile_command="$compile_command ${wl}-bind_at_load"
-	      finalize_command="$finalize_command ${wl}-bind_at_load"
+	      func_append compile_command " ${wl}-bind_at_load"
+	      func_append finalize_command " ${wl}-bind_at_load"
 	    ;;
 	  esac
 	fi
 	# Time to change all our "foo.ltframework" stuff back to "-framework foo"
-	compile_deplibs=`$ECHO "X $compile_deplibs" | $Xsed -e 's% \([^ $]*\).ltframework% -framework \1%g'`
-	finalize_deplibs=`$ECHO "X $finalize_deplibs" | $Xsed -e 's% \([^ $]*\).ltframework% -framework \1%g'`
+	compile_deplibs=`$ECHO " $compile_deplibs" | $SED 's% \([^ $]*\).ltframework% -framework \1%g'`
+	finalize_deplibs=`$ECHO " $finalize_deplibs" | $SED 's% \([^ $]*\).ltframework% -framework \1%g'`
 	;;
       esac
 
@@ -7545,7 +8725,7 @@
 	*)
 	  case " $compile_deplibs " in
 	  *" -L$path/$objdir "*)
-	    new_libs="$new_libs -L$path/$objdir" ;;
+	    func_append new_libs " -L$path/$objdir" ;;
 	  esac
 	  ;;
 	esac
@@ -7555,17 +8735,17 @@
 	-L*)
 	  case " $new_libs " in
 	  *" $deplib "*) ;;
-	  *) new_libs="$new_libs $deplib" ;;
+	  *) func_append new_libs " $deplib" ;;
 	  esac
 	  ;;
-	*) new_libs="$new_libs $deplib" ;;
+	*) func_append new_libs " $deplib" ;;
 	esac
       done
       compile_deplibs="$new_libs"
 
 
-      compile_command="$compile_command $compile_deplibs"
-      finalize_command="$finalize_command $finalize_deplibs"
+      func_append compile_command " $compile_deplibs"
+      func_append finalize_command " $finalize_deplibs"
 
       if test -n "$rpath$xrpath"; then
 	# If the user specified any rpath flags, then add them.
@@ -7573,7 +8753,7 @@
 	  # This is the magic to use -rpath.
 	  case "$finalize_rpath " in
 	  *" $libdir "*) ;;
-	  *) finalize_rpath="$finalize_rpath $libdir" ;;
+	  *) func_append finalize_rpath " $libdir" ;;
 	  esac
 	done
       fi
@@ -7592,18 +8772,18 @@
 	      *"$hardcode_libdir_separator$libdir$hardcode_libdir_separator"*)
 		;;
 	      *)
-		hardcode_libdirs="$hardcode_libdirs$hardcode_libdir_separator$libdir"
+		func_append hardcode_libdirs "$hardcode_libdir_separator$libdir"
 		;;
 	      esac
 	    fi
 	  else
 	    eval flag=\"$hardcode_libdir_flag_spec\"
-	    rpath="$rpath $flag"
+	    func_append rpath " $flag"
 	  fi
 	elif test -n "$runpath_var"; then
 	  case "$perm_rpath " in
 	  *" $libdir "*) ;;
-	  *) perm_rpath="$perm_rpath $libdir" ;;
+	  *) func_append perm_rpath " $libdir" ;;
 	  esac
 	fi
 	case $host in
@@ -7612,12 +8792,12 @@
 	  case :$dllsearchpath: in
 	  *":$libdir:"*) ;;
 	  ::) dllsearchpath=$libdir;;
-	  *) dllsearchpath="$dllsearchpath:$libdir";;
+	  *) func_append dllsearchpath ":$libdir";;
 	  esac
 	  case :$dllsearchpath: in
 	  *":$testbindir:"*) ;;
 	  ::) dllsearchpath=$testbindir;;
-	  *) dllsearchpath="$dllsearchpath:$testbindir";;
+	  *) func_append dllsearchpath ":$testbindir";;
 	  esac
 	  ;;
 	esac
@@ -7643,18 +8823,18 @@
 	      *"$hardcode_libdir_separator$libdir$hardcode_libdir_separator"*)
 		;;
 	      *)
-		hardcode_libdirs="$hardcode_libdirs$hardcode_libdir_separator$libdir"
+		func_append hardcode_libdirs "$hardcode_libdir_separator$libdir"
 		;;
 	      esac
 	    fi
 	  else
 	    eval flag=\"$hardcode_libdir_flag_spec\"
-	    rpath="$rpath $flag"
+	    func_append rpath " $flag"
 	  fi
 	elif test -n "$runpath_var"; then
 	  case "$finalize_perm_rpath " in
 	  *" $libdir "*) ;;
-	  *) finalize_perm_rpath="$finalize_perm_rpath $libdir" ;;
+	  *) func_append finalize_perm_rpath " $libdir" ;;
 	  esac
 	fi
       done
@@ -7668,8 +8848,8 @@
 
       if test -n "$libobjs" && test "$build_old_libs" = yes; then
 	# Transform all the library objects into standard objects.
-	compile_command=`$ECHO "X$compile_command" | $SP2NL | $Xsed -e "$lo2o" | $NL2SP`
-	finalize_command=`$ECHO "X$finalize_command" | $SP2NL | $Xsed -e "$lo2o" | $NL2SP`
+	compile_command=`$ECHO "$compile_command" | $SP2NL | $SED "$lo2o" | $NL2SP`
+	finalize_command=`$ECHO "$finalize_command" | $SP2NL | $SED "$lo2o" | $NL2SP`
       fi
 
       func_generate_dlsyms "$outputname" "@PROGRAM@" "no"
@@ -7681,15 +8861,15 @@
 
       wrappers_required=yes
       case $host in
+      *cegcc* | *mingw32ce*)
+        # Disable wrappers for cegcc and mingw32ce hosts, we are cross compiling anyway.
+        wrappers_required=no
+        ;;
       *cygwin* | *mingw* )
         if test "$build_libtool_libs" != yes; then
           wrappers_required=no
         fi
         ;;
-      *cegcc)
-        # Disable wrappers for cegcc, we are cross compiling anyway.
-        wrappers_required=no
-        ;;
       *)
         if test "$need_relink" = no || test "$build_libtool_libs" != yes; then
           wrappers_required=no
@@ -7698,13 +8878,19 @@
       esac
       if test "$wrappers_required" = no; then
 	# Replace the output file specification.
-	compile_command=`$ECHO "X$compile_command" | $Xsed -e 's%@OUTPUT@%'"$output"'%g'`
+	compile_command=`$ECHO "$compile_command" | $SED 's%@OUTPUT@%'"$output"'%g'`
 	link_command="$compile_command$compile_rpath"
 
 	# We have no uninstalled library dependencies, so finalize right now.
 	exit_status=0
 	func_show_eval "$link_command" 'exit_status=$?'
 
+	if test -n "$postlink_cmds"; then
+	  func_to_tool_file "$output"
+	  postlink_cmds=`func_echo_all "$postlink_cmds" | $SED -e 's%@OUTPUT@%'"$output"'%g' -e 's%@TOOL_OUTPUT@%'"$func_to_tool_file_result"'%g'`
+	  func_execute_cmds "$postlink_cmds" 'exit $?'
+	fi
+
 	# Delete the generated files.
 	if test -f "$output_objdir/${outputname}S.${objext}"; then
 	  func_show_eval '$RM "$output_objdir/${outputname}S.${objext}"'
@@ -7727,7 +8913,7 @@
 	  # We should set the runpath_var.
 	  rpath=
 	  for dir in $perm_rpath; do
-	    rpath="$rpath$dir:"
+	    func_append rpath "$dir:"
 	  done
 	  compile_var="$runpath_var=\"$rpath\$$runpath_var\" "
 	fi
@@ -7735,7 +8921,7 @@
 	  # We should set the runpath_var.
 	  rpath=
 	  for dir in $finalize_perm_rpath; do
-	    rpath="$rpath$dir:"
+	    func_append rpath "$dir:"
 	  done
 	  finalize_var="$runpath_var=\"$rpath\$$runpath_var\" "
 	fi
@@ -7745,11 +8931,18 @@
 	# We don't need to create a wrapper script.
 	link_command="$compile_var$compile_command$compile_rpath"
 	# Replace the output file specification.
-	link_command=`$ECHO "X$link_command" | $Xsed -e 's%@OUTPUT@%'"$output"'%g'`
+	link_command=`$ECHO "$link_command" | $SED 's%@OUTPUT@%'"$output"'%g'`
 	# Delete the old output file.
 	$opt_dry_run || $RM $output
 	# Link the executable and exit
 	func_show_eval "$link_command" 'exit $?'
+
+	if test -n "$postlink_cmds"; then
+	  func_to_tool_file "$output"
+	  postlink_cmds=`func_echo_all "$postlink_cmds" | $SED -e 's%@OUTPUT@%'"$output"'%g' -e 's%@TOOL_OUTPUT@%'"$func_to_tool_file_result"'%g'`
+	  func_execute_cmds "$postlink_cmds" 'exit $?'
+	fi
+
 	exit $EXIT_SUCCESS
       fi
 
@@ -7764,7 +8957,7 @@
 	if test "$fast_install" != no; then
 	  link_command="$finalize_var$compile_command$finalize_rpath"
 	  if test "$fast_install" = yes; then
-	    relink_command=`$ECHO "X$compile_var$compile_command$compile_rpath" | $Xsed -e 's%@OUTPUT@%\$progdir/\$file%g'`
+	    relink_command=`$ECHO "$compile_var$compile_command$compile_rpath" | $SED 's%@OUTPUT@%\$progdir/\$file%g'`
 	  else
 	    # fast_install is set to needless
 	    relink_command=
@@ -7776,13 +8969,19 @@
       fi
 
       # Replace the output file specification.
-      link_command=`$ECHO "X$link_command" | $Xsed -e 's%@OUTPUT@%'"$output_objdir/$outputname"'%g'`
+      link_command=`$ECHO "$link_command" | $SED 's%@OUTPUT@%'"$output_objdir/$outputname"'%g'`
 
       # Delete the old output files.
       $opt_dry_run || $RM $output $output_objdir/$outputname $output_objdir/lt-$outputname
 
       func_show_eval "$link_command" 'exit $?'
 
+      if test -n "$postlink_cmds"; then
+	func_to_tool_file "$output_objdir/$outputname"
+	postlink_cmds=`func_echo_all "$postlink_cmds" | $SED -e 's%@OUTPUT@%'"$output_objdir/$outputname"'%g' -e 's%@TOOL_OUTPUT@%'"$func_to_tool_file_result"'%g'`
+	func_execute_cmds "$postlink_cmds" 'exit $?'
+      fi
+
       # Now create the wrapper script.
       func_verbose "creating $output"
 
@@ -7800,18 +8999,7 @@
 	  fi
 	done
 	relink_command="(cd `pwd`; $relink_command)"
-	relink_command=`$ECHO "X$relink_command" | $Xsed -e "$sed_quote_subst"`
-      fi
-
-      # Quote $ECHO for shipping.
-      if test "X$ECHO" = "X$SHELL $progpath --fallback-echo"; then
-	case $progpath in
-	[\\/]* | [A-Za-z]:[\\/]*) qecho="$SHELL $progpath --fallback-echo";;
-	*) qecho="$SHELL `pwd`/$progpath --fallback-echo";;
-	esac
-	qecho=`$ECHO "X$qecho" | $Xsed -e "$sed_quote_subst"`
-      else
-	qecho=`$ECHO "X$ECHO" | $Xsed -e "$sed_quote_subst"`
+	relink_command=`$ECHO "$relink_command" | $SED "$sed_quote_subst"`
       fi
 
       # Only actually do things if not in dry run mode.
@@ -7891,7 +9079,7 @@
 	else
 	  oldobjs="$old_deplibs $non_pic_objects"
 	  if test "$preload" = yes && test -f "$symfileobj"; then
-	    oldobjs="$oldobjs $symfileobj"
+	    func_append oldobjs " $symfileobj"
 	  fi
 	fi
 	addlibs="$old_convenience"
@@ -7899,10 +9087,10 @@
 
       if test -n "$addlibs"; then
 	gentop="$output_objdir/${outputname}x"
-	generated="$generated $gentop"
+	func_append generated " $gentop"
 
 	func_extract_archives $gentop $addlibs
-	oldobjs="$oldobjs $func_extract_archives_result"
+	func_append oldobjs " $func_extract_archives_result"
       fi
 
       # Do each command in the archive commands.
@@ -7913,10 +9101,10 @@
 	# Add any objects from preloaded convenience libraries
 	if test -n "$dlprefiles"; then
 	  gentop="$output_objdir/${outputname}x"
-	  generated="$generated $gentop"
+	  func_append generated " $gentop"
 
 	  func_extract_archives $gentop $dlprefiles
-	  oldobjs="$oldobjs $func_extract_archives_result"
+	  func_append oldobjs " $func_extract_archives_result"
 	fi
 
 	# POSIX demands no paths to be encoded in archives.  We have
@@ -7932,9 +9120,9 @@
 	    done | sort | sort -uc >/dev/null 2>&1); then
 	  :
 	else
-	  $ECHO "copying selected object files to avoid basename conflicts..."
+	  echo "copying selected object files to avoid basename conflicts..."
 	  gentop="$output_objdir/${outputname}x"
-	  generated="$generated $gentop"
+	  func_append generated " $gentop"
 	  func_mkdir_p "$gentop"
 	  save_oldobjs=$oldobjs
 	  oldobjs=
@@ -7958,9 +9146,9 @@
 		esac
 	      done
 	      func_show_eval "ln $obj $gentop/$newobj || cp $obj $gentop/$newobj"
-	      oldobjs="$oldobjs $gentop/$newobj"
+	      func_append oldobjs " $gentop/$newobj"
 	      ;;
-	    *) oldobjs="$oldobjs $obj" ;;
+	    *) func_append oldobjs " $obj" ;;
 	    esac
 	  done
 	fi
@@ -7970,6 +9158,16 @@
 	len=$func_len_result
 	if test "$len" -lt "$max_cmd_len" || test "$max_cmd_len" -le -1; then
 	  cmds=$old_archive_cmds
+	elif test -n "$archiver_list_spec"; then
+	  func_verbose "using command file archive linking..."
+	  for obj in $oldobjs
+	  do
+	    func_to_tool_file "$obj"
+	    $ECHO "$func_to_tool_file_result"
+	  done > $output_objdir/$libname.libcmd
+	  func_to_tool_file "$output_objdir/$libname.libcmd"
+	  oldobjs=" $archiver_list_spec$func_to_tool_file_result"
+	  cmds=$old_archive_cmds
 	else
 	  # the command line is too long to link in one step, link in parts
 	  func_verbose "using piecewise archive linking..."
@@ -8043,7 +9241,7 @@
       done
       # Quote the link command for shipping.
       relink_command="(cd `pwd`; $SHELL $progpath $preserve_args --mode=relink $libtool_args @inst_prefix_dir@)"
-      relink_command=`$ECHO "X$relink_command" | $Xsed -e "$sed_quote_subst"`
+      relink_command=`$ECHO "$relink_command" | $SED "$sed_quote_subst"`
       if test "$hardcode_automatic" = yes ; then
 	relink_command=
       fi
@@ -8066,9 +9264,19 @@
 		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $deplib`
 		test -z "$libdir" && \
 		  func_fatal_error "\`$deplib' is not a valid libtool archive"
-		newdependency_libs="$newdependency_libs $libdir/$name"
+		func_append newdependency_libs " ${lt_sysroot:+=}$libdir/$name"
+		;;
+	      -L*)
+		func_stripname -L '' "$deplib"
+		func_replace_sysroot "$func_stripname_result"
+		func_append newdependency_libs " -L$func_replace_sysroot_result"
 		;;
-	      *) newdependency_libs="$newdependency_libs $deplib" ;;
+	      -R*)
+		func_stripname -R '' "$deplib"
+		func_replace_sysroot "$func_stripname_result"
+		func_append newdependency_libs " -R$func_replace_sysroot_result"
+		;;
+	      *) func_append newdependency_libs " $deplib" ;;
 	      esac
 	    done
 	    dependency_libs="$newdependency_libs"
@@ -8082,9 +9290,9 @@
 		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $lib`
 		test -z "$libdir" && \
 		  func_fatal_error "\`$lib' is not a valid libtool archive"
-		newdlfiles="$newdlfiles $libdir/$name"
+		func_append newdlfiles " ${lt_sysroot:+=}$libdir/$name"
 		;;
-	      *) newdlfiles="$newdlfiles $lib" ;;
+	      *) func_append newdlfiles " $lib" ;;
 	      esac
 	    done
 	    dlfiles="$newdlfiles"
@@ -8101,7 +9309,7 @@
 		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $lib`
 		test -z "$libdir" && \
 		  func_fatal_error "\`$lib' is not a valid libtool archive"
-		newdlprefiles="$newdlprefiles $libdir/$name"
+		func_append newdlprefiles " ${lt_sysroot:+=}$libdir/$name"
 		;;
 	      esac
 	    done
@@ -8113,7 +9321,7 @@
 		[\\/]* | [A-Za-z]:[\\/]*) abs="$lib" ;;
 		*) abs=`pwd`"/$lib" ;;
 	      esac
-	      newdlfiles="$newdlfiles $abs"
+	      func_append newdlfiles " $abs"
 	    done
 	    dlfiles="$newdlfiles"
 	    newdlprefiles=
@@ -8122,15 +9330,33 @@
 		[\\/]* | [A-Za-z]:[\\/]*) abs="$lib" ;;
 		*) abs=`pwd`"/$lib" ;;
 	      esac
-	      newdlprefiles="$newdlprefiles $abs"
+	      func_append newdlprefiles " $abs"
 	    done
 	    dlprefiles="$newdlprefiles"
 	  fi
 	  $RM $output
 	  # place dlname in correct position for cygwin
+	  # In fact, it would be nice if we could use this code for all target
+	  # systems that can't hard-code library paths into their executables
+	  # and that have no shared library path variable independent of PATH,
+	  # but it turns out we can't easily determine that from inspecting
+	  # libtool variables, so we have to hard-code the OSs to which it
+	  # applies here; at the moment, that means platforms that use the PE
+	  # object format with DLL files.  See the long comment at the top of
+	  # tests/bindir.at for full details.
 	  tdlname=$dlname
 	  case $host,$output,$installed,$module,$dlname in
-	    *cygwin*,*lai,yes,no,*.dll | *mingw*,*lai,yes,no,*.dll | *cegcc*,*lai,yes,no,*.dll) tdlname=../bin/$dlname ;;
+	    *cygwin*,*lai,yes,no,*.dll | *mingw*,*lai,yes,no,*.dll | *cegcc*,*lai,yes,no,*.dll)
+	      # If a -bindir argument was supplied, place the dll there.
+	      if test "x$bindir" != x ;
+	      then
+		func_relative_path "$install_libdir" "$bindir"
+		tdlname=$func_relative_path_result$dlname
+	      else
+		# Otherwise fall back on heuristic.
+		tdlname=../bin/$dlname
+	      fi
+	      ;;
 	  esac
 	  $ECHO > $output "\
 # $outputname - a libtool library file
@@ -8189,7 +9415,7 @@
     exit $EXIT_SUCCESS
 }
 
-{ test "$mode" = link || test "$mode" = relink; } &&
+{ test "$opt_mode" = link || test "$opt_mode" = relink; } &&
     func_mode_link ${1+"$@"}
 
 
@@ -8209,9 +9435,9 @@
     for arg
     do
       case $arg in
-      -f) RM="$RM $arg"; rmforce=yes ;;
-      -*) RM="$RM $arg" ;;
-      *) files="$files $arg" ;;
+      -f) func_append RM " $arg"; rmforce=yes ;;
+      -*) func_append RM " $arg" ;;
+      *) func_append files " $arg" ;;
       esac
     done
 
@@ -8220,24 +9446,23 @@
 
     rmdirs=
 
-    origobjdir="$objdir"
     for file in $files; do
       func_dirname "$file" "" "."
       dir="$func_dirname_result"
       if test "X$dir" = X.; then
-	objdir="$origobjdir"
+	odir="$objdir"
       else
-	objdir="$dir/$origobjdir"
+	odir="$dir/$objdir"
       fi
       func_basename "$file"
       name="$func_basename_result"
-      test "$mode" = uninstall && objdir="$dir"
+      test "$opt_mode" = uninstall && odir="$dir"
 
-      # Remember objdir for removal later, being careful to avoid duplicates
-      if test "$mode" = clean; then
+      # Remember odir for removal later, being careful to avoid duplicates
+      if test "$opt_mode" = clean; then
 	case " $rmdirs " in
-	  *" $objdir "*) ;;
-	  *) rmdirs="$rmdirs $objdir" ;;
+	  *" $odir "*) ;;
+	  *) func_append rmdirs " $odir" ;;
 	esac
       fi
 
@@ -8263,18 +9488,17 @@
 
 	  # Delete the libtool libraries and symlinks.
 	  for n in $library_names; do
-	    rmfiles="$rmfiles $objdir/$n"
+	    func_append rmfiles " $odir/$n"
 	  done
-	  test -n "$old_library" && rmfiles="$rmfiles $objdir/$old_library"
+	  test -n "$old_library" && func_append rmfiles " $odir/$old_library"
 
-	  case "$mode" in
+	  case "$opt_mode" in
 	  clean)
-	    case "  $library_names " in
-	    # "  " in the beginning catches empty $dlname
+	    case " $library_names " in
 	    *" $dlname "*) ;;
-	    *) rmfiles="$rmfiles $objdir/$dlname" ;;
+	    *) test -n "$dlname" && func_append rmfiles " $odir/$dlname" ;;
 	    esac
-	    test -n "$libdir" && rmfiles="$rmfiles $objdir/$name $objdir/${name}i"
+	    test -n "$libdir" && func_append rmfiles " $odir/$name $odir/${name}i"
 	    ;;
 	  uninstall)
 	    if test -n "$library_names"; then
@@ -8302,19 +9526,19 @@
 	  # Add PIC object to the list of files to remove.
 	  if test -n "$pic_object" &&
 	     test "$pic_object" != none; then
-	    rmfiles="$rmfiles $dir/$pic_object"
+	    func_append rmfiles " $dir/$pic_object"
 	  fi
 
 	  # Add non-PIC object to the list of files to remove.
 	  if test -n "$non_pic_object" &&
 	     test "$non_pic_object" != none; then
-	    rmfiles="$rmfiles $dir/$non_pic_object"
+	    func_append rmfiles " $dir/$non_pic_object"
 	  fi
 	fi
 	;;
 
       *)
-	if test "$mode" = clean ; then
+	if test "$opt_mode" = clean ; then
 	  noexename=$name
 	  case $file in
 	  *.exe)
@@ -8324,7 +9548,7 @@
 	    noexename=$func_stripname_result
 	    # $file with .exe has already been added to rmfiles,
 	    # add $file without .exe
-	    rmfiles="$rmfiles $file"
+	    func_append rmfiles " $file"
 	    ;;
 	  esac
 	  # Do a test to see if this is a libtool program.
@@ -8333,7 +9557,7 @@
 	      func_ltwrapper_scriptname "$file"
 	      relink_command=
 	      func_source $func_ltwrapper_scriptname_result
-	      rmfiles="$rmfiles $func_ltwrapper_scriptname_result"
+	      func_append rmfiles " $func_ltwrapper_scriptname_result"
 	    else
 	      relink_command=
 	      func_source $dir/$noexename
@@ -8341,12 +9565,12 @@
 
 	    # note $name still contains .exe if it was in $file originally
 	    # as does the version of $file that was added into $rmfiles
-	    rmfiles="$rmfiles $objdir/$name $objdir/${name}S.${objext}"
+	    func_append rmfiles " $odir/$name $odir/${name}S.${objext}"
 	    if test "$fast_install" = yes && test -n "$relink_command"; then
-	      rmfiles="$rmfiles $objdir/lt-$name"
+	      func_append rmfiles " $odir/lt-$name"
 	    fi
 	    if test "X$noexename" != "X$name" ; then
-	      rmfiles="$rmfiles $objdir/lt-${noexename}.c"
+	      func_append rmfiles " $odir/lt-${noexename}.c"
 	    fi
 	  fi
 	fi
@@ -8354,7 +9578,6 @@
       esac
       func_show_eval "$RM $rmfiles" 'exit_status=1'
     done
-    objdir="$origobjdir"
 
     # Try to remove the ${objdir}s in the directories where we deleted files
     for dir in $rmdirs; do
@@ -8366,16 +9589,16 @@
     exit $exit_status
 }
 
-{ test "$mode" = uninstall || test "$mode" = clean; } &&
+{ test "$opt_mode" = uninstall || test "$opt_mode" = clean; } &&
     func_mode_uninstall ${1+"$@"}
 
-test -z "$mode" && {
+test -z "$opt_mode" && {
   help="$generic_help"
   func_fatal_help "you must specify a MODE"
 }
 
 test -z "$exec_cmd" && \
-  func_fatal_help "invalid operation mode \`$mode'"
+  func_fatal_help "invalid operation mode \`$opt_mode'"
 
 if test -n "$exec_cmd"; then
   eval exec "$exec_cmd"
diff -ru trousers-0.3.8-orig/Makefile.in trousers-0.3.8/Makefile.in
--- trousers-0.3.8-orig/Makefile.in	2011-12-24 06:19:33.000000000 +0000
+++ trousers-0.3.8/Makefile.in	2012-02-14 20:35:05.901388058 +0000
@@ -119,6 +119,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -128,8 +129,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -144,6 +143,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -160,9 +160,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -175,6 +172,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -207,7 +205,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/man/Makefile.in trousers-0.3.8/man/Makefile.in
--- trousers-0.3.8-orig/man/Makefile.in	2011-12-24 06:19:32.000000000 +0000
+++ trousers-0.3.8/man/Makefile.in	2012-02-14 20:35:05.902050691 +0000
@@ -103,6 +103,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -112,8 +113,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -128,6 +127,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -144,9 +144,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -159,6 +156,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -191,7 +189,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/man/man3/Makefile.in trousers-0.3.8/man/man3/Makefile.in
--- trousers-0.3.8-orig/man/man3/Makefile.in	2011-12-24 06:19:32.000000000 +0000
+++ trousers-0.3.8/man/man3/Makefile.in	2012-02-14 20:35:05.902719223 +0000
@@ -88,6 +88,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -97,8 +98,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -113,6 +112,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -129,9 +129,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -144,6 +141,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -176,7 +174,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/man/man5/Makefile.in trousers-0.3.8/man/man5/Makefile.in
--- trousers-0.3.8-orig/man/man5/Makefile.in	2011-12-24 06:19:32.000000000 +0000
+++ trousers-0.3.8/man/man5/Makefile.in	2012-02-14 20:35:05.903346581 +0000
@@ -89,6 +89,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -98,8 +99,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -114,6 +113,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -130,9 +130,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -145,6 +142,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -177,7 +175,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
Only in trousers-0.3.8-orig/man/man5: tcsd.conf.5
diff -ru trousers-0.3.8-orig/man/man8/Makefile.in trousers-0.3.8/man/man8/Makefile.in
--- trousers-0.3.8-orig/man/man8/Makefile.in	2011-12-24 06:19:32.000000000 +0000
+++ trousers-0.3.8/man/man8/Makefile.in	2012-02-14 20:35:05.904224771 +0000
@@ -89,6 +89,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -98,8 +99,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -114,6 +113,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -130,9 +130,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -145,6 +142,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -177,7 +175,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
Only in trousers-0.3.8-orig/man/man8: tcsd.8
diff -ru trousers-0.3.8-orig/man/man8/tcsd.8.in trousers-0.3.8/man/man8/tcsd.8.in
--- trousers-0.3.8-orig/man/man8/tcsd.8.in	2011-07-01 14:35:01.000000000 +0000
+++ trousers-0.3.8/man/man8/tcsd.8.in	2012-02-14 20:35:05.904913758 +0000
@@ -79,12 +79,32 @@
 the TCS and stays valid across application lifetimes, \fBtcsd\fR restarts and 
 system resets. Data registered in system PS stays valid until an application 
 requests that it be removed. User PS files are by default stored as 
-/var/tpm/user.{pid} and the system PS file by default is /var/tpm/system.data. 
-The system PS file is initially created when ownership of the TPM is first 
-taken.
+/var/user/$USERNAME/tpm/userps/user.data and the system PS file by default is
+/var/tpm/system/system.data.  The system PS file is initially created when 
+ownership of the TPM is first taken.
+.PP
+\fB/var/tpm/system/system.data\fR
+.ad
+.RS 4n
+Contains the system PS (persistent storage) data controlled by the TCS.  By default,
+the SRK key is installed in PS and does not require owner authorization to use.  If the
+TPM has previously been provisioned and owner-auth is required to load the SRK,
+then the /var/tpm/system/system.data.auth file should be moved to 
+/var/tpm/system/system.data before starting the TCS (See NOTES).
+.RE
+.sp
+.PP
+\fB/var/tpm/system/system.data.auth\fR
+.ad
+.RS 4n
+This is the default PS data file to use if the TPM has been previously 
+configured to require owner-auth to access the SRK.  Copy this file 
+to /var/tpm/system/system.data prior to starting the TCS if owner-auth is
+needed, otherwise this file can be ignored.
+.RE
 
 .SH "CONFIGURATION"
-\fBtcsd\fR configuration is stored by default in /etc/tcsd.conf
+\fBtcsd\fR configuration is stored by default in /etc/security/tcsd.conf
 
 .SH "DEBUG OUTPUT"
 If TrouSerS has been compiled with debugging enabled, the debugging output
@@ -93,8 +113,9 @@
 .SH "DEVICE DRIVERS"
 .PP
 \fBtcsd\fR is compatible with the IBM Research TPM device driver available
-from http://www.research.ibm.com/gsal/tcpa and the TPM device driver available
-from http://sf.net/projects/tmpdd
+from http://www.research.ibm.com/gsal/tcpa and the TPM device driver for 
+Linux available from http://sf.net/projects/tmpdd.  It is also compatible 
+with the TPM device driver for Solaris which is available in the driver/crypto/tpm package.
 
 .SH "CONFORMING TO"
 .PP
@@ -103,7 +124,23 @@
 
 .SH "SEE ALSO"
 .PP
-\fBtcsd.conf\fR(5)
+\fBtcsd.conf\fR(5), \fBsvcadm\fR(1M), \fBsmf\fR(5)
+
+.SH "NOTES"
+.sp
+.LP
+The \fBtcsd\fR service is managed by the service management facility, \fBsmf\fR(5), under
+the service identifier:
+.sp
+.in +2
+.nf
+svc:/application/security/tcsd:default
+.fi
+.in -2
+.sp
+.LP
+Administrative actions on this service, such as enabling, disabling, or requesting restart, can be
+performed using \fBsvcadm\fR(1M). The service's status can be queried using the \fBsvcs\fR(1) command.
 
 .SH "AUTHOR"
 Kent Yoder
diff -ru trousers-0.3.8-orig/src/include/Makefile.in trousers-0.3.8/src/include/Makefile.in
--- trousers-0.3.8-orig/src/include/Makefile.in	2011-12-24 06:19:32.000000000 +0000
+++ trousers-0.3.8/src/include/Makefile.in	2012-02-14 20:35:05.905658791 +0000
@@ -93,6 +93,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -102,8 +103,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -118,6 +117,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -134,9 +134,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -149,6 +146,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -181,7 +179,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/src/include/tcsd.h trousers-0.3.8/src/include/tcsd.h
--- trousers-0.3.8-orig/src/include/tcsd.h	2011-07-01 14:35:01.000000000 +0000
+++ trousers-0.3.8/src/include/tcsd.h	2012-02-14 20:35:05.905939545 +0000
@@ -48,15 +48,24 @@
 							of this TCS System */
 };
 
+#ifdef SOLARIS
+#define TCSD_DEFAULT_CONFIG_FILE	"/etc/security/tcsd.conf"
+#else
 #define TCSD_DEFAULT_CONFIG_FILE	ETC_PREFIX "/tcsd.conf"
+#endif
 extern char *tcsd_config_file;
 
 #define TSS_USER_NAME		"tss"
 #define TSS_GROUP_NAME		"tss"
 
 #define TCSD_DEFAULT_MAX_THREADS	10
+#ifdef SOLARIS
+#define TCSD_DEFAULT_SYSTEM_PS_FILE   "/var/tpm/system/system.data"
+#define TCSD_DEFAULT_SYSTEM_PS_DIR    "/var/tpm/system"
+#else
 #define TCSD_DEFAULT_SYSTEM_PS_FILE	VAR_PREFIX "/lib/tpm/system.data"
 #define TCSD_DEFAULT_SYSTEM_PS_DIR	VAR_PREFIX "/lib/tpm"
+#endif
 #define TCSD_DEFAULT_FIRMWARE_LOG_FILE	"/sys/kernel/security/tpm0/binary_bios_measurements"
 #define TCSD_DEFAULT_KERNEL_LOG_FILE	"/sys/kernel/security/ima/binary_runtime_measurements"
 #define TCSD_DEFAULT_FIRMWARE_PCRS	0x00000000
diff -ru trousers-0.3.8-orig/src/include/trousers_types.h trousers-0.3.8/src/include/trousers_types.h
--- trousers-0.3.8-orig/src/include/trousers_types.h	2010-09-10 19:50:27.000000000 +0000
+++ trousers-0.3.8/src/include/trousers_types.h	2012-02-14 20:35:05.906206092 +0000
@@ -118,9 +118,9 @@
 	BYTE *encData;
 } TSS_KEY;
 
-#if (defined (__linux) || defined (linux) || defined (SOLARIS) || defined (__GLIBC__))
+#if (defined (__linux) || defined (linux) || defined (__GLIBC__))
 #define BSD_CONST
-#elif (defined (__OpenBSD__) || defined (__FreeBSD__))
+#elif (defined (__OpenBSD__) || defined (__FreeBSD__) || defined(SOLARIS))
 #define BSD_CONST const
 #endif
 
diff -ru trousers-0.3.8-orig/src/include/tspps.h trousers-0.3.8/src/include/tspps.h
--- trousers-0.3.8-orig/src/include/tspps.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tspps.h	2012-02-14 20:35:05.906473796 +0000
@@ -13,13 +13,17 @@
 
 #define PASSWD_BUFSIZE		4096
 
+#ifdef SOLARIS
+#define TSS_USER_PS_DIR		"/var/user/"
+#else
 #define TSS_USER_PS_DIR		".trousers"
+#endif
 #define TSS_USER_PS_FILE	"user.data"
 
 TSS_RESULT	   get_file(int *);
 int		   put_file(int);
-inline TSS_RESULT  read_data(int, void *, UINT32);
-inline TSS_RESULT  write_data(int, void *, UINT32);
+TSS_RESULT         read_data(int, void *, UINT32);
+TSS_RESULT         write_data(int, void *, UINT32);
 UINT32		   psfile_get_num_keys(int);
 TSS_RESULT	   psfile_get_parent_uuid_by_uuid(int, TSS_UUID *, TSS_UUID *);
 TSS_RESULT	   psfile_remove_key_by_uuid(int, TSS_UUID *);
diff -ru trousers-0.3.8-orig/src/include/tss/compat11b.h trousers-0.3.8/src/include/tss/compat11b.h
--- trousers-0.3.8-orig/src/include/tss/compat11b.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/compat11b.h	2012-02-14 20:35:05.906963148 +0000
@@ -1,200 +1,200 @@
-
-#ifndef __COMPAT11B_H__
-#define __COMPAT11B_H__
-
-#include <tss/tpm.h>
-
-#define TCPA_Vendor_Specific32  TPM_Vendor_Specific32
-#define TCPA_Vendor_Specific8   TPM_Vendor_Specific8
-
-typedef TSS_UNICODE             UNICODE;
-typedef TPM_DIGEST              TCPA_DIGEST;
-typedef TPM_NONCE               TCPA_NONCE;
-typedef TPM_NONCE               TCPA_SALT_NONCE;
-typedef TPM_PUBKEY              TCPA_PUBKEY;
-typedef TPM_SECRET              TCPA_SECRET;
-typedef TPM_KEY                 TCPA_KEY;
-typedef TPM_DIRVALUE            TCPA_DIRVALUE;
-typedef TPM_COMMAND_CODE        TCPA_COMMAND_CODE;
-typedef TPM_BOUND_DATA          TCPA_BOUND_DATA;
-typedef TPM_STRUCT_VER          TCPA_VERSION;
-typedef TPM_RESULT              TCPA_RESULT;
-typedef TPM_PAYLOAD_TYPE        TCPA_PAYLOAD_TYPE;
-typedef TPM_STORE_PRIVKEY       TCPA_STORE_PRIVKEY;
-typedef TPM_CHOSENID_HASH       TCPA_CHOSENID_HASH;
-typedef TPM_SYMMETRIC_KEY       TCPA_SYMMETRIC_KEY;
-typedef TPM_PCR_INFO            TCPA_PCR_INFO;
-typedef TPM_PCR_SELECTION       TCPA_PCR_SELECTION;
-typedef TPM_STORED_DATA         TCPA_STORED_DATA;
-typedef TPM_SEALED_DATA         TCPA_SEALED_DATA;
-typedef TPM_KEY_FLAGS           TCPA_KEY_FLAGS;
-typedef TPM_KEY_PARMS           TCPA_KEY_PARMS;
-typedef TPM_STORE_PUBKEY        TCPA_STORE_PUBKEY;
-typedef TPM_MIGRATIONKEYAUTH    TCPA_MIGRATIONKEYAUTH;
-typedef TPM_RSA_KEY_PARMS       TCPA_RSA_KEY_PARMS;
-typedef TPM_CERTIFY_INFO        TCPA_CERTIFY_INFO;
-typedef TPM_STORE_ASYMKEY       TCPA_STORE_ASYMKEY;
-typedef TPM_ENCAUTH             TCPA_ENCAUTH;
-typedef TPM_PCRINDEX            TCPA_PCRINDEX;
-typedef TPM_PCRVALUE            TCPA_PCRVALUE;
-typedef TPM_DIRINDEX            TCPA_DIRINDEX;
-typedef TPM_PROTOCOL_ID         TCPA_PROTOCOL_ID;
-typedef TPM_ALGORITHM_ID        TCPA_ALGORITHM_ID;
-typedef TPM_ENTITY_TYPE         TCPA_ENTITY_TYPE;
-typedef TPM_CAPABILITY_AREA     TCPA_CAPABILITY_AREA;
-typedef TPM_HMAC                TCPA_HMAC;
-typedef TPM_MIGRATE_SCHEME      TCPA_MIGRATE_SCHEME;
-typedef TPM_PHYSICAL_PRESENCE   TCPA_PHYSICAL_PRESENCE;
-typedef TPM_KEY_HANDLE          TCPA_KEY_HANDLE;
-typedef TPM_KEY_HANDLE_LIST     TCPA_KEY_HANDLE_LIST;
-typedef TPM_PCR_COMPOSITE       TCPA_PCR_COMPOSITE;
-typedef TPM_AUTH_DATA_USAGE     TCPA_AUTH_DATA_USAGE;
-typedef TPM_AUTHDATA            TCPA_AUTHDATA;
-typedef TPM_KEY_USAGE           TCPA_KEY_USAGE;
-typedef TPM_COMPOSITE_HASH      TCPA_COMPOSITE_HASH;
-typedef TPM_QUOTE_INFO          TCPA_QUOTE_INFO;
-typedef TPM_TAG                 TCPA_TAG;
-typedef TPM_ENC_SCHEME          TCPA_ENC_SCHEME;
-typedef TPM_SIG_SCHEME          TCPA_SIG_SCHEME;
-typedef TPM_STARTUP_TYPE        TCPA_STARTUP_TYPE;
-typedef TPM_AUTHHANDLE          TCPA_AUTHHANDLE;
-typedef TPM_SYM_CA_ATTESTATION  TCPA_SYM_CA_ATTESTATION;
-typedef TPM_ASYM_CA_CONTENTS    TCPA_ASYM_CA_CONTENTS;
-typedef TPM_IDENTITY_REQ        TCPA_IDENTITY_REQ;
-typedef TPM_IDENTITY_PROOF      TCPA_IDENTITY_PROOF;
-
-// These were removed from the 1.2 TPM spec
-typedef UINT32                  TCPA_ENCHANDLE;
-typedef UINT32                  TCPA_EVENTTYPE;
-typedef struct tdTCPA_AUDIT_EVENT {
-    TCPA_COMMAND_CODE ordinal;
-    TCPA_RESULT       returncode;
-} TCPA_AUDIT_EVENT;
-
-#define TCPA_SHA1_160_HASH_LEN          TPM_SHA1_160_HASH_LEN
-#define TCPA_SHA1BASED_NONCE_LEN        TPM_SHA1BASED_NONCE_LEN
-
-#define redirection             TSS_KEYFLAG_REDIRECTION
-#define migratable              TSS_KEYFLAG_MIGRATABLE
-#define volatileKey             TSS_KEYFLAG_VOLATILEKEY
-
-#define TCPA_ET_KEYHANDLE       TPM_ET_KEYHANDLE
-#define TCPA_ET_KEY             TPM_ET_KEY
-#define TCPA_ET_OWNER           TPM_ET_OWNER
-#define TCPA_ET_SRK             TPM_ET_SRK
-#define TCPA_ET_DATA            TPM_ET_DATA
-
-#define TCPA_PID_OIAP           TPM_PID_OIAP
-#define TCPA_PID_OSAP           TPM_PID_OSAP
-#define TCPA_PID_ADIP           TPM_PID_ADIP
-#define TCPA_PID_ADCP           TPM_PID_ADCP
-#define TCPA_PID_OWNER          TPM_PID_OWNER
-
-#define TCPA_PT_ASYM            TPM_PT_ASYM
-#define TCPA_PT_BIND            TPM_PT_BIND
-#define TCPA_PT_MIGRATE         TPM_PT_MIGRATE
-#define TCPA_PT_MAINT           TPM_PT_MAINT
-#define TCPA_PT_SEAL            TPM_PT_SEAL
-
-#define TCPA_CAP_ALG            TPM_CAP_ALG
-#define TCPA_CAP_ORD            TPM_CAP_ORD
-#define TCPA_CAP_PID            TPM_CAP_PID
-#define TCPA_CAP_FLAG           TPM_CAP_FLAG
-#define TCPA_CAP_VERSION        TPM_CAP_VERSION
-#define TCPA_CAP_PROPERTY       TPM_CAP_PROPERTY
-#define TCPA_CAP_KEY_HANDLE     TPM_CAP_KEY_HANDLE
-#define TCPA_CAP_CHECK_LOADED   TPM_CAP_CHECK_LOADED
-
-#define TCPA_ALG_RSA            TPM_ALG_RSA
-#define TCPA_ALG_DES            TPM_ALG_DES
-#define TCPA_ALG_3DES           TPM_ALG_3DES
-#define TCPA_ALG_SHA            TPM_ALG_SHA
-#define TCPA_ALG_HMAC           TPM_ALG_HMAC
-#define TCPA_ALG_AES            TPM_ALG_AES
-
-#define TCPA_PROTECTED_ORDINAL          TPM_PROTECTED_ORDINAL
-#define TCPA_UNPROTECTED_ORDINAL        TPM_UNPROTECTED_ORDINAL
-#define TCPA_CONNECTION_ORDINAL         TPM_CONNECTION_ORDINAL
-
-#define TCPA_PROTECTED_COMMAND          TPM_PROTECTED_COMMAND
-#define TCPA_UNPROTECTED_COMMAND        TPM_UNPROTECTED_COMMAND
-#define TCPA_CONNECTION_COMMAND         TPM_CONNECTION_COMMAND
-#define TCPA_VENDOR_COMMAND             TPM_VENDOR_COMMAND
-
-#define TCPA_MAIN               TPM_MAIN
-#define TCPA_PC                 TPM_PC
-#define TCPA_PDA                TPM_PDA
-#define TCPA_CELL_PHONE         TPM_CELL_PHONE
-
-#define TCPA_MS_MIGRATE                 TPM_MS_MIGRATE
-#define TCPA_MS_REWRAP                  TPM_MS_REWRAP
-#define TCPA_MS_MAINT                   TPM_MS_MAINT
-
-#define TCPA_ES_NONE                    TPM_ES_NONE
-#define TCPA_ES_RSAESPKCSv15            TPM_ES_RSAESPKCSv15
-#define TCPA_ES_RSAESOAEP_SHA1_MGF1     TPM_ES_RSAESOAEP_SHA1_MGF1
-
-#define TCPA_SS_NONE                    TPM_SS_NONE
-#define TCPA_SS_RSASSAPKCS1v15_SHA1     TPM_SS_RSASSAPKCS1v15_SHA1
-#define TCPA_SS_RSASSAPKCS1v15_DER      TPM_SS_RSASSAPKCS1v15_DER
-#define	TCPA_SS_RSASSAPKCS1v15_INFO	TPM_SS_RSASSAPKCS1v15_INFO
-
-#define TCPA_PHYSICAL_PRESENCE_LIFETIME_LOCK    TPM_PHYSICAL_PRESENCE_LIFETIME_LOCK
-#define TCPA_PHYSICAL_PRESENCE_HW_ENABLE        TPM_PHYSICAL_PRESENCE_HW_ENABLE
-#define TCPA_PHYSICAL_PRESENCE_CMD_ENABLE       TPM_PHYSICAL_PRESENCE_CMD_ENABLE
-#define TCPA_PHYSICAL_PRESENCE_LOCK             TPM_PHYSICAL_PRESENCE_LOCK
-#define TCPA_PHYSICAL_PRESENCE_PRESENT          TPM_PHYSICAL_PRESENCE_PRESENT
-#define TCPA_PHYSICAL_PRESENCE_NOTPRESENT       TPM_PHYSICAL_PRESENCE_NOTPRESENT
-
-#define TCPA_SUCCESS                    TPM_SUCCESS
-#define TCPA_E_BASE                     TPM_E_BASE
-#define TCPA_E_NON_FATAL                TPM_E_NON_FATAL
-#define TCPA_E_AUTHFAIL                 TPM_E_AUTHFAIL
-#define TCPA_E_BAD_PARAMETER            TPM_E_BAD_PARAMETER
-#define TCPA_E_BADINDEX                 TPM_E_BADINDEX
-#define TCPA_E_AUDITFAILURE             TPM_E_AUDITFAILURE
-#define TCPA_E_CLEAR_DISABLED           TPM_E_CLEAR_DISABLED
-#define TCPA_E_DEACTIVATED              TPM_E_DEACTIVATED
-#define TCPA_E_DISABLED                 TPM_E_DISABLED
-#define TCPA_E_DISABLED_CMD             TPM_E_DISABLED_CMD
-#define TCPA_E_FAIL                     TPM_E_FAIL
-#define TCPA_E_INACTIVE                 TPM_E_BAD_ORDINAL
-#define TCPA_E_INSTALL_DISABLED         TPM_E_INSTALL_DISABLED
-#define TCPA_E_INVALID_KEYHANDLE        TPM_E_INVALID_KEYHANDLE
-#define TCPA_E_KEYNOTFOUND              TPM_E_KEYNOTFOUND
-#define TCPA_E_NEED_SELFTEST            TPM_E_INAPPROPRIATE_ENC
-#define TCPA_E_MIGRATEFAIL              TPM_E_MIGRATEFAIL
-#define TCPA_E_NO_PCR_INFO              TPM_E_INVALID_PCR_INFO
-#define TCPA_E_NOSPACE                  TPM_E_NOSPACE
-#define TCPA_E_NOSRK                    TPM_E_NOSRK
-#define TCPA_E_NOTSEALED_BLOB           TPM_E_NOTSEALED_BLOB
-#define TCPA_E_OWNER_SET                TPM_E_OWNER_SET
-#define TCPA_E_RESOURCES                TPM_E_RESOURCES
-#define TCPA_E_SHORTRANDOM              TPM_E_SHORTRANDOM
-#define TCPA_E_SIZE                     TPM_E_SIZE
-#define TCPA_E_WRONGPCRVAL              TPM_E_WRONGPCRVAL
-#define TCPA_E_BAD_PARAM_SIZE           TPM_E_BAD_PARAM_SIZE
-#define TCPA_E_SHA_THREAD               TPM_E_SHA_THREAD
-#define TCPA_E_SHA_ERROR                TPM_E_SHA_ERROR
-#define TCPA_E_FAILEDSELFTEST           TPM_E_FAILEDSELFTEST
-#define TCPA_E_AUTH2FAIL                TPM_E_AUTH2FAIL
-#define TCPA_E_BADTAG                   TPM_E_BADTAG
-#define TCPA_E_IOERROR                  TPM_E_IOERROR
-#define TCPA_E_ENCRYPT_ERROR            TPM_E_ENCRYPT_ERROR
-#define TCPA_E_DECRYPT_ERROR            TPM_E_DECRYPT_ERROR
-#define TCPA_E_INVALID_AUTHHANDLE       TPM_E_INVALID_AUTHHANDLE
-#define TCPA_E_NO_ENDORSEMENT           TPM_E_NO_ENDORSEMENT
-#define TCPA_E_INVALID_KEYUSAGE         TPM_E_INVALID_KEYUSAGE
-#define TCPA_E_WRONG_ENTITYTYPE         TPM_E_WRONG_ENTITYTYPE
-#define TCPA_E_INVALID_POSTINIT         TPM_E_INVALID_POSTINIT
-#define TCPA_E_INAPPROPRIATE_SIG        TPM_E_INAPPROPRIATE_SIG
-#define TCPA_E_BAD_KEY_PROPERTY         TPM_E_BAD_KEY_PROPERTY
-#define TCPA_E_BAD_MIGRATION            TPM_E_BAD_MIGRATION
-#define TCPA_E_BAD_SCHEME               TPM_E_BAD_SCHEME
-#define TCPA_E_BAD_DATASIZE             TPM_E_BAD_DATASIZE
-#define TCPA_E_BAD_MODE                 TPM_E_BAD_MODE
-#define TCPA_E_BAD_PRESENCE             TPM_E_BAD_PRESENCE
-#define TCPA_E_BAD_VERSION              TPM_E_BAD_VERSION
-#define TCPA_E_RETRY                    TPM_E_RETRY
-
-#endif
+
+#ifndef __COMPAT11B_H__
+#define __COMPAT11B_H__
+
+#include <tss/tpm.h>
+
+#define TCPA_Vendor_Specific32  TPM_Vendor_Specific32
+#define TCPA_Vendor_Specific8   TPM_Vendor_Specific8
+
+typedef TSS_UNICODE             UNICODE;
+typedef TPM_DIGEST              TCPA_DIGEST;
+typedef TPM_NONCE               TCPA_NONCE;
+typedef TPM_NONCE               TCPA_SALT_NONCE;
+typedef TPM_PUBKEY              TCPA_PUBKEY;
+typedef TPM_SECRET              TCPA_SECRET;
+typedef TPM_KEY                 TCPA_KEY;
+typedef TPM_DIRVALUE            TCPA_DIRVALUE;
+typedef TPM_COMMAND_CODE        TCPA_COMMAND_CODE;
+typedef TPM_BOUND_DATA          TCPA_BOUND_DATA;
+typedef TPM_STRUCT_VER          TCPA_VERSION;
+typedef TPM_RESULT              TCPA_RESULT;
+typedef TPM_PAYLOAD_TYPE        TCPA_PAYLOAD_TYPE;
+typedef TPM_STORE_PRIVKEY       TCPA_STORE_PRIVKEY;
+typedef TPM_CHOSENID_HASH       TCPA_CHOSENID_HASH;
+typedef TPM_SYMMETRIC_KEY       TCPA_SYMMETRIC_KEY;
+typedef TPM_PCR_INFO            TCPA_PCR_INFO;
+typedef TPM_PCR_SELECTION       TCPA_PCR_SELECTION;
+typedef TPM_STORED_DATA         TCPA_STORED_DATA;
+typedef TPM_SEALED_DATA         TCPA_SEALED_DATA;
+typedef TPM_KEY_FLAGS           TCPA_KEY_FLAGS;
+typedef TPM_KEY_PARMS           TCPA_KEY_PARMS;
+typedef TPM_STORE_PUBKEY        TCPA_STORE_PUBKEY;
+typedef TPM_MIGRATIONKEYAUTH    TCPA_MIGRATIONKEYAUTH;
+typedef TPM_RSA_KEY_PARMS       TCPA_RSA_KEY_PARMS;
+typedef TPM_CERTIFY_INFO        TCPA_CERTIFY_INFO;
+typedef TPM_STORE_ASYMKEY       TCPA_STORE_ASYMKEY;
+typedef TPM_ENCAUTH             TCPA_ENCAUTH;
+typedef TPM_PCRINDEX            TCPA_PCRINDEX;
+typedef TPM_PCRVALUE            TCPA_PCRVALUE;
+typedef TPM_DIRINDEX            TCPA_DIRINDEX;
+typedef TPM_PROTOCOL_ID         TCPA_PROTOCOL_ID;
+typedef TPM_ALGORITHM_ID        TCPA_ALGORITHM_ID;
+typedef TPM_ENTITY_TYPE         TCPA_ENTITY_TYPE;
+typedef TPM_CAPABILITY_AREA     TCPA_CAPABILITY_AREA;
+typedef TPM_HMAC                TCPA_HMAC;
+typedef TPM_MIGRATE_SCHEME      TCPA_MIGRATE_SCHEME;
+typedef TPM_PHYSICAL_PRESENCE   TCPA_PHYSICAL_PRESENCE;
+typedef TPM_KEY_HANDLE          TCPA_KEY_HANDLE;
+typedef TPM_KEY_HANDLE_LIST     TCPA_KEY_HANDLE_LIST;
+typedef TPM_PCR_COMPOSITE       TCPA_PCR_COMPOSITE;
+typedef TPM_AUTH_DATA_USAGE     TCPA_AUTH_DATA_USAGE;
+typedef TPM_AUTHDATA            TCPA_AUTHDATA;
+typedef TPM_KEY_USAGE           TCPA_KEY_USAGE;
+typedef TPM_COMPOSITE_HASH      TCPA_COMPOSITE_HASH;
+typedef TPM_QUOTE_INFO          TCPA_QUOTE_INFO;
+typedef TPM_TAG                 TCPA_TAG;
+typedef TPM_ENC_SCHEME          TCPA_ENC_SCHEME;
+typedef TPM_SIG_SCHEME          TCPA_SIG_SCHEME;
+typedef TPM_STARTUP_TYPE        TCPA_STARTUP_TYPE;
+typedef TPM_AUTHHANDLE          TCPA_AUTHHANDLE;
+typedef TPM_SYM_CA_ATTESTATION  TCPA_SYM_CA_ATTESTATION;
+typedef TPM_ASYM_CA_CONTENTS    TCPA_ASYM_CA_CONTENTS;
+typedef TPM_IDENTITY_REQ        TCPA_IDENTITY_REQ;
+typedef TPM_IDENTITY_PROOF      TCPA_IDENTITY_PROOF;
+
+// These were removed from the 1.2 TPM spec
+typedef UINT32                  TCPA_ENCHANDLE;
+typedef UINT32                  TCPA_EVENTTYPE;
+typedef struct tdTCPA_AUDIT_EVENT {
+    TCPA_COMMAND_CODE ordinal;
+    TCPA_RESULT       returncode;
+} TCPA_AUDIT_EVENT;
+
+#define TCPA_SHA1_160_HASH_LEN          TPM_SHA1_160_HASH_LEN
+#define TCPA_SHA1BASED_NONCE_LEN        TPM_SHA1BASED_NONCE_LEN
+
+#define redirection             TSS_KEYFLAG_REDIRECTION
+#define migratable              TSS_KEYFLAG_MIGRATABLE
+#define volatileKey             TSS_KEYFLAG_VOLATILEKEY
+
+#define TCPA_ET_KEYHANDLE       TPM_ET_KEYHANDLE
+#define TCPA_ET_KEY             TPM_ET_KEY
+#define TCPA_ET_OWNER           TPM_ET_OWNER
+#define TCPA_ET_SRK             TPM_ET_SRK
+#define TCPA_ET_DATA            TPM_ET_DATA
+
+#define TCPA_PID_OIAP           TPM_PID_OIAP
+#define TCPA_PID_OSAP           TPM_PID_OSAP
+#define TCPA_PID_ADIP           TPM_PID_ADIP
+#define TCPA_PID_ADCP           TPM_PID_ADCP
+#define TCPA_PID_OWNER          TPM_PID_OWNER
+
+#define TCPA_PT_ASYM            TPM_PT_ASYM
+#define TCPA_PT_BIND            TPM_PT_BIND
+#define TCPA_PT_MIGRATE         TPM_PT_MIGRATE
+#define TCPA_PT_MAINT           TPM_PT_MAINT
+#define TCPA_PT_SEAL            TPM_PT_SEAL
+
+#define TCPA_CAP_ALG            TPM_CAP_ALG
+#define TCPA_CAP_ORD            TPM_CAP_ORD
+#define TCPA_CAP_PID            TPM_CAP_PID
+#define TCPA_CAP_FLAG           TPM_CAP_FLAG
+#define TCPA_CAP_VERSION        TPM_CAP_VERSION
+#define TCPA_CAP_PROPERTY       TPM_CAP_PROPERTY
+#define TCPA_CAP_KEY_HANDLE     TPM_CAP_KEY_HANDLE
+#define TCPA_CAP_CHECK_LOADED   TPM_CAP_CHECK_LOADED
+
+#define TCPA_ALG_RSA            TPM_ALG_RSA
+#define TCPA_ALG_DES            TPM_ALG_DES
+#define TCPA_ALG_3DES           TPM_ALG_3DES
+#define TCPA_ALG_SHA            TPM_ALG_SHA
+#define TCPA_ALG_HMAC           TPM_ALG_HMAC
+#define TCPA_ALG_AES            TPM_ALG_AES
+
+#define TCPA_PROTECTED_ORDINAL          TPM_PROTECTED_ORDINAL
+#define TCPA_UNPROTECTED_ORDINAL        TPM_UNPROTECTED_ORDINAL
+#define TCPA_CONNECTION_ORDINAL         TPM_CONNECTION_ORDINAL
+
+#define TCPA_PROTECTED_COMMAND          TPM_PROTECTED_COMMAND
+#define TCPA_UNPROTECTED_COMMAND        TPM_UNPROTECTED_COMMAND
+#define TCPA_CONNECTION_COMMAND         TPM_CONNECTION_COMMAND
+#define TCPA_VENDOR_COMMAND             TPM_VENDOR_COMMAND
+
+#define TCPA_MAIN               TPM_MAIN
+#define TCPA_PC                 TPM_PC
+#define TCPA_PDA                TPM_PDA
+#define TCPA_CELL_PHONE         TPM_CELL_PHONE
+
+#define TCPA_MS_MIGRATE                 TPM_MS_MIGRATE
+#define TCPA_MS_REWRAP                  TPM_MS_REWRAP
+#define TCPA_MS_MAINT                   TPM_MS_MAINT
+
+#define TCPA_ES_NONE                    TPM_ES_NONE
+#define TCPA_ES_RSAESPKCSv15            TPM_ES_RSAESPKCSv15
+#define TCPA_ES_RSAESOAEP_SHA1_MGF1     TPM_ES_RSAESOAEP_SHA1_MGF1
+
+#define TCPA_SS_NONE                    TPM_SS_NONE
+#define TCPA_SS_RSASSAPKCS1v15_SHA1     TPM_SS_RSASSAPKCS1v15_SHA1
+#define TCPA_SS_RSASSAPKCS1v15_DER      TPM_SS_RSASSAPKCS1v15_DER
+#define	TCPA_SS_RSASSAPKCS1v15_INFO	TPM_SS_RSASSAPKCS1v15_INFO
+
+#define TCPA_PHYSICAL_PRESENCE_LIFETIME_LOCK    TPM_PHYSICAL_PRESENCE_LIFETIME_LOCK
+#define TCPA_PHYSICAL_PRESENCE_HW_ENABLE        TPM_PHYSICAL_PRESENCE_HW_ENABLE
+#define TCPA_PHYSICAL_PRESENCE_CMD_ENABLE       TPM_PHYSICAL_PRESENCE_CMD_ENABLE
+#define TCPA_PHYSICAL_PRESENCE_LOCK             TPM_PHYSICAL_PRESENCE_LOCK
+#define TCPA_PHYSICAL_PRESENCE_PRESENT          TPM_PHYSICAL_PRESENCE_PRESENT
+#define TCPA_PHYSICAL_PRESENCE_NOTPRESENT       TPM_PHYSICAL_PRESENCE_NOTPRESENT
+
+#define TCPA_SUCCESS                    TPM_SUCCESS
+#define TCPA_E_BASE                     TPM_E_BASE
+#define TCPA_E_NON_FATAL                TPM_E_NON_FATAL
+#define TCPA_E_AUTHFAIL                 TPM_E_AUTHFAIL
+#define TCPA_E_BAD_PARAMETER            TPM_E_BAD_PARAMETER
+#define TCPA_E_BADINDEX                 TPM_E_BADINDEX
+#define TCPA_E_AUDITFAILURE             TPM_E_AUDITFAILURE
+#define TCPA_E_CLEAR_DISABLED           TPM_E_CLEAR_DISABLED
+#define TCPA_E_DEACTIVATED              TPM_E_DEACTIVATED
+#define TCPA_E_DISABLED                 TPM_E_DISABLED
+#define TCPA_E_DISABLED_CMD             TPM_E_DISABLED_CMD
+#define TCPA_E_FAIL                     TPM_E_FAIL
+#define TCPA_E_INACTIVE                 TPM_E_BAD_ORDINAL
+#define TCPA_E_INSTALL_DISABLED         TPM_E_INSTALL_DISABLED
+#define TCPA_E_INVALID_KEYHANDLE        TPM_E_INVALID_KEYHANDLE
+#define TCPA_E_KEYNOTFOUND              TPM_E_KEYNOTFOUND
+#define TCPA_E_NEED_SELFTEST            TPM_E_INAPPROPRIATE_ENC
+#define TCPA_E_MIGRATEFAIL              TPM_E_MIGRATEFAIL
+#define TCPA_E_NO_PCR_INFO              TPM_E_INVALID_PCR_INFO
+#define TCPA_E_NOSPACE                  TPM_E_NOSPACE
+#define TCPA_E_NOSRK                    TPM_E_NOSRK
+#define TCPA_E_NOTSEALED_BLOB           TPM_E_NOTSEALED_BLOB
+#define TCPA_E_OWNER_SET                TPM_E_OWNER_SET
+#define TCPA_E_RESOURCES                TPM_E_RESOURCES
+#define TCPA_E_SHORTRANDOM              TPM_E_SHORTRANDOM
+#define TCPA_E_SIZE                     TPM_E_SIZE
+#define TCPA_E_WRONGPCRVAL              TPM_E_WRONGPCRVAL
+#define TCPA_E_BAD_PARAM_SIZE           TPM_E_BAD_PARAM_SIZE
+#define TCPA_E_SHA_THREAD               TPM_E_SHA_THREAD
+#define TCPA_E_SHA_ERROR                TPM_E_SHA_ERROR
+#define TCPA_E_FAILEDSELFTEST           TPM_E_FAILEDSELFTEST
+#define TCPA_E_AUTH2FAIL                TPM_E_AUTH2FAIL
+#define TCPA_E_BADTAG                   TPM_E_BADTAG
+#define TCPA_E_IOERROR                  TPM_E_IOERROR
+#define TCPA_E_ENCRYPT_ERROR            TPM_E_ENCRYPT_ERROR
+#define TCPA_E_DECRYPT_ERROR            TPM_E_DECRYPT_ERROR
+#define TCPA_E_INVALID_AUTHHANDLE       TPM_E_INVALID_AUTHHANDLE
+#define TCPA_E_NO_ENDORSEMENT           TPM_E_NO_ENDORSEMENT
+#define TCPA_E_INVALID_KEYUSAGE         TPM_E_INVALID_KEYUSAGE
+#define TCPA_E_WRONG_ENTITYTYPE         TPM_E_WRONG_ENTITYTYPE
+#define TCPA_E_INVALID_POSTINIT         TPM_E_INVALID_POSTINIT
+#define TCPA_E_INAPPROPRIATE_SIG        TPM_E_INAPPROPRIATE_SIG
+#define TCPA_E_BAD_KEY_PROPERTY         TPM_E_BAD_KEY_PROPERTY
+#define TCPA_E_BAD_MIGRATION            TPM_E_BAD_MIGRATION
+#define TCPA_E_BAD_SCHEME               TPM_E_BAD_SCHEME
+#define TCPA_E_BAD_DATASIZE             TPM_E_BAD_DATASIZE
+#define TCPA_E_BAD_MODE                 TPM_E_BAD_MODE
+#define TCPA_E_BAD_PRESENCE             TPM_E_BAD_PRESENCE
+#define TCPA_E_BAD_VERSION              TPM_E_BAD_VERSION
+#define TCPA_E_RETRY                    TPM_E_RETRY
+
+#endif
diff -ru trousers-0.3.8-orig/src/include/tss/platform.h trousers-0.3.8/src/include/tss/platform.h
--- trousers-0.3.8-orig/src/include/tss/platform.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/platform.h	2012-02-14 20:35:05.907250627 +0000
@@ -1,46 +1,46 @@
-/*++
-
-There are platform dependent and general defines.
-
---*/
-
-#ifndef TSS_PLATFORM_H
-#define TSS_PLATFORM_H
-
-
-/* The default implementation is to use stdint.h, a part of the C99 standard.
- * Systems that don't support this are handled on a case-by-case basis.
- */
-
-#if !defined(WIN32)
-#include <stdint.h>
-   typedef uint8_t            BYTE;
-   typedef int8_t             TSS_BOOL;
-   typedef uint16_t           UINT16;
-   typedef uint32_t           UINT32;
-   typedef uint64_t           UINT64;
-
-   typedef uint16_t           TSS_UNICODE;
-   typedef void*              PVOID;
-
-#elif defined(WIN32)
-#include <basetsd.h>
-   typedef  unsigned char    BYTE;  
-   typedef  signed char      TSS_BOOL;
-#ifndef _BASETSD_H_
-   // basetsd.h provides definitions of UINT16, UINT32 and UINT64.
-   typedef  unsigned short   UINT16;
-   typedef  unsigned long    UINT32;
-   typedef  unsigned __int64 UINT64;
-#endif
-   typedef  unsigned short   TSS_UNICODE;
-   typedef  void*            PVOID;
-#endif
-
-
-/* Include this so that applications that use names as defined in the
- * 1.1 TSS specification can still compile
- */
-#include <tss/compat11b.h>
-
-#endif // TSS_PLATFORM_H
+/*++
+
+There are platform dependent and general defines.
+
+--*/
+
+#ifndef TSS_PLATFORM_H
+#define TSS_PLATFORM_H
+
+
+/* The default implementation is to use stdint.h, a part of the C99 standard.
+ * Systems that don't support this are handled on a case-by-case basis.
+ */
+
+#if !defined(WIN32)
+#include <stdint.h>
+   typedef uint8_t            BYTE;
+   typedef int8_t             TSS_BOOL;
+   typedef uint16_t           UINT16;
+   typedef uint32_t           UINT32;
+   typedef uint64_t           UINT64;
+
+   typedef uint16_t           TSS_UNICODE;
+   typedef void*              PVOID;
+
+#elif defined(WIN32)
+#include <basetsd.h>
+   typedef  unsigned char    BYTE;  
+   typedef  signed char      TSS_BOOL;
+#ifndef _BASETSD_H_
+   // basetsd.h provides definitions of UINT16, UINT32 and UINT64.
+   typedef  unsigned short   UINT16;
+   typedef  unsigned long    UINT32;
+   typedef  unsigned __int64 UINT64;
+#endif
+   typedef  unsigned short   TSS_UNICODE;
+   typedef  void*            PVOID;
+#endif
+
+
+/* Include this so that applications that use names as defined in the
+ * 1.1 TSS specification can still compile
+ */
+#include <tss/compat11b.h>
+
+#endif // TSS_PLATFORM_H
diff -ru trousers-0.3.8-orig/src/include/tss/tcpa_defines.h trousers-0.3.8/src/include/tss/tcpa_defines.h
--- trousers-0.3.8-orig/src/include/tss/tcpa_defines.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcpa_defines.h	2012-02-14 20:35:05.907484496 +0000
@@ -1,7 +1,7 @@
-
-#ifndef __TCPA_DEFINES_H__
-#define __TCPA_DEFINES_H__
-
-#warning including deprecated header file tcpa_defines.h
-
-#endif
+
+#ifndef __TCPA_DEFINES_H__
+#define __TCPA_DEFINES_H__
+
+#warning including deprecated header file tcpa_defines.h
+
+#endif
diff -ru trousers-0.3.8-orig/src/include/tss/tcpa_error.h trousers-0.3.8/src/include/tss/tcpa_error.h
--- trousers-0.3.8-orig/src/include/tss/tcpa_error.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcpa_error.h	2012-02-14 20:35:05.907718234 +0000
@@ -1,7 +1,7 @@
-
-#ifndef __TCPA_ERROR_H__
-#define __TCPA_ERROR_H__
-
-#warning including deprecated header file tcpa_error.h
-
-#endif
+
+#ifndef __TCPA_ERROR_H__
+#define __TCPA_ERROR_H__
+
+#warning including deprecated header file tcpa_error.h
+
+#endif
diff -ru trousers-0.3.8-orig/src/include/tss/tcpa_struct.h trousers-0.3.8/src/include/tss/tcpa_struct.h
--- trousers-0.3.8-orig/src/include/tss/tcpa_struct.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcpa_struct.h	2012-02-14 20:35:05.907955674 +0000
@@ -1,7 +1,7 @@
-
-#ifndef __TCPA_STRUCT_H__
-#define __TCPA_STRUCT_H__
-
-#warning including deprecated header file tcpa_struct.h
-
-#endif
+
+#ifndef __TCPA_STRUCT_H__
+#define __TCPA_STRUCT_H__
+
+#warning including deprecated header file tcpa_struct.h
+
+#endif
diff -ru trousers-0.3.8-orig/src/include/tss/tcpa_typedef.h trousers-0.3.8/src/include/tss/tcpa_typedef.h
--- trousers-0.3.8-orig/src/include/tss/tcpa_typedef.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcpa_typedef.h	2012-02-14 20:35:05.908196953 +0000
@@ -1,7 +1,7 @@
-
-#ifndef __TCPA_TYPEDEF_H__
-#define __TCPA_TYPEDEF_H__
-
-#warning including deprecated header file tcpa_typedef.h
-
-#endif
+
+#ifndef __TCPA_TYPEDEF_H__
+#define __TCPA_TYPEDEF_H__
+
+#warning including deprecated header file tcpa_typedef.h
+
+#endif
diff -ru trousers-0.3.8-orig/src/include/tss/tcs_defines.h trousers-0.3.8/src/include/tss/tcs_defines.h
--- trousers-0.3.8-orig/src/include/tss/tcs_defines.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcs_defines.h	2012-02-14 20:35:05.908467308 +0000
@@ -1,28 +1,28 @@
-/*++
-
-TSS Core Service structures
-
-*/
-
-#ifndef __TCS_DEFINES_H__
-#define __TCS_DEFINES_H__
-
-#define TSS_TCSATTRIB_TRANSPORT_DEFAULT           ((UINT32)(0x00000000))
-#define TSS_TCSATTRIB_TRANSPORT_EXCLUSIVE         ((UINT32)(0x00000001))
-
-
-// Values for the ulCredentialType parameter to Tcsi_GetCredential
-#define TSS_TCS_CREDENTIAL_EKCERT                 ((UINT32)0x00000001)
-#define TSS_TCS_CREDENTIAL_TPM_CC                 ((UINT32)0x00000002)
-#define TSS_TCS_CREDENTIAL_PLATFORMCERT           ((UINT32)0x00000003)
-
-
-// Values for the ulCredentialAccessMode parameter to Tcsi_GetCredential
-//  TSS_TCS_CERT_ACCESS_AUTO triggers the default behavior.
-//  Values with TSS_TCS_CERT_VENDOR_SPECIFIC_BIT set trigger
-//    vendor specific behavior.
-#define TSS_TCS_CERT_ACCESS_AUTO                  ((UINT32)0x00000001)
-
-#define TSS_TCS_CERT_VENDOR_SPECIFIC_BIT          ((UINT32)0x80000000)
-
-#endif // __TCS_DEFINES_H__
+/*++
+
+TSS Core Service structures
+
+*/
+
+#ifndef __TCS_DEFINES_H__
+#define __TCS_DEFINES_H__
+
+#define TSS_TCSATTRIB_TRANSPORT_DEFAULT           ((UINT32)(0x00000000))
+#define TSS_TCSATTRIB_TRANSPORT_EXCLUSIVE         ((UINT32)(0x00000001))
+
+
+// Values for the ulCredentialType parameter to Tcsi_GetCredential
+#define TSS_TCS_CREDENTIAL_EKCERT                 ((UINT32)0x00000001)
+#define TSS_TCS_CREDENTIAL_TPM_CC                 ((UINT32)0x00000002)
+#define TSS_TCS_CREDENTIAL_PLATFORMCERT           ((UINT32)0x00000003)
+
+
+// Values for the ulCredentialAccessMode parameter to Tcsi_GetCredential
+//  TSS_TCS_CERT_ACCESS_AUTO triggers the default behavior.
+//  Values with TSS_TCS_CERT_VENDOR_SPECIFIC_BIT set trigger
+//    vendor specific behavior.
+#define TSS_TCS_CERT_ACCESS_AUTO                  ((UINT32)0x00000001)
+
+#define TSS_TCS_CERT_VENDOR_SPECIFIC_BIT          ((UINT32)0x80000000)
+
+#endif // __TCS_DEFINES_H__
diff -ru trousers-0.3.8-orig/src/include/tss/tcs_error.h trousers-0.3.8/src/include/tss/tcs_error.h
--- trousers-0.3.8-orig/src/include/tss/tcs_error.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcs_error.h	2012-02-14 20:35:05.908764731 +0000
@@ -1,56 +1,56 @@
-/*++
- 
-TSS Core Service error return codes 
- 
---*/
-
-#ifndef __TCS_ERROR_H__
-#define __TCS_ERROR_H__
-
-
-#ifndef TSS_E_BASE
-#define TSS_E_BASE      0x00000000L
-#endif // TSS_E_BASE
-
-// The context handle supplied is invalid.
-#define TCS_E_INVALID_CONTEXTHANDLE  (UINT32)(TSS_E_BASE + 0x0C1L) 
-
-// The key handle supplied is invalid.
-#define TCS_E_INVALID_KEYHANDLE  (UINT32)(TSS_E_BASE + 0x0C2L) 
-
-// The authorization session handle supplied is invalid.
-#define TCS_E_INVALID_AUTHHANDLE  (UINT32)(TSS_E_BASE + 0x0C3L)
-
-// the auth session has been closed by the TPM
-#define TCS_E_INVALID_AUTHSESSION  (UINT32)(TSS_E_BASE + 0x0C4L) 
-
-// the key has been unloaded 
-#define TCS_E_INVALID_KEY   (UINT32)(TSS_E_BASE + 0x0C5L) 
-
-// Key addressed by the application key handle does not match the key addressed
-// by the given UUID.
-#define TCS_E_KEY_MISMATCH   (UINT32)(TSS_E_BASE + 0x0C8L)
-
-// Key adressed by Key's UUID cannot be loaded because one of the required
-// parent keys needs authorization.
-#define TCS_E_KM_LOADFAILED   (UINT32)(TSS_E_BASE + 0x0CAL)
-
-// The Key Cache Manager could not reload the key into the TPM.
-#define TCS_E_KEY_CONTEXT_RELOAD  (UINT32)(TSS_E_BASE + 0x0CCL)
-
-// Bad memory index
-#define TCS_E_BAD_INDEX                           (UINT32)(TSS_E_BASE + 0x0CDL)
-
-
-// These TCS_E_ macros are defined by name in the TSS spec, however
-// they are defined to have the same values as the TSS_E_ equivalents.
-#define TCS_SUCCESS                        TSS_SUCCESS
-#define TCS_E_KEY_ALREADY_REGISTERED       TSS_E_KEY_ALREADY_REGISTERED
-#define TCS_E_KEY_NOT_REGISTERED           TSS_E_KEY_NOT_REGISTERED
-#define TCS_E_BAD_PARAMETER                TSS_E_BAD_PARAMETER
-#define TCS_E_OUTOFMEMORY                  TSS_E_OUTOFMEMORY
-#define TCS_E_SIZE                         TSS_E_SIZE
-#define TCS_E_NOTIMPL                      TSS_E_NOTIMPL
-#define TCS_E_INTERNAL_ERROR               TSS_E_INTERNAL_ERROR
-
-#endif // __TCS_ERROR_H__
+/*++
+ 
+TSS Core Service error return codes 
+ 
+--*/
+
+#ifndef __TCS_ERROR_H__
+#define __TCS_ERROR_H__
+
+
+#ifndef TSS_E_BASE
+#define TSS_E_BASE      0x00000000L
+#endif // TSS_E_BASE
+
+// The context handle supplied is invalid.
+#define TCS_E_INVALID_CONTEXTHANDLE  (UINT32)(TSS_E_BASE + 0x0C1L) 
+
+// The key handle supplied is invalid.
+#define TCS_E_INVALID_KEYHANDLE  (UINT32)(TSS_E_BASE + 0x0C2L) 
+
+// The authorization session handle supplied is invalid.
+#define TCS_E_INVALID_AUTHHANDLE  (UINT32)(TSS_E_BASE + 0x0C3L)
+
+// the auth session has been closed by the TPM
+#define TCS_E_INVALID_AUTHSESSION  (UINT32)(TSS_E_BASE + 0x0C4L) 
+
+// the key has been unloaded 
+#define TCS_E_INVALID_KEY   (UINT32)(TSS_E_BASE + 0x0C5L) 
+
+// Key addressed by the application key handle does not match the key addressed
+// by the given UUID.
+#define TCS_E_KEY_MISMATCH   (UINT32)(TSS_E_BASE + 0x0C8L)
+
+// Key adressed by Key's UUID cannot be loaded because one of the required
+// parent keys needs authorization.
+#define TCS_E_KM_LOADFAILED   (UINT32)(TSS_E_BASE + 0x0CAL)
+
+// The Key Cache Manager could not reload the key into the TPM.
+#define TCS_E_KEY_CONTEXT_RELOAD  (UINT32)(TSS_E_BASE + 0x0CCL)
+
+// Bad memory index
+#define TCS_E_BAD_INDEX                           (UINT32)(TSS_E_BASE + 0x0CDL)
+
+
+// These TCS_E_ macros are defined by name in the TSS spec, however
+// they are defined to have the same values as the TSS_E_ equivalents.
+#define TCS_SUCCESS                        TSS_SUCCESS
+#define TCS_E_KEY_ALREADY_REGISTERED       TSS_E_KEY_ALREADY_REGISTERED
+#define TCS_E_KEY_NOT_REGISTERED           TSS_E_KEY_NOT_REGISTERED
+#define TCS_E_BAD_PARAMETER                TSS_E_BAD_PARAMETER
+#define TCS_E_OUTOFMEMORY                  TSS_E_OUTOFMEMORY
+#define TCS_E_SIZE                         TSS_E_SIZE
+#define TCS_E_NOTIMPL                      TSS_E_NOTIMPL
+#define TCS_E_INTERNAL_ERROR               TSS_E_INTERNAL_ERROR
+
+#endif // __TCS_ERROR_H__
diff -ru trousers-0.3.8-orig/src/include/tss/tcs_structs.h trousers-0.3.8/src/include/tss/tcs_structs.h
--- trousers-0.3.8-orig/src/include/tss/tcs_structs.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcs_structs.h	2012-02-14 20:35:05.909041925 +0000
@@ -1,40 +1,40 @@
-/*++
-
-TSS Core Service structures
-
-*/
-
-#ifndef __TCS_STRUCT_H__
-#define __TCS_STRUCT_H__
-
-#include <tss/tpm.h>
-#include <tss/tss_structs.h>
-#include <tss/tcs_typedef.h>
-
-typedef struct tdTCS_AUTH
-{
-    TCS_AUTHHANDLE  AuthHandle;
-    TPM_NONCE       NonceOdd;   // system  
-    TPM_NONCE       NonceEven;   // TPM   
-    TSS_BOOL        fContinueAuthSession;
-    TPM_AUTHDATA    HMAC;
-} TCS_AUTH;
-
-// This is kept for legacy compatibility
-typedef TCS_AUTH    TPM_AUTH;
-
-
-typedef struct tdTCS_LOADKEY_INFO
-{
-    TSS_UUID   keyUUID;
-    TSS_UUID   parentKeyUUID;
-    TPM_DIGEST  paramDigest; // SHA1 digest of the TPM_LoadKey
-                             // Command input parameters
-                             // As defined in TPM Main Specification
-    TPM_AUTH   authData;     // Data regarding a valid auth
-                             // Session including the
-                             // HMAC digest
-} TCS_LOADKEY_INFO;
-
-#endif // __TCS_STRUCT_H__
-
+/*++
+
+TSS Core Service structures
+
+*/
+
+#ifndef __TCS_STRUCT_H__
+#define __TCS_STRUCT_H__
+
+#include <tss/tpm.h>
+#include <tss/tss_structs.h>
+#include <tss/tcs_typedef.h>
+
+typedef struct tdTCS_AUTH
+{
+    TCS_AUTHHANDLE  AuthHandle;
+    TPM_NONCE       NonceOdd;   // system  
+    TPM_NONCE       NonceEven;   // TPM   
+    TSS_BOOL        fContinueAuthSession;
+    TPM_AUTHDATA    HMAC;
+} TCS_AUTH;
+
+// This is kept for legacy compatibility
+typedef TCS_AUTH    TPM_AUTH;
+
+
+typedef struct tdTCS_LOADKEY_INFO
+{
+    TSS_UUID   keyUUID;
+    TSS_UUID   parentKeyUUID;
+    TPM_DIGEST  paramDigest; // SHA1 digest of the TPM_LoadKey
+                             // Command input parameters
+                             // As defined in TPM Main Specification
+    TPM_AUTH   authData;     // Data regarding a valid auth
+                             // Session including the
+                             // HMAC digest
+} TCS_LOADKEY_INFO;
+
+#endif // __TCS_STRUCT_H__
+
diff -ru trousers-0.3.8-orig/src/include/tss/tcs_typedef.h trousers-0.3.8/src/include/tss/tcs_typedef.h
--- trousers-0.3.8-orig/src/include/tss/tcs_typedef.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcs_typedef.h	2012-02-14 20:35:05.909307388 +0000
@@ -1,32 +1,32 @@
-/*++
-
-Global typedefs for TSS Core Service
- 
-*/
-
-#ifndef __TCS_TYPEDEF_H__
-#define __TCS_TYPEDEF_H__
-
-#include <tss/tss_structs.h>
-#include <tss/tpm.h>
-
-typedef UINT32  TCS_AUTHHANDLE;
-typedef UINT32  TCS_CONTEXT_HANDLE;
-typedef UINT32  TCS_KEY_HANDLE;
-typedef UINT32  TCS_HANDLE;
-
-
-// Substitution definitions for TCS-IDL
-typedef TPM_ENCAUTH                TCG_ENCAUTH;
-typedef TPM_NONCE                  TCG_NONCE;
-typedef TPM_ENTITY_TYPE            TCG_ENTITY_TYPE;
-typedef TPM_PCRINDEX               TCG_PCRINDEX;
-typedef TPM_DIGEST                 TCG_DIGEST;
-typedef TPM_PCRVALUE               TCG_PCRVALUE;
-typedef TPM_DIRVALUE               TCG_DIRVALUE;
-typedef TPM_DIRINDEX               TCG_DIRINDEX;
-
-
-
-#endif // __TCS_TYPEDEF_H__
-
+/*++
+
+Global typedefs for TSS Core Service
+ 
+*/
+
+#ifndef __TCS_TYPEDEF_H__
+#define __TCS_TYPEDEF_H__
+
+#include <tss/tss_structs.h>
+#include <tss/tpm.h>
+
+typedef UINT32  TCS_AUTHHANDLE;
+typedef UINT32  TCS_CONTEXT_HANDLE;
+typedef UINT32  TCS_KEY_HANDLE;
+typedef UINT32  TCS_HANDLE;
+
+
+// Substitution definitions for TCS-IDL
+typedef TPM_ENCAUTH                TCG_ENCAUTH;
+typedef TPM_NONCE                  TCG_NONCE;
+typedef TPM_ENTITY_TYPE            TCG_ENTITY_TYPE;
+typedef TPM_PCRINDEX               TCG_PCRINDEX;
+typedef TPM_DIGEST                 TCG_DIGEST;
+typedef TPM_PCRVALUE               TCG_PCRVALUE;
+typedef TPM_DIRVALUE               TCG_DIRVALUE;
+typedef TPM_DIRINDEX               TCG_DIRINDEX;
+
+
+
+#endif // __TCS_TYPEDEF_H__
+
diff -ru trousers-0.3.8-orig/src/include/tss/tcs.h trousers-0.3.8/src/include/tss/tcs.h
--- trousers-0.3.8-orig/src/include/tss/tcs.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tcs.h	2012-02-14 20:35:05.910749898 +0000
@@ -1,1129 +1,1129 @@
-#ifndef TCS_H
-#define TCS_H
-#include <tss/platform.h>
-#include <tss/tss_structs.h>
-#include <tss/tcs_typedef.h>
-#include <tss/tcs_defines.h>
-#include <tss/tcs_structs.h>
-#include <tss/tcs_error.h>
-#include <tss/tpm.h>
-
-#if defined __cplusplus
-extern "C" {
-#endif 
-
-extern TSS_RESULT Tcsi_OpenContext
-(
-    TCS_CONTEXT_HANDLE*   hContext                     // out
-);
-extern TSS_RESULT Tcsi_CloseContext
-(
-    TCS_CONTEXT_HANDLE    hContext                     // in
-);
-extern TSS_RESULT Tcsi_FreeMemory
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    BYTE*                 pMemory                      // in
-);
-extern TSS_RESULT Tcsi_GetCapability
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_CAPABILITY_AREA   capArea,                     // in
-    UINT32                subCapSize,                  // in
-    BYTE*                 subCap,                      // in
-    UINT32*               respSize,                    // out
-    BYTE**                resp                         // out
-);
-extern TSS_RESULT Tcsi_RegisterKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_UUID              WrappingKeyUUID,             // in
-    TSS_UUID              KeyUUID,                     // in
-    UINT32                cKeySize,                    // in
-    BYTE*                 rgbKey,                      // in
-    UINT32                cVendorDataSize,             // in
-    BYTE*                 gbVendorData                 // in
-);
-extern TSS_RESULT Tcsip_UnregisterKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_UUID              KeyUUID                      // in
-);
-extern TSS_RESULT Tcsip_KeyControlOwner
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hKey,                        // in
-    UINT32                ulPubKeyLength,              // in
-    BYTE*                 prgbPubKey,                  // in
-    UINT32                attribName,                  // in
-    TSS_BOOL              attribValue,                 // in
-    TPM_AUTH*             pOwnerAuth,                  // in, out
-    TSS_UUID*             pUuidData                    // out
-);
-extern TSS_RESULT Tcsi_EnumRegisteredKeys
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_UUID*             pKeyUUID,                    // in
-    UINT32*               pcKeyHierarchySize,          // out
-    TSS_KM_KEYINFO**      ppKeyHierarchy               // out
-);
-extern TSS_RESULT Tcsi_GetRegisteredKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_UUID              KeyUUID,                     // in
-    TSS_KM_KEYINFO**      ppKeyInfo                    // out
-);
-extern TSS_RESULT Tcsi_GetRegisteredKeyBlob
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_UUID              KeyUUID,                     // in
-    UINT32*               pcKeySize,                   // out
-    BYTE**                prgbKey                      // out
-);
-extern TSS_RESULT Tcsip_GetRegisteredKeyByPublicInfo
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_ALGORITHM_ID      algID,                       // in
-    UINT32                ulPublicInfoLength,          // in
-    BYTE*                 rgbPublicInfo,               // in
-    UINT32*               keySize,                     // out
-    BYTE**                keyBlob                      // out
-);
-extern TSS_RESULT Tcsip_LoadKeyByBlob
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hUnwrappingKey,              // in
-    UINT32                cWrappedKeyBlobSize,         // in
-    BYTE*                 rgbWrappedKeyBlob,           // in
-    TPM_AUTH*             pAuth,                       // in, out
-    TCS_KEY_HANDLE*       phKeyTCSI,                   // out
-    TCS_KEY_HANDLE*       phKeyHMAC                    // out
-);
-extern TSS_RESULT Tcsip_LoadKeyByUUID
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_UUID              KeyUUID,                     // in
-    TCS_LOADKEY_INFO*     pLoadKeyInfo,                // in, out
-    TCS_KEY_HANDLE*       phKeyTCSI                    // out
-);
-extern TSS_RESULT Tcsip_EvictKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hKey                         // in
-);
-extern TSS_RESULT Tcsip_CreateWrapKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hWrappingKey,                // in
-    TPM_ENCAUTH           KeyUsageAuth,                // in
-    TPM_ENCAUTH           KeyMigrationAuth,            // in
-    UINT32                keyInfoSize,                 // in
-    BYTE*                 keyInfo,                     // in
-    TPM_AUTH*             pAuth,                       // in, out
-    UINT32*               keyDataSize,                 // out
-    BYTE**                keyData                      // out
-);
-extern TSS_RESULT Tcsip_GetPubKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hKey,                        // in
-    TPM_AUTH*             pAuth,                       // in, out
-    UINT32*               pcPubKeySize,                // out
-    BYTE**                prgbPubKey                   // out
-);
-extern TSS_RESULT Tcsip_MakeIdentity
-(
-    TCS_CONTEXT_HANDLE    hContext,                              // in
-    TPM_ENCAUTH           identityAuth,                          // in
-    TPM_CHOSENID_HASH     IDLabel_PrivCAHash,                    // in
-    UINT32                idIdentityKeyInfoSize,                 // in
-    BYTE*                 idIdentityKeyInfo,                     // in
-    TPM_AUTH*             pSrkAuth,                              // in, out
-    TPM_AUTH*             pOwnerAuth,                            // in, out
-    UINT32*               idIdentityKeySize,                     // out
-    BYTE**                idIdentityKey,                         // out
-    UINT32*               pcIdentityBindingSize,                 // out
-    BYTE**                prgbIdentityBinding,                   // out
-    UINT32*               pcEndorsementCredentialSize,           // out
-    BYTE**                prgbEndorsementCredential,             // out
-    UINT32*               pcPlatformCredentialSize,              // out
-    BYTE**                prgbPlatformCredential,                // out
-    UINT32*               pcConformanceCredentialSize,           // out
-    BYTE**                prgbConformanceCredential              // out
-);
-extern TSS_RESULT Tcsip_MakeIdentity2
-(
-    TCS_CONTEXT_HANDLE    hContext,                              // in
-    TPM_ENCAUTH           identityAuth,                          // in
-    TPM_CHOSENID_HASH     IDLabel_PrivCAHash,                    // in
-    UINT32                idIdentityKeyInfoSize,                 // in
-    BYTE*                 idIdentityKeyInfo,                     // in
-    TPM_AUTH*             pSrkAuth,                              // in, out
-    TPM_AUTH*             pOwnerAuth,                            // in, out
-    UINT32*               idIdentityKeySize,                     // out
-    BYTE**                idIdentityKey,                         // out
-    UINT32*               pcIdentityBindingSize,                 // out
-    BYTE**                prgbIdentityBinding                    // out
-);
-extern TSS_RESULT Tcsi_LogPcrEvent
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_PCR_EVENT         Event,                       // in
-    UINT32*               pNumber                      // out
-);
-extern TSS_RESULT Tcsi_GetPcrEvent
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                PcrIndex,                    // in
-    UINT32*               pNumber,                     // in, out
-    TSS_PCR_EVENT**       ppEvent                      // out
-);
-extern TSS_RESULT Tcsi_GetPcrEventsByPcr
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                PcrIndex,                    // in
-    UINT32                FirstEvent,                  // in
-    UINT32*               pEventCount,                 // in, out
-    TSS_PCR_EVENT**       ppEvents                     // out
-);
-extern TSS_RESULT Tcsi_GetPcrEventLog
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32*               pEventCount,                 // out
-    TSS_PCR_EVENT**       ppEvents                     // out
-);
-extern TSS_RESULT Tcsip_SetOwnerInstall
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_BOOL              state                        // in
-);
-extern TSS_RESULT Tcsip_TakeOwnership
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT16                protocolID,                  // in
-    UINT32                encOwnerAuthSize,            // in
-    BYTE*                 encOwnerAuth,                // in
-    UINT32                encSrkAuthSize,              // in
-    BYTE*                 encSrkAuth,                  // in
-    UINT32                srkKeyInfoSize,              // in
-    BYTE*                 srkKeyInfo,                  // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               srkKeyDataSize,              // out
-    BYTE**                srkKeyData                   // out
-);
-extern TSS_RESULT Tcsip_SetOperatorAuth
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_SECRET            operatorAuth                 // in
-);
-extern TSS_RESULT Tcsip_OIAP
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_AUTHHANDLE*       authHandle,                  // out
-    TPM_NONCE*            nonce0                       // out
-);
-extern TSS_RESULT Tcsip_OSAP
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_ENTITY_TYPE       entityType,                  // in
-    UINT32                entityValue,                 // in
-    TPM_NONCE             nonceOddOSAP,                // in
-    TCS_AUTHHANDLE*       authHandle,                  // out
-    TPM_NONCE*            nonceEven,                   // out
-    TPM_NONCE*            nonceEvenOSAP                // out
-);
-extern TSS_RESULT Tcsip_ChangeAuth
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        parentHandle,                // in
-    TPM_PROTOCOL_ID       protocolID,                  // in
-    TPM_ENCAUTH           newAuth,                     // in
-    TPM_ENTITY_TYPE       entityType,                  // in
-    UINT32                encDataSize,                 // in
-    BYTE*                 encData,                     // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    TPM_AUTH*             entityAuth,                  // in, out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_ChangeAuthOwner
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_PROTOCOL_ID       protocolID,                  // in
-    TPM_ENCAUTH           newAuth,                     // in
-    TPM_ENTITY_TYPE       entityType,                  // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_ChangeAuthAsymStart
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        idHandle,                    // in
-    TPM_NONCE             antiReplay,                  // in
-    UINT32                TempKeyInfoSize,             // in
-    BYTE*                 TempKeyInfoData,             // in
-    TPM_AUTH*             pAuth,                       // in, out
-    UINT32*               TempKeySize,                 // out
-    BYTE**                TempKeyData,                 // out
-    UINT32*               CertifyInfoSize,             // out
-    BYTE**                CertifyInfo,                 // out
-    UINT32*               sigSize,                     // out
-    BYTE**                sig,                         // out
-    TCS_KEY_HANDLE*       ephHandle                    // out
-);
-extern TSS_RESULT Tcsip_ChangeAuthAsymFinish
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        parentHandle,                // in
-    TCS_KEY_HANDLE        ephHandle,                   // in
-    TPM_ENTITY_TYPE       entityType,                  // in
-    TPM_HMAC              newAuthLink,                 // in
-    UINT32                newAuthSize,                 // in
-    BYTE*                 encNewAuth,                  // in
-    UINT32                encDataSizeIn,               // in
-    BYTE*                 encDataIn,                   // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               encDataSizeOut,              // out
-    BYTE**                encDataOut,                  // out
-    TPM_NONCE*            saltNonce,                   // out
-    TPM_DIGEST*           changeProof                  // out
-);
-extern TSS_RESULT Tcsip_TerminateHandle
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_AUTHHANDLE        handle                       // in
-);
-extern TSS_RESULT Tcsip_ActivateTPMIdentity
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        idKey,                       // in
-    UINT32                blobSize,                    // in
-    BYTE*                 blob,                        // in
-    TPM_AUTH*             idKeyAuth,                   // in, out
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               SymmetricKeySize,            // out
-    BYTE**                SymmetricKey                 // out
-);
-extern TSS_RESULT Tcsip_EstablishTransport
-(
-    TCS_CONTEXT_HANDLE            hContext,                      // in
-    UINT32                        ulTransControlFlags,           // in
-    TCS_KEY_HANDLE                hEncKey,                       // in
-    UINT32                        ulTransSessionInfoSize,        // in
-    BYTE*                         rgbTransSessionInfo,           // in
-    UINT32                        ulSecretSize,                  // in
-    BYTE*                         rgbSecret,                     // in
-    TPM_AUTH*                     pEncKeyAuth,                   // in, out
-    TPM_MODIFIER_INDICATOR*       pbLocality,                    // out
-    TCS_HANDLE*                   hTransSession,                 // out
-    UINT32*                       ulCurrentTicksSize,            // out
-    BYTE**                        prgbCurrentTicks,              // out
-    TPM_NONCE*                    pTransNonce                    // out
-);
-extern TSS_RESULT Tcsip_ExecuteTransport
-(
-    TCS_CONTEXT_HANDLE            hContext,                      // in
-    TPM_COMMAND_CODE              unWrappedCommandOrdinal,       // in
-    UINT32                        ulWrappedCmdParamInSize,       // in
-    BYTE*                         rgbWrappedCmdParamIn,          // in
-    UINT32*                       pulHandleListSize,             // in, out
-    TCS_HANDLE**                  rghHandles,                    // in, out
-    TPM_AUTH*                     pWrappedCmdAuth1,              // in, out
-    TPM_AUTH*                     pWrappedCmdAuth2,              // in, out
-    TPM_AUTH*                     pTransAuth,                    // in, out
-    UINT64*                       punCurrentTicks,               // out
-    TPM_MODIFIER_INDICATOR*       pbLocality,                    // out
-    TPM_RESULT*                   pulWrappedCmdReturnCode,       // out
-    UINT32*                       ulWrappedCmdParamOutSize,      // out
-    BYTE**                        rgbWrappedCmdParamOut          // out
-);
-extern TSS_RESULT Tcsip_ReleaseTransportSigned
-(
-    TCS_CONTEXT_HANDLE            hContext,            // in
-    TCS_KEY_HANDLE                hSignatureKey,       // in
-    TPM_NONCE                     AntiReplayNonce,     // in
-    TPM_AUTH*                     pKeyAuth,            // in, out
-    TPM_AUTH*                     pTransAuth,          // in, out
-    TPM_MODIFIER_INDICATOR*       pbLocality,          // out
-    UINT32*                       pulCurrentTicksSize, // out
-    BYTE**                        prgbCurrentTicks,    // out
-    UINT32*                       pulSignatureSize,    // out
-    BYTE**                        prgbSignature        // out
-);
-extern TSS_RESULT Tcsip_Extend
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_PCRINDEX          pcrNum,                      // in
-    TPM_DIGEST            inDigest,                    // in
-    TPM_PCRVALUE*         outDigest                    // out
-);
-extern TSS_RESULT Tcsip_PcrRead
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_PCRINDEX          pcrNum,                      // in
-    TPM_PCRVALUE*         outDigest                    // out
-);
-extern TSS_RESULT Tcsip_Quote
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_NONCE             antiReplay,                  // in
-    UINT32                pcrTargetSize,               // in
-    BYTE*                 pcrTarget,                   // in
-    TPM_AUTH*             privAuth,                    // in, out
-    UINT32*               pcrDataSize,                 // out
-    BYTE**                pcrData,                     // out
-    UINT32*               sigSize,                     // out
-    BYTE**                sig                          // out
-);
-extern TSS_RESULT Tcsip_Quote2
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_NONCE             antiReplay,                  // in
-    UINT32                pcrTargetSize,               // in
-    BYTE*                 pcrTarget,                   // in
-    TSS_BOOL              addVersion,                  // in
-    TPM_AUTH*             privAuth,                    // in, out
-    UINT32*               pcrDataSize,                 // out
-    BYTE**                pcrData,                     // out
-    UINT32*               versionInfoSize,             // out
-    BYTE**                versionInfo,                 // out
-    UINT32*               sigSize,                     // out
-    BYTE**                sig                          // out
-);
-extern TSS_RESULT Tcsip_DirWriteAuth
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_DIRINDEX          dirIndex,                    // in
-    TPM_DIRVALUE          newContents,                 // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_DirRead
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_DIRINDEX          dirIndex,                    // in
-    TPM_DIRVALUE*         dirValue                     // out
-);
-extern TSS_RESULT Tcsip_Seal
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_ENCAUTH           encAuth,                     // in
-    UINT32                pcrInfoSize,                 // in
-    BYTE*                 PcrInfo,                     // in
-    UINT32                inDataSize,                  // in
-    BYTE*                 inData,                      // in
-    TPM_AUTH*             pubAuth,                     // in, out
-    UINT32*               SealedDataSize,              // out
-    BYTE**                SealedData                   // out
-);
-extern TSS_RESULT Tcsip_Unseal
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    UINT32                SealedDataSize,              // in
-    BYTE*                 SealedData,                  // in
-    TPM_AUTH*             keyAuth,                     // in, out
-    TPM_AUTH*             dataAuth,                    // in, out
-    UINT32*               DataSize,                    // out
-    BYTE**                Data                         // out
-);
-extern TSS_RESULT Tcsip_UnBind
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    UINT32                inDataSize,                  // in
-    BYTE*                 inData,                      // in
-    TPM_AUTH*             privAuth,                    // in, out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_Sealx
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_ENCAUTH           encAuth,                     // in
-    UINT32                pcrInfoSize,                 // in
-    BYTE*                 PcrInfo,                     // in
-    UINT32                inDataSize,                  // in
-    BYTE*                 inData,                      // in
-    TPM_AUTH*             pubAuth,                     // in, out
-    UINT32*               SealedDataSize,              // out
-    BYTE**                SealedData                   // out
-);
-extern TSS_RESULT Tcsip_LoadKey2ByBlob
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hUnwrappingKey,              // in
-    UINT32                cWrappedKeyBlobSize,         // in
-    BYTE*                 rgbWrappedKeyBlob,           // in
-    TPM_AUTH*             pAuth,                       // in, out
-    TCS_KEY_HANDLE*       phKeyTCSI                    // out
-);
-extern TSS_RESULT Tcsip_CreateMigrationBlob
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        parentHandle,                // in
-    TSS_MIGRATE_SCHEME    migrationType,               // in
-    UINT32                MigrationKeyAuthSize,        // in
-    BYTE*                 MigrationKeyAuth,            // in
-    UINT32                encDataSize,                 // in
-    BYTE*                 encData,                     // in
-    TPM_AUTH*             parentAuth,                  // in, out
-    TPM_AUTH*             entityAuth,                  // in, out
-    UINT32*               randomSize,                  // out
-    BYTE**                random,                      // out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_ConvertMigrationBlob
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        parentHandle,                // in
-    UINT32                inDataSize,                  // in
-    BYTE*                 inData,                      // in
-    UINT32                randomSize,                  // in
-    BYTE*                 random,                      // in
-    TPM_AUTH*             parentAuth,                  // in, out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_AuthorizeMigrationKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_MIGRATE_SCHEME    migrateScheme,               // in
-    UINT32                MigrationKeySize,            // in
-    BYTE*                 MigrationKey,                // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               MigrationKeyAuthSize,        // out
-    BYTE**                MigrationKeyAuth             // out
-);
-extern TSS_RESULT Tcsip_CertifyKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        certHandle,                  // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_NONCE             antiReplay,                  // in
-    TPM_AUTH*             certAuth,                    // in, out
-    TPM_AUTH*             keyAuth,                     // in, out
-    UINT32*               CertifyInfoSize,             // out
-    BYTE**                CertifyInfo,                 // out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_CertifyKey2
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        certHandle,                  // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_DIGEST            MSAdigest,                   // in
-    TPM_NONCE             antiReplay,                  // in
-    TPM_AUTH*             certAuth,                    // in, out
-    TPM_AUTH*             keyAuth,                     // in, out
-    UINT32*               CertifyInfoSize,             // out
-    BYTE**                CertifyInfo,                 // out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_Sign
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    UINT32                areaToSignSize,              // in
-    BYTE*                 areaToSign,                  // in
-    TPM_AUTH*             privAuth,                    // in, out
-    UINT32*               sigSize,                     // out
-    BYTE**                sig                          // out
-);
-extern TSS_RESULT Tcsip_GetRandom
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32*               bytesRequested,              // in, out
-    BYTE**                randomBytes                  // out
-);
-extern TSS_RESULT Tcsip_StirRandom
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                inDataSize,                  // in
-    BYTE*                 inData                       // in
-);
-extern TSS_RESULT Tcsip_GetCapability
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_CAPABILITY_AREA   capArea,                     // in
-    UINT32                subCapSize,                  // in
-    BYTE*                 subCap,                      // in
-    UINT32*               respSize,                    // out
-    BYTE**                resp                         // out
-);
-extern TSS_RESULT Tcsip_GetCapabilitySigned
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_NONCE             antiReplay,                  // in
-    TPM_CAPABILITY_AREA   capArea,                     // in
-    UINT32                subCapSize,                  // in
-    BYTE*                 subCap,                      // in
-    TPM_AUTH*             privAuth,                    // in, out
-    TPM_VERSION*          Version,                     // out
-    UINT32*               respSize,                    // out
-    BYTE**                resp,                        // out
-    UINT32*               sigSize,                     // out
-    BYTE**                sig                          // out
-);
-extern TSS_RESULT Tcsip_GetCapabilityOwner
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_AUTH*             pOwnerAuth,                  // in, out
-    TPM_VERSION*          pVersion,                    // out
-    UINT32*               pNonVolatileFlags,           // out
-    UINT32*               pVolatileFlags               // out
-);
-extern TSS_RESULT Tcsip_CreateEndorsementKeyPair
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_NONCE             antiReplay,                  // in
-    UINT32                endorsementKeyInfoSize,      // in
-    BYTE*                 endorsementKeyInfo,          // in
-    UINT32*               endorsementKeySize,          // out
-    BYTE**                endorsementKey,              // out
-    TPM_DIGEST*           checksum                     // out
-);
-extern TSS_RESULT Tcsip_ReadPubek
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_NONCE             antiReplay,                  // in
-    UINT32*               pubEndorsementKeySize,       // out
-    BYTE**                pubEndorsementKey,           // out
-    TPM_DIGEST*           checksum                     // out
-);
-extern TSS_RESULT Tcsip_DisablePubekRead
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_OwnerReadPubek
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               pubEndorsementKeySize,       // out
-    BYTE**                pubEndorsementKey            // out
-);
-extern TSS_RESULT Tcsip_SelfTestFull
-(
-    TCS_CONTEXT_HANDLE    hContext                     // in
-);
-extern TSS_RESULT Tcsip_CertifySelfTest
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_NONCE             antiReplay,                  // in
-    TPM_AUTH*             privAuth,                    // in, out
-    UINT32*               sigSize,                     // out
-    BYTE**                sig                          // out
-);
-extern TSS_RESULT Tcsip_ContinueSelfTest
-(
-    TCS_CONTEXT_HANDLE    hContext                     // in
-);
-extern TSS_RESULT Tcsip_GetTestResult
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_OwnerSetDisable
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_BOOL              disableState,                // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_OwnerClear
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_DisableOwnerClear
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_ForceClear
-(
-    TCS_CONTEXT_HANDLE    hContext                     // in
-);
-extern TSS_RESULT Tcsip_DisableForceClear
-(
-    TCS_CONTEXT_HANDLE    hContext                     // in
-);
-extern TSS_RESULT Tcsip_PhysicalDisable
-(
-    TCS_CONTEXT_HANDLE    hContext                     // in
-);
-extern TSS_RESULT Tcsip_PhysicalEnable
-(
-    TCS_CONTEXT_HANDLE    hContext                     // in
-);
-extern TSS_RESULT Tcsip_PhysicalSetDeactivated
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_BOOL              state                        // in
-);
-extern TSS_RESULT Tcsip_SetTempDeactivated
-(
-    TCS_CONTEXT_HANDLE    hContext                     // in
-);
-extern TSS_RESULT Tcsip_SetTempDeactivated2
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_AUTH*             pOperatorAuth                // in, out
-);
-extern TSS_RESULT Tcsip_OwnerReadInternalPub
-(
-    TCS_CONTEXT_HANDLE   hContext,                     // in
-    TCS_KEY_HANDLE       hKey,                         // in
-    TPM_AUTH*            pOwnerAuth,                   // in, out
-    UINT32*              punPubKeySize,                // out
-    BYTE**               ppbPubKeyData                 // out
-);
-extern TSS_RESULT Tcsip_PhysicalPresence
-(
-    TCS_CONTEXT_HANDLE            hContext,            // in
-    TPM_PHYSICAL_PRESENCE         fPhysicalPresence    // in
-);
-extern TSS_RESULT Tcsip_FieldUpgrade
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                dataInSize,                  // in
-    BYTE*                 dataIn,                      // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               dataOutSize,                 // out
-    BYTE**                dataOut                      // out
-);
-extern TSS_RESULT Tcsip_ResetLockValue
-(
-    TCS_CONTEXT_HANDLE            hContext,            // in
-    TPM_AUTH*                     ownerAuth            // in, out
-);
-extern TSS_RESULT Tcsip_FlushSpecific
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_HANDLE            hResHandle,                  // in
-    TPM_RESOURCE_TYPE     resourceType                 // in
-);
-extern TSS_RESULT Tcsip_SetRedirection
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    UINT32                c1,                          // in
-    UINT32                c2,                          // in
-    TPM_AUTH*             privAuth                     // in, out
-);
-extern TSS_RESULT Tcsip_DSAP
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_ENTITY_TYPE       entityType,                  // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TPM_NONCE             nonceOddDSAP,                // in
-    UINT32                entityValueSize,             // in
-    BYTE*                 entityValue,                 // in
-    TCS_AUTHHANDLE*       authHandle,                  // out
-    TPM_NONCE*            nonceEven,                   // out
-    TPM_NONCE*            nonceEvenDSAP                // out
-);
-extern TSS_RESULT Tcsip_Delegate_Manage
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_FAMILY_ID         familyID,                    // in
-    TPM_FAMILY_OPERATION  opFlag,                      // in
-    UINT32                opDataSize,                  // in
-    BYTE*                 opData,                      // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               retDataSize,                 // out
-    BYTE**                retData                      // out
-);
-extern TSS_RESULT Tcsip_Delegate_CreateKeyDelegation
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hKey,                        // in
-    UINT32                publicInfoSize,              // in
-    BYTE*                 publicInfo,                  // in
-    TPM_ENCAUTH           encDelAuth,                  // in
-    TPM_AUTH*             keyAuth,                     // in, out
-    UINT32*               blobSize,                    // out
-    BYTE**                blob                         // out
-);
-extern TSS_RESULT Tcsip_Delegate_CreateOwnerDelegation
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_BOOL              increment,                   // in
-    UINT32                publicInfoSize,              // in
-    BYTE*                 publicInfo,                  // in
-    TPM_ENCAUTH           encDelAuth,                  // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               blobSize,                    // out
-    BYTE**                blob                         // out
-);
-extern TSS_RESULT Tcsip_Delegate_LoadOwnerDelegation
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_DELEGATE_INDEX    index,                       // in
-    UINT32                blobSize,                    // in
-    BYTE*                 blob,                        // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_Delegate_UpdateVerificationCount
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                inputSize,                   // in
-    BYTE*                 input,                       // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               outputSize,                  // out
-    BYTE**                output                       // out
-);
-extern TSS_RESULT Tcsip_Delegate_VerifyDelegation
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                delegateSize,                // in
-    BYTE*                 delegate                     // in
-);
-extern TSS_RESULT Tcsip_Delegate_ReadTable
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32*               pulFamilyTableSize,          // out
-    BYTE**                ppFamilyTable,               // out
-    UINT32*               pulDelegateTableSize,        // out
-    BYTE**                ppDelegateTable              // out
-);
-extern TSS_RESULT Tcsip_NV_DefineOrReleaseSpace
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                cPubInfoSize,                // in
-    BYTE*                 pPubInfo,                    // in
-    TPM_ENCAUTH           encAuth,                     // in
-    TPM_AUTH*             pAuth                        // in, out
-);
-extern TSS_RESULT Tcsip_NV_WriteValue
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_NV_INDEX          hNVStore,                    // in
-    UINT32                offset,                      // in
-    UINT32                ulDataLength,                // in
-    BYTE*                 rgbDataToWrite,              // in
-    TPM_AUTH*             privAuth                     // in, out
-);
-extern TSS_RESULT Tcsip_NV_WriteValueAuth
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_NV_INDEX          hNVStore,                    // in
-    UINT32                offset,                      // in
-    UINT32                ulDataLength,                // in
-    BYTE*                 rgbDataToWrite,              // in
-    TPM_AUTH*             NVAuth                       // in, out
-);
-extern TSS_RESULT Tcsip_NV_ReadValue
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_NV_INDEX          hNVStore,                    // in
-    UINT32                offset,                      // in
-    UINT32*               pulDataLength,               // in, out
-    TPM_AUTH*             privAuth,                    // in, out
-    BYTE**                rgbDataRead                  // out
-);
-extern TSS_RESULT Tcsip_NV_ReadValueAuth
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_NV_INDEX          hNVStore,                    // in
-    UINT32                offset,                      // in
-    UINT32*               pulDataLength,               // in, out
-    TPM_AUTH*             NVAuth,                      // in, out
-    BYTE**                rgbDataRead                  // out
-);
-extern TSS_RESULT Tcsip_CreateMaintenanceArchive
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_BOOL              generateRandom,              // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               randomSize,                  // out
-    BYTE**                random,                      // out
-    UINT32*               archiveSize,                 // out
-    BYTE**                archive                      // out
-);
-extern TSS_RESULT Tcsip_LoadMaintenanceArchive
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                dataInSize,                  // in
-    BYTE*                 dataIn,                      // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               dataOutSize,                 // out
-    BYTE**                dataOut                      // out
-);
-extern TSS_RESULT Tcsip_KillMaintenanceFeature
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_LoadManuMaintPub
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_NONCE             antiReplay,                  // in
-    UINT32                PubKeySize,                  // in
-    BYTE*                 PubKey,                      // in
-    TPM_DIGEST*           checksum                     // out
-);
-extern TSS_RESULT Tcsip_ReadManuMaintPub
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_NONCE             antiReplay,                  // in
-    TPM_DIGEST*           checksum                     // out
-);
-extern TSS_RESULT Tcsip_CreateRevocableEndorsementKeyPair
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_NONCE             antiReplay,                  // in
-    UINT32                endorsementKeyInfoSize,      // in
-    BYTE*                 endorsementKeyInfo,          // in
-    TSS_BOOL              GenResetAuth,                // in
-    TPM_DIGEST*           EKResetAuth,                 // in, out
-    UINT32*               endorsementKeySize,          // out
-    BYTE**                endorsementKey,              // out
-    TPM_DIGEST*           checksum                     // out
-);
-extern TSS_RESULT Tcsip_RevokeEndorsementKeyPair
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_DIGEST            EKResetAuth                  // in
-);
-extern TSS_RESULT Tcsip_PcrReset
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                pcrTargetSize,               // in
-    BYTE*                 pcrTarget                    // in
-);
-extern TSS_RESULT Tcsip_ReadCounter
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_COUNTER_ID        idCounter,                   // in
-    TPM_COUNTER_VALUE*    counterValue                 // out
-);
-extern TSS_RESULT Tcsip_CreateCounter
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                LabelSize,                   // in (=4)
-    BYTE*                 pLabel,                      // in
-    TPM_ENCAUTH           CounterAuth,                 // in
-    TPM_AUTH*             pOwnerAuth,                  // in, out
-    TSS_COUNTER_ID*       idCounter,                   // out
-    TPM_COUNTER_VALUE*    counterValue                 // out
-);
-extern TSS_RESULT Tcsip_IncrementCounter
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_COUNTER_ID        idCounter,                   // in
-    TPM_AUTH*             pCounterAuth,                // in, out
-    TPM_COUNTER_VALUE*    counterValue                 // out
-);
-extern TSS_RESULT Tcsip_ReleaseCounter
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_COUNTER_ID        idCounter,                   // in
-    TPM_AUTH*             pCounterAuth                 // in, out
-);
-extern TSS_RESULT Tcsip_ReleaseCounterOwner
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_COUNTER_ID        idCounter,                   // in
-    TPM_AUTH*             pOwnerAuth                   // in, out
-);
-extern TSS_RESULT Tcsip_ReadCurrentTicks
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32*               pulCurrentTimeSize,          // out
-    BYTE**                prgbCurrentTime              // out
-);
-extern TSS_RESULT Tcsip_TickStampBlob
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hKey,                        // in
-    TPM_NONCE             antiReplay,                  // in
-    TPM_DIGEST            digestToStamp,               // in
-    TPM_AUTH*             privAuth,                    // in, out
-    UINT32*               pulSignatureLength,          // out
-    BYTE**                prgbSignature,               // out
-    UINT32*               pulTickCountSize,            // out
-    BYTE**                prgbTickCount                // out
-);
-extern TSS_RESULT Tcsip_TPM_DAA_Join
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_HANDLE            handle,                      // in
-    BYTE                  stage,                       // in
-    UINT32                inputSize0,                  // in
-    BYTE*                 inputData0,                  // in
-    UINT32                inputSize1,                  // in
-    BYTE*                 inputData1,                  // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               outputSize,                  // out
-    BYTE**                outputData                   // out
-);
-extern TSS_RESULT Tcsip_TPM_DAA_Sign
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_HANDLE            handle,                      // in
-    BYTE                  stage,                       // in
-    UINT32                inputSize0,                  // in
-    BYTE*                 inputData0,                  // in
-    UINT32                inputSize1,                  // in
-    BYTE*                 inputData1,                  // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               outputSize,                  // out
-    BYTE**                outputData                   // out
-);
-extern TSS_RESULT Tcsip_MigrateKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hMaKey,                      // in
-    UINT32                PublicKeySize,               // in
-    BYTE*                 PublicKey,                   // in
-    UINT32                inDataSize,                  // in
-    BYTE*                 inData,                      // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_CMK_SetRestrictions
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TSS_CMK_DELEGATE      Restriction,                 // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_CMK_ApproveMA
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_DIGEST            migAuthorityDigest,          // in
-    TPM_AUTH*             ownerAuth,                   // in, out
-    TPM_HMAC*             HmacMigAuthDigest            // out
-);
-extern TSS_RESULT Tcsip_CMK_CreateKey
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        hWrappingKey,                // in
-    TPM_ENCAUTH           KeyUsageAuth,                // in
-    TPM_HMAC              MigAuthApproval,             // in
-    TPM_DIGEST            MigAuthorityDigest,          // in
-    UINT32*               keyDataSize,                 // in, out
-    BYTE**                prgbKeyData,                 // in, out
-    TPM_AUTH*             pAuth                        // in, out
-);
-extern TSS_RESULT Tcsip_CMK_CreateTicket
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                PublicVerifyKeySize,         // in
-    BYTE*                 PublicVerifyKey,             // in
-    TPM_DIGEST            SignedData,                  // in
-    UINT32                SigValueSize,                // in
-    BYTE*                 SigValue,                    // in
-    TPM_AUTH*             pOwnerAuth,                  // in, out
-    TPM_HMAC*             SigTicket                    // out
-);
-extern TSS_RESULT Tcsip_CMK_CreateBlob
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        parentHandle,                // in
-    TSS_MIGRATE_SCHEME    migrationType,               // in
-    UINT32                MigrationKeyAuthSize,        // in
-    BYTE*                 MigrationKeyAuth,            // in
-    TPM_DIGEST            PubSourceKeyDigest,          // in
-    UINT32                msaListSize,                 // in
-    BYTE*                 msaList,                     // in
-    UINT32                restrictTicketSize,          // in
-    BYTE*                 restrictTicket,              // in
-    UINT32                sigTicketSize,               // in
-    BYTE*                 sigTicket,                   // in
-    UINT32                encDataSize,                 // in
-    BYTE*                 encData,                     // in
-    TPM_AUTH*             parentAuth,                  // in, out
-    UINT32*               randomSize,                  // out
-    BYTE**                random,                      // out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_CMK_ConvertMigration
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        parentHandle,                // in
-    TPM_CMK_AUTH          restrictTicket,              // in
-    TPM_HMAC              sigTicket,                   // in
-    UINT32                keyDataSize,                 // in
-    BYTE*                 prgbKeyData,                 // in
-    UINT32                msaListSize,                 // in
-    BYTE*                 msaList,                     // in
-    UINT32                randomSize,                  // in
-    BYTE*                 random,                      // in
-    TPM_AUTH*             parentAuth,                  // in, out
-    UINT32*               outDataSize,                 // out
-    BYTE**                outData                      // out
-);
-extern TSS_RESULT Tcsip_SetCapability
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TPM_CAPABILITY_AREA   capArea,                     // in
-    UINT32                subCapSize,                  // in
-    BYTE*                 subCap,                      // in
-    UINT32                valueSize,                   // in
-    BYTE*                 value,                       // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsip_GetAuditDigest
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                startOrdinal,                // in
-    TPM_DIGEST*           auditDigest,                 // out
-    UINT32*               counterValueSize,            // out
-    BYTE**                counterValue,                // out
-    TSS_BOOL*             more,                        // out
-    UINT32*               ordSize,                     // out
-    UINT32**              ordList                      // out
-);
-extern TSS_RESULT Tcsip_GetAuditDigestSigned
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    TCS_KEY_HANDLE        keyHandle,                   // in
-    TSS_BOOL              closeAudit,                  // in
-    TPM_NONCE             antiReplay,                  // in
-    TPM_AUTH*             privAuth,                    // in, out
-    UINT32*               counterValueSize,            // out
-    BYTE**                counterValue,                // out
-    TPM_DIGEST*           auditDigest,                 // out
-    TPM_DIGEST*           ordinalDigest,               // out
-    UINT32*               sigSize,                     // out
-    BYTE**                sig                          // out
-);
-extern TSS_RESULT Tcsip_SetOrdinalAuditStatus
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                ordinalToAudit,              // in
-    TSS_BOOL              auditState,                  // in
-    TPM_AUTH*             ownerAuth                    // in, out
-);
-extern TSS_RESULT Tcsi_Admin_TSS_SessionsPerLocality
-(
-    TCS_CONTEXT_HANDLE    hContext,                    // in
-    UINT32                ulLocality,                  // in
-    UINT32                ulSessions,                  // in
-    TPM_AUTH*             pOwnerAuth                   // in, out
-);
-extern TSS_RESULT Tcsi_GetCredential
-(
-    TCS_CONTEXT_HANDLE  hContext,               // in
-    UINT32              ulCredentialType,       // in
-    UINT32              ulCredentialAccessMode, // in
-    UINT32*             pulCredentialSize,      // out
-    BYTE**              prgbCredentialData      // out
-);
-
-#if defined __cplusplus
-} // extern "C"
-#endif
-
-#endif /* TCS_H */
+#ifndef TCS_H
+#define TCS_H
+#include <tss/platform.h>
+#include <tss/tss_structs.h>
+#include <tss/tcs_typedef.h>
+#include <tss/tcs_defines.h>
+#include <tss/tcs_structs.h>
+#include <tss/tcs_error.h>
+#include <tss/tpm.h>
+
+#if defined __cplusplus
+extern "C" {
+#endif 
+
+extern TSS_RESULT Tcsi_OpenContext
+(
+    TCS_CONTEXT_HANDLE*   hContext                     // out
+);
+extern TSS_RESULT Tcsi_CloseContext
+(
+    TCS_CONTEXT_HANDLE    hContext                     // in
+);
+extern TSS_RESULT Tcsi_FreeMemory
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    BYTE*                 pMemory                      // in
+);
+extern TSS_RESULT Tcsi_GetCapability
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_CAPABILITY_AREA   capArea,                     // in
+    UINT32                subCapSize,                  // in
+    BYTE*                 subCap,                      // in
+    UINT32*               respSize,                    // out
+    BYTE**                resp                         // out
+);
+extern TSS_RESULT Tcsi_RegisterKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_UUID              WrappingKeyUUID,             // in
+    TSS_UUID              KeyUUID,                     // in
+    UINT32                cKeySize,                    // in
+    BYTE*                 rgbKey,                      // in
+    UINT32                cVendorDataSize,             // in
+    BYTE*                 gbVendorData                 // in
+);
+extern TSS_RESULT Tcsip_UnregisterKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_UUID              KeyUUID                      // in
+);
+extern TSS_RESULT Tcsip_KeyControlOwner
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hKey,                        // in
+    UINT32                ulPubKeyLength,              // in
+    BYTE*                 prgbPubKey,                  // in
+    UINT32                attribName,                  // in
+    TSS_BOOL              attribValue,                 // in
+    TPM_AUTH*             pOwnerAuth,                  // in, out
+    TSS_UUID*             pUuidData                    // out
+);
+extern TSS_RESULT Tcsi_EnumRegisteredKeys
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_UUID*             pKeyUUID,                    // in
+    UINT32*               pcKeyHierarchySize,          // out
+    TSS_KM_KEYINFO**      ppKeyHierarchy               // out
+);
+extern TSS_RESULT Tcsi_GetRegisteredKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_UUID              KeyUUID,                     // in
+    TSS_KM_KEYINFO**      ppKeyInfo                    // out
+);
+extern TSS_RESULT Tcsi_GetRegisteredKeyBlob
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_UUID              KeyUUID,                     // in
+    UINT32*               pcKeySize,                   // out
+    BYTE**                prgbKey                      // out
+);
+extern TSS_RESULT Tcsip_GetRegisteredKeyByPublicInfo
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_ALGORITHM_ID      algID,                       // in
+    UINT32                ulPublicInfoLength,          // in
+    BYTE*                 rgbPublicInfo,               // in
+    UINT32*               keySize,                     // out
+    BYTE**                keyBlob                      // out
+);
+extern TSS_RESULT Tcsip_LoadKeyByBlob
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hUnwrappingKey,              // in
+    UINT32                cWrappedKeyBlobSize,         // in
+    BYTE*                 rgbWrappedKeyBlob,           // in
+    TPM_AUTH*             pAuth,                       // in, out
+    TCS_KEY_HANDLE*       phKeyTCSI,                   // out
+    TCS_KEY_HANDLE*       phKeyHMAC                    // out
+);
+extern TSS_RESULT Tcsip_LoadKeyByUUID
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_UUID              KeyUUID,                     // in
+    TCS_LOADKEY_INFO*     pLoadKeyInfo,                // in, out
+    TCS_KEY_HANDLE*       phKeyTCSI                    // out
+);
+extern TSS_RESULT Tcsip_EvictKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hKey                         // in
+);
+extern TSS_RESULT Tcsip_CreateWrapKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hWrappingKey,                // in
+    TPM_ENCAUTH           KeyUsageAuth,                // in
+    TPM_ENCAUTH           KeyMigrationAuth,            // in
+    UINT32                keyInfoSize,                 // in
+    BYTE*                 keyInfo,                     // in
+    TPM_AUTH*             pAuth,                       // in, out
+    UINT32*               keyDataSize,                 // out
+    BYTE**                keyData                      // out
+);
+extern TSS_RESULT Tcsip_GetPubKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hKey,                        // in
+    TPM_AUTH*             pAuth,                       // in, out
+    UINT32*               pcPubKeySize,                // out
+    BYTE**                prgbPubKey                   // out
+);
+extern TSS_RESULT Tcsip_MakeIdentity
+(
+    TCS_CONTEXT_HANDLE    hContext,                              // in
+    TPM_ENCAUTH           identityAuth,                          // in
+    TPM_CHOSENID_HASH     IDLabel_PrivCAHash,                    // in
+    UINT32                idIdentityKeyInfoSize,                 // in
+    BYTE*                 idIdentityKeyInfo,                     // in
+    TPM_AUTH*             pSrkAuth,                              // in, out
+    TPM_AUTH*             pOwnerAuth,                            // in, out
+    UINT32*               idIdentityKeySize,                     // out
+    BYTE**                idIdentityKey,                         // out
+    UINT32*               pcIdentityBindingSize,                 // out
+    BYTE**                prgbIdentityBinding,                   // out
+    UINT32*               pcEndorsementCredentialSize,           // out
+    BYTE**                prgbEndorsementCredential,             // out
+    UINT32*               pcPlatformCredentialSize,              // out
+    BYTE**                prgbPlatformCredential,                // out
+    UINT32*               pcConformanceCredentialSize,           // out
+    BYTE**                prgbConformanceCredential              // out
+);
+extern TSS_RESULT Tcsip_MakeIdentity2
+(
+    TCS_CONTEXT_HANDLE    hContext,                              // in
+    TPM_ENCAUTH           identityAuth,                          // in
+    TPM_CHOSENID_HASH     IDLabel_PrivCAHash,                    // in
+    UINT32                idIdentityKeyInfoSize,                 // in
+    BYTE*                 idIdentityKeyInfo,                     // in
+    TPM_AUTH*             pSrkAuth,                              // in, out
+    TPM_AUTH*             pOwnerAuth,                            // in, out
+    UINT32*               idIdentityKeySize,                     // out
+    BYTE**                idIdentityKey,                         // out
+    UINT32*               pcIdentityBindingSize,                 // out
+    BYTE**                prgbIdentityBinding                    // out
+);
+extern TSS_RESULT Tcsi_LogPcrEvent
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_PCR_EVENT         Event,                       // in
+    UINT32*               pNumber                      // out
+);
+extern TSS_RESULT Tcsi_GetPcrEvent
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                PcrIndex,                    // in
+    UINT32*               pNumber,                     // in, out
+    TSS_PCR_EVENT**       ppEvent                      // out
+);
+extern TSS_RESULT Tcsi_GetPcrEventsByPcr
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                PcrIndex,                    // in
+    UINT32                FirstEvent,                  // in
+    UINT32*               pEventCount,                 // in, out
+    TSS_PCR_EVENT**       ppEvents                     // out
+);
+extern TSS_RESULT Tcsi_GetPcrEventLog
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32*               pEventCount,                 // out
+    TSS_PCR_EVENT**       ppEvents                     // out
+);
+extern TSS_RESULT Tcsip_SetOwnerInstall
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_BOOL              state                        // in
+);
+extern TSS_RESULT Tcsip_TakeOwnership
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT16                protocolID,                  // in
+    UINT32                encOwnerAuthSize,            // in
+    BYTE*                 encOwnerAuth,                // in
+    UINT32                encSrkAuthSize,              // in
+    BYTE*                 encSrkAuth,                  // in
+    UINT32                srkKeyInfoSize,              // in
+    BYTE*                 srkKeyInfo,                  // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               srkKeyDataSize,              // out
+    BYTE**                srkKeyData                   // out
+);
+extern TSS_RESULT Tcsip_SetOperatorAuth
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_SECRET            operatorAuth                 // in
+);
+extern TSS_RESULT Tcsip_OIAP
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_AUTHHANDLE*       authHandle,                  // out
+    TPM_NONCE*            nonce0                       // out
+);
+extern TSS_RESULT Tcsip_OSAP
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_ENTITY_TYPE       entityType,                  // in
+    UINT32                entityValue,                 // in
+    TPM_NONCE             nonceOddOSAP,                // in
+    TCS_AUTHHANDLE*       authHandle,                  // out
+    TPM_NONCE*            nonceEven,                   // out
+    TPM_NONCE*            nonceEvenOSAP                // out
+);
+extern TSS_RESULT Tcsip_ChangeAuth
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        parentHandle,                // in
+    TPM_PROTOCOL_ID       protocolID,                  // in
+    TPM_ENCAUTH           newAuth,                     // in
+    TPM_ENTITY_TYPE       entityType,                  // in
+    UINT32                encDataSize,                 // in
+    BYTE*                 encData,                     // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    TPM_AUTH*             entityAuth,                  // in, out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_ChangeAuthOwner
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_PROTOCOL_ID       protocolID,                  // in
+    TPM_ENCAUTH           newAuth,                     // in
+    TPM_ENTITY_TYPE       entityType,                  // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_ChangeAuthAsymStart
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        idHandle,                    // in
+    TPM_NONCE             antiReplay,                  // in
+    UINT32                TempKeyInfoSize,             // in
+    BYTE*                 TempKeyInfoData,             // in
+    TPM_AUTH*             pAuth,                       // in, out
+    UINT32*               TempKeySize,                 // out
+    BYTE**                TempKeyData,                 // out
+    UINT32*               CertifyInfoSize,             // out
+    BYTE**                CertifyInfo,                 // out
+    UINT32*               sigSize,                     // out
+    BYTE**                sig,                         // out
+    TCS_KEY_HANDLE*       ephHandle                    // out
+);
+extern TSS_RESULT Tcsip_ChangeAuthAsymFinish
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        parentHandle,                // in
+    TCS_KEY_HANDLE        ephHandle,                   // in
+    TPM_ENTITY_TYPE       entityType,                  // in
+    TPM_HMAC              newAuthLink,                 // in
+    UINT32                newAuthSize,                 // in
+    BYTE*                 encNewAuth,                  // in
+    UINT32                encDataSizeIn,               // in
+    BYTE*                 encDataIn,                   // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               encDataSizeOut,              // out
+    BYTE**                encDataOut,                  // out
+    TPM_NONCE*            saltNonce,                   // out
+    TPM_DIGEST*           changeProof                  // out
+);
+extern TSS_RESULT Tcsip_TerminateHandle
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_AUTHHANDLE        handle                       // in
+);
+extern TSS_RESULT Tcsip_ActivateTPMIdentity
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        idKey,                       // in
+    UINT32                blobSize,                    // in
+    BYTE*                 blob,                        // in
+    TPM_AUTH*             idKeyAuth,                   // in, out
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               SymmetricKeySize,            // out
+    BYTE**                SymmetricKey                 // out
+);
+extern TSS_RESULT Tcsip_EstablishTransport
+(
+    TCS_CONTEXT_HANDLE            hContext,                      // in
+    UINT32                        ulTransControlFlags,           // in
+    TCS_KEY_HANDLE                hEncKey,                       // in
+    UINT32                        ulTransSessionInfoSize,        // in
+    BYTE*                         rgbTransSessionInfo,           // in
+    UINT32                        ulSecretSize,                  // in
+    BYTE*                         rgbSecret,                     // in
+    TPM_AUTH*                     pEncKeyAuth,                   // in, out
+    TPM_MODIFIER_INDICATOR*       pbLocality,                    // out
+    TCS_HANDLE*                   hTransSession,                 // out
+    UINT32*                       ulCurrentTicksSize,            // out
+    BYTE**                        prgbCurrentTicks,              // out
+    TPM_NONCE*                    pTransNonce                    // out
+);
+extern TSS_RESULT Tcsip_ExecuteTransport
+(
+    TCS_CONTEXT_HANDLE            hContext,                      // in
+    TPM_COMMAND_CODE              unWrappedCommandOrdinal,       // in
+    UINT32                        ulWrappedCmdParamInSize,       // in
+    BYTE*                         rgbWrappedCmdParamIn,          // in
+    UINT32*                       pulHandleListSize,             // in, out
+    TCS_HANDLE**                  rghHandles,                    // in, out
+    TPM_AUTH*                     pWrappedCmdAuth1,              // in, out
+    TPM_AUTH*                     pWrappedCmdAuth2,              // in, out
+    TPM_AUTH*                     pTransAuth,                    // in, out
+    UINT64*                       punCurrentTicks,               // out
+    TPM_MODIFIER_INDICATOR*       pbLocality,                    // out
+    TPM_RESULT*                   pulWrappedCmdReturnCode,       // out
+    UINT32*                       ulWrappedCmdParamOutSize,      // out
+    BYTE**                        rgbWrappedCmdParamOut          // out
+);
+extern TSS_RESULT Tcsip_ReleaseTransportSigned
+(
+    TCS_CONTEXT_HANDLE            hContext,            // in
+    TCS_KEY_HANDLE                hSignatureKey,       // in
+    TPM_NONCE                     AntiReplayNonce,     // in
+    TPM_AUTH*                     pKeyAuth,            // in, out
+    TPM_AUTH*                     pTransAuth,          // in, out
+    TPM_MODIFIER_INDICATOR*       pbLocality,          // out
+    UINT32*                       pulCurrentTicksSize, // out
+    BYTE**                        prgbCurrentTicks,    // out
+    UINT32*                       pulSignatureSize,    // out
+    BYTE**                        prgbSignature        // out
+);
+extern TSS_RESULT Tcsip_Extend
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_PCRINDEX          pcrNum,                      // in
+    TPM_DIGEST            inDigest,                    // in
+    TPM_PCRVALUE*         outDigest                    // out
+);
+extern TSS_RESULT Tcsip_PcrRead
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_PCRINDEX          pcrNum,                      // in
+    TPM_PCRVALUE*         outDigest                    // out
+);
+extern TSS_RESULT Tcsip_Quote
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_NONCE             antiReplay,                  // in
+    UINT32                pcrTargetSize,               // in
+    BYTE*                 pcrTarget,                   // in
+    TPM_AUTH*             privAuth,                    // in, out
+    UINT32*               pcrDataSize,                 // out
+    BYTE**                pcrData,                     // out
+    UINT32*               sigSize,                     // out
+    BYTE**                sig                          // out
+);
+extern TSS_RESULT Tcsip_Quote2
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_NONCE             antiReplay,                  // in
+    UINT32                pcrTargetSize,               // in
+    BYTE*                 pcrTarget,                   // in
+    TSS_BOOL              addVersion,                  // in
+    TPM_AUTH*             privAuth,                    // in, out
+    UINT32*               pcrDataSize,                 // out
+    BYTE**                pcrData,                     // out
+    UINT32*               versionInfoSize,             // out
+    BYTE**                versionInfo,                 // out
+    UINT32*               sigSize,                     // out
+    BYTE**                sig                          // out
+);
+extern TSS_RESULT Tcsip_DirWriteAuth
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_DIRINDEX          dirIndex,                    // in
+    TPM_DIRVALUE          newContents,                 // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_DirRead
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_DIRINDEX          dirIndex,                    // in
+    TPM_DIRVALUE*         dirValue                     // out
+);
+extern TSS_RESULT Tcsip_Seal
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_ENCAUTH           encAuth,                     // in
+    UINT32                pcrInfoSize,                 // in
+    BYTE*                 PcrInfo,                     // in
+    UINT32                inDataSize,                  // in
+    BYTE*                 inData,                      // in
+    TPM_AUTH*             pubAuth,                     // in, out
+    UINT32*               SealedDataSize,              // out
+    BYTE**                SealedData                   // out
+);
+extern TSS_RESULT Tcsip_Unseal
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    UINT32                SealedDataSize,              // in
+    BYTE*                 SealedData,                  // in
+    TPM_AUTH*             keyAuth,                     // in, out
+    TPM_AUTH*             dataAuth,                    // in, out
+    UINT32*               DataSize,                    // out
+    BYTE**                Data                         // out
+);
+extern TSS_RESULT Tcsip_UnBind
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    UINT32                inDataSize,                  // in
+    BYTE*                 inData,                      // in
+    TPM_AUTH*             privAuth,                    // in, out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_Sealx
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_ENCAUTH           encAuth,                     // in
+    UINT32                pcrInfoSize,                 // in
+    BYTE*                 PcrInfo,                     // in
+    UINT32                inDataSize,                  // in
+    BYTE*                 inData,                      // in
+    TPM_AUTH*             pubAuth,                     // in, out
+    UINT32*               SealedDataSize,              // out
+    BYTE**                SealedData                   // out
+);
+extern TSS_RESULT Tcsip_LoadKey2ByBlob
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hUnwrappingKey,              // in
+    UINT32                cWrappedKeyBlobSize,         // in
+    BYTE*                 rgbWrappedKeyBlob,           // in
+    TPM_AUTH*             pAuth,                       // in, out
+    TCS_KEY_HANDLE*       phKeyTCSI                    // out
+);
+extern TSS_RESULT Tcsip_CreateMigrationBlob
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        parentHandle,                // in
+    TSS_MIGRATE_SCHEME    migrationType,               // in
+    UINT32                MigrationKeyAuthSize,        // in
+    BYTE*                 MigrationKeyAuth,            // in
+    UINT32                encDataSize,                 // in
+    BYTE*                 encData,                     // in
+    TPM_AUTH*             parentAuth,                  // in, out
+    TPM_AUTH*             entityAuth,                  // in, out
+    UINT32*               randomSize,                  // out
+    BYTE**                random,                      // out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_ConvertMigrationBlob
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        parentHandle,                // in
+    UINT32                inDataSize,                  // in
+    BYTE*                 inData,                      // in
+    UINT32                randomSize,                  // in
+    BYTE*                 random,                      // in
+    TPM_AUTH*             parentAuth,                  // in, out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_AuthorizeMigrationKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_MIGRATE_SCHEME    migrateScheme,               // in
+    UINT32                MigrationKeySize,            // in
+    BYTE*                 MigrationKey,                // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               MigrationKeyAuthSize,        // out
+    BYTE**                MigrationKeyAuth             // out
+);
+extern TSS_RESULT Tcsip_CertifyKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        certHandle,                  // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_NONCE             antiReplay,                  // in
+    TPM_AUTH*             certAuth,                    // in, out
+    TPM_AUTH*             keyAuth,                     // in, out
+    UINT32*               CertifyInfoSize,             // out
+    BYTE**                CertifyInfo,                 // out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_CertifyKey2
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        certHandle,                  // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_DIGEST            MSAdigest,                   // in
+    TPM_NONCE             antiReplay,                  // in
+    TPM_AUTH*             certAuth,                    // in, out
+    TPM_AUTH*             keyAuth,                     // in, out
+    UINT32*               CertifyInfoSize,             // out
+    BYTE**                CertifyInfo,                 // out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_Sign
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    UINT32                areaToSignSize,              // in
+    BYTE*                 areaToSign,                  // in
+    TPM_AUTH*             privAuth,                    // in, out
+    UINT32*               sigSize,                     // out
+    BYTE**                sig                          // out
+);
+extern TSS_RESULT Tcsip_GetRandom
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32*               bytesRequested,              // in, out
+    BYTE**                randomBytes                  // out
+);
+extern TSS_RESULT Tcsip_StirRandom
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                inDataSize,                  // in
+    BYTE*                 inData                       // in
+);
+extern TSS_RESULT Tcsip_GetCapability
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_CAPABILITY_AREA   capArea,                     // in
+    UINT32                subCapSize,                  // in
+    BYTE*                 subCap,                      // in
+    UINT32*               respSize,                    // out
+    BYTE**                resp                         // out
+);
+extern TSS_RESULT Tcsip_GetCapabilitySigned
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_NONCE             antiReplay,                  // in
+    TPM_CAPABILITY_AREA   capArea,                     // in
+    UINT32                subCapSize,                  // in
+    BYTE*                 subCap,                      // in
+    TPM_AUTH*             privAuth,                    // in, out
+    TPM_VERSION*          Version,                     // out
+    UINT32*               respSize,                    // out
+    BYTE**                resp,                        // out
+    UINT32*               sigSize,                     // out
+    BYTE**                sig                          // out
+);
+extern TSS_RESULT Tcsip_GetCapabilityOwner
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_AUTH*             pOwnerAuth,                  // in, out
+    TPM_VERSION*          pVersion,                    // out
+    UINT32*               pNonVolatileFlags,           // out
+    UINT32*               pVolatileFlags               // out
+);
+extern TSS_RESULT Tcsip_CreateEndorsementKeyPair
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_NONCE             antiReplay,                  // in
+    UINT32                endorsementKeyInfoSize,      // in
+    BYTE*                 endorsementKeyInfo,          // in
+    UINT32*               endorsementKeySize,          // out
+    BYTE**                endorsementKey,              // out
+    TPM_DIGEST*           checksum                     // out
+);
+extern TSS_RESULT Tcsip_ReadPubek
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_NONCE             antiReplay,                  // in
+    UINT32*               pubEndorsementKeySize,       // out
+    BYTE**                pubEndorsementKey,           // out
+    TPM_DIGEST*           checksum                     // out
+);
+extern TSS_RESULT Tcsip_DisablePubekRead
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_OwnerReadPubek
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               pubEndorsementKeySize,       // out
+    BYTE**                pubEndorsementKey            // out
+);
+extern TSS_RESULT Tcsip_SelfTestFull
+(
+    TCS_CONTEXT_HANDLE    hContext                     // in
+);
+extern TSS_RESULT Tcsip_CertifySelfTest
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_NONCE             antiReplay,                  // in
+    TPM_AUTH*             privAuth,                    // in, out
+    UINT32*               sigSize,                     // out
+    BYTE**                sig                          // out
+);
+extern TSS_RESULT Tcsip_ContinueSelfTest
+(
+    TCS_CONTEXT_HANDLE    hContext                     // in
+);
+extern TSS_RESULT Tcsip_GetTestResult
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_OwnerSetDisable
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_BOOL              disableState,                // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_OwnerClear
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_DisableOwnerClear
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_ForceClear
+(
+    TCS_CONTEXT_HANDLE    hContext                     // in
+);
+extern TSS_RESULT Tcsip_DisableForceClear
+(
+    TCS_CONTEXT_HANDLE    hContext                     // in
+);
+extern TSS_RESULT Tcsip_PhysicalDisable
+(
+    TCS_CONTEXT_HANDLE    hContext                     // in
+);
+extern TSS_RESULT Tcsip_PhysicalEnable
+(
+    TCS_CONTEXT_HANDLE    hContext                     // in
+);
+extern TSS_RESULT Tcsip_PhysicalSetDeactivated
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_BOOL              state                        // in
+);
+extern TSS_RESULT Tcsip_SetTempDeactivated
+(
+    TCS_CONTEXT_HANDLE    hContext                     // in
+);
+extern TSS_RESULT Tcsip_SetTempDeactivated2
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_AUTH*             pOperatorAuth                // in, out
+);
+extern TSS_RESULT Tcsip_OwnerReadInternalPub
+(
+    TCS_CONTEXT_HANDLE   hContext,                     // in
+    TCS_KEY_HANDLE       hKey,                         // in
+    TPM_AUTH*            pOwnerAuth,                   // in, out
+    UINT32*              punPubKeySize,                // out
+    BYTE**               ppbPubKeyData                 // out
+);
+extern TSS_RESULT Tcsip_PhysicalPresence
+(
+    TCS_CONTEXT_HANDLE            hContext,            // in
+    TPM_PHYSICAL_PRESENCE         fPhysicalPresence    // in
+);
+extern TSS_RESULT Tcsip_FieldUpgrade
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                dataInSize,                  // in
+    BYTE*                 dataIn,                      // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               dataOutSize,                 // out
+    BYTE**                dataOut                      // out
+);
+extern TSS_RESULT Tcsip_ResetLockValue
+(
+    TCS_CONTEXT_HANDLE            hContext,            // in
+    TPM_AUTH*                     ownerAuth            // in, out
+);
+extern TSS_RESULT Tcsip_FlushSpecific
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_HANDLE            hResHandle,                  // in
+    TPM_RESOURCE_TYPE     resourceType                 // in
+);
+extern TSS_RESULT Tcsip_SetRedirection
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    UINT32                c1,                          // in
+    UINT32                c2,                          // in
+    TPM_AUTH*             privAuth                     // in, out
+);
+extern TSS_RESULT Tcsip_DSAP
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_ENTITY_TYPE       entityType,                  // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TPM_NONCE             nonceOddDSAP,                // in
+    UINT32                entityValueSize,             // in
+    BYTE*                 entityValue,                 // in
+    TCS_AUTHHANDLE*       authHandle,                  // out
+    TPM_NONCE*            nonceEven,                   // out
+    TPM_NONCE*            nonceEvenDSAP                // out
+);
+extern TSS_RESULT Tcsip_Delegate_Manage
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_FAMILY_ID         familyID,                    // in
+    TPM_FAMILY_OPERATION  opFlag,                      // in
+    UINT32                opDataSize,                  // in
+    BYTE*                 opData,                      // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               retDataSize,                 // out
+    BYTE**                retData                      // out
+);
+extern TSS_RESULT Tcsip_Delegate_CreateKeyDelegation
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hKey,                        // in
+    UINT32                publicInfoSize,              // in
+    BYTE*                 publicInfo,                  // in
+    TPM_ENCAUTH           encDelAuth,                  // in
+    TPM_AUTH*             keyAuth,                     // in, out
+    UINT32*               blobSize,                    // out
+    BYTE**                blob                         // out
+);
+extern TSS_RESULT Tcsip_Delegate_CreateOwnerDelegation
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_BOOL              increment,                   // in
+    UINT32                publicInfoSize,              // in
+    BYTE*                 publicInfo,                  // in
+    TPM_ENCAUTH           encDelAuth,                  // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               blobSize,                    // out
+    BYTE**                blob                         // out
+);
+extern TSS_RESULT Tcsip_Delegate_LoadOwnerDelegation
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_DELEGATE_INDEX    index,                       // in
+    UINT32                blobSize,                    // in
+    BYTE*                 blob,                        // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_Delegate_UpdateVerificationCount
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                inputSize,                   // in
+    BYTE*                 input,                       // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               outputSize,                  // out
+    BYTE**                output                       // out
+);
+extern TSS_RESULT Tcsip_Delegate_VerifyDelegation
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                delegateSize,                // in
+    BYTE*                 delegate                     // in
+);
+extern TSS_RESULT Tcsip_Delegate_ReadTable
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32*               pulFamilyTableSize,          // out
+    BYTE**                ppFamilyTable,               // out
+    UINT32*               pulDelegateTableSize,        // out
+    BYTE**                ppDelegateTable              // out
+);
+extern TSS_RESULT Tcsip_NV_DefineOrReleaseSpace
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                cPubInfoSize,                // in
+    BYTE*                 pPubInfo,                    // in
+    TPM_ENCAUTH           encAuth,                     // in
+    TPM_AUTH*             pAuth                        // in, out
+);
+extern TSS_RESULT Tcsip_NV_WriteValue
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_NV_INDEX          hNVStore,                    // in
+    UINT32                offset,                      // in
+    UINT32                ulDataLength,                // in
+    BYTE*                 rgbDataToWrite,              // in
+    TPM_AUTH*             privAuth                     // in, out
+);
+extern TSS_RESULT Tcsip_NV_WriteValueAuth
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_NV_INDEX          hNVStore,                    // in
+    UINT32                offset,                      // in
+    UINT32                ulDataLength,                // in
+    BYTE*                 rgbDataToWrite,              // in
+    TPM_AUTH*             NVAuth                       // in, out
+);
+extern TSS_RESULT Tcsip_NV_ReadValue
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_NV_INDEX          hNVStore,                    // in
+    UINT32                offset,                      // in
+    UINT32*               pulDataLength,               // in, out
+    TPM_AUTH*             privAuth,                    // in, out
+    BYTE**                rgbDataRead                  // out
+);
+extern TSS_RESULT Tcsip_NV_ReadValueAuth
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_NV_INDEX          hNVStore,                    // in
+    UINT32                offset,                      // in
+    UINT32*               pulDataLength,               // in, out
+    TPM_AUTH*             NVAuth,                      // in, out
+    BYTE**                rgbDataRead                  // out
+);
+extern TSS_RESULT Tcsip_CreateMaintenanceArchive
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_BOOL              generateRandom,              // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               randomSize,                  // out
+    BYTE**                random,                      // out
+    UINT32*               archiveSize,                 // out
+    BYTE**                archive                      // out
+);
+extern TSS_RESULT Tcsip_LoadMaintenanceArchive
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                dataInSize,                  // in
+    BYTE*                 dataIn,                      // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               dataOutSize,                 // out
+    BYTE**                dataOut                      // out
+);
+extern TSS_RESULT Tcsip_KillMaintenanceFeature
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_LoadManuMaintPub
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_NONCE             antiReplay,                  // in
+    UINT32                PubKeySize,                  // in
+    BYTE*                 PubKey,                      // in
+    TPM_DIGEST*           checksum                     // out
+);
+extern TSS_RESULT Tcsip_ReadManuMaintPub
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_NONCE             antiReplay,                  // in
+    TPM_DIGEST*           checksum                     // out
+);
+extern TSS_RESULT Tcsip_CreateRevocableEndorsementKeyPair
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_NONCE             antiReplay,                  // in
+    UINT32                endorsementKeyInfoSize,      // in
+    BYTE*                 endorsementKeyInfo,          // in
+    TSS_BOOL              GenResetAuth,                // in
+    TPM_DIGEST*           EKResetAuth,                 // in, out
+    UINT32*               endorsementKeySize,          // out
+    BYTE**                endorsementKey,              // out
+    TPM_DIGEST*           checksum                     // out
+);
+extern TSS_RESULT Tcsip_RevokeEndorsementKeyPair
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_DIGEST            EKResetAuth                  // in
+);
+extern TSS_RESULT Tcsip_PcrReset
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                pcrTargetSize,               // in
+    BYTE*                 pcrTarget                    // in
+);
+extern TSS_RESULT Tcsip_ReadCounter
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_COUNTER_ID        idCounter,                   // in
+    TPM_COUNTER_VALUE*    counterValue                 // out
+);
+extern TSS_RESULT Tcsip_CreateCounter
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                LabelSize,                   // in (=4)
+    BYTE*                 pLabel,                      // in
+    TPM_ENCAUTH           CounterAuth,                 // in
+    TPM_AUTH*             pOwnerAuth,                  // in, out
+    TSS_COUNTER_ID*       idCounter,                   // out
+    TPM_COUNTER_VALUE*    counterValue                 // out
+);
+extern TSS_RESULT Tcsip_IncrementCounter
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_COUNTER_ID        idCounter,                   // in
+    TPM_AUTH*             pCounterAuth,                // in, out
+    TPM_COUNTER_VALUE*    counterValue                 // out
+);
+extern TSS_RESULT Tcsip_ReleaseCounter
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_COUNTER_ID        idCounter,                   // in
+    TPM_AUTH*             pCounterAuth                 // in, out
+);
+extern TSS_RESULT Tcsip_ReleaseCounterOwner
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_COUNTER_ID        idCounter,                   // in
+    TPM_AUTH*             pOwnerAuth                   // in, out
+);
+extern TSS_RESULT Tcsip_ReadCurrentTicks
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32*               pulCurrentTimeSize,          // out
+    BYTE**                prgbCurrentTime              // out
+);
+extern TSS_RESULT Tcsip_TickStampBlob
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hKey,                        // in
+    TPM_NONCE             antiReplay,                  // in
+    TPM_DIGEST            digestToStamp,               // in
+    TPM_AUTH*             privAuth,                    // in, out
+    UINT32*               pulSignatureLength,          // out
+    BYTE**                prgbSignature,               // out
+    UINT32*               pulTickCountSize,            // out
+    BYTE**                prgbTickCount                // out
+);
+extern TSS_RESULT Tcsip_TPM_DAA_Join
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_HANDLE            handle,                      // in
+    BYTE                  stage,                       // in
+    UINT32                inputSize0,                  // in
+    BYTE*                 inputData0,                  // in
+    UINT32                inputSize1,                  // in
+    BYTE*                 inputData1,                  // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               outputSize,                  // out
+    BYTE**                outputData                   // out
+);
+extern TSS_RESULT Tcsip_TPM_DAA_Sign
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_HANDLE            handle,                      // in
+    BYTE                  stage,                       // in
+    UINT32                inputSize0,                  // in
+    BYTE*                 inputData0,                  // in
+    UINT32                inputSize1,                  // in
+    BYTE*                 inputData1,                  // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               outputSize,                  // out
+    BYTE**                outputData                   // out
+);
+extern TSS_RESULT Tcsip_MigrateKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hMaKey,                      // in
+    UINT32                PublicKeySize,               // in
+    BYTE*                 PublicKey,                   // in
+    UINT32                inDataSize,                  // in
+    BYTE*                 inData,                      // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_CMK_SetRestrictions
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TSS_CMK_DELEGATE      Restriction,                 // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_CMK_ApproveMA
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_DIGEST            migAuthorityDigest,          // in
+    TPM_AUTH*             ownerAuth,                   // in, out
+    TPM_HMAC*             HmacMigAuthDigest            // out
+);
+extern TSS_RESULT Tcsip_CMK_CreateKey
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        hWrappingKey,                // in
+    TPM_ENCAUTH           KeyUsageAuth,                // in
+    TPM_HMAC              MigAuthApproval,             // in
+    TPM_DIGEST            MigAuthorityDigest,          // in
+    UINT32*               keyDataSize,                 // in, out
+    BYTE**                prgbKeyData,                 // in, out
+    TPM_AUTH*             pAuth                        // in, out
+);
+extern TSS_RESULT Tcsip_CMK_CreateTicket
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                PublicVerifyKeySize,         // in
+    BYTE*                 PublicVerifyKey,             // in
+    TPM_DIGEST            SignedData,                  // in
+    UINT32                SigValueSize,                // in
+    BYTE*                 SigValue,                    // in
+    TPM_AUTH*             pOwnerAuth,                  // in, out
+    TPM_HMAC*             SigTicket                    // out
+);
+extern TSS_RESULT Tcsip_CMK_CreateBlob
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        parentHandle,                // in
+    TSS_MIGRATE_SCHEME    migrationType,               // in
+    UINT32                MigrationKeyAuthSize,        // in
+    BYTE*                 MigrationKeyAuth,            // in
+    TPM_DIGEST            PubSourceKeyDigest,          // in
+    UINT32                msaListSize,                 // in
+    BYTE*                 msaList,                     // in
+    UINT32                restrictTicketSize,          // in
+    BYTE*                 restrictTicket,              // in
+    UINT32                sigTicketSize,               // in
+    BYTE*                 sigTicket,                   // in
+    UINT32                encDataSize,                 // in
+    BYTE*                 encData,                     // in
+    TPM_AUTH*             parentAuth,                  // in, out
+    UINT32*               randomSize,                  // out
+    BYTE**                random,                      // out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_CMK_ConvertMigration
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        parentHandle,                // in
+    TPM_CMK_AUTH          restrictTicket,              // in
+    TPM_HMAC              sigTicket,                   // in
+    UINT32                keyDataSize,                 // in
+    BYTE*                 prgbKeyData,                 // in
+    UINT32                msaListSize,                 // in
+    BYTE*                 msaList,                     // in
+    UINT32                randomSize,                  // in
+    BYTE*                 random,                      // in
+    TPM_AUTH*             parentAuth,                  // in, out
+    UINT32*               outDataSize,                 // out
+    BYTE**                outData                      // out
+);
+extern TSS_RESULT Tcsip_SetCapability
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TPM_CAPABILITY_AREA   capArea,                     // in
+    UINT32                subCapSize,                  // in
+    BYTE*                 subCap,                      // in
+    UINT32                valueSize,                   // in
+    BYTE*                 value,                       // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsip_GetAuditDigest
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                startOrdinal,                // in
+    TPM_DIGEST*           auditDigest,                 // out
+    UINT32*               counterValueSize,            // out
+    BYTE**                counterValue,                // out
+    TSS_BOOL*             more,                        // out
+    UINT32*               ordSize,                     // out
+    UINT32**              ordList                      // out
+);
+extern TSS_RESULT Tcsip_GetAuditDigestSigned
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    TCS_KEY_HANDLE        keyHandle,                   // in
+    TSS_BOOL              closeAudit,                  // in
+    TPM_NONCE             antiReplay,                  // in
+    TPM_AUTH*             privAuth,                    // in, out
+    UINT32*               counterValueSize,            // out
+    BYTE**                counterValue,                // out
+    TPM_DIGEST*           auditDigest,                 // out
+    TPM_DIGEST*           ordinalDigest,               // out
+    UINT32*               sigSize,                     // out
+    BYTE**                sig                          // out
+);
+extern TSS_RESULT Tcsip_SetOrdinalAuditStatus
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                ordinalToAudit,              // in
+    TSS_BOOL              auditState,                  // in
+    TPM_AUTH*             ownerAuth                    // in, out
+);
+extern TSS_RESULT Tcsi_Admin_TSS_SessionsPerLocality
+(
+    TCS_CONTEXT_HANDLE    hContext,                    // in
+    UINT32                ulLocality,                  // in
+    UINT32                ulSessions,                  // in
+    TPM_AUTH*             pOwnerAuth                   // in, out
+);
+extern TSS_RESULT Tcsi_GetCredential
+(
+    TCS_CONTEXT_HANDLE  hContext,               // in
+    UINT32              ulCredentialType,       // in
+    UINT32              ulCredentialAccessMode, // in
+    UINT32*             pulCredentialSize,      // out
+    BYTE**              prgbCredentialData      // out
+);
+
+#if defined __cplusplus
+} // extern "C"
+#endif
+
+#endif /* TCS_H */
diff -ru trousers-0.3.8-orig/src/include/tss/tddl_error.h trousers-0.3.8/src/include/tss/tddl_error.h
--- trousers-0.3.8-orig/src/include/tss/tddl_error.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tddl_error.h	2012-02-14 20:35:05.911043332 +0000
@@ -1,51 +1,51 @@
-/*++
-
-TPM Device Driver Library error return codes 
- 
---*/
-
-#ifndef __TDDL_ERROR_H__
-#define __TDDL_ERROR_H__
-
-#include <tss/tss_error_basics.h>
-#include <tss/tss_error.h>
-
-
-#ifndef TSS_E_BASE
-#define TSS_E_BASE      0x00000000L
-#endif // TSS_E_BASE
-
-
-//
-// specific error codes returned by the TPM device driver library
-// offset TSS_TDDL_OFFSET
-//
-#define TDDL_E_FAIL 		TSS_E_FAIL
-#define TDDL_E_TIMEOUT 		TSS_E_TIMEOUT
-
-// The connection was already established.
-#define TDDL_E_ALREADY_OPENED   (UINT32)(TSS_E_BASE + 0x081L)
-
-// The device was not connected.
-#define TDDL_E_ALREADY_CLOSED   (UINT32)(TSS_E_BASE + 0x082L)
-
-// The receive buffer is too small.
-#define TDDL_E_INSUFFICIENT_BUFFER  (UINT32)(TSS_E_BASE + 0x083L)
-
-// The command has already completed.
-#define TDDL_E_COMMAND_COMPLETED  (UINT32)(TSS_E_BASE + 0x084L)
-
-// TPM aborted processing of command.
-#define TDDL_E_COMMAND_ABORTED  (UINT32)(TSS_E_BASE + 0x085L)
-
-//  The request could not be performed because of an I/O device error.
-#define TDDL_E_IOERROR    (UINT32)(TSS_E_BASE + 0x087L)
-
-// Unsupported TAG is requested
-#define TDDL_E_BADTAG    (UINT32)(TSS_E_BASE + 0x088L)
-
-// the requested TPM component was not found
-#define TDDL_E_COMPONENT_NOT_FOUND  (UINT32)(TSS_E_BASE + 0x089L)
-
-#endif // __TDDL_ERROR_H__
-
+/*++
+
+TPM Device Driver Library error return codes 
+ 
+--*/
+
+#ifndef __TDDL_ERROR_H__
+#define __TDDL_ERROR_H__
+
+#include <tss/tss_error_basics.h>
+#include <tss/tss_error.h>
+
+
+#ifndef TSS_E_BASE
+#define TSS_E_BASE      0x00000000L
+#endif // TSS_E_BASE
+
+
+//
+// specific error codes returned by the TPM device driver library
+// offset TSS_TDDL_OFFSET
+//
+#define TDDL_E_FAIL 		TSS_E_FAIL
+#define TDDL_E_TIMEOUT 		TSS_E_TIMEOUT
+
+// The connection was already established.
+#define TDDL_E_ALREADY_OPENED   (UINT32)(TSS_E_BASE + 0x081L)
+
+// The device was not connected.
+#define TDDL_E_ALREADY_CLOSED   (UINT32)(TSS_E_BASE + 0x082L)
+
+// The receive buffer is too small.
+#define TDDL_E_INSUFFICIENT_BUFFER  (UINT32)(TSS_E_BASE + 0x083L)
+
+// The command has already completed.
+#define TDDL_E_COMMAND_COMPLETED  (UINT32)(TSS_E_BASE + 0x084L)
+
+// TPM aborted processing of command.
+#define TDDL_E_COMMAND_ABORTED  (UINT32)(TSS_E_BASE + 0x085L)
+
+//  The request could not be performed because of an I/O device error.
+#define TDDL_E_IOERROR    (UINT32)(TSS_E_BASE + 0x087L)
+
+// Unsupported TAG is requested
+#define TDDL_E_BADTAG    (UINT32)(TSS_E_BASE + 0x088L)
+
+// the requested TPM component was not found
+#define TDDL_E_COMPONENT_NOT_FOUND  (UINT32)(TSS_E_BASE + 0x089L)
+
+#endif // __TDDL_ERROR_H__
+
diff -ru trousers-0.3.8-orig/src/include/tss/tddlapi_error.h trousers-0.3.8/src/include/tss/tddlapi_error.h
--- trousers-0.3.8-orig/src/include/tss/tddlapi_error.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tddlapi_error.h	2012-02-14 20:35:05.911335349 +0000
@@ -1,54 +1,54 @@
-/*++
-
-TDDL error return codes for the TPM Device Driver Library Interface (TDDLI)
- 
---*/
-
-#ifndef __TDDLAPI_ERROR_H__
-#define __TDDLAPI_ERROR_H__
-
-
-//
-// error coding scheme for a Microsoft Windows platform -
-// refer to the TSS Specification Parts
-//
-//  Values are 32 bit values layed out as follows:
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//  +---+-+-+-----------------------+-------+-----------------------+
-//  |Lev|C|R|     Facility          | Layer |         Code          |
-//  +---+-+-+-----------------------+-------+-----------------------+
-//  | Platform specific coding      | TSS error coding system       |
-//  +---+-+-+-----------------------+-------+-----------------------+
-//
-//      Lev - is the Level code
-//
-//          00 - Success
-//          01 - Informational
-//          10 - Warning
-//          11 - Error
-//
-//      C - is the Customer code flag  (must actually be set)
-//
-//      R - is a reserved bit    (unused)
-//
-//      Facility - is the facility code: TCPA: proposal 0x028
-//
-//      Code - is the facility's status code
-//
-
-
-// no macros are used below intentionally 
-// for a better error code recognition by the reader
-
-// note that the values of TPM_E_BASE and TSS_E_BASE, TSS_W_BASE and TSS_I_BASE
-// have to be adjusted for a platform other than Windows
-
-//
-// TPM specific error codes (layer nibble set to TPM layer TSS_LAYER_TPM)
-//
-
-
-#endif // __TDDLAPI_ERROR_H__
-
+/*++
+
+TDDL error return codes for the TPM Device Driver Library Interface (TDDLI)
+ 
+--*/
+
+#ifndef __TDDLAPI_ERROR_H__
+#define __TDDLAPI_ERROR_H__
+
+
+//
+// error coding scheme for a Microsoft Windows platform -
+// refer to the TSS Specification Parts
+//
+//  Values are 32 bit values layed out as follows:
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//  +---+-+-+-----------------------+-------+-----------------------+
+//  |Lev|C|R|     Facility          | Layer |         Code          |
+//  +---+-+-+-----------------------+-------+-----------------------+
+//  | Platform specific coding      | TSS error coding system       |
+//  +---+-+-+-----------------------+-------+-----------------------+
+//
+//      Lev - is the Level code
+//
+//          00 - Success
+//          01 - Informational
+//          10 - Warning
+//          11 - Error
+//
+//      C - is the Customer code flag  (must actually be set)
+//
+//      R - is a reserved bit    (unused)
+//
+//      Facility - is the facility code: TCPA: proposal 0x028
+//
+//      Code - is the facility's status code
+//
+
+
+// no macros are used below intentionally 
+// for a better error code recognition by the reader
+
+// note that the values of TPM_E_BASE and TSS_E_BASE, TSS_W_BASE and TSS_I_BASE
+// have to be adjusted for a platform other than Windows
+
+//
+// TPM specific error codes (layer nibble set to TPM layer TSS_LAYER_TPM)
+//
+
+
+#endif // __TDDLAPI_ERROR_H__
+
diff -ru trousers-0.3.8-orig/src/include/tss/tddli.h trousers-0.3.8/src/include/tss/tddli.h
--- trousers-0.3.8-orig/src/include/tss/tddli.h	2010-04-13 03:23:16.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tddli.h	2012-02-14 20:35:05.911656697 +0000
@@ -1,94 +1,94 @@
-/*++
-
-TPM Device Driver Library interface
- 
---*/
-
-#ifndef __TDDLI_H__
-#define __TDDLI_H__
-
-#include <tss/tss_typedef.h>
-#include <tss/tddl_error.h>
-
-#if !defined(TDDLI)
-#ifdef WIN32
-// --- This should be used on Windows platforms
-#ifdef TDDLI_EXPORTS
-#define TDDLI __declspec(dllexport)
-#else
-#define TDDLI __declspec(dllimport)
-#endif
-#else
-#define TDDLI 
-#endif
-#endif /* !defined(TDDLI) */
-
-
-#define TDDL_CAP_VERSION   0x0100
-#define TDDL_CAP_VER_DRV   0x0101
-#define TDDL_CAP_VER_FW    0x0102
-#define TDDL_CAP_VER_FW_DATE   0x0103
-
-#define TDDL_CAP_PROPERTY   0x0200
-#define TDDL_CAP_PROP_MANUFACTURER  0x0201
-#define TDDL_CAP_PROP_MODULE_TYPE  0x0202
-#define TDDL_CAP_PROP_GLOBAL_STATE  0x0203
-
-
-//--------------------------------------------------------------------
-// TDDL specific helper redefinitions
-
-#ifdef __cplusplus
-extern "C" {
-#endif
-
-    //establish a connection to the TPM device driver
-    TDDLI TSS_RESULT Tddli_Open(void);
- 
-    //close a open connection to the TPM device driver
-    TDDLI TSS_RESULT Tddli_Close(void);
-
-    //cancels the last outstanding TPM command
-    TDDLI TSS_RESULT Tddli_Cancel(void);
-
-    // read the attributes returned by the TPM HW/FW
-    TDDLI TSS_RESULT Tddli_GetCapability(
-        UINT32        CapArea,
-        UINT32        SubCap,
-        BYTE         *pCapBuf,
-        UINT32       *puntCapBufLen);
-
-    // set parameters to the TPM HW/FW
-    TDDLI TSS_RESULT Tddli_SetCapability(
-        UINT32        CapArea,
-        UINT32        SubCap,
-        BYTE         *pCapBuf,
-        UINT32        puntCapBufLen);
-
-    // get status of the TPM driver and device
-    TDDLI TSS_RESULT Tddli_GetStatus(
-        UINT32        ReqStatusType,
-        UINT32       *puntStatus);
-
-    // send any data to the TPM module
-    TDDLI TSS_RESULT Tddli_TransmitData(
-        BYTE         *pTransmitBuf,
-        UINT32        TransmitBufLen,
-        BYTE         *pReceiveBuf,
-        UINT32       *puntReceiveBufLen);
-
-    TDDLI TSS_RESULT Tddli_SetPowerManagement(
-        TSS_BOOL      SendSaveStateCommand,       // in
-        UINT32       *QuerySetNewTPMPowerState);  // in, out
-
-    TDDLI TSS_RESULT Tddli_PowerManagementControl(
-        TSS_BOOL      SendPowerManager,           // in
-        UINT32       *DriverManagesPowerStates);  // out
-
-    
-#ifdef __cplusplus
-}
-#endif
-
-#endif // __TDDLI_H__
-
+/*++
+
+TPM Device Driver Library interface
+ 
+--*/
+
+#ifndef __TDDLI_H__
+#define __TDDLI_H__
+
+#include <tss/tss_typedef.h>
+#include <tss/tddl_error.h>
+
+#if !defined(TDDLI)
+#ifdef WIN32
+// --- This should be used on Windows platforms
+#ifdef TDDLI_EXPORTS
+#define TDDLI __declspec(dllexport)
+#else
+#define TDDLI __declspec(dllimport)
+#endif
+#else
+#define TDDLI 
+#endif
+#endif /* !defined(TDDLI) */
+
+
+#define TDDL_CAP_VERSION   0x0100
+#define TDDL_CAP_VER_DRV   0x0101
+#define TDDL_CAP_VER_FW    0x0102
+#define TDDL_CAP_VER_FW_DATE   0x0103
+
+#define TDDL_CAP_PROPERTY   0x0200
+#define TDDL_CAP_PROP_MANUFACTURER  0x0201
+#define TDDL_CAP_PROP_MODULE_TYPE  0x0202
+#define TDDL_CAP_PROP_GLOBAL_STATE  0x0203
+
+
+//--------------------------------------------------------------------
+// TDDL specific helper redefinitions
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+    //establish a connection to the TPM device driver
+    TDDLI TSS_RESULT Tddli_Open(void);
+ 
+    //close a open connection to the TPM device driver
+    TDDLI TSS_RESULT Tddli_Close(void);
+
+    //cancels the last outstanding TPM command
+    TDDLI TSS_RESULT Tddli_Cancel(void);
+
+    // read the attributes returned by the TPM HW/FW
+    TDDLI TSS_RESULT Tddli_GetCapability(
+        UINT32        CapArea,
+        UINT32        SubCap,
+        BYTE         *pCapBuf,
+        UINT32       *puntCapBufLen);
+
+    // set parameters to the TPM HW/FW
+    TDDLI TSS_RESULT Tddli_SetCapability(
+        UINT32        CapArea,
+        UINT32        SubCap,
+        BYTE         *pCapBuf,
+        UINT32        puntCapBufLen);
+
+    // get status of the TPM driver and device
+    TDDLI TSS_RESULT Tddli_GetStatus(
+        UINT32        ReqStatusType,
+        UINT32       *puntStatus);
+
+    // send any data to the TPM module
+    TDDLI TSS_RESULT Tddli_TransmitData(
+        BYTE         *pTransmitBuf,
+        UINT32        TransmitBufLen,
+        BYTE         *pReceiveBuf,
+        UINT32       *puntReceiveBufLen);
+
+    TDDLI TSS_RESULT Tddli_SetPowerManagement(
+        TSS_BOOL      SendSaveStateCommand,       // in
+        UINT32       *QuerySetNewTPMPowerState);  // in, out
+
+    TDDLI TSS_RESULT Tddli_PowerManagementControl(
+        TSS_BOOL      SendPowerManager,           // in
+        UINT32       *DriverManagesPowerStates);  // out
+
+    
+#ifdef __cplusplus
+}
+#endif
+
+#endif // __TDDLI_H__
+
diff -ru trousers-0.3.8-orig/src/include/tss/tpm_error.h trousers-0.3.8/src/include/tss/tpm_error.h
--- trousers-0.3.8-orig/src/include/tss/tpm_error.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tpm_error.h	2012-02-14 20:35:05.912620272 +0000
@@ -1,963 +1,963 @@
-/*
- * The TPM error codes extracted from the TPM main specification
- * version 1.2 revision 85.
- */
-
-#ifndef __TPM_ERROR_H__
-#define __TPM_ERROR_H__
-
-
-#ifndef TPM_E_BASE
-#define TPM_E_BASE        ((UINT32)0)
-#endif
-
-#ifndef TPM_E_NON_FATAL
-#define TPM_E_NON_FATAL   ((UINT32)0x00000800)
-#endif
-
-
-// Successful completion of the TPM operation.
-#define TPM_SUCCESS    TPM_E_BASE
-
-//
-// MessageId: TPM_E_AUTHFAIL
-//
-// MessageText:
-//
-// Authentication failed
-//
-#define TPM_E_AUTHFAIL ((UINT32)(TPM_E_BASE + 0x00000001))
-
-//
-// MessageId: TPM_E_BADINDEX
-//
-// MessageText:
-//
-// The index to a PCR, DIR or other register is incorrect
-//
-#define TPM_E_BADINDEX ((UINT32)(TPM_E_BASE + 0x00000002))
-
-//
-// MessageId: TPM_E_BAD_PARAMETER
-//
-// MessageText:
-//
-// One or more parameter is bad
-//
-#define TPM_E_BAD_PARAMETER ((UINT32)(TPM_E_BASE + 0x00000003))
-
-//
-// MessageId: TPM_E_AUDITFAILURE
-//
-// MessageText:
-//
-// An operation completed successfully but the auditing of that
-// operation failed.
-//
-#define TPM_E_AUDITFAILURE ((UINT32)(TPM_E_BASE + 0x00000004))
-
-//
-// MessageId: TPM_E_CLEAR_DISABLED
-//
-// MessageText:
-//
-// The clear disable flag is set and all clear operations now require
-// physical access
-//
-#define TPM_E_CLEAR_DISABLED ((UINT32)(TPM_E_BASE + 0x00000005))
-
-//
-// MessageId: TPM_E_DEACTIVATED
-//
-// MessageText:
-//
-// The TPM is deactivated
-//
-#define TPM_E_DEACTIVATED ((UINT32)(TPM_E_BASE + 0x00000006))
-
-//
-// MessageId: TPM_E_DISABLED
-//
-// MessageText:
-//
-// The TPM is disabled
-//
-#define TPM_E_DISABLED ((UINT32)(TPM_E_BASE + 0x00000007))
-
-//
-// MessageId: TPM_E_DISABLED_CMD
-//
-// MessageText:
-//
-// The target command has been disabled
-//
-#define TPM_E_DISABLED_CMD ((UINT32)(TPM_E_BASE + 0x00000008))
-
-//
-// MessageId: TPM_E_FAIL
-//
-// MessageText:
-//
-// The operation failed
-//
-#define TPM_E_FAIL ((UINT32)(TPM_E_BASE + 0x00000009))
-
-//
-// MessageId: TPM_E_BAD_ORDINAL
-//
-// MessageText:
-//
-// The ordinal was unknown or inconsistent
-//
-#define TPM_E_BAD_ORDINAL ((UINT32)(TPM_E_BASE + 0x0000000a))
-
-//
-// MessageId: TPM_E_INSTALL_DISABLED
-//
-// MessageText:
-//
-// The ability to install an owner is disabled
-//
-#define TPM_E_INSTALL_DISABLED ((UINT32)(TPM_E_BASE + 0x0000000b))
-
-//
-// MessageId: TPM_E_INVALID_KEYHANDLE
-//
-// MessageText:
-//
-// The key handle can not be interpreted
-//
-#define TPM_E_INVALID_KEYHANDLE ((UINT32)(TPM_E_BASE + 0x0000000c))
-
-//
-// MessageId: TPM_E_KEYNOTFOUND
-//
-// MessageText:
-//
-// The key handle points to an invalid key
-//
-#define TPM_E_KEYNOTFOUND ((UINT32)(TPM_E_BASE + 0x0000000d))
-
-//
-// MessageId: TPM_E_INAPPROPRIATE_ENC
-//
-// MessageText:
-//
-// Unacceptable encryption scheme
-//
-#define TPM_E_INAPPROPRIATE_ENC ((UINT32)(TPM_E_BASE + 0x0000000e))
-
-//
-// MessageId: TPM_E_MIGRATEFAIL
-//
-// MessageText:
-//
-// Migration authorization failed
-//
-#define TPM_E_MIGRATEFAIL ((UINT32)(TPM_E_BASE + 0x0000000f))
-
-//
-// MessageId: TPM_E_INVALID_PCR_INFO
-//
-// MessageText:
-//
-// PCR information could not be interpreted
-//
-#define TPM_E_INVALID_PCR_INFO ((UINT32)(TPM_E_BASE + 0x00000010))
-
-//
-// MessageId: TPM_E_NOSPACE
-//
-// MessageText:
-//
-// No room to load key.
-//
-#define TPM_E_NOSPACE ((UINT32)(TPM_E_BASE + 0x00000011))
-
-//
-// MessageId: TPM_E_NOSRK
-//
-// MessageText:
-//
-// There is no SRK set
-//
-#define TPM_E_NOSRK ((UINT32)(TPM_E_BASE + 0x00000012))
-
-//
-// MessageId: TPM_E_NOTSEALED_BLOB
-//
-// MessageText:
-//
-// An encrypted blob is invalid or was not created by this TPM
-//
-#define TPM_E_NOTSEALED_BLOB ((UINT32)(TPM_E_BASE + 0x00000013))
-
-//
-// MessageId: TPM_E_OWNER_SET
-//
-// MessageText:
-//
-// There is already an Owner 
-//
-#define TPM_E_OWNER_SET ((UINT32)(TPM_E_BASE + 0x00000014))
-
-//
-// MessageId: TPM_E_RESOURCES
-//
-// MessageText:
-//
-// The TPM has insufficient internal resources to perform the
-// requested action.
-//
-#define TPM_E_RESOURCES ((UINT32)(TPM_E_BASE + 0x00000015))
-
-//
-// MessageId: TPM_E_SHORTRANDOM
-//
-// MessageText:
-//
-// A random string was too short
-//
-#define TPM_E_SHORTRANDOM ((UINT32)(TPM_E_BASE + 0x00000016))
-
-//
-// MessageId: TPM_E_SIZE
-//
-// MessageText:
-//
-// The TPM does not have the space to perform the operation.
-//
-#define TPM_E_SIZE ((UINT32)(TPM_E_BASE + 0x00000017))
-
-//
-// MessageId: TPM_E_WRONGPCRVAL
-//
-// MessageText:
-//
-// The named PCR value does not match the current PCR value.
-//
-#define TPM_E_WRONGPCRVAL ((UINT32)(TPM_E_BASE + 0x00000018))
-
-//
-// MessageId: TPM_E_BAD_PARAM_SIZE 
-//
-// MessageText:
-//
-// The paramSize argument to the command has the incorrect value 
-//
-#define TPM_E_BAD_PARAM_SIZE ((UINT32)(TPM_E_BASE + 0x00000019))
-
-//
-// MessageId: TPM_E_SHA_THREAD
-//
-// MessageText:
-//
-// There is no existing SHA-1 thread.
-//
-#define TPM_E_SHA_THREAD ((UINT32)(TPM_E_BASE + 0x0000001a))
-
-//
-// MessageId: TPM_E_SHA_ERROR
-//
-// MessageText:
-//
-// The calculation is unable to proceed because the existing SHA-1
-// thread has already encountered an error.
-//
-#define TPM_E_SHA_ERROR ((UINT32)(TPM_E_BASE + 0x0000001b))
-
-//
-// MessageId: TPM_E_FAILEDSELFTEST
-//
-// MessageText:
-//
-// Self-test has failed and the TPM has shutdown.
-//
-#define TPM_E_FAILEDSELFTEST ((UINT32)(TPM_E_BASE + 0x0000001c))
-
-//
-// MessageId: TPM_E_AUTH2FAIL
-//
-// MessageText:
-//
-// The authorization for the second key in a 2 key function failed
-// authorization
-//
-#define TPM_E_AUTH2FAIL ((UINT32)(TPM_E_BASE + 0x0000001d))
-
-//
-// MessageId: TPM_E_BADTAG
-//
-// MessageText:
-//
-// The tag value sent to for a command is invalid
-//
-#define TPM_E_BADTAG ((UINT32)(TPM_E_BASE + 0x0000001e))
-
-//
-// MessageId: TPM_E_IOERROR
-//
-// MessageText:
-//
-// An IO error occurred transmitting information to the TPM
-//
-#define TPM_E_IOERROR ((UINT32)(TPM_E_BASE + 0x0000001f))
-
-//
-// MessageId: TPM_E_ENCRYPT_ERROR
-//
-// MessageText:
-//
-// The encryption process had a problem.
-//
-#define TPM_E_ENCRYPT_ERROR ((UINT32)(TPM_E_BASE + 0x00000020))
-
-//
-// MessageId: TPM_E_DECRYPT_ERROR
-//
-// MessageText:
-//
-// The decryption process did not complete.
-//
-#define TPM_E_DECRYPT_ERROR ((UINT32)(TPM_E_BASE + 0x00000021))
-
-//
-// MessageId: TPM_E_INVALID_AUTHHANDLE
-//
-// MessageText:
-//
-// An invalid handle was used.
-//
-#define TPM_E_INVALID_AUTHHANDLE ((UINT32)(TPM_E_BASE + 0x00000022))
-
-//
-// MessageId: TPM_E_NO_ENDORSEMENT
-//
-// MessageText:
-//
-// The TPM does not a EK installed
-//
-#define TPM_E_NO_ENDORSEMENT ((UINT32)(TPM_E_BASE + 0x00000023))
-
-//
-// MessageId: TPM_E_INVALID_KEYUSAGE
-//
-// MessageText:
-//
-// The usage of a key is not allowed
-//
-#define TPM_E_INVALID_KEYUSAGE ((UINT32)(TPM_E_BASE + 0x00000024))
-
-//
-// MessageId: TPM_E_WRONG_ENTITYTYPE
-//
-// MessageText:
-//
-// The submitted entity type is not allowed
-//
-#define TPM_E_WRONG_ENTITYTYPE ((UINT32)(TPM_E_BASE + 0x00000025))
-
-//
-// MessageId: TPM_E_INVALID_POSTINIT
-//
-// MessageText:
-//
-// The command was received in the wrong sequence relative to TPM_Init
-// and a subsequent TPM_Startup
-//
-#define TPM_E_INVALID_POSTINIT ((UINT32)(TPM_E_BASE + 0x00000026))
-
-//
-// MessageId: TPM_E_INAPPROPRIATE_SIG
-//
-// MessageText:
-//
-// Signed data cannot include additional DER information
-//
-#define TPM_E_INAPPROPRIATE_SIG ((UINT32)(TPM_E_BASE + 0x00000027))
-
-//
-// MessageId: TPM_E_BAD_KEY_PROPERTY
-//
-// MessageText:
-//
-// The key properties in TPM_KEY_PARMs are not supported by this TPM
-//
-#define TPM_E_BAD_KEY_PROPERTY ((UINT32)(TPM_E_BASE + 0x00000028))
-
-//
-// MessageId: TPM_E_BAD_MIGRATION
-//
-// MessageText:
-//
-// The migration properties of this key are incorrect.
-//
-#define TPM_E_BAD_MIGRATION ((UINT32)(TPM_E_BASE + 0x00000029))
-
-//
-// MessageId: TPM_E_BAD_SCHEME
-//
-// MessageText:
-//
-// The signature or encryption scheme for this key is incorrect or not
-// permitted in this situation.
-//
-#define TPM_E_BAD_SCHEME ((UINT32)(TPM_E_BASE + 0x0000002a))
-
-//
-// MessageId: TPM_E_BAD_DATASIZE
-//
-// MessageText:
-//
-// The size of the data (or blob) parameter is bad or inconsistent
-// with the referenced key
-//
-#define TPM_E_BAD_DATASIZE ((UINT32)(TPM_E_BASE + 0x0000002b))
-
-//
-// MessageId: TPM_E_BAD_MODE
-//
-// MessageText:
-//
-// A mode parameter is bad, such as capArea or subCapArea for
-// TPM_GetCapability, physicalPresence parameter for
-// TPM_PhysicalPresence, or migrationType for TPM_CreateMigrationBlob.
-//
-#define TPM_E_BAD_MODE ((UINT32)(TPM_E_BASE + 0x0000002c))
-
-//
-// MessageId: TPM_E_BAD_PRESENCE
-//
-// MessageText:
-//
-// Either the physicalPresence or physicalPresenceLock bits have the
-// wrong value
-//
-#define TPM_E_BAD_PRESENCE ((UINT32)(TPM_E_BASE + 0x0000002d))
-
-//
-// MessageId: TPM_E_BAD_VERSION
-//
-// MessageText:
-//
-// The TPM cannot perform this version of the capability
-//
-#define TPM_E_BAD_VERSION ((UINT32)(TPM_E_BASE + 0x0000002e))
-
-//
-// MessageId: TPM_E_NO_WRAP_TRANSPORT
-//
-// MessageText:
-//
-// The TPM does not allow for wrapped transport sessions
-//
-#define TPM_E_NO_WRAP_TRANSPORT ((UINT32)(TPM_E_BASE + 0x0000002f))
-
-//
-// MessageId: TPM_E_AUDITFAIL_UNSUCCESSFUL
-//
-// MessageText:
-//
-// TPM audit construction failed and the underlying command was
-// returning a failure code also
-//
-#define TPM_E_AUDITFAIL_UNSUCCESSFUL ((UINT32)(TPM_E_BASE + 0x00000030))
-
-//
-// MessageId: TPM_E_AUDITFAIL_SUCCESSFUL
-//
-// MessageText:
-//
-// TPM audit construction failed and the underlying command was
-// returning success
-//
-#define TPM_E_AUDITFAIL_SUCCESSFUL ((UINT32)(TPM_E_BASE + 0x00000031))
-
-//
-// MessageId: TPM_E_NOTRESETABLE
-//
-// MessageText:
-//
-// Attempt to reset a PCR register that does not have the resettable
-// attribute
-//
-#define TPM_E_NOTRESETABLE ((UINT32)(TPM_E_BASE + 0x00000032))
-
-//
-// MessageId: TPM_E_NOTLOCAL
-//
-// MessageText:
-//
-// Attempt to reset a PCR register that requires locality and locality
-// modifier not part of command transport
-//
-#define TPM_E_NOTLOCAL ((UINT32)(TPM_E_BASE + 0x00000033))
-
-//
-// MessageId: TPM_E_BAD_TYPE
-//
-// MessageText:
-//
-// Make identity blob not properly typed
-//
-#define TPM_E_BAD_TYPE ((UINT32)(TPM_E_BASE + 0x00000034))
-
-//
-// MessageId: TPM_E_INVALID_RESOURCE
-//
-// MessageText:
-//
-// When saving context identified resource type does not match actual
-// resource
-//
-#define TPM_E_INVALID_RESOURCE ((UINT32)(TPM_E_BASE + 0x00000035))
-
-//
-// MessageId: TPM_E_NOTFIPS
-//
-// MessageText:
-//
-// The TPM is attempting to execute a command only available when in
-// FIPS mode
-//
-#define TPM_E_NOTFIPS ((UINT32)(TPM_E_BASE + 0x00000036))
-
-//
-// MessageId: TPM_E_INVALID_FAMILY
-//
-// MessageText:
-//
-// The command is attempting to use an invalid family ID
-//
-#define TPM_E_INVALID_FAMILY ((UINT32)(TPM_E_BASE + 0x00000037))
-
-//
-// MessageId: TPM_E_NO_NV_PERMISSION
-//
-// MessageText:
-//
-// The permission to manipulate the NV storage is not available
-//
-#define TPM_E_NO_NV_PERMISSION ((UINT32)(TPM_E_BASE + 0x00000038))
-
-//
-// MessageId: TPM_E_REQUIRES_SIGN
-//
-// MessageText:
-//
-// The operation requires a signed command
-//
-#define TPM_E_REQUIRES_SIGN ((UINT32)(TPM_E_BASE + 0x00000039))
-
-//
-// MessageId: TPM_E_KEY_NOTSUPPORTED
-//
-// MessageText:
-//
-// Wrong operation to load an NV key
-//
-#define TPM_E_KEY_NOTSUPPORTED ((UINT32)(TPM_E_BASE + 0x0000003a))
-
-//
-// MessageId: TPM_E_AUTH_CONFLICT
-//
-// MessageText:
-//
-// NV_LoadKey blob requires both owner and blob authorization
-//
-#define TPM_E_AUTH_CONFLICT ((UINT32)(TPM_E_BASE + 0x0000003b))
-
-//
-// MessageId: TPM_E_AREA_LOCKED
-//
-// MessageText:
-//
-// The NV area is locked and not writable
-//
-#define TPM_E_AREA_LOCKED ((UINT32)(TPM_E_BASE + 0x0000003c))
-
-//
-// MessageId: TPM_E_BAD_LOCALITY
-//
-// MessageText:
-//
-// The locality is incorrect for the attempted operation
-//
-#define TPM_E_BAD_LOCALITY ((UINT32)(TPM_E_BASE + 0x0000003d))
-
-//
-// MessageId: TPM_E_READ_ONLY
-//
-// MessageText:
-//
-// The NV area is read only and can't be written to
-//
-#define TPM_E_READ_ONLY ((UINT32)(TPM_E_BASE + 0x0000003e))
-
-//
-// MessageId: TPM_E_PER_NOWRITE
-//
-// MessageText:
-//
-// There is no protection on the write to the NV area
-//
-#define TPM_E_PER_NOWRITE ((UINT32)(TPM_E_BASE + 0x0000003f))
-
-//
-// MessageId: TPM_E_FAMILYCOUNT
-//
-// MessageText:
-//
-// The family count value does not match
-//
-#define TPM_E_FAMILYCOUNT ((UINT32)(TPM_E_BASE + 0x00000040))
-
-//
-// MessageId: TPM_E_WRITE_LOCKED
-//
-// MessageText:
-//
-// The NV area has already been written to
-//
-#define TPM_E_WRITE_LOCKED ((UINT32)(TPM_E_BASE + 0x00000041))
-
-//
-// MessageId: TPM_E_BAD_ATTRIBUTES
-//
-// MessageText:
-//
-// The NV area attributes conflict
-//
-#define TPM_E_BAD_ATTRIBUTES ((UINT32)(TPM_E_BASE + 0x00000042))
-
-//
-// MessageId: TPM_E_INVALID_STRUCTURE
-//
-// MessageText:
-//
-// The structure tag and version are invalid or inconsistent
-//
-#define TPM_E_INVALID_STRUCTURE ((UINT32)(TPM_E_BASE + 0x00000043))
-
-//
-// MessageId: TPM_E_KEY_OWNER_CONTROL
-//
-// MessageText:
-//
-// The key is under control of the TPM Owner and can only be evicted
-// by the TPM Owner.
-//
-#define TPM_E_KEY_OWNER_CONTROL ((UINT32)(TPM_E_BASE + 0x00000044))
-
-//
-// MessageId: TPM_E_BAD_COUNTER
-//
-// MessageText:
-//
-// The counter handle is incorrect
-//
-#define TPM_E_BAD_COUNTER ((UINT32)(TPM_E_BASE + 0x00000045))
-
-//
-// MessageId: TPM_E_NOT_FULLWRITE
-//
-// MessageText:
-//
-// The write is not a complete write of the area
-//
-#define TPM_E_NOT_FULLWRITE ((UINT32)(TPM_E_BASE + 0x00000046))
-
-//
-// MessageId: TPM_E_CONTEXT_GAP
-//
-// MessageText:
-//
-// The gap between saved context counts is too large
-//
-#define TPM_E_CONTEXT_GAP ((UINT32)(TPM_E_BASE + 0x00000047))
-
-//
-// MessageId: TPM_E_MAXNVWRITES
-//
-// MessageText:
-//
-// The maximum number of NV writes without an owner has been exceeded
-//
-#define TPM_E_MAXNVWRITES ((UINT32)(TPM_E_BASE + 0x00000048))
-
-//
-// MessageId: TPM_E_NOOPERATOR
-//
-// MessageText:
-//
-// No operator AuthData value is set
-//
-#define TPM_E_NOOPERATOR ((UINT32)(TPM_E_BASE + 0x00000049))
-
-//
-// MessageId: TPM_E_RESOURCEMISSING
-//
-// MessageText:
-//
-// The resource pointed to by context is not loaded
-//
-#define TPM_E_RESOURCEMISSING ((UINT32)(TPM_E_BASE + 0x0000004a))
-
-//
-// MessageId: TPM_E_DELEGATE_LOCK
-//
-// MessageText:
-//
-// The delegate administration is locked
-//
-#define TPM_E_DELEGATE_LOCK ((UINT32)(TPM_E_BASE + 0x0000004b))
-
-//
-// MessageId: TPM_E_DELEGATE_FAMILY
-//
-// MessageText:
-//
-// Attempt to manage a family other then the delegated family
-//
-#define TPM_E_DELEGATE_FAMILY ((UINT32)(TPM_E_BASE + 0x0000004c))
-
-//
-// MessageId: TPM_E_DELEGATE_ADMIN
-//
-// MessageText:
-//
-// Delegation table management not enabled
-//
-#define TPM_E_DELEGATE_ADMIN ((UINT32)(TPM_E_BASE + 0x0000004d))
-
-//
-// MessageId: TPM_E_TRANSPORT_NOTEXCLUSIVE
-//
-// MessageText:
-//
-// There was a command executed outside of an exclusive transport session
-//
-#define TPM_E_TRANSPORT_NOTEXCLUSIVE ((UINT32)(TPM_E_BASE + 0x0000004e))
-
-//
-// MessageId: TPM_E_OWNER_CONTROL
-//
-// MessageText:
-//
-// Attempt to context save a owner evict controlled key
-//
-#define TPM_E_OWNER_CONTROL ((UINT32)(TPM_E_BASE + 0x0000004f))
-
-//
-// MessageId: TPM_E_DAA_RESOURCES
-//
-// MessageText:
-//
-// The DAA command has no resources available to execute the command
-//
-#define TPM_E_DAA_RESOURCES ((UINT32)(TPM_E_BASE + 0x00000050))
-
-//
-// MessageId: TPM_E_DAA_INPUT_DATA0
-//
-// MessageText:
-//
-// The consistency check on DAA parameter inputData0 has failed.
-//
-#define TPM_E_DAA_INPUT_DATA0 ((UINT32)(TPM_E_BASE + 0x00000051))
-
-//
-// MessageId: TPM_E_DAA_INPUT_DATA1
-//
-// MessageText:
-//
-// The consistency check on DAA parameter inputData1 has failed.
-//
-#define TPM_E_DAA_INPUT_DATA1 ((UINT32)(TPM_E_BASE + 0x00000052))
-
-//
-// MessageId: TPM_E_DAA_ISSUER_SETTINGS
-//
-// MessageText:
-//
-// The consistency check on DAA_issuerSettings has failed.
-//
-#define TPM_E_DAA_ISSUER_SETTINGS ((UINT32)(TPM_E_BASE + 0x00000053))
-
-//
-// MessageId: TPM_E_DAA_TPM_SETTINGS
-//
-// MessageText:
-//
-// The consistency check on DAA_tpmSpecific has failed.
-//
-#define TPM_E_DAA_TPM_SETTINGS ((UINT32)(TPM_E_BASE + 0x00000054))
-
-//
-// MessageId: TPM_E_DAA_STAGE
-//
-// MessageText:
-//
-// The atomic process indicated by the submitted DAA command is not
-// the expected process.
-//
-#define TPM_E_DAA_STAGE ((UINT32)(TPM_E_BASE + 0x00000055))
-
-//
-// MessageId: TPM_E_DAA_ISSUER_VALIDITY
-//
-// MessageText:
-//
-// The issuer's validity check has detected an inconsistency
-//
-#define TPM_E_DAA_ISSUER_VALIDITY ((UINT32)(TPM_E_BASE + 0x00000056))
-
-//
-// MessageId: TPM_E_DAA_WRONG_W
-//
-// MessageText:
-//
-// The consistency check on w has failed.
-//
-#define TPM_E_DAA_WRONG_W ((UINT32)(TPM_E_BASE + 0x00000057))
-
-//
-// MessageId: TPM_E_BAD_HANDLE
-//
-// MessageText:
-//
-// The handle is incorrect
-//
-#define TPM_E_BAD_HANDLE ((UINT32)(TPM_E_BASE + 0x00000058))
-
-//
-// MessageId: TPM_E_BAD_DELEGATE
-//
-// MessageText:
-//
-// Delegation is not correct
-//
-#define TPM_E_BAD_DELEGATE ((UINT32)(TPM_E_BASE + 0x00000059))
-
-//
-// MessageId: TPM_E_BADCONTEXT
-//
-// MessageText:
-//
-// The context blob is invalid
-//
-#define TPM_E_BADCONTEXT ((UINT32)(TPM_E_BASE + 0x0000005a))
-
-//
-// MessageId: TPM_E_TOOMANYCONTEXTS
-//
-// MessageText:
-//
-// Too many contexts held by the TPM
-//
-#define TPM_E_TOOMANYCONTEXTS ((UINT32)(TPM_E_BASE + 0x0000005b))
-
-//
-// MessageId: TPM_E_MA_TICKET_SIGNATURE
-//
-// MessageText:
-//
-// Migration authority signature validation failure
-//
-#define TPM_E_MA_TICKET_SIGNATURE ((UINT32)(TPM_E_BASE + 0x0000005c))
-
-//
-// MessageId: TPM_E_MA_DESTINATION
-//
-// MessageText:
-//
-// Migration destination not authenticated
-//
-#define TPM_E_MA_DESTINATION ((UINT32)(TPM_E_BASE + 0x0000005d))
-
-//
-// MessageId: TPM_E_MA_SOURCE
-//
-// MessageText:
-//
-// Migration source incorrect
-//
-#define TPM_E_MA_SOURCE ((UINT32)(TPM_E_BASE + 0x0000005e))
-
-//
-// MessageId: TPM_E_MA_AUTHORITY
-//
-// MessageText:
-//
-// Incorrect migration authority
-//
-#define TPM_E_MA_AUTHORITY ((UINT32)(TPM_E_BASE + 0x0000005f))
-
-//
-// MessageId: TPM_E_PERMANENTEK
-//
-// MessageText:
-//
-// Attempt to revoke the EK and the EK is not revocable
-//
-#define TPM_E_PERMANENTEK ((UINT32)(TPM_E_BASE + 0x00000061))
-
-//
-// MessageId: TPM_E_BAD_SIGNATURE
-//
-// MessageText:
-//
-// Bad signature of CMK ticket
-//
-#define TPM_E_BAD_SIGNATURE ((UINT32)(TPM_E_BASE + 0x00000062))
-
-//
-// MessageId: TPM_E_NOCONTEXTSPACE
-//
-// MessageText:
-//
-// There is no room in the context list for additional contexts
-//
-#define TPM_E_NOCONTEXTSPACE  ((UINT32)(TPM_E_BASE + 0x00000063))
-
-
-//
-// MessageId: TPM_E_RETRY
-//
-// MessageText:
-//
-// The TPM is too busy to respond to the command immediately, but the
-// command could be resubmitted at a later time. The TPM MAY return
-// TPM_Retry for any command at any time.
-//
-#define TPM_E_RETRY ((UINT32)(TPM_E_BASE + TPM_E_NON_FATAL))
-
-//
-// MessageId: TPM_E_NEEDS_SELFTEST
-//
-// MessageText:
-//
-// SelfTestFull has not been run
-//
-#define TPM_E_NEEDS_SELFTEST ((UINT32)(TPM_E_BASE + TPM_E_NON_FATAL + 1))
-
-//
-// MessageId: TPM_E_DOING_SELFTEST
-//
-// MessageText:
-//
-// The TPM is currently executing a full selftest
-//
-#define TPM_E_DOING_SELFTEST ((UINT32)(TPM_E_BASE + TPM_E_NON_FATAL + 2))
-
-//
-// MessageId: TPM_E_DEFEND_LOCK_RUNNING
-//
-// MessageText:
-//
-// The TPM is defending against dictionary attacks and is in some
-// time-out period.
-//
-#define TPM_E_DEFEND_LOCK_RUNNING ((UINT32)(TPM_E_BASE + TPM_E_NON_FATAL + 3))
-
-#endif /* __TPM_ERROR_H__ */
+/*
+ * The TPM error codes extracted from the TPM main specification
+ * version 1.2 revision 85.
+ */
+
+#ifndef __TPM_ERROR_H__
+#define __TPM_ERROR_H__
+
+
+#ifndef TPM_E_BASE
+#define TPM_E_BASE        ((UINT32)0)
+#endif
+
+#ifndef TPM_E_NON_FATAL
+#define TPM_E_NON_FATAL   ((UINT32)0x00000800)
+#endif
+
+
+// Successful completion of the TPM operation.
+#define TPM_SUCCESS    TPM_E_BASE
+
+//
+// MessageId: TPM_E_AUTHFAIL
+//
+// MessageText:
+//
+// Authentication failed
+//
+#define TPM_E_AUTHFAIL ((UINT32)(TPM_E_BASE + 0x00000001))
+
+//
+// MessageId: TPM_E_BADINDEX
+//
+// MessageText:
+//
+// The index to a PCR, DIR or other register is incorrect
+//
+#define TPM_E_BADINDEX ((UINT32)(TPM_E_BASE + 0x00000002))
+
+//
+// MessageId: TPM_E_BAD_PARAMETER
+//
+// MessageText:
+//
+// One or more parameter is bad
+//
+#define TPM_E_BAD_PARAMETER ((UINT32)(TPM_E_BASE + 0x00000003))
+
+//
+// MessageId: TPM_E_AUDITFAILURE
+//
+// MessageText:
+//
+// An operation completed successfully but the auditing of that
+// operation failed.
+//
+#define TPM_E_AUDITFAILURE ((UINT32)(TPM_E_BASE + 0x00000004))
+
+//
+// MessageId: TPM_E_CLEAR_DISABLED
+//
+// MessageText:
+//
+// The clear disable flag is set and all clear operations now require
+// physical access
+//
+#define TPM_E_CLEAR_DISABLED ((UINT32)(TPM_E_BASE + 0x00000005))
+
+//
+// MessageId: TPM_E_DEACTIVATED
+//
+// MessageText:
+//
+// The TPM is deactivated
+//
+#define TPM_E_DEACTIVATED ((UINT32)(TPM_E_BASE + 0x00000006))
+
+//
+// MessageId: TPM_E_DISABLED
+//
+// MessageText:
+//
+// The TPM is disabled
+//
+#define TPM_E_DISABLED ((UINT32)(TPM_E_BASE + 0x00000007))
+
+//
+// MessageId: TPM_E_DISABLED_CMD
+//
+// MessageText:
+//
+// The target command has been disabled
+//
+#define TPM_E_DISABLED_CMD ((UINT32)(TPM_E_BASE + 0x00000008))
+
+//
+// MessageId: TPM_E_FAIL
+//
+// MessageText:
+//
+// The operation failed
+//
+#define TPM_E_FAIL ((UINT32)(TPM_E_BASE + 0x00000009))
+
+//
+// MessageId: TPM_E_BAD_ORDINAL
+//
+// MessageText:
+//
+// The ordinal was unknown or inconsistent
+//
+#define TPM_E_BAD_ORDINAL ((UINT32)(TPM_E_BASE + 0x0000000a))
+
+//
+// MessageId: TPM_E_INSTALL_DISABLED
+//
+// MessageText:
+//
+// The ability to install an owner is disabled
+//
+#define TPM_E_INSTALL_DISABLED ((UINT32)(TPM_E_BASE + 0x0000000b))
+
+//
+// MessageId: TPM_E_INVALID_KEYHANDLE
+//
+// MessageText:
+//
+// The key handle can not be interpreted
+//
+#define TPM_E_INVALID_KEYHANDLE ((UINT32)(TPM_E_BASE + 0x0000000c))
+
+//
+// MessageId: TPM_E_KEYNOTFOUND
+//
+// MessageText:
+//
+// The key handle points to an invalid key
+//
+#define TPM_E_KEYNOTFOUND ((UINT32)(TPM_E_BASE + 0x0000000d))
+
+//
+// MessageId: TPM_E_INAPPROPRIATE_ENC
+//
+// MessageText:
+//
+// Unacceptable encryption scheme
+//
+#define TPM_E_INAPPROPRIATE_ENC ((UINT32)(TPM_E_BASE + 0x0000000e))
+
+//
+// MessageId: TPM_E_MIGRATEFAIL
+//
+// MessageText:
+//
+// Migration authorization failed
+//
+#define TPM_E_MIGRATEFAIL ((UINT32)(TPM_E_BASE + 0x0000000f))
+
+//
+// MessageId: TPM_E_INVALID_PCR_INFO
+//
+// MessageText:
+//
+// PCR information could not be interpreted
+//
+#define TPM_E_INVALID_PCR_INFO ((UINT32)(TPM_E_BASE + 0x00000010))
+
+//
+// MessageId: TPM_E_NOSPACE
+//
+// MessageText:
+//
+// No room to load key.
+//
+#define TPM_E_NOSPACE ((UINT32)(TPM_E_BASE + 0x00000011))
+
+//
+// MessageId: TPM_E_NOSRK
+//
+// MessageText:
+//
+// There is no SRK set
+//
+#define TPM_E_NOSRK ((UINT32)(TPM_E_BASE + 0x00000012))
+
+//
+// MessageId: TPM_E_NOTSEALED_BLOB
+//
+// MessageText:
+//
+// An encrypted blob is invalid or was not created by this TPM
+//
+#define TPM_E_NOTSEALED_BLOB ((UINT32)(TPM_E_BASE + 0x00000013))
+
+//
+// MessageId: TPM_E_OWNER_SET
+//
+// MessageText:
+//
+// There is already an Owner 
+//
+#define TPM_E_OWNER_SET ((UINT32)(TPM_E_BASE + 0x00000014))
+
+//
+// MessageId: TPM_E_RESOURCES
+//
+// MessageText:
+//
+// The TPM has insufficient internal resources to perform the
+// requested action.
+//
+#define TPM_E_RESOURCES ((UINT32)(TPM_E_BASE + 0x00000015))
+
+//
+// MessageId: TPM_E_SHORTRANDOM
+//
+// MessageText:
+//
+// A random string was too short
+//
+#define TPM_E_SHORTRANDOM ((UINT32)(TPM_E_BASE + 0x00000016))
+
+//
+// MessageId: TPM_E_SIZE
+//
+// MessageText:
+//
+// The TPM does not have the space to perform the operation.
+//
+#define TPM_E_SIZE ((UINT32)(TPM_E_BASE + 0x00000017))
+
+//
+// MessageId: TPM_E_WRONGPCRVAL
+//
+// MessageText:
+//
+// The named PCR value does not match the current PCR value.
+//
+#define TPM_E_WRONGPCRVAL ((UINT32)(TPM_E_BASE + 0x00000018))
+
+//
+// MessageId: TPM_E_BAD_PARAM_SIZE 
+//
+// MessageText:
+//
+// The paramSize argument to the command has the incorrect value 
+//
+#define TPM_E_BAD_PARAM_SIZE ((UINT32)(TPM_E_BASE + 0x00000019))
+
+//
+// MessageId: TPM_E_SHA_THREAD
+//
+// MessageText:
+//
+// There is no existing SHA-1 thread.
+//
+#define TPM_E_SHA_THREAD ((UINT32)(TPM_E_BASE + 0x0000001a))
+
+//
+// MessageId: TPM_E_SHA_ERROR
+//
+// MessageText:
+//
+// The calculation is unable to proceed because the existing SHA-1
+// thread has already encountered an error.
+//
+#define TPM_E_SHA_ERROR ((UINT32)(TPM_E_BASE + 0x0000001b))
+
+//
+// MessageId: TPM_E_FAILEDSELFTEST
+//
+// MessageText:
+//
+// Self-test has failed and the TPM has shutdown.
+//
+#define TPM_E_FAILEDSELFTEST ((UINT32)(TPM_E_BASE + 0x0000001c))
+
+//
+// MessageId: TPM_E_AUTH2FAIL
+//
+// MessageText:
+//
+// The authorization for the second key in a 2 key function failed
+// authorization
+//
+#define TPM_E_AUTH2FAIL ((UINT32)(TPM_E_BASE + 0x0000001d))
+
+//
+// MessageId: TPM_E_BADTAG
+//
+// MessageText:
+//
+// The tag value sent to for a command is invalid
+//
+#define TPM_E_BADTAG ((UINT32)(TPM_E_BASE + 0x0000001e))
+
+//
+// MessageId: TPM_E_IOERROR
+//
+// MessageText:
+//
+// An IO error occurred transmitting information to the TPM
+//
+#define TPM_E_IOERROR ((UINT32)(TPM_E_BASE + 0x0000001f))
+
+//
+// MessageId: TPM_E_ENCRYPT_ERROR
+//
+// MessageText:
+//
+// The encryption process had a problem.
+//
+#define TPM_E_ENCRYPT_ERROR ((UINT32)(TPM_E_BASE + 0x00000020))
+
+//
+// MessageId: TPM_E_DECRYPT_ERROR
+//
+// MessageText:
+//
+// The decryption process did not complete.
+//
+#define TPM_E_DECRYPT_ERROR ((UINT32)(TPM_E_BASE + 0x00000021))
+
+//
+// MessageId: TPM_E_INVALID_AUTHHANDLE
+//
+// MessageText:
+//
+// An invalid handle was used.
+//
+#define TPM_E_INVALID_AUTHHANDLE ((UINT32)(TPM_E_BASE + 0x00000022))
+
+//
+// MessageId: TPM_E_NO_ENDORSEMENT
+//
+// MessageText:
+//
+// The TPM does not a EK installed
+//
+#define TPM_E_NO_ENDORSEMENT ((UINT32)(TPM_E_BASE + 0x00000023))
+
+//
+// MessageId: TPM_E_INVALID_KEYUSAGE
+//
+// MessageText:
+//
+// The usage of a key is not allowed
+//
+#define TPM_E_INVALID_KEYUSAGE ((UINT32)(TPM_E_BASE + 0x00000024))
+
+//
+// MessageId: TPM_E_WRONG_ENTITYTYPE
+//
+// MessageText:
+//
+// The submitted entity type is not allowed
+//
+#define TPM_E_WRONG_ENTITYTYPE ((UINT32)(TPM_E_BASE + 0x00000025))
+
+//
+// MessageId: TPM_E_INVALID_POSTINIT
+//
+// MessageText:
+//
+// The command was received in the wrong sequence relative to TPM_Init
+// and a subsequent TPM_Startup
+//
+#define TPM_E_INVALID_POSTINIT ((UINT32)(TPM_E_BASE + 0x00000026))
+
+//
+// MessageId: TPM_E_INAPPROPRIATE_SIG
+//
+// MessageText:
+//
+// Signed data cannot include additional DER information
+//
+#define TPM_E_INAPPROPRIATE_SIG ((UINT32)(TPM_E_BASE + 0x00000027))
+
+//
+// MessageId: TPM_E_BAD_KEY_PROPERTY
+//
+// MessageText:
+//
+// The key properties in TPM_KEY_PARMs are not supported by this TPM
+//
+#define TPM_E_BAD_KEY_PROPERTY ((UINT32)(TPM_E_BASE + 0x00000028))
+
+//
+// MessageId: TPM_E_BAD_MIGRATION
+//
+// MessageText:
+//
+// The migration properties of this key are incorrect.
+//
+#define TPM_E_BAD_MIGRATION ((UINT32)(TPM_E_BASE + 0x00000029))
+
+//
+// MessageId: TPM_E_BAD_SCHEME
+//
+// MessageText:
+//
+// The signature or encryption scheme for this key is incorrect or not
+// permitted in this situation.
+//
+#define TPM_E_BAD_SCHEME ((UINT32)(TPM_E_BASE + 0x0000002a))
+
+//
+// MessageId: TPM_E_BAD_DATASIZE
+//
+// MessageText:
+//
+// The size of the data (or blob) parameter is bad or inconsistent
+// with the referenced key
+//
+#define TPM_E_BAD_DATASIZE ((UINT32)(TPM_E_BASE + 0x0000002b))
+
+//
+// MessageId: TPM_E_BAD_MODE
+//
+// MessageText:
+//
+// A mode parameter is bad, such as capArea or subCapArea for
+// TPM_GetCapability, physicalPresence parameter for
+// TPM_PhysicalPresence, or migrationType for TPM_CreateMigrationBlob.
+//
+#define TPM_E_BAD_MODE ((UINT32)(TPM_E_BASE + 0x0000002c))
+
+//
+// MessageId: TPM_E_BAD_PRESENCE
+//
+// MessageText:
+//
+// Either the physicalPresence or physicalPresenceLock bits have the
+// wrong value
+//
+#define TPM_E_BAD_PRESENCE ((UINT32)(TPM_E_BASE + 0x0000002d))
+
+//
+// MessageId: TPM_E_BAD_VERSION
+//
+// MessageText:
+//
+// The TPM cannot perform this version of the capability
+//
+#define TPM_E_BAD_VERSION ((UINT32)(TPM_E_BASE + 0x0000002e))
+
+//
+// MessageId: TPM_E_NO_WRAP_TRANSPORT
+//
+// MessageText:
+//
+// The TPM does not allow for wrapped transport sessions
+//
+#define TPM_E_NO_WRAP_TRANSPORT ((UINT32)(TPM_E_BASE + 0x0000002f))
+
+//
+// MessageId: TPM_E_AUDITFAIL_UNSUCCESSFUL
+//
+// MessageText:
+//
+// TPM audit construction failed and the underlying command was
+// returning a failure code also
+//
+#define TPM_E_AUDITFAIL_UNSUCCESSFUL ((UINT32)(TPM_E_BASE + 0x00000030))
+
+//
+// MessageId: TPM_E_AUDITFAIL_SUCCESSFUL
+//
+// MessageText:
+//
+// TPM audit construction failed and the underlying command was
+// returning success
+//
+#define TPM_E_AUDITFAIL_SUCCESSFUL ((UINT32)(TPM_E_BASE + 0x00000031))
+
+//
+// MessageId: TPM_E_NOTRESETABLE
+//
+// MessageText:
+//
+// Attempt to reset a PCR register that does not have the resettable
+// attribute
+//
+#define TPM_E_NOTRESETABLE ((UINT32)(TPM_E_BASE + 0x00000032))
+
+//
+// MessageId: TPM_E_NOTLOCAL
+//
+// MessageText:
+//
+// Attempt to reset a PCR register that requires locality and locality
+// modifier not part of command transport
+//
+#define TPM_E_NOTLOCAL ((UINT32)(TPM_E_BASE + 0x00000033))
+
+//
+// MessageId: TPM_E_BAD_TYPE
+//
+// MessageText:
+//
+// Make identity blob not properly typed
+//
+#define TPM_E_BAD_TYPE ((UINT32)(TPM_E_BASE + 0x00000034))
+
+//
+// MessageId: TPM_E_INVALID_RESOURCE
+//
+// MessageText:
+//
+// When saving context identified resource type does not match actual
+// resource
+//
+#define TPM_E_INVALID_RESOURCE ((UINT32)(TPM_E_BASE + 0x00000035))
+
+//
+// MessageId: TPM_E_NOTFIPS
+//
+// MessageText:
+//
+// The TPM is attempting to execute a command only available when in
+// FIPS mode
+//
+#define TPM_E_NOTFIPS ((UINT32)(TPM_E_BASE + 0x00000036))
+
+//
+// MessageId: TPM_E_INVALID_FAMILY
+//
+// MessageText:
+//
+// The command is attempting to use an invalid family ID
+//
+#define TPM_E_INVALID_FAMILY ((UINT32)(TPM_E_BASE + 0x00000037))
+
+//
+// MessageId: TPM_E_NO_NV_PERMISSION
+//
+// MessageText:
+//
+// The permission to manipulate the NV storage is not available
+//
+#define TPM_E_NO_NV_PERMISSION ((UINT32)(TPM_E_BASE + 0x00000038))
+
+//
+// MessageId: TPM_E_REQUIRES_SIGN
+//
+// MessageText:
+//
+// The operation requires a signed command
+//
+#define TPM_E_REQUIRES_SIGN ((UINT32)(TPM_E_BASE + 0x00000039))
+
+//
+// MessageId: TPM_E_KEY_NOTSUPPORTED
+//
+// MessageText:
+//
+// Wrong operation to load an NV key
+//
+#define TPM_E_KEY_NOTSUPPORTED ((UINT32)(TPM_E_BASE + 0x0000003a))
+
+//
+// MessageId: TPM_E_AUTH_CONFLICT
+//
+// MessageText:
+//
+// NV_LoadKey blob requires both owner and blob authorization
+//
+#define TPM_E_AUTH_CONFLICT ((UINT32)(TPM_E_BASE + 0x0000003b))
+
+//
+// MessageId: TPM_E_AREA_LOCKED
+//
+// MessageText:
+//
+// The NV area is locked and not writable
+//
+#define TPM_E_AREA_LOCKED ((UINT32)(TPM_E_BASE + 0x0000003c))
+
+//
+// MessageId: TPM_E_BAD_LOCALITY
+//
+// MessageText:
+//
+// The locality is incorrect for the attempted operation
+//
+#define TPM_E_BAD_LOCALITY ((UINT32)(TPM_E_BASE + 0x0000003d))
+
+//
+// MessageId: TPM_E_READ_ONLY
+//
+// MessageText:
+//
+// The NV area is read only and can't be written to
+//
+#define TPM_E_READ_ONLY ((UINT32)(TPM_E_BASE + 0x0000003e))
+
+//
+// MessageId: TPM_E_PER_NOWRITE
+//
+// MessageText:
+//
+// There is no protection on the write to the NV area
+//
+#define TPM_E_PER_NOWRITE ((UINT32)(TPM_E_BASE + 0x0000003f))
+
+//
+// MessageId: TPM_E_FAMILYCOUNT
+//
+// MessageText:
+//
+// The family count value does not match
+//
+#define TPM_E_FAMILYCOUNT ((UINT32)(TPM_E_BASE + 0x00000040))
+
+//
+// MessageId: TPM_E_WRITE_LOCKED
+//
+// MessageText:
+//
+// The NV area has already been written to
+//
+#define TPM_E_WRITE_LOCKED ((UINT32)(TPM_E_BASE + 0x00000041))
+
+//
+// MessageId: TPM_E_BAD_ATTRIBUTES
+//
+// MessageText:
+//
+// The NV area attributes conflict
+//
+#define TPM_E_BAD_ATTRIBUTES ((UINT32)(TPM_E_BASE + 0x00000042))
+
+//
+// MessageId: TPM_E_INVALID_STRUCTURE
+//
+// MessageText:
+//
+// The structure tag and version are invalid or inconsistent
+//
+#define TPM_E_INVALID_STRUCTURE ((UINT32)(TPM_E_BASE + 0x00000043))
+
+//
+// MessageId: TPM_E_KEY_OWNER_CONTROL
+//
+// MessageText:
+//
+// The key is under control of the TPM Owner and can only be evicted
+// by the TPM Owner.
+//
+#define TPM_E_KEY_OWNER_CONTROL ((UINT32)(TPM_E_BASE + 0x00000044))
+
+//
+// MessageId: TPM_E_BAD_COUNTER
+//
+// MessageText:
+//
+// The counter handle is incorrect
+//
+#define TPM_E_BAD_COUNTER ((UINT32)(TPM_E_BASE + 0x00000045))
+
+//
+// MessageId: TPM_E_NOT_FULLWRITE
+//
+// MessageText:
+//
+// The write is not a complete write of the area
+//
+#define TPM_E_NOT_FULLWRITE ((UINT32)(TPM_E_BASE + 0x00000046))
+
+//
+// MessageId: TPM_E_CONTEXT_GAP
+//
+// MessageText:
+//
+// The gap between saved context counts is too large
+//
+#define TPM_E_CONTEXT_GAP ((UINT32)(TPM_E_BASE + 0x00000047))
+
+//
+// MessageId: TPM_E_MAXNVWRITES
+//
+// MessageText:
+//
+// The maximum number of NV writes without an owner has been exceeded
+//
+#define TPM_E_MAXNVWRITES ((UINT32)(TPM_E_BASE + 0x00000048))
+
+//
+// MessageId: TPM_E_NOOPERATOR
+//
+// MessageText:
+//
+// No operator AuthData value is set
+//
+#define TPM_E_NOOPERATOR ((UINT32)(TPM_E_BASE + 0x00000049))
+
+//
+// MessageId: TPM_E_RESOURCEMISSING
+//
+// MessageText:
+//
+// The resource pointed to by context is not loaded
+//
+#define TPM_E_RESOURCEMISSING ((UINT32)(TPM_E_BASE + 0x0000004a))
+
+//
+// MessageId: TPM_E_DELEGATE_LOCK
+//
+// MessageText:
+//
+// The delegate administration is locked
+//
+#define TPM_E_DELEGATE_LOCK ((UINT32)(TPM_E_BASE + 0x0000004b))
+
+//
+// MessageId: TPM_E_DELEGATE_FAMILY
+//
+// MessageText:
+//
+// Attempt to manage a family other then the delegated family
+//
+#define TPM_E_DELEGATE_FAMILY ((UINT32)(TPM_E_BASE + 0x0000004c))
+
+//
+// MessageId: TPM_E_DELEGATE_ADMIN
+//
+// MessageText:
+//
+// Delegation table management not enabled
+//
+#define TPM_E_DELEGATE_ADMIN ((UINT32)(TPM_E_BASE + 0x0000004d))
+
+//
+// MessageId: TPM_E_TRANSPORT_NOTEXCLUSIVE
+//
+// MessageText:
+//
+// There was a command executed outside of an exclusive transport session
+//
+#define TPM_E_TRANSPORT_NOTEXCLUSIVE ((UINT32)(TPM_E_BASE + 0x0000004e))
+
+//
+// MessageId: TPM_E_OWNER_CONTROL
+//
+// MessageText:
+//
+// Attempt to context save a owner evict controlled key
+//
+#define TPM_E_OWNER_CONTROL ((UINT32)(TPM_E_BASE + 0x0000004f))
+
+//
+// MessageId: TPM_E_DAA_RESOURCES
+//
+// MessageText:
+//
+// The DAA command has no resources available to execute the command
+//
+#define TPM_E_DAA_RESOURCES ((UINT32)(TPM_E_BASE + 0x00000050))
+
+//
+// MessageId: TPM_E_DAA_INPUT_DATA0
+//
+// MessageText:
+//
+// The consistency check on DAA parameter inputData0 has failed.
+//
+#define TPM_E_DAA_INPUT_DATA0 ((UINT32)(TPM_E_BASE + 0x00000051))
+
+//
+// MessageId: TPM_E_DAA_INPUT_DATA1
+//
+// MessageText:
+//
+// The consistency check on DAA parameter inputData1 has failed.
+//
+#define TPM_E_DAA_INPUT_DATA1 ((UINT32)(TPM_E_BASE + 0x00000052))
+
+//
+// MessageId: TPM_E_DAA_ISSUER_SETTINGS
+//
+// MessageText:
+//
+// The consistency check on DAA_issuerSettings has failed.
+//
+#define TPM_E_DAA_ISSUER_SETTINGS ((UINT32)(TPM_E_BASE + 0x00000053))
+
+//
+// MessageId: TPM_E_DAA_TPM_SETTINGS
+//
+// MessageText:
+//
+// The consistency check on DAA_tpmSpecific has failed.
+//
+#define TPM_E_DAA_TPM_SETTINGS ((UINT32)(TPM_E_BASE + 0x00000054))
+
+//
+// MessageId: TPM_E_DAA_STAGE
+//
+// MessageText:
+//
+// The atomic process indicated by the submitted DAA command is not
+// the expected process.
+//
+#define TPM_E_DAA_STAGE ((UINT32)(TPM_E_BASE + 0x00000055))
+
+//
+// MessageId: TPM_E_DAA_ISSUER_VALIDITY
+//
+// MessageText:
+//
+// The issuer's validity check has detected an inconsistency
+//
+#define TPM_E_DAA_ISSUER_VALIDITY ((UINT32)(TPM_E_BASE + 0x00000056))
+
+//
+// MessageId: TPM_E_DAA_WRONG_W
+//
+// MessageText:
+//
+// The consistency check on w has failed.
+//
+#define TPM_E_DAA_WRONG_W ((UINT32)(TPM_E_BASE + 0x00000057))
+
+//
+// MessageId: TPM_E_BAD_HANDLE
+//
+// MessageText:
+//
+// The handle is incorrect
+//
+#define TPM_E_BAD_HANDLE ((UINT32)(TPM_E_BASE + 0x00000058))
+
+//
+// MessageId: TPM_E_BAD_DELEGATE
+//
+// MessageText:
+//
+// Delegation is not correct
+//
+#define TPM_E_BAD_DELEGATE ((UINT32)(TPM_E_BASE + 0x00000059))
+
+//
+// MessageId: TPM_E_BADCONTEXT
+//
+// MessageText:
+//
+// The context blob is invalid
+//
+#define TPM_E_BADCONTEXT ((UINT32)(TPM_E_BASE + 0x0000005a))
+
+//
+// MessageId: TPM_E_TOOMANYCONTEXTS
+//
+// MessageText:
+//
+// Too many contexts held by the TPM
+//
+#define TPM_E_TOOMANYCONTEXTS ((UINT32)(TPM_E_BASE + 0x0000005b))
+
+//
+// MessageId: TPM_E_MA_TICKET_SIGNATURE
+//
+// MessageText:
+//
+// Migration authority signature validation failure
+//
+#define TPM_E_MA_TICKET_SIGNATURE ((UINT32)(TPM_E_BASE + 0x0000005c))
+
+//
+// MessageId: TPM_E_MA_DESTINATION
+//
+// MessageText:
+//
+// Migration destination not authenticated
+//
+#define TPM_E_MA_DESTINATION ((UINT32)(TPM_E_BASE + 0x0000005d))
+
+//
+// MessageId: TPM_E_MA_SOURCE
+//
+// MessageText:
+//
+// Migration source incorrect
+//
+#define TPM_E_MA_SOURCE ((UINT32)(TPM_E_BASE + 0x0000005e))
+
+//
+// MessageId: TPM_E_MA_AUTHORITY
+//
+// MessageText:
+//
+// Incorrect migration authority
+//
+#define TPM_E_MA_AUTHORITY ((UINT32)(TPM_E_BASE + 0x0000005f))
+
+//
+// MessageId: TPM_E_PERMANENTEK
+//
+// MessageText:
+//
+// Attempt to revoke the EK and the EK is not revocable
+//
+#define TPM_E_PERMANENTEK ((UINT32)(TPM_E_BASE + 0x00000061))
+
+//
+// MessageId: TPM_E_BAD_SIGNATURE
+//
+// MessageText:
+//
+// Bad signature of CMK ticket
+//
+#define TPM_E_BAD_SIGNATURE ((UINT32)(TPM_E_BASE + 0x00000062))
+
+//
+// MessageId: TPM_E_NOCONTEXTSPACE
+//
+// MessageText:
+//
+// There is no room in the context list for additional contexts
+//
+#define TPM_E_NOCONTEXTSPACE  ((UINT32)(TPM_E_BASE + 0x00000063))
+
+
+//
+// MessageId: TPM_E_RETRY
+//
+// MessageText:
+//
+// The TPM is too busy to respond to the command immediately, but the
+// command could be resubmitted at a later time. The TPM MAY return
+// TPM_Retry for any command at any time.
+//
+#define TPM_E_RETRY ((UINT32)(TPM_E_BASE + TPM_E_NON_FATAL))
+
+//
+// MessageId: TPM_E_NEEDS_SELFTEST
+//
+// MessageText:
+//
+// SelfTestFull has not been run
+//
+#define TPM_E_NEEDS_SELFTEST ((UINT32)(TPM_E_BASE + TPM_E_NON_FATAL + 1))
+
+//
+// MessageId: TPM_E_DOING_SELFTEST
+//
+// MessageText:
+//
+// The TPM is currently executing a full selftest
+//
+#define TPM_E_DOING_SELFTEST ((UINT32)(TPM_E_BASE + TPM_E_NON_FATAL + 2))
+
+//
+// MessageId: TPM_E_DEFEND_LOCK_RUNNING
+//
+// MessageText:
+//
+// The TPM is defending against dictionary attacks and is in some
+// time-out period.
+//
+#define TPM_E_DEFEND_LOCK_RUNNING ((UINT32)(TPM_E_BASE + TPM_E_NON_FATAL + 3))
+
+#endif /* __TPM_ERROR_H__ */
diff -ru trousers-0.3.8-orig/src/include/tss/tpm_ordinal.h trousers-0.3.8/src/include/tss/tpm_ordinal.h
--- trousers-0.3.8-orig/src/include/tss/tpm_ordinal.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tpm_ordinal.h	2012-02-14 20:35:05.913041461 +0000
@@ -1,151 +1,151 @@
-/*
- * TPM Ordinal definitions extracted from the TPM 1.2 specification, rev 85.
- */
-
-#ifndef __TPM_ORDINAL_H__
-#define __TPM_ORDINAL_H__
-
-#define TPM_PROTECTED_COMMAND                     ((UINT32)(0x00000000))
-#define TPM_UNPROTECTED_COMMAND                   ((UINT32)(0x80000000))
-#define TPM_CONNECTION_COMMAND                    ((UINT32)(0x40000000))
-#define TPM_VENDOR_COMMAND                        ((UINT32)(0x20000000))
-
-#define TPM_MAIN                                  ((UINT16)(0x0000))
-#define TPM_PC                                    ((UINT16)(0x0001))
-#define TPM_PDA                                   ((UINT16)(0x0002))
-#define TPM_CELL_PHONE                            ((UINT16)(0x0003))
-#define TPM_SERVER                                ((UINT16)(0x0004))
-
-#define TPM_PROTECTED_ORDINAL              (TPM_MAIN | TPM_PROTECTED_COMMAND)
-#define TPM_UNPROTECTED_ORDINAL            (TPM_MAIN | TPM_UNPROTECTED_COMMAND)
-#define TPM_CONNECTION_ORDINAL             (TPM_MAIN | TPM_CONNECTION_COMMAND)
-
-
-#define TPM_ORD_OIAP                              ((UINT32)0x0000000A)
-#define TPM_ORD_OSAP                              ((UINT32)0x0000000B)
-#define TPM_ORD_ChangeAuth                        ((UINT32)0x0000000C)
-#define TPM_ORD_TakeOwnership                     ((UINT32)0x0000000D)
-#define TPM_ORD_ChangeAuthAsymStart               ((UINT32)0x0000000E)
-#define TPM_ORD_ChangeAuthAsymFinish              ((UINT32)0x0000000F)
-#define TPM_ORD_ChangeAuthOwner                   ((UINT32)0x00000010)
-#define TPM_ORD_DSAP                              ((UINT32)0x00000011)
-#define TPM_ORD_CMK_CreateTicket                  ((UINT32)0x00000012)
-#define TPM_ORD_CMK_CreateKey                     ((UINT32)0x00000013)
-#define TPM_ORD_Extend                            ((UINT32)0x00000014)
-#define TPM_ORD_PcrRead                           ((UINT32)0x00000015)
-#define TPM_ORD_Quote                             ((UINT32)0x00000016)
-#define TPM_ORD_Seal                              ((UINT32)0x00000017)
-#define TPM_ORD_Unseal                            ((UINT32)0x00000018)
-#define TPM_ORD_DirWriteAuth                      ((UINT32)0x00000019)
-#define TPM_ORD_DirRead                           ((UINT32)0x0000001A)
-#define TPM_ORD_CMK_CreateBlob                    ((UINT32)0x0000001B)
-#define TPM_ORD_CMK_SetRestrictions               ((UINT32)0x0000001C)
-#define TPM_ORD_CMK_ApproveMA                     ((UINT32)0x0000001D)
-#define TPM_ORD_UnBind                            ((UINT32)0x0000001E)
-#define TPM_ORD_CreateWrapKey                     ((UINT32)0x0000001F)
-#define TPM_ORD_LoadKey                           ((UINT32)0x00000020)
-#define TPM_ORD_GetPubKey                         ((UINT32)0x00000021)
-#define TPM_ORD_EvictKey                          ((UINT32)0x00000022)
-#define TPM_ORD_KeyControlOwner                   ((UINT32)0x00000023)
-#define TPM_ORD_CMK_ConvertMigration              ((UINT32)0x00000024)
-#define TPM_ORD_MigrateKey                        ((UINT32)0x00000025)
-#define TPM_ORD_CreateMigrationBlob               ((UINT32)0x00000028)
-#define TPM_ORD_DAA_Join                          ((UINT32)0x00000029)
-#define TPM_ORD_ConvertMigrationBlob              ((UINT32)0x0000002A)
-#define TPM_ORD_AuthorizeMigrationKey             ((UINT32)0x0000002B)
-#define TPM_ORD_CreateMaintenanceArchive          ((UINT32)0x0000002C)
-#define TPM_ORD_LoadMaintenanceArchive            ((UINT32)0x0000002D)
-#define TPM_ORD_KillMaintenanceFeature            ((UINT32)0x0000002E)
-#define TPM_ORD_LoadManuMaintPub                  ((UINT32)0x0000002F)
-#define TPM_ORD_ReadManuMaintPub                  ((UINT32)0x00000030)
-#define TPM_ORD_DAA_Sign                          ((UINT32)0x00000031)
-#define TPM_ORD_CertifyKey                        ((UINT32)0x00000032)
-#define TPM_ORD_CertifyKey2                       ((UINT32)0x00000033)
-#define TPM_ORD_Sign                              ((UINT32)0x0000003C)
-#define TPM_ORD_Sealx                             ((UINT32)0x0000003D)
-#define TPM_ORD_Quote2                            ((UINT32)0x0000003E)
-#define TPM_ORD_SetCapability                     ((UINT32)0x0000003F)
-#define TPM_ORD_ResetLockValue                    ((UINT32)0x00000040)
-#define TPM_ORD_LoadKey2                          ((UINT32)0x00000041)
-#define TPM_ORD_GetRandom                         ((UINT32)0x00000046)
-#define TPM_ORD_StirRandom                        ((UINT32)0x00000047)
-#define TPM_ORD_SelfTestFull                      ((UINT32)0x00000050)
-#define TPM_ORD_CertifySelfTest                   ((UINT32)0x00000052)
-#define TPM_ORD_ContinueSelfTest                  ((UINT32)0x00000053)
-#define TPM_ORD_GetTestResult                     ((UINT32)0x00000054)
-#define TPM_ORD_Reset                             ((UINT32)0x0000005A)
-#define TPM_ORD_OwnerClear                        ((UINT32)0x0000005B)
-#define TPM_ORD_DisableOwnerClear                 ((UINT32)0x0000005C)
-#define TPM_ORD_ForceClear                        ((UINT32)0x0000005D)
-#define TPM_ORD_DisableForceClear                 ((UINT32)0x0000005E)
-#define TPM_ORD_GetCapabilitySigned               ((UINT32)0x00000064)
-#define TPM_ORD_GetCapability                     ((UINT32)0x00000065)
-#define TPM_ORD_GetCapabilityOwner                ((UINT32)0x00000066)
-#define TPM_ORD_OwnerSetDisable                   ((UINT32)0x0000006E)
-#define TPM_ORD_PhysicalEnable                    ((UINT32)0x0000006F)
-#define TPM_ORD_PhysicalDisable                   ((UINT32)0x00000070)
-#define TPM_ORD_SetOwnerInstall                   ((UINT32)0x00000071)
-#define TPM_ORD_PhysicalSetDeactivated            ((UINT32)0x00000072)
-#define TPM_ORD_SetTempDeactivated                ((UINT32)0x00000073)
-#define TPM_ORD_SetOperatorAuth                   ((UINT32)0x00000074)
-#define TPM_ORD_SetOwnerPointer                   ((UINT32)0x00000075)
-#define TPM_ORD_CreateEndorsementKeyPair          ((UINT32)0x00000078)
-#define TPM_ORD_MakeIdentity                      ((UINT32)0x00000079)
-#define TPM_ORD_ActivateIdentity                  ((UINT32)0x0000007A)
-#define TPM_ORD_ReadPubek                         ((UINT32)0x0000007C)
-#define TPM_ORD_OwnerReadPubek                    ((UINT32)0x0000007D)
-#define TPM_ORD_DisablePubekRead                  ((UINT32)0x0000007E)
-#define TPM_ORD_CreateRevocableEK                 ((UINT32)0x0000007F)
-#define TPM_ORD_RevokeTrust                       ((UINT32)0x00000080)
-#define TPM_ORD_OwnerReadInternalPub              ((UINT32)0x00000081)
-#define TPM_ORD_GetAuditEvent                     ((UINT32)0x00000082)
-#define TPM_ORD_GetAuditEventSigned               ((UINT32)0x00000083)
-#define TPM_ORD_GetAuditDigest                    ((UINT32)0x00000085)
-#define TPM_ORD_GetAuditDigestSigned              ((UINT32)0x00000086)
-#define TPM_ORD_GetOrdinalAuditStatus             ((UINT32)0x0000008C)
-#define TPM_ORD_SetOrdinalAuditStatus             ((UINT32)0x0000008D)
-#define TPM_ORD_Terminate_Handle                  ((UINT32)0x00000096)
-#define TPM_ORD_Init                              ((UINT32)0x00000097)
-#define TPM_ORD_SaveState                         ((UINT32)0x00000098)
-#define TPM_ORD_Startup                           ((UINT32)0x00000099)
-#define TPM_ORD_SetRedirection                    ((UINT32)0x0000009A)
-#define TPM_ORD_SHA1Start                         ((UINT32)0x000000A0)
-#define TPM_ORD_SHA1Update                        ((UINT32)0x000000A1)
-#define TPM_ORD_SHA1Complete                      ((UINT32)0x000000A2)
-#define TPM_ORD_SHA1CompleteExtend                ((UINT32)0x000000A3)
-#define TPM_ORD_FieldUpgrade                      ((UINT32)0x000000AA)
-#define TPM_ORD_SaveKeyContext                    ((UINT32)0x000000B4)
-#define TPM_ORD_LoadKeyContext                    ((UINT32)0x000000B5)
-#define TPM_ORD_SaveAuthContext                   ((UINT32)0x000000B6)
-#define TPM_ORD_LoadAuthContext                   ((UINT32)0x000000B7)
-#define TPM_ORD_SaveContext                       ((UINT32)0x000000B8)
-#define TPM_ORD_LoadContext                       ((UINT32)0x000000B9)
-#define TPM_ORD_FlushSpecific                     ((UINT32)0x000000BA)
-#define TPM_ORD_PCR_Reset                         ((UINT32)0x000000C8)
-#define TPM_ORD_NV_DefineSpace                    ((UINT32)0x000000CC)
-#define TPM_ORD_NV_WriteValue                     ((UINT32)0x000000CD)
-#define TPM_ORD_NV_WriteValueAuth                 ((UINT32)0x000000CE)
-#define TPM_ORD_NV_ReadValue                      ((UINT32)0x000000CF)
-#define TPM_ORD_NV_ReadValueAuth                  ((UINT32)0x000000D0)
-#define TPM_ORD_Delegate_UpdateVerification       ((UINT32)0x000000D1)
-#define TPM_ORD_Delegate_Manage                   ((UINT32)0x000000D2)
-#define TPM_ORD_Delegate_CreateKeyDelegation      ((UINT32)0x000000D4)
-#define TPM_ORD_Delegate_CreateOwnerDelegation    ((UINT32)0x000000D5)
-#define TPM_ORD_Delegate_VerifyDelegation         ((UINT32)0x000000D6)
-#define TPM_ORD_Delegate_LoadOwnerDelegation      ((UINT32)0x000000D8)
-#define TPM_ORD_Delegate_ReadTable                ((UINT32)0x000000DB)
-#define TPM_ORD_CreateCounter                     ((UINT32)0x000000DC)
-#define TPM_ORD_IncrementCounter                  ((UINT32)0x000000DD)
-#define TPM_ORD_ReadCounter                       ((UINT32)0x000000DE)
-#define TPM_ORD_ReleaseCounter                    ((UINT32)0x000000DF)
-#define TPM_ORD_ReleaseCounterOwner               ((UINT32)0x000000E0)
-#define TPM_ORD_EstablishTransport                ((UINT32)0x000000E6)
-#define TPM_ORD_ExecuteTransport                  ((UINT32)0x000000E7)
-#define TPM_ORD_ReleaseTransportSigned            ((UINT32)0x000000E8)
-#define TPM_ORD_GetTicks                          ((UINT32)0x000000F1)
-#define TPM_ORD_TickStampBlob                     ((UINT32)0x000000F2)
-
-#define TSC_ORD_PhysicalPresence                  ((UINT32)0x4000000A)
-#define TSC_ORD_ResetEstablishmentBit             ((UINT32)0x4000000B)
-
-#endif // __TPM_ORDINAL_H__
+/*
+ * TPM Ordinal definitions extracted from the TPM 1.2 specification, rev 85.
+ */
+
+#ifndef __TPM_ORDINAL_H__
+#define __TPM_ORDINAL_H__
+
+#define TPM_PROTECTED_COMMAND                     ((UINT32)(0x00000000))
+#define TPM_UNPROTECTED_COMMAND                   ((UINT32)(0x80000000))
+#define TPM_CONNECTION_COMMAND                    ((UINT32)(0x40000000))
+#define TPM_VENDOR_COMMAND                        ((UINT32)(0x20000000))
+
+#define TPM_MAIN                                  ((UINT16)(0x0000))
+#define TPM_PC                                    ((UINT16)(0x0001))
+#define TPM_PDA                                   ((UINT16)(0x0002))
+#define TPM_CELL_PHONE                            ((UINT16)(0x0003))
+#define TPM_SERVER                                ((UINT16)(0x0004))
+
+#define TPM_PROTECTED_ORDINAL              (TPM_MAIN | TPM_PROTECTED_COMMAND)
+#define TPM_UNPROTECTED_ORDINAL            (TPM_MAIN | TPM_UNPROTECTED_COMMAND)
+#define TPM_CONNECTION_ORDINAL             (TPM_MAIN | TPM_CONNECTION_COMMAND)
+
+
+#define TPM_ORD_OIAP                              ((UINT32)0x0000000A)
+#define TPM_ORD_OSAP                              ((UINT32)0x0000000B)
+#define TPM_ORD_ChangeAuth                        ((UINT32)0x0000000C)
+#define TPM_ORD_TakeOwnership                     ((UINT32)0x0000000D)
+#define TPM_ORD_ChangeAuthAsymStart               ((UINT32)0x0000000E)
+#define TPM_ORD_ChangeAuthAsymFinish              ((UINT32)0x0000000F)
+#define TPM_ORD_ChangeAuthOwner                   ((UINT32)0x00000010)
+#define TPM_ORD_DSAP                              ((UINT32)0x00000011)
+#define TPM_ORD_CMK_CreateTicket                  ((UINT32)0x00000012)
+#define TPM_ORD_CMK_CreateKey                     ((UINT32)0x00000013)
+#define TPM_ORD_Extend                            ((UINT32)0x00000014)
+#define TPM_ORD_PcrRead                           ((UINT32)0x00000015)
+#define TPM_ORD_Quote                             ((UINT32)0x00000016)
+#define TPM_ORD_Seal                              ((UINT32)0x00000017)
+#define TPM_ORD_Unseal                            ((UINT32)0x00000018)
+#define TPM_ORD_DirWriteAuth                      ((UINT32)0x00000019)
+#define TPM_ORD_DirRead                           ((UINT32)0x0000001A)
+#define TPM_ORD_CMK_CreateBlob                    ((UINT32)0x0000001B)
+#define TPM_ORD_CMK_SetRestrictions               ((UINT32)0x0000001C)
+#define TPM_ORD_CMK_ApproveMA                     ((UINT32)0x0000001D)
+#define TPM_ORD_UnBind                            ((UINT32)0x0000001E)
+#define TPM_ORD_CreateWrapKey                     ((UINT32)0x0000001F)
+#define TPM_ORD_LoadKey                           ((UINT32)0x00000020)
+#define TPM_ORD_GetPubKey                         ((UINT32)0x00000021)
+#define TPM_ORD_EvictKey                          ((UINT32)0x00000022)
+#define TPM_ORD_KeyControlOwner                   ((UINT32)0x00000023)
+#define TPM_ORD_CMK_ConvertMigration              ((UINT32)0x00000024)
+#define TPM_ORD_MigrateKey                        ((UINT32)0x00000025)
+#define TPM_ORD_CreateMigrationBlob               ((UINT32)0x00000028)
+#define TPM_ORD_DAA_Join                          ((UINT32)0x00000029)
+#define TPM_ORD_ConvertMigrationBlob              ((UINT32)0x0000002A)
+#define TPM_ORD_AuthorizeMigrationKey             ((UINT32)0x0000002B)
+#define TPM_ORD_CreateMaintenanceArchive          ((UINT32)0x0000002C)
+#define TPM_ORD_LoadMaintenanceArchive            ((UINT32)0x0000002D)
+#define TPM_ORD_KillMaintenanceFeature            ((UINT32)0x0000002E)
+#define TPM_ORD_LoadManuMaintPub                  ((UINT32)0x0000002F)
+#define TPM_ORD_ReadManuMaintPub                  ((UINT32)0x00000030)
+#define TPM_ORD_DAA_Sign                          ((UINT32)0x00000031)
+#define TPM_ORD_CertifyKey                        ((UINT32)0x00000032)
+#define TPM_ORD_CertifyKey2                       ((UINT32)0x00000033)
+#define TPM_ORD_Sign                              ((UINT32)0x0000003C)
+#define TPM_ORD_Sealx                             ((UINT32)0x0000003D)
+#define TPM_ORD_Quote2                            ((UINT32)0x0000003E)
+#define TPM_ORD_SetCapability                     ((UINT32)0x0000003F)
+#define TPM_ORD_ResetLockValue                    ((UINT32)0x00000040)
+#define TPM_ORD_LoadKey2                          ((UINT32)0x00000041)
+#define TPM_ORD_GetRandom                         ((UINT32)0x00000046)
+#define TPM_ORD_StirRandom                        ((UINT32)0x00000047)
+#define TPM_ORD_SelfTestFull                      ((UINT32)0x00000050)
+#define TPM_ORD_CertifySelfTest                   ((UINT32)0x00000052)
+#define TPM_ORD_ContinueSelfTest                  ((UINT32)0x00000053)
+#define TPM_ORD_GetTestResult                     ((UINT32)0x00000054)
+#define TPM_ORD_Reset                             ((UINT32)0x0000005A)
+#define TPM_ORD_OwnerClear                        ((UINT32)0x0000005B)
+#define TPM_ORD_DisableOwnerClear                 ((UINT32)0x0000005C)
+#define TPM_ORD_ForceClear                        ((UINT32)0x0000005D)
+#define TPM_ORD_DisableForceClear                 ((UINT32)0x0000005E)
+#define TPM_ORD_GetCapabilitySigned               ((UINT32)0x00000064)
+#define TPM_ORD_GetCapability                     ((UINT32)0x00000065)
+#define TPM_ORD_GetCapabilityOwner                ((UINT32)0x00000066)
+#define TPM_ORD_OwnerSetDisable                   ((UINT32)0x0000006E)
+#define TPM_ORD_PhysicalEnable                    ((UINT32)0x0000006F)
+#define TPM_ORD_PhysicalDisable                   ((UINT32)0x00000070)
+#define TPM_ORD_SetOwnerInstall                   ((UINT32)0x00000071)
+#define TPM_ORD_PhysicalSetDeactivated            ((UINT32)0x00000072)
+#define TPM_ORD_SetTempDeactivated                ((UINT32)0x00000073)
+#define TPM_ORD_SetOperatorAuth                   ((UINT32)0x00000074)
+#define TPM_ORD_SetOwnerPointer                   ((UINT32)0x00000075)
+#define TPM_ORD_CreateEndorsementKeyPair          ((UINT32)0x00000078)
+#define TPM_ORD_MakeIdentity                      ((UINT32)0x00000079)
+#define TPM_ORD_ActivateIdentity                  ((UINT32)0x0000007A)
+#define TPM_ORD_ReadPubek                         ((UINT32)0x0000007C)
+#define TPM_ORD_OwnerReadPubek                    ((UINT32)0x0000007D)
+#define TPM_ORD_DisablePubekRead                  ((UINT32)0x0000007E)
+#define TPM_ORD_CreateRevocableEK                 ((UINT32)0x0000007F)
+#define TPM_ORD_RevokeTrust                       ((UINT32)0x00000080)
+#define TPM_ORD_OwnerReadInternalPub              ((UINT32)0x00000081)
+#define TPM_ORD_GetAuditEvent                     ((UINT32)0x00000082)
+#define TPM_ORD_GetAuditEventSigned               ((UINT32)0x00000083)
+#define TPM_ORD_GetAuditDigest                    ((UINT32)0x00000085)
+#define TPM_ORD_GetAuditDigestSigned              ((UINT32)0x00000086)
+#define TPM_ORD_GetOrdinalAuditStatus             ((UINT32)0x0000008C)
+#define TPM_ORD_SetOrdinalAuditStatus             ((UINT32)0x0000008D)
+#define TPM_ORD_Terminate_Handle                  ((UINT32)0x00000096)
+#define TPM_ORD_Init                              ((UINT32)0x00000097)
+#define TPM_ORD_SaveState                         ((UINT32)0x00000098)
+#define TPM_ORD_Startup                           ((UINT32)0x00000099)
+#define TPM_ORD_SetRedirection                    ((UINT32)0x0000009A)
+#define TPM_ORD_SHA1Start                         ((UINT32)0x000000A0)
+#define TPM_ORD_SHA1Update                        ((UINT32)0x000000A1)
+#define TPM_ORD_SHA1Complete                      ((UINT32)0x000000A2)
+#define TPM_ORD_SHA1CompleteExtend                ((UINT32)0x000000A3)
+#define TPM_ORD_FieldUpgrade                      ((UINT32)0x000000AA)
+#define TPM_ORD_SaveKeyContext                    ((UINT32)0x000000B4)
+#define TPM_ORD_LoadKeyContext                    ((UINT32)0x000000B5)
+#define TPM_ORD_SaveAuthContext                   ((UINT32)0x000000B6)
+#define TPM_ORD_LoadAuthContext                   ((UINT32)0x000000B7)
+#define TPM_ORD_SaveContext                       ((UINT32)0x000000B8)
+#define TPM_ORD_LoadContext                       ((UINT32)0x000000B9)
+#define TPM_ORD_FlushSpecific                     ((UINT32)0x000000BA)
+#define TPM_ORD_PCR_Reset                         ((UINT32)0x000000C8)
+#define TPM_ORD_NV_DefineSpace                    ((UINT32)0x000000CC)
+#define TPM_ORD_NV_WriteValue                     ((UINT32)0x000000CD)
+#define TPM_ORD_NV_WriteValueAuth                 ((UINT32)0x000000CE)
+#define TPM_ORD_NV_ReadValue                      ((UINT32)0x000000CF)
+#define TPM_ORD_NV_ReadValueAuth                  ((UINT32)0x000000D0)
+#define TPM_ORD_Delegate_UpdateVerification       ((UINT32)0x000000D1)
+#define TPM_ORD_Delegate_Manage                   ((UINT32)0x000000D2)
+#define TPM_ORD_Delegate_CreateKeyDelegation      ((UINT32)0x000000D4)
+#define TPM_ORD_Delegate_CreateOwnerDelegation    ((UINT32)0x000000D5)
+#define TPM_ORD_Delegate_VerifyDelegation         ((UINT32)0x000000D6)
+#define TPM_ORD_Delegate_LoadOwnerDelegation      ((UINT32)0x000000D8)
+#define TPM_ORD_Delegate_ReadTable                ((UINT32)0x000000DB)
+#define TPM_ORD_CreateCounter                     ((UINT32)0x000000DC)
+#define TPM_ORD_IncrementCounter                  ((UINT32)0x000000DD)
+#define TPM_ORD_ReadCounter                       ((UINT32)0x000000DE)
+#define TPM_ORD_ReleaseCounter                    ((UINT32)0x000000DF)
+#define TPM_ORD_ReleaseCounterOwner               ((UINT32)0x000000E0)
+#define TPM_ORD_EstablishTransport                ((UINT32)0x000000E6)
+#define TPM_ORD_ExecuteTransport                  ((UINT32)0x000000E7)
+#define TPM_ORD_ReleaseTransportSigned            ((UINT32)0x000000E8)
+#define TPM_ORD_GetTicks                          ((UINT32)0x000000F1)
+#define TPM_ORD_TickStampBlob                     ((UINT32)0x000000F2)
+
+#define TSC_ORD_PhysicalPresence                  ((UINT32)0x4000000A)
+#define TSC_ORD_ResetEstablishmentBit             ((UINT32)0x4000000B)
+
+#endif // __TPM_ORDINAL_H__
diff -ru trousers-0.3.8-orig/src/include/tss/tpm.h trousers-0.3.8/src/include/tss/tpm.h
--- trousers-0.3.8-orig/src/include/tss/tpm.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tpm.h	2012-02-14 20:35:05.914846447 +0000
@@ -1,1663 +1,1663 @@
-/*++
- * 
- * TPM structures extracted from the TPM specification 1.2, 
- * Part 2 (Structures), rev 85.
- *
- * Errata:
- *
- * *) The individual bits of TPM_STARTUP_EFFECTS were not given names in
- * the TPM spec so they are not defined in tpm.h.
- * 
- * *) A few typedefs not present in the TPM 1.2 specification have been
- * added. This was generally done when the TPM 1.2 spec defined a set of
- * related values (either bitmasks or enumeration values) but did not
- * define an associated type to hold these values. The typedefs have been
- * added and structure fields that were to hold those values have been
- * switched from generic UINT* types to the more specific types. This was
- * done to highlight exactly where those #defined values were to be used.
- * The types that have been added are:
- *   TPM_NV_PER_ATTRIBUTES
- *   TPM_DELEGATE_TYPE
- *
- * *) The layout of bitfields within a structure are compiler-dependent
- * and the use of structure bitfields has been avoided where possible. In
- * cases where a value is a collection of independent bits the type is
- * given a name (typedeffed to UINT16 or UINT32 as appropriate) and masks
- * are #defined to access the individual bits. This is not possible for
- * TPM_VERSION_BYTE because the fields are 4-bit values. A best attempt
- * has been made to make this compiler independent but it has only been
- * checked on GCC and Visual C++ on little-endian machines.
- * 
- * *) The TPM_DELEGATIONS per1 and per2 fields field are a bitmask but
- * are defined as a UINT32 because the bitfields have different meaning
- * based on the type of delegation blob.
- * 
- * *) The definitions of TPM_PERMANENT_DATA, TPM_STCLEAR_DATA,
- * TPM_STANY_DATA, and TPM_DELEGATE_TABLE_ROW are commented out. These
- * structures are internal to the TPM and are not directly accessible by
- * external software so this should not be a problem.
- * 
- * *) The definitions of TPM_FAMILY_TABLE and TPM_DELEGATE_TABLE are
- * commented out because they are variable length arrays internal to the
- * TPM. As above they are not directly accessible by external software
- * so this should not be a problem.
- */
-
-#ifndef __TPM_H__
-#define __TPM_H__
-
-#ifdef __midl
-#define SIZEIS(x)  [size_is(x)]
-#else
-#define SIZEIS(x)
-#endif
-
-#include <tss/platform.h>
-
-//-------------------------------------------------------------------
-// Part 2, section 2.1: Basic data types
-typedef BYTE   TPM_BOOL;
-#ifndef FALSE
-#define FALSE  0x00
-#define TRUE   0x01
-#endif /* ifndef FALSE */
-
-//-------------------------------------------------------------------
-// Part 2, section 2.3: Helper Redefinitions
-//   Many of the helper redefinitions appear later in this file
-//   so that they are declared next to the list of valid values
-//   they may hold.
-typedef BYTE TPM_LOCALITY_MODIFIER;
-typedef UINT32 TPM_COMMAND_CODE;                            /* 1.1b */
-typedef UINT32 TPM_COUNT_ID;
-typedef UINT32 TPM_REDIT_COMMAND;
-typedef UINT32 TPM_HANDLE;
-typedef UINT32 TPM_AUTHHANDLE;
-typedef UINT32 TPM_TRANSHANDLE;
-typedef UINT32 TPM_KEYHANDLE;
-typedef UINT32 TPM_DIRINDEX;
-typedef UINT32 TPM_PCRINDEX;
-typedef UINT32 TPM_RESULT;
-typedef UINT32 TPM_MODIFIER_INDICATOR;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 2.2.4: Vendor Specific
-#define TPM_Vendor_Specific32  0x00000400
-#define TPM_Vendor_Specific8   0x80
-
-
-//-------------------------------------------------------------------
-// Part 2, section 3: Structure Tags
-typedef UINT16  TPM_STRUCTURE_TAG;
-#define TPM_TAG_CONTEXTBLOB            ((UINT16)0x0001)
-#define TPM_TAG_CONTEXT_SENSITIVE      ((UINT16)0x0002)
-#define TPM_TAG_CONTEXTPOINTER         ((UINT16)0x0003)
-#define TPM_TAG_CONTEXTLIST            ((UINT16)0x0004)
-#define TPM_TAG_SIGNINFO               ((UINT16)0x0005)
-#define TPM_TAG_PCR_INFO_LONG          ((UINT16)0x0006)
-#define TPM_TAG_PERSISTENT_FLAGS       ((UINT16)0x0007)
-#define TPM_TAG_VOLATILE_FLAGS         ((UINT16)0x0008)
-#define TPM_TAG_PERSISTENT_DATA        ((UINT16)0x0009)
-#define TPM_TAG_VOLATILE_DATA          ((UINT16)0x000a)
-#define TPM_TAG_SV_DATA                ((UINT16)0x000b)
-#define TPM_TAG_EK_BLOB                ((UINT16)0x000c)
-#define TPM_TAG_EK_BLOB_AUTH           ((UINT16)0x000d)
-#define TPM_TAG_COUNTER_VALUE          ((UINT16)0x000e)
-#define TPM_TAG_TRANSPORT_INTERNAL     ((UINT16)0x000f)
-#define TPM_TAG_TRANSPORT_LOG_IN       ((UINT16)0x0010)
-#define TPM_TAG_TRANSPORT_LOG_OUT      ((UINT16)0x0011)
-#define TPM_TAG_AUDIT_EVENT_IN         ((UINT16)0x0012)
-#define TPM_TAG_AUDIT_EVENT_OUT        ((UINT16)0x0013)
-#define TPM_TAG_CURRENT_TICKS          ((UINT16)0x0014)
-#define TPM_TAG_KEY                    ((UINT16)0x0015)
-#define TPM_TAG_STORED_DATA12          ((UINT16)0x0016)
-#define TPM_TAG_NV_ATTRIBUTES          ((UINT16)0x0017)
-#define TPM_TAG_NV_DATA_PUBLIC         ((UINT16)0x0018)
-#define TPM_TAG_NV_DATA_SENSITIVE      ((UINT16)0x0019)
-#define TPM_TAG_DELEGATIONS            ((UINT16)0x001a)
-#define TPM_TAG_DELEGATE_PUBLIC        ((UINT16)0x001b)
-#define TPM_TAG_DELEGATE_TABLE_ROW     ((UINT16)0x001c)
-#define TPM_TAG_TRANSPORT_AUTH         ((UINT16)0x001d)
-#define TPM_TAG_TRANSPORT_PUBLIC       ((UINT16)0x001e)
-#define TPM_TAG_PERMANENT_FLAGS        ((UINT16)0x001f)
-#define TPM_TAG_STCLEAR_FLAGS          ((UINT16)0x0020)
-#define TPM_TAG_STANY_FLAGS            ((UINT16)0x0021)
-#define TPM_TAG_PERMANENT_DATA         ((UINT16)0x0022)
-#define TPM_TAG_STCLEAR_DATA           ((UINT16)0x0023)
-#define TPM_TAG_STANY_DATA             ((UINT16)0x0024)
-#define TPM_TAG_FAMILY_TABLE_ENTRY     ((UINT16)0x0025)
-#define TPM_TAG_DELEGATE_SENSITIVE     ((UINT16)0x0026)
-#define TPM_TAG_DELG_KEY_BLOB          ((UINT16)0x0027)
-#define TPM_TAG_KEY12                  ((UINT16)0x0028)
-#define TPM_TAG_CERTIFY_INFO2          ((UINT16)0x0029)
-#define TPM_TAG_DELEGATE_OWNER_BLOB    ((UINT16)0x002a)
-#define TPM_TAG_EK_BLOB_ACTIVATE       ((UINT16)0x002b)
-#define TPM_TAG_DAA_BLOB               ((UINT16)0x002c)
-#define TPM_TAG_DAA_CONTEXT            ((UINT16)0x002d)
-#define TPM_TAG_DAA_ENFORCE            ((UINT16)0x002e)
-#define TPM_TAG_DAA_ISSUER             ((UINT16)0x002f)
-#define TPM_TAG_CAP_VERSION_INFO       ((UINT16)0x0030)
-#define TPM_TAG_DAA_SENSITIVE          ((UINT16)0x0031)
-#define TPM_TAG_DAA_TPM                ((UINT16)0x0032)
-#define TPM_TAG_CMK_MIGAUTH            ((UINT16)0x0033)
-#define TPM_TAG_CMK_SIGTICKET          ((UINT16)0x0034)
-#define TPM_TAG_CMK_MA_APPROVAL        ((UINT16)0x0035)
-#define TPM_TAG_QUOTE_INFO2            ((UINT16)0x0036)
-#define TPM_TAG_DA_INFO                ((UINT16)0x0037)
-#define TPM_TAG_DA_INFO_LIMITED        ((UINT16)0x0038)
-#define TPM_TAG_DA_ACTION_TYPE         ((UINT16)0x0039)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 4: Types
-typedef UINT32 TPM_RESOURCE_TYPE;
-#define TPM_RT_KEY                     ((UINT32)0x00000001)
-#define TPM_RT_AUTH                    ((UINT32)0x00000002)
-#define TPM_RT_HASH                    ((UINT32)0x00000003)
-#define TPM_RT_TRANS                   ((UINT32)0x00000004)
-#define TPM_RT_CONTEXT                 ((UINT32)0x00000005)
-#define TPM_RT_COUNTER                 ((UINT32)0x00000006)
-#define TPM_RT_DELEGATE                ((UINT32)0x00000007)
-#define TPM_RT_DAA_TPM                 ((UINT32)0x00000008)
-#define TPM_RT_DAA_V0                  ((UINT32)0x00000009)
-#define TPM_RT_DAA_V1                  ((UINT32)0x0000000a)
-
-
-typedef BYTE TPM_PAYLOAD_TYPE;                              /* 1.1b */
-#define TPM_PT_ASYM                    ((BYTE)0x01)         /* 1.1b */
-#define TPM_PT_BIND                    ((BYTE)0x02)         /* 1.1b */
-#define TPM_PT_MIGRATE                 ((BYTE)0x03)         /* 1.1b */
-#define TPM_PT_MAINT                   ((BYTE)0x04)         /* 1.1b */
-#define TPM_PT_SEAL                    ((BYTE)0x05)         /* 1.1b */
-#define TPM_PT_MIGRATE_RESTRICTED      ((BYTE)0x06)
-#define TPM_PT_MIGRATE_EXTERNAL        ((BYTE)0x07)
-#define TPM_PT_CMK_MIGRATE             ((BYTE)0x08)
-
-
-typedef UINT16 TPM_ENTITY_TYPE;                             /* 1.1b */
-#define TPM_ET_KEYHANDLE               ((UINT16)0x0001)     /* 1.1b */
-#define TPM_ET_OWNER                   ((UINT16)0x0002)     /* 1.1b */
-#define TPM_ET_DATA                    ((UINT16)0x0003)     /* 1.1b */
-#define TPM_ET_SRK                     ((UINT16)0x0004)     /* 1.1b */
-#define TPM_ET_KEY                     ((UINT16)0x0005)     /* 1.1b */
-#define TPM_ET_REVOKE                  ((UINT16)0x0006)
-#define TPM_ET_DEL_OWNER_BLOB          ((UINT16)0x0007)
-#define TPM_ET_DEL_ROW                 ((UINT16)0x0008)
-#define TPM_ET_DEL_KEY_BLOB            ((UINT16)0x0009)
-#define TPM_ET_COUNTER                 ((UINT16)0x000a)
-#define TPM_ET_NV                      ((UINT16)0x000b)
-#define TPM_ET_OPERATOR                ((UINT16)0x000c)
-#define TPM_ET_RESERVED_HANDLE         ((UINT16)0x0040)
-
-/* The following values may be ORed into the MSB of the TPM_ENTITY_TYPE
- * to indicate particular encryption scheme
- */
-#define TPM_ET_XOR                     ((BYTE)0x00)
-#define TPM_ET_AES                     ((BYTE)0x06)
-
-typedef UINT32 TPM_KEY_HANDLE;                              /* 1.1b */
-#define TPM_KH_SRK                     ((UINT32)0x40000000)
-#define TPM_KH_OWNER                   ((UINT32)0x40000001)
-#define TPM_KH_REVOKE                  ((UINT32)0x40000002)
-#define TPM_KH_TRANSPORT               ((UINT32)0x40000003)
-#define TPM_KH_OPERATOR                ((UINT32)0x40000004)
-#define TPM_KH_ADMIN                   ((UINT32)0x40000005)
-#define TPM_KH_EK                      ((UINT32)0x40000006)
-/* 1.1b used different names, but the same values */
-#define TPM_KEYHND_SRK                 (TPM_KH_SRK)        /* 1.1b */
-#define TPM_KEYHND_OWNER               (TPM_KH_OWNER)      /* 1.1b */
-
-
-typedef UINT16 TPM_STARTUP_TYPE;                            /* 1.1b */
-#define TPM_ST_CLEAR                   ((UINT16)0x0001)     /* 1.1b */
-#define TPM_ST_STATE                   ((UINT16)0x0002)     /* 1.1b */
-#define TPM_ST_DEACTIVATED             ((UINT16)0x0003)     /* 1.1b */
-
-
-//typedef UINT32 TPM_STARTUP_EFFECTS;
-// 32-bit mask, see spec for meaning. Names not currently defined.
-// bits 0-8 have meaning
-
-typedef UINT16 TPM_PROTOCOL_ID;                             /* 1.1b */
-#define TPM_PID_OIAP                   ((UINT16)0x0001)     /* 1.1b */
-#define TPM_PID_OSAP                   ((UINT16)0x0002)     /* 1.1b */
-#define TPM_PID_ADIP                   ((UINT16)0x0003)     /* 1.1b */
-#define TPM_PID_ADCP                   ((UINT16)0x0004)     /* 1.1b */
-#define TPM_PID_OWNER                  ((UINT16)0x0005)     /* 1.1b */
-#define TPM_PID_DSAP                   ((UINT16)0x0006)
-#define TPM_PID_TRANSPORT              ((UINT16)0x0007)
-
-
-// Note in 1.2 rev 104, DES and 3DES are eliminated
-typedef UINT32 TPM_ALGORITHM_ID;                            /* 1.1b */
-#define TPM_ALG_RSA                    ((UINT32)0x00000001) /* 1.1b */
-#define TPM_ALG_DES                    ((UINT32)0x00000002) /* 1.1b */
-#define TPM_ALG_3DES                   ((UINT32)0x00000003) /* 1.1b */
-#define TPM_ALG_SHA                    ((UINT32)0x00000004) /* 1.1b */
-#define TPM_ALG_HMAC                   ((UINT32)0x00000005) /* 1.1b */
-#define TPM_ALG_AES                    ((UINT32)0x00000006) /* 1.1b */
-#define TPM_ALG_AES128                 (TPM_ALG_AES)
-#define TPM_ALG_MGF1                   ((UINT32)0x00000007)
-#define TPM_ALG_AES192                 ((UINT32)0x00000008)
-#define TPM_ALG_AES256                 ((UINT32)0x00000009)
-#define TPM_ALG_XOR                    ((UINT32)0x0000000a)
-
-
-typedef UINT16 TPM_PHYSICAL_PRESENCE;                        /* 1.1b */
-#define TPM_PHYSICAL_PRESENCE_LOCK          ((UINT16)0x0004) /* 1.1b */
-#define TPM_PHYSICAL_PRESENCE_PRESENT       ((UINT16)0x0008) /* 1.1b */
-#define TPM_PHYSICAL_PRESENCE_NOTPRESENT    ((UINT16)0x0010) /* 1.1b */
-#define TPM_PHYSICAL_PRESENCE_CMD_ENABLE    ((UINT16)0x0020) /* 1.1b */
-#define TPM_PHYSICAL_PRESENCE_HW_ENABLE     ((UINT16)0x0040) /* 1.1b */
-#define TPM_PHYSICAL_PRESENCE_LIFETIME_LOCK ((UINT16)0x0080) /* 1.1b */
-#define TPM_PHYSICAL_PRESENCE_CMD_DISABLE   ((UINT16)0x0100)
-#define TPM_PHYSICAL_PRESENCE_HW_DISABLE    ((UINT16)0x0200)
-
-
-typedef UINT16 TPM_MIGRATE_SCHEME;                          /* 1.1b */
-#define TPM_MS_MIGRATE                   ((UINT16)0x0001)   /* 1.1b */
-#define TPM_MS_REWRAP                    ((UINT16)0x0002)   /* 1.1b */
-#define TPM_MS_MAINT                     ((UINT16)0x0003)   /* 1.1b */
-#define TPM_MS_RESTRICT_MIGRATE          ((UINT16)0x0004)
-#define TPM_MS_RESTRICT_APPROVE_DOUBLE   ((UINT16)0x0005)
-
-
-typedef UINT16 TPM_EK_TYPE;
-#define TPM_EK_TYPE_ACTIVATE           ((UINT16)0x0001)
-#define TPM_EK_TYPE_AUTH               ((UINT16)0x0002)
-
-
-typedef UINT16 TPM_PLATFORM_SPECIFIC;
-#define TPM_PS_PC_11                   ((UINT16)0x0001)
-#define TPM_PS_PC_12                   ((UINT16)0x0002)
-#define TPM_PS_PDA_12                  ((UINT16)0x0003)
-#define TPM_PS_Server_12               ((UINT16)0x0004)
-#define TPM_PS_Mobile_12               ((UINT16)0x0005)
-
-//-------------------------------------------------------------------
-// Part 2, section 5: Basic Structures
-
-typedef struct tdTPM_STRUCT_VER
-{
-    BYTE   major;
-    BYTE   minor;
-    BYTE   revMajor;
-    BYTE   revMinor;
-} TPM_STRUCT_VER;
-
-typedef struct tdTPM_VERSION_BYTE
-{
-    // This needs to be made compiler-independent.
-    int leastSigVer : 4; // least significant 4 bits
-    int mostSigVer  : 4; // most significant 4 bits
-} TPM_VERSION_BYTE;
-
-typedef struct tdTPM_VERSION
-{
-    BYTE   major;      // Should really be a TPM_VERSION_BYTE
-    BYTE   minor;      // Should really be a TPM_VERSION_BYTE
-    BYTE   revMajor;
-    BYTE   revMinor;
-} TPM_VERSION;
-
-
-// Put this in the right place:
-// byte size definition for 160 bit SHA1 hash value
-#define TPM_SHA1_160_HASH_LEN    0x14
-#define TPM_SHA1BASED_NONCE_LEN  TPM_SHA1_160_HASH_LEN
-
-typedef struct tdTPM_DIGEST
-{
-    BYTE  digest[TPM_SHA1_160_HASH_LEN];
-} TPM_DIGEST;
-
-typedef TPM_DIGEST TPM_CHOSENID_HASH;
-typedef TPM_DIGEST TPM_COMPOSITE_HASH;
-typedef TPM_DIGEST TPM_DIRVALUE;
-typedef TPM_DIGEST TPM_HMAC;
-typedef TPM_DIGEST TPM_PCRVALUE;
-typedef TPM_DIGEST TPM_AUDITDIGEST;
-
-typedef struct tdTPM_NONCE                                  /* 1.1b */
-{
-    BYTE  nonce[TPM_SHA1BASED_NONCE_LEN];
-} TPM_NONCE;
-
-typedef TPM_NONCE TPM_DAA_TPM_SEED;
-typedef TPM_NONCE TPM_DAA_CONTEXT_SEED;
-
-typedef struct tdTPM_AUTHDATA                               /* 1.1b */
-{
-    BYTE  authdata[TPM_SHA1_160_HASH_LEN];
-} TPM_AUTHDATA;
-
-typedef TPM_AUTHDATA TPM_SECRET;
-typedef TPM_AUTHDATA TPM_ENCAUTH;
-
-
-typedef struct tdTPM_KEY_HANDLE_LIST                        /* 1.1b */
-{
-    UINT16              loaded;
-    SIZEIS(loaded)
-        TPM_KEY_HANDLE *handle;
-} TPM_KEY_HANDLE_LIST;
-
-
-//-------------------------------------------------------------------
-// Part 2, section 5.8: Key usage values
-
-typedef UINT16 TPM_KEY_USAGE;                               /* 1.1b */
-#define TPM_KEY_SIGNING                ((UINT16)0x0010)     /* 1.1b */
-#define TPM_KEY_STORAGE                ((UINT16)0x0011)     /* 1.1b */
-#define TPM_KEY_IDENTITY               ((UINT16)0x0012)     /* 1.1b */
-#define TPM_KEY_AUTHCHANGE             ((UINT16)0x0013)     /* 1.1b */
-#define TPM_KEY_BIND                   ((UINT16)0x0014)     /* 1.1b */
-#define TPM_KEY_LEGACY                 ((UINT16)0x0015)     /* 1.1b */
-#define TPM_KEY_MIGRATE                ((UINT16)0x0016)
-
-typedef UINT16 TPM_SIG_SCHEME;                              /* 1.1b */
-#define TPM_SS_NONE                    ((UINT16)0x0001)     /* 1.1b */
-#define TPM_SS_RSASSAPKCS1v15_SHA1     ((UINT16)0x0002)     /* 1.1b */
-#define TPM_SS_RSASSAPKCS1v15_DER      ((UINT16)0x0003)     /* 1.1b */
-#define TPM_SS_RSASSAPKCS1v15_INFO     ((UINT16)0x0004)
-
-typedef UINT16 TPM_ENC_SCHEME;                              /* 1.1b */
-#define TPM_ES_NONE                    ((UINT16)0x0001)     /* 1.1b */
-#define TPM_ES_RSAESPKCSv15            ((UINT16)0x0002)     /* 1.1b */
-#define TPM_ES_RSAESOAEP_SHA1_MGF1     ((UINT16)0x0003)     /* 1.1b */
-#define TPM_ES_SYM_CNT                 ((UINT16)0x0004)
-#define TPM_ES_SYM_CTR                 TPM_ES_SYM_CNT
-#define TPM_ES_SYM_OFB                 ((UINT16)0x0005)
-#define TPM_ES_SYM_CBC_PKCS5PAD        ((UINT16)0x00ff)
-
-//-------------------------------------------------------------------
-// Part 2, section 5.9: TPM_AUTH_DATA_USAGE values
-
-typedef BYTE TPM_AUTH_DATA_USAGE;                           /* 1.1b */
-#define TPM_AUTH_NEVER                 ((BYTE)0x00)         /* 1.1b */
-#define TPM_AUTH_ALWAYS                ((BYTE)0x01)         /* 1.1b */
-#define TPM_AUTH_PRIV_USE_ONLY         ((BYTE)0x11)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 5.10: TPM_KEY_FLAGS flags
-
-typedef UINT32 TPM_KEY_FLAGS;                               /* 1.1b */
-#define TPM_REDIRECTION                ((UINT32)0x00000001) /* 1.1b */
-#define TPM_MIGRATABLE                 ((UINT32)0x00000002) /* 1.1b */
-#define TPM_VOLATILE                   ((UINT32)0x00000004) /* 1.1b */
-#define TPM_PCRIGNOREDONREAD           ((UINT32)0x00000008)
-#define TPM_MIGRATEAUTHORITY           ((UINT32)0x00000010)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 5.11: TPM_CHANGEAUTH_VALIDATE
-
-typedef struct tdTPM_CHANGEAUTH_VALIDATE
-{
-    TPM_SECRET newAuthSecret;
-    TPM_NONCE  n1;
-} TPM_CHANGEAUTH_VALIDATE;
-
-//-------------------------------------------------------------------
-// Part 2, section 5.12: TPM_MIGRATIONKEYAUTH
-// declared after section 10 to catch declaration of TPM_PUBKEY 
-
-//-------------------------------------------------------------------
-// Part 2, section 5.13: TPM_COUNTER_VALUE;
-
-typedef UINT32 TPM_ACTUAL_COUNT;
-typedef struct tdTPM_COUNTER_VALUE
-{
-    TPM_STRUCTURE_TAG tag;
-    BYTE              label[4];
-    TPM_ACTUAL_COUNT  counter;
-} TPM_COUNTER_VALUE;
-
-//-------------------------------------------------------------------
-// Part 2, section 5.14: TPM_SIGN_INFO structure
-
-typedef struct tdTPM_SIGN_INFO
-{
-    TPM_STRUCTURE_TAG tag;
-    BYTE              fixed[4];
-    TPM_NONCE         replay;
-    UINT32            dataLen;
-    SIZEIS(dataLen)
-        BYTE         *data;
-} TPM_SIGN_INFO;
-
-//-------------------------------------------------------------------
-// Part 2, section 5.15: TPM_MSA_COMPOSITE
-
-typedef struct tdTPM_MSA_COMPOSITE
-{
-    UINT32          MSAlist;
-    SIZEIS(MSAlist)
-        TPM_DIGEST *migAuthDigest;
-} TPM_MSA_COMPOSITE;
-
-//-------------------------------------------------------------------
-// Part 2, section 5.16: TPM_CMK_AUTH
-
-typedef struct tdTPM_CMK_AUTH
-{
-    TPM_DIGEST migrationAuthorityDigest;
-    TPM_DIGEST destinationKeyDigest;
-    TPM_DIGEST sourceKeyDigest;
-} TPM_CMK_AUTH;
-
-//-------------------------------------------------------------------
-// Part 2, section 5.17: TPM_CMK_DELEGATE
-
-typedef UINT32 TPM_CMK_DELEGATE;
-#define TPM_CMK_DELEGATE_SIGNING       (((UINT32)1)<<31)
-#define TPM_CMK_DELEGATE_STORAGE       (((UINT32)1)<<30)
-#define TPM_CMK_DELEGATE_BIND          (((UINT32)1)<<29)
-#define TPM_CMK_DELEGATE_LEGACY        (((UINT32)1)<<28)
-#define TPM_CMK_DELEGATE_MIGRATE       (((UINT32)1)<<27)
-
-//-------------------------------------------------------------------
-// Part 2, section 5.18: TPM_SELECT_SIZE
-
-typedef struct tdTPM_SELECT_SIZE
-{
-    BYTE   major;
-    BYTE   minor;
-    UINT16 reqSize;
-} TPM_SELECT_SIZE;
-
-//-------------------------------------------------------------------
-// Part 2, section 5.19: TPM_CMK_MIGAUTH
-
-typedef struct tdTPM_CMK_MIGAUTH
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_DIGEST        msaDigest;
-    TPM_DIGEST        pubKeyDigest;
-} TPM_CMK_MIGAUTH;
-
-//-------------------------------------------------------------------
-// Part 2, section 5.20: TPM_CMK_SIGTICKET
-
-typedef struct tdTPM_CMK_SIGTICKET
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_DIGEST        verKeyDigest;
-    TPM_DIGEST        signedData;
-} TPM_CMK_SIGTICKET;
-
-//-------------------------------------------------------------------
-// Part 2, section 5.21: TPM_CMK_MA_APPROVAL
-
-typedef struct tdTPM_CMK_MA_APPROVAL
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_DIGEST        migrationAuthorityDigest;
-} TPM_CMK_MA_APPROVAL;
-
-
-//-------------------------------------------------------------------
-// Part 2, section 6: Command Tags
-
-typedef UINT16 TPM_TAG;                                     /* 1.1b */
-#define TPM_TAG_RQU_COMMAND            ((UINT16)0x00c1)
-#define TPM_TAG_RQU_AUTH1_COMMAND      ((UINT16)0x00c2)
-#define TPM_TAG_RQU_AUTH2_COMMAND      ((UINT16)0x00c3)
-#define TPM_TAG_RSP_COMMAND            ((UINT16)0x00c4)
-#define TPM_TAG_RSP_AUTH1_COMMAND      ((UINT16)0x00c5)
-#define TPM_TAG_RSP_AUTH2_COMMAND      ((UINT16)0x00c6)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 7.1: TPM_PERMANENT_FLAGS
-
-typedef struct tdTPM_PERMANENT_FLAGS
-{
-    TPM_STRUCTURE_TAG tag;
-    TSS_BOOL disable;
-    TSS_BOOL ownership;
-    TSS_BOOL deactivated;
-    TSS_BOOL readPubek;
-    TSS_BOOL disableOwnerClear;
-    TSS_BOOL allowMaintenance;
-    TSS_BOOL physicalPresenceLifetimeLock;
-    TSS_BOOL physicalPresenceHWEnable;
-    TSS_BOOL physicalPresenceCMDEnable;
-    TSS_BOOL CEKPUsed;
-    TSS_BOOL TPMpost;
-    TSS_BOOL TPMpostLock;
-    TSS_BOOL FIPS;
-    TSS_BOOL Operator;
-    TSS_BOOL enableRevokeEK;
-    TSS_BOOL nvLocked;
-    TSS_BOOL readSRKPub;
-    TSS_BOOL tpmEstablished;
-    TSS_BOOL maintenanceDone;
-    TSS_BOOL disableFullDALogicInfo;
-} TPM_PERMANENT_FLAGS;
-
-#define TPM_PF_DISABLE                      ((UINT32)0x00000001)
-#define TPM_PF_OWNERSHIP                    ((UINT32)0x00000002)
-#define TPM_PF_DEACTIVATED                  ((UINT32)0x00000003)
-#define TPM_PF_READPUBEK                    ((UINT32)0x00000004)
-#define TPM_PF_DISABLEOWNERCLEAR            ((UINT32)0x00000005)
-#define TPM_PF_ALLOWMAINTENANCE             ((UINT32)0x00000006)
-#define TPM_PF_PHYSICALPRESENCELIFETIMELOCK ((UINT32)0x00000007)
-#define TPM_PF_PHYSICALPRESENCEHWENABLE     ((UINT32)0x00000008)
-#define TPM_PF_PHYSICALPRESENCECMDENABLE    ((UINT32)0x00000009)
-#define TPM_PF_CEKPUSED                     ((UINT32)0x0000000A)
-#define TPM_PF_TPMPOST                      ((UINT32)0x0000000B)
-#define TPM_PF_TPMPOSTLOCK                  ((UINT32)0x0000000C)
-#define TPM_PF_FIPS                         ((UINT32)0x0000000D)
-#define TPM_PF_OPERATOR                     ((UINT32)0x0000000E)
-#define TPM_PF_ENABLEREVOKEEK               ((UINT32)0x0000000F)
-#define TPM_PF_NV_LOCKED                    ((UINT32)0x00000010)
-#define TPM_PF_READSRKPUB                   ((UINT32)0x00000011)
-#define TPM_PF_RESETESTABLISHMENTBIT        ((UINT32)0x00000012)
-#define TPM_PF_MAINTENANCEDONE              ((UINT32)0x00000013)
-#define TPM_PF_DISABLEFULLDALOGICINFO       ((UINT32)0x00000014)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 7.2: TPM_STCLEAR_FLAGS
-
-typedef struct tdTPM_STCLEAR_FLAGS
-{
-    TPM_STRUCTURE_TAG tag;
-    TSS_BOOL          deactivated;
-    TSS_BOOL          disableForceClear;
-    TSS_BOOL          physicalPresence;
-    TSS_BOOL          physicalPresenceLock;
-    TSS_BOOL          bGlobalLock;
-} TPM_STCLEAR_FLAGS;
-
-#define TPM_SF_DEACTIVATED             ((UINT32)0x00000001)
-#define TPM_SF_DISABLEFORCECLEAR       ((UINT32)0x00000002)
-#define TPM_SF_PHYSICALPRESENCE        ((UINT32)0x00000003)
-#define TPM_SF_PHYSICALPRESENCELOCK    ((UINT32)0x00000004)
-#define TPM_SF_GLOBALLOCK              ((UINT32)0x00000005)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 7.3: TPM_STANY_FLAGS
-
-typedef struct tdTPM_STANY_FLAGS
-{
-    TPM_STRUCTURE_TAG      tag;
-    TSS_BOOL               postInitialise;
-    TPM_MODIFIER_INDICATOR localityModifier;
-    TSS_BOOL               transportExclusive;
-    TSS_BOOL               TOSPresent;
-} TPM_STANY_FLAGS;
-
-#define TPM_AF_POSTINITIALIZE          ((UINT32)0x00000001)
-#define TPM_AF_LOCALITYMODIFIER        ((UINT32)0x00000002)
-#define TPM_AF_TRANSPORTEXCLUSIVE      ((UINT32)0x00000003)
-#define TPM_AF_TOSPRESENT              ((UINT32)0x00000004)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 7.4: TPM_PERMANENT_DATA
-// available inside TPM only
-//
-//#define TPM_MIN_COUNTERS          4
-//#define TPM_NUM_PCR              16
-//#define TPM_MAX_NV_WRITE_NOOWNER 64
-//
-//typedef struct tdTPM_PERMANENT_DATA
-//{
-//    TPM_STRUCTURE_TAG  tag;
-//    BYTE               revMajor;
-//    BYTE               revMinor;
-//    TPM_NONCE          tpmProof;
-//    TPM_NONCE          ekReset;
-//    TPM_SECRET         ownerAuth;
-//    TPM_SECRET         operatorAuth;
-//    TPM_DIRVALUE       authDIR[1];
-//    TPM_PUBKEY         manuMaintPub;
-//    TPM_KEY            endorsementKey;
-//    TPM_KEY            srk;
-//    TPM_KEY            contextKey;
-//    TPM_KEY            delegateKey;
-//    TPM_COUNTER_VALUE  auditMonotonicCounter;
-//    TPM_COUNTER_VALUE  monitonicCounter[TPM_MIN_COUNTERS];
-//    TPM_PCR_ATTRIBUTES pcrAttrib[TPM_NUM_PCR];
-//    BYTE               ordinalAuditStatus[];
-//    BYTE              *rngState;
-//    TPM_FAMILY_TABLE   familyTable;
-//    TPM_DELEGATE_TABLE delegateTable;
-//    UINT32             maxNVBufSize;
-//    UINT32             lastFamilyID;
-//    UINT32             noOwnerNVWrite;
-//    TPM_CMK_DELEGATE   restrictDelegate;
-//    TPM_DAA_TPM_SEED   tpmDAASeed;
-//    TPM_NONCE          daaProof;
-//    TPM_NONCE          daaBlobKey;
-//} TPM_PERMANENT_DATA;
-
-
-//-------------------------------------------------------------------
-// Part 2, section 7.5: TPM_STCLEAR_DATA
-// available inside TPM only
-//
-//typedef struct tdTPM_STCLEAR_DATA
-//{
-//    TPM_STRUCTURE_TAG tag;
-//    TPM_NONCE         contextNonceKey;
-//    TPM_COUNT_ID      countID;
-//    UINT32            ownerReference;
-//    TPM_BOOL          disableResetLock;
-//    TPM_PCRVALUE      PCR[TPM_NUM_PCR];
-//    UINT32            deferredPhysicalPresence;
-//} TPM_STCLEAR_DATA;
-    
-
-
-//-------------------------------------------------------------------
-// Part 2, section 7.5: TPM_STANY_DATA
-// available inside TPM only
-//
-//typedef struct tdTPM_STANY_DATA
-//{
-//    TPM_STRUCTURE_TAG tag;
-//    TPM_NONCE         contextNonceSession;
-//    TPM_DIGEST        auditDigest;
-//    TPM_CURRENT_TICKS currentTicks;
-//    UINT32            contextCount;
-//    UINT32            contextList[TPM_MIN_SESSION_LIST];
-//    TPM_SESSION_DATA  sessions[TPM_MIN_SESSIONS];
-//    // The following appear in section 22.6 but not in 7.5
-//    TPM_DAA_ISSUER    DAA_issuerSettings;
-//    TPM_DAA_TPM       DAA_tpmSpecific;
-//    TPM_DAA_CONTEXT   DAA_session;
-//    TPM_DAA_JOINDATA  DAA_joinSession;
-//} TPM_STANY_DATA;
-    
-
-
-//-------------------------------------------------------------------
-// Part 2, section 8: PCR Structures
-
-typedef BYTE  TPM_LOCALITY_SELECTION;
-#define TPM_LOC_FOUR                   (((UINT32)1)<<4)
-#define TPM_LOC_THREE                  (((UINT32)1)<<3)
-#define TPM_LOC_TWO                    (((UINT32)1)<<2)
-#define TPM_LOC_ONE                    (((UINT32)1)<<1)
-#define TPM_LOC_ZERO                   (((UINT32)1)<<0)
-
-typedef struct tdTPM_PCR_SELECTION                          /* 1.1b */
-{ 
-    UINT16    sizeOfSelect;
-    SIZEIS(sizeOfSelect)
-        BYTE *pcrSelect;  
-} TPM_PCR_SELECTION;
-
-typedef struct tdTPM_PCR_COMPOSITE                          /* 1.1b */
-{ 
-    TPM_PCR_SELECTION select;
-    UINT32            valueSize;
-    SIZEIS(valueSize)
-        TPM_PCRVALUE *pcrValue; 
-} TPM_PCR_COMPOSITE;
-
-typedef struct tdTPM_PCR_INFO                               /* 1.1b */
-{
-    TPM_PCR_SELECTION  pcrSelection;
-    TPM_COMPOSITE_HASH digestAtRelease;
-    TPM_COMPOSITE_HASH digestAtCreation;
-}  TPM_PCR_INFO;
-
-typedef struct tdTPM_PCR_INFO_LONG
-{
-    TPM_STRUCTURE_TAG      tag;
-    TPM_LOCALITY_SELECTION localityAtCreation;
-    TPM_LOCALITY_SELECTION localityAtRelease;
-    TPM_PCR_SELECTION      creationPCRSelection;
-    TPM_PCR_SELECTION      releasePCRSelection;
-    TPM_COMPOSITE_HASH     digestAtCreation;
-    TPM_COMPOSITE_HASH     digestAtRelease;
-}  TPM_PCR_INFO_LONG;
-
-typedef struct tdTPM_PCR_INFO_SHORT
-{
-    TPM_PCR_SELECTION      pcrSelection;
-    TPM_LOCALITY_SELECTION localityAtRelease;
-    TPM_COMPOSITE_HASH     digestAtRelease;
-}  TPM_PCR_INFO_SHORT;
-
-typedef struct tdTPM_PCR_ATTRIBUTES
-{
-    BYTE                   pcrReset;
-    TPM_LOCALITY_SELECTION pcrExtendLocal;
-    TPM_LOCALITY_SELECTION pcrResetLocal;
-} TPM_PCR_ATTRIBUTES;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 9:
-
-typedef struct tdTPM_STORED_DATA                            /* 1.1b */
-{
-    TPM_STRUCT_VER ver;
-    UINT32         sealInfoSize;
-    SIZEIS(sealInfoSize)
-        BYTE      *sealInfo;
-    UINT32         encDataSize;
-    SIZEIS(encDataSize)
-        BYTE      *encData;
-} TPM_STORED_DATA;
-
-typedef struct tdTPM_STORED_DATA12
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_ENTITY_TYPE   et;
-    UINT32            sealInfoSize;
-    SIZEIS(sealInfoSize)
-        BYTE         *sealInfo;
-    UINT32            encDataSize;
-    SIZEIS(encDataSize)
-        BYTE         *encData;
-} TPM_STORED_DATA12;
-
-typedef struct tdTPM_SEALED_DATA                            /* 1.1b */
-{ 
-    TPM_PAYLOAD_TYPE  payload;
-    TPM_SECRET        authData;
-    TPM_NONCE         tpmProof;
-    TPM_DIGEST        storedDigest;
-    UINT32            dataSize;
-    SIZEIS(dataSize)
-        BYTE         *data;
-} TPM_SEALED_DATA;
-
-typedef struct tdTPM_SYMMETRIC_KEY                          /* 1.1b */
-{
-    TPM_ALGORITHM_ID  algId;
-    TPM_ENC_SCHEME    encScheme;
-    UINT16            size;
-    SIZEIS(size)
-        BYTE         *data;
-} TPM_SYMMETRIC_KEY;
-
-typedef struct tdTPM_BOUND_DATA
-{
-    TPM_STRUCT_VER   ver;
-    TPM_PAYLOAD_TYPE payload;
-    BYTE            *payloadData; // length is implied
-} TPM_BOUND_DATA;
-
-
-//-------------------------------------------------------------------
-// Part 2, section 10: TPM_KEY complex
-
-typedef struct tdTPM_KEY_PARMS                              /* 1.1b */
-{
-    TPM_ALGORITHM_ID  algorithmID;
-    TPM_ENC_SCHEME    encScheme;
-    TPM_SIG_SCHEME    sigScheme;
-    UINT32            parmSize;
-    SIZEIS(parmSize)
-        BYTE         *parms;
-} TPM_KEY_PARMS;
-
-typedef struct tdTPM_RSA_KEY_PARMS                          /* 1.1b */
-{  
-    UINT32    keyLength; 
-    UINT32    numPrimes; 
-    UINT32    exponentSize;
-    SIZEIS(exponentSize)
-        BYTE *exponent;
-} TPM_RSA_KEY_PARMS;
-
-typedef struct tdTPM_SYMMETRIC_KEY_PARMS
-{
-    UINT32 keyLength;
-    UINT32 blockSize;
-    UINT32 ivSize;
-    SIZEIS(ivSize)
-        BYTE *IV;
-} TPM_SYMMETRIC_KEY_PARMS;
-
-typedef struct tdTPM_STORE_PUBKEY                           /* 1.1b */
-{
-    UINT32    keyLength;
-    SIZEIS(keyLength)
-        BYTE *key;
-} TPM_STORE_PUBKEY;
-
-typedef struct tdTPM_PUBKEY                                 /* 1.1b */
-{
-    TPM_KEY_PARMS     algorithmParms;
-    TPM_STORE_PUBKEY  pubKey;
-} TPM_PUBKEY;
-
-typedef struct tdTPM_STORE_PRIVKEY                          /* 1.1b */
-{
-    UINT32    keyLength;
-    SIZEIS(keyLength)
-        BYTE *key;   
-} TPM_STORE_PRIVKEY;
-
-typedef struct tdTPM_STORE_ASYMKEY                          /* 1.1b */
-{         
-    TPM_PAYLOAD_TYPE  payload;   
-    TPM_SECRET        usageAuth;    
-    TPM_SECRET        migrationAuth;  
-    TPM_DIGEST        pubDataDigest;   
-    TPM_STORE_PRIVKEY privKey;   
-} TPM_STORE_ASYMKEY;
-
-typedef struct tdTPM_KEY                                    /* 1.1b */
-{
-    TPM_STRUCT_VER      ver;
-    TPM_KEY_USAGE       keyUsage;
-    TPM_KEY_FLAGS       keyFlags;
-    TPM_AUTH_DATA_USAGE authDataUsage;
-    TPM_KEY_PARMS       algorithmParms; 
-    UINT32              PCRInfoSize;
-    SIZEIS(PCRInfoSize)
-        BYTE           *PCRInfo;
-    TPM_STORE_PUBKEY    pubKey;
-    UINT32              encSize;
-    SIZEIS(encSize)
-        BYTE           *encData; 
-} TPM_KEY;
-
-typedef struct tdTPM_KEY12
-{
-    TPM_STRUCTURE_TAG   tag;
-    UINT16              fill;
-    TPM_KEY_USAGE       keyUsage;
-    TPM_KEY_FLAGS       keyFlags;
-    TPM_AUTH_DATA_USAGE authDataUsage;
-    TPM_KEY_PARMS       algorithmParms;
-    UINT32              PCRInfoSize;
-    SIZEIS(PCRInfoSize)
-       BYTE            *PCRInfo;
-    TPM_STORE_PUBKEY    pubKey;
-    UINT32              encSize;
-    SIZEIS(encSize)
-       BYTE            *encData;
-} TPM_KEY12;
-
-typedef struct tdTPM_MIGRATE_ASYMKEY
-{
-    TPM_PAYLOAD_TYPE payload;
-    TPM_SECRET       usageAuth;
-    TPM_DIGEST       pubDataDigest;
-    UINT32           partPrivKeyLen;
-    SIZEIS(partPrivKeyLen)
-        BYTE        *partPrivKey;
-} TPM_MIGRATE_ASYMKEY;
-
-
-typedef UINT32 TPM_KEY_CONTROL;
-#define TPM_KEY_CONTROL_OWNER_EVICT    ((UINT32)0x00000001)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 5.12: TPM_MIGRATIONKEYAUTH
-
-typedef struct tdTPM_MIGRATIONKEYAUTH                       /* 1.1b */
-{
-    TPM_PUBKEY         migrationKey;
-    TPM_MIGRATE_SCHEME migrationScheme;
-    TPM_DIGEST         digest;
-} TPM_MIGRATIONKEYAUTH;
-
-
-//-------------------------------------------------------------------
-// Part 2, section 11: Signed Structures
-
-typedef struct tdTPM_CERTIFY_INFO                           /* 1.1b */
-{
-    TPM_STRUCT_VER      version;
-    TPM_KEY_USAGE       keyUsage;
-    TPM_KEY_FLAGS       keyFlags;
-    TPM_AUTH_DATA_USAGE authDataUsage;
-    TPM_KEY_PARMS       algorithmParms;
-    TPM_DIGEST          pubkeyDigest;
-    TPM_NONCE           data;
-    TPM_BOOL            parentPCRStatus;
-    UINT32              PCRInfoSize;
-    SIZEIS(PCRInfoSize)
-        BYTE           *PCRInfo;
-} TPM_CERTIFY_INFO;
-
-typedef struct tdTPM_CERTIFY_INFO2
-{
-    TPM_STRUCTURE_TAG   tag;
-    BYTE                fill;
-    TPM_PAYLOAD_TYPE    payloadType;
-    TPM_KEY_USAGE       keyUsage;
-    TPM_KEY_FLAGS       keyFlags;
-    TPM_AUTH_DATA_USAGE authDataUsage;
-    TPM_KEY_PARMS       algorithmParms;
-    TPM_DIGEST          pubkeyDigest;
-    TPM_NONCE           data;
-    TPM_BOOL            parentPCRStatus;
-    UINT32              PCRInfoSize;
-    SIZEIS(PCRInfoSize) 
-        BYTE           *PCRInfo;
-    UINT32              migrationAuthoritySize;
-    SIZEIS(migrationAuthoritySize)
-        BYTE           *migrationAuthority;
-} TPM_CERTIFY_INFO2;
-
-typedef struct tdTPM_QUOTE_INFO                             /* 1.1b */
-{
-    TPM_STRUCT_VER     version;
-    BYTE               fixed[4];
-    TPM_COMPOSITE_HASH compositeHash; /* in 1.2 TPM spec, named digestValue */
-    TPM_NONCE          externalData;
-} TPM_QUOTE_INFO;
-
-typedef struct tdTPM_QUOTE_INFO2
-{
-    TPM_STRUCTURE_TAG  tag;
-    BYTE               fixed[4];
-    TPM_NONCE          externalData;
-    TPM_PCR_INFO_SHORT infoShort;
-} TPM_QUOTE_INFO2;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 12: Identity Structures
-
-
-typedef struct tdTPM_EK_BLOB
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_EK_TYPE       ekType;
-    UINT32            blobSize;
-    SIZEIS(blobSize)
-        BYTE         *blob;
-} TPM_EK_BLOB;
-
-typedef struct tdTPM_EK_BLOB_ACTIVATE
-{
-    TPM_STRUCTURE_TAG  tag;
-    TPM_SYMMETRIC_KEY  sessionKey;
-    TPM_DIGEST         idDigest;
-    TPM_PCR_INFO_SHORT pcrInfo;
-} TPM_EK_BLOB_ACTIVATE;
-
-typedef struct tdTPM_EK_BLOB_AUTH
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_SECRET        authValue;
-} TPM_EK_BLOB_AUTH;
-
-
-typedef struct tdTPM_IDENTITY_CONTENTS
-{
-    TPM_STRUCT_VER    ver;
-    UINT32            ordinal;
-    TPM_CHOSENID_HASH labelPrivCADigest;
-    TPM_PUBKEY        identityPubKey;
-} TPM_IDENTITY_CONTENTS;
-
-typedef struct tdTPM_IDENTITY_REQ                           /* 1.1b */
-{
-    UINT32         asymSize;
-    UINT32         symSize;
-    TPM_KEY_PARMS  asymAlgorithm;
-    TPM_KEY_PARMS  symAlgorithm;
-    SIZEIS(asymSize)
-        BYTE      *asymBlob;
-    SIZEIS(symSize)
-        BYTE      *symBlob;
-} TPM_IDENTITY_REQ;
-
-typedef struct tdTPM_IDENTITY_PROOF                         /* 1.1b */
-{
-    TPM_STRUCT_VER  ver;
-    UINT32          labelSize;
-    UINT32          identityBindingSize;
-    UINT32          endorsementSize;
-    UINT32          platformSize;
-    UINT32          conformanceSize;
-    TPM_PUBKEY      identityKey;
-    SIZEIS(labelSize)
-      BYTE         *labelArea;
-    SIZEIS(identityBindingSize)
-      BYTE         *identityBinding;
-    SIZEIS(endorsementSize)
-      BYTE         *endorsementCredential;
-    SIZEIS(platformSize)
-      BYTE         *platformCredential;
-    SIZEIS(conformanceSize)
-      BYTE         *conformanceCredential;
-} TPM_IDENTITY_PROOF;
-
-typedef struct tdTPM_ASYM_CA_CONTENTS                       /* 1.1b */
-{
-    TPM_SYMMETRIC_KEY sessionKey;
-    TPM_DIGEST        idDigest;
-} TPM_ASYM_CA_CONTENTS;
-
-typedef struct tdTPM_SYM_CA_ATTESTATION
-{
-    UINT32         credSize;
-    TPM_KEY_PARMS  algorithm;
-    SIZEIS(credSize)
-        BYTE      *credential;
-} TPM_SYM_CA_ATTESTATION;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 15: Tick Structures
-// Placed here out of order because definitions are used in section 13.
-
-typedef struct tdTPM_CURRENT_TICKS
-{
-    TPM_STRUCTURE_TAG tag;
-    UINT64            currentTicks;
-    UINT16            tickRate;
-    TPM_NONCE         tickNonce;
-} TPM_CURRENT_TICKS;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 13: Transport structures
-
-typedef UINT32 TPM_TRANSPORT_ATTRIBUTES;
-#define TPM_TRANSPORT_ENCRYPT          ((UINT32)0x00000001)
-#define TPM_TRANSPORT_LOG              ((UINT32)0x00000002)
-#define TPM_TRANSPORT_EXCLUSIVE        ((UINT32)0x00000004)
-
-typedef struct tdTPM_TRANSPORT_PUBLIC
-{
-    TPM_STRUCTURE_TAG        tag;
-    TPM_TRANSPORT_ATTRIBUTES transAttributes;
-    TPM_ALGORITHM_ID         algId;
-    TPM_ENC_SCHEME           encScheme;
-} TPM_TRANSPORT_PUBLIC;
-
-typedef struct tdTPM_TRANSPORT_INTERNAL
-{
-    TPM_STRUCTURE_TAG    tag;
-    TPM_AUTHDATA         authData;
-    TPM_TRANSPORT_PUBLIC transPublic;
-    TPM_TRANSHANDLE      transHandle;
-    TPM_NONCE            transNonceEven;
-    TPM_DIGEST           transDigest;
-} TPM_TRANSPORT_INTERNAL;
-
-typedef struct tdTPM_TRANSPORT_LOG_IN
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_DIGEST        parameters;
-    TPM_DIGEST        pubKeyHash;
-} TPM_TRANSPORT_LOG_IN;
-
-typedef struct tdTPM_TRANSPORT_LOG_OUT
-{
-    TPM_STRUCTURE_TAG      tag;
-    TPM_CURRENT_TICKS      currentTicks;
-    TPM_DIGEST             parameters;
-    TPM_MODIFIER_INDICATOR locality;
-} TPM_TRANSPORT_LOG_OUT;
-
-typedef struct tdTPM_TRANSPORT_AUTH
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_AUTHDATA      authData;
-} TPM_TRANSPORT_AUTH;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 14: Audit Structures
-
-typedef struct tdTPM_AUDIT_EVENT_IN
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_DIGEST        inputParms;
-    TPM_COUNTER_VALUE auditCount;
-} TPM_AUDIT_EVENT_IN;
-
-typedef struct tdTPM_AUDIT_EVENT_OUT
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_COMMAND_CODE  ordinal;
-    TPM_DIGEST        outputParms;
-    TPM_COUNTER_VALUE auditCount;
-    TPM_RESULT        returnCode;
-} TPM_AUDIT_EVENT_OUT;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 16: Return codes
-
-#include <tss/tpm_error.h>
-
-
-//-------------------------------------------------------------------
-// Part 2, section 17: Ordinals
-
-#include <tss/tpm_ordinal.h>
-
-//-------------------------------------------------------------------
-// Part 2, section 18: Context structures
-
-typedef struct tdTPM_CONTEXT_BLOB
-{
-    TPM_STRUCTURE_TAG  tag;
-    TPM_RESOURCE_TYPE  resourceType;
-    TPM_HANDLE         handle;
-    BYTE               label[16];
-    UINT32             contextCount;
-    TPM_DIGEST         integrityDigest;
-    UINT32             additionalSize;
-    SIZEIS(additionalSize)
-        BYTE          *additionalData;
-    UINT32             sensitiveSize;
-    SIZEIS(sensitiveSize)
-        BYTE          *sensitiveData;
-} TPM_CONTEXT_BLOB;
-
-typedef struct tdTPM_CONTEXT_SENSITIVE
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_NONCE         contextNonce;
-    UINT32            internalSize;
-    SIZEIS(internalSize)
-        BYTE         *internalData;
-} TPM_CONTEXT_SENSITIVE;
-
-//-------------------------------------------------------------------
-// Part 2, section 19: NV Structures
-
-typedef UINT32 TPM_NV_INDEX;
-#define TPM_NV_INDEX_LOCK              ((UINT32)0xffffffff)
-#define TPM_NV_INDEX0                  ((UINT32)0x00000000)
-#define TPM_NV_INDEX_DIR               ((UINT32)0x10000001)
-#define TPM_NV_INDEX_EKCert            ((UINT32)0x0000f000)
-#define TPM_NV_INDEX_TPM_CC            ((UINT32)0x0000f001)
-#define TPM_NV_INDEX_PlatformCert      ((UINT32)0x0000f002)
-#define TPM_NV_INDEX_Platform_CC       ((UINT32)0x0000f003)
-// The following define ranges of reserved indices.
-#define TPM_NV_INDEX_TSS_BASE          ((UINT32)0x00011100)
-#define TPM_NV_INDEX_PC_BASE           ((UINT32)0x00011200)
-#define TPM_NV_INDEX_SERVER_BASE       ((UINT32)0x00011300)
-#define TPM_NV_INDEX_MOBILE_BASE       ((UINT32)0x00011400)
-#define TPM_NV_INDEX_PERIPHERAL_BASE   ((UINT32)0x00011500)
-#define TPM_NV_INDEX_GROUP_RESV_BASE   ((UINT32)0x00010000)
-
-
-typedef UINT32 TPM_NV_PER_ATTRIBUTES;
-#define TPM_NV_PER_READ_STCLEAR        (((UINT32)1)<<31)
-#define TPM_NV_PER_AUTHREAD            (((UINT32)1)<<18)
-#define TPM_NV_PER_OWNERREAD           (((UINT32)1)<<17)
-#define TPM_NV_PER_PPREAD              (((UINT32)1)<<16)
-#define TPM_NV_PER_GLOBALLOCK          (((UINT32)1)<<15)
-#define TPM_NV_PER_WRITE_STCLEAR       (((UINT32)1)<<14)
-#define TPM_NV_PER_WRITEDEFINE         (((UINT32)1)<<13)
-#define TPM_NV_PER_WRITEALL            (((UINT32)1)<<12)
-#define TPM_NV_PER_AUTHWRITE           (((UINT32)1)<<2)
-#define TPM_NV_PER_OWNERWRITE          (((UINT32)1)<<1)
-#define TPM_NV_PER_PPWRITE             (((UINT32)1)<<0)
-
-typedef struct tdTPM_NV_ATTRIBUTES
-{
-    TPM_STRUCTURE_TAG     tag;
-    TPM_NV_PER_ATTRIBUTES attributes;
-} TPM_NV_ATTRIBUTES;
-
-
-typedef struct tdTPM_NV_DATA_PUBLIC
-{
-    TPM_STRUCTURE_TAG  tag;
-    TPM_NV_INDEX       nvIndex;
-    TPM_PCR_INFO_SHORT pcrInfoRead;
-    TPM_PCR_INFO_SHORT pcrInfoWrite;
-    TPM_NV_ATTRIBUTES  permission;
-    TPM_BOOL           bReadSTClear;
-    TPM_BOOL           bWriteSTClear;
-    TPM_BOOL           bWriteDefine;
-    UINT32             dataSize;
-} TPM_NV_DATA_PUBLIC;
-
-
-#if 0
-// Internal to TPM:
-typedef struct tdTPM_NV_DATA_SENSITIVE
-{
-    TPM_STRUCTURE_TAG  tag;
-    TPM_NV_DATA_PUBLIC pubInfo;
-    TPM_AUTHDATA       authValue;
-    SIZEIS(pubInfo.dataSize)
-        BYTE          *data;
-} TPM_NV_DATA_SENSITIVE;
-#endif
-
-
-//-------------------------------------------------------------------
-// Part 2, section 20: Delegation
-
-//-------------------------------------------------------------------
-// Part 2, section 20.3: Owner Permissions Settings for per1 bits
-#define TPM_DELEGATE_SetOrdinalAuditStatus          (((UINT32)1)<<30)
-#define TPM_DELEGATE_DirWriteAuth                   (((UINT32)1)<<29)
-#define TPM_DELEGATE_CMK_ApproveMA                  (((UINT32)1)<<28)
-#define TPM_DELEGATE_NV_WriteValue                  (((UINT32)1)<<27)
-#define TPM_DELEGATE_CMK_CreateTicket               (((UINT32)1)<<26)
-#define TPM_DELEGATE_NV_ReadValue                   (((UINT32)1)<<25)
-#define TPM_DELEGATE_Delegate_LoadOwnerDelegation   (((UINT32)1)<<24)
-#define TPM_DELEGATE_DAA_Join                       (((UINT32)1)<<23)
-#define TPM_DELEGATE_AuthorizeMigrationKey          (((UINT32)1)<<22)
-#define TPM_DELEGATE_CreateMaintenanceArchive       (((UINT32)1)<<21)
-#define TPM_DELEGATE_LoadMaintenanceArchive         (((UINT32)1)<<20)
-#define TPM_DELEGATE_KillMaintenanceFeature         (((UINT32)1)<<19)
-#define TPM_DELEGATE_OwnerReadInternalPub           (((UINT32)1)<<18)
-#define TPM_DELEGATE_ResetLockValue                 (((UINT32)1)<<17)
-#define TPM_DELEGATE_OwnerClear                     (((UINT32)1)<<16)
-#define TPM_DELEGATE_DisableOwnerClear              (((UINT32)1)<<15)
-#define TPM_DELEGATE_NV_DefineSpace                 (((UINT32)1)<<14)
-#define TPM_DELEGATE_OwnerSetDisable                (((UINT32)1)<<13)
-#define TPM_DELEGATE_SetCapability                  (((UINT32)1)<<12)
-#define TPM_DELEGATE_MakeIdentity                   (((UINT32)1)<<11)
-#define TPM_DELEGATE_ActivateIdentity               (((UINT32)1)<<10)
-#define TPM_DELEGATE_OwnerReadPubek                 (((UINT32)1)<<9)
-#define TPM_DELEGATE_DisablePubekRead               (((UINT32)1)<<8)
-#define TPM_DELEGATE_SetRedirection                 (((UINT32)1)<<7)
-#define TPM_DELEGATE_FieldUpgrade                   (((UINT32)1)<<6)
-#define TPM_DELEGATE_Delegate_UpdateVerification    (((UINT32)1)<<5)
-#define TPM_DELEGATE_CreateCounter                  (((UINT32)1)<<4)
-#define TPM_DELEGATE_ReleaseCounterOwner            (((UINT32)1)<<3)
-#define TPM_DELEGATE_DelegateManage                 (((UINT32)1)<<2)
-#define TPM_DELEGATE_Delegate_CreateOwnerDelegation (((UINT32)1)<<1)
-#define TPM_DELEGATE_DAA_Sign                       (((UINT32)1)<<0)
-
-//-------------------------------------------------------------------
-// Part 2, section 20.3: Key Permissions Settings for per1 bits
-#define TPM_KEY_DELEGATE_CMK_ConvertMigration       (((UINT32)1)<<28)
-#define TPM_KEY_DELEGATE_TickStampBlob              (((UINT32)1)<<27)
-#define TPM_KEY_DELEGATE_ChangeAuthAsymStart        (((UINT32)1)<<26)
-#define TPM_KEY_DELEGATE_ChangeAuthAsymFinish       (((UINT32)1)<<25)
-#define TPM_KEY_DELEGATE_CMK_CreateKey              (((UINT32)1)<<24)
-#define TPM_KEY_DELEGATE_MigrateKey                 (((UINT32)1)<<23)
-#define TPM_KEY_DELEGATE_LoadKey2                   (((UINT32)1)<<22)
-#define TPM_KEY_DELEGATE_EstablishTransport         (((UINT32)1)<<21)
-#define TPM_KEY_DELEGATE_ReleaseTransportSigned     (((UINT32)1)<<20)
-#define TPM_KEY_DELEGATE_Quote2                     (((UINT32)1)<<19)
-#define TPM_KEY_DELEGATE_Sealx                      (((UINT32)1)<<18)
-#define TPM_KEY_DELEGATE_MakeIdentity               (((UINT32)1)<<17)
-#define TPM_KEY_DELEGATE_ActivateIdentity           (((UINT32)1)<<16)
-#define TPM_KEY_DELEGATE_GetAuditDigestSigned       (((UINT32)1)<<15)
-#define TPM_KEY_DELEGATE_Sign                       (((UINT32)1)<<14)
-#define TPM_KEY_DELEGATE_CertifyKey2                (((UINT32)1)<<13)
-#define TPM_KEY_DELEGATE_CertifyKey                 (((UINT32)1)<<12)
-#define TPM_KEY_DELEGATE_CreateWrapKey              (((UINT32)1)<<11)
-#define TPM_KEY_DELEGATE_CMK_CreateBlob             (((UINT32)1)<<10)
-#define TPM_KEY_DELEGATE_CreateMigrationBlob        (((UINT32)1)<<9)
-#define TPM_KEY_DELEGATE_ConvertMigrationBlob       (((UINT32)1)<<8)
-#define TPM_KEY_DELEGATE_CreateKeyDelegation        (((UINT32)1)<<7)
-#define TPM_KEY_DELEGATE_ChangeAuth                 (((UINT32)1)<<6)
-#define TPM_KEY_DELEGATE_GetPubKey                  (((UINT32)1)<<5)
-#define TPM_KEY_DELEGATE_UnBind                     (((UINT32)1)<<4)
-#define TPM_KEY_DELEGATE_Quote                      (((UINT32)1)<<3)
-#define TPM_KEY_DELEGATE_Unseal                     (((UINT32)1)<<2)
-#define TPM_KEY_DELEGATE_Seal                       (((UINT32)1)<<1)
-#define TPM_KEY_DELEGATE_LoadKey                    (((UINT32)1)<<0)
-
-typedef UINT32 TPM_FAMILY_VERIFICATION;
-
-typedef UINT32 TPM_FAMILY_ID;
-
-typedef UINT32 TPM_DELEGATE_INDEX;
-
-typedef UINT32 TPM_FAMILY_OPERATION;
-#define TPM_FAMILY_CREATE              ((UINT32)0x00000001)
-#define TPM_FAMILY_ENABLE              ((UINT32)0x00000002)
-#define TPM_FAMILY_ADMIN               ((UINT32)0x00000003)
-#define TPM_FAMILY_INVALIDATE          ((UINT32)0x00000004)
-
-typedef UINT32 TPM_FAMILY_FLAGS;
-#define TPM_FAMFLAG_DELEGATE_ADMIN_LOCK   (((UINT32)1)<<1)
-#define TPM_FAMFLAG_ENABLE                (((UINT32)1)<<0)
-
-typedef struct tdTPM_FAMILY_LABEL
-{
-    BYTE label;
-} TPM_FAMILY_LABEL;
-
-typedef struct tdTPM_FAMILY_TABLE_ENTRY
-{
-    TPM_STRUCTURE_TAG       tag;
-    TPM_FAMILY_LABEL        label;
-    TPM_FAMILY_ID           familyID;
-    TPM_FAMILY_VERIFICATION verificationCount;
-    TPM_FAMILY_FLAGS        flags;
-} TPM_FAMILY_TABLE_ENTRY;
-
-
-#define TPM_FAMILY_TABLE_ENTRY_MIN 8
-//typedef struct tdTPM_FAMILY_TABLE
-//{
-//    TPM_FAMILY_TABLE_ENTRY FamTableRow[TPM_NUM_FAMILY_TABLE_ENTRY_MIN];
-//} TPM_FAMILY_TABLE;
-
-
-typedef struct tdTPM_DELEGATE_LABEL
-{
-    BYTE label;
-} TPM_DELEGATE_LABEL;
-
-
-typedef UINT32 TPM_DELEGATE_TYPE;
-#define TPM_DEL_OWNER_BITS             ((UINT32)0x00000001)
-#define TPM_DEL_KEY_BITS               ((UINT32)0x00000002)
-
-typedef struct tdTPM_DELEGATIONS
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_DELEGATE_TYPE delegateType;
-    UINT32            per1;
-    UINT32            per2;
-} TPM_DELEGATIONS;
-
-typedef struct tdTPM_DELEGATE_PUBLIC
-{
-    TPM_STRUCTURE_TAG       tag;
-    TPM_DELEGATE_LABEL      label;
-    TPM_PCR_INFO_SHORT      pcrInfo;
-    TPM_DELEGATIONS         permissions;
-    TPM_FAMILY_ID           familyID;
-    TPM_FAMILY_VERIFICATION verificationCount;
-} TPM_DELEGATE_PUBLIC;
-
-typedef struct tdTPM_DELEGATE_TABLE_ROW
-{
-    TPM_STRUCTURE_TAG   tag;
-    TPM_DELEGATE_PUBLIC pub;
-    TPM_SECRET          authValue;
-} TPM_DELEGATE_TABLE_ROW;
-
-
-#define TPM_NUM_DELEGATE_TABLE_ENTRY_MIN 2
-//typedef struct tdTPM_DELEGATE_TABLE
-//{
-//    TPM_DELEGATE_TABLE_ROW delRow[TPM_NUM_DELEGATE_TABLE_ENTRY_MIN];
-//} TPM_DELEGATE_TABLE;
-
-typedef struct tdTPM_DELEGATE_SENSITIVE
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_SECRET        authValue;
-} TPM_DELEGATE_SENSITIVE;
-
-typedef struct tdTPM_DELEGATE_OWNER_BLOB
-{
-    TPM_STRUCTURE_TAG   tag;
-    TPM_DELEGATE_PUBLIC pub;
-    TPM_DIGEST          integrityDigest;
-    UINT32              additionalSize;
-    SIZEIS(additionalSize)
-        BYTE           *additionalArea;
-    UINT32              sensitiveSize;
-    SIZEIS(sensitiveSize)
-        BYTE           *sensitiveArea;
-} TPM_DELEGATE_OWNER_BLOB;
-
-typedef struct tdTPM_DELEGATE_KEY_BLOB
-{
-    TPM_STRUCTURE_TAG   tag;
-    TPM_DELEGATE_PUBLIC pub;
-    TPM_DIGEST          integrityDigest;
-    TPM_DIGEST          pubKeyDigest;
-    UINT32              additionalSize;
-    SIZEIS(additionalSize)
-        BYTE           *additionalArea;
-    UINT32              sensitiveSize;
-    SIZEIS(sensitiveSize)
-        BYTE           *sensitiveArea;
-} TPM_DELEGATE_KEY_BLOB;
-
-
-//-------------------------------------------------------------------
-// Part 2, section 21.1: TPM_CAPABILITY_AREA
-
-typedef UINT32 TPM_CAPABILITY_AREA;                         /* 1.1b */
-#define TPM_CAP_ORD                    ((UINT32)0x00000001) /* 1.1b */
-#define TPM_CAP_ALG                    ((UINT32)0x00000002) /* 1.1b */
-#define TPM_CAP_PID                    ((UINT32)0x00000003) /* 1.1b */
-#define TPM_CAP_FLAG                   ((UINT32)0x00000004) /* 1.1b */
-#define TPM_CAP_PROPERTY               ((UINT32)0x00000005) /* 1.1b */
-#define TPM_CAP_VERSION                ((UINT32)0x00000006) /* 1.1b */
-#define TPM_CAP_KEY_HANDLE             ((UINT32)0x00000007) /* 1.1b */
-#define TPM_CAP_CHECK_LOADED           ((UINT32)0x00000008) /* 1.1b */
-#define TPM_CAP_SYM_MODE               ((UINT32)0x00000009)
-#define TPM_CAP_KEY_STATUS             ((UINT32)0x0000000C)
-#define TPM_CAP_NV_LIST                ((UINT32)0x0000000D)
-#define TPM_CAP_MFR                    ((UINT32)0x00000010)
-#define TPM_CAP_NV_INDEX               ((UINT32)0x00000011)
-#define TPM_CAP_TRANS_ALG              ((UINT32)0x00000012)
-#define TPM_CAP_HANDLE                 ((UINT32)0x00000014)
-#define TPM_CAP_TRANS_ES               ((UINT32)0x00000015)
-#define TPM_CAP_AUTH_ENCRYPT           ((UINT32)0x00000017)
-#define TPM_CAP_SELECT_SIZE            ((UINT32)0x00000018)
-#define TPM_CAP_DA_LOGIC               ((UINT32)0x00000019)
-#define TPM_CAP_VERSION_VAL            ((UINT32)0x0000001A)
-
-// Part 2, section 21.1: Subcap values for CAP_FLAG
-#define TPM_CAP_FLAG_PERMANENT         ((UINT32)0x00000108)
-#define TPM_CAP_FLAG_VOLATILE          ((UINT32)0x00000109)
-
-//-------------------------------------------------------------------
-// Part 2, section 21.2: Subcap values for CAP_PROPERTY
-
-#define TPM_CAP_PROP_PCR               ((UINT32)0x00000101) /* 1.1b */
-#define TPM_CAP_PROP_DIR               ((UINT32)0x00000102) /* 1.1b */
-#define TPM_CAP_PROP_MANUFACTURER      ((UINT32)0x00000103) /* 1.1b */
-#define TPM_CAP_PROP_KEYS              ((UINT32)0x00000104)
-#define TPM_CAP_PROP_SLOTS             (TPM_CAP_PROP_KEYS)
-#define TPM_CAP_PROP_MIN_COUNTER       ((UINT32)0x00000107)
-#define TPM_CAP_PROP_AUTHSESS          ((UINT32)0x0000010A)
-#define TPM_CAP_PROP_TRANSSESS         ((UINT32)0x0000010B)
-#define TPM_CAP_PROP_COUNTERS          ((UINT32)0x0000010C)
-#define TPM_CAP_PROP_MAX_AUTHSESS      ((UINT32)0x0000010D)
-#define TPM_CAP_PROP_MAX_TRANSSESS     ((UINT32)0x0000010E)
-#define TPM_CAP_PROP_MAX_COUNTERS      ((UINT32)0x0000010F)
-#define TPM_CAP_PROP_MAX_KEYS          ((UINT32)0x00000110)
-#define TPM_CAP_PROP_OWNER             ((UINT32)0x00000111)
-#define TPM_CAP_PROP_CONTEXT           ((UINT32)0x00000112)
-#define TPM_CAP_PROP_MAX_CONTEXT       ((UINT32)0x00000113)
-#define TPM_CAP_PROP_FAMILYROWS        ((UINT32)0x00000114)
-#define TPM_CAP_PROP_TIS_TIMEOUT       ((UINT32)0x00000115)
-#define TPM_CAP_PROP_STARTUP_EFFECT    ((UINT32)0x00000116)
-#define TPM_CAP_PROP_DELEGATE_ROW      ((UINT32)0x00000117)
-#define TPM_CAP_PROP_MAX_DAASESS       ((UINT32)0x00000119)
-#define TPM_CAP_PROP_DAA_MAX           TPM_CAP_PROP_MAX_DAASESS
-#define TPM_CAP_PROP_DAASESS           ((UINT32)0x0000011A)
-#define TPM_CAP_PROP_SESSION_DAA       TPM_CAP_PROP_DAASESS
-#define TPM_CAP_PROP_CONTEXT_DIST      ((UINT32)0x0000011B)
-#define TPM_CAP_PROP_DAA_INTERRUPT     ((UINT32)0x0000011C)
-#define TPM_CAP_PROP_SESSIONS          ((UINT32)0x0000011D)
-#define TPM_CAP_PROP_MAX_SESSIONS      ((UINT32)0x0000011E)
-#define TPM_CAP_PROP_CMK_RESTRICTION   ((UINT32)0x0000011F)
-#define TPM_CAP_PROP_DURATION          ((UINT32)0x00000120)
-#define TPM_CAP_PROP_ACTIVE_COUNTER    ((UINT32)0x00000122)
-#define TPM_CAP_PROP_NV_AVAILABLE      ((UINT32)0x00000123)
-#define TPM_CAP_PROP_INPUT_BUFFER      ((UINT32)0x00000124)
-
-
-// Part 2, section 21.4: SetCapability Values
-#define TPM_SET_PERM_FLAGS             ((UINT32)0x00000001)
-#define TPM_SET_PERM_DATA              ((UINT32)0x00000002)
-#define TPM_SET_STCLEAR_FLAGS          ((UINT32)0x00000003)
-#define TPM_SET_STCLEAR_DATA           ((UINT32)0x00000004)
-#define TPM_SET_STANY_FLAGS            ((UINT32)0x00000005)
-#define TPM_SET_STANY_DATA             ((UINT32)0x00000006)
-#define TPM_SET_VENDOR                 ((UINT32)0x00000007)
-
-
-// Part 2, section 21.6: TPM_CAP_VERSION_INFO
-typedef struct tdTPM_CAP_VERSION_INFO
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_VERSION       version;
-    UINT16            specLevel;
-    BYTE              errataRev;
-    BYTE              tpmVendorID[4];
-    UINT16            vendorSpecificSize;
-    SIZEIS(vendorSpecificSize)
-        BYTE         *vendorSpecific;
-} TPM_CAP_VERSION_INFO;
-
-
-// Part 2, section 21.9: TPM_DA_STATE
-// out of order to make it available for structure definitions
-typedef BYTE TPM_DA_STATE;
-#define TPM_DA_STATE_INACTIVE          (0x00)
-#define TPM_DA_STATE_ACTIVE            (0x01)
-
-// Part 2, section 21.10: TPM_DA_ACTION_TYPE
-typedef struct tdTPM_DA_ACTION_TYPE
-{
-    TPM_STRUCTURE_TAG tag;
-    UINT32            actions;
-} TPM_DA_ACTION_TYPE;
-#define TPM_DA_ACTION_TIMEOUT          ((UINT32)0x00000001)
-#define TPM_DA_ACTION_DISABLE          ((UINT32)0x00000002)
-#define TPM_DA_ACTION_DEACTIVATE       ((UINT32)0x00000004)
-#define TPM_DA_ACTION_FAILURE_MODE     ((UINT32)0x00000008)
-
-// Part 2, section 21.7: TPM_DA_INFO
-typedef struct tdTPM_DA_INFO
-{
-    TPM_STRUCTURE_TAG  tag;
-    TPM_DA_STATE       state;
-    UINT16             currentCount;
-    UINT16             threshholdCount;
-    TPM_DA_ACTION_TYPE actionAtThreshold;
-    UINT32             actionDependValue;
-    UINT32             vendorDataSize;
-    SIZEIS(vendorDataSize)
-        BYTE          *vendorData;
-} TPM_DA_INFO;
-
-// Part 2, section 21.8: TPM_DA_INFO_LIMITED
-typedef struct tdTPM_DA_INFO_LIMITED
-{
-    TPM_STRUCTURE_TAG  tag;
-    TPM_DA_STATE       state;
-    TPM_DA_ACTION_TYPE actionAtThreshold;
-    UINT32             vendorDataSize;
-    SIZEIS(vendorDataSize)
-        BYTE          *vendorData;
-} TPM_DA_INFO_LIMITED;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 22: DAA Structures
-
-#define TPM_DAA_SIZE_r0                (43)
-#define TPM_DAA_SIZE_r1                (43)
-#define TPM_DAA_SIZE_r2                (128)
-#define TPM_DAA_SIZE_r3                (168)
-#define TPM_DAA_SIZE_r4                (219)
-#define TPM_DAA_SIZE_NT                (20)
-#define TPM_DAA_SIZE_v0                (128)
-#define TPM_DAA_SIZE_v1                (192)
-#define TPM_DAA_SIZE_NE                (256)
-#define TPM_DAA_SIZE_w                 (256)
-#define TPM_DAA_SIZE_issuerModulus     (256)
-#define TPM_DAA_power0                 (104)
-#define TPM_DAA_power1                 (1024)
-
-typedef struct tdTPM_DAA_ISSUER
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_DIGEST        DAA_digest_R0;
-    TPM_DIGEST        DAA_digest_R1;
-    TPM_DIGEST        DAA_digest_S0;
-    TPM_DIGEST        DAA_digest_S1;
-    TPM_DIGEST        DAA_digest_n;
-    TPM_DIGEST        DAA_digest_gamma;
-    BYTE              DAA_generic_q[26];
-} TPM_DAA_ISSUER;
-
-
-typedef struct tdTPM_DAA_TPM
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_DIGEST        DAA_digestIssuer;
-    TPM_DIGEST        DAA_digest_v0;
-    TPM_DIGEST        DAA_digest_v1;
-    TPM_DIGEST        DAA_rekey;
-    UINT32            DAA_count;
-} TPM_DAA_TPM;
-
-typedef struct tdTPM_DAA_CONTEXT
-{
-    TPM_STRUCTURE_TAG    tag;
-    TPM_DIGEST           DAA_digestContext;
-    TPM_DIGEST           DAA_digest;
-    TPM_DAA_CONTEXT_SEED DAA_contextSeed;
-    BYTE                 DAA_scratch[256];
-    BYTE                 DAA_stage;
-} TPM_DAA_CONTEXT;
-
-typedef struct tdTPM_DAA_JOINDATA
-{
-    BYTE       DAA_join_u0[128];
-    BYTE       DAA_join_u1[138];
-    TPM_DIGEST DAA_digest_n0;
-} TPM_DAA_JOINDATA;
-
-typedef struct tdTPM_DAA_BLOB
-{
-    TPM_STRUCTURE_TAG tag;
-    TPM_RESOURCE_TYPE resourceType;
-    BYTE              label[16];
-    TPM_DIGEST        blobIntegrity;
-    UINT32            additionalSize;
-    SIZEIS(additionalSize)
-        BYTE         *additionalData;
-    UINT32            sensitiveSize;
-    SIZEIS(sensitiveSize)
-        BYTE         *sensitiveData;
-} TPM_DAA_BLOB;
-
-typedef struct tdTPM_DAA_SENSITIVE
-{
-    TPM_STRUCTURE_TAG tag;
-    UINT32            internalSize;
-    SIZEIS(internalSize)
-        BYTE         *internalData;
-} TPM_DAA_SENSITIVE;
-
-
-
-//-------------------------------------------------------------------
-// Part 2, section 23: Redirection
-
-// This section of the TPM spec defines exactly one value but does not
-// give it a name. The definition of TPM_SetRedirection in Part3
-// refers to exactly one name but does not give its value. We join
-// them here.
-#define TPM_REDIR_GPIO              (0x00000001)
-
-
-//-------------------------------------------------------------------
-// Part 2, section 24.6: TPM_SYM_MODE
-//    Deprecated by TPM 1.2 spec
-
-typedef UINT32 TPM_SYM_MODE;
-#define TPM_SYM_MODE_ECB            (0x00000001)
-#define TPM_SYM_MODE_CBC            (0x00000002)
-#define TPM_SYM_MODE_CFB            (0x00000003)
-
-#endif // __TPM_H__
-
+/*++
+ * 
+ * TPM structures extracted from the TPM specification 1.2, 
+ * Part 2 (Structures), rev 85.
+ *
+ * Errata:
+ *
+ * *) The individual bits of TPM_STARTUP_EFFECTS were not given names in
+ * the TPM spec so they are not defined in tpm.h.
+ * 
+ * *) A few typedefs not present in the TPM 1.2 specification have been
+ * added. This was generally done when the TPM 1.2 spec defined a set of
+ * related values (either bitmasks or enumeration values) but did not
+ * define an associated type to hold these values. The typedefs have been
+ * added and structure fields that were to hold those values have been
+ * switched from generic UINT* types to the more specific types. This was
+ * done to highlight exactly where those #defined values were to be used.
+ * The types that have been added are:
+ *   TPM_NV_PER_ATTRIBUTES
+ *   TPM_DELEGATE_TYPE
+ *
+ * *) The layout of bitfields within a structure are compiler-dependent
+ * and the use of structure bitfields has been avoided where possible. In
+ * cases where a value is a collection of independent bits the type is
+ * given a name (typedeffed to UINT16 or UINT32 as appropriate) and masks
+ * are #defined to access the individual bits. This is not possible for
+ * TPM_VERSION_BYTE because the fields are 4-bit values. A best attempt
+ * has been made to make this compiler independent but it has only been
+ * checked on GCC and Visual C++ on little-endian machines.
+ * 
+ * *) The TPM_DELEGATIONS per1 and per2 fields field are a bitmask but
+ * are defined as a UINT32 because the bitfields have different meaning
+ * based on the type of delegation blob.
+ * 
+ * *) The definitions of TPM_PERMANENT_DATA, TPM_STCLEAR_DATA,
+ * TPM_STANY_DATA, and TPM_DELEGATE_TABLE_ROW are commented out. These
+ * structures are internal to the TPM and are not directly accessible by
+ * external software so this should not be a problem.
+ * 
+ * *) The definitions of TPM_FAMILY_TABLE and TPM_DELEGATE_TABLE are
+ * commented out because they are variable length arrays internal to the
+ * TPM. As above they are not directly accessible by external software
+ * so this should not be a problem.
+ */
+
+#ifndef __TPM_H__
+#define __TPM_H__
+
+#ifdef __midl
+#define SIZEIS(x)  [size_is(x)]
+#else
+#define SIZEIS(x)
+#endif
+
+#include <tss/platform.h>
+
+//-------------------------------------------------------------------
+// Part 2, section 2.1: Basic data types
+typedef BYTE   TPM_BOOL;
+#ifndef FALSE
+#define FALSE  0x00
+#define TRUE   0x01
+#endif /* ifndef FALSE */
+
+//-------------------------------------------------------------------
+// Part 2, section 2.3: Helper Redefinitions
+//   Many of the helper redefinitions appear later in this file
+//   so that they are declared next to the list of valid values
+//   they may hold.
+typedef BYTE TPM_LOCALITY_MODIFIER;
+typedef UINT32 TPM_COMMAND_CODE;                            /* 1.1b */
+typedef UINT32 TPM_COUNT_ID;
+typedef UINT32 TPM_REDIT_COMMAND;
+typedef UINT32 TPM_HANDLE;
+typedef UINT32 TPM_AUTHHANDLE;
+typedef UINT32 TPM_TRANSHANDLE;
+typedef UINT32 TPM_KEYHANDLE;
+typedef UINT32 TPM_DIRINDEX;
+typedef UINT32 TPM_PCRINDEX;
+typedef UINT32 TPM_RESULT;
+typedef UINT32 TPM_MODIFIER_INDICATOR;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 2.2.4: Vendor Specific
+#define TPM_Vendor_Specific32  0x00000400
+#define TPM_Vendor_Specific8   0x80
+
+
+//-------------------------------------------------------------------
+// Part 2, section 3: Structure Tags
+typedef UINT16  TPM_STRUCTURE_TAG;
+#define TPM_TAG_CONTEXTBLOB            ((UINT16)0x0001)
+#define TPM_TAG_CONTEXT_SENSITIVE      ((UINT16)0x0002)
+#define TPM_TAG_CONTEXTPOINTER         ((UINT16)0x0003)
+#define TPM_TAG_CONTEXTLIST            ((UINT16)0x0004)
+#define TPM_TAG_SIGNINFO               ((UINT16)0x0005)
+#define TPM_TAG_PCR_INFO_LONG          ((UINT16)0x0006)
+#define TPM_TAG_PERSISTENT_FLAGS       ((UINT16)0x0007)
+#define TPM_TAG_VOLATILE_FLAGS         ((UINT16)0x0008)
+#define TPM_TAG_PERSISTENT_DATA        ((UINT16)0x0009)
+#define TPM_TAG_VOLATILE_DATA          ((UINT16)0x000a)
+#define TPM_TAG_SV_DATA                ((UINT16)0x000b)
+#define TPM_TAG_EK_BLOB                ((UINT16)0x000c)
+#define TPM_TAG_EK_BLOB_AUTH           ((UINT16)0x000d)
+#define TPM_TAG_COUNTER_VALUE          ((UINT16)0x000e)
+#define TPM_TAG_TRANSPORT_INTERNAL     ((UINT16)0x000f)
+#define TPM_TAG_TRANSPORT_LOG_IN       ((UINT16)0x0010)
+#define TPM_TAG_TRANSPORT_LOG_OUT      ((UINT16)0x0011)
+#define TPM_TAG_AUDIT_EVENT_IN         ((UINT16)0x0012)
+#define TPM_TAG_AUDIT_EVENT_OUT        ((UINT16)0x0013)
+#define TPM_TAG_CURRENT_TICKS          ((UINT16)0x0014)
+#define TPM_TAG_KEY                    ((UINT16)0x0015)
+#define TPM_TAG_STORED_DATA12          ((UINT16)0x0016)
+#define TPM_TAG_NV_ATTRIBUTES          ((UINT16)0x0017)
+#define TPM_TAG_NV_DATA_PUBLIC         ((UINT16)0x0018)
+#define TPM_TAG_NV_DATA_SENSITIVE      ((UINT16)0x0019)
+#define TPM_TAG_DELEGATIONS            ((UINT16)0x001a)
+#define TPM_TAG_DELEGATE_PUBLIC        ((UINT16)0x001b)
+#define TPM_TAG_DELEGATE_TABLE_ROW     ((UINT16)0x001c)
+#define TPM_TAG_TRANSPORT_AUTH         ((UINT16)0x001d)
+#define TPM_TAG_TRANSPORT_PUBLIC       ((UINT16)0x001e)
+#define TPM_TAG_PERMANENT_FLAGS        ((UINT16)0x001f)
+#define TPM_TAG_STCLEAR_FLAGS          ((UINT16)0x0020)
+#define TPM_TAG_STANY_FLAGS            ((UINT16)0x0021)
+#define TPM_TAG_PERMANENT_DATA         ((UINT16)0x0022)
+#define TPM_TAG_STCLEAR_DATA           ((UINT16)0x0023)
+#define TPM_TAG_STANY_DATA             ((UINT16)0x0024)
+#define TPM_TAG_FAMILY_TABLE_ENTRY     ((UINT16)0x0025)
+#define TPM_TAG_DELEGATE_SENSITIVE     ((UINT16)0x0026)
+#define TPM_TAG_DELG_KEY_BLOB          ((UINT16)0x0027)
+#define TPM_TAG_KEY12                  ((UINT16)0x0028)
+#define TPM_TAG_CERTIFY_INFO2          ((UINT16)0x0029)
+#define TPM_TAG_DELEGATE_OWNER_BLOB    ((UINT16)0x002a)
+#define TPM_TAG_EK_BLOB_ACTIVATE       ((UINT16)0x002b)
+#define TPM_TAG_DAA_BLOB               ((UINT16)0x002c)
+#define TPM_TAG_DAA_CONTEXT            ((UINT16)0x002d)
+#define TPM_TAG_DAA_ENFORCE            ((UINT16)0x002e)
+#define TPM_TAG_DAA_ISSUER             ((UINT16)0x002f)
+#define TPM_TAG_CAP_VERSION_INFO       ((UINT16)0x0030)
+#define TPM_TAG_DAA_SENSITIVE          ((UINT16)0x0031)
+#define TPM_TAG_DAA_TPM                ((UINT16)0x0032)
+#define TPM_TAG_CMK_MIGAUTH            ((UINT16)0x0033)
+#define TPM_TAG_CMK_SIGTICKET          ((UINT16)0x0034)
+#define TPM_TAG_CMK_MA_APPROVAL        ((UINT16)0x0035)
+#define TPM_TAG_QUOTE_INFO2            ((UINT16)0x0036)
+#define TPM_TAG_DA_INFO                ((UINT16)0x0037)
+#define TPM_TAG_DA_INFO_LIMITED        ((UINT16)0x0038)
+#define TPM_TAG_DA_ACTION_TYPE         ((UINT16)0x0039)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 4: Types
+typedef UINT32 TPM_RESOURCE_TYPE;
+#define TPM_RT_KEY                     ((UINT32)0x00000001)
+#define TPM_RT_AUTH                    ((UINT32)0x00000002)
+#define TPM_RT_HASH                    ((UINT32)0x00000003)
+#define TPM_RT_TRANS                   ((UINT32)0x00000004)
+#define TPM_RT_CONTEXT                 ((UINT32)0x00000005)
+#define TPM_RT_COUNTER                 ((UINT32)0x00000006)
+#define TPM_RT_DELEGATE                ((UINT32)0x00000007)
+#define TPM_RT_DAA_TPM                 ((UINT32)0x00000008)
+#define TPM_RT_DAA_V0                  ((UINT32)0x00000009)
+#define TPM_RT_DAA_V1                  ((UINT32)0x0000000a)
+
+
+typedef BYTE TPM_PAYLOAD_TYPE;                              /* 1.1b */
+#define TPM_PT_ASYM                    ((BYTE)0x01)         /* 1.1b */
+#define TPM_PT_BIND                    ((BYTE)0x02)         /* 1.1b */
+#define TPM_PT_MIGRATE                 ((BYTE)0x03)         /* 1.1b */
+#define TPM_PT_MAINT                   ((BYTE)0x04)         /* 1.1b */
+#define TPM_PT_SEAL                    ((BYTE)0x05)         /* 1.1b */
+#define TPM_PT_MIGRATE_RESTRICTED      ((BYTE)0x06)
+#define TPM_PT_MIGRATE_EXTERNAL        ((BYTE)0x07)
+#define TPM_PT_CMK_MIGRATE             ((BYTE)0x08)
+
+
+typedef UINT16 TPM_ENTITY_TYPE;                             /* 1.1b */
+#define TPM_ET_KEYHANDLE               ((UINT16)0x0001)     /* 1.1b */
+#define TPM_ET_OWNER                   ((UINT16)0x0002)     /* 1.1b */
+#define TPM_ET_DATA                    ((UINT16)0x0003)     /* 1.1b */
+#define TPM_ET_SRK                     ((UINT16)0x0004)     /* 1.1b */
+#define TPM_ET_KEY                     ((UINT16)0x0005)     /* 1.1b */
+#define TPM_ET_REVOKE                  ((UINT16)0x0006)
+#define TPM_ET_DEL_OWNER_BLOB          ((UINT16)0x0007)
+#define TPM_ET_DEL_ROW                 ((UINT16)0x0008)
+#define TPM_ET_DEL_KEY_BLOB            ((UINT16)0x0009)
+#define TPM_ET_COUNTER                 ((UINT16)0x000a)
+#define TPM_ET_NV                      ((UINT16)0x000b)
+#define TPM_ET_OPERATOR                ((UINT16)0x000c)
+#define TPM_ET_RESERVED_HANDLE         ((UINT16)0x0040)
+
+/* The following values may be ORed into the MSB of the TPM_ENTITY_TYPE
+ * to indicate particular encryption scheme
+ */
+#define TPM_ET_XOR                     ((BYTE)0x00)
+#define TPM_ET_AES                     ((BYTE)0x06)
+
+typedef UINT32 TPM_KEY_HANDLE;                              /* 1.1b */
+#define TPM_KH_SRK                     ((UINT32)0x40000000)
+#define TPM_KH_OWNER                   ((UINT32)0x40000001)
+#define TPM_KH_REVOKE                  ((UINT32)0x40000002)
+#define TPM_KH_TRANSPORT               ((UINT32)0x40000003)
+#define TPM_KH_OPERATOR                ((UINT32)0x40000004)
+#define TPM_KH_ADMIN                   ((UINT32)0x40000005)
+#define TPM_KH_EK                      ((UINT32)0x40000006)
+/* 1.1b used different names, but the same values */
+#define TPM_KEYHND_SRK                 (TPM_KH_SRK)        /* 1.1b */
+#define TPM_KEYHND_OWNER               (TPM_KH_OWNER)      /* 1.1b */
+
+
+typedef UINT16 TPM_STARTUP_TYPE;                            /* 1.1b */
+#define TPM_ST_CLEAR                   ((UINT16)0x0001)     /* 1.1b */
+#define TPM_ST_STATE                   ((UINT16)0x0002)     /* 1.1b */
+#define TPM_ST_DEACTIVATED             ((UINT16)0x0003)     /* 1.1b */
+
+
+//typedef UINT32 TPM_STARTUP_EFFECTS;
+// 32-bit mask, see spec for meaning. Names not currently defined.
+// bits 0-8 have meaning
+
+typedef UINT16 TPM_PROTOCOL_ID;                             /* 1.1b */
+#define TPM_PID_OIAP                   ((UINT16)0x0001)     /* 1.1b */
+#define TPM_PID_OSAP                   ((UINT16)0x0002)     /* 1.1b */
+#define TPM_PID_ADIP                   ((UINT16)0x0003)     /* 1.1b */
+#define TPM_PID_ADCP                   ((UINT16)0x0004)     /* 1.1b */
+#define TPM_PID_OWNER                  ((UINT16)0x0005)     /* 1.1b */
+#define TPM_PID_DSAP                   ((UINT16)0x0006)
+#define TPM_PID_TRANSPORT              ((UINT16)0x0007)
+
+
+// Note in 1.2 rev 104, DES and 3DES are eliminated
+typedef UINT32 TPM_ALGORITHM_ID;                            /* 1.1b */
+#define TPM_ALG_RSA                    ((UINT32)0x00000001) /* 1.1b */
+#define TPM_ALG_DES                    ((UINT32)0x00000002) /* 1.1b */
+#define TPM_ALG_3DES                   ((UINT32)0x00000003) /* 1.1b */
+#define TPM_ALG_SHA                    ((UINT32)0x00000004) /* 1.1b */
+#define TPM_ALG_HMAC                   ((UINT32)0x00000005) /* 1.1b */
+#define TPM_ALG_AES                    ((UINT32)0x00000006) /* 1.1b */
+#define TPM_ALG_AES128                 (TPM_ALG_AES)
+#define TPM_ALG_MGF1                   ((UINT32)0x00000007)
+#define TPM_ALG_AES192                 ((UINT32)0x00000008)
+#define TPM_ALG_AES256                 ((UINT32)0x00000009)
+#define TPM_ALG_XOR                    ((UINT32)0x0000000a)
+
+
+typedef UINT16 TPM_PHYSICAL_PRESENCE;                        /* 1.1b */
+#define TPM_PHYSICAL_PRESENCE_LOCK          ((UINT16)0x0004) /* 1.1b */
+#define TPM_PHYSICAL_PRESENCE_PRESENT       ((UINT16)0x0008) /* 1.1b */
+#define TPM_PHYSICAL_PRESENCE_NOTPRESENT    ((UINT16)0x0010) /* 1.1b */
+#define TPM_PHYSICAL_PRESENCE_CMD_ENABLE    ((UINT16)0x0020) /* 1.1b */
+#define TPM_PHYSICAL_PRESENCE_HW_ENABLE     ((UINT16)0x0040) /* 1.1b */
+#define TPM_PHYSICAL_PRESENCE_LIFETIME_LOCK ((UINT16)0x0080) /* 1.1b */
+#define TPM_PHYSICAL_PRESENCE_CMD_DISABLE   ((UINT16)0x0100)
+#define TPM_PHYSICAL_PRESENCE_HW_DISABLE    ((UINT16)0x0200)
+
+
+typedef UINT16 TPM_MIGRATE_SCHEME;                          /* 1.1b */
+#define TPM_MS_MIGRATE                   ((UINT16)0x0001)   /* 1.1b */
+#define TPM_MS_REWRAP                    ((UINT16)0x0002)   /* 1.1b */
+#define TPM_MS_MAINT                     ((UINT16)0x0003)   /* 1.1b */
+#define TPM_MS_RESTRICT_MIGRATE          ((UINT16)0x0004)
+#define TPM_MS_RESTRICT_APPROVE_DOUBLE   ((UINT16)0x0005)
+
+
+typedef UINT16 TPM_EK_TYPE;
+#define TPM_EK_TYPE_ACTIVATE           ((UINT16)0x0001)
+#define TPM_EK_TYPE_AUTH               ((UINT16)0x0002)
+
+
+typedef UINT16 TPM_PLATFORM_SPECIFIC;
+#define TPM_PS_PC_11                   ((UINT16)0x0001)
+#define TPM_PS_PC_12                   ((UINT16)0x0002)
+#define TPM_PS_PDA_12                  ((UINT16)0x0003)
+#define TPM_PS_Server_12               ((UINT16)0x0004)
+#define TPM_PS_Mobile_12               ((UINT16)0x0005)
+
+//-------------------------------------------------------------------
+// Part 2, section 5: Basic Structures
+
+typedef struct tdTPM_STRUCT_VER
+{
+    BYTE   major;
+    BYTE   minor;
+    BYTE   revMajor;
+    BYTE   revMinor;
+} TPM_STRUCT_VER;
+
+typedef struct tdTPM_VERSION_BYTE
+{
+    // This needs to be made compiler-independent.
+    int leastSigVer : 4; // least significant 4 bits
+    int mostSigVer  : 4; // most significant 4 bits
+} TPM_VERSION_BYTE;
+
+typedef struct tdTPM_VERSION
+{
+    BYTE   major;      // Should really be a TPM_VERSION_BYTE
+    BYTE   minor;      // Should really be a TPM_VERSION_BYTE
+    BYTE   revMajor;
+    BYTE   revMinor;
+} TPM_VERSION;
+
+
+// Put this in the right place:
+// byte size definition for 160 bit SHA1 hash value
+#define TPM_SHA1_160_HASH_LEN    0x14
+#define TPM_SHA1BASED_NONCE_LEN  TPM_SHA1_160_HASH_LEN
+
+typedef struct tdTPM_DIGEST
+{
+    BYTE  digest[TPM_SHA1_160_HASH_LEN];
+} TPM_DIGEST;
+
+typedef TPM_DIGEST TPM_CHOSENID_HASH;
+typedef TPM_DIGEST TPM_COMPOSITE_HASH;
+typedef TPM_DIGEST TPM_DIRVALUE;
+typedef TPM_DIGEST TPM_HMAC;
+typedef TPM_DIGEST TPM_PCRVALUE;
+typedef TPM_DIGEST TPM_AUDITDIGEST;
+
+typedef struct tdTPM_NONCE                                  /* 1.1b */
+{
+    BYTE  nonce[TPM_SHA1BASED_NONCE_LEN];
+} TPM_NONCE;
+
+typedef TPM_NONCE TPM_DAA_TPM_SEED;
+typedef TPM_NONCE TPM_DAA_CONTEXT_SEED;
+
+typedef struct tdTPM_AUTHDATA                               /* 1.1b */
+{
+    BYTE  authdata[TPM_SHA1_160_HASH_LEN];
+} TPM_AUTHDATA;
+
+typedef TPM_AUTHDATA TPM_SECRET;
+typedef TPM_AUTHDATA TPM_ENCAUTH;
+
+
+typedef struct tdTPM_KEY_HANDLE_LIST                        /* 1.1b */
+{
+    UINT16              loaded;
+    SIZEIS(loaded)
+        TPM_KEY_HANDLE *handle;
+} TPM_KEY_HANDLE_LIST;
+
+
+//-------------------------------------------------------------------
+// Part 2, section 5.8: Key usage values
+
+typedef UINT16 TPM_KEY_USAGE;                               /* 1.1b */
+#define TPM_KEY_SIGNING                ((UINT16)0x0010)     /* 1.1b */
+#define TPM_KEY_STORAGE                ((UINT16)0x0011)     /* 1.1b */
+#define TPM_KEY_IDENTITY               ((UINT16)0x0012)     /* 1.1b */
+#define TPM_KEY_AUTHCHANGE             ((UINT16)0x0013)     /* 1.1b */
+#define TPM_KEY_BIND                   ((UINT16)0x0014)     /* 1.1b */
+#define TPM_KEY_LEGACY                 ((UINT16)0x0015)     /* 1.1b */
+#define TPM_KEY_MIGRATE                ((UINT16)0x0016)
+
+typedef UINT16 TPM_SIG_SCHEME;                              /* 1.1b */
+#define TPM_SS_NONE                    ((UINT16)0x0001)     /* 1.1b */
+#define TPM_SS_RSASSAPKCS1v15_SHA1     ((UINT16)0x0002)     /* 1.1b */
+#define TPM_SS_RSASSAPKCS1v15_DER      ((UINT16)0x0003)     /* 1.1b */
+#define TPM_SS_RSASSAPKCS1v15_INFO     ((UINT16)0x0004)
+
+typedef UINT16 TPM_ENC_SCHEME;                              /* 1.1b */
+#define TPM_ES_NONE                    ((UINT16)0x0001)     /* 1.1b */
+#define TPM_ES_RSAESPKCSv15            ((UINT16)0x0002)     /* 1.1b */
+#define TPM_ES_RSAESOAEP_SHA1_MGF1     ((UINT16)0x0003)     /* 1.1b */
+#define TPM_ES_SYM_CNT                 ((UINT16)0x0004)
+#define TPM_ES_SYM_CTR                 TPM_ES_SYM_CNT
+#define TPM_ES_SYM_OFB                 ((UINT16)0x0005)
+#define TPM_ES_SYM_CBC_PKCS5PAD        ((UINT16)0x00ff)
+
+//-------------------------------------------------------------------
+// Part 2, section 5.9: TPM_AUTH_DATA_USAGE values
+
+typedef BYTE TPM_AUTH_DATA_USAGE;                           /* 1.1b */
+#define TPM_AUTH_NEVER                 ((BYTE)0x00)         /* 1.1b */
+#define TPM_AUTH_ALWAYS                ((BYTE)0x01)         /* 1.1b */
+#define TPM_AUTH_PRIV_USE_ONLY         ((BYTE)0x11)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 5.10: TPM_KEY_FLAGS flags
+
+typedef UINT32 TPM_KEY_FLAGS;                               /* 1.1b */
+#define TPM_REDIRECTION                ((UINT32)0x00000001) /* 1.1b */
+#define TPM_MIGRATABLE                 ((UINT32)0x00000002) /* 1.1b */
+#define TPM_VOLATILE                   ((UINT32)0x00000004) /* 1.1b */
+#define TPM_PCRIGNOREDONREAD           ((UINT32)0x00000008)
+#define TPM_MIGRATEAUTHORITY           ((UINT32)0x00000010)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 5.11: TPM_CHANGEAUTH_VALIDATE
+
+typedef struct tdTPM_CHANGEAUTH_VALIDATE
+{
+    TPM_SECRET newAuthSecret;
+    TPM_NONCE  n1;
+} TPM_CHANGEAUTH_VALIDATE;
+
+//-------------------------------------------------------------------
+// Part 2, section 5.12: TPM_MIGRATIONKEYAUTH
+// declared after section 10 to catch declaration of TPM_PUBKEY 
+
+//-------------------------------------------------------------------
+// Part 2, section 5.13: TPM_COUNTER_VALUE;
+
+typedef UINT32 TPM_ACTUAL_COUNT;
+typedef struct tdTPM_COUNTER_VALUE
+{
+    TPM_STRUCTURE_TAG tag;
+    BYTE              label[4];
+    TPM_ACTUAL_COUNT  counter;
+} TPM_COUNTER_VALUE;
+
+//-------------------------------------------------------------------
+// Part 2, section 5.14: TPM_SIGN_INFO structure
+
+typedef struct tdTPM_SIGN_INFO
+{
+    TPM_STRUCTURE_TAG tag;
+    BYTE              fixed[4];
+    TPM_NONCE         replay;
+    UINT32            dataLen;
+    SIZEIS(dataLen)
+        BYTE         *data;
+} TPM_SIGN_INFO;
+
+//-------------------------------------------------------------------
+// Part 2, section 5.15: TPM_MSA_COMPOSITE
+
+typedef struct tdTPM_MSA_COMPOSITE
+{
+    UINT32          MSAlist;
+    SIZEIS(MSAlist)
+        TPM_DIGEST *migAuthDigest;
+} TPM_MSA_COMPOSITE;
+
+//-------------------------------------------------------------------
+// Part 2, section 5.16: TPM_CMK_AUTH
+
+typedef struct tdTPM_CMK_AUTH
+{
+    TPM_DIGEST migrationAuthorityDigest;
+    TPM_DIGEST destinationKeyDigest;
+    TPM_DIGEST sourceKeyDigest;
+} TPM_CMK_AUTH;
+
+//-------------------------------------------------------------------
+// Part 2, section 5.17: TPM_CMK_DELEGATE
+
+typedef UINT32 TPM_CMK_DELEGATE;
+#define TPM_CMK_DELEGATE_SIGNING       (((UINT32)1)<<31)
+#define TPM_CMK_DELEGATE_STORAGE       (((UINT32)1)<<30)
+#define TPM_CMK_DELEGATE_BIND          (((UINT32)1)<<29)
+#define TPM_CMK_DELEGATE_LEGACY        (((UINT32)1)<<28)
+#define TPM_CMK_DELEGATE_MIGRATE       (((UINT32)1)<<27)
+
+//-------------------------------------------------------------------
+// Part 2, section 5.18: TPM_SELECT_SIZE
+
+typedef struct tdTPM_SELECT_SIZE
+{
+    BYTE   major;
+    BYTE   minor;
+    UINT16 reqSize;
+} TPM_SELECT_SIZE;
+
+//-------------------------------------------------------------------
+// Part 2, section 5.19: TPM_CMK_MIGAUTH
+
+typedef struct tdTPM_CMK_MIGAUTH
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_DIGEST        msaDigest;
+    TPM_DIGEST        pubKeyDigest;
+} TPM_CMK_MIGAUTH;
+
+//-------------------------------------------------------------------
+// Part 2, section 5.20: TPM_CMK_SIGTICKET
+
+typedef struct tdTPM_CMK_SIGTICKET
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_DIGEST        verKeyDigest;
+    TPM_DIGEST        signedData;
+} TPM_CMK_SIGTICKET;
+
+//-------------------------------------------------------------------
+// Part 2, section 5.21: TPM_CMK_MA_APPROVAL
+
+typedef struct tdTPM_CMK_MA_APPROVAL
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_DIGEST        migrationAuthorityDigest;
+} TPM_CMK_MA_APPROVAL;
+
+
+//-------------------------------------------------------------------
+// Part 2, section 6: Command Tags
+
+typedef UINT16 TPM_TAG;                                     /* 1.1b */
+#define TPM_TAG_RQU_COMMAND            ((UINT16)0x00c1)
+#define TPM_TAG_RQU_AUTH1_COMMAND      ((UINT16)0x00c2)
+#define TPM_TAG_RQU_AUTH2_COMMAND      ((UINT16)0x00c3)
+#define TPM_TAG_RSP_COMMAND            ((UINT16)0x00c4)
+#define TPM_TAG_RSP_AUTH1_COMMAND      ((UINT16)0x00c5)
+#define TPM_TAG_RSP_AUTH2_COMMAND      ((UINT16)0x00c6)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 7.1: TPM_PERMANENT_FLAGS
+
+typedef struct tdTPM_PERMANENT_FLAGS
+{
+    TPM_STRUCTURE_TAG tag;
+    TSS_BOOL disable;
+    TSS_BOOL ownership;
+    TSS_BOOL deactivated;
+    TSS_BOOL readPubek;
+    TSS_BOOL disableOwnerClear;
+    TSS_BOOL allowMaintenance;
+    TSS_BOOL physicalPresenceLifetimeLock;
+    TSS_BOOL physicalPresenceHWEnable;
+    TSS_BOOL physicalPresenceCMDEnable;
+    TSS_BOOL CEKPUsed;
+    TSS_BOOL TPMpost;
+    TSS_BOOL TPMpostLock;
+    TSS_BOOL FIPS;
+    TSS_BOOL Operator;
+    TSS_BOOL enableRevokeEK;
+    TSS_BOOL nvLocked;
+    TSS_BOOL readSRKPub;
+    TSS_BOOL tpmEstablished;
+    TSS_BOOL maintenanceDone;
+    TSS_BOOL disableFullDALogicInfo;
+} TPM_PERMANENT_FLAGS;
+
+#define TPM_PF_DISABLE                      ((UINT32)0x00000001)
+#define TPM_PF_OWNERSHIP                    ((UINT32)0x00000002)
+#define TPM_PF_DEACTIVATED                  ((UINT32)0x00000003)
+#define TPM_PF_READPUBEK                    ((UINT32)0x00000004)
+#define TPM_PF_DISABLEOWNERCLEAR            ((UINT32)0x00000005)
+#define TPM_PF_ALLOWMAINTENANCE             ((UINT32)0x00000006)
+#define TPM_PF_PHYSICALPRESENCELIFETIMELOCK ((UINT32)0x00000007)
+#define TPM_PF_PHYSICALPRESENCEHWENABLE     ((UINT32)0x00000008)
+#define TPM_PF_PHYSICALPRESENCECMDENABLE    ((UINT32)0x00000009)
+#define TPM_PF_CEKPUSED                     ((UINT32)0x0000000A)
+#define TPM_PF_TPMPOST                      ((UINT32)0x0000000B)
+#define TPM_PF_TPMPOSTLOCK                  ((UINT32)0x0000000C)
+#define TPM_PF_FIPS                         ((UINT32)0x0000000D)
+#define TPM_PF_OPERATOR                     ((UINT32)0x0000000E)
+#define TPM_PF_ENABLEREVOKEEK               ((UINT32)0x0000000F)
+#define TPM_PF_NV_LOCKED                    ((UINT32)0x00000010)
+#define TPM_PF_READSRKPUB                   ((UINT32)0x00000011)
+#define TPM_PF_RESETESTABLISHMENTBIT        ((UINT32)0x00000012)
+#define TPM_PF_MAINTENANCEDONE              ((UINT32)0x00000013)
+#define TPM_PF_DISABLEFULLDALOGICINFO       ((UINT32)0x00000014)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 7.2: TPM_STCLEAR_FLAGS
+
+typedef struct tdTPM_STCLEAR_FLAGS
+{
+    TPM_STRUCTURE_TAG tag;
+    TSS_BOOL          deactivated;
+    TSS_BOOL          disableForceClear;
+    TSS_BOOL          physicalPresence;
+    TSS_BOOL          physicalPresenceLock;
+    TSS_BOOL          bGlobalLock;
+} TPM_STCLEAR_FLAGS;
+
+#define TPM_SF_DEACTIVATED             ((UINT32)0x00000001)
+#define TPM_SF_DISABLEFORCECLEAR       ((UINT32)0x00000002)
+#define TPM_SF_PHYSICALPRESENCE        ((UINT32)0x00000003)
+#define TPM_SF_PHYSICALPRESENCELOCK    ((UINT32)0x00000004)
+#define TPM_SF_GLOBALLOCK              ((UINT32)0x00000005)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 7.3: TPM_STANY_FLAGS
+
+typedef struct tdTPM_STANY_FLAGS
+{
+    TPM_STRUCTURE_TAG      tag;
+    TSS_BOOL               postInitialise;
+    TPM_MODIFIER_INDICATOR localityModifier;
+    TSS_BOOL               transportExclusive;
+    TSS_BOOL               TOSPresent;
+} TPM_STANY_FLAGS;
+
+#define TPM_AF_POSTINITIALIZE          ((UINT32)0x00000001)
+#define TPM_AF_LOCALITYMODIFIER        ((UINT32)0x00000002)
+#define TPM_AF_TRANSPORTEXCLUSIVE      ((UINT32)0x00000003)
+#define TPM_AF_TOSPRESENT              ((UINT32)0x00000004)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 7.4: TPM_PERMANENT_DATA
+// available inside TPM only
+//
+//#define TPM_MIN_COUNTERS          4
+//#define TPM_NUM_PCR              16
+//#define TPM_MAX_NV_WRITE_NOOWNER 64
+//
+//typedef struct tdTPM_PERMANENT_DATA
+//{
+//    TPM_STRUCTURE_TAG  tag;
+//    BYTE               revMajor;
+//    BYTE               revMinor;
+//    TPM_NONCE          tpmProof;
+//    TPM_NONCE          ekReset;
+//    TPM_SECRET         ownerAuth;
+//    TPM_SECRET         operatorAuth;
+//    TPM_DIRVALUE       authDIR[1];
+//    TPM_PUBKEY         manuMaintPub;
+//    TPM_KEY            endorsementKey;
+//    TPM_KEY            srk;
+//    TPM_KEY            contextKey;
+//    TPM_KEY            delegateKey;
+//    TPM_COUNTER_VALUE  auditMonotonicCounter;
+//    TPM_COUNTER_VALUE  monitonicCounter[TPM_MIN_COUNTERS];
+//    TPM_PCR_ATTRIBUTES pcrAttrib[TPM_NUM_PCR];
+//    BYTE               ordinalAuditStatus[];
+//    BYTE              *rngState;
+//    TPM_FAMILY_TABLE   familyTable;
+//    TPM_DELEGATE_TABLE delegateTable;
+//    UINT32             maxNVBufSize;
+//    UINT32             lastFamilyID;
+//    UINT32             noOwnerNVWrite;
+//    TPM_CMK_DELEGATE   restrictDelegate;
+//    TPM_DAA_TPM_SEED   tpmDAASeed;
+//    TPM_NONCE          daaProof;
+//    TPM_NONCE          daaBlobKey;
+//} TPM_PERMANENT_DATA;
+
+
+//-------------------------------------------------------------------
+// Part 2, section 7.5: TPM_STCLEAR_DATA
+// available inside TPM only
+//
+//typedef struct tdTPM_STCLEAR_DATA
+//{
+//    TPM_STRUCTURE_TAG tag;
+//    TPM_NONCE         contextNonceKey;
+//    TPM_COUNT_ID      countID;
+//    UINT32            ownerReference;
+//    TPM_BOOL          disableResetLock;
+//    TPM_PCRVALUE      PCR[TPM_NUM_PCR];
+//    UINT32            deferredPhysicalPresence;
+//} TPM_STCLEAR_DATA;
+    
+
+
+//-------------------------------------------------------------------
+// Part 2, section 7.5: TPM_STANY_DATA
+// available inside TPM only
+//
+//typedef struct tdTPM_STANY_DATA
+//{
+//    TPM_STRUCTURE_TAG tag;
+//    TPM_NONCE         contextNonceSession;
+//    TPM_DIGEST        auditDigest;
+//    TPM_CURRENT_TICKS currentTicks;
+//    UINT32            contextCount;
+//    UINT32            contextList[TPM_MIN_SESSION_LIST];
+//    TPM_SESSION_DATA  sessions[TPM_MIN_SESSIONS];
+//    // The following appear in section 22.6 but not in 7.5
+//    TPM_DAA_ISSUER    DAA_issuerSettings;
+//    TPM_DAA_TPM       DAA_tpmSpecific;
+//    TPM_DAA_CONTEXT   DAA_session;
+//    TPM_DAA_JOINDATA  DAA_joinSession;
+//} TPM_STANY_DATA;
+    
+
+
+//-------------------------------------------------------------------
+// Part 2, section 8: PCR Structures
+
+typedef BYTE  TPM_LOCALITY_SELECTION;
+#define TPM_LOC_FOUR                   (((UINT32)1)<<4)
+#define TPM_LOC_THREE                  (((UINT32)1)<<3)
+#define TPM_LOC_TWO                    (((UINT32)1)<<2)
+#define TPM_LOC_ONE                    (((UINT32)1)<<1)
+#define TPM_LOC_ZERO                   (((UINT32)1)<<0)
+
+typedef struct tdTPM_PCR_SELECTION                          /* 1.1b */
+{ 
+    UINT16    sizeOfSelect;
+    SIZEIS(sizeOfSelect)
+        BYTE *pcrSelect;  
+} TPM_PCR_SELECTION;
+
+typedef struct tdTPM_PCR_COMPOSITE                          /* 1.1b */
+{ 
+    TPM_PCR_SELECTION select;
+    UINT32            valueSize;
+    SIZEIS(valueSize)
+        TPM_PCRVALUE *pcrValue; 
+} TPM_PCR_COMPOSITE;
+
+typedef struct tdTPM_PCR_INFO                               /* 1.1b */
+{
+    TPM_PCR_SELECTION  pcrSelection;
+    TPM_COMPOSITE_HASH digestAtRelease;
+    TPM_COMPOSITE_HASH digestAtCreation;
+}  TPM_PCR_INFO;
+
+typedef struct tdTPM_PCR_INFO_LONG
+{
+    TPM_STRUCTURE_TAG      tag;
+    TPM_LOCALITY_SELECTION localityAtCreation;
+    TPM_LOCALITY_SELECTION localityAtRelease;
+    TPM_PCR_SELECTION      creationPCRSelection;
+    TPM_PCR_SELECTION      releasePCRSelection;
+    TPM_COMPOSITE_HASH     digestAtCreation;
+    TPM_COMPOSITE_HASH     digestAtRelease;
+}  TPM_PCR_INFO_LONG;
+
+typedef struct tdTPM_PCR_INFO_SHORT
+{
+    TPM_PCR_SELECTION      pcrSelection;
+    TPM_LOCALITY_SELECTION localityAtRelease;
+    TPM_COMPOSITE_HASH     digestAtRelease;
+}  TPM_PCR_INFO_SHORT;
+
+typedef struct tdTPM_PCR_ATTRIBUTES
+{
+    BYTE                   pcrReset;
+    TPM_LOCALITY_SELECTION pcrExtendLocal;
+    TPM_LOCALITY_SELECTION pcrResetLocal;
+} TPM_PCR_ATTRIBUTES;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 9:
+
+typedef struct tdTPM_STORED_DATA                            /* 1.1b */
+{
+    TPM_STRUCT_VER ver;
+    UINT32         sealInfoSize;
+    SIZEIS(sealInfoSize)
+        BYTE      *sealInfo;
+    UINT32         encDataSize;
+    SIZEIS(encDataSize)
+        BYTE      *encData;
+} TPM_STORED_DATA;
+
+typedef struct tdTPM_STORED_DATA12
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_ENTITY_TYPE   et;
+    UINT32            sealInfoSize;
+    SIZEIS(sealInfoSize)
+        BYTE         *sealInfo;
+    UINT32            encDataSize;
+    SIZEIS(encDataSize)
+        BYTE         *encData;
+} TPM_STORED_DATA12;
+
+typedef struct tdTPM_SEALED_DATA                            /* 1.1b */
+{ 
+    TPM_PAYLOAD_TYPE  payload;
+    TPM_SECRET        authData;
+    TPM_NONCE         tpmProof;
+    TPM_DIGEST        storedDigest;
+    UINT32            dataSize;
+    SIZEIS(dataSize)
+        BYTE         *data;
+} TPM_SEALED_DATA;
+
+typedef struct tdTPM_SYMMETRIC_KEY                          /* 1.1b */
+{
+    TPM_ALGORITHM_ID  algId;
+    TPM_ENC_SCHEME    encScheme;
+    UINT16            size;
+    SIZEIS(size)
+        BYTE         *data;
+} TPM_SYMMETRIC_KEY;
+
+typedef struct tdTPM_BOUND_DATA
+{
+    TPM_STRUCT_VER   ver;
+    TPM_PAYLOAD_TYPE payload;
+    BYTE            *payloadData; // length is implied
+} TPM_BOUND_DATA;
+
+
+//-------------------------------------------------------------------
+// Part 2, section 10: TPM_KEY complex
+
+typedef struct tdTPM_KEY_PARMS                              /* 1.1b */
+{
+    TPM_ALGORITHM_ID  algorithmID;
+    TPM_ENC_SCHEME    encScheme;
+    TPM_SIG_SCHEME    sigScheme;
+    UINT32            parmSize;
+    SIZEIS(parmSize)
+        BYTE         *parms;
+} TPM_KEY_PARMS;
+
+typedef struct tdTPM_RSA_KEY_PARMS                          /* 1.1b */
+{  
+    UINT32    keyLength; 
+    UINT32    numPrimes; 
+    UINT32    exponentSize;
+    SIZEIS(exponentSize)
+        BYTE *exponent;
+} TPM_RSA_KEY_PARMS;
+
+typedef struct tdTPM_SYMMETRIC_KEY_PARMS
+{
+    UINT32 keyLength;
+    UINT32 blockSize;
+    UINT32 ivSize;
+    SIZEIS(ivSize)
+        BYTE *IV;
+} TPM_SYMMETRIC_KEY_PARMS;
+
+typedef struct tdTPM_STORE_PUBKEY                           /* 1.1b */
+{
+    UINT32    keyLength;
+    SIZEIS(keyLength)
+        BYTE *key;
+} TPM_STORE_PUBKEY;
+
+typedef struct tdTPM_PUBKEY                                 /* 1.1b */
+{
+    TPM_KEY_PARMS     algorithmParms;
+    TPM_STORE_PUBKEY  pubKey;
+} TPM_PUBKEY;
+
+typedef struct tdTPM_STORE_PRIVKEY                          /* 1.1b */
+{
+    UINT32    keyLength;
+    SIZEIS(keyLength)
+        BYTE *key;   
+} TPM_STORE_PRIVKEY;
+
+typedef struct tdTPM_STORE_ASYMKEY                          /* 1.1b */
+{         
+    TPM_PAYLOAD_TYPE  payload;   
+    TPM_SECRET        usageAuth;    
+    TPM_SECRET        migrationAuth;  
+    TPM_DIGEST        pubDataDigest;   
+    TPM_STORE_PRIVKEY privKey;   
+} TPM_STORE_ASYMKEY;
+
+typedef struct tdTPM_KEY                                    /* 1.1b */
+{
+    TPM_STRUCT_VER      ver;
+    TPM_KEY_USAGE       keyUsage;
+    TPM_KEY_FLAGS       keyFlags;
+    TPM_AUTH_DATA_USAGE authDataUsage;
+    TPM_KEY_PARMS       algorithmParms; 
+    UINT32              PCRInfoSize;
+    SIZEIS(PCRInfoSize)
+        BYTE           *PCRInfo;
+    TPM_STORE_PUBKEY    pubKey;
+    UINT32              encSize;
+    SIZEIS(encSize)
+        BYTE           *encData; 
+} TPM_KEY;
+
+typedef struct tdTPM_KEY12
+{
+    TPM_STRUCTURE_TAG   tag;
+    UINT16              fill;
+    TPM_KEY_USAGE       keyUsage;
+    TPM_KEY_FLAGS       keyFlags;
+    TPM_AUTH_DATA_USAGE authDataUsage;
+    TPM_KEY_PARMS       algorithmParms;
+    UINT32              PCRInfoSize;
+    SIZEIS(PCRInfoSize)
+       BYTE            *PCRInfo;
+    TPM_STORE_PUBKEY    pubKey;
+    UINT32              encSize;
+    SIZEIS(encSize)
+       BYTE            *encData;
+} TPM_KEY12;
+
+typedef struct tdTPM_MIGRATE_ASYMKEY
+{
+    TPM_PAYLOAD_TYPE payload;
+    TPM_SECRET       usageAuth;
+    TPM_DIGEST       pubDataDigest;
+    UINT32           partPrivKeyLen;
+    SIZEIS(partPrivKeyLen)
+        BYTE        *partPrivKey;
+} TPM_MIGRATE_ASYMKEY;
+
+
+typedef UINT32 TPM_KEY_CONTROL;
+#define TPM_KEY_CONTROL_OWNER_EVICT    ((UINT32)0x00000001)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 5.12: TPM_MIGRATIONKEYAUTH
+
+typedef struct tdTPM_MIGRATIONKEYAUTH                       /* 1.1b */
+{
+    TPM_PUBKEY         migrationKey;
+    TPM_MIGRATE_SCHEME migrationScheme;
+    TPM_DIGEST         digest;
+} TPM_MIGRATIONKEYAUTH;
+
+
+//-------------------------------------------------------------------
+// Part 2, section 11: Signed Structures
+
+typedef struct tdTPM_CERTIFY_INFO                           /* 1.1b */
+{
+    TPM_STRUCT_VER      version;
+    TPM_KEY_USAGE       keyUsage;
+    TPM_KEY_FLAGS       keyFlags;
+    TPM_AUTH_DATA_USAGE authDataUsage;
+    TPM_KEY_PARMS       algorithmParms;
+    TPM_DIGEST          pubkeyDigest;
+    TPM_NONCE           data;
+    TPM_BOOL            parentPCRStatus;
+    UINT32              PCRInfoSize;
+    SIZEIS(PCRInfoSize)
+        BYTE           *PCRInfo;
+} TPM_CERTIFY_INFO;
+
+typedef struct tdTPM_CERTIFY_INFO2
+{
+    TPM_STRUCTURE_TAG   tag;
+    BYTE                fill;
+    TPM_PAYLOAD_TYPE    payloadType;
+    TPM_KEY_USAGE       keyUsage;
+    TPM_KEY_FLAGS       keyFlags;
+    TPM_AUTH_DATA_USAGE authDataUsage;
+    TPM_KEY_PARMS       algorithmParms;
+    TPM_DIGEST          pubkeyDigest;
+    TPM_NONCE           data;
+    TPM_BOOL            parentPCRStatus;
+    UINT32              PCRInfoSize;
+    SIZEIS(PCRInfoSize) 
+        BYTE           *PCRInfo;
+    UINT32              migrationAuthoritySize;
+    SIZEIS(migrationAuthoritySize)
+        BYTE           *migrationAuthority;
+} TPM_CERTIFY_INFO2;
+
+typedef struct tdTPM_QUOTE_INFO                             /* 1.1b */
+{
+    TPM_STRUCT_VER     version;
+    BYTE               fixed[4];
+    TPM_COMPOSITE_HASH compositeHash; /* in 1.2 TPM spec, named digestValue */
+    TPM_NONCE          externalData;
+} TPM_QUOTE_INFO;
+
+typedef struct tdTPM_QUOTE_INFO2
+{
+    TPM_STRUCTURE_TAG  tag;
+    BYTE               fixed[4];
+    TPM_NONCE          externalData;
+    TPM_PCR_INFO_SHORT infoShort;
+} TPM_QUOTE_INFO2;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 12: Identity Structures
+
+
+typedef struct tdTPM_EK_BLOB
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_EK_TYPE       ekType;
+    UINT32            blobSize;
+    SIZEIS(blobSize)
+        BYTE         *blob;
+} TPM_EK_BLOB;
+
+typedef struct tdTPM_EK_BLOB_ACTIVATE
+{
+    TPM_STRUCTURE_TAG  tag;
+    TPM_SYMMETRIC_KEY  sessionKey;
+    TPM_DIGEST         idDigest;
+    TPM_PCR_INFO_SHORT pcrInfo;
+} TPM_EK_BLOB_ACTIVATE;
+
+typedef struct tdTPM_EK_BLOB_AUTH
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_SECRET        authValue;
+} TPM_EK_BLOB_AUTH;
+
+
+typedef struct tdTPM_IDENTITY_CONTENTS
+{
+    TPM_STRUCT_VER    ver;
+    UINT32            ordinal;
+    TPM_CHOSENID_HASH labelPrivCADigest;
+    TPM_PUBKEY        identityPubKey;
+} TPM_IDENTITY_CONTENTS;
+
+typedef struct tdTPM_IDENTITY_REQ                           /* 1.1b */
+{
+    UINT32         asymSize;
+    UINT32         symSize;
+    TPM_KEY_PARMS  asymAlgorithm;
+    TPM_KEY_PARMS  symAlgorithm;
+    SIZEIS(asymSize)
+        BYTE      *asymBlob;
+    SIZEIS(symSize)
+        BYTE      *symBlob;
+} TPM_IDENTITY_REQ;
+
+typedef struct tdTPM_IDENTITY_PROOF                         /* 1.1b */
+{
+    TPM_STRUCT_VER  ver;
+    UINT32          labelSize;
+    UINT32          identityBindingSize;
+    UINT32          endorsementSize;
+    UINT32          platformSize;
+    UINT32          conformanceSize;
+    TPM_PUBKEY      identityKey;
+    SIZEIS(labelSize)
+      BYTE         *labelArea;
+    SIZEIS(identityBindingSize)
+      BYTE         *identityBinding;
+    SIZEIS(endorsementSize)
+      BYTE         *endorsementCredential;
+    SIZEIS(platformSize)
+      BYTE         *platformCredential;
+    SIZEIS(conformanceSize)
+      BYTE         *conformanceCredential;
+} TPM_IDENTITY_PROOF;
+
+typedef struct tdTPM_ASYM_CA_CONTENTS                       /* 1.1b */
+{
+    TPM_SYMMETRIC_KEY sessionKey;
+    TPM_DIGEST        idDigest;
+} TPM_ASYM_CA_CONTENTS;
+
+typedef struct tdTPM_SYM_CA_ATTESTATION
+{
+    UINT32         credSize;
+    TPM_KEY_PARMS  algorithm;
+    SIZEIS(credSize)
+        BYTE      *credential;
+} TPM_SYM_CA_ATTESTATION;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 15: Tick Structures
+// Placed here out of order because definitions are used in section 13.
+
+typedef struct tdTPM_CURRENT_TICKS
+{
+    TPM_STRUCTURE_TAG tag;
+    UINT64            currentTicks;
+    UINT16            tickRate;
+    TPM_NONCE         tickNonce;
+} TPM_CURRENT_TICKS;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 13: Transport structures
+
+typedef UINT32 TPM_TRANSPORT_ATTRIBUTES;
+#define TPM_TRANSPORT_ENCRYPT          ((UINT32)0x00000001)
+#define TPM_TRANSPORT_LOG              ((UINT32)0x00000002)
+#define TPM_TRANSPORT_EXCLUSIVE        ((UINT32)0x00000004)
+
+typedef struct tdTPM_TRANSPORT_PUBLIC
+{
+    TPM_STRUCTURE_TAG        tag;
+    TPM_TRANSPORT_ATTRIBUTES transAttributes;
+    TPM_ALGORITHM_ID         algId;
+    TPM_ENC_SCHEME           encScheme;
+} TPM_TRANSPORT_PUBLIC;
+
+typedef struct tdTPM_TRANSPORT_INTERNAL
+{
+    TPM_STRUCTURE_TAG    tag;
+    TPM_AUTHDATA         authData;
+    TPM_TRANSPORT_PUBLIC transPublic;
+    TPM_TRANSHANDLE      transHandle;
+    TPM_NONCE            transNonceEven;
+    TPM_DIGEST           transDigest;
+} TPM_TRANSPORT_INTERNAL;
+
+typedef struct tdTPM_TRANSPORT_LOG_IN
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_DIGEST        parameters;
+    TPM_DIGEST        pubKeyHash;
+} TPM_TRANSPORT_LOG_IN;
+
+typedef struct tdTPM_TRANSPORT_LOG_OUT
+{
+    TPM_STRUCTURE_TAG      tag;
+    TPM_CURRENT_TICKS      currentTicks;
+    TPM_DIGEST             parameters;
+    TPM_MODIFIER_INDICATOR locality;
+} TPM_TRANSPORT_LOG_OUT;
+
+typedef struct tdTPM_TRANSPORT_AUTH
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_AUTHDATA      authData;
+} TPM_TRANSPORT_AUTH;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 14: Audit Structures
+
+typedef struct tdTPM_AUDIT_EVENT_IN
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_DIGEST        inputParms;
+    TPM_COUNTER_VALUE auditCount;
+} TPM_AUDIT_EVENT_IN;
+
+typedef struct tdTPM_AUDIT_EVENT_OUT
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_COMMAND_CODE  ordinal;
+    TPM_DIGEST        outputParms;
+    TPM_COUNTER_VALUE auditCount;
+    TPM_RESULT        returnCode;
+} TPM_AUDIT_EVENT_OUT;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 16: Return codes
+
+#include <tss/tpm_error.h>
+
+
+//-------------------------------------------------------------------
+// Part 2, section 17: Ordinals
+
+#include <tss/tpm_ordinal.h>
+
+//-------------------------------------------------------------------
+// Part 2, section 18: Context structures
+
+typedef struct tdTPM_CONTEXT_BLOB
+{
+    TPM_STRUCTURE_TAG  tag;
+    TPM_RESOURCE_TYPE  resourceType;
+    TPM_HANDLE         handle;
+    BYTE               label[16];
+    UINT32             contextCount;
+    TPM_DIGEST         integrityDigest;
+    UINT32             additionalSize;
+    SIZEIS(additionalSize)
+        BYTE          *additionalData;
+    UINT32             sensitiveSize;
+    SIZEIS(sensitiveSize)
+        BYTE          *sensitiveData;
+} TPM_CONTEXT_BLOB;
+
+typedef struct tdTPM_CONTEXT_SENSITIVE
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_NONCE         contextNonce;
+    UINT32            internalSize;
+    SIZEIS(internalSize)
+        BYTE         *internalData;
+} TPM_CONTEXT_SENSITIVE;
+
+//-------------------------------------------------------------------
+// Part 2, section 19: NV Structures
+
+typedef UINT32 TPM_NV_INDEX;
+#define TPM_NV_INDEX_LOCK              ((UINT32)0xffffffff)
+#define TPM_NV_INDEX0                  ((UINT32)0x00000000)
+#define TPM_NV_INDEX_DIR               ((UINT32)0x10000001)
+#define TPM_NV_INDEX_EKCert            ((UINT32)0x0000f000)
+#define TPM_NV_INDEX_TPM_CC            ((UINT32)0x0000f001)
+#define TPM_NV_INDEX_PlatformCert      ((UINT32)0x0000f002)
+#define TPM_NV_INDEX_Platform_CC       ((UINT32)0x0000f003)
+// The following define ranges of reserved indices.
+#define TPM_NV_INDEX_TSS_BASE          ((UINT32)0x00011100)
+#define TPM_NV_INDEX_PC_BASE           ((UINT32)0x00011200)
+#define TPM_NV_INDEX_SERVER_BASE       ((UINT32)0x00011300)
+#define TPM_NV_INDEX_MOBILE_BASE       ((UINT32)0x00011400)
+#define TPM_NV_INDEX_PERIPHERAL_BASE   ((UINT32)0x00011500)
+#define TPM_NV_INDEX_GROUP_RESV_BASE   ((UINT32)0x00010000)
+
+
+typedef UINT32 TPM_NV_PER_ATTRIBUTES;
+#define TPM_NV_PER_READ_STCLEAR        (((UINT32)1)<<31)
+#define TPM_NV_PER_AUTHREAD            (((UINT32)1)<<18)
+#define TPM_NV_PER_OWNERREAD           (((UINT32)1)<<17)
+#define TPM_NV_PER_PPREAD              (((UINT32)1)<<16)
+#define TPM_NV_PER_GLOBALLOCK          (((UINT32)1)<<15)
+#define TPM_NV_PER_WRITE_STCLEAR       (((UINT32)1)<<14)
+#define TPM_NV_PER_WRITEDEFINE         (((UINT32)1)<<13)
+#define TPM_NV_PER_WRITEALL            (((UINT32)1)<<12)
+#define TPM_NV_PER_AUTHWRITE           (((UINT32)1)<<2)
+#define TPM_NV_PER_OWNERWRITE          (((UINT32)1)<<1)
+#define TPM_NV_PER_PPWRITE             (((UINT32)1)<<0)
+
+typedef struct tdTPM_NV_ATTRIBUTES
+{
+    TPM_STRUCTURE_TAG     tag;
+    TPM_NV_PER_ATTRIBUTES attributes;
+} TPM_NV_ATTRIBUTES;
+
+
+typedef struct tdTPM_NV_DATA_PUBLIC
+{
+    TPM_STRUCTURE_TAG  tag;
+    TPM_NV_INDEX       nvIndex;
+    TPM_PCR_INFO_SHORT pcrInfoRead;
+    TPM_PCR_INFO_SHORT pcrInfoWrite;
+    TPM_NV_ATTRIBUTES  permission;
+    TPM_BOOL           bReadSTClear;
+    TPM_BOOL           bWriteSTClear;
+    TPM_BOOL           bWriteDefine;
+    UINT32             dataSize;
+} TPM_NV_DATA_PUBLIC;
+
+
+#if 0
+// Internal to TPM:
+typedef struct tdTPM_NV_DATA_SENSITIVE
+{
+    TPM_STRUCTURE_TAG  tag;
+    TPM_NV_DATA_PUBLIC pubInfo;
+    TPM_AUTHDATA       authValue;
+    SIZEIS(pubInfo.dataSize)
+        BYTE          *data;
+} TPM_NV_DATA_SENSITIVE;
+#endif
+
+
+//-------------------------------------------------------------------
+// Part 2, section 20: Delegation
+
+//-------------------------------------------------------------------
+// Part 2, section 20.3: Owner Permissions Settings for per1 bits
+#define TPM_DELEGATE_SetOrdinalAuditStatus          (((UINT32)1)<<30)
+#define TPM_DELEGATE_DirWriteAuth                   (((UINT32)1)<<29)
+#define TPM_DELEGATE_CMK_ApproveMA                  (((UINT32)1)<<28)
+#define TPM_DELEGATE_NV_WriteValue                  (((UINT32)1)<<27)
+#define TPM_DELEGATE_CMK_CreateTicket               (((UINT32)1)<<26)
+#define TPM_DELEGATE_NV_ReadValue                   (((UINT32)1)<<25)
+#define TPM_DELEGATE_Delegate_LoadOwnerDelegation   (((UINT32)1)<<24)
+#define TPM_DELEGATE_DAA_Join                       (((UINT32)1)<<23)
+#define TPM_DELEGATE_AuthorizeMigrationKey          (((UINT32)1)<<22)
+#define TPM_DELEGATE_CreateMaintenanceArchive       (((UINT32)1)<<21)
+#define TPM_DELEGATE_LoadMaintenanceArchive         (((UINT32)1)<<20)
+#define TPM_DELEGATE_KillMaintenanceFeature         (((UINT32)1)<<19)
+#define TPM_DELEGATE_OwnerReadInternalPub           (((UINT32)1)<<18)
+#define TPM_DELEGATE_ResetLockValue                 (((UINT32)1)<<17)
+#define TPM_DELEGATE_OwnerClear                     (((UINT32)1)<<16)
+#define TPM_DELEGATE_DisableOwnerClear              (((UINT32)1)<<15)
+#define TPM_DELEGATE_NV_DefineSpace                 (((UINT32)1)<<14)
+#define TPM_DELEGATE_OwnerSetDisable                (((UINT32)1)<<13)
+#define TPM_DELEGATE_SetCapability                  (((UINT32)1)<<12)
+#define TPM_DELEGATE_MakeIdentity                   (((UINT32)1)<<11)
+#define TPM_DELEGATE_ActivateIdentity               (((UINT32)1)<<10)
+#define TPM_DELEGATE_OwnerReadPubek                 (((UINT32)1)<<9)
+#define TPM_DELEGATE_DisablePubekRead               (((UINT32)1)<<8)
+#define TPM_DELEGATE_SetRedirection                 (((UINT32)1)<<7)
+#define TPM_DELEGATE_FieldUpgrade                   (((UINT32)1)<<6)
+#define TPM_DELEGATE_Delegate_UpdateVerification    (((UINT32)1)<<5)
+#define TPM_DELEGATE_CreateCounter                  (((UINT32)1)<<4)
+#define TPM_DELEGATE_ReleaseCounterOwner            (((UINT32)1)<<3)
+#define TPM_DELEGATE_DelegateManage                 (((UINT32)1)<<2)
+#define TPM_DELEGATE_Delegate_CreateOwnerDelegation (((UINT32)1)<<1)
+#define TPM_DELEGATE_DAA_Sign                       (((UINT32)1)<<0)
+
+//-------------------------------------------------------------------
+// Part 2, section 20.3: Key Permissions Settings for per1 bits
+#define TPM_KEY_DELEGATE_CMK_ConvertMigration       (((UINT32)1)<<28)
+#define TPM_KEY_DELEGATE_TickStampBlob              (((UINT32)1)<<27)
+#define TPM_KEY_DELEGATE_ChangeAuthAsymStart        (((UINT32)1)<<26)
+#define TPM_KEY_DELEGATE_ChangeAuthAsymFinish       (((UINT32)1)<<25)
+#define TPM_KEY_DELEGATE_CMK_CreateKey              (((UINT32)1)<<24)
+#define TPM_KEY_DELEGATE_MigrateKey                 (((UINT32)1)<<23)
+#define TPM_KEY_DELEGATE_LoadKey2                   (((UINT32)1)<<22)
+#define TPM_KEY_DELEGATE_EstablishTransport         (((UINT32)1)<<21)
+#define TPM_KEY_DELEGATE_ReleaseTransportSigned     (((UINT32)1)<<20)
+#define TPM_KEY_DELEGATE_Quote2                     (((UINT32)1)<<19)
+#define TPM_KEY_DELEGATE_Sealx                      (((UINT32)1)<<18)
+#define TPM_KEY_DELEGATE_MakeIdentity               (((UINT32)1)<<17)
+#define TPM_KEY_DELEGATE_ActivateIdentity           (((UINT32)1)<<16)
+#define TPM_KEY_DELEGATE_GetAuditDigestSigned       (((UINT32)1)<<15)
+#define TPM_KEY_DELEGATE_Sign                       (((UINT32)1)<<14)
+#define TPM_KEY_DELEGATE_CertifyKey2                (((UINT32)1)<<13)
+#define TPM_KEY_DELEGATE_CertifyKey                 (((UINT32)1)<<12)
+#define TPM_KEY_DELEGATE_CreateWrapKey              (((UINT32)1)<<11)
+#define TPM_KEY_DELEGATE_CMK_CreateBlob             (((UINT32)1)<<10)
+#define TPM_KEY_DELEGATE_CreateMigrationBlob        (((UINT32)1)<<9)
+#define TPM_KEY_DELEGATE_ConvertMigrationBlob       (((UINT32)1)<<8)
+#define TPM_KEY_DELEGATE_CreateKeyDelegation        (((UINT32)1)<<7)
+#define TPM_KEY_DELEGATE_ChangeAuth                 (((UINT32)1)<<6)
+#define TPM_KEY_DELEGATE_GetPubKey                  (((UINT32)1)<<5)
+#define TPM_KEY_DELEGATE_UnBind                     (((UINT32)1)<<4)
+#define TPM_KEY_DELEGATE_Quote                      (((UINT32)1)<<3)
+#define TPM_KEY_DELEGATE_Unseal                     (((UINT32)1)<<2)
+#define TPM_KEY_DELEGATE_Seal                       (((UINT32)1)<<1)
+#define TPM_KEY_DELEGATE_LoadKey                    (((UINT32)1)<<0)
+
+typedef UINT32 TPM_FAMILY_VERIFICATION;
+
+typedef UINT32 TPM_FAMILY_ID;
+
+typedef UINT32 TPM_DELEGATE_INDEX;
+
+typedef UINT32 TPM_FAMILY_OPERATION;
+#define TPM_FAMILY_CREATE              ((UINT32)0x00000001)
+#define TPM_FAMILY_ENABLE              ((UINT32)0x00000002)
+#define TPM_FAMILY_ADMIN               ((UINT32)0x00000003)
+#define TPM_FAMILY_INVALIDATE          ((UINT32)0x00000004)
+
+typedef UINT32 TPM_FAMILY_FLAGS;
+#define TPM_FAMFLAG_DELEGATE_ADMIN_LOCK   (((UINT32)1)<<1)
+#define TPM_FAMFLAG_ENABLE                (((UINT32)1)<<0)
+
+typedef struct tdTPM_FAMILY_LABEL
+{
+    BYTE label;
+} TPM_FAMILY_LABEL;
+
+typedef struct tdTPM_FAMILY_TABLE_ENTRY
+{
+    TPM_STRUCTURE_TAG       tag;
+    TPM_FAMILY_LABEL        label;
+    TPM_FAMILY_ID           familyID;
+    TPM_FAMILY_VERIFICATION verificationCount;
+    TPM_FAMILY_FLAGS        flags;
+} TPM_FAMILY_TABLE_ENTRY;
+
+
+#define TPM_FAMILY_TABLE_ENTRY_MIN 8
+//typedef struct tdTPM_FAMILY_TABLE
+//{
+//    TPM_FAMILY_TABLE_ENTRY FamTableRow[TPM_NUM_FAMILY_TABLE_ENTRY_MIN];
+//} TPM_FAMILY_TABLE;
+
+
+typedef struct tdTPM_DELEGATE_LABEL
+{
+    BYTE label;
+} TPM_DELEGATE_LABEL;
+
+
+typedef UINT32 TPM_DELEGATE_TYPE;
+#define TPM_DEL_OWNER_BITS             ((UINT32)0x00000001)
+#define TPM_DEL_KEY_BITS               ((UINT32)0x00000002)
+
+typedef struct tdTPM_DELEGATIONS
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_DELEGATE_TYPE delegateType;
+    UINT32            per1;
+    UINT32            per2;
+} TPM_DELEGATIONS;
+
+typedef struct tdTPM_DELEGATE_PUBLIC
+{
+    TPM_STRUCTURE_TAG       tag;
+    TPM_DELEGATE_LABEL      label;
+    TPM_PCR_INFO_SHORT      pcrInfo;
+    TPM_DELEGATIONS         permissions;
+    TPM_FAMILY_ID           familyID;
+    TPM_FAMILY_VERIFICATION verificationCount;
+} TPM_DELEGATE_PUBLIC;
+
+typedef struct tdTPM_DELEGATE_TABLE_ROW
+{
+    TPM_STRUCTURE_TAG   tag;
+    TPM_DELEGATE_PUBLIC pub;
+    TPM_SECRET          authValue;
+} TPM_DELEGATE_TABLE_ROW;
+
+
+#define TPM_NUM_DELEGATE_TABLE_ENTRY_MIN 2
+//typedef struct tdTPM_DELEGATE_TABLE
+//{
+//    TPM_DELEGATE_TABLE_ROW delRow[TPM_NUM_DELEGATE_TABLE_ENTRY_MIN];
+//} TPM_DELEGATE_TABLE;
+
+typedef struct tdTPM_DELEGATE_SENSITIVE
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_SECRET        authValue;
+} TPM_DELEGATE_SENSITIVE;
+
+typedef struct tdTPM_DELEGATE_OWNER_BLOB
+{
+    TPM_STRUCTURE_TAG   tag;
+    TPM_DELEGATE_PUBLIC pub;
+    TPM_DIGEST          integrityDigest;
+    UINT32              additionalSize;
+    SIZEIS(additionalSize)
+        BYTE           *additionalArea;
+    UINT32              sensitiveSize;
+    SIZEIS(sensitiveSize)
+        BYTE           *sensitiveArea;
+} TPM_DELEGATE_OWNER_BLOB;
+
+typedef struct tdTPM_DELEGATE_KEY_BLOB
+{
+    TPM_STRUCTURE_TAG   tag;
+    TPM_DELEGATE_PUBLIC pub;
+    TPM_DIGEST          integrityDigest;
+    TPM_DIGEST          pubKeyDigest;
+    UINT32              additionalSize;
+    SIZEIS(additionalSize)
+        BYTE           *additionalArea;
+    UINT32              sensitiveSize;
+    SIZEIS(sensitiveSize)
+        BYTE           *sensitiveArea;
+} TPM_DELEGATE_KEY_BLOB;
+
+
+//-------------------------------------------------------------------
+// Part 2, section 21.1: TPM_CAPABILITY_AREA
+
+typedef UINT32 TPM_CAPABILITY_AREA;                         /* 1.1b */
+#define TPM_CAP_ORD                    ((UINT32)0x00000001) /* 1.1b */
+#define TPM_CAP_ALG                    ((UINT32)0x00000002) /* 1.1b */
+#define TPM_CAP_PID                    ((UINT32)0x00000003) /* 1.1b */
+#define TPM_CAP_FLAG                   ((UINT32)0x00000004) /* 1.1b */
+#define TPM_CAP_PROPERTY               ((UINT32)0x00000005) /* 1.1b */
+#define TPM_CAP_VERSION                ((UINT32)0x00000006) /* 1.1b */
+#define TPM_CAP_KEY_HANDLE             ((UINT32)0x00000007) /* 1.1b */
+#define TPM_CAP_CHECK_LOADED           ((UINT32)0x00000008) /* 1.1b */
+#define TPM_CAP_SYM_MODE               ((UINT32)0x00000009)
+#define TPM_CAP_KEY_STATUS             ((UINT32)0x0000000C)
+#define TPM_CAP_NV_LIST                ((UINT32)0x0000000D)
+#define TPM_CAP_MFR                    ((UINT32)0x00000010)
+#define TPM_CAP_NV_INDEX               ((UINT32)0x00000011)
+#define TPM_CAP_TRANS_ALG              ((UINT32)0x00000012)
+#define TPM_CAP_HANDLE                 ((UINT32)0x00000014)
+#define TPM_CAP_TRANS_ES               ((UINT32)0x00000015)
+#define TPM_CAP_AUTH_ENCRYPT           ((UINT32)0x00000017)
+#define TPM_CAP_SELECT_SIZE            ((UINT32)0x00000018)
+#define TPM_CAP_DA_LOGIC               ((UINT32)0x00000019)
+#define TPM_CAP_VERSION_VAL            ((UINT32)0x0000001A)
+
+// Part 2, section 21.1: Subcap values for CAP_FLAG
+#define TPM_CAP_FLAG_PERMANENT         ((UINT32)0x00000108)
+#define TPM_CAP_FLAG_VOLATILE          ((UINT32)0x00000109)
+
+//-------------------------------------------------------------------
+// Part 2, section 21.2: Subcap values for CAP_PROPERTY
+
+#define TPM_CAP_PROP_PCR               ((UINT32)0x00000101) /* 1.1b */
+#define TPM_CAP_PROP_DIR               ((UINT32)0x00000102) /* 1.1b */
+#define TPM_CAP_PROP_MANUFACTURER      ((UINT32)0x00000103) /* 1.1b */
+#define TPM_CAP_PROP_KEYS              ((UINT32)0x00000104)
+#define TPM_CAP_PROP_SLOTS             (TPM_CAP_PROP_KEYS)
+#define TPM_CAP_PROP_MIN_COUNTER       ((UINT32)0x00000107)
+#define TPM_CAP_PROP_AUTHSESS          ((UINT32)0x0000010A)
+#define TPM_CAP_PROP_TRANSSESS         ((UINT32)0x0000010B)
+#define TPM_CAP_PROP_COUNTERS          ((UINT32)0x0000010C)
+#define TPM_CAP_PROP_MAX_AUTHSESS      ((UINT32)0x0000010D)
+#define TPM_CAP_PROP_MAX_TRANSSESS     ((UINT32)0x0000010E)
+#define TPM_CAP_PROP_MAX_COUNTERS      ((UINT32)0x0000010F)
+#define TPM_CAP_PROP_MAX_KEYS          ((UINT32)0x00000110)
+#define TPM_CAP_PROP_OWNER             ((UINT32)0x00000111)
+#define TPM_CAP_PROP_CONTEXT           ((UINT32)0x00000112)
+#define TPM_CAP_PROP_MAX_CONTEXT       ((UINT32)0x00000113)
+#define TPM_CAP_PROP_FAMILYROWS        ((UINT32)0x00000114)
+#define TPM_CAP_PROP_TIS_TIMEOUT       ((UINT32)0x00000115)
+#define TPM_CAP_PROP_STARTUP_EFFECT    ((UINT32)0x00000116)
+#define TPM_CAP_PROP_DELEGATE_ROW      ((UINT32)0x00000117)
+#define TPM_CAP_PROP_MAX_DAASESS       ((UINT32)0x00000119)
+#define TPM_CAP_PROP_DAA_MAX           TPM_CAP_PROP_MAX_DAASESS
+#define TPM_CAP_PROP_DAASESS           ((UINT32)0x0000011A)
+#define TPM_CAP_PROP_SESSION_DAA       TPM_CAP_PROP_DAASESS
+#define TPM_CAP_PROP_CONTEXT_DIST      ((UINT32)0x0000011B)
+#define TPM_CAP_PROP_DAA_INTERRUPT     ((UINT32)0x0000011C)
+#define TPM_CAP_PROP_SESSIONS          ((UINT32)0x0000011D)
+#define TPM_CAP_PROP_MAX_SESSIONS      ((UINT32)0x0000011E)
+#define TPM_CAP_PROP_CMK_RESTRICTION   ((UINT32)0x0000011F)
+#define TPM_CAP_PROP_DURATION          ((UINT32)0x00000120)
+#define TPM_CAP_PROP_ACTIVE_COUNTER    ((UINT32)0x00000122)
+#define TPM_CAP_PROP_NV_AVAILABLE      ((UINT32)0x00000123)
+#define TPM_CAP_PROP_INPUT_BUFFER      ((UINT32)0x00000124)
+
+
+// Part 2, section 21.4: SetCapability Values
+#define TPM_SET_PERM_FLAGS             ((UINT32)0x00000001)
+#define TPM_SET_PERM_DATA              ((UINT32)0x00000002)
+#define TPM_SET_STCLEAR_FLAGS          ((UINT32)0x00000003)
+#define TPM_SET_STCLEAR_DATA           ((UINT32)0x00000004)
+#define TPM_SET_STANY_FLAGS            ((UINT32)0x00000005)
+#define TPM_SET_STANY_DATA             ((UINT32)0x00000006)
+#define TPM_SET_VENDOR                 ((UINT32)0x00000007)
+
+
+// Part 2, section 21.6: TPM_CAP_VERSION_INFO
+typedef struct tdTPM_CAP_VERSION_INFO
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_VERSION       version;
+    UINT16            specLevel;
+    BYTE              errataRev;
+    BYTE              tpmVendorID[4];
+    UINT16            vendorSpecificSize;
+    SIZEIS(vendorSpecificSize)
+        BYTE         *vendorSpecific;
+} TPM_CAP_VERSION_INFO;
+
+
+// Part 2, section 21.9: TPM_DA_STATE
+// out of order to make it available for structure definitions
+typedef BYTE TPM_DA_STATE;
+#define TPM_DA_STATE_INACTIVE          (0x00)
+#define TPM_DA_STATE_ACTIVE            (0x01)
+
+// Part 2, section 21.10: TPM_DA_ACTION_TYPE
+typedef struct tdTPM_DA_ACTION_TYPE
+{
+    TPM_STRUCTURE_TAG tag;
+    UINT32            actions;
+} TPM_DA_ACTION_TYPE;
+#define TPM_DA_ACTION_TIMEOUT          ((UINT32)0x00000001)
+#define TPM_DA_ACTION_DISABLE          ((UINT32)0x00000002)
+#define TPM_DA_ACTION_DEACTIVATE       ((UINT32)0x00000004)
+#define TPM_DA_ACTION_FAILURE_MODE     ((UINT32)0x00000008)
+
+// Part 2, section 21.7: TPM_DA_INFO
+typedef struct tdTPM_DA_INFO
+{
+    TPM_STRUCTURE_TAG  tag;
+    TPM_DA_STATE       state;
+    UINT16             currentCount;
+    UINT16             threshholdCount;
+    TPM_DA_ACTION_TYPE actionAtThreshold;
+    UINT32             actionDependValue;
+    UINT32             vendorDataSize;
+    SIZEIS(vendorDataSize)
+        BYTE          *vendorData;
+} TPM_DA_INFO;
+
+// Part 2, section 21.8: TPM_DA_INFO_LIMITED
+typedef struct tdTPM_DA_INFO_LIMITED
+{
+    TPM_STRUCTURE_TAG  tag;
+    TPM_DA_STATE       state;
+    TPM_DA_ACTION_TYPE actionAtThreshold;
+    UINT32             vendorDataSize;
+    SIZEIS(vendorDataSize)
+        BYTE          *vendorData;
+} TPM_DA_INFO_LIMITED;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 22: DAA Structures
+
+#define TPM_DAA_SIZE_r0                (43)
+#define TPM_DAA_SIZE_r1                (43)
+#define TPM_DAA_SIZE_r2                (128)
+#define TPM_DAA_SIZE_r3                (168)
+#define TPM_DAA_SIZE_r4                (219)
+#define TPM_DAA_SIZE_NT                (20)
+#define TPM_DAA_SIZE_v0                (128)
+#define TPM_DAA_SIZE_v1                (192)
+#define TPM_DAA_SIZE_NE                (256)
+#define TPM_DAA_SIZE_w                 (256)
+#define TPM_DAA_SIZE_issuerModulus     (256)
+#define TPM_DAA_power0                 (104)
+#define TPM_DAA_power1                 (1024)
+
+typedef struct tdTPM_DAA_ISSUER
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_DIGEST        DAA_digest_R0;
+    TPM_DIGEST        DAA_digest_R1;
+    TPM_DIGEST        DAA_digest_S0;
+    TPM_DIGEST        DAA_digest_S1;
+    TPM_DIGEST        DAA_digest_n;
+    TPM_DIGEST        DAA_digest_gamma;
+    BYTE              DAA_generic_q[26];
+} TPM_DAA_ISSUER;
+
+
+typedef struct tdTPM_DAA_TPM
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_DIGEST        DAA_digestIssuer;
+    TPM_DIGEST        DAA_digest_v0;
+    TPM_DIGEST        DAA_digest_v1;
+    TPM_DIGEST        DAA_rekey;
+    UINT32            DAA_count;
+} TPM_DAA_TPM;
+
+typedef struct tdTPM_DAA_CONTEXT
+{
+    TPM_STRUCTURE_TAG    tag;
+    TPM_DIGEST           DAA_digestContext;
+    TPM_DIGEST           DAA_digest;
+    TPM_DAA_CONTEXT_SEED DAA_contextSeed;
+    BYTE                 DAA_scratch[256];
+    BYTE                 DAA_stage;
+} TPM_DAA_CONTEXT;
+
+typedef struct tdTPM_DAA_JOINDATA
+{
+    BYTE       DAA_join_u0[128];
+    BYTE       DAA_join_u1[138];
+    TPM_DIGEST DAA_digest_n0;
+} TPM_DAA_JOINDATA;
+
+typedef struct tdTPM_DAA_BLOB
+{
+    TPM_STRUCTURE_TAG tag;
+    TPM_RESOURCE_TYPE resourceType;
+    BYTE              label[16];
+    TPM_DIGEST        blobIntegrity;
+    UINT32            additionalSize;
+    SIZEIS(additionalSize)
+        BYTE         *additionalData;
+    UINT32            sensitiveSize;
+    SIZEIS(sensitiveSize)
+        BYTE         *sensitiveData;
+} TPM_DAA_BLOB;
+
+typedef struct tdTPM_DAA_SENSITIVE
+{
+    TPM_STRUCTURE_TAG tag;
+    UINT32            internalSize;
+    SIZEIS(internalSize)
+        BYTE         *internalData;
+} TPM_DAA_SENSITIVE;
+
+
+
+//-------------------------------------------------------------------
+// Part 2, section 23: Redirection
+
+// This section of the TPM spec defines exactly one value but does not
+// give it a name. The definition of TPM_SetRedirection in Part3
+// refers to exactly one name but does not give its value. We join
+// them here.
+#define TPM_REDIR_GPIO              (0x00000001)
+
+
+//-------------------------------------------------------------------
+// Part 2, section 24.6: TPM_SYM_MODE
+//    Deprecated by TPM 1.2 spec
+
+typedef UINT32 TPM_SYM_MODE;
+#define TPM_SYM_MODE_ECB            (0x00000001)
+#define TPM_SYM_MODE_CBC            (0x00000002)
+#define TPM_SYM_MODE_CFB            (0x00000003)
+
+#endif // __TPM_H__
+
diff -ru trousers-0.3.8-orig/src/include/tss/tspi.h trousers-0.3.8/src/include/tss/tspi.h
--- trousers-0.3.8-orig/src/include/tss/tspi.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tspi.h	2012-02-14 20:35:05.916221767 +0000
@@ -1,1198 +1,1198 @@
-#if !defined(_TSPI_H_)
-#define _TSPI_H_
-
-#include <tss/tss_defines.h>
-#include <tss/tss_typedef.h>
-#include <tss/tss_structs.h>
-#include <tss/tss_error.h>
-#include <tss/tss_error_basics.h>
-
-#if !defined( TSPICALL )
-  #if !defined(WIN32) || defined (TSP_STATIC)
-    // Linux, or a Win32 static library
-    #define TSPICALL extern TSS_RESULT
-  #elif defined (TSPDLL_EXPORTS)
-    // Win32 DLL build
-    #define TSPICALL extern __declspec(dllexport) TSS_RESULT
-  #else
-    // Win32 DLL import
-    #define TSPICALL extern __declspec(dllimport) TSS_RESULT
-  #endif
-#endif /* TSPICALL */
-
-#if defined ( __cplusplus )
-extern "C" {
-#endif /* __cplusplus */
-
-
-// Class-independent ASN.1 conversion functions
-TSPICALL Tspi_EncodeDER_TssBlob
-(
-    UINT32              rawBlobSize,                   // in
-    BYTE*               rawBlob,                       // in
-    UINT32              blobType,                      // in
-    UINT32*             derBlobSize,                   // in, out
-    BYTE*               derBlob                        // out
-);
-
-TSPICALL Tspi_DecodeBER_TssBlob
-(
-    UINT32              berBlobSize,                   // in
-    BYTE*               berBlob,                       // in
-    UINT32*             blobType,                      // out
-    UINT32*             rawBlobSize,                   // in, out
-    BYTE*               rawBlob                        // out
-);
-
-
-
-// Common Methods
-TSPICALL Tspi_SetAttribUint32
-(
-    TSS_HOBJECT         hObject,                       // in
-    TSS_FLAG            attribFlag,                    // in
-    TSS_FLAG            subFlag,                       // in
-    UINT32              ulAttrib                       // in
-);
-
-TSPICALL Tspi_GetAttribUint32
-(
-    TSS_HOBJECT         hObject,                       // in
-    TSS_FLAG            attribFlag,                    // in
-    TSS_FLAG            subFlag,                       // in
-    UINT32*             pulAttrib                      // out
-);
-
-TSPICALL Tspi_SetAttribData
-(
-    TSS_HOBJECT         hObject,                       // in
-    TSS_FLAG            attribFlag,                    // in
-    TSS_FLAG            subFlag,                       // in
-    UINT32              ulAttribDataSize,              // in
-    BYTE*               rgbAttribData                  // in
-);
-
-TSPICALL Tspi_GetAttribData
-(
-    TSS_HOBJECT         hObject,                       // in
-    TSS_FLAG            attribFlag,                    // in
-    TSS_FLAG            subFlag,                       // in
-    UINT32*             pulAttribDataSize,             // out
-    BYTE**              prgbAttribData                 // out
-);
-
-TSPICALL Tspi_ChangeAuth
-(
-    TSS_HOBJECT         hObjectToChange,               // in
-    TSS_HOBJECT         hParentObject,                 // in
-    TSS_HPOLICY         hNewPolicy                     // in
-);
-
-TSPICALL Tspi_ChangeAuthAsym
-(
-    TSS_HOBJECT         hObjectToChange,               // in
-    TSS_HOBJECT         hParentObject,                 // in
-    TSS_HKEY            hIdentKey,                     // in
-    TSS_HPOLICY         hNewPolicy                     // in
-);
-
-TSPICALL Tspi_GetPolicyObject
-(
-    TSS_HOBJECT         hObject,                       // in
-    TSS_FLAG            policyType,                    // in
-    TSS_HPOLICY*        phPolicy                       // out
-);
-
-
-
-// Tspi_Context Class Definitions
-TSPICALL Tspi_Context_Create
-(
-    TSS_HCONTEXT*       phContext                      // out
-);
-
-TSPICALL Tspi_Context_Close
-(
-    TSS_HCONTEXT        hContext                       // in
-);
-
-TSPICALL Tspi_Context_Connect
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_UNICODE*        wszDestination                 // in
-);
-
-TSPICALL Tspi_Context_FreeMemory
-(
-    TSS_HCONTEXT        hContext,                      // in
-    BYTE*               rgbMemory                      // in
-);
-
-TSPICALL Tspi_Context_GetDefaultPolicy
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_HPOLICY*        phPolicy                       // out
-);
-
-TSPICALL Tspi_Context_CreateObject
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_FLAG            objectType,                    // in
-    TSS_FLAG            initFlags,                     // in
-    TSS_HOBJECT*        phObject                       // out
-);
-
-TSPICALL Tspi_Context_CloseObject
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_HOBJECT         hObject                        // in
-);
-
-TSPICALL Tspi_Context_GetCapability
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_FLAG            capArea,                       // in
-    UINT32              ulSubCapLength,                // in
-    BYTE*               rgbSubCap,                     // in
-    UINT32*             pulRespDataLength,             // out
-    BYTE**              prgbRespData                   // out
-);
-
-TSPICALL Tspi_Context_GetTpmObject
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_HTPM*           phTPM                          // out
-);
-
-TSPICALL Tspi_Context_SetTransEncryptionKey
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_HKEY            hKey                           // in
-);
-
-TSPICALL Tspi_Context_CloseSignTransport
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_HKEY            hSigningKey,                   // in
-    TSS_VALIDATION*     pValidationData                // in, out
-);
-
-TSPICALL Tspi_Context_LoadKeyByBlob
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_HKEY            hUnwrappingKey,                // in
-    UINT32              ulBlobLength,                  // in
-    BYTE*               rgbBlobData,                   // in
-    TSS_HKEY*           phKey                          // out
-);
-
-TSPICALL Tspi_Context_LoadKeyByUUID
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_FLAG            persistentStorageType,         // in
-    TSS_UUID            uuidData,                      // in
-    TSS_HKEY*           phKey                          // out
-);
-
-TSPICALL Tspi_Context_RegisterKey
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_HKEY            hKey,                          // in
-    TSS_FLAG            persistentStorageType,         // in
-    TSS_UUID            uuidKey,                       // in
-    TSS_FLAG            persistentStorageTypeParent,   // in
-    TSS_UUID            uuidParentKey                  // in
-);
-
-TSPICALL Tspi_Context_UnregisterKey
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_FLAG            persistentStorageType,         // in
-    TSS_UUID            uuidKey,                       // in
-    TSS_HKEY*           phkey                          // out
-);
-
-TSPICALL Tspi_Context_GetKeyByUUID
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_FLAG            persistentStorageType,         // in
-    TSS_UUID            uuidData,                      // in
-    TSS_HKEY*           phKey                          // out
-);
-
-TSPICALL Tspi_Context_GetKeyByPublicInfo
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_FLAG            persistentStorageType,         // in
-    TSS_ALGORITHM_ID    algID,                         // in
-    UINT32              ulPublicInfoLength,            // in
-    BYTE*               rgbPublicInfo,                 // in
-    TSS_HKEY*           phKey                          // out
-);
-
-TSPICALL Tspi_Context_GetRegisteredKeysByUUID
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_FLAG            persistentStorageType,         // in
-    TSS_UUID*           pUuidData,                     // in
-    UINT32*             pulKeyHierarchySize,           // out
-    TSS_KM_KEYINFO**    ppKeyHierarchy                 // out
-);
-
-TSPICALL Tspi_Context_GetRegisteredKeysByUUID2
-(
-    TSS_HCONTEXT        hContext,                      // in
-    TSS_FLAG            persistentStorageType,         // in
-    TSS_UUID*           pUuidData,                     // in
-    UINT32*             pulKeyHierarchySize,           // out
-    TSS_KM_KEYINFO2**   ppKeyHierarchy                 // out
-);
-
-
-// Policy class definitions
-TSPICALL Tspi_Policy_SetSecret
-(
-    TSS_HPOLICY         hPolicy,                       // in
-    TSS_FLAG            secretMode,                    // in
-    UINT32              ulSecretLength,                // in
-    BYTE*               rgbSecret                      // in
-);
-
-TSPICALL Tspi_Policy_FlushSecret
-(
-    TSS_HPOLICY         hPolicy                        // in
-);
-
-TSPICALL Tspi_Policy_AssignToObject
-(
-    TSS_HPOLICY         hPolicy,                       // in
-    TSS_HOBJECT         hObject                        // in
-);
-
-
-
-// TPM Class Definitions
-TSPICALL Tspi_TPM_KeyControlOwner
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hKey,                          // in
-    UINT32              attribName,                    // in
-    TSS_BOOL            attribValue,                   // in
-    TSS_UUID*           pUuidData                      // out
-);
-
-TSPICALL Tspi_TPM_CreateEndorsementKey
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hKey,                          // in
-    TSS_VALIDATION*     pValidationData                // in, out
-);
-
-TSPICALL Tspi_TPM_CreateRevocableEndorsementKey
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hKey,                          // in
-    TSS_VALIDATION*     pValidationData,               // in, out
-    UINT32*             pulEkResetDataLength,          // in, out
-    BYTE**              rgbEkResetData                 // in, out
-);
-
-TSPICALL Tspi_TPM_RevokeEndorsementKey
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulEkResetDataLength,           // in
-    BYTE*               rgbEkResetData                 // in
-);
-
-TSPICALL Tspi_TPM_GetPubEndorsementKey
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_BOOL            fOwnerAuthorized,              // in
-    TSS_VALIDATION*     pValidationData,               // in, out
-    TSS_HKEY*           phEndorsementPubKey            // out
-);
-
-TSPICALL Tspi_TPM_OwnerGetSRKPubKey
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32*             pulPubKeyLength,               // out
-    BYTE**              prgbPubKey                     // out
-);
-
-TSPICALL Tspi_TPM_TakeOwnership
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hKeySRK,                       // in
-    TSS_HKEY            hEndorsementPubKey             // in
-);
-
-TSPICALL Tspi_TPM_ClearOwner
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_BOOL            fForcedClear                   // in
-);
-
-TSPICALL Tspi_TPM_CollateIdentityRequest
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hKeySRK,                       // in
-    TSS_HKEY            hCAPubKey,                     // in
-    UINT32              ulIdentityLabelLength,         // in
-    BYTE*               rgbIdentityLabelData,          // in
-    TSS_HKEY            hIdentityKey,                  // in
-    TSS_ALGORITHM_ID    algID,                         // in
-    UINT32*             pulTCPAIdentityReqLength,      // out
-    BYTE**              prgbTCPAIdentityReq            // out
-);
-
-TSPICALL Tspi_TPM_ActivateIdentity
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hIdentKey,                     // in
-    UINT32              ulAsymCAContentsBlobLength,    // in
-    BYTE*               rgbAsymCAContentsBlob,         // in
-    UINT32              ulSymCAAttestationBlobLength,  // in
-    BYTE*               rgbSymCAAttestationBlob,       // in
-    UINT32*             pulCredentialLength,           // out
-    BYTE**              prgbCredential                 // out
-);
-
-TSPICALL Tspi_TPM_CreateMaintenanceArchive
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_BOOL            fGenerateRndNumber,            // in
-    UINT32*             pulRndNumberLength,            // out
-    BYTE**              prgbRndNumber,                 // out
-    UINT32*             pulArchiveDataLength,          // out
-    BYTE**              prgbArchiveData                // out
-);
-
-TSPICALL Tspi_TPM_KillMaintenanceFeature
-(
-    TSS_HTPM            hTPM                           // in
-);
-
-TSPICALL Tspi_TPM_LoadMaintenancePubKey
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hMaintenanceKey,               // in
-    TSS_VALIDATION*     pValidationData                // in, out
-);
-
-TSPICALL Tspi_TPM_CheckMaintenancePubKey
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hMaintenanceKey,               // in
-    TSS_VALIDATION*     pValidationData                // in, out
-);
-
-TSPICALL Tspi_TPM_SetOperatorAuth
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HPOLICY         hOperatorPolicy                // in
-);
-
-TSPICALL Tspi_TPM_SetStatus
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_FLAG            statusFlag,                    // in
-    TSS_BOOL            fTpmState                      // in
-);
-
-TSPICALL Tspi_TPM_GetStatus
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_FLAG            statusFlag,                    // in
-    TSS_BOOL*           pfTpmState                     // out
-);
-
-TSPICALL Tspi_TPM_GetCapability
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_FLAG            capArea,                       // in
-    UINT32              ulSubCapLength,                // in
-    BYTE*               rgbSubCap,                     // in
-    UINT32*             pulRespDataLength,             // out
-    BYTE**              prgbRespData                   // out
-);
-
-TSPICALL Tspi_TPM_GetCapabilitySigned
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hKey,                          // in
-    TSS_FLAG            capArea,                       // in
-    UINT32              ulSubCapLength,                // in
-    BYTE*               rgbSubCap,                     // in
-    TSS_VALIDATION*     pValidationData,               // in, out
-    UINT32*             pulRespDataLength,             // out
-    BYTE**              prgbRespData                   // out
-);
-
-TSPICALL Tspi_TPM_SelfTestFull
-(
-    TSS_HTPM            hTPM                           // in
-);
-
-TSPICALL Tspi_TPM_CertifySelfTest
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hKey,                          // in
-    TSS_VALIDATION*     pValidationData                // in, out
-);
-
-TSPICALL Tspi_TPM_GetTestResult
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32*             pulTestResultLength,           // out
-    BYTE**              prgbTestResult                 // out
-);
-
-TSPICALL Tspi_TPM_GetRandom
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulRandomDataLength,            // in
-    BYTE**              prgbRandomData                 // out
-);
-
-TSPICALL Tspi_TPM_StirRandom
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulEntropyDataLength,           // in
-    BYTE*               rgbEntropyData                 // in
-);
-
-TSPICALL Tspi_TPM_GetEvent
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulPcrIndex,                    // in
-    UINT32              ulEventNumber,                 // in
-    TSS_PCR_EVENT*      pPcrEvent                      // out
-);
-
-TSPICALL Tspi_TPM_GetEvents
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulPcrIndex,                    // in
-    UINT32              ulStartNumber,                 // in
-    UINT32*             pulEventNumber,                // in, out
-    TSS_PCR_EVENT**     prgPcrEvents                   // out
-);
-
-TSPICALL Tspi_TPM_GetEventLog
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32*             pulEventNumber,                // out
-    TSS_PCR_EVENT**     prgPcrEvents                   // out
-);
-
-TSPICALL Tspi_TPM_Quote
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hIdentKey,                     // in
-    TSS_HPCRS           hPcrComposite,                 // in
-    TSS_VALIDATION*     pValidationData                // in, out
-);
-
-TSPICALL Tspi_TPM_Quote2
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hIdentKey,                     // in
-    TSS_BOOL            fAddVersion,                   // in
-    TSS_HPCRS           hPcrComposite,                 // in
-    TSS_VALIDATION*     pValidationData,               // in, out
-    UINT32*             versionInfoSize,               // out
-    BYTE**              versionInfo                    // out
-);
-
-TSPICALL Tspi_TPM_PcrExtend
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulPcrIndex,                    // in
-    UINT32              ulPcrDataLength,               // in
-    BYTE*               pbPcrData,                     // in
-    TSS_PCR_EVENT*      pPcrEvent,                     // in
-    UINT32*             pulPcrValueLength,             // out
-    BYTE**              prgbPcrValue                   // out
-);
-
-TSPICALL Tspi_TPM_PcrRead
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulPcrIndex,                    // in
-    UINT32*             pulPcrValueLength,             // out
-    BYTE**              prgbPcrValue                   // out
-);
-
-TSPICALL Tspi_TPM_PcrReset
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HPCRS           hPcrComposite                  // in
-);
-
-TSPICALL Tspi_TPM_AuthorizeMigrationTicket
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hMigrationKey,                 // in
-    TSS_MIGRATE_SCHEME  migrationScheme,               // in
-    UINT32*             pulMigTicketLength,            // out
-    BYTE**              prgbMigTicket                  // out
-);
-
-TSPICALL Tspi_TPM_CMKSetRestrictions
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_CMK_DELEGATE    CmkDelegate                    // in
-);
-
-TSPICALL Tspi_TPM_CMKApproveMA
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HMIGDATA        hMaAuthData                    // in
-);
-
-TSPICALL Tspi_TPM_CMKCreateTicket
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hVerifyKey,                    // in
-    TSS_HMIGDATA        hSigData                       // in
-);
-
-TSPICALL Tspi_TPM_ReadCounter
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32*             counterValue                   // out
-);
-
-TSPICALL Tspi_TPM_ReadCurrentTicks
-(
-    TSS_HTPM            hTPM,                          // in
-    TPM_CURRENT_TICKS*  tickCount                      // out
-);
-
-TSPICALL Tspi_TPM_DirWrite
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulDirIndex,                    // in
-    UINT32              ulDirDataLength,               // in
-    BYTE*               rgbDirData                     // in
-);
-
-TSPICALL Tspi_TPM_DirRead
-(
-    TSS_HTPM            hTPM,                          // in
-    UINT32              ulDirIndex,                    // in
-    UINT32*             pulDirDataLength,              // out
-    BYTE**              prgbDirData                    // out
-);
-
-TSPICALL Tspi_TPM_Delegate_AddFamily
-(
-    TSS_HTPM            hTPM,                          // in, must not be NULL
-    BYTE                bLabel,                        // in
-    TSS_HDELFAMILY*     phFamily                       // out
-);
-
-TSPICALL Tspi_TPM_Delegate_GetFamily
-(
-    TSS_HTPM            hTPM,                          // in, must not NULL
-    UINT32              ulFamilyID,                    // in
-    TSS_HDELFAMILY*     phFamily                       // out
-);
-
-TSPICALL Tspi_TPM_Delegate_InvalidateFamily
-(
-    TSS_HTPM            hTPM,                          // in, must not be NULL
-    TSS_HDELFAMILY      hFamily                        // in
-);
-
-TSPICALL Tspi_TPM_Delegate_CreateDelegation
-(
-    TSS_HOBJECT         hObject,                       // in
-    BYTE                bLabel,                        // in
-    UINT32              ulFlags,                       // in
-    TSS_HPCRS           hPcr,                          // in, may be NULL
-    TSS_HDELFAMILY      hFamily,                       // in
-    TSS_HPOLICY         hDelegation                    // in, out
-);
-
-TSPICALL Tspi_TPM_Delegate_CacheOwnerDelegation
-(
-    TSS_HTPM            hTPM,                          // in, must not be NULL
-    TSS_HPOLICY         hDelegation,                   // in, out
-    UINT32              ulIndex,                       // in
-    UINT32              ulFlags                        // in
-);
-
-TSPICALL Tspi_TPM_Delegate_UpdateVerificationCount
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HPOLICY         hDelegation                    // in, out
-);
-
-TSPICALL Tspi_TPM_Delegate_VerifyDelegation
-(
-    TSS_HPOLICY         hDelegation                    // in, out
-);
-
-TSPICALL Tspi_TPM_Delegate_ReadTables
-(
-    TSS_HCONTEXT                  hContext,                      // in
-    UINT32*                       pulFamilyTableSize,            // out
-    TSS_FAMILY_TABLE_ENTRY**      ppFamilyTable,                 // out
-    UINT32*                       pulDelegateTableSize,          // out
-    TSS_DELEGATION_TABLE_ENTRY**  ppDelegateTable                // out
-);
-
-TSPICALL Tspi_TPM_DAA_JoinInit
-(
-    TSS_HTPM                      hTPM,                          // in
-    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
-    UINT32                        daaCounter,                    // in
-    UINT32                        issuerAuthPKsLength,           // in
-    TSS_HKEY*                     issuerAuthPKs,                 // in
-    UINT32                        issuerAuthPKSignaturesLength,  // in
-    UINT32                        issuerAuthPKSignaturesLength2, // in
-    BYTE**                        issuerAuthPKSignatures,        // in
-    UINT32*                       capitalUprimeLength,           // out
-    BYTE**                        capitalUprime,                 // out
-    TSS_DAA_IDENTITY_PROOF**      identityProof,                 // out
-    UINT32*                       joinSessionLength,             // out
-    BYTE**                        joinSession                    // out
-);
-
-TSPICALL Tspi_TPM_DAA_JoinCreateDaaPubKey
-(
-    TSS_HTPM                      hTPM,                          // in
-    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
-    UINT32                        authenticationChallengeLength, // in
-    BYTE*                         authenticationChallenge,       // in
-    UINT32                        nonceIssuerLength,             // in
-    BYTE*                         nonceIssuer,                   // in
-    UINT32                        attributesPlatformLength,      // in
-    UINT32                        attributesPlatformLength2,     // in
-    BYTE**                        attributesPlatform,            // in
-    UINT32                        joinSessionLength,             // in
-    BYTE*                         joinSession,                   // in
-    TSS_DAA_CREDENTIAL_REQUEST**  credentialRequest              // out
-);
-
-TSPICALL Tspi_TPM_DAA_JoinStoreCredential
-(
-    TSS_HTPM                      hTPM,                          // in
-    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
-    TSS_DAA_CRED_ISSUER*          credIssuer,                    // in
-    UINT32                        joinSessionLength,             // in
-    BYTE*                         joinSession                    // in
-);
-
-TSPICALL Tspi_TPM_DAA_Sign
-(
-    TSS_HTPM                      hTPM,                          // in
-    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
-    TSS_HDAA_ARA_KEY              hARAKey,                       // in
-    TSS_DAA_SELECTED_ATTRIB*      revealAttributes,              // in
-    UINT32                        verifierNonceLength,           // in
-    BYTE*                         verifierNonce,                 // in
-    UINT32                        verifierBaseNameLength,        // in
-    BYTE*                         verifierBaseName,              // in
-    TSS_HOBJECT                   signData,                      // in
-    TSS_DAA_SIGNATURE**           daaSignature                   // out
-);
-
-TSPICALL Tspi_TPM_GetAuditDigest
-(
-    TSS_HTPM            hTPM,                          // in
-    TSS_HKEY            hKey,                          // in
-    TSS_BOOL            closeAudit,                    // in
-    UINT32*             pulAuditDigestSize,            // out
-    BYTE**              prgbAuditDigest,               // out
-    TPM_COUNTER_VALUE*  pCounterValue,                 // out
-    TSS_VALIDATION*     pValidationData,               // out
-    UINT32*             ordSize,                       // out
-    UINT32**            ordList                        // out
-);
-
-
-
-// PcrComposite Class Definitions
-TSPICALL Tspi_PcrComposite_SelectPcrIndex
-(
-    TSS_HPCRS           hPcrComposite,                 // in
-    UINT32              ulPcrIndex                     // in
-);
-
-TSPICALL Tspi_PcrComposite_SelectPcrIndexEx
-(
-    TSS_HPCRS           hPcrComposite,                 // in
-    UINT32              ulPcrIndex,                    // in
-    UINT32              direction                      // in
-);
-
-TSPICALL Tspi_PcrComposite_SetPcrValue
-(
-    TSS_HPCRS           hPcrComposite,                 // in
-    UINT32              ulPcrIndex,                    // in
-    UINT32              ulPcrValueLength,              // in
-    BYTE*               rgbPcrValue                    // in
-);
-
-TSPICALL Tspi_PcrComposite_GetPcrValue
-(
-    TSS_HPCRS           hPcrComposite,                 // in
-    UINT32              ulPcrIndex,                    // in
-    UINT32*             pulPcrValueLength,             // out
-    BYTE**              prgbPcrValue                   // out
-);
-
-TSPICALL Tspi_PcrComposite_SetPcrLocality
-(
-    TSS_HPCRS           hPcrComposite,                 // in
-    UINT32              LocalityValue                  // in
-);
-
-TSPICALL Tspi_PcrComposite_GetPcrLocality
-(
-    TSS_HPCRS           hPcrComposite,                 // in
-    UINT32*             pLocalityValue                 // out
-);
-
-TSPICALL Tspi_PcrComposite_GetCompositeHash
-(
-    TSS_HPCRS           hPcrComposite,                 // in
-    UINT32*             pLen,                          // in
-    BYTE**              ppbHashData                    // out
-);
-
-
-
-// Key Class Definition
-TSPICALL Tspi_Key_LoadKey
-(
-    TSS_HKEY            hKey,                          // in
-    TSS_HKEY            hUnwrappingKey                 // in
-);
-
-TSPICALL Tspi_Key_UnloadKey
-(
-    TSS_HKEY            hKey                           // in
-);
-
-TSPICALL Tspi_Key_GetPubKey
-(
-    TSS_HKEY            hKey,                          // in
-    UINT32*             pulPubKeyLength,               // out
-    BYTE**              prgbPubKey                     // out
-);
-
-TSPICALL Tspi_Key_CertifyKey
-(
-    TSS_HKEY            hKey,                          // in
-    TSS_HKEY            hCertifyingKey,                // in
-    TSS_VALIDATION*     pValidationData                // in, out
-);
-
-TSPICALL Tspi_Key_CreateKey
-(
-    TSS_HKEY            hKey,                          // in
-    TSS_HKEY            hWrappingKey,                  // in
-    TSS_HPCRS           hPcrComposite                  // in, may be NULL
-);
-
-TSPICALL Tspi_Key_WrapKey
-(
-    TSS_HKEY            hKey,                          // in
-    TSS_HKEY            hWrappingKey,                  // in
-    TSS_HPCRS           hPcrComposite                  // in, may be NULL
-);
-
-TSPICALL Tspi_Key_CreateMigrationBlob
-(
-    TSS_HKEY            hKeyToMigrate,                 // in
-    TSS_HKEY            hParentKey,                    // in
-    UINT32              ulMigTicketLength,             // in
-    BYTE*               rgbMigTicket,                  // in
-    UINT32*             pulRandomLength,               // out
-    BYTE**              prgbRandom,                    // out
-    UINT32*             pulMigrationBlobLength,        // out
-    BYTE**              prgbMigrationBlob              // out
-);
-
-TSPICALL Tspi_Key_ConvertMigrationBlob
-(
-    TSS_HKEY            hKeyToMigrate,                 // in
-    TSS_HKEY            hParentKey,                    // in
-    UINT32              ulRandomLength,                // in
-    BYTE*               rgbRandom,                     // in
-    UINT32              ulMigrationBlobLength,         // in
-    BYTE*               rgbMigrationBlob               // in
-);
-
-TSPICALL Tspi_Key_MigrateKey
-(
-    TSS_HKEY            hMaKey,                        // in
-    TSS_HKEY            hPublicKey,                    // in
-    TSS_HKEY            hMigData                       // in
-);
-
-TSPICALL Tspi_Key_CMKCreateBlob
-(
-    TSS_HKEY            hKeyToMigrate,                 // in
-    TSS_HKEY            hParentKey,                    // in
-    TSS_HMIGDATA        hMigrationData,                // in
-    UINT32*             pulRandomLength,               // out
-    BYTE**              prgbRandom                     // out
-);
-
-TSPICALL Tspi_Key_CMKConvertMigration
-(
-    TSS_HKEY            hKeyToMigrate,                 // in
-    TSS_HKEY            hParentKey,                    // in
-    TSS_HMIGDATA        hMigrationData,                // in
-    UINT32              ulRandomLength,                // in
-    BYTE*               rgbRandom                      // in
-);
-
-
-
-// Hash Class Definition
-TSPICALL Tspi_Hash_Sign
-(
-    TSS_HHASH           hHash,                         // in
-    TSS_HKEY            hKey,                          // in
-    UINT32*             pulSignatureLength,            // out
-    BYTE**              prgbSignature                  // out
-);
-
-TSPICALL Tspi_Hash_VerifySignature
-(
-    TSS_HHASH           hHash,                         // in
-    TSS_HKEY            hKey,                          // in
-    UINT32              ulSignatureLength,             // in
-    BYTE*               rgbSignature                   // in
-);
-
-TSPICALL Tspi_Hash_SetHashValue
-(
-    TSS_HHASH           hHash,                         // in
-    UINT32              ulHashValueLength,             // in
-    BYTE*               rgbHashValue                   // in
-);
-
-TSPICALL Tspi_Hash_GetHashValue
-(
-    TSS_HHASH           hHash,                         // in
-    UINT32*             pulHashValueLength,            // out
-    BYTE**              prgbHashValue                  // out
-);
-
-TSPICALL Tspi_Hash_UpdateHashValue
-(
-    TSS_HHASH           hHash,                         // in
-    UINT32              ulDataLength,                  // in
-    BYTE*               rgbData                        // in
-);
-
-TSPICALL Tspi_Hash_TickStampBlob
-(
-    TSS_HHASH           hHash,                         // in
-    TSS_HKEY            hIdentKey,                     // in
-    TSS_VALIDATION*     pValidationData                // in
-);
-
-
-
-// EncData Class Definition
-TSPICALL Tspi_Data_Bind
-(
-    TSS_HENCDATA        hEncData,                      // in
-    TSS_HKEY            hEncKey,                       // in
-    UINT32              ulDataLength,                  // in
-    BYTE*               rgbDataToBind                  // in
-);
-
-TSPICALL Tspi_Data_Unbind
-(
-    TSS_HENCDATA        hEncData,                      // in
-    TSS_HKEY            hKey,                          // in
-    UINT32*             pulUnboundDataLength,          // out
-    BYTE**              prgbUnboundData                // out
-);
-
-TSPICALL Tspi_Data_Seal
-(
-    TSS_HENCDATA        hEncData,                      // in
-    TSS_HKEY            hEncKey,                       // in
-    UINT32              ulDataLength,                  // in
-    BYTE*               rgbDataToSeal,                 // in
-    TSS_HPCRS           hPcrComposite                  // in
-);
-
-TSPICALL Tspi_Data_Unseal
-(
-    TSS_HENCDATA        hEncData,                      // in
-    TSS_HKEY            hKey,                          // in
-    UINT32*             pulUnsealedDataLength,         // out
-    BYTE**              prgbUnsealedData               // out
-);
-
-
-
-// NV Class Definition
-TSPICALL Tspi_NV_DefineSpace
-(
-    TSS_HNVSTORE        hNVStore,                      // in
-    TSS_HPCRS           hReadPcrComposite,             // in, may be NULL
-    TSS_HPCRS           hWritePcrComposite             // in, may be NULL
-);
-
-TSPICALL Tspi_NV_ReleaseSpace
-(
-    TSS_HNVSTORE        hNVStore                       // in
-);
-
-TSPICALL Tspi_NV_WriteValue
-(
-    TSS_HNVSTORE        hNVStore,                      // in
-    UINT32              offset,                        // in
-    UINT32              ulDataLength,                  // in
-    BYTE*               rgbDataToWrite                 // in
-);
-
-TSPICALL Tspi_NV_ReadValue
-(
-    TSS_HNVSTORE        hNVStore,                      // in
-    UINT32              offset,                        // in
-    UINT32*             ulDataLength,                  // in, out
-    BYTE**              rgbDataRead                    // out
-);
-
-
-// DAA Utility functions (optional, do not require a TPM or TCS)
-TSPICALL Tspi_DAA_IssuerKeyVerify
-(
-    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
-    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
-    TSS_BOOL*                     isCorrect                      // out
-);
-
-TSPICALL Tspi_DAA_Issuer_GenerateKey
-(
-    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
-    UINT32                        issuerBaseNameLength,          // in
-    BYTE*                         issuerBaseName                 // in
-);
-
-TSPICALL Tspi_DAA_Issuer_InitCredential
-(
-    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
-    TSS_HKEY                      issuerAuthPK,                  // in
-    TSS_DAA_IDENTITY_PROOF*       identityProof,                 // in
-    UINT32                        capitalUprimeLength,           // in
-    BYTE*                         capitalUprime,                 // in
-    UINT32                        daaCounter,                    // in
-    UINT32*                       nonceIssuerLength,             // out
-    BYTE**                        nonceIssuer,                   // out
-    UINT32*                       authenticationChallengeLength, // out
-    BYTE**                        authenticationChallenge,       // out
-    UINT32*                       joinSessionLength,             // out
-    BYTE**                        joinSession                    // out
-);
-
-TSPICALL Tspi_DAA_Issuer_IssueCredential
-(
-    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
-    TSS_DAA_CREDENTIAL_REQUEST*   credentialRequest,             // in
-    UINT32                        issuerJoinSessionLength,       // in
-    BYTE*                         issuerJoinSession,             // in
-    TSS_DAA_CRED_ISSUER**         credIssuer                     // out
-);
-
-TSPICALL Tspi_DAA_Verifier_Init
-(
-    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
-    UINT32*                       nonceVerifierLength,           // out
-    BYTE**                        nonceVerifier,                 // out
-    UINT32*                       baseNameLength,                // out
-    BYTE**                        baseName                       // out
-);
-
-TSPICALL Tspi_DAA_VerifySignature
-(
-    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
-    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
-    TSS_HDAA_ARA_KEY              hARAKey,                       // in
-    TSS_HHASH                     hARACondition,                 // in
-    UINT32                        attributesLength,              // in
-    UINT32                        attributesLength2,             // in
-    BYTE**                        attributes,                    // in
-    UINT32                        verifierNonceLength,           // in
-    BYTE*                         verifierNonce,                 // in
-    UINT32                        verifierBaseNameLength,        // in
-    BYTE*                         verifierBaseName,              // in
-    TSS_HOBJECT                   signData,                      // in
-    TSS_DAA_SIGNATURE*            daaSignature,                  // in
-    TSS_BOOL*                     isCorrect                      // out
-);
-
-TSPICALL Tspi_DAA_ARA_GenerateKey
-(
-    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
-    TSS_HDAA_ARA_KEY              hARAKey                        // in
-);
-
-TSPICALL Tspi_DAA_ARA_RevokeAnonymity
-(
-    TSS_HDAA_ARA_KEY              hARAKey,                       // in
-    TSS_HHASH                     hARACondition,                 // in
-    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
-    TSS_DAA_PSEUDONYM_ENCRYPTED*  encryptedPseudonym,            // in
-    TSS_DAA_PSEUDONYM_PLAIN**     pseudonym                      // out
-);
-
-
-
-// Callback typedefs
-typedef TSS_RESULT (*Tspicb_CallbackHMACAuth)
-(
-    PVOID            lpAppData,          // in
-    TSS_HOBJECT      hAuthorizedObject,  // in
-    TSS_BOOL         ReturnOrVerify,     // in
-    UINT32           ulPendingFunction,  // in
-    TSS_BOOL         ContinueUse,        // in
-    UINT32           ulSizeNonces,       // in
-    BYTE*            rgbNonceEven,       // in
-    BYTE*            rgbNonceOdd,        // in
-    BYTE*            rgbNonceEvenOSAP,   // in
-    BYTE*            rgbNonceOddOSAP,    // in
-    UINT32           ulSizeDigestHmac,   // in
-    BYTE*            rgbParamDigest,     // in
-    BYTE*            rgbHmacData         // in, out
-);
-
-typedef TSS_RESULT (*Tspicb_CallbackXorEnc)
-(
-   PVOID            lpAppData,            // in
-   TSS_HOBJECT      hOSAPObject,          // in
-   TSS_HOBJECT      hObject,              // in
-   TSS_FLAG         PurposeSecret,        // in
-   UINT32           ulSizeNonces,         // in
-   BYTE*            rgbNonceEven,         // in
-   BYTE*            rgbNonceOdd,          // in
-   BYTE*            rgbNonceEvenOSAP,     // in
-   BYTE*            rgbNonceOddOSAP,      // in
-   UINT32           ulSizeEncAuth,        // in
-   BYTE*            rgbEncAuthUsage,      // out
-   BYTE*            rgbEncAuthMigration   // out
-);
-
-typedef TSS_RESULT (*Tspicb_CallbackTakeOwnership)
-(
-   PVOID            lpAppData,         // in
-   TSS_HOBJECT      hObject,           // in
-   TSS_HKEY         hObjectPubKey,     // in
-   UINT32           ulSizeEncAuth,     // in
-   BYTE*            rgbEncAuth         // out
-);
-
-typedef TSS_RESULT (*Tspicb_CallbackSealxMask)
-(
-    PVOID            lpAppData,        // in
-    TSS_HKEY         hKey,             // in
-    TSS_HENCDATA     hEncData,         // in
-    TSS_ALGORITHM_ID algID,            // in
-    UINT32           ulSizeNonces,     // in
-    BYTE*            rgbNonceEven,     // in
-    BYTE*            rgbNonceOdd,      // in
-    BYTE*            rgbNonceEvenOSAP, // in
-    BYTE*            rgbNonceOddOSAP,  // in
-    UINT32           ulDataLength,     // in
-    BYTE*            rgbDataToMask,    // in
-    BYTE*            rgbMaskedData     // out
-);
-
-typedef TSS_RESULT (*Tspicb_CallbackChangeAuthAsym)
-(
-   PVOID            lpAppData,        // in
-   TSS_HOBJECT      hObject,          // in
-   TSS_HKEY         hObjectPubKey,    // in
-   UINT32           ulSizeEncAuth,    // in
-   UINT32           ulSizeAuthLink,   // in
-   BYTE*            rgbEncAuth,       // out
-   BYTE*            rgbAuthLink       // out
-);
-
-typedef TSS_RESULT (*Tspicb_CollateIdentity)
-(
-   PVOID            lpAppData,                      // in
-   UINT32           ulTCPAPlainIdentityProofLength, // in
-   BYTE*            rgbTCPAPlainIdentityProof,      // in
-   TSS_ALGORITHM_ID algID,                          // in
-   UINT32           ulSessionKeyLength,             // out
-   BYTE*            rgbSessionKey,                  // out
-   UINT32*          pulTCPAIdentityProofLength,     // out
-   BYTE*            rgbTCPAIdentityProof            // out
-);
-
-
-typedef TSS_RESULT (*Tspicb_ActivateIdentity)
-(
-   PVOID            lpAppData,                    // in
-   UINT32           ulSessionKeyLength,           // in
-   BYTE*            rgbSessionKey,                // in
-   UINT32           ulSymCAAttestationBlobLength, // in
-   BYTE*            rgbSymCAAttestationBlob,      // in
-   UINT32*          pulCredentialLength,          // out
-   BYTE*            rgbCredential                 // out
-);
-
-
-typedef TSS_RESULT (*Tspicb_DAA_Sign)
-(
-    PVOID                        lpAppData,                 // in
-    TSS_HDAA_ISSUER_KEY          daaPublicKey,              // in
-    UINT32                       gammasLength,              // in
-    BYTE**                       gammas,                    // in
-    UINT32                       attributesLength,          // in
-    BYTE**                       attributes,                // in
-    UINT32                       randomAttributesLength,    // in
-    BYTE**                       randomAttributes,          // in
-    UINT32                       attributeCommitmentsLength,// in
-    TSS_DAA_ATTRIB_COMMIT*       attributeCommitments,      // in
-    TSS_DAA_ATTRIB_COMMIT*       attributeCommitmentsProof, // in
-    TSS_DAA_PSEUDONYM_PLAIN*     pseudonym,                 // in
-    TSS_DAA_PSEUDONYM_PLAIN*     pseudonymTilde,            // in
-    TSS_DAA_PSEUDONYM_ENCRYPTED* pseudonymEncrypted,        // in
-    TSS_DAA_PSEUDONYM_ENCRYPTED* pseudonymEncProof,         // in
-    TSS_DAA_SIGN_CALLBACK**      additionalProof            // out
-);
-
-typedef TSS_RESULT (*Tspicb_DAA_VerifySignature)
-(
-    PVOID                        lpAppData,                 // in
-    UINT32                       challengeLength,           // in
-    BYTE*                        challenge,                 // in
-    TSS_DAA_SIGN_CALLBACK*       additionalProof,           // in
-    TSS_HDAA_ISSUER_KEY          daaPublicKey,              // in
-    UINT32                       gammasLength,              // in
-    BYTE**                       gammas,                    // in
-    UINT32                       sAttributesLength,         // in
-    BYTE**                       sAttributes,               // in
-    UINT32                       attributeCommitmentsLength,// in
-    TSS_DAA_ATTRIB_COMMIT*       attributeCommitments,      // in
-    TSS_DAA_ATTRIB_COMMIT*       attributeCommitmentsProof, // in
-    UINT32                       zetaLength,                // in
-    BYTE*                        zeta,                      // in
-    UINT32                       sFLength,                  // in
-    BYTE*                        sF,                        // in
-    TSS_DAA_PSEUDONYM*           pseudonym,                 // in
-    TSS_DAA_PSEUDONYM*           pseudonymProof,            // in
-    TSS_BOOL*                    isCorrect                  // out
-);
-
-
-#if defined ( __cplusplus )
-}
-#endif /* __cplusplus */
-
-
-#endif /* _TSPI_H_ */
+#if !defined(_TSPI_H_)
+#define _TSPI_H_
+
+#include <tss/tss_defines.h>
+#include <tss/tss_typedef.h>
+#include <tss/tss_structs.h>
+#include <tss/tss_error.h>
+#include <tss/tss_error_basics.h>
+
+#if !defined( TSPICALL )
+  #if !defined(WIN32) || defined (TSP_STATIC)
+    // Linux, or a Win32 static library
+    #define TSPICALL extern TSS_RESULT
+  #elif defined (TSPDLL_EXPORTS)
+    // Win32 DLL build
+    #define TSPICALL extern __declspec(dllexport) TSS_RESULT
+  #else
+    // Win32 DLL import
+    #define TSPICALL extern __declspec(dllimport) TSS_RESULT
+  #endif
+#endif /* TSPICALL */
+
+#if defined ( __cplusplus )
+extern "C" {
+#endif /* __cplusplus */
+
+
+// Class-independent ASN.1 conversion functions
+TSPICALL Tspi_EncodeDER_TssBlob
+(
+    UINT32              rawBlobSize,                   // in
+    BYTE*               rawBlob,                       // in
+    UINT32              blobType,                      // in
+    UINT32*             derBlobSize,                   // in, out
+    BYTE*               derBlob                        // out
+);
+
+TSPICALL Tspi_DecodeBER_TssBlob
+(
+    UINT32              berBlobSize,                   // in
+    BYTE*               berBlob,                       // in
+    UINT32*             blobType,                      // out
+    UINT32*             rawBlobSize,                   // in, out
+    BYTE*               rawBlob                        // out
+);
+
+
+
+// Common Methods
+TSPICALL Tspi_SetAttribUint32
+(
+    TSS_HOBJECT         hObject,                       // in
+    TSS_FLAG            attribFlag,                    // in
+    TSS_FLAG            subFlag,                       // in
+    UINT32              ulAttrib                       // in
+);
+
+TSPICALL Tspi_GetAttribUint32
+(
+    TSS_HOBJECT         hObject,                       // in
+    TSS_FLAG            attribFlag,                    // in
+    TSS_FLAG            subFlag,                       // in
+    UINT32*             pulAttrib                      // out
+);
+
+TSPICALL Tspi_SetAttribData
+(
+    TSS_HOBJECT         hObject,                       // in
+    TSS_FLAG            attribFlag,                    // in
+    TSS_FLAG            subFlag,                       // in
+    UINT32              ulAttribDataSize,              // in
+    BYTE*               rgbAttribData                  // in
+);
+
+TSPICALL Tspi_GetAttribData
+(
+    TSS_HOBJECT         hObject,                       // in
+    TSS_FLAG            attribFlag,                    // in
+    TSS_FLAG            subFlag,                       // in
+    UINT32*             pulAttribDataSize,             // out
+    BYTE**              prgbAttribData                 // out
+);
+
+TSPICALL Tspi_ChangeAuth
+(
+    TSS_HOBJECT         hObjectToChange,               // in
+    TSS_HOBJECT         hParentObject,                 // in
+    TSS_HPOLICY         hNewPolicy                     // in
+);
+
+TSPICALL Tspi_ChangeAuthAsym
+(
+    TSS_HOBJECT         hObjectToChange,               // in
+    TSS_HOBJECT         hParentObject,                 // in
+    TSS_HKEY            hIdentKey,                     // in
+    TSS_HPOLICY         hNewPolicy                     // in
+);
+
+TSPICALL Tspi_GetPolicyObject
+(
+    TSS_HOBJECT         hObject,                       // in
+    TSS_FLAG            policyType,                    // in
+    TSS_HPOLICY*        phPolicy                       // out
+);
+
+
+
+// Tspi_Context Class Definitions
+TSPICALL Tspi_Context_Create
+(
+    TSS_HCONTEXT*       phContext                      // out
+);
+
+TSPICALL Tspi_Context_Close
+(
+    TSS_HCONTEXT        hContext                       // in
+);
+
+TSPICALL Tspi_Context_Connect
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_UNICODE*        wszDestination                 // in
+);
+
+TSPICALL Tspi_Context_FreeMemory
+(
+    TSS_HCONTEXT        hContext,                      // in
+    BYTE*               rgbMemory                      // in
+);
+
+TSPICALL Tspi_Context_GetDefaultPolicy
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_HPOLICY*        phPolicy                       // out
+);
+
+TSPICALL Tspi_Context_CreateObject
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_FLAG            objectType,                    // in
+    TSS_FLAG            initFlags,                     // in
+    TSS_HOBJECT*        phObject                       // out
+);
+
+TSPICALL Tspi_Context_CloseObject
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_HOBJECT         hObject                        // in
+);
+
+TSPICALL Tspi_Context_GetCapability
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_FLAG            capArea,                       // in
+    UINT32              ulSubCapLength,                // in
+    BYTE*               rgbSubCap,                     // in
+    UINT32*             pulRespDataLength,             // out
+    BYTE**              prgbRespData                   // out
+);
+
+TSPICALL Tspi_Context_GetTpmObject
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_HTPM*           phTPM                          // out
+);
+
+TSPICALL Tspi_Context_SetTransEncryptionKey
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_HKEY            hKey                           // in
+);
+
+TSPICALL Tspi_Context_CloseSignTransport
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_HKEY            hSigningKey,                   // in
+    TSS_VALIDATION*     pValidationData                // in, out
+);
+
+TSPICALL Tspi_Context_LoadKeyByBlob
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_HKEY            hUnwrappingKey,                // in
+    UINT32              ulBlobLength,                  // in
+    BYTE*               rgbBlobData,                   // in
+    TSS_HKEY*           phKey                          // out
+);
+
+TSPICALL Tspi_Context_LoadKeyByUUID
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_FLAG            persistentStorageType,         // in
+    TSS_UUID            uuidData,                      // in
+    TSS_HKEY*           phKey                          // out
+);
+
+TSPICALL Tspi_Context_RegisterKey
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_HKEY            hKey,                          // in
+    TSS_FLAG            persistentStorageType,         // in
+    TSS_UUID            uuidKey,                       // in
+    TSS_FLAG            persistentStorageTypeParent,   // in
+    TSS_UUID            uuidParentKey                  // in
+);
+
+TSPICALL Tspi_Context_UnregisterKey
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_FLAG            persistentStorageType,         // in
+    TSS_UUID            uuidKey,                       // in
+    TSS_HKEY*           phkey                          // out
+);
+
+TSPICALL Tspi_Context_GetKeyByUUID
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_FLAG            persistentStorageType,         // in
+    TSS_UUID            uuidData,                      // in
+    TSS_HKEY*           phKey                          // out
+);
+
+TSPICALL Tspi_Context_GetKeyByPublicInfo
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_FLAG            persistentStorageType,         // in
+    TSS_ALGORITHM_ID    algID,                         // in
+    UINT32              ulPublicInfoLength,            // in
+    BYTE*               rgbPublicInfo,                 // in
+    TSS_HKEY*           phKey                          // out
+);
+
+TSPICALL Tspi_Context_GetRegisteredKeysByUUID
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_FLAG            persistentStorageType,         // in
+    TSS_UUID*           pUuidData,                     // in
+    UINT32*             pulKeyHierarchySize,           // out
+    TSS_KM_KEYINFO**    ppKeyHierarchy                 // out
+);
+
+TSPICALL Tspi_Context_GetRegisteredKeysByUUID2
+(
+    TSS_HCONTEXT        hContext,                      // in
+    TSS_FLAG            persistentStorageType,         // in
+    TSS_UUID*           pUuidData,                     // in
+    UINT32*             pulKeyHierarchySize,           // out
+    TSS_KM_KEYINFO2**   ppKeyHierarchy                 // out
+);
+
+
+// Policy class definitions
+TSPICALL Tspi_Policy_SetSecret
+(
+    TSS_HPOLICY         hPolicy,                       // in
+    TSS_FLAG            secretMode,                    // in
+    UINT32              ulSecretLength,                // in
+    BYTE*               rgbSecret                      // in
+);
+
+TSPICALL Tspi_Policy_FlushSecret
+(
+    TSS_HPOLICY         hPolicy                        // in
+);
+
+TSPICALL Tspi_Policy_AssignToObject
+(
+    TSS_HPOLICY         hPolicy,                       // in
+    TSS_HOBJECT         hObject                        // in
+);
+
+
+
+// TPM Class Definitions
+TSPICALL Tspi_TPM_KeyControlOwner
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hKey,                          // in
+    UINT32              attribName,                    // in
+    TSS_BOOL            attribValue,                   // in
+    TSS_UUID*           pUuidData                      // out
+);
+
+TSPICALL Tspi_TPM_CreateEndorsementKey
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hKey,                          // in
+    TSS_VALIDATION*     pValidationData                // in, out
+);
+
+TSPICALL Tspi_TPM_CreateRevocableEndorsementKey
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hKey,                          // in
+    TSS_VALIDATION*     pValidationData,               // in, out
+    UINT32*             pulEkResetDataLength,          // in, out
+    BYTE**              rgbEkResetData                 // in, out
+);
+
+TSPICALL Tspi_TPM_RevokeEndorsementKey
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulEkResetDataLength,           // in
+    BYTE*               rgbEkResetData                 // in
+);
+
+TSPICALL Tspi_TPM_GetPubEndorsementKey
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_BOOL            fOwnerAuthorized,              // in
+    TSS_VALIDATION*     pValidationData,               // in, out
+    TSS_HKEY*           phEndorsementPubKey            // out
+);
+
+TSPICALL Tspi_TPM_OwnerGetSRKPubKey
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32*             pulPubKeyLength,               // out
+    BYTE**              prgbPubKey                     // out
+);
+
+TSPICALL Tspi_TPM_TakeOwnership
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hKeySRK,                       // in
+    TSS_HKEY            hEndorsementPubKey             // in
+);
+
+TSPICALL Tspi_TPM_ClearOwner
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_BOOL            fForcedClear                   // in
+);
+
+TSPICALL Tspi_TPM_CollateIdentityRequest
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hKeySRK,                       // in
+    TSS_HKEY            hCAPubKey,                     // in
+    UINT32              ulIdentityLabelLength,         // in
+    BYTE*               rgbIdentityLabelData,          // in
+    TSS_HKEY            hIdentityKey,                  // in
+    TSS_ALGORITHM_ID    algID,                         // in
+    UINT32*             pulTCPAIdentityReqLength,      // out
+    BYTE**              prgbTCPAIdentityReq            // out
+);
+
+TSPICALL Tspi_TPM_ActivateIdentity
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hIdentKey,                     // in
+    UINT32              ulAsymCAContentsBlobLength,    // in
+    BYTE*               rgbAsymCAContentsBlob,         // in
+    UINT32              ulSymCAAttestationBlobLength,  // in
+    BYTE*               rgbSymCAAttestationBlob,       // in
+    UINT32*             pulCredentialLength,           // out
+    BYTE**              prgbCredential                 // out
+);
+
+TSPICALL Tspi_TPM_CreateMaintenanceArchive
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_BOOL            fGenerateRndNumber,            // in
+    UINT32*             pulRndNumberLength,            // out
+    BYTE**              prgbRndNumber,                 // out
+    UINT32*             pulArchiveDataLength,          // out
+    BYTE**              prgbArchiveData                // out
+);
+
+TSPICALL Tspi_TPM_KillMaintenanceFeature
+(
+    TSS_HTPM            hTPM                           // in
+);
+
+TSPICALL Tspi_TPM_LoadMaintenancePubKey
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hMaintenanceKey,               // in
+    TSS_VALIDATION*     pValidationData                // in, out
+);
+
+TSPICALL Tspi_TPM_CheckMaintenancePubKey
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hMaintenanceKey,               // in
+    TSS_VALIDATION*     pValidationData                // in, out
+);
+
+TSPICALL Tspi_TPM_SetOperatorAuth
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HPOLICY         hOperatorPolicy                // in
+);
+
+TSPICALL Tspi_TPM_SetStatus
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_FLAG            statusFlag,                    // in
+    TSS_BOOL            fTpmState                      // in
+);
+
+TSPICALL Tspi_TPM_GetStatus
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_FLAG            statusFlag,                    // in
+    TSS_BOOL*           pfTpmState                     // out
+);
+
+TSPICALL Tspi_TPM_GetCapability
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_FLAG            capArea,                       // in
+    UINT32              ulSubCapLength,                // in
+    BYTE*               rgbSubCap,                     // in
+    UINT32*             pulRespDataLength,             // out
+    BYTE**              prgbRespData                   // out
+);
+
+TSPICALL Tspi_TPM_GetCapabilitySigned
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hKey,                          // in
+    TSS_FLAG            capArea,                       // in
+    UINT32              ulSubCapLength,                // in
+    BYTE*               rgbSubCap,                     // in
+    TSS_VALIDATION*     pValidationData,               // in, out
+    UINT32*             pulRespDataLength,             // out
+    BYTE**              prgbRespData                   // out
+);
+
+TSPICALL Tspi_TPM_SelfTestFull
+(
+    TSS_HTPM            hTPM                           // in
+);
+
+TSPICALL Tspi_TPM_CertifySelfTest
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hKey,                          // in
+    TSS_VALIDATION*     pValidationData                // in, out
+);
+
+TSPICALL Tspi_TPM_GetTestResult
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32*             pulTestResultLength,           // out
+    BYTE**              prgbTestResult                 // out
+);
+
+TSPICALL Tspi_TPM_GetRandom
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulRandomDataLength,            // in
+    BYTE**              prgbRandomData                 // out
+);
+
+TSPICALL Tspi_TPM_StirRandom
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulEntropyDataLength,           // in
+    BYTE*               rgbEntropyData                 // in
+);
+
+TSPICALL Tspi_TPM_GetEvent
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulPcrIndex,                    // in
+    UINT32              ulEventNumber,                 // in
+    TSS_PCR_EVENT*      pPcrEvent                      // out
+);
+
+TSPICALL Tspi_TPM_GetEvents
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulPcrIndex,                    // in
+    UINT32              ulStartNumber,                 // in
+    UINT32*             pulEventNumber,                // in, out
+    TSS_PCR_EVENT**     prgPcrEvents                   // out
+);
+
+TSPICALL Tspi_TPM_GetEventLog
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32*             pulEventNumber,                // out
+    TSS_PCR_EVENT**     prgPcrEvents                   // out
+);
+
+TSPICALL Tspi_TPM_Quote
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hIdentKey,                     // in
+    TSS_HPCRS           hPcrComposite,                 // in
+    TSS_VALIDATION*     pValidationData                // in, out
+);
+
+TSPICALL Tspi_TPM_Quote2
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hIdentKey,                     // in
+    TSS_BOOL            fAddVersion,                   // in
+    TSS_HPCRS           hPcrComposite,                 // in
+    TSS_VALIDATION*     pValidationData,               // in, out
+    UINT32*             versionInfoSize,               // out
+    BYTE**              versionInfo                    // out
+);
+
+TSPICALL Tspi_TPM_PcrExtend
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulPcrIndex,                    // in
+    UINT32              ulPcrDataLength,               // in
+    BYTE*               pbPcrData,                     // in
+    TSS_PCR_EVENT*      pPcrEvent,                     // in
+    UINT32*             pulPcrValueLength,             // out
+    BYTE**              prgbPcrValue                   // out
+);
+
+TSPICALL Tspi_TPM_PcrRead
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulPcrIndex,                    // in
+    UINT32*             pulPcrValueLength,             // out
+    BYTE**              prgbPcrValue                   // out
+);
+
+TSPICALL Tspi_TPM_PcrReset
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HPCRS           hPcrComposite                  // in
+);
+
+TSPICALL Tspi_TPM_AuthorizeMigrationTicket
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hMigrationKey,                 // in
+    TSS_MIGRATE_SCHEME  migrationScheme,               // in
+    UINT32*             pulMigTicketLength,            // out
+    BYTE**              prgbMigTicket                  // out
+);
+
+TSPICALL Tspi_TPM_CMKSetRestrictions
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_CMK_DELEGATE    CmkDelegate                    // in
+);
+
+TSPICALL Tspi_TPM_CMKApproveMA
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HMIGDATA        hMaAuthData                    // in
+);
+
+TSPICALL Tspi_TPM_CMKCreateTicket
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hVerifyKey,                    // in
+    TSS_HMIGDATA        hSigData                       // in
+);
+
+TSPICALL Tspi_TPM_ReadCounter
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32*             counterValue                   // out
+);
+
+TSPICALL Tspi_TPM_ReadCurrentTicks
+(
+    TSS_HTPM            hTPM,                          // in
+    TPM_CURRENT_TICKS*  tickCount                      // out
+);
+
+TSPICALL Tspi_TPM_DirWrite
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulDirIndex,                    // in
+    UINT32              ulDirDataLength,               // in
+    BYTE*               rgbDirData                     // in
+);
+
+TSPICALL Tspi_TPM_DirRead
+(
+    TSS_HTPM            hTPM,                          // in
+    UINT32              ulDirIndex,                    // in
+    UINT32*             pulDirDataLength,              // out
+    BYTE**              prgbDirData                    // out
+);
+
+TSPICALL Tspi_TPM_Delegate_AddFamily
+(
+    TSS_HTPM            hTPM,                          // in, must not be NULL
+    BYTE                bLabel,                        // in
+    TSS_HDELFAMILY*     phFamily                       // out
+);
+
+TSPICALL Tspi_TPM_Delegate_GetFamily
+(
+    TSS_HTPM            hTPM,                          // in, must not NULL
+    UINT32              ulFamilyID,                    // in
+    TSS_HDELFAMILY*     phFamily                       // out
+);
+
+TSPICALL Tspi_TPM_Delegate_InvalidateFamily
+(
+    TSS_HTPM            hTPM,                          // in, must not be NULL
+    TSS_HDELFAMILY      hFamily                        // in
+);
+
+TSPICALL Tspi_TPM_Delegate_CreateDelegation
+(
+    TSS_HOBJECT         hObject,                       // in
+    BYTE                bLabel,                        // in
+    UINT32              ulFlags,                       // in
+    TSS_HPCRS           hPcr,                          // in, may be NULL
+    TSS_HDELFAMILY      hFamily,                       // in
+    TSS_HPOLICY         hDelegation                    // in, out
+);
+
+TSPICALL Tspi_TPM_Delegate_CacheOwnerDelegation
+(
+    TSS_HTPM            hTPM,                          // in, must not be NULL
+    TSS_HPOLICY         hDelegation,                   // in, out
+    UINT32              ulIndex,                       // in
+    UINT32              ulFlags                        // in
+);
+
+TSPICALL Tspi_TPM_Delegate_UpdateVerificationCount
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HPOLICY         hDelegation                    // in, out
+);
+
+TSPICALL Tspi_TPM_Delegate_VerifyDelegation
+(
+    TSS_HPOLICY         hDelegation                    // in, out
+);
+
+TSPICALL Tspi_TPM_Delegate_ReadTables
+(
+    TSS_HCONTEXT                  hContext,                      // in
+    UINT32*                       pulFamilyTableSize,            // out
+    TSS_FAMILY_TABLE_ENTRY**      ppFamilyTable,                 // out
+    UINT32*                       pulDelegateTableSize,          // out
+    TSS_DELEGATION_TABLE_ENTRY**  ppDelegateTable                // out
+);
+
+TSPICALL Tspi_TPM_DAA_JoinInit
+(
+    TSS_HTPM                      hTPM,                          // in
+    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
+    UINT32                        daaCounter,                    // in
+    UINT32                        issuerAuthPKsLength,           // in
+    TSS_HKEY*                     issuerAuthPKs,                 // in
+    UINT32                        issuerAuthPKSignaturesLength,  // in
+    UINT32                        issuerAuthPKSignaturesLength2, // in
+    BYTE**                        issuerAuthPKSignatures,        // in
+    UINT32*                       capitalUprimeLength,           // out
+    BYTE**                        capitalUprime,                 // out
+    TSS_DAA_IDENTITY_PROOF**      identityProof,                 // out
+    UINT32*                       joinSessionLength,             // out
+    BYTE**                        joinSession                    // out
+);
+
+TSPICALL Tspi_TPM_DAA_JoinCreateDaaPubKey
+(
+    TSS_HTPM                      hTPM,                          // in
+    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
+    UINT32                        authenticationChallengeLength, // in
+    BYTE*                         authenticationChallenge,       // in
+    UINT32                        nonceIssuerLength,             // in
+    BYTE*                         nonceIssuer,                   // in
+    UINT32                        attributesPlatformLength,      // in
+    UINT32                        attributesPlatformLength2,     // in
+    BYTE**                        attributesPlatform,            // in
+    UINT32                        joinSessionLength,             // in
+    BYTE*                         joinSession,                   // in
+    TSS_DAA_CREDENTIAL_REQUEST**  credentialRequest              // out
+);
+
+TSPICALL Tspi_TPM_DAA_JoinStoreCredential
+(
+    TSS_HTPM                      hTPM,                          // in
+    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
+    TSS_DAA_CRED_ISSUER*          credIssuer,                    // in
+    UINT32                        joinSessionLength,             // in
+    BYTE*                         joinSession                    // in
+);
+
+TSPICALL Tspi_TPM_DAA_Sign
+(
+    TSS_HTPM                      hTPM,                          // in
+    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
+    TSS_HDAA_ARA_KEY              hARAKey,                       // in
+    TSS_DAA_SELECTED_ATTRIB*      revealAttributes,              // in
+    UINT32                        verifierNonceLength,           // in
+    BYTE*                         verifierNonce,                 // in
+    UINT32                        verifierBaseNameLength,        // in
+    BYTE*                         verifierBaseName,              // in
+    TSS_HOBJECT                   signData,                      // in
+    TSS_DAA_SIGNATURE**           daaSignature                   // out
+);
+
+TSPICALL Tspi_TPM_GetAuditDigest
+(
+    TSS_HTPM            hTPM,                          // in
+    TSS_HKEY            hKey,                          // in
+    TSS_BOOL            closeAudit,                    // in
+    UINT32*             pulAuditDigestSize,            // out
+    BYTE**              prgbAuditDigest,               // out
+    TPM_COUNTER_VALUE*  pCounterValue,                 // out
+    TSS_VALIDATION*     pValidationData,               // out
+    UINT32*             ordSize,                       // out
+    UINT32**            ordList                        // out
+);
+
+
+
+// PcrComposite Class Definitions
+TSPICALL Tspi_PcrComposite_SelectPcrIndex
+(
+    TSS_HPCRS           hPcrComposite,                 // in
+    UINT32              ulPcrIndex                     // in
+);
+
+TSPICALL Tspi_PcrComposite_SelectPcrIndexEx
+(
+    TSS_HPCRS           hPcrComposite,                 // in
+    UINT32              ulPcrIndex,                    // in
+    UINT32              direction                      // in
+);
+
+TSPICALL Tspi_PcrComposite_SetPcrValue
+(
+    TSS_HPCRS           hPcrComposite,                 // in
+    UINT32              ulPcrIndex,                    // in
+    UINT32              ulPcrValueLength,              // in
+    BYTE*               rgbPcrValue                    // in
+);
+
+TSPICALL Tspi_PcrComposite_GetPcrValue
+(
+    TSS_HPCRS           hPcrComposite,                 // in
+    UINT32              ulPcrIndex,                    // in
+    UINT32*             pulPcrValueLength,             // out
+    BYTE**              prgbPcrValue                   // out
+);
+
+TSPICALL Tspi_PcrComposite_SetPcrLocality
+(
+    TSS_HPCRS           hPcrComposite,                 // in
+    UINT32              LocalityValue                  // in
+);
+
+TSPICALL Tspi_PcrComposite_GetPcrLocality
+(
+    TSS_HPCRS           hPcrComposite,                 // in
+    UINT32*             pLocalityValue                 // out
+);
+
+TSPICALL Tspi_PcrComposite_GetCompositeHash
+(
+    TSS_HPCRS           hPcrComposite,                 // in
+    UINT32*             pLen,                          // in
+    BYTE**              ppbHashData                    // out
+);
+
+
+
+// Key Class Definition
+TSPICALL Tspi_Key_LoadKey
+(
+    TSS_HKEY            hKey,                          // in
+    TSS_HKEY            hUnwrappingKey                 // in
+);
+
+TSPICALL Tspi_Key_UnloadKey
+(
+    TSS_HKEY            hKey                           // in
+);
+
+TSPICALL Tspi_Key_GetPubKey
+(
+    TSS_HKEY            hKey,                          // in
+    UINT32*             pulPubKeyLength,               // out
+    BYTE**              prgbPubKey                     // out
+);
+
+TSPICALL Tspi_Key_CertifyKey
+(
+    TSS_HKEY            hKey,                          // in
+    TSS_HKEY            hCertifyingKey,                // in
+    TSS_VALIDATION*     pValidationData                // in, out
+);
+
+TSPICALL Tspi_Key_CreateKey
+(
+    TSS_HKEY            hKey,                          // in
+    TSS_HKEY            hWrappingKey,                  // in
+    TSS_HPCRS           hPcrComposite                  // in, may be NULL
+);
+
+TSPICALL Tspi_Key_WrapKey
+(
+    TSS_HKEY            hKey,                          // in
+    TSS_HKEY            hWrappingKey,                  // in
+    TSS_HPCRS           hPcrComposite                  // in, may be NULL
+);
+
+TSPICALL Tspi_Key_CreateMigrationBlob
+(
+    TSS_HKEY            hKeyToMigrate,                 // in
+    TSS_HKEY            hParentKey,                    // in
+    UINT32              ulMigTicketLength,             // in
+    BYTE*               rgbMigTicket,                  // in
+    UINT32*             pulRandomLength,               // out
+    BYTE**              prgbRandom,                    // out
+    UINT32*             pulMigrationBlobLength,        // out
+    BYTE**              prgbMigrationBlob              // out
+);
+
+TSPICALL Tspi_Key_ConvertMigrationBlob
+(
+    TSS_HKEY            hKeyToMigrate,                 // in
+    TSS_HKEY            hParentKey,                    // in
+    UINT32              ulRandomLength,                // in
+    BYTE*               rgbRandom,                     // in
+    UINT32              ulMigrationBlobLength,         // in
+    BYTE*               rgbMigrationBlob               // in
+);
+
+TSPICALL Tspi_Key_MigrateKey
+(
+    TSS_HKEY            hMaKey,                        // in
+    TSS_HKEY            hPublicKey,                    // in
+    TSS_HKEY            hMigData                       // in
+);
+
+TSPICALL Tspi_Key_CMKCreateBlob
+(
+    TSS_HKEY            hKeyToMigrate,                 // in
+    TSS_HKEY            hParentKey,                    // in
+    TSS_HMIGDATA        hMigrationData,                // in
+    UINT32*             pulRandomLength,               // out
+    BYTE**              prgbRandom                     // out
+);
+
+TSPICALL Tspi_Key_CMKConvertMigration
+(
+    TSS_HKEY            hKeyToMigrate,                 // in
+    TSS_HKEY            hParentKey,                    // in
+    TSS_HMIGDATA        hMigrationData,                // in
+    UINT32              ulRandomLength,                // in
+    BYTE*               rgbRandom                      // in
+);
+
+
+
+// Hash Class Definition
+TSPICALL Tspi_Hash_Sign
+(
+    TSS_HHASH           hHash,                         // in
+    TSS_HKEY            hKey,                          // in
+    UINT32*             pulSignatureLength,            // out
+    BYTE**              prgbSignature                  // out
+);
+
+TSPICALL Tspi_Hash_VerifySignature
+(
+    TSS_HHASH           hHash,                         // in
+    TSS_HKEY            hKey,                          // in
+    UINT32              ulSignatureLength,             // in
+    BYTE*               rgbSignature                   // in
+);
+
+TSPICALL Tspi_Hash_SetHashValue
+(
+    TSS_HHASH           hHash,                         // in
+    UINT32              ulHashValueLength,             // in
+    BYTE*               rgbHashValue                   // in
+);
+
+TSPICALL Tspi_Hash_GetHashValue
+(
+    TSS_HHASH           hHash,                         // in
+    UINT32*             pulHashValueLength,            // out
+    BYTE**              prgbHashValue                  // out
+);
+
+TSPICALL Tspi_Hash_UpdateHashValue
+(
+    TSS_HHASH           hHash,                         // in
+    UINT32              ulDataLength,                  // in
+    BYTE*               rgbData                        // in
+);
+
+TSPICALL Tspi_Hash_TickStampBlob
+(
+    TSS_HHASH           hHash,                         // in
+    TSS_HKEY            hIdentKey,                     // in
+    TSS_VALIDATION*     pValidationData                // in
+);
+
+
+
+// EncData Class Definition
+TSPICALL Tspi_Data_Bind
+(
+    TSS_HENCDATA        hEncData,                      // in
+    TSS_HKEY            hEncKey,                       // in
+    UINT32              ulDataLength,                  // in
+    BYTE*               rgbDataToBind                  // in
+);
+
+TSPICALL Tspi_Data_Unbind
+(
+    TSS_HENCDATA        hEncData,                      // in
+    TSS_HKEY            hKey,                          // in
+    UINT32*             pulUnboundDataLength,          // out
+    BYTE**              prgbUnboundData                // out
+);
+
+TSPICALL Tspi_Data_Seal
+(
+    TSS_HENCDATA        hEncData,                      // in
+    TSS_HKEY            hEncKey,                       // in
+    UINT32              ulDataLength,                  // in
+    BYTE*               rgbDataToSeal,                 // in
+    TSS_HPCRS           hPcrComposite                  // in
+);
+
+TSPICALL Tspi_Data_Unseal
+(
+    TSS_HENCDATA        hEncData,                      // in
+    TSS_HKEY            hKey,                          // in
+    UINT32*             pulUnsealedDataLength,         // out
+    BYTE**              prgbUnsealedData               // out
+);
+
+
+
+// NV Class Definition
+TSPICALL Tspi_NV_DefineSpace
+(
+    TSS_HNVSTORE        hNVStore,                      // in
+    TSS_HPCRS           hReadPcrComposite,             // in, may be NULL
+    TSS_HPCRS           hWritePcrComposite             // in, may be NULL
+);
+
+TSPICALL Tspi_NV_ReleaseSpace
+(
+    TSS_HNVSTORE        hNVStore                       // in
+);
+
+TSPICALL Tspi_NV_WriteValue
+(
+    TSS_HNVSTORE        hNVStore,                      // in
+    UINT32              offset,                        // in
+    UINT32              ulDataLength,                  // in
+    BYTE*               rgbDataToWrite                 // in
+);
+
+TSPICALL Tspi_NV_ReadValue
+(
+    TSS_HNVSTORE        hNVStore,                      // in
+    UINT32              offset,                        // in
+    UINT32*             ulDataLength,                  // in, out
+    BYTE**              rgbDataRead                    // out
+);
+
+
+// DAA Utility functions (optional, do not require a TPM or TCS)
+TSPICALL Tspi_DAA_IssuerKeyVerify
+(
+    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
+    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
+    TSS_BOOL*                     isCorrect                      // out
+);
+
+TSPICALL Tspi_DAA_Issuer_GenerateKey
+(
+    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
+    UINT32                        issuerBaseNameLength,          // in
+    BYTE*                         issuerBaseName                 // in
+);
+
+TSPICALL Tspi_DAA_Issuer_InitCredential
+(
+    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
+    TSS_HKEY                      issuerAuthPK,                  // in
+    TSS_DAA_IDENTITY_PROOF*       identityProof,                 // in
+    UINT32                        capitalUprimeLength,           // in
+    BYTE*                         capitalUprime,                 // in
+    UINT32                        daaCounter,                    // in
+    UINT32*                       nonceIssuerLength,             // out
+    BYTE**                        nonceIssuer,                   // out
+    UINT32*                       authenticationChallengeLength, // out
+    BYTE**                        authenticationChallenge,       // out
+    UINT32*                       joinSessionLength,             // out
+    BYTE**                        joinSession                    // out
+);
+
+TSPICALL Tspi_DAA_Issuer_IssueCredential
+(
+    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
+    TSS_DAA_CREDENTIAL_REQUEST*   credentialRequest,             // in
+    UINT32                        issuerJoinSessionLength,       // in
+    BYTE*                         issuerJoinSession,             // in
+    TSS_DAA_CRED_ISSUER**         credIssuer                     // out
+);
+
+TSPICALL Tspi_DAA_Verifier_Init
+(
+    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
+    UINT32*                       nonceVerifierLength,           // out
+    BYTE**                        nonceVerifier,                 // out
+    UINT32*                       baseNameLength,                // out
+    BYTE**                        baseName                       // out
+);
+
+TSPICALL Tspi_DAA_VerifySignature
+(
+    TSS_HDAA_CREDENTIAL           hDAACredential,                // in
+    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
+    TSS_HDAA_ARA_KEY              hARAKey,                       // in
+    TSS_HHASH                     hARACondition,                 // in
+    UINT32                        attributesLength,              // in
+    UINT32                        attributesLength2,             // in
+    BYTE**                        attributes,                    // in
+    UINT32                        verifierNonceLength,           // in
+    BYTE*                         verifierNonce,                 // in
+    UINT32                        verifierBaseNameLength,        // in
+    BYTE*                         verifierBaseName,              // in
+    TSS_HOBJECT                   signData,                      // in
+    TSS_DAA_SIGNATURE*            daaSignature,                  // in
+    TSS_BOOL*                     isCorrect                      // out
+);
+
+TSPICALL Tspi_DAA_ARA_GenerateKey
+(
+    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
+    TSS_HDAA_ARA_KEY              hARAKey                        // in
+);
+
+TSPICALL Tspi_DAA_ARA_RevokeAnonymity
+(
+    TSS_HDAA_ARA_KEY              hARAKey,                       // in
+    TSS_HHASH                     hARACondition,                 // in
+    TSS_HDAA_ISSUER_KEY           hIssuerKey,                    // in
+    TSS_DAA_PSEUDONYM_ENCRYPTED*  encryptedPseudonym,            // in
+    TSS_DAA_PSEUDONYM_PLAIN**     pseudonym                      // out
+);
+
+
+
+// Callback typedefs
+typedef TSS_RESULT (*Tspicb_CallbackHMACAuth)
+(
+    PVOID            lpAppData,          // in
+    TSS_HOBJECT      hAuthorizedObject,  // in
+    TSS_BOOL         ReturnOrVerify,     // in
+    UINT32           ulPendingFunction,  // in
+    TSS_BOOL         ContinueUse,        // in
+    UINT32           ulSizeNonces,       // in
+    BYTE*            rgbNonceEven,       // in
+    BYTE*            rgbNonceOdd,        // in
+    BYTE*            rgbNonceEvenOSAP,   // in
+    BYTE*            rgbNonceOddOSAP,    // in
+    UINT32           ulSizeDigestHmac,   // in
+    BYTE*            rgbParamDigest,     // in
+    BYTE*            rgbHmacData         // in, out
+);
+
+typedef TSS_RESULT (*Tspicb_CallbackXorEnc)
+(
+   PVOID            lpAppData,            // in
+   TSS_HOBJECT      hOSAPObject,          // in
+   TSS_HOBJECT      hObject,              // in
+   TSS_FLAG         PurposeSecret,        // in
+   UINT32           ulSizeNonces,         // in
+   BYTE*            rgbNonceEven,         // in
+   BYTE*            rgbNonceOdd,          // in
+   BYTE*            rgbNonceEvenOSAP,     // in
+   BYTE*            rgbNonceOddOSAP,      // in
+   UINT32           ulSizeEncAuth,        // in
+   BYTE*            rgbEncAuthUsage,      // out
+   BYTE*            rgbEncAuthMigration   // out
+);
+
+typedef TSS_RESULT (*Tspicb_CallbackTakeOwnership)
+(
+   PVOID            lpAppData,         // in
+   TSS_HOBJECT      hObject,           // in
+   TSS_HKEY         hObjectPubKey,     // in
+   UINT32           ulSizeEncAuth,     // in
+   BYTE*            rgbEncAuth         // out
+);
+
+typedef TSS_RESULT (*Tspicb_CallbackSealxMask)
+(
+    PVOID            lpAppData,        // in
+    TSS_HKEY         hKey,             // in
+    TSS_HENCDATA     hEncData,         // in
+    TSS_ALGORITHM_ID algID,            // in
+    UINT32           ulSizeNonces,     // in
+    BYTE*            rgbNonceEven,     // in
+    BYTE*            rgbNonceOdd,      // in
+    BYTE*            rgbNonceEvenOSAP, // in
+    BYTE*            rgbNonceOddOSAP,  // in
+    UINT32           ulDataLength,     // in
+    BYTE*            rgbDataToMask,    // in
+    BYTE*            rgbMaskedData     // out
+);
+
+typedef TSS_RESULT (*Tspicb_CallbackChangeAuthAsym)
+(
+   PVOID            lpAppData,        // in
+   TSS_HOBJECT      hObject,          // in
+   TSS_HKEY         hObjectPubKey,    // in
+   UINT32           ulSizeEncAuth,    // in
+   UINT32           ulSizeAuthLink,   // in
+   BYTE*            rgbEncAuth,       // out
+   BYTE*            rgbAuthLink       // out
+);
+
+typedef TSS_RESULT (*Tspicb_CollateIdentity)
+(
+   PVOID            lpAppData,                      // in
+   UINT32           ulTCPAPlainIdentityProofLength, // in
+   BYTE*            rgbTCPAPlainIdentityProof,      // in
+   TSS_ALGORITHM_ID algID,                          // in
+   UINT32           ulSessionKeyLength,             // out
+   BYTE*            rgbSessionKey,                  // out
+   UINT32*          pulTCPAIdentityProofLength,     // out
+   BYTE*            rgbTCPAIdentityProof            // out
+);
+
+
+typedef TSS_RESULT (*Tspicb_ActivateIdentity)
+(
+   PVOID            lpAppData,                    // in
+   UINT32           ulSessionKeyLength,           // in
+   BYTE*            rgbSessionKey,                // in
+   UINT32           ulSymCAAttestationBlobLength, // in
+   BYTE*            rgbSymCAAttestationBlob,      // in
+   UINT32*          pulCredentialLength,          // out
+   BYTE*            rgbCredential                 // out
+);
+
+
+typedef TSS_RESULT (*Tspicb_DAA_Sign)
+(
+    PVOID                        lpAppData,                 // in
+    TSS_HDAA_ISSUER_KEY          daaPublicKey,              // in
+    UINT32                       gammasLength,              // in
+    BYTE**                       gammas,                    // in
+    UINT32                       attributesLength,          // in
+    BYTE**                       attributes,                // in
+    UINT32                       randomAttributesLength,    // in
+    BYTE**                       randomAttributes,          // in
+    UINT32                       attributeCommitmentsLength,// in
+    TSS_DAA_ATTRIB_COMMIT*       attributeCommitments,      // in
+    TSS_DAA_ATTRIB_COMMIT*       attributeCommitmentsProof, // in
+    TSS_DAA_PSEUDONYM_PLAIN*     pseudonym,                 // in
+    TSS_DAA_PSEUDONYM_PLAIN*     pseudonymTilde,            // in
+    TSS_DAA_PSEUDONYM_ENCRYPTED* pseudonymEncrypted,        // in
+    TSS_DAA_PSEUDONYM_ENCRYPTED* pseudonymEncProof,         // in
+    TSS_DAA_SIGN_CALLBACK**      additionalProof            // out
+);
+
+typedef TSS_RESULT (*Tspicb_DAA_VerifySignature)
+(
+    PVOID                        lpAppData,                 // in
+    UINT32                       challengeLength,           // in
+    BYTE*                        challenge,                 // in
+    TSS_DAA_SIGN_CALLBACK*       additionalProof,           // in
+    TSS_HDAA_ISSUER_KEY          daaPublicKey,              // in
+    UINT32                       gammasLength,              // in
+    BYTE**                       gammas,                    // in
+    UINT32                       sAttributesLength,         // in
+    BYTE**                       sAttributes,               // in
+    UINT32                       attributeCommitmentsLength,// in
+    TSS_DAA_ATTRIB_COMMIT*       attributeCommitments,      // in
+    TSS_DAA_ATTRIB_COMMIT*       attributeCommitmentsProof, // in
+    UINT32                       zetaLength,                // in
+    BYTE*                        zeta,                      // in
+    UINT32                       sFLength,                  // in
+    BYTE*                        sF,                        // in
+    TSS_DAA_PSEUDONYM*           pseudonym,                 // in
+    TSS_DAA_PSEUDONYM*           pseudonymProof,            // in
+    TSS_BOOL*                    isCorrect                  // out
+);
+
+
+#if defined ( __cplusplus )
+}
+#endif /* __cplusplus */
+
+
+#endif /* _TSPI_H_ */
diff -ru trousers-0.3.8-orig/src/include/tss/tss_defines.h trousers-0.3.8/src/include/tss/tss_defines.h
--- trousers-0.3.8-orig/src/include/tss/tss_defines.h	2011-12-24 04:05:17.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tss_defines.h	2012-02-14 20:35:05.917770056 +0000
@@ -1,1288 +1,1291 @@
-/*++
- 
-Global defines for TSS.
-
---*/
-
-#ifndef __TSS_DEFINES_H__
-#define __TSS_DEFINES_H__
-
-#include <tss/platform.h>
-#include <tss/tpm.h>
-
-
-//////////////////////////////////////////////////////////////////////////
-// Object types:
-//////////////////////////////////////////////////////////////////////////
-
-//
-// definition of the object types that can be created via CreateObject
-//
-#define   TSS_OBJECT_TYPE_POLICY    (0x01)      // Policy object
-#define   TSS_OBJECT_TYPE_RSAKEY    (0x02)      // RSA-Key object
-#define   TSS_OBJECT_TYPE_ENCDATA   (0x03)      // Encrypted data object
-#define   TSS_OBJECT_TYPE_PCRS      (0x04)      // PCR composite object
-#define   TSS_OBJECT_TYPE_HASH      (0x05)      // Hash object
-#define   TSS_OBJECT_TYPE_DELFAMILY (0x06)      // Delegation Family object
-#define   TSS_OBJECT_TYPE_NV        (0x07)      // NV object
-#define   TSS_OBJECT_TYPE_MIGDATA   (0x08)      // CMK Migration data object
-#define   TSS_OBJECT_TYPE_DAA_CERTIFICATE (0x09) // DAA credential
-#define   TSS_OBJECT_TYPE_DAA_ISSUER_KEY  (0x0a) // DAA cred. issuer keypair
-#define   TSS_OBJECT_TYPE_DAA_ARA_KEY     (0x0b) // DAA anonymity revocation
-                                                 // authority keypair
-
-
-//////////////////////////////////////////////////////////////////////////
-// CreateObject: Flags
-//////////////////////////////////////////////////////////////////////////
-
-
-//************************************
-// Flags for creating RSAKEY object: *
-//************************************
-
-//
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//                                                              |x x|Auth
-//                                                            |x|    Volatility
-//                                                          |x|      Migration
-//                                                  |x x x x|        Type
-//                                          |x x x x|                Size
-//                                      |x x|                        CMK
-//                                |x x x|                            Version
-//              |0 0 0 0 0 0 0 0 0|                                  Reserved
-//  |x x x x x x|                                                    Fixed Type
-//
-
-//  Authorization:
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-//   Never                                                      |0 0|
-//   Always                                                     |0 1|
-//   Private key always                                         |1 0|
-//
-#define   TSS_KEY_NO_AUTHORIZATION            (0x00000000) // no auth needed
-                                                           // for this key
-#define   TSS_KEY_AUTHORIZATION               (0x00000001) // key needs auth
-                                                           // for all ops
-#define   TSS_KEY_AUTHORIZATION_PRIV_USE_ONLY (0x00000002) // key needs auth
-                                                           // for privkey ops,
-                                                           // noauth for pubkey
-
-//
-//  Volatility
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-//   Non Volatile                                             |0|
-//   Volatile                                                 |1|
-//
-#define    TSS_KEY_NON_VOLATILE      (0x00000000)   // Key is non-volatile
-#define    TSS_KEY_VOLATILE          (0x00000004)   // Key is volatile
-
-//
-//  Migration
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-//   Non Migratable                                         |0|
-//   Migratable                                             |1|
-//
-#define   TSS_KEY_NOT_MIGRATABLE     (0x00000000)   // key is not migratable
-#define   TSS_KEY_MIGRATABLE         (0x00000008)   // key is migratable
-
-//
-//  Usage
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-//   Default (Legacy)                               |0 0 0 0|
-//   Signing                                        |0 0 0 1|
-//   Storage                                        |0 0 1 0|
-//   Identity                                       |0 0 1 1|
-//   AuthChange                                     |0 1 0 0|
-//   Bind                                           |0 1 0 1|
-//   Legacy                                         |0 1 1 0|
-//
-#define   TSS_KEY_TYPE_DEFAULT    (0x00000000)   // indicate a default key
-                                                 // (Legacy-Key)
-#define   TSS_KEY_TYPE_SIGNING    (0x00000010)   // indicate a signing key
-#define   TSS_KEY_TYPE_STORAGE    (0x00000020)   // used as storage key
-#define   TSS_KEY_TYPE_IDENTITY   (0x00000030)   // indicate an idendity key
-#define   TSS_KEY_TYPE_AUTHCHANGE (0x00000040)   // indicate an ephemeral key
-#define   TSS_KEY_TYPE_BIND       (0x00000050)   // indicate a key for TPM_Bind
-#define   TSS_KEY_TYPE_LEGACY     (0x00000060)   // indicate a key that can
-                                                 // perform signing and binding
-#define   TSS_KEY_TYPE_MIGRATE    (0x00000070)   // indicate a key that can
-                                                 // act as a CMK MA
-#define   TSS_KEY_TYPE_BITMASK    (0x000000F0)   // mask to extract key type
-
-//
-//  Key size
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-// DEFAULT                                  |0 0 0 0|
-//   512                                    |0 0 0 1|
-//  1024                                    |0 0 1 0|
-//  2048                                    |0 0 1 1|
-//  4096                                    |0 1 0 0|
-//  8192                                    |0 1 0 1|
-// 16384                                    |0 1 1 0|
-//
-#define TSS_KEY_SIZE_DEFAULT (UINT32)(0x00000000) // indicate tpm-specific size
-#define TSS_KEY_SIZE_512     (UINT32)(0x00000100) // indicate a 512-bit key
-#define TSS_KEY_SIZE_1024    (UINT32)(0x00000200) // indicate a 1024-bit key
-#define TSS_KEY_SIZE_2048    (UINT32)(0x00000300) // indicate a 2048-bit key
-#define TSS_KEY_SIZE_4096    (UINT32)(0x00000400) // indicate a 4096-bit key
-#define TSS_KEY_SIZE_8192    (UINT32)(0x00000500) // indicate a 8192-bit key
-#define TSS_KEY_SIZE_16384   (UINT32)(0x00000600) // indicate a 16384-bit key
-#define TSS_KEY_SIZE_BITMASK (UINT32)(0x00000F00) // mask to extract key size
-
-//
-//  Certified Migratability
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-// DEFAULT                              |0 0|
-// Not Certified Migratable             |0 0|
-// Certified Migratable                 |0 1|
-//
-#define TSS_KEY_NOT_CERTIFIED_MIGRATABLE (UINT32)(0x00000000)
-#define TSS_KEY_CERTIFIED_MIGRATABLE     (UINT32)(0x00001000)
-
-//
-//  Specification version
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-// Context default                |0 0 0|
-// TPM_KEY 1.1b key               |0 0 1|
-// TPM_KEY12 1.2 key              |0 1 0|
-//
-#define TSS_KEY_STRUCT_DEFAULT            (UINT32)(0x00000000)
-#define TSS_KEY_STRUCT_KEY                (UINT32)(0x00004000)
-#define TSS_KEY_STRUCT_KEY12              (UINT32)(0x00008000)
-#define TSS_KEY_STRUCT_BITMASK            (UINT32)(0x0001C000)
-
-
-//
-//  fixed KeyTypes (templates)
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-//  |0 0 0 0 0 0|                             Empty Key
-//  |0 0 0 0 0 1|                             Storage Root Key
-//
-#define   TSS_KEY_EMPTY_KEY (0x00000000) // no TPM key template
-                                         // (empty TSP key object)
-#define   TSS_KEY_TSP_SRK   (0x04000000) // use a TPM SRK template
-                                         // (TSP key object for SRK)
-#define   TSS_KEY_TEMPLATE_BITMASK (0xFC000000) // bitmask to extract key
-                                                // template
-
-
-//*************************************
-// Flags for creating ENCDATA object: *
-//*************************************
-
-//
-//  Type
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-//   Seal                                                     |0 0 1|
-//   Bind                                                     |0 1 0|
-//   Legacy                                                   |0 1 1|
-//
-//   ENCDATA Reserved:
-//  |x x x x x x x x x x x x x x x x x x x x x x x x x x x x x|
-//
-#define   TSS_ENCDATA_SEAL     (0x00000001)   // data for seal operation
-#define   TSS_ENCDATA_BIND     (0x00000002)   // data for bind operation
-#define   TSS_ENCDATA_LEGACY   (0x00000003)   // data for legacy bind operation
-
-
-//**********************************
-// Flags for creating HASH object: *
-//**********************************
-
-//
-//  Algorithm
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-//   DEFAULT               
-//  |0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0|
-//   SHA1
-//  |0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1|
-//   OTHER
-//  |1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1|
-//
-#define   TSS_HASH_DEFAULT    (0x00000000)   // Default hash algorithm
-#define   TSS_HASH_SHA1       (0x00000001)   // SHA-1 with 20 bytes
-#define   TSS_HASH_OTHER      (0xFFFFFFFF)   // Not-specified hash algorithm
-
-
-//************************************
-// Flags for creating POLICY object: *
-//************************************
-
-//
-//  Type
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//
-//   Usage                                                    |0 0 1|
-//   Migration                                                |0 1 0|
-//   Operator                                                 |0 1 1|
-//
-//   POLICY Reserved:
-//  |x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x|
-
-#define   TSS_POLICY_USAGE         (0x00000001)   // usage policy object
-#define   TSS_POLICY_MIGRATION     (0x00000002)   // migration policy object
-#define   TSS_POLICY_OPERATOR      (0x00000003)   // migration policy object
-
-
-//******************************************
-// Flags for creating PCRComposite object: *
-//******************************************
-
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-//                                                              |x x| Struct
-//  |x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x|     Reserved
-//
-
-//  PCRComposite Version:
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//   ---------------------------------------------------------------
-// TPM_PCR_DEFAULT                                            |0 0 0|
-// TPM_PCR_INFO                                               |0 0 1|
-// TPM_PCR_INFO_LONG                                          |0 1 0|
-// TPM_PCR_INFO_SHORT                                         |0 1 1|
-//
-
-#define   TSS_PCRS_STRUCT_DEFAULT    (0x00000000) // depends on context
-#define   TSS_PCRS_STRUCT_INFO       (0x00000001) // TPM_PCR_INFO
-#define   TSS_PCRS_STRUCT_INFO_LONG  (0x00000002) // TPM_PCR_INFO_LONG
-#define   TSS_PCRS_STRUCT_INFO_SHORT (0x00000003) // TPM_PCR_INFO_SHORT
-
-
-
-//////////////////////////////////////////////////////////////////////////
-// Attribute Flags, Subflags, and Values
-//////////////////////////////////////////////////////////////////////////
-
-
-//******************
-// Context object: *
-//******************
-
-//
-// Attributes
-//
-#define TSS_TSPATTRIB_CONTEXT_SILENT_MODE        (0x00000001)
-                                                    // dialog display control
-#define TSS_TSPATTRIB_CONTEXT_MACHINE_NAME       (0x00000002)
-                                                    // remote machine name
-#define TSS_TSPATTRIB_CONTEXT_VERSION_MODE       (0x00000003)
-                                                    // context version
-#define TSS_TSPATTRIB_CONTEXT_TRANSPORT          (0x00000004)
-                                                    // transport control
-#define TSS_TSPATTRIB_CONTEXT_CONNECTION_VERSION (0x00000005)
-                                                    // connection version
-#define TSS_TSPATTRIB_SECRET_HASH_MODE           (0x00000006)
-                                                    // flag indicating whether
-                                                    // NUL is included in the
-                                                    // hash of the password
-//
-// SubFlags for Flag TSS_TSPATTRIB_CONTEXT_TRANSPORT
-//
-#define   TSS_TSPATTRIB_CONTEXTTRANS_CONTROL   (0x00000008)
-#define   TSS_TSPATTRIB_CONTEXTTRANS_MODE      (0x00000010)
-
-//
-// Values for the TSS_TSPATTRIB_CONTEXT_SILENT_MODE attribute
-//
-#define   TSS_TSPATTRIB_CONTEXT_NOT_SILENT (0x00000000) // TSP dialogs enabled
-#define   TSS_TSPATTRIB_CONTEXT_SILENT     (0x00000001) // TSP dialogs disabled
-
-//
-// Values for the TSS_TSPATTRIB_CONTEXT_VERSION_MODE attribute
-//
-#define   TSS_TSPATTRIB_CONTEXT_VERSION_AUTO (0x00000001)
-#define   TSS_TSPATTRIB_CONTEXT_VERSION_V1_1 (0x00000002)
-#define   TSS_TSPATTRIB_CONTEXT_VERSION_V1_2 (0x00000003)
-
-//
-// Values for the subflag TSS_TSPATTRIB_CONTEXT_TRANS_CONTROL
-//
-#define   TSS_TSPATTRIB_DISABLE_TRANSPORT      (0x00000016)
-#define   TSS_TSPATTRIB_ENABLE_TRANSPORT       (0x00000032)
-
-//
-// Values for the subflag TSS_TSPATTRIB_CONTEXT_TRANS_MODE
-//
-#define   TSS_TSPATTRIB_TRANSPORT_NO_DEFAULT_ENCRYPTION (0x00000000)
-#define   TSS_TSPATTRIB_TRANSPORT_DEFAULT_ENCRYPTION    (0x00000001)
-#define   TSS_TSPATTRIB_TRANSPORT_AUTHENTIC_CHANNEL     (0x00000002)
-#define   TSS_TSPATTRIB_TRANSPORT_EXCLUSIVE             (0x00000004)
-#define   TSS_TSPATTRIB_TRANSPORT_STATIC_AUTH           (0x00000008)
-
-//
-// Values for the TSS_TSPATTRIB_CONTEXT_CONNECTION_VERSION attribute
-//
-#define TSS_CONNECTION_VERSION_1_1                      (0x00000001)
-#define TSS_CONNECTION_VERSION_1_2                      (0x00000002)
-
-
-//
-// Subflags of TSS_TSPATTRIB_SECRET_HASH_MODE
-//
-#define TSS_TSPATTRIB_SECRET_HASH_MODE_POPUP     (0x00000001)
-
-//
-// Values for TSS_TSPATTRIB_SECRET_HASH_MODE_POPUP subflag
-//
-#define TSS_TSPATTRIB_HASH_MODE_NOT_NULL         (0x00000000)
-#define TSS_TSPATTRIB_HASH_MODE_NULL             (0x00000001)
-
-
-// *************
-// TPM object: *
-// *************
-
-//
-// Attributes:
-//
-#define TSS_TSPATTRIB_TPM_CALLBACK_COLLATEIDENTITY  0x00000001
-#define TSS_TSPATTRIB_TPM_CALLBACK_ACTIVATEIDENTITY 0x00000002
-#define TSS_TSPATTRIB_TPM_ORDINAL_AUDIT_STATUS      0x00000003
-#define TSS_TSPATTRIB_TPM_CREDENTIAL                0x00001000
-
-//
-// Subflags for TSS_TSPATTRIB_TPM_ORDINAL_AUDIT_STATUS
-//
-#define TPM_CAP_PROP_TPM_CLEAR_ORDINAL_AUDIT        0x00000000
-#define TPM_CAP_PROP_TPM_SET_ORDINAL_AUDIT          0x00000001
-
-//
-// Subflags for TSS_TSPATTRIB_TPM_CREDENTIAL
-//
-#define TSS_TPMATTRIB_EKCERT                        0x00000001
-#define TSS_TPMATTRIB_TPM_CC                        0x00000002
-#define TSS_TPMATTRIB_PLATFORMCERT                  0x00000003
-#define TSS_TPMATTRIB_PLATFORM_CC                   0x00000004
-
-
-//*****************
-// Policy object: *
-//*****************
-
-//
-// Attributes
-//
-#define TSS_TSPATTRIB_POLICY_CALLBACK_HMAC           (0x00000080)
-                                        // enable/disable callback function
-
-#define TSS_TSPATTRIB_POLICY_CALLBACK_XOR_ENC        (0x00000100)
-                                        // enable/disable callback function
-
-#define TSS_TSPATTRIB_POLICY_CALLBACK_TAKEOWNERSHIP  (0x00000180)
-                                        // enable/disable callback function
-
-#define TSS_TSPATTRIB_POLICY_CALLBACK_CHANGEAUTHASYM (0x00000200)
-                                        // enable/disable callback function
-
-#define TSS_TSPATTRIB_POLICY_SECRET_LIFETIME         (0x00000280)
-                                        // set lifetime mode for policy secret
-
-#define TSS_TSPATTRIB_POLICY_POPUPSTRING             (0x00000300)
-                                        // set a NULL terminated UNICODE string
-                                        // which is displayed in the TSP policy
-                                        // popup dialog
-#define TSS_TSPATTRIB_POLICY_CALLBACK_SEALX_MASK     (0x00000380)
-                                        // enable/disable callback function
-#if 0
-/* This attribute flag is defined earlier with the context attributes.
- * It is valid for both context and policy objects. It is copied
- * here as a reminder to avoid collisions.
- */
-#define TSS_TSPATTRIB_SECRET_HASH_MODE               (0x00000006)
-                                                    // flag indicating whether
-                                                    // NUL is included in the
-                                                    // hash of the password
-#endif
-
-
-#define TSS_TSPATTRIB_POLICY_DELEGATION_INFO         (0x00000001)
-#define TSS_TSPATTRIB_POLICY_DELEGATION_PCR          (0x00000002)
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_POLICY_SECRET_LIFETIME
-//
-#define TSS_SECRET_LIFETIME_ALWAYS  (0x00000001) // secret will not be
-                                                 // invalidated
-#define TSS_SECRET_LIFETIME_COUNTER (0x00000002) // secret lifetime
-                                                 // controlled by counter
-#define TSS_SECRET_LIFETIME_TIMER   (0x00000003) // secret lifetime
-                                                 // controlled by time
-#define TSS_TSPATTRIB_POLSECRET_LIFETIME_ALWAYS  TSS_SECRET_LIFETIME_ALWAYS
-#define TSS_TSPATTRIB_POLSECRET_LIFETIME_COUNTER TSS_SECRET_LIFETIME_COUNTER
-#define TSS_TSPATTRIB_POLSECRET_LIFETIME_TIMER   TSS_SECRET_LIFETIME_TIMER
-
-// Alternate names misspelled in the 1.1 TSS spec.
-#define TSS_TSPATTRIB_POLICYSECRET_LIFETIME_ALWAYS  TSS_SECRET_LIFETIME_ALWAYS
-#define TSS_TSPATTRIB_POLICYSECRET_LIFETIME_COUNTER TSS_SECRET_LIFETIME_COUNTER
-#define TSS_TSPATTRIB_POLICYSECRET_LIFETIME_TIMER   TSS_SECRET_LIFETIME_TIMER
-
-//
-// Subflags of TSS_TSPATTRIB_POLICY_DELEGATION_INFO
-//
-#define TSS_TSPATTRIB_POLDEL_TYPE                (0x00000001)
-#define TSS_TSPATTRIB_POLDEL_INDEX               (0x00000002)
-#define TSS_TSPATTRIB_POLDEL_PER1                (0x00000003)
-#define TSS_TSPATTRIB_POLDEL_PER2                (0x00000004)
-#define TSS_TSPATTRIB_POLDEL_LABEL               (0x00000005)
-#define TSS_TSPATTRIB_POLDEL_FAMILYID            (0x00000006)
-#define TSS_TSPATTRIB_POLDEL_VERCOUNT            (0x00000007)
-#define TSS_TSPATTRIB_POLDEL_OWNERBLOB           (0x00000008)
-#define TSS_TSPATTRIB_POLDEL_KEYBLOB             (0x00000009)
-
-//
-// Subflags of TSS_TSPATTRIB_POLICY_DELEGATION_PCR
-//
-#define TSS_TSPATTRIB_POLDELPCR_LOCALITY         (0x00000001)
-#define TSS_TSPATTRIB_POLDELPCR_DIGESTATRELEASE  (0x00000002)
-#define TSS_TSPATTRIB_POLDELPCR_SELECTION        (0x00000003)
-
-//
-// Values for the Policy TSS_TSPATTRIB_POLDEL_TYPE attribute
-//
-#define TSS_DELEGATIONTYPE_NONE                  (0x00000001)
-#define TSS_DELEGATIONTYPE_OWNER                 (0x00000002)
-#define TSS_DELEGATIONTYPE_KEY                   (0x00000003)
-
-
-
-//
-//  Flags used for the 'mode' parameter in Tspi_Policy_SetSecret()
-//
-#define TSS_SECRET_MODE_NONE     (0x00000800) // No authorization will be
-                                              // processed
-#define TSS_SECRET_MODE_SHA1     (0x00001000) // Secret string will not be
-                                              // touched by TSP 
-#define TSS_SECRET_MODE_PLAIN    (0x00001800) // Secret string will be hashed
-                                              // using SHA1
-#define TSS_SECRET_MODE_POPUP    (0x00002000) // TSS SP will ask for a secret
-#define TSS_SECRET_MODE_CALLBACK (0x00002800) // Application has to provide a
-                                              // call back function
-
-
-
-//******************
-// EncData object: *
-//******************
-
-//
-// Attributes
-//
-#define TSS_TSPATTRIB_ENCDATA_BLOB     (0x00000008)
-#define TSS_TSPATTRIB_ENCDATA_PCR      (0x00000010)
-#define TSS_TSPATTRIB_ENCDATA_PCR_LONG (0x00000018)
-#define TSS_TSPATTRIB_ENCDATA_SEAL     (0x00000020)
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_ENCDATA_BLOB
-//
-#define TSS_TSPATTRIB_ENCDATABLOB_BLOB   (0x00000001)   // encrypted data blob
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_ENCDATA_PCR
-//
-#define TSS_TSPATTRIB_ENCDATAPCR_DIGEST_ATCREATION       (0x00000002)
-#define TSS_TSPATTRIB_ENCDATAPCR_DIGEST_ATRELEASE        (0x00000003)
-#define TSS_TSPATTRIB_ENCDATAPCR_SELECTION               (0x00000004)
-// support typo from 1.1 headers
-#define TSS_TSPATTRIB_ENCDATAPCR_DIGEST_RELEASE \
-                          TSS_TSPATTRIB_ENCDATAPCR_DIGEST_ATRELEASE
-
-#define TSS_TSPATTRIB_ENCDATAPCRLONG_LOCALITY_ATCREATION (0x00000005)
-#define TSS_TSPATTRIB_ENCDATAPCRLONG_LOCALITY_ATRELEASE  (0x00000006)
-#define TSS_TSPATTRIB_ENCDATAPCRLONG_CREATION_SELECTION  (0x00000007)
-#define TSS_TSPATTRIB_ENCDATAPCRLONG_RELEASE_SELECTION   (0x00000008)
-#define TSS_TSPATTRIB_ENCDATAPCRLONG_DIGEST_ATCREATION   (0x00000009)
-#define TSS_TSPATTRIB_ENCDATAPCRLONG_DIGEST_ATRELEASE    (0x0000000A)
-
-
-//
-// Attribute subflags TSS_TSPATTRIB_ENCDATA_SEAL
-//
-#define TSS_TSPATTRIB_ENCDATASEAL_PROTECT_MODE           (0x00000001)
-
-//
-// Attribute values for 
-//    TSS_TSPATTRIB_ENCDATA_SEAL/TSS_TSPATTRIB_ENCDATASEAL_PROTECT_MODE
-//
-#define  TSS_TSPATTRIB_ENCDATASEAL_NOPROTECT             (0x00000000)
-#define  TSS_TSPATTRIB_ENCDATASEAL_PROTECT               (0x00000001)
-
-// Accounting for typos in original header files
-#define  TSS_TSPATTRIB_ENCDATASEAL_NO_PROTECT                                \
-                                           TSS_TSPATTRIB_ENCDATASEAL_NOPROTECT
-
-//*************
-// NV object: *
-//*************
-
-//
-// Attributes
-//
-#define TSS_TSPATTRIB_NV_INDEX                     (0x00000001)
-#define TSS_TSPATTRIB_NV_PERMISSIONS               (0x00000002)
-#define TSS_TSPATTRIB_NV_STATE                     (0x00000003)
-#define TSS_TSPATTRIB_NV_DATASIZE                  (0x00000004)
-#define TSS_TSPATTRIB_NV_PCR                       (0x00000005)
-
-#define TSS_TSPATTRIB_NVSTATE_READSTCLEAR          (0x00100000)
-#define TSS_TSPATTRIB_NVSTATE_WRITESTCLEAR         (0x00200000)
-#define TSS_TSPATTRIB_NVSTATE_WRITEDEFINE          (0x00300000)
-
-#define TSS_TSPATTRIB_NVPCR_READPCRSELECTION       (0x01000000)
-#define TSS_TSPATTRIB_NVPCR_READDIGESTATRELEASE    (0x02000000)
-#define TSS_TSPATTRIB_NVPCR_READLOCALITYATRELEASE  (0x03000000)
-#define TSS_TSPATTRIB_NVPCR_WRITEPCRSELECTION      (0x04000000)
-#define TSS_TSPATTRIB_NVPCR_WRITEDIGESTATRELEASE   (0x05000000)
-#define TSS_TSPATTRIB_NVPCR_WRITELOCALITYATRELEASE (0x06000000)
-
-/* NV index flags
- *
- * From the TPM spec, Part 2, Section 19.1.
- *
- *        3                   2                   1
- *      1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
- *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
- *     |T|P|U|D| resvd |   Purview     |          Index                |
- *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
- */
-#define TSS_NV_TPM                (0x80000000) // TPM mfr reserved bit
-#define TSS_NV_PLATFORM           (0x40000000) // Platform mfr reserved bit
-#define TSS_NV_USER               (0x20000000) // User reserved bit
-#define TSS_NV_DEFINED            (0x10000000) // "Defined permanently" flag
-#define TSS_NV_MASK_TPM           (0x80000000) // mask to extract 'T'
-#define TSS_NV_MASK_PLATFORM      (0x40000000) // mask to extract 'P'
-#define TSS_NV_MASK_USER          (0x20000000) // mask to extract 'U'
-#define TSS_NV_MASK_DEFINED       (0x10000000) // mask to extract 'D'
-#define TSS_NV_MASK_RESERVED      (0x0f000000) // mask to extract reserved bits
-#define TSS_NV_MASK_PURVIEW       (0x00ff0000) // mask to extract purview byte
-#define TSS_NV_MASK_INDEX         (0x0000ffff) // mask to extract index byte
-
-// This is the index of the NV storage area where the number of sessions
-// per locality is stored.
-#define TSS_NV_INDEX_SESSIONS     (0x00011101)
-
-
-//******************
-// MigData object: *
-//******************
-
-//
-// Attributes
-//
-#define TSS_MIGATTRIB_MIGRATIONBLOB                    (0x00000010)
-#define TSS_MIGATTRIB_MIGRATIONTICKET                  (0x00000020)
-#define TSS_MIGATTRIB_AUTHORITY_DATA                   (0x00000030)
-#define TSS_MIGATTRIB_MIG_AUTH_DATA                    (0x00000040)
-#define TSS_MIGATTRIB_TICKET_DATA                      (0x00000050)
-#define TSS_MIGATTRIB_PAYLOAD_TYPE                     (0x00000060)
-
-//
-// Attribute subflags TSS_MIGATTRIB_MIGRATIONBLOB
-//
-#define TSS_MIGATTRIB_MIGRATION_XOR_BLOB               (0x00000101)
-#define TSS_MIGATTRIB_MIGRATION_REWRAPPED_BLOB         (0x00000102)
-#define TSS_MIGATTRIB_MIG_MSALIST_PUBKEY_BLOB          (0x00000103)
-#define TSS_MIGATTRIB_MIG_AUTHORITY_PUBKEY_BLOB        (0x00000104)
-#define TSS_MIGATTRIB_MIG_DESTINATION_PUBKEY_BLOB      (0x00000105)
-#define TSS_MIGATTRIB_MIG_SOURCE_PUBKEY_BLOB           (0x00000106)
-#define TSS_MIGATTRIB_MIG_REWRAPPED_BLOB               TSS_MIGATTRIB_MIGRATION_REWRAPPED_BLOB
-#define TSS_MIGATTRIB_MIG_XOR_BLOB                     TSS_MIGATTRIB_MIGRATION_XOR_BLOB
-
-//
-// Attribute subflags TSS_MIGATTRIB_MIGRATIONTICKET
-//
-// none
-
-//
-// Attribute subflags TSS_MIGATTRIB_AUTHORITY_DATA
-//
-#define TSS_MIGATTRIB_AUTHORITY_DIGEST                 (0x00000301)
-#define TSS_MIGATTRIB_AUTHORITY_APPROVAL_HMAC          (0x00000302)
-#define TSS_MIGATTRIB_AUTHORITY_MSALIST                (0x00000303)
-
-//
-// Attribute subflags TSS_MIGATTRIB_MIG_AUTH_DATA
-//
-#define TSS_MIGATTRIB_MIG_AUTH_AUTHORITY_DIGEST        (0x00000401)
-#define TSS_MIGATTRIB_MIG_AUTH_DESTINATION_DIGEST      (0x00000402)
-#define TSS_MIGATTRIB_MIG_AUTH_SOURCE_DIGEST           (0x00000403)
-
-//
-// Attribute subflags TSS_MIGATTRIB_TICKET_DATA
-//
-#define TSS_MIGATTRIB_TICKET_SIG_DIGEST                (0x00000501)
-#define TSS_MIGATTRIB_TICKET_SIG_VALUE                 (0x00000502)
-#define TSS_MIGATTRIB_TICKET_SIG_TICKET                (0x00000503)
-#define TSS_MIGATTRIB_TICKET_RESTRICT_TICKET           (0x00000504)
-
-//
-// Attribute subflags TSS_MIGATTRIB_PAYLOAD_TYPE
-//
-#define TSS_MIGATTRIB_PT_MIGRATE_RESTRICTED            (0x00000601)
-#define TSS_MIGATTRIB_PT_MIGRATE_EXTERNAL              (0x00000602)
-
-
-
-
-//***************
-// Hash object: *
-//***************
-
-//
-// Attributes
-//
-#define TSS_TSPATTRIB_HASH_IDENTIFIER (0x00001000) // Hash algorithm identifier
-#define TSS_TSPATTRIB_ALG_IDENTIFIER  (0x00002000) // ASN.1 alg identifier
-
-
-
-//***************
-// PCRs object: *
-//***************
-
-//
-// Attributes
-//
-#define TSS_TSPATTRIB_PCRS_INFO  (0x00000001) // info 
-
-//
-// Subflags for TSS_TSPATTRIB_PCRS_INFO flag
-//
-#define TSS_TSPATTRIB_PCRSINFO_PCRSTRUCT (0x00000001) // type of pcr struct
-                                                      // TSS_PCRS_STRUCT_TYPE_XX
-
-//****************************
-// Delegation Family object: *
-//****************************
-
-//
-// Attributes
-//
-#define TSS_TSPATTRIB_DELFAMILY_STATE            (0x00000001)
-#define TSS_TSPATTRIB_DELFAMILY_INFO             (0x00000002)
-
-// DELFAMILY_STATE sub-attributes
-#define TSS_TSPATTRIB_DELFAMILYSTATE_LOCKED      (0x00000001)
-#define TSS_TSPATTRIB_DELFAMILYSTATE_ENABLED     (0x00000002)
-
-// DELFAMILY_INFO sub-attributes
-#define TSS_TSPATTRIB_DELFAMILYINFO_LABEL        (0x00000003)
-#define TSS_TSPATTRIB_DELFAMILYINFO_VERCOUNT     (0x00000004)
-#define TSS_TSPATTRIB_DELFAMILYINFO_FAMILYID     (0x00000005)
-
-// Bitmasks for the 'ulFlags' argument to Tspi_TPM_Delegate_CreateDelegation.
-// Only one bit used for now.
-#define TSS_DELEGATE_INCREMENTVERIFICATIONCOUNT               ((UINT32)1)
-
-// Bitmasks for the 'ulFlags' argument to
-// Tspi_TPM_Delegate_CacheOwnerDelegation. Only 1 bit is used for now.
-#define TSS_DELEGATE_CACHEOWNERDELEGATION_OVERWRITEEXISTING   ((UINT32)1)
-
-
-
-//*************************
-// DAA Credential Object: *
-//*************************
-
-//
-// Attribute flags
-//
-#define TSS_TSPATTRIB_DAACRED_COMMIT                   (0x00000001)
-#define TSS_TSPATTRIB_DAACRED_ATTRIB_GAMMAS            (0x00000002)
-#define TSS_TSPATTRIB_DAACRED_CREDENTIAL_BLOB          (0x00000003)
-#define TSS_TSPATTRIB_DAACRED_CALLBACK_SIGN            (0x00000004)
-#define TSS_TSPATTRIB_DAACRED_CALLBACK_VERIFYSIGNATURE (0x00000005)
-
-//
-// Subflags for TSS_TSPATTRIB_DAACRED_COMMIT
-// 
-#define TSS_TSPATTRIB_DAACOMMIT_NUMBER              (0x00000001)
-#define TSS_TSPATTRIB_DAACOMMIT_SELECTION           (0x00000002)
-#define TSS_TSPATTRIB_DAACOMMIT_COMMITMENTS         (0x00000003)
-
-//
-// Subflags for TSS_TSPATTRIB_DAACRED_ATTRIB_GAMMAS
-// 
-#define TSS_TSPATTRIB_DAAATTRIBGAMMAS_BLOB          (0xffffffff)
-
-
-
-//*************************
-// DAA Issuer Key Object: *
-//*************************
-
-//
-// Attribute flags
-//
-#define TSS_TSPATTRIB_DAAISSUERKEY_BLOB              (0x00000001)
-#define TSS_TSPATTRIB_DAAISSUERKEY_PUBKEY            (0x00000002)
-
-//
-// Subflags for TSS_TSPATTRIB_DAAISSUERKEY_BLOB
-// 
-#define TSS_TSPATTRIB_DAAISSUERKEYBLOB_PUBLIC_KEY     (0x00000001)
-#define TSS_TSPATTRIB_DAAISSUERKEYBLOB_SECRET_KEY     (0x00000002)
-#define TSS_TSPATTRIB_DAAISSUERKEYBLOB_KEYBLOB        (0x00000003)
-#define TSS_TSPATTRIB_DAAISSUERKEYBLOB_PROOF          (0x00000004)
-
-//
-// Subflags for TSS_TSPATTRIB_DAAISSUERKEY_PUBKEY
-// 
-#define TSS_TSPATTRIB_DAAISSUERKEYPUBKEY_NUM_ATTRIBS          (0x00000001)
-#define TSS_TSPATTRIB_DAAISSUERKEYPUBKEY_NUM_PLATFORM_ATTRIBS (0x00000002)
-#define TSS_TSPATTRIB_DAAISSUERKEYPUBKEY_NUM_ISSUER_ATTRIBS   (0x00000003)
-
-
-
-//***************************************
-// DAA Anonymity Revocation Key Object: *
-//***************************************
-
-//
-// Attribute flags
-//
-#define TSS_TSPATTRIB_DAAARAKEY_BLOB                 (0x00000001)
-
-//
-// Subflags for TSS_TSPATTRIB_DAAARAKEY_BLOB
-// 
-#define TSS_TSPATTRIB_DAAARAKEYBLOB_PUBLIC_KEY     (0x00000001)
-#define TSS_TSPATTRIB_DAAARAKEYBLOB_SECRET_KEY     (0x00000002)
-#define TSS_TSPATTRIB_DAAARAKEYBLOB_KEYBLOB        (0x00000003)
-
-
-
-//
-// Structure payload flags for TSS_DAA_PSEUDONYM,
-// (TSS_DAA_PSEUDONYM.payloadFlag)
-//
-#define TSS_FLAG_DAA_PSEUDONYM_PLAIN                 (0x00000000)
-#define TSS_FLAG_DAA_PSEUDONYM_ENCRYPTED             (0x00000001)
-
-
-//**************
-// Key Object: *
-//**************
-
-//
-// Attribute flags
-//
-#define TSS_TSPATTRIB_KEY_BLOB       (0x00000040) // key info as blob data
-#define TSS_TSPATTRIB_KEY_INFO       (0x00000080) // keyparam info as blob data
-#define TSS_TSPATTRIB_KEY_UUID       (0x000000C0) // key UUID info as blob data
-#define TSS_TSPATTRIB_KEY_PCR        (0x00000100) // composite digest value for
-                                                  // the key
-#define TSS_TSPATTRIB_RSAKEY_INFO    (0x00000140) // public key info
-#define TSS_TSPATTRIB_KEY_REGISTER   (0x00000180) // register location
-#define TSS_TSPATTRIB_KEY_PCR_LONG   (0x000001c0) // PCR_INFO_LONG for the key
-#define TSS_TSPATTRIB_KEY_CONTROLBIT (0x00000200) // key control flags
-#define TSS_TSPATTRIB_KEY_CMKINFO    (0x00000400) // CMK info
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_KEY_BLOB
-//
-#define TSS_TSPATTRIB_KEYBLOB_BLOB        (0x00000008) // key info using the
-                                                       // key blob
-#define TSS_TSPATTRIB_KEYBLOB_PUBLIC_KEY  (0x00000010) // public key info
-                                                       // using the blob
-#define TSS_TSPATTRIB_KEYBLOB_PRIVATE_KEY (0x00000028) // encrypted private key
-                                                       // blob
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_KEY_INFO
-//
-#define TSS_TSPATTRIB_KEYINFO_SIZE          (0x00000080) // key size in bits
-#define TSS_TSPATTRIB_KEYINFO_USAGE         (0x00000100) // key usage info
-#define TSS_TSPATTRIB_KEYINFO_KEYFLAGS      (0x00000180) // key flags   
-#define TSS_TSPATTRIB_KEYINFO_AUTHUSAGE     (0x00000200) // key auth usage info
-#define TSS_TSPATTRIB_KEYINFO_ALGORITHM     (0x00000280) // key algorithm ID
-#define TSS_TSPATTRIB_KEYINFO_SIGSCHEME     (0x00000300) // key sig scheme
-#define TSS_TSPATTRIB_KEYINFO_ENCSCHEME     (0x00000380) // key enc scheme   
-#define TSS_TSPATTRIB_KEYINFO_MIGRATABLE    (0x00000400) // if true then key is
-                                                         // migratable
-#define TSS_TSPATTRIB_KEYINFO_REDIRECTED    (0x00000480) // key is redirected
-#define TSS_TSPATTRIB_KEYINFO_VOLATILE      (0x00000500) // if true key is
-                                                         // volatile
-#define TSS_TSPATTRIB_KEYINFO_AUTHDATAUSAGE (0x00000580) // if true auth is
-                                                         // required
-#define TSS_TSPATTRIB_KEYINFO_VERSION       (0x00000600) // version info as TSS
-                                                         // version struct
-#define TSS_TSPATTRIB_KEYINFO_CMK           (0x00000680) // if true then key
-                                                         // is certified
-                                                         // migratable
-#define TSS_TSPATTRIB_KEYINFO_KEYSTRUCT     (0x00000700) // type of key struct
-                                                         // used for this key
-                                                         // (TPM_KEY or 
-                                                         // TPM_KEY12)
-#define TSS_TSPATTRIB_KEYCONTROL_OWNEREVICT (0x00000780) // Get current status
-							 // of owner evict flag
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_RSAKEY_INFO
-//
-#define TSS_TSPATTRIB_KEYINFO_RSA_EXPONENT  (0x00001000)
-#define TSS_TSPATTRIB_KEYINFO_RSA_MODULUS   (0x00002000)
-#define TSS_TSPATTRIB_KEYINFO_RSA_KEYSIZE   (0x00003000)
-#define TSS_TSPATTRIB_KEYINFO_RSA_PRIMES    (0x00004000)
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_KEY_PCR
-//
-#define TSS_TSPATTRIB_KEYPCR_DIGEST_ATCREATION  (0x00008000)
-#define TSS_TSPATTRIB_KEYPCR_DIGEST_ATRELEASE   (0x00010000)
-#define TSS_TSPATTRIB_KEYPCR_SELECTION          (0x00018000)
-
-//
-// SubFlags for TSS_TSPATTRIB_KEY_REGISTER
-//
-#define TSS_TSPATTRIB_KEYREGISTER_USER    (0x02000000)
-#define TSS_TSPATTRIB_KEYREGISTER_SYSTEM  (0x04000000)
-#define TSS_TSPATTRIB_KEYREGISTER_NO      (0x06000000)
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_KEY_PCR_LONG
-//
-#define TSS_TSPATTRIB_KEYPCRLONG_LOCALITY_ATCREATION (0x00040000) /* UINT32 */
-#define TSS_TSPATTRIB_KEYPCRLONG_LOCALITY_ATRELEASE  (0x00080000) /* UINT32 */
-#define TSS_TSPATTRIB_KEYPCRLONG_CREATION_SELECTION  (0x000C0000) /* DATA */
-#define TSS_TSPATTRIB_KEYPCRLONG_RELEASE_SELECTION   (0x00100000) /* DATA */
-#define TSS_TSPATTRIB_KEYPCRLONG_DIGEST_ATCREATION   (0x00140000) /* DATA */
-#define TSS_TSPATTRIB_KEYPCRLONG_DIGEST_ATRELEASE    (0x00180000) /* DATA */
-
-//
-// SubFlags for Flag TSS_TSPATTRIB_KEY_CMKINFO
-//
-#define TSS_TSPATTRIB_KEYINFO_CMK_MA_APPROVAL  (0x00000010)
-#define TSS_TSPATTRIB_KEYINFO_CMK_MA_DIGEST    (0x00000020)
-
-
-//
-// Attribute Values
-//
-
-//
-// key size definitions
-//
-#define TSS_KEY_SIZEVAL_512BIT      (0x0200)
-#define TSS_KEY_SIZEVAL_1024BIT     (0x0400)
-#define TSS_KEY_SIZEVAL_2048BIT     (0x0800)
-#define TSS_KEY_SIZEVAL_4096BIT     (0x1000)
-#define TSS_KEY_SIZEVAL_8192BIT     (0x2000)
-#define TSS_KEY_SIZEVAL_16384BIT    (0x4000)
-
-//
-// key usage definitions
-// Values intentionally moved away from corresponding TPM values to avoid
-// possible misuse
-//
-#define TSS_KEYUSAGE_BIND           (0x00)   
-#define TSS_KEYUSAGE_IDENTITY       (0x01)   
-#define TSS_KEYUSAGE_LEGACY         (0x02)   
-#define TSS_KEYUSAGE_SIGN           (0x03)   
-#define TSS_KEYUSAGE_STORAGE        (0x04)
-#define TSS_KEYUSAGE_AUTHCHANGE     (0x05)
-#define TSS_KEYUSAGE_MIGRATE        (0x06)
-
-//
-// key flag definitions
-//
-#define TSS_KEYFLAG_REDIRECTION          (0x00000001)
-#define TSS_KEYFLAG_MIGRATABLE           (0x00000002)
-#define TSS_KEYFLAG_VOLATILEKEY          (0x00000004)
-#define TSS_KEYFLAG_CERTIFIED_MIGRATABLE (0x00000008)
-
-//
-//  algorithm ID definitions
-//
-//  This table defines the algo id's
-//  Values intentionally moved away from corresponding TPM values to avoid
-//  possible misuse
-//
-#define   TSS_ALG_RSA               (0x20)
-#define   TSS_ALG_DES               (0x21)
-#define   TSS_ALG_3DES              (0x22)
-#define   TSS_ALG_SHA               (0x23)
-#define   TSS_ALG_HMAC              (0x24)
-#define   TSS_ALG_AES128            (0x25)
-#define   TSS_ALG_AES192            (0x26)
-#define   TSS_ALG_AES256            (0x27)
-#define   TSS_ALG_XOR               (0x28)
-#define   TSS_ALG_MGF1              (0x29)
-
-#define   TSS_ALG_AES               TSS_ALG_AES128
-
-// Special values for 
-//   Tspi_Context_GetCapability(TSS_TSPCAP_ALG)
-//   Tspi_Context_GetCapability(TSS_TCSCAP_ALG)
-#define   TSS_ALG_DEFAULT           (0xfe)
-#define   TSS_ALG_DEFAULT_SIZE      (0xff)
-
-
-//
-// key signature scheme definitions
-//
-#define TSS_SS_NONE                 (0x10)
-#define TSS_SS_RSASSAPKCS1V15_SHA1  (0x11)
-#define TSS_SS_RSASSAPKCS1V15_DER   (0x12)
-#define	TSS_SS_RSASSAPKCS1V15_INFO  (0x13)
-
-//
-// key encryption scheme definitions
-//
-#define TSS_ES_NONE                 (0x10)
-#define TSS_ES_RSAESPKCSV15         (0x11)
-#define TSS_ES_RSAESOAEP_SHA1_MGF1  (0x12)
-#define TSS_ES_SYM_CNT              (0x13)
-#define TSS_ES_SYM_OFB              (0x14)
-#define TSS_ES_SYM_CBC_PKCS5PAD     (0x15)
-
-
-//
-// persistent storage registration definitions
-//
-#define TSS_PS_TYPE_USER   (1) // Key is registered persistantly in the user
-                               // storage database.
-#define TSS_PS_TYPE_SYSTEM (2) // Key is registered persistantly in the system
-                               // storage database.
-
-//
-// migration scheme definitions
-// Values intentionally moved away from corresponding TPM values to avoid
-// possible misuse
-//
-#define TSS_MS_MIGRATE                   (0x20)
-#define TSS_MS_REWRAP                    (0x21)
-#define TSS_MS_MAINT                     (0x22)
-#define TSS_MS_RESTRICT_MIGRATE          (0x23)
-#define TSS_MS_RESTRICT_APPROVE_DOUBLE   (0x24)
-#define TSS_MS_RESTRICT_MIGRATE_EXTERNAL (0x25)
-
-//
-// TPM key authorization
-// Values intentionally moved away from corresponding TPM values to avoid
-// possible misuse
-//
-#define TSS_KEYAUTH_AUTH_NEVER         (0x10)
-#define TSS_KEYAUTH_AUTH_ALWAYS        (0x11)
-#define TSS_KEYAUTH_AUTH_PRIV_USE_ONLY (0x12)
-
-
-//
-// Flags for TPM status information (GetStatus and SetStatus)
-//
-#define TSS_TPMSTATUS_DISABLEOWNERCLEAR      (0x00000001) // persistent flag
-#define TSS_TPMSTATUS_DISABLEFORCECLEAR      (0x00000002) // volatile flag
-#define TSS_TPMSTATUS_DISABLED               (0x00000003) // persistent flag
-#define TSS_TPMSTATUS_DEACTIVATED            (0x00000004) // volatile flag
-#define TSS_TPMSTATUS_OWNERSETDISABLE        (0x00000005) // persistent flag
-                                                          // for SetStatus
-                                                          // (disable flag) 
-#define TSS_TPMSTATUS_SETOWNERINSTALL        (0x00000006) // persistent flag
-                                                          // (ownership flag)
-#define TSS_TPMSTATUS_DISABLEPUBEKREAD       (0x00000007) // persistent flag
-#define TSS_TPMSTATUS_ALLOWMAINTENANCE       (0x00000008) // persistent flag
-#define TSS_TPMSTATUS_PHYSPRES_LIFETIMELOCK  (0x00000009) // persistent flag
-#define TSS_TPMSTATUS_PHYSPRES_HWENABLE      (0x0000000A) // persistent flag
-#define TSS_TPMSTATUS_PHYSPRES_CMDENABLE     (0x0000000B) // persistent flag
-#define TSS_TPMSTATUS_PHYSPRES_LOCK          (0x0000000C) // volatile flag
-#define TSS_TPMSTATUS_PHYSPRESENCE           (0x0000000D) // volatile flag
-#define TSS_TPMSTATUS_PHYSICALDISABLE        (0x0000000E) // persistent flag
-                                                          // (SetStatus
-                                                          //  disable flag)
-#define TSS_TPMSTATUS_CEKP_USED              (0x0000000F) // persistent flag
-#define TSS_TPMSTATUS_PHYSICALSETDEACTIVATED (0x00000010) // persistent flag
-                                                          // (deactivated flag)
-#define TSS_TPMSTATUS_SETTEMPDEACTIVATED     (0x00000011) // volatile flag
-                                                          // (deactivated flag)
-#define TSS_TPMSTATUS_POSTINITIALISE         (0x00000012) // volatile flag
-#define TSS_TPMSTATUS_TPMPOST                (0x00000013) // persistent flag
-#define TSS_TPMSTATUS_TPMPOSTLOCK            (0x00000014) // persistent flag
-#define TSS_TPMSTATUS_DISABLEPUBSRKREAD      (0x00000016) // persistent flag
-#define TSS_TPMSTATUS_MAINTENANCEUSED        (0x00000017) // persistent flag
-#define TSS_TPMSTATUS_OPERATORINSTALLED      (0x00000018) // persistent flag
-#define TSS_TPMSTATUS_OPERATOR_INSTALLED     (TSS_TPMSTATUS_OPERATORINSTALLED)
-#define TSS_TPMSTATUS_FIPS                   (0x00000019) // persistent flag
-#define TSS_TPMSTATUS_ENABLEREVOKEEK         (0x0000001A) // persistent flag
-#define TSS_TPMSTATUS_ENABLE_REVOKEEK        (TSS_TPMSTATUS_ENABLEREVOKEEK)
-#define TSS_TPMSTATUS_NV_LOCK                (0x0000001B) // persistent flag
-#define TSS_TPMSTATUS_TPM_ESTABLISHED        (0x0000001C) // persistent flag
-#define TSS_TPMSTATUS_RESETLOCK              (0x0000001D) // volatile flag
-#define TSS_TPMSTATUS_DISABLE_FULL_DA_LOGIC_INFO (0x0000001D) //persistent flag
-
-
-//
-// Capability flag definitions
-//
-// TPM capabilities            
-//
-#define TSS_TPMCAP_ORD                   (0x10)
-#define TSS_TPMCAP_ALG                   (0x11)
-#define TSS_TPMCAP_FLAG                  (0x12)
-#define TSS_TPMCAP_PROPERTY              (0x13)
-#define TSS_TPMCAP_VERSION               (0x14)
-#define TSS_TPMCAP_VERSION_VAL           (0x15)
-#define TSS_TPMCAP_NV_LIST               (0x16)
-#define TSS_TPMCAP_NV_INDEX              (0x17)
-#define TSS_TPMCAP_MFR                   (0x18)
-#define TSS_TPMCAP_SYM_MODE              (0x19)
-#define TSS_TPMCAP_HANDLE                (0x1a)
-#define TSS_TPMCAP_TRANS_ES              (0x1b)
-#define TSS_TPMCAP_AUTH_ENCRYPT          (0x1c)  
-#define TSS_TPMCAP_SET_PERM_FLAGS        (0x1d)  // cf. TPM_SET_PERM_FLAGS
-#define TSS_TPMCAP_SET_VENDOR            (0x1e)  // cf. TPM_SET_VENDOR
-#define TSS_TPMCAP_DA_LOGIC              (0x1f)
-
-//
-// Sub-Capability Flags for TSS_TPMCAP_PROPERTY
-//
-#define TSS_TPMCAP_PROP_PCR                 (0x10)
-#define TSS_TPMCAP_PROP_DIR                 (0x11)
-#define TSS_TPMCAP_PROP_MANUFACTURER        (0x12)
-#define TSS_TPMCAP_PROP_SLOTS               (0x13)
-#define TSS_TPMCAP_PROP_KEYS                TSS_TPMCAP_PROP_SLOTS
-#define TSS_TPMCAP_PROP_FAMILYROWS          (0x14)
-#define TSS_TPMCAP_PROP_DELEGATEROWS        (0x15)
-#define TSS_TPMCAP_PROP_OWNER               (0x16)
-#define TSS_TPMCAP_PROP_MAXKEYS             (0x18)
-#define TSS_TPMCAP_PROP_AUTHSESSIONS        (0x19)
-#define TSS_TPMCAP_PROP_MAXAUTHSESSIONS     (0x1a)
-#define TSS_TPMCAP_PROP_TRANSESSIONS        (0x1b)
-#define TSS_TPMCAP_PROP_MAXTRANSESSIONS     (0x1c)
-#define TSS_TPMCAP_PROP_SESSIONS            (0x1d)
-#define TSS_TPMCAP_PROP_MAXSESSIONS         (0x1e)
-#define TSS_TPMCAP_PROP_CONTEXTS            (0x1f)
-#define TSS_TPMCAP_PROP_MAXCONTEXTS         (0x20)
-#define TSS_TPMCAP_PROP_DAASESSIONS         (0x21)
-#define TSS_TPMCAP_PROP_MAXDAASESSIONS      (0x22)
-#define TSS_TPMCAP_PROP_DAA_INTERRUPT       (0x23)
-#define TSS_TPMCAP_PROP_COUNTERS            (0x24)
-#define TSS_TPMCAP_PROP_MAXCOUNTERS         (0x25)
-#define TSS_TPMCAP_PROP_ACTIVECOUNTER       (0x26)
-#define TSS_TPMCAP_PROP_MIN_COUNTER         (0x27)
-#define TSS_TPMCAP_PROP_TISTIMEOUTS         (0x28)
-#define TSS_TPMCAP_PROP_STARTUPEFFECTS      (0x29)
-#define TSS_TPMCAP_PROP_MAXCONTEXTCOUNTDIST (0x2a)
-#define TSS_TPMCAP_PROP_CMKRESTRICTION      (0x2b)
-#define TSS_TPMCAP_PROP_DURATION            (0x2c)
-#define TSS_TPMCAP_PROP_MAXNVAVAILABLE      (0x2d)
-#define TSS_TPMCAP_PROP_INPUTBUFFERSIZE     (0x2e)
-#define TSS_TPMCAP_PROP_REVISION            (0x2f)
-#define TSS_TPMCAP_PROP_LOCALITIES_AVAIL    (0x32)
-
-//
-// Resource type flags
-// Sub-Capability Flags for TSS_TPMCAP_HANDLE
-//
-#define TSS_RT_KEY                     ((UINT32)0x00000010)
-#define TSS_RT_AUTH                    ((UINT32)0x00000020)
-#define TSS_RT_TRANS                   ((UINT32)0x00000030)
-#define TSS_RT_COUNTER                 ((UINT32)0x00000040)
-
-
-//
-// TSS Core Service Capabilities   
-//
-#define TSS_TCSCAP_ALG                   (0x00000001)
-#define TSS_TCSCAP_VERSION               (0x00000002)
-#define TSS_TCSCAP_CACHING               (0x00000003)
-#define TSS_TCSCAP_PERSSTORAGE           (0x00000004)
-#define TSS_TCSCAP_MANUFACTURER          (0x00000005)
-#define TSS_TCSCAP_PLATFORM_CLASS        (0x00000006)
-#define TSS_TCSCAP_TRANSPORT             (0x00000007)
-#define TSS_TCSCAP_PLATFORM_INFO         (0x00000008)
-
-//
-// Sub-Capability Flags TSS-CoreService-Capabilities
-//
-#define TSS_TCSCAP_PROP_KEYCACHE         (0x00000100)
-#define TSS_TCSCAP_PROP_AUTHCACHE        (0x00000101)
-#define TSS_TCSCAP_PROP_MANUFACTURER_STR (0x00000102)
-#define TSS_TCSCAP_PROP_MANUFACTURER_ID  (0x00000103)
-#define TSS_TCSCAP_PLATFORM_VERSION      (0x00001100)
-#define TSS_TCSCAP_PLATFORM_TYPE         (0x00001101)
-#define TSS_TCSCAP_TRANS_EXCLUSIVE       (0x00002100)
-#define TSS_TCSCAP_PROP_HOST_PLATFORM    (0x00003001)
-#define TSS_TCSCAP_PROP_ALL_PLATFORMS    (0x00003002)
-
-//
-// TSS Service Provider Capabilities      
-//
-#define TSS_TSPCAP_ALG                   (0x00000010)
-#define TSS_TSPCAP_VERSION               (0x00000011)
-#define TSS_TSPCAP_PERSSTORAGE           (0x00000012)
-#define TSS_TSPCAP_MANUFACTURER          (0x00000013)
-#define TSS_TSPCAP_RETURNVALUE_INFO      (0x00000015)
-#define TSS_TSPCAP_PLATFORM_INFO         (0x00000016)
-
-// Sub-Capability Flags for TSS_TSPCAP_MANUFACTURER
-//
-#define TSS_TSPCAP_PROP_MANUFACTURER_STR (0x00000102)
-#define TSS_TSPCAP_PROP_MANUFACTURER_ID  (0x00000103)
-
-// Sub-Capability Flags for TSS_TSPCAP_PLATFORM_INFO
-//
-#define TSS_TSPCAP_PLATFORM_TYPE         (0x00000201)
-#define TSS_TSPCAP_PLATFORM_VERSION      (0x00000202)
-
-
-
-// Sub-Capability Flags for TSS_TSPCAP_RETURNVALUE_INFO
-//
-#define TSS_TSPCAP_PROP_RETURNVALUE_INFO (0x00000201)
-
-//
-// Event type definitions
-//
-#define TSS_EV_CODE_CERT                 (0x00000001)
-#define TSS_EV_CODE_NOCERT               (0x00000002)
-#define TSS_EV_XML_CONFIG                (0x00000003)
-#define TSS_EV_NO_ACTION                 (0x00000004)
-#define TSS_EV_SEPARATOR                 (0x00000005)
-#define TSS_EV_ACTION                    (0x00000006)
-#define TSS_EV_PLATFORM_SPECIFIC         (0x00000007)
-
-
-//
-// TSP random number limits
-//
-#define TSS_TSPCAP_RANDOMLIMIT     (0x00001000)   // Errata: Missing from spec
-
-//
-// UUIDs
-//
-// Errata: This are not in the spec
-#define TSS_UUID_SRK  {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 1}} // Storage root key
-#define TSS_UUID_SK   {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 2}} // System key
-#define TSS_UUID_RK   {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 3}} // roaming key
-#define TSS_UUID_CRK  {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 8}} // CMK roaming key
-#define TSS_UUID_USK1 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 4}} // user storage key 1
-#define TSS_UUID_USK2 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 5}} // user storage key 2
-#define TSS_UUID_USK3 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 6}} // user storage key 3
-#define TSS_UUID_USK4 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 7}} // user storage key 4
-#define TSS_UUID_USK5 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 9}} // user storage key 5
-#define TSS_UUID_USK6 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 10}}// user storage key 6
-
-// macro to derive UUIDs for keys whose "OwnerEvict" key is set.
-#define TSS_UUID_OWNEREVICT(i) {0, 0, 0, 0, 0, {0, 0, 0, 0, 1, (i)}}
-
-
-//
-// TPM well-known secret
-//
-#define TSS_WELL_KNOWN_SECRET \
-        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
-         0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
-
-
-// Values for the "direction" parameters in the Tspi_PcrComposite_XX functions.
-#define TSS_PCRS_DIRECTION_CREATION                        ((UINT32)1)
-#define TSS_PCRS_DIRECTION_RELEASE                         ((UINT32)2)
-
-
-//
-// TSS blob version definition for ASN.1 blobs
-//
-#define TSS_BLOB_STRUCT_VERSION                              0x01
-
-//
-// TSS blob type definitions for ASN.1 blobs
-//
-#define TSS_BLOB_TYPE_KEY                                    0x01
-#define TSS_BLOB_TYPE_PUBKEY                                 0x02
-#define TSS_BLOB_TYPE_MIGKEY                                 0x03
-#define TSS_BLOB_TYPE_SEALEDDATA                             0x04
-#define TSS_BLOB_TYPE_BOUNDDATA                              0x05
-#define TSS_BLOB_TYPE_MIGTICKET                              0x06
-#define TSS_BLOB_TYPE_PRIVATEKEY                             0x07
-#define TSS_BLOB_TYPE_PRIVATEKEY_MOD1                        0x08
-#define TSS_BLOB_TYPE_RANDOM_XOR                             0x09
-#define TSS_BLOB_TYPE_CERTIFY_INFO                           0x0A
-#define TSS_BLOB_TYPE_KEY_1_2                                0x0B
-#define TSS_BLOB_TYPE_CERTIFY_INFO_2                         0x0C
-#define TSS_BLOB_TYPE_CMK_MIG_KEY                            0x0D
-#define TSS_BLOB_TYPE_CMK_BYTE_STREAM                        0x0E
-
-
-
-//
-// Values for TPM_CMK_DELEGATE bitmasks
-// For now these are exactly the same values as the corresponding
-// TPM_CMK_DELEGATE_* bitmasks.
-//
-#define TSS_CMK_DELEGATE_SIGNING       (((UINT32)1)<<31)
-#define TSS_CMK_DELEGATE_STORAGE       (((UINT32)1)<<30)
-#define TSS_CMK_DELEGATE_BIND          (((UINT32)1)<<29)
-#define TSS_CMK_DELEGATE_LEGACY        (((UINT32)1)<<28)
-#define TSS_CMK_DELEGATE_MIGRATE       (((UINT32)1)<<27)
-
-
-//
-// Constants for DAA
-//
-#define TSS_DAA_LENGTH_N                256             // Length of the RSA Modulus (2048 bits)
-#define TSS_DAA_LENGTH_F                13              // Length of the f_i's (information encoded into the certificate, 104 bits)
-#define TSS_DAA_LENGTH_E                46              // Length of the e's (exponents, part of certificate, 386 bits)
-#define TSS_DAA_LENGTH_E_PRIME          15              // Length of the interval the e's are chosen from (120 bits)
-#define TSS_DAA_LENGTH_V                317             // Length of the v's (random value, part of certificate, 2536 bits)
-#define TSS_DAA_LENGTH_SAFETY           10              // Length of the security parameter controlling the statistical zero-knowledge property (80 bits)
-#define TSS_DAA_LENGTH_HASH     TPM_SHA1_160_HASH_LEN   // Length of the output of the hash function SHA-1 used for the Fiat-Shamir heuristic(160 bits)
-#define TSS_DAA_LENGTH_S                128             // Length of the split large exponent for easier computations on the TPM (1024 bits)
-#define TSS_DAA_LENGTH_GAMMA            204             // Length of the modulus 'Gamma' (1632 bits)
-#define TSS_DAA_LENGTH_RHO              26              // Length of the order 'rho' of the sub group of Z*_Gamma that is used for roggue tagging (208 bits)
-#define TSS_DAA_LENGTH_MFG1_GAMMA       214             // Length of the output of MGF1 in conjunction with the modulus Gamma (1712 bits)
-#define TSS_DAA_LENGTH_MGF1_AR          25              // Length of the output of MGF1 used for anonymity revocation (200 bits)
-
-
-#endif // __TSS_DEFINES_H__
+/*++
+ 
+Global defines for TSS.
+
+--*/
+
+#ifndef __TSS_DEFINES_H__
+#define __TSS_DEFINES_H__
+
+#include <tss/platform.h>
+#include <tss/tpm.h>
+
+
+//////////////////////////////////////////////////////////////////////////
+// Object types:
+//////////////////////////////////////////////////////////////////////////
+
+//
+// definition of the object types that can be created via CreateObject
+//
+#define   TSS_OBJECT_TYPE_POLICY    (0x01)      // Policy object
+#define   TSS_OBJECT_TYPE_RSAKEY    (0x02)      // RSA-Key object
+#define   TSS_OBJECT_TYPE_ENCDATA   (0x03)      // Encrypted data object
+#define   TSS_OBJECT_TYPE_PCRS      (0x04)      // PCR composite object
+#define   TSS_OBJECT_TYPE_HASH      (0x05)      // Hash object
+#define   TSS_OBJECT_TYPE_DELFAMILY (0x06)      // Delegation Family object
+#define   TSS_OBJECT_TYPE_NV        (0x07)      // NV object
+#define   TSS_OBJECT_TYPE_MIGDATA   (0x08)      // CMK Migration data object
+#define   TSS_OBJECT_TYPE_DAA_CERTIFICATE (0x09) // DAA credential
+#define   TSS_OBJECT_TYPE_DAA_ISSUER_KEY  (0x0a) // DAA cred. issuer keypair
+#define   TSS_OBJECT_TYPE_DAA_ARA_KEY     (0x0b) // DAA anonymity revocation
+                                                 // authority keypair
+
+
+//////////////////////////////////////////////////////////////////////////
+// CreateObject: Flags
+//////////////////////////////////////////////////////////////////////////
+
+
+//************************************
+// Flags for creating RSAKEY object: *
+//************************************
+
+//
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//                                                              |x x|Auth
+//                                                            |x|    Volatility
+//                                                          |x|      Migration
+//                                                  |x x x x|        Type
+//                                          |x x x x|                Size
+//                                      |x x|                        CMK
+//                                |x x x|                            Version
+//              |0 0 0 0 0 0 0 0 0|                                  Reserved
+//  |x x x x x x|                                                    Fixed Type
+//
+
+//  Authorization:
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+//   Never                                                      |0 0|
+//   Always                                                     |0 1|
+//   Private key always                                         |1 0|
+//
+#define   TSS_KEY_NO_AUTHORIZATION            (0x00000000) // no auth needed
+                                                           // for this key
+#define   TSS_KEY_AUTHORIZATION               (0x00000001) // key needs auth
+                                                           // for all ops
+#define   TSS_KEY_AUTHORIZATION_PRIV_USE_ONLY (0x00000002) // key needs auth
+                                                           // for privkey ops,
+                                                           // noauth for pubkey
+
+//
+//  Volatility
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+//   Non Volatile                                             |0|
+//   Volatile                                                 |1|
+//
+#define    TSS_KEY_NON_VOLATILE      (0x00000000)   // Key is non-volatile
+#define    TSS_KEY_VOLATILE          (0x00000004)   // Key is volatile
+
+//
+//  Migration
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+//   Non Migratable                                         |0|
+//   Migratable                                             |1|
+//
+#define   TSS_KEY_NOT_MIGRATABLE     (0x00000000)   // key is not migratable
+#define   TSS_KEY_MIGRATABLE         (0x00000008)   // key is migratable
+
+//
+//  Usage
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+//   Default (Legacy)                               |0 0 0 0|
+//   Signing                                        |0 0 0 1|
+//   Storage                                        |0 0 1 0|
+//   Identity                                       |0 0 1 1|
+//   AuthChange                                     |0 1 0 0|
+//   Bind                                           |0 1 0 1|
+//   Legacy                                         |0 1 1 0|
+//
+#define   TSS_KEY_TYPE_DEFAULT    (0x00000000)   // indicate a default key
+                                                 // (Legacy-Key)
+#define   TSS_KEY_TYPE_SIGNING    (0x00000010)   // indicate a signing key
+#define   TSS_KEY_TYPE_STORAGE    (0x00000020)   // used as storage key
+#define   TSS_KEY_TYPE_IDENTITY   (0x00000030)   // indicate an idendity key
+#define   TSS_KEY_TYPE_AUTHCHANGE (0x00000040)   // indicate an ephemeral key
+#define   TSS_KEY_TYPE_BIND       (0x00000050)   // indicate a key for TPM_Bind
+#define   TSS_KEY_TYPE_LEGACY     (0x00000060)   // indicate a key that can
+                                                 // perform signing and binding
+#define   TSS_KEY_TYPE_MIGRATE    (0x00000070)   // indicate a key that can
+                                                 // act as a CMK MA
+#define   TSS_KEY_TYPE_BITMASK    (0x000000F0)   // mask to extract key type
+
+//
+//  Key size
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+// DEFAULT                                  |0 0 0 0|
+//   512                                    |0 0 0 1|
+//  1024                                    |0 0 1 0|
+//  2048                                    |0 0 1 1|
+//  4096                                    |0 1 0 0|
+//  8192                                    |0 1 0 1|
+// 16384                                    |0 1 1 0|
+//
+#define TSS_KEY_SIZE_DEFAULT (UINT32)(0x00000000) // indicate tpm-specific size
+#define TSS_KEY_SIZE_512     (UINT32)(0x00000100) // indicate a 512-bit key
+#define TSS_KEY_SIZE_1024    (UINT32)(0x00000200) // indicate a 1024-bit key
+#define TSS_KEY_SIZE_2048    (UINT32)(0x00000300) // indicate a 2048-bit key
+#define TSS_KEY_SIZE_4096    (UINT32)(0x00000400) // indicate a 4096-bit key
+#define TSS_KEY_SIZE_8192    (UINT32)(0x00000500) // indicate a 8192-bit key
+#define TSS_KEY_SIZE_16384   (UINT32)(0x00000600) // indicate a 16384-bit key
+#define TSS_KEY_SIZE_BITMASK (UINT32)(0x00000F00) // mask to extract key size
+
+//
+//  Certified Migratability
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+// DEFAULT                              |0 0|
+// Not Certified Migratable             |0 0|
+// Certified Migratable                 |0 1|
+//
+#define TSS_KEY_NOT_CERTIFIED_MIGRATABLE (UINT32)(0x00000000)
+#define TSS_KEY_CERTIFIED_MIGRATABLE     (UINT32)(0x00001000)
+
+//
+//  Specification version
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+// Context default                |0 0 0|
+// TPM_KEY 1.1b key               |0 0 1|
+// TPM_KEY12 1.2 key              |0 1 0|
+//
+#define TSS_KEY_STRUCT_DEFAULT            (UINT32)(0x00000000)
+#define TSS_KEY_STRUCT_KEY                (UINT32)(0x00004000)
+#define TSS_KEY_STRUCT_KEY12              (UINT32)(0x00008000)
+#define TSS_KEY_STRUCT_BITMASK            (UINT32)(0x0001C000)
+
+
+//
+//  fixed KeyTypes (templates)
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+//  |0 0 0 0 0 0|                             Empty Key
+//  |0 0 0 0 0 1|                             Storage Root Key
+//
+#define   TSS_KEY_EMPTY_KEY (0x00000000) // no TPM key template
+                                         // (empty TSP key object)
+#define   TSS_KEY_TSP_SRK   (0x04000000) // use a TPM SRK template
+                                         // (TSP key object for SRK)
+#define   TSS_KEY_TEMPLATE_BITMASK (0xFC000000) // bitmask to extract key
+                                                // template
+
+
+//*************************************
+// Flags for creating ENCDATA object: *
+//*************************************
+
+//
+//  Type
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+//   Seal                                                     |0 0 1|
+//   Bind                                                     |0 1 0|
+//   Legacy                                                   |0 1 1|
+//
+//   ENCDATA Reserved:
+//  |x x x x x x x x x x x x x x x x x x x x x x x x x x x x x|
+//
+#define   TSS_ENCDATA_SEAL     (0x00000001)   // data for seal operation
+#define   TSS_ENCDATA_BIND     (0x00000002)   // data for bind operation
+#define   TSS_ENCDATA_LEGACY   (0x00000003)   // data for legacy bind operation
+
+
+//**********************************
+// Flags for creating HASH object: *
+//**********************************
+
+//
+//  Algorithm
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+//   DEFAULT               
+//  |0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0|
+//   SHA1
+//  |0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1|
+//   OTHER
+//  |1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1|
+//
+#define   TSS_HASH_DEFAULT    (0x00000000)   // Default hash algorithm
+#define   TSS_HASH_SHA1       (0x00000001)   // SHA-1 with 20 bytes
+#define   TSS_HASH_OTHER      (0xFFFFFFFF)   // Not-specified hash algorithm
+
+
+//************************************
+// Flags for creating POLICY object: *
+//************************************
+
+//
+//  Type
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//
+//   Usage                                                    |0 0 1|
+//   Migration                                                |0 1 0|
+//   Operator                                                 |0 1 1|
+//
+//   POLICY Reserved:
+//  |x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x|
+
+#define   TSS_POLICY_USAGE         (0x00000001)   // usage policy object
+#define   TSS_POLICY_MIGRATION     (0x00000002)   // migration policy object
+#define   TSS_POLICY_OPERATOR      (0x00000003)   // migration policy object
+
+
+//******************************************
+// Flags for creating PCRComposite object: *
+//******************************************
+
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+//                                                              |x x| Struct
+//  |x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x|     Reserved
+//
+
+//  PCRComposite Version:
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//   ---------------------------------------------------------------
+// TPM_PCR_DEFAULT                                            |0 0 0|
+// TPM_PCR_INFO                                               |0 0 1|
+// TPM_PCR_INFO_LONG                                          |0 1 0|
+// TPM_PCR_INFO_SHORT                                         |0 1 1|
+//
+
+#define   TSS_PCRS_STRUCT_DEFAULT    (0x00000000) // depends on context
+#define   TSS_PCRS_STRUCT_INFO       (0x00000001) // TPM_PCR_INFO
+#define   TSS_PCRS_STRUCT_INFO_LONG  (0x00000002) // TPM_PCR_INFO_LONG
+#define   TSS_PCRS_STRUCT_INFO_SHORT (0x00000003) // TPM_PCR_INFO_SHORT
+
+
+
+//////////////////////////////////////////////////////////////////////////
+// Attribute Flags, Subflags, and Values
+//////////////////////////////////////////////////////////////////////////
+
+
+//******************
+// Context object: *
+//******************
+
+//
+// Attributes
+//
+#define TSS_TSPATTRIB_CONTEXT_SILENT_MODE        (0x00000001)
+                                                    // dialog display control
+#define TSS_TSPATTRIB_CONTEXT_MACHINE_NAME       (0x00000002)
+                                                    // remote machine name
+#define TSS_TSPATTRIB_CONTEXT_VERSION_MODE       (0x00000003)
+                                                    // context version
+#define TSS_TSPATTRIB_CONTEXT_TRANSPORT          (0x00000004)
+                                                    // transport control
+#define TSS_TSPATTRIB_CONTEXT_CONNECTION_VERSION (0x00000005)
+                                                    // connection version
+#define TSS_TSPATTRIB_SECRET_HASH_MODE           (0x00000006)
+                                                    // flag indicating whether
+                                                    // NUL is included in the
+                                                    // hash of the password
+//
+// SubFlags for Flag TSS_TSPATTRIB_CONTEXT_TRANSPORT
+//
+#define   TSS_TSPATTRIB_CONTEXTTRANS_CONTROL   (0x00000008)
+#define   TSS_TSPATTRIB_CONTEXTTRANS_MODE      (0x00000010)
+
+//
+// Values for the TSS_TSPATTRIB_CONTEXT_SILENT_MODE attribute
+//
+#define   TSS_TSPATTRIB_CONTEXT_NOT_SILENT (0x00000000) // TSP dialogs enabled
+#define   TSS_TSPATTRIB_CONTEXT_SILENT     (0x00000001) // TSP dialogs disabled
+
+//
+// Values for the TSS_TSPATTRIB_CONTEXT_VERSION_MODE attribute
+//
+#define   TSS_TSPATTRIB_CONTEXT_VERSION_AUTO (0x00000001)
+#define   TSS_TSPATTRIB_CONTEXT_VERSION_V1_1 (0x00000002)
+#define   TSS_TSPATTRIB_CONTEXT_VERSION_V1_2 (0x00000003)
+
+//
+// Values for the subflag TSS_TSPATTRIB_CONTEXT_TRANS_CONTROL
+//
+#define   TSS_TSPATTRIB_DISABLE_TRANSPORT      (0x00000016)
+#define   TSS_TSPATTRIB_ENABLE_TRANSPORT       (0x00000032)
+
+//
+// Values for the subflag TSS_TSPATTRIB_CONTEXT_TRANS_MODE
+//
+#define   TSS_TSPATTRIB_TRANSPORT_NO_DEFAULT_ENCRYPTION (0x00000000)
+#define   TSS_TSPATTRIB_TRANSPORT_DEFAULT_ENCRYPTION    (0x00000001)
+#define   TSS_TSPATTRIB_TRANSPORT_AUTHENTIC_CHANNEL     (0x00000002)
+#define   TSS_TSPATTRIB_TRANSPORT_EXCLUSIVE             (0x00000004)
+#define   TSS_TSPATTRIB_TRANSPORT_STATIC_AUTH           (0x00000008)
+
+//
+// Values for the TSS_TSPATTRIB_CONTEXT_CONNECTION_VERSION attribute
+//
+#define TSS_CONNECTION_VERSION_1_1                      (0x00000001)
+#define TSS_CONNECTION_VERSION_1_2                      (0x00000002)
+
+
+//
+// Subflags of TSS_TSPATTRIB_SECRET_HASH_MODE
+//
+#define TSS_TSPATTRIB_SECRET_HASH_MODE_POPUP     (0x00000001)
+
+//
+// Values for TSS_TSPATTRIB_SECRET_HASH_MODE_POPUP subflag
+//
+#define TSS_TSPATTRIB_HASH_MODE_NOT_NULL         (0x00000000)
+#define TSS_TSPATTRIB_HASH_MODE_NULL             (0x00000001)
+
+
+// *************
+// TPM object: *
+// *************
+
+//
+// Attributes:
+//
+#define TSS_TSPATTRIB_TPM_CALLBACK_COLLATEIDENTITY  0x00000001
+#define TSS_TSPATTRIB_TPM_CALLBACK_ACTIVATEIDENTITY 0x00000002
+#define TSS_TSPATTRIB_TPM_ORDINAL_AUDIT_STATUS      0x00000003
+#define TSS_TSPATTRIB_TPM_CREDENTIAL                0x00001000
+
+//
+// Subflags for TSS_TSPATTRIB_TPM_ORDINAL_AUDIT_STATUS
+//
+#define TPM_CAP_PROP_TPM_CLEAR_ORDINAL_AUDIT        0x00000000
+#define TPM_CAP_PROP_TPM_SET_ORDINAL_AUDIT          0x00000001
+
+//
+// Subflags for TSS_TSPATTRIB_TPM_CREDENTIAL
+//
+#define TSS_TPMATTRIB_EKCERT                        0x00000001
+#define TSS_TPMATTRIB_TPM_CC                        0x00000002
+#define TSS_TPMATTRIB_PLATFORMCERT                  0x00000003
+#define TSS_TPMATTRIB_PLATFORM_CC                   0x00000004
+
+
+//*****************
+// Policy object: *
+//*****************
+
+//
+// Attributes
+//
+#define TSS_TSPATTRIB_POLICY_CALLBACK_HMAC           (0x00000080)
+                                        // enable/disable callback function
+
+#define TSS_TSPATTRIB_POLICY_CALLBACK_XOR_ENC        (0x00000100)
+                                        // enable/disable callback function
+
+#define TSS_TSPATTRIB_POLICY_CALLBACK_TAKEOWNERSHIP  (0x00000180)
+                                        // enable/disable callback function
+
+#define TSS_TSPATTRIB_POLICY_CALLBACK_CHANGEAUTHASYM (0x00000200)
+                                        // enable/disable callback function
+
+#define TSS_TSPATTRIB_POLICY_SECRET_LIFETIME         (0x00000280)
+                                        // set lifetime mode for policy secret
+
+#define TSS_TSPATTRIB_POLICY_POPUPSTRING             (0x00000300)
+                                        // set a NULL terminated UNICODE string
+                                        // which is displayed in the TSP policy
+                                        // popup dialog
+#define TSS_TSPATTRIB_POLICY_CALLBACK_SEALX_MASK     (0x00000380)
+                                        // enable/disable callback function
+#if 0
+/* This attribute flag is defined earlier with the context attributes.
+ * It is valid for both context and policy objects. It is copied
+ * here as a reminder to avoid collisions.
+ */
+#define TSS_TSPATTRIB_SECRET_HASH_MODE               (0x00000006)
+                                                    // flag indicating whether
+                                                    // NUL is included in the
+                                                    // hash of the password
+#endif
+
+
+#define TSS_TSPATTRIB_POLICY_DELEGATION_INFO         (0x00000001)
+#define TSS_TSPATTRIB_POLICY_DELEGATION_PCR          (0x00000002)
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_POLICY_SECRET_LIFETIME
+//
+#define TSS_SECRET_LIFETIME_ALWAYS  (0x00000001) // secret will not be
+                                                 // invalidated
+#define TSS_SECRET_LIFETIME_COUNTER (0x00000002) // secret lifetime
+                                                 // controlled by counter
+#define TSS_SECRET_LIFETIME_TIMER   (0x00000003) // secret lifetime
+                                                 // controlled by time
+#define TSS_TSPATTRIB_POLSECRET_LIFETIME_ALWAYS  TSS_SECRET_LIFETIME_ALWAYS
+#define TSS_TSPATTRIB_POLSECRET_LIFETIME_COUNTER TSS_SECRET_LIFETIME_COUNTER
+#define TSS_TSPATTRIB_POLSECRET_LIFETIME_TIMER   TSS_SECRET_LIFETIME_TIMER
+
+// Alternate names misspelled in the 1.1 TSS spec.
+#define TSS_TSPATTRIB_POLICYSECRET_LIFETIME_ALWAYS  TSS_SECRET_LIFETIME_ALWAYS
+#define TSS_TSPATTRIB_POLICYSECRET_LIFETIME_COUNTER TSS_SECRET_LIFETIME_COUNTER
+#define TSS_TSPATTRIB_POLICYSECRET_LIFETIME_TIMER   TSS_SECRET_LIFETIME_TIMER
+
+//
+// Subflags of TSS_TSPATTRIB_POLICY_DELEGATION_INFO
+//
+#define TSS_TSPATTRIB_POLDEL_TYPE                (0x00000001)
+#define TSS_TSPATTRIB_POLDEL_INDEX               (0x00000002)
+#define TSS_TSPATTRIB_POLDEL_PER1                (0x00000003)
+#define TSS_TSPATTRIB_POLDEL_PER2                (0x00000004)
+#define TSS_TSPATTRIB_POLDEL_LABEL               (0x00000005)
+#define TSS_TSPATTRIB_POLDEL_FAMILYID            (0x00000006)
+#define TSS_TSPATTRIB_POLDEL_VERCOUNT            (0x00000007)
+#define TSS_TSPATTRIB_POLDEL_OWNERBLOB           (0x00000008)
+#define TSS_TSPATTRIB_POLDEL_KEYBLOB             (0x00000009)
+
+//
+// Subflags of TSS_TSPATTRIB_POLICY_DELEGATION_PCR
+//
+#define TSS_TSPATTRIB_POLDELPCR_LOCALITY         (0x00000001)
+#define TSS_TSPATTRIB_POLDELPCR_DIGESTATRELEASE  (0x00000002)
+#define TSS_TSPATTRIB_POLDELPCR_SELECTION        (0x00000003)
+
+//
+// Values for the Policy TSS_TSPATTRIB_POLDEL_TYPE attribute
+//
+#define TSS_DELEGATIONTYPE_NONE                  (0x00000001)
+#define TSS_DELEGATIONTYPE_OWNER                 (0x00000002)
+#define TSS_DELEGATIONTYPE_KEY                   (0x00000003)
+
+
+
+//
+//  Flags used for the 'mode' parameter in Tspi_Policy_SetSecret()
+//
+#define TSS_SECRET_MODE_NONE     (0x00000800) // No authorization will be
+                                              // processed
+#define TSS_SECRET_MODE_SHA1     (0x00001000) // Secret string will not be
+                                              // touched by TSP 
+#define TSS_SECRET_MODE_PLAIN    (0x00001800) // Secret string will be hashed
+                                              // using SHA1
+#define TSS_SECRET_MODE_POPUP    (0x00002000) // TSS SP will ask for a secret
+#define TSS_SECRET_MODE_CALLBACK (0x00002800) // Application has to provide a
+                                              // call back function
+
+
+
+//******************
+// EncData object: *
+//******************
+
+//
+// Attributes
+//
+#define TSS_TSPATTRIB_ENCDATA_BLOB     (0x00000008)
+#define TSS_TSPATTRIB_ENCDATA_PCR      (0x00000010)
+#define TSS_TSPATTRIB_ENCDATA_PCR_LONG (0x00000018)
+#define TSS_TSPATTRIB_ENCDATA_SEAL     (0x00000020)
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_ENCDATA_BLOB
+//
+#define TSS_TSPATTRIB_ENCDATABLOB_BLOB   (0x00000001)   // encrypted data blob
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_ENCDATA_PCR
+//
+#define TSS_TSPATTRIB_ENCDATAPCR_DIGEST_ATCREATION       (0x00000002)
+#define TSS_TSPATTRIB_ENCDATAPCR_DIGEST_ATRELEASE        (0x00000003)
+#define TSS_TSPATTRIB_ENCDATAPCR_SELECTION               (0x00000004)
+// support typo from 1.1 headers
+#define TSS_TSPATTRIB_ENCDATAPCR_DIGEST_RELEASE \
+                          TSS_TSPATTRIB_ENCDATAPCR_DIGEST_ATRELEASE
+
+#define TSS_TSPATTRIB_ENCDATAPCRLONG_LOCALITY_ATCREATION (0x00000005)
+#define TSS_TSPATTRIB_ENCDATAPCRLONG_LOCALITY_ATRELEASE  (0x00000006)
+#define TSS_TSPATTRIB_ENCDATAPCRLONG_CREATION_SELECTION  (0x00000007)
+#define TSS_TSPATTRIB_ENCDATAPCRLONG_RELEASE_SELECTION   (0x00000008)
+#define TSS_TSPATTRIB_ENCDATAPCRLONG_DIGEST_ATCREATION   (0x00000009)
+#define TSS_TSPATTRIB_ENCDATAPCRLONG_DIGEST_ATRELEASE    (0x0000000A)
+
+
+//
+// Attribute subflags TSS_TSPATTRIB_ENCDATA_SEAL
+//
+#define TSS_TSPATTRIB_ENCDATASEAL_PROTECT_MODE           (0x00000001)
+
+//
+// Attribute values for 
+//    TSS_TSPATTRIB_ENCDATA_SEAL/TSS_TSPATTRIB_ENCDATASEAL_PROTECT_MODE
+//
+#define  TSS_TSPATTRIB_ENCDATASEAL_NOPROTECT             (0x00000000)
+#define  TSS_TSPATTRIB_ENCDATASEAL_PROTECT               (0x00000001)
+
+// Accounting for typos in original header files
+#define  TSS_TSPATTRIB_ENCDATASEAL_NO_PROTECT                                \
+                                           TSS_TSPATTRIB_ENCDATASEAL_NOPROTECT
+
+//*************
+// NV object: *
+//*************
+
+//
+// Attributes
+//
+#define TSS_TSPATTRIB_NV_INDEX                     (0x00000001)
+#define TSS_TSPATTRIB_NV_PERMISSIONS               (0x00000002)
+#define TSS_TSPATTRIB_NV_STATE                     (0x00000003)
+#define TSS_TSPATTRIB_NV_DATASIZE                  (0x00000004)
+#define TSS_TSPATTRIB_NV_PCR                       (0x00000005)
+
+#define TSS_TSPATTRIB_NVSTATE_READSTCLEAR          (0x00100000)
+#define TSS_TSPATTRIB_NVSTATE_WRITESTCLEAR         (0x00200000)
+#define TSS_TSPATTRIB_NVSTATE_WRITEDEFINE          (0x00300000)
+
+#define TSS_TSPATTRIB_NVPCR_READPCRSELECTION       (0x01000000)
+#define TSS_TSPATTRIB_NVPCR_READDIGESTATRELEASE    (0x02000000)
+#define TSS_TSPATTRIB_NVPCR_READLOCALITYATRELEASE  (0x03000000)
+#define TSS_TSPATTRIB_NVPCR_WRITEPCRSELECTION      (0x04000000)
+#define TSS_TSPATTRIB_NVPCR_WRITEDIGESTATRELEASE   (0x05000000)
+#define TSS_TSPATTRIB_NVPCR_WRITELOCALITYATRELEASE (0x06000000)
+
+/* NV index flags
+ *
+ * From the TPM spec, Part 2, Section 19.1.
+ *
+ *        3                   2                   1
+ *      1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+ *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+ *     |T|P|U|D| resvd |   Purview     |          Index                |
+ *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+ */
+#define TSS_NV_TPM                (0x80000000) // TPM mfr reserved bit
+#define TSS_NV_PLATFORM           (0x40000000) // Platform mfr reserved bit
+#define TSS_NV_USER               (0x20000000) // User reserved bit
+#define TSS_NV_DEFINED            (0x10000000) // "Defined permanently" flag
+#define TSS_NV_MASK_TPM           (0x80000000) // mask to extract 'T'
+#define TSS_NV_MASK_PLATFORM      (0x40000000) // mask to extract 'P'
+#define TSS_NV_MASK_USER          (0x20000000) // mask to extract 'U'
+#define TSS_NV_MASK_DEFINED       (0x10000000) // mask to extract 'D'
+#define TSS_NV_MASK_RESERVED      (0x0f000000) // mask to extract reserved bits
+#define TSS_NV_MASK_PURVIEW       (0x00ff0000) // mask to extract purview byte
+#define TSS_NV_MASK_INDEX         (0x0000ffff) // mask to extract index byte
+
+// This is the index of the NV storage area where the number of sessions
+// per locality is stored.
+#define TSS_NV_INDEX_SESSIONS     (0x00011101)
+
+
+//******************
+// MigData object: *
+//******************
+
+//
+// Attributes
+//
+#define TSS_MIGATTRIB_MIGRATIONBLOB                    (0x00000010)
+#define TSS_MIGATTRIB_MIGRATIONTICKET                  (0x00000020)
+#define TSS_MIGATTRIB_AUTHORITY_DATA                   (0x00000030)
+#define TSS_MIGATTRIB_MIG_AUTH_DATA                    (0x00000040)
+#define TSS_MIGATTRIB_TICKET_DATA                      (0x00000050)
+#define TSS_MIGATTRIB_PAYLOAD_TYPE                     (0x00000060)
+
+//
+// Attribute subflags TSS_MIGATTRIB_MIGRATIONBLOB
+//
+#define TSS_MIGATTRIB_MIGRATION_XOR_BLOB               (0x00000101)
+#define TSS_MIGATTRIB_MIGRATION_REWRAPPED_BLOB         (0x00000102)
+#define TSS_MIGATTRIB_MIG_MSALIST_PUBKEY_BLOB          (0x00000103)
+#define TSS_MIGATTRIB_MIG_AUTHORITY_PUBKEY_BLOB        (0x00000104)
+#define TSS_MIGATTRIB_MIG_DESTINATION_PUBKEY_BLOB      (0x00000105)
+#define TSS_MIGATTRIB_MIG_SOURCE_PUBKEY_BLOB           (0x00000106)
+#define TSS_MIGATTRIB_MIG_REWRAPPED_BLOB               TSS_MIGATTRIB_MIGRATION_REWRAPPED_BLOB
+#define TSS_MIGATTRIB_MIG_XOR_BLOB                     TSS_MIGATTRIB_MIGRATION_XOR_BLOB
+
+//
+// Attribute subflags TSS_MIGATTRIB_MIGRATIONTICKET
+//
+// none
+
+//
+// Attribute subflags TSS_MIGATTRIB_AUTHORITY_DATA
+//
+#define TSS_MIGATTRIB_AUTHORITY_DIGEST                 (0x00000301)
+#define TSS_MIGATTRIB_AUTHORITY_APPROVAL_HMAC          (0x00000302)
+#define TSS_MIGATTRIB_AUTHORITY_MSALIST                (0x00000303)
+
+//
+// Attribute subflags TSS_MIGATTRIB_MIG_AUTH_DATA
+//
+#define TSS_MIGATTRIB_MIG_AUTH_AUTHORITY_DIGEST        (0x00000401)
+#define TSS_MIGATTRIB_MIG_AUTH_DESTINATION_DIGEST      (0x00000402)
+#define TSS_MIGATTRIB_MIG_AUTH_SOURCE_DIGEST           (0x00000403)
+
+//
+// Attribute subflags TSS_MIGATTRIB_TICKET_DATA
+//
+#define TSS_MIGATTRIB_TICKET_SIG_DIGEST                (0x00000501)
+#define TSS_MIGATTRIB_TICKET_SIG_VALUE                 (0x00000502)
+#define TSS_MIGATTRIB_TICKET_SIG_TICKET                (0x00000503)
+#define TSS_MIGATTRIB_TICKET_RESTRICT_TICKET           (0x00000504)
+
+//
+// Attribute subflags TSS_MIGATTRIB_PAYLOAD_TYPE
+//
+#define TSS_MIGATTRIB_PT_MIGRATE_RESTRICTED            (0x00000601)
+#define TSS_MIGATTRIB_PT_MIGRATE_EXTERNAL              (0x00000602)
+
+
+
+
+//***************
+// Hash object: *
+//***************
+
+//
+// Attributes
+//
+#define TSS_TSPATTRIB_HASH_IDENTIFIER (0x00001000) // Hash algorithm identifier
+#define TSS_TSPATTRIB_ALG_IDENTIFIER  (0x00002000) // ASN.1 alg identifier
+
+
+
+//***************
+// PCRs object: *
+//***************
+
+//
+// Attributes
+//
+#define TSS_TSPATTRIB_PCRS_INFO  (0x00000001) // info 
+
+//
+// Subflags for TSS_TSPATTRIB_PCRS_INFO flag
+//
+#define TSS_TSPATTRIB_PCRSINFO_PCRSTRUCT (0x00000001) // type of pcr struct
+                                                      // TSS_PCRS_STRUCT_TYPE_XX
+
+//****************************
+// Delegation Family object: *
+//****************************
+
+//
+// Attributes
+//
+#define TSS_TSPATTRIB_DELFAMILY_STATE            (0x00000001)
+#define TSS_TSPATTRIB_DELFAMILY_INFO             (0x00000002)
+
+// DELFAMILY_STATE sub-attributes
+#define TSS_TSPATTRIB_DELFAMILYSTATE_LOCKED      (0x00000001)
+#define TSS_TSPATTRIB_DELFAMILYSTATE_ENABLED     (0x00000002)
+
+// DELFAMILY_INFO sub-attributes
+#define TSS_TSPATTRIB_DELFAMILYINFO_LABEL        (0x00000003)
+#define TSS_TSPATTRIB_DELFAMILYINFO_VERCOUNT     (0x00000004)
+#define TSS_TSPATTRIB_DELFAMILYINFO_FAMILYID     (0x00000005)
+
+// Bitmasks for the 'ulFlags' argument to Tspi_TPM_Delegate_CreateDelegation.
+// Only one bit used for now.
+#define TSS_DELEGATE_INCREMENTVERIFICATIONCOUNT               ((UINT32)1)
+
+// Bitmasks for the 'ulFlags' argument to
+// Tspi_TPM_Delegate_CacheOwnerDelegation. Only 1 bit is used for now.
+#define TSS_DELEGATE_CACHEOWNERDELEGATION_OVERWRITEEXISTING   ((UINT32)1)
+
+
+
+//*************************
+// DAA Credential Object: *
+//*************************
+
+//
+// Attribute flags
+//
+#define TSS_TSPATTRIB_DAACRED_COMMIT                   (0x00000001)
+#define TSS_TSPATTRIB_DAACRED_ATTRIB_GAMMAS            (0x00000002)
+#define TSS_TSPATTRIB_DAACRED_CREDENTIAL_BLOB          (0x00000003)
+#define TSS_TSPATTRIB_DAACRED_CALLBACK_SIGN            (0x00000004)
+#define TSS_TSPATTRIB_DAACRED_CALLBACK_VERIFYSIGNATURE (0x00000005)
+
+//
+// Subflags for TSS_TSPATTRIB_DAACRED_COMMIT
+// 
+#define TSS_TSPATTRIB_DAACOMMIT_NUMBER              (0x00000001)
+#define TSS_TSPATTRIB_DAACOMMIT_SELECTION           (0x00000002)
+#define TSS_TSPATTRIB_DAACOMMIT_COMMITMENTS         (0x00000003)
+
+//
+// Subflags for TSS_TSPATTRIB_DAACRED_ATTRIB_GAMMAS
+// 
+#define TSS_TSPATTRIB_DAAATTRIBGAMMAS_BLOB          (0xffffffff)
+
+
+
+//*************************
+// DAA Issuer Key Object: *
+//*************************
+
+//
+// Attribute flags
+//
+#define TSS_TSPATTRIB_DAAISSUERKEY_BLOB              (0x00000001)
+#define TSS_TSPATTRIB_DAAISSUERKEY_PUBKEY            (0x00000002)
+
+//
+// Subflags for TSS_TSPATTRIB_DAAISSUERKEY_BLOB
+// 
+#define TSS_TSPATTRIB_DAAISSUERKEYBLOB_PUBLIC_KEY     (0x00000001)
+#define TSS_TSPATTRIB_DAAISSUERKEYBLOB_SECRET_KEY     (0x00000002)
+#define TSS_TSPATTRIB_DAAISSUERKEYBLOB_KEYBLOB        (0x00000003)
+#define TSS_TSPATTRIB_DAAISSUERKEYBLOB_PROOF          (0x00000004)
+
+//
+// Subflags for TSS_TSPATTRIB_DAAISSUERKEY_PUBKEY
+// 
+#define TSS_TSPATTRIB_DAAISSUERKEYPUBKEY_NUM_ATTRIBS          (0x00000001)
+#define TSS_TSPATTRIB_DAAISSUERKEYPUBKEY_NUM_PLATFORM_ATTRIBS (0x00000002)
+#define TSS_TSPATTRIB_DAAISSUERKEYPUBKEY_NUM_ISSUER_ATTRIBS   (0x00000003)
+
+
+
+//***************************************
+// DAA Anonymity Revocation Key Object: *
+//***************************************
+
+//
+// Attribute flags
+//
+#define TSS_TSPATTRIB_DAAARAKEY_BLOB                 (0x00000001)
+
+//
+// Subflags for TSS_TSPATTRIB_DAAARAKEY_BLOB
+// 
+#define TSS_TSPATTRIB_DAAARAKEYBLOB_PUBLIC_KEY     (0x00000001)
+#define TSS_TSPATTRIB_DAAARAKEYBLOB_SECRET_KEY     (0x00000002)
+#define TSS_TSPATTRIB_DAAARAKEYBLOB_KEYBLOB        (0x00000003)
+
+
+
+//
+// Structure payload flags for TSS_DAA_PSEUDONYM,
+// (TSS_DAA_PSEUDONYM.payloadFlag)
+//
+#define TSS_FLAG_DAA_PSEUDONYM_PLAIN                 (0x00000000)
+#define TSS_FLAG_DAA_PSEUDONYM_ENCRYPTED             (0x00000001)
+
+
+//**************
+// Key Object: *
+//**************
+
+//
+// Attribute flags
+//
+#define TSS_TSPATTRIB_KEY_BLOB       (0x00000040) // key info as blob data
+#define TSS_TSPATTRIB_KEY_INFO       (0x00000080) // keyparam info as blob data
+#define TSS_TSPATTRIB_KEY_UUID       (0x000000C0) // key UUID info as blob data
+#define TSS_TSPATTRIB_KEY_PCR        (0x00000100) // composite digest value for
+                                                  // the key
+#define TSS_TSPATTRIB_RSAKEY_INFO    (0x00000140) // public key info
+#define TSS_TSPATTRIB_KEY_REGISTER   (0x00000180) // register location
+#define TSS_TSPATTRIB_KEY_PCR_LONG   (0x000001c0) // PCR_INFO_LONG for the key
+#define TSS_TSPATTRIB_KEY_CONTROLBIT (0x00000200) // key control flags
+#define TSS_TSPATTRIB_KEY_CMKINFO    (0x00000400) // CMK info
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_KEY_BLOB
+//
+#define TSS_TSPATTRIB_KEYBLOB_BLOB        (0x00000008) // key info using the
+                                                       // key blob
+#define TSS_TSPATTRIB_KEYBLOB_PUBLIC_KEY  (0x00000010) // public key info
+                                                       // using the blob
+#define TSS_TSPATTRIB_KEYBLOB_PRIVATE_KEY (0x00000028) // encrypted private key
+                                                       // blob
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_KEY_INFO
+//
+#define TSS_TSPATTRIB_KEYINFO_SIZE          (0x00000080) // key size in bits
+#define TSS_TSPATTRIB_KEYINFO_USAGE         (0x00000100) // key usage info
+#define TSS_TSPATTRIB_KEYINFO_KEYFLAGS      (0x00000180) // key flags   
+#define TSS_TSPATTRIB_KEYINFO_AUTHUSAGE     (0x00000200) // key auth usage info
+#define TSS_TSPATTRIB_KEYINFO_ALGORITHM     (0x00000280) // key algorithm ID
+#define TSS_TSPATTRIB_KEYINFO_SIGSCHEME     (0x00000300) // key sig scheme
+#define TSS_TSPATTRIB_KEYINFO_ENCSCHEME     (0x00000380) // key enc scheme   
+#define TSS_TSPATTRIB_KEYINFO_MIGRATABLE    (0x00000400) // if true then key is
+                                                         // migratable
+#define TSS_TSPATTRIB_KEYINFO_REDIRECTED    (0x00000480) // key is redirected
+#define TSS_TSPATTRIB_KEYINFO_VOLATILE      (0x00000500) // if true key is
+                                                         // volatile
+#define TSS_TSPATTRIB_KEYINFO_AUTHDATAUSAGE (0x00000580) // if true auth is
+                                                         // required
+#define TSS_TSPATTRIB_KEYINFO_VERSION       (0x00000600) // version info as TSS
+                                                         // version struct
+#define TSS_TSPATTRIB_KEYINFO_CMK           (0x00000680) // if true then key
+                                                         // is certified
+                                                         // migratable
+#define TSS_TSPATTRIB_KEYINFO_KEYSTRUCT     (0x00000700) // type of key struct
+                                                         // used for this key
+                                                         // (TPM_KEY or 
+                                                         // TPM_KEY12)
+#define TSS_TSPATTRIB_KEYCONTROL_OWNEREVICT (0x00000780) // Get current status
+							 // of owner evict flag
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_RSAKEY_INFO
+//
+#define TSS_TSPATTRIB_KEYINFO_RSA_EXPONENT  (0x00001000)
+#define TSS_TSPATTRIB_KEYINFO_RSA_MODULUS   (0x00002000)
+#define TSS_TSPATTRIB_KEYINFO_RSA_KEYSIZE   (0x00003000)
+#define TSS_TSPATTRIB_KEYINFO_RSA_PRIMES    (0x00004000)
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_KEY_PCR
+//
+#define TSS_TSPATTRIB_KEYPCR_DIGEST_ATCREATION  (0x00008000)
+#define TSS_TSPATTRIB_KEYPCR_DIGEST_ATRELEASE   (0x00010000)
+#define TSS_TSPATTRIB_KEYPCR_SELECTION          (0x00018000)
+
+//
+// SubFlags for TSS_TSPATTRIB_KEY_REGISTER
+//
+#define TSS_TSPATTRIB_KEYREGISTER_USER    (0x02000000)
+#define TSS_TSPATTRIB_KEYREGISTER_SYSTEM  (0x04000000)
+#define TSS_TSPATTRIB_KEYREGISTER_NO      (0x06000000)
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_KEY_PCR_LONG
+//
+#define TSS_TSPATTRIB_KEYPCRLONG_LOCALITY_ATCREATION (0x00040000) /* UINT32 */
+#define TSS_TSPATTRIB_KEYPCRLONG_LOCALITY_ATRELEASE  (0x00080000) /* UINT32 */
+#define TSS_TSPATTRIB_KEYPCRLONG_CREATION_SELECTION  (0x000C0000) /* DATA */
+#define TSS_TSPATTRIB_KEYPCRLONG_RELEASE_SELECTION   (0x00100000) /* DATA */
+#define TSS_TSPATTRIB_KEYPCRLONG_DIGEST_ATCREATION   (0x00140000) /* DATA */
+#define TSS_TSPATTRIB_KEYPCRLONG_DIGEST_ATRELEASE    (0x00180000) /* DATA */
+
+//
+// SubFlags for Flag TSS_TSPATTRIB_KEY_CMKINFO
+//
+#define TSS_TSPATTRIB_KEYINFO_CMK_MA_APPROVAL  (0x00000010)
+#define TSS_TSPATTRIB_KEYINFO_CMK_MA_DIGEST    (0x00000020)
+
+
+//
+// Attribute Values
+//
+
+//
+// key size definitions
+//
+#define TSS_KEY_SIZEVAL_512BIT      (0x0200)
+#define TSS_KEY_SIZEVAL_1024BIT     (0x0400)
+#define TSS_KEY_SIZEVAL_2048BIT     (0x0800)
+#define TSS_KEY_SIZEVAL_4096BIT     (0x1000)
+#define TSS_KEY_SIZEVAL_8192BIT     (0x2000)
+#define TSS_KEY_SIZEVAL_16384BIT    (0x4000)
+
+//
+// key usage definitions
+// Values intentionally moved away from corresponding TPM values to avoid
+// possible misuse
+//
+#define TSS_KEYUSAGE_BIND           (0x00)   
+#define TSS_KEYUSAGE_IDENTITY       (0x01)   
+#define TSS_KEYUSAGE_LEGACY         (0x02)   
+#define TSS_KEYUSAGE_SIGN           (0x03)   
+#define TSS_KEYUSAGE_STORAGE        (0x04)
+#define TSS_KEYUSAGE_AUTHCHANGE     (0x05)
+#define TSS_KEYUSAGE_MIGRATE        (0x06)
+
+//
+// key flag definitions
+//
+#define TSS_KEYFLAG_REDIRECTION          (0x00000001)
+#define TSS_KEYFLAG_MIGRATABLE           (0x00000002)
+#define TSS_KEYFLAG_VOLATILEKEY          (0x00000004)
+#define TSS_KEYFLAG_CERTIFIED_MIGRATABLE (0x00000008)
+
+//
+//  algorithm ID definitions
+//
+//  This table defines the algo id's
+//  Values intentionally moved away from corresponding TPM values to avoid
+//  possible misuse
+//
+#define   TSS_ALG_RSA               (0x20)
+#define   TSS_ALG_DES               (0x21)
+#define   TSS_ALG_3DES              (0x22)
+#define   TSS_ALG_SHA               (0x23)
+#define   TSS_ALG_HMAC              (0x24)
+#define   TSS_ALG_AES128            (0x25)
+#define   TSS_ALG_AES192            (0x26)
+#define   TSS_ALG_AES256            (0x27)
+#define   TSS_ALG_XOR               (0x28)
+#define   TSS_ALG_MGF1              (0x29)
+
+#define   TSS_ALG_AES               TSS_ALG_AES128
+
+// Special values for 
+//   Tspi_Context_GetCapability(TSS_TSPCAP_ALG)
+//   Tspi_Context_GetCapability(TSS_TCSCAP_ALG)
+#define   TSS_ALG_DEFAULT           (0xfe)
+#define   TSS_ALG_DEFAULT_SIZE      (0xff)
+
+
+//
+// key signature scheme definitions
+//
+#define TSS_SS_NONE                 (0x10)
+#define TSS_SS_RSASSAPKCS1V15_SHA1  (0x11)
+#define TSS_SS_RSASSAPKCS1V15_DER   (0x12)
+#define	TSS_SS_RSASSAPKCS1V15_INFO  (0x13)
+
+//
+// key encryption scheme definitions
+//
+#define TSS_ES_NONE                 (0x10)
+#define TSS_ES_RSAESPKCSV15         (0x11)
+#define TSS_ES_RSAESOAEP_SHA1_MGF1  (0x12)
+#define TSS_ES_SYM_CNT              (0x13)
+#define TSS_ES_SYM_OFB              (0x14)
+#define TSS_ES_SYM_CBC_PKCS5PAD     (0x15)
+
+
+//
+// persistent storage registration definitions
+//
+#define TSS_PS_TYPE_USER   (1) // Key is registered persistantly in the user
+                               // storage database.
+#define TSS_PS_TYPE_SYSTEM (2) // Key is registered persistantly in the system
+                               // storage database.
+
+//
+// migration scheme definitions
+// Values intentionally moved away from corresponding TPM values to avoid
+// possible misuse
+//
+#define TSS_MS_MIGRATE                   (0x20)
+#define TSS_MS_REWRAP                    (0x21)
+#define TSS_MS_MAINT                     (0x22)
+#define TSS_MS_RESTRICT_MIGRATE          (0x23)
+#define TSS_MS_RESTRICT_APPROVE_DOUBLE   (0x24)
+#define TSS_MS_RESTRICT_MIGRATE_EXTERNAL (0x25)
+
+//
+// TPM key authorization
+// Values intentionally moved away from corresponding TPM values to avoid
+// possible misuse
+//
+#define TSS_KEYAUTH_AUTH_NEVER         (0x10)
+#define TSS_KEYAUTH_AUTH_ALWAYS        (0x11)
+#define TSS_KEYAUTH_AUTH_PRIV_USE_ONLY (0x12)
+
+
+//
+// Flags for TPM status information (GetStatus and SetStatus)
+//
+#define TSS_TPMSTATUS_DISABLEOWNERCLEAR      (0x00000001) // persistent flag
+#define TSS_TPMSTATUS_DISABLEFORCECLEAR      (0x00000002) // volatile flag
+#define TSS_TPMSTATUS_DISABLED               (0x00000003) // persistent flag
+#define TSS_TPMSTATUS_DEACTIVATED            (0x00000004) // volatile flag
+#define TSS_TPMSTATUS_OWNERSETDISABLE        (0x00000005) // persistent flag
+                                                          // for SetStatus
+                                                          // (disable flag) 
+#define TSS_TPMSTATUS_SETOWNERINSTALL        (0x00000006) // persistent flag
+                                                          // (ownership flag)
+#define TSS_TPMSTATUS_DISABLEPUBEKREAD       (0x00000007) // persistent flag
+#define TSS_TPMSTATUS_ALLOWMAINTENANCE       (0x00000008) // persistent flag
+#define TSS_TPMSTATUS_PHYSPRES_LIFETIMELOCK  (0x00000009) // persistent flag
+#define TSS_TPMSTATUS_PHYSPRES_HWENABLE      (0x0000000A) // persistent flag
+#define TSS_TPMSTATUS_PHYSPRES_CMDENABLE     (0x0000000B) // persistent flag
+#define TSS_TPMSTATUS_PHYSPRES_LOCK          (0x0000000C) // volatile flag
+#define TSS_TPMSTATUS_PHYSPRESENCE           (0x0000000D) // volatile flag
+#define TSS_TPMSTATUS_PHYSICALDISABLE        (0x0000000E) // persistent flag
+                                                          // (SetStatus
+                                                          //  disable flag)
+#define TSS_TPMSTATUS_CEKP_USED              (0x0000000F) // persistent flag
+#define TSS_TPMSTATUS_PHYSICALSETDEACTIVATED (0x00000010) // persistent flag
+                                                          // (deactivated flag)
+#define TSS_TPMSTATUS_SETTEMPDEACTIVATED     (0x00000011) // volatile flag
+                                                          // (deactivated flag)
+#define TSS_TPMSTATUS_POSTINITIALISE         (0x00000012) // volatile flag
+#define TSS_TPMSTATUS_TPMPOST                (0x00000013) // persistent flag
+#define TSS_TPMSTATUS_TPMPOSTLOCK            (0x00000014) // persistent flag
+#define TSS_TPMSTATUS_DISABLEPUBSRKREAD      (0x00000016) // persistent flag
+#define TSS_TPMSTATUS_MAINTENANCEUSED        (0x00000017) // persistent flag
+#define TSS_TPMSTATUS_OPERATORINSTALLED      (0x00000018) // persistent flag
+#define TSS_TPMSTATUS_OPERATOR_INSTALLED     (TSS_TPMSTATUS_OPERATORINSTALLED)
+#define TSS_TPMSTATUS_FIPS                   (0x00000019) // persistent flag
+#define TSS_TPMSTATUS_ENABLEREVOKEEK         (0x0000001A) // persistent flag
+#define TSS_TPMSTATUS_ENABLE_REVOKEEK        (TSS_TPMSTATUS_ENABLEREVOKEEK)
+#define TSS_TPMSTATUS_NV_LOCK                (0x0000001B) // persistent flag
+#define TSS_TPMSTATUS_TPM_ESTABLISHED        (0x0000001C) // persistent flag
+#define TSS_TPMSTATUS_RESETLOCK              (0x0000001D) // volatile flag
+#define TSS_TPMSTATUS_DISABLE_FULL_DA_LOGIC_INFO (0x0000001D) //persistent flag
+
+
+//
+// Capability flag definitions
+//
+// TPM capabilities            
+//
+#define TSS_TPMCAP_ORD                   (0x10)
+#define TSS_TPMCAP_ALG                   (0x11)
+#define TSS_TPMCAP_FLAG                  (0x12)
+#define TSS_TPMCAP_PROPERTY              (0x13)
+#define TSS_TPMCAP_VERSION               (0x14)
+#define TSS_TPMCAP_VERSION_VAL           (0x15)
+#define TSS_TPMCAP_NV_LIST               (0x16)
+#define TSS_TPMCAP_NV_INDEX              (0x17)
+#define TSS_TPMCAP_MFR                   (0x18)
+#define TSS_TPMCAP_SYM_MODE              (0x19)
+#define TSS_TPMCAP_HANDLE                (0x1a)
+#define TSS_TPMCAP_TRANS_ES              (0x1b)
+#define TSS_TPMCAP_AUTH_ENCRYPT          (0x1c)  
+#define TSS_TPMCAP_SET_PERM_FLAGS        (0x1d)  // cf. TPM_SET_PERM_FLAGS
+#define TSS_TPMCAP_SET_VENDOR            (0x1e)  // cf. TPM_SET_VENDOR
+#define TSS_TPMCAP_DA_LOGIC              (0x1f)
+
+//
+// Sub-Capability Flags for TSS_TPMCAP_PROPERTY
+//
+#define TSS_TPMCAP_PROP_PCR                 (0x10)
+#define TSS_TPMCAP_PROP_DIR                 (0x11)
+#define TSS_TPMCAP_PROP_MANUFACTURER        (0x12)
+#define TSS_TPMCAP_PROP_SLOTS               (0x13)
+#define TSS_TPMCAP_PROP_KEYS                TSS_TPMCAP_PROP_SLOTS
+#define TSS_TPMCAP_PROP_FAMILYROWS          (0x14)
+#define TSS_TPMCAP_PROP_DELEGATEROWS        (0x15)
+#define TSS_TPMCAP_PROP_OWNER               (0x16)
+#define TSS_TPMCAP_PROP_MAXKEYS             (0x18)
+#define TSS_TPMCAP_PROP_AUTHSESSIONS        (0x19)
+#define TSS_TPMCAP_PROP_MAXAUTHSESSIONS     (0x1a)
+#define TSS_TPMCAP_PROP_TRANSESSIONS        (0x1b)
+#define TSS_TPMCAP_PROP_MAXTRANSESSIONS     (0x1c)
+#define TSS_TPMCAP_PROP_SESSIONS            (0x1d)
+#define TSS_TPMCAP_PROP_MAXSESSIONS         (0x1e)
+#define TSS_TPMCAP_PROP_CONTEXTS            (0x1f)
+#define TSS_TPMCAP_PROP_MAXCONTEXTS         (0x20)
+#define TSS_TPMCAP_PROP_DAASESSIONS         (0x21)
+#define TSS_TPMCAP_PROP_MAXDAASESSIONS      (0x22)
+#define TSS_TPMCAP_PROP_DAA_INTERRUPT       (0x23)
+#define TSS_TPMCAP_PROP_COUNTERS            (0x24)
+#define TSS_TPMCAP_PROP_MAXCOUNTERS         (0x25)
+#define TSS_TPMCAP_PROP_ACTIVECOUNTER       (0x26)
+#define TSS_TPMCAP_PROP_MIN_COUNTER         (0x27)
+#define TSS_TPMCAP_PROP_TISTIMEOUTS         (0x28)
+#define TSS_TPMCAP_PROP_STARTUPEFFECTS      (0x29)
+#define TSS_TPMCAP_PROP_MAXCONTEXTCOUNTDIST (0x2a)
+#define TSS_TPMCAP_PROP_CMKRESTRICTION      (0x2b)
+#define TSS_TPMCAP_PROP_DURATION            (0x2c)
+#define TSS_TPMCAP_PROP_MAXNVAVAILABLE      (0x2d)
+#define TSS_TPMCAP_PROP_INPUTBUFFERSIZE     (0x2e)
+#define TSS_TPMCAP_PROP_REVISION            (0x2f)
+#define TSS_TPMCAP_PROP_LOCALITIES_AVAIL    (0x32)
+
+//
+// Resource type flags
+// Sub-Capability Flags for TSS_TPMCAP_HANDLE
+//
+#define TSS_RT_KEY                     ((UINT32)0x00000010)
+#define TSS_RT_AUTH                    ((UINT32)0x00000020)
+#define TSS_RT_TRANS                   ((UINT32)0x00000030)
+#define TSS_RT_COUNTER                 ((UINT32)0x00000040)
+
+
+//
+// TSS Core Service Capabilities   
+//
+#define TSS_TCSCAP_ALG                   (0x00000001)
+#define TSS_TCSCAP_VERSION               (0x00000002)
+#define TSS_TCSCAP_CACHING               (0x00000003)
+#define TSS_TCSCAP_PERSSTORAGE           (0x00000004)
+#define TSS_TCSCAP_MANUFACTURER          (0x00000005)
+#define TSS_TCSCAP_PLATFORM_CLASS        (0x00000006)
+#define TSS_TCSCAP_TRANSPORT             (0x00000007)
+#define TSS_TCSCAP_PLATFORM_INFO         (0x00000008)
+
+//
+// Sub-Capability Flags TSS-CoreService-Capabilities
+//
+#define TSS_TCSCAP_PROP_KEYCACHE         (0x00000100)
+#define TSS_TCSCAP_PROP_AUTHCACHE        (0x00000101)
+#define TSS_TCSCAP_PROP_MANUFACTURER_STR (0x00000102)
+#define TSS_TCSCAP_PROP_MANUFACTURER_ID  (0x00000103)
+#define TSS_TCSCAP_PLATFORM_VERSION      (0x00001100)
+#define TSS_TCSCAP_PLATFORM_TYPE         (0x00001101)
+#define TSS_TCSCAP_TRANS_EXCLUSIVE       (0x00002100)
+#define TSS_TCSCAP_PROP_HOST_PLATFORM    (0x00003001)
+#define TSS_TCSCAP_PROP_ALL_PLATFORMS    (0x00003002)
+
+//
+// TSS Service Provider Capabilities      
+//
+#define TSS_TSPCAP_ALG                   (0x00000010)
+#define TSS_TSPCAP_VERSION               (0x00000011)
+#define TSS_TSPCAP_PERSSTORAGE           (0x00000012)
+#define TSS_TSPCAP_MANUFACTURER          (0x00000013)
+#define TSS_TSPCAP_RETURNVALUE_INFO      (0x00000015)
+#define TSS_TSPCAP_PLATFORM_INFO         (0x00000016)
+
+// Sub-Capability Flags for TSS_TSPCAP_MANUFACTURER
+//
+#define TSS_TSPCAP_PROP_MANUFACTURER_STR (0x00000102)
+#define TSS_TSPCAP_PROP_MANUFACTURER_ID  (0x00000103)
+
+// Sub-Capability Flags for TSS_TSPCAP_PLATFORM_INFO
+//
+#define TSS_TSPCAP_PLATFORM_TYPE         (0x00000201)
+#define TSS_TSPCAP_PLATFORM_VERSION      (0x00000202)
+
+
+
+// Sub-Capability Flags for TSS_TSPCAP_RETURNVALUE_INFO
+//
+#define TSS_TSPCAP_PROP_RETURNVALUE_INFO (0x00000201)
+
+//
+// Event type definitions
+//
+#define TSS_EV_CODE_CERT                 (0x00000001)
+#define TSS_EV_CODE_NOCERT               (0x00000002)
+#define TSS_EV_XML_CONFIG                (0x00000003)
+#define TSS_EV_NO_ACTION                 (0x00000004)
+#define TSS_EV_SEPARATOR                 (0x00000005)
+#define TSS_EV_ACTION                    (0x00000006)
+#define TSS_EV_PLATFORM_SPECIFIC         (0x00000007)
+
+
+//
+// TSP random number limits
+//
+#define TSS_TSPCAP_RANDOMLIMIT     (0x00001000)   // Errata: Missing from spec
+
+//
+// UUIDs
+//
+// Errata: This are not in the spec
+#define TSS_UUID_SRK  {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 1}} // Storage root key
+#define TSS_UUID_SK   {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 2}} // System key
+#define TSS_UUID_RK   {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 3}} // roaming key
+#define TSS_UUID_CRK  {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 8}} // CMK roaming key
+#define TSS_UUID_USK1 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 4}} // user storage key 1
+#define TSS_UUID_USK2 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 5}} // user storage key 2
+#define TSS_UUID_USK3 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 6}} // user storage key 3
+#define TSS_UUID_USK4 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 7}} // user storage key 4
+#define TSS_UUID_USK5 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 9}} // user storage key 5
+#define TSS_UUID_USK6 {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 10}}// user storage key 6
+
+/* SOLARIS: Migratable Root Key UUID */
+#define TSS_UUID_MRK {0, 0, 0, 0, 0, {0, 0, 0, 0, 0, 11}}
+
+// macro to derive UUIDs for keys whose "OwnerEvict" key is set.
+#define TSS_UUID_OWNEREVICT(i) {0, 0, 0, 0, 0, {0, 0, 0, 0, 1, (i)}}
+
+
+//
+// TPM well-known secret
+//
+#define TSS_WELL_KNOWN_SECRET \
+        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
+         0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
+
+
+// Values for the "direction" parameters in the Tspi_PcrComposite_XX functions.
+#define TSS_PCRS_DIRECTION_CREATION                        ((UINT32)1)
+#define TSS_PCRS_DIRECTION_RELEASE                         ((UINT32)2)
+
+
+//
+// TSS blob version definition for ASN.1 blobs
+//
+#define TSS_BLOB_STRUCT_VERSION                              0x01
+
+//
+// TSS blob type definitions for ASN.1 blobs
+//
+#define TSS_BLOB_TYPE_KEY                                    0x01
+#define TSS_BLOB_TYPE_PUBKEY                                 0x02
+#define TSS_BLOB_TYPE_MIGKEY                                 0x03
+#define TSS_BLOB_TYPE_SEALEDDATA                             0x04
+#define TSS_BLOB_TYPE_BOUNDDATA                              0x05
+#define TSS_BLOB_TYPE_MIGTICKET                              0x06
+#define TSS_BLOB_TYPE_PRIVATEKEY                             0x07
+#define TSS_BLOB_TYPE_PRIVATEKEY_MOD1                        0x08
+#define TSS_BLOB_TYPE_RANDOM_XOR                             0x09
+#define TSS_BLOB_TYPE_CERTIFY_INFO                           0x0A
+#define TSS_BLOB_TYPE_KEY_1_2                                0x0B
+#define TSS_BLOB_TYPE_CERTIFY_INFO_2                         0x0C
+#define TSS_BLOB_TYPE_CMK_MIG_KEY                            0x0D
+#define TSS_BLOB_TYPE_CMK_BYTE_STREAM                        0x0E
+
+
+
+//
+// Values for TPM_CMK_DELEGATE bitmasks
+// For now these are exactly the same values as the corresponding
+// TPM_CMK_DELEGATE_* bitmasks.
+//
+#define TSS_CMK_DELEGATE_SIGNING       (((UINT32)1)<<31)
+#define TSS_CMK_DELEGATE_STORAGE       (((UINT32)1)<<30)
+#define TSS_CMK_DELEGATE_BIND          (((UINT32)1)<<29)
+#define TSS_CMK_DELEGATE_LEGACY        (((UINT32)1)<<28)
+#define TSS_CMK_DELEGATE_MIGRATE       (((UINT32)1)<<27)
+
+
+//
+// Constants for DAA
+//
+#define TSS_DAA_LENGTH_N                256             // Length of the RSA Modulus (2048 bits)
+#define TSS_DAA_LENGTH_F                13              // Length of the f_i's (information encoded into the certificate, 104 bits)
+#define TSS_DAA_LENGTH_E                46              // Length of the e's (exponents, part of certificate, 386 bits)
+#define TSS_DAA_LENGTH_E_PRIME          15              // Length of the interval the e's are chosen from (120 bits)
+#define TSS_DAA_LENGTH_V                317             // Length of the v's (random value, part of certificate, 2536 bits)
+#define TSS_DAA_LENGTH_SAFETY           10              // Length of the security parameter controlling the statistical zero-knowledge property (80 bits)
+#define TSS_DAA_LENGTH_HASH     TPM_SHA1_160_HASH_LEN   // Length of the output of the hash function SHA-1 used for the Fiat-Shamir heuristic(160 bits)
+#define TSS_DAA_LENGTH_S                128             // Length of the split large exponent for easier computations on the TPM (1024 bits)
+#define TSS_DAA_LENGTH_GAMMA            204             // Length of the modulus 'Gamma' (1632 bits)
+#define TSS_DAA_LENGTH_RHO              26              // Length of the order 'rho' of the sub group of Z*_Gamma that is used for roggue tagging (208 bits)
+#define TSS_DAA_LENGTH_MFG1_GAMMA       214             // Length of the output of MGF1 in conjunction with the modulus Gamma (1712 bits)
+#define TSS_DAA_LENGTH_MGF1_AR          25              // Length of the output of MGF1 used for anonymity revocation (200 bits)
+
+
+#endif // __TSS_DEFINES_H__
diff -ru trousers-0.3.8-orig/src/include/tss/tss_error_basics.h trousers-0.3.8/src/include/tss/tss_error_basics.h
--- trousers-0.3.8-orig/src/include/tss/tss_error_basics.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tss_error_basics.h	2012-02-14 20:35:05.918084175 +0000
@@ -1,59 +1,59 @@
-/*++
-
-Basic defines for TSS error return codes
- 
---*/
-
-#ifndef __TSS_ERROR_BASICS_H__
-#define __TSS_ERROR_BASICS_H__
-
-
-//
-// definitions for the various TSS-SW layers
-//
-#ifndef TSS_LAYER_TPM
-#define TSS_LAYER_TPM   0x0000L     // definition for TPM layer
-#endif // TSS_LAYER_TPM
-
-#define TSS_LAYER_TDDL   0x1000L     // definition for TDDL layer
-#define TSS_LAYER_TCS   0x2000L     // definition for TCS layer
-
-#ifndef TSS_LAYER_TSP
-#define TSS_LAYER_TSP   0x3000L     // definition for TSP layer
-#endif // TSS_LAYER_TSP
-
-
-//
-// definitions for the start points of layer specific error codes
-//
-#ifndef TSS_COMMON_OFFSET
-#define TSS_COMMON_OFFSET   0x000L     
-#endif // TSS_COMMON_OFFSET
-
-#define TSS_TDDL_OFFSET    0x080L     
-#define TSS_TCSI_OFFSET    0x0C0L     
-
-#ifndef TSS_TSPI_OFFSET
-#define TSS_TSPI_OFFSET    0x100L     
-#endif // TSS_TSPI_OFFSET
-
-#ifndef TSS_VENDOR_OFFSET
-#define TSS_VENDOR_OFFSET   0x800L       
-#endif // TSS_VENDOR_OFFSET
- 
-// do not exceed TSS_MAX_ERROR for vendor specific code values:               
-#ifndef TSS_MAX_ERROR              
-#define TSS_MAX_ERROR    0xFFFL 
-#endif // TSS_MAX_ERROR
-
-
-/* Macros for the construction and interpretation of error codes */
-#define TPM_ERROR(code)        (code)
-#define TDDL_ERROR(code)       ((code) ? (TSS_LAYER_TDDL | (code)) : (code))
-#define TCS_ERROR(code)        ((code) ? (TSS_LAYER_TCS | (code)) : (code))
-#define TSP_ERROR(code)        ((code) ? (TSS_LAYER_TSP | (code)) : (code))
-#define ERROR_LAYER(error)     ((error) & 0xf000)
-#define ERROR_CODE(error)      ((error) & 0x0fff)
-
-#endif // __TSS_ERROR_BASICS_H__
-
+/*++
+
+Basic defines for TSS error return codes
+ 
+--*/
+
+#ifndef __TSS_ERROR_BASICS_H__
+#define __TSS_ERROR_BASICS_H__
+
+
+//
+// definitions for the various TSS-SW layers
+//
+#ifndef TSS_LAYER_TPM
+#define TSS_LAYER_TPM   0x0000L     // definition for TPM layer
+#endif // TSS_LAYER_TPM
+
+#define TSS_LAYER_TDDL   0x1000L     // definition for TDDL layer
+#define TSS_LAYER_TCS   0x2000L     // definition for TCS layer
+
+#ifndef TSS_LAYER_TSP
+#define TSS_LAYER_TSP   0x3000L     // definition for TSP layer
+#endif // TSS_LAYER_TSP
+
+
+//
+// definitions for the start points of layer specific error codes
+//
+#ifndef TSS_COMMON_OFFSET
+#define TSS_COMMON_OFFSET   0x000L     
+#endif // TSS_COMMON_OFFSET
+
+#define TSS_TDDL_OFFSET    0x080L     
+#define TSS_TCSI_OFFSET    0x0C0L     
+
+#ifndef TSS_TSPI_OFFSET
+#define TSS_TSPI_OFFSET    0x100L     
+#endif // TSS_TSPI_OFFSET
+
+#ifndef TSS_VENDOR_OFFSET
+#define TSS_VENDOR_OFFSET   0x800L       
+#endif // TSS_VENDOR_OFFSET
+ 
+// do not exceed TSS_MAX_ERROR for vendor specific code values:               
+#ifndef TSS_MAX_ERROR              
+#define TSS_MAX_ERROR    0xFFFL 
+#endif // TSS_MAX_ERROR
+
+
+/* Macros for the construction and interpretation of error codes */
+#define TPM_ERROR(code)        (code)
+#define TDDL_ERROR(code)       ((code) ? (TSS_LAYER_TDDL | (code)) : (code))
+#define TCS_ERROR(code)        ((code) ? (TSS_LAYER_TCS | (code)) : (code))
+#define TSP_ERROR(code)        ((code) ? (TSS_LAYER_TSP | (code)) : (code))
+#define ERROR_LAYER(error)     ((error) & 0xf000)
+#define ERROR_CODE(error)      ((error) & 0x0fff)
+
+#endif // __TSS_ERROR_BASICS_H__
+
diff -ru trousers-0.3.8-orig/src/include/tss/tss_error.h trousers-0.3.8/src/include/tss/tss_error.h
--- trousers-0.3.8-orig/src/include/tss/tss_error.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tss_error.h	2012-02-14 20:35:05.918849513 +0000
@@ -1,687 +1,687 @@
-/*++
-
-TSS error return codes 
- 
---*/
-
-#ifndef __TSS_ERROR_H__
-#define __TSS_ERROR_H__
-
-#include <tss/platform.h>
-
-//
-// error coding scheme for a Microsoft Windows platform -
-// refer to the TSS Specification Parts
-//
-//  Values are 32 bit values layed out as follows:
-//
-//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
-//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
-//  +---+-+-+-----------------------+-------+-----------------------+
-//  |Lev|C|R|     Facility          | Layer |         Code          |
-//  +---+-+-+-----------------------+-------+-----------------------+
-//  | Platform specific coding      | TSS error coding system       |
-//  +---+-+-+-----------------------+-------+-----------------------+
-//
-//      Lev - is the Level code
-//
-//          00 - Success
-//          01 - Informational
-//          10 - Warning
-//          11 - Error
-//
-//      C - is the Customer code flag  (must actually be set)
-//
-//      R - is a reserved bit    (unused)
-//
-//      Facility - is the facility code: TCPA: proposal 0x028
-//
-//      Code - is the facility's status code
-//
-
-//
-// definitions for the code level information
-//
-#define TSS_LEVEL_SUCCESS  0x00     // code level success 
-#define TSS_LEVEL_INFO     0x40000000L    // code level information
-#define TSS_LEVEL_WARNING  0x80000000L    // code level warning
-#define TSS_LEVEL_ERROR    0xC0000000L    // code level error
-
-//
-// some defines for the platform specific information
-//
-#define FACILITY_TSS            0x28L     // facility number for TCPA return codes
-#define FACILITY_TSS_CODEPOS   (FACILITY_TSS << 16)  // shift the facility info to the code 
-                                                                        // position
-
-#define TSS_CUSTOM_CODEFLAG     0x20000000L    // bit position for the custom flag in 
-                                                                        // return code
-
-//
-//
-// TSS error return codes
-//
-//
-#ifndef TSS_E_BASE
-#define TSS_E_BASE    0x00000000L
-#endif // TSS_E_BASE
-#ifndef TSS_W_BASE
-#define TSS_W_BASE    0x00000000L
-#endif // TSS_W_BASE
-#ifndef TSS_I_BASE
-#define TSS_I_BASE    0x00000000L
-#endif // TSS_I_BASE
-
-//
-// basic error return codes common to all TSS Service Provider Interface methods
-// and returned by all TSS SW stack components
-//
-
-//
-// MessageId: TSS_SUCCESS
-//
-// MessageText:
-//
-//  Successful completion of the operation.
-//
-#define TSS_SUCCESS     (UINT32)(0x00000000L)
-
-//
-// MessageId: TSS_E_FAIL
-//
-// MessageText:
-//
-//  An internal error has been detected, but the source is unknown.
-//
-#define TSS_E_FAIL     (UINT32)(TSS_E_BASE + 0x002L)
-
-//
-// MessageId: TSS_E_BAD_PARAMETER
-//
-// MessageText:
-//
-// One or more parameter is bad.
-//
-#define TSS_E_BAD_PARAMETER    (UINT32)(TSS_E_BASE + 0x003L)
-
-//
-// MessageId: TSS_E_INTERNAL_ERROR
-//
-// MessageText:
-//
-//  An internal SW error has been detected.
-//
-#define TSS_E_INTERNAL_ERROR    (UINT32)(TSS_E_BASE + 0x004L)
-
-//
-// MessageId: TSS_E_OUTOFMEMORY
-//
-// MessageText:
-//
-// Ran out of memory.
-//
-#define TSS_E_OUTOFMEMORY    (UINT32)(TSS_E_BASE + 0x005L)
-
-//
-// MessageId: TSS_E_NOTIMPL
-//
-// MessageText:
-//
-// Not implemented.
-//
-#define TSS_E_NOTIMPL     (UINT32)(TSS_E_BASE + 0x006L)
-
-//
-// MessageId: TSS_E_KEY_ALREADY_REGISTERED
-//
-// MessageText:
-//
-//  Key is already registered
-//
-#define TSS_E_KEY_ALREADY_REGISTERED  (UINT32)(TSS_E_BASE + 0x008L)
-
-
-//
-// MessageId: TSS_E_TPM_UNEXPECTED
-//
-// MessageText:
-//
-//  An unexpected TPM error has occurred.
-//
-#define TSS_E_TPM_UNEXPECTED    (UINT32)(TSS_E_BASE + 0x010L)
-
-//
-// MessageId: TSS_E_COMM_FAILURE
-//
-// MessageText:
-//
-//  A communications error with the TPM has been detected.
-//
-#define TSS_E_COMM_FAILURE    (UINT32)(TSS_E_BASE + 0x011L)
-
-//
-// MessageId: TSS_E_TIMEOUT
-//
-// MessageText:
-//
-//  The operation has timed out.
-//
-#define TSS_E_TIMEOUT     (UINT32)(TSS_E_BASE + 0x012L)
-
-//
-// MessageId: TSS_E_TPM_UNSUPPORTED_FEATURE
-//
-// MessageText:
-//
-//  The TPM does not support the requested feature.
-//
-#define TSS_E_TPM_UNSUPPORTED_FEATURE  (UINT32)(TSS_E_BASE + 0x014L)
-
-//
-// MessageId: TSS_E_CANCELED
-//
-// MessageText:
-//
-//  The action was canceled by request.
-//
-#define TSS_E_CANCELED     (UINT32)(TSS_E_BASE + 0x016L)
-
-//
-// MessageId: TSS_E_PS_KEY_NOTFOUND
-//
-// MessageText:
-//
-// The key cannot be found in the persistent storage database.
-//
-#define TSS_E_PS_KEY_NOTFOUND    (UINT32)(TSS_E_BASE + 0x020L)
-//
-// MessageId: TSS_E_PS_KEY_EXISTS
-//
-// MessageText:
-//
-// The key already exists in the persistent storage database.
-//
-#define TSS_E_PS_KEY_EXISTS            (UINT32)(TSS_E_BASE + 0x021L)
-
-//
-// MessageId: TSS_E_PS_BAD_KEY_STATE
-//
-// MessageText:
-//
-// The key data set not valid in the persistent storage database.
-//
-#define TSS_E_PS_BAD_KEY_STATE         (UINT32)(TSS_E_BASE + 0x022L)
-
-
-//
-// error codes returned by specific TSS Service Provider Interface methods
-// offset TSS_TSPI_OFFSET
-//
-
-//
-// MessageId: TSS_E_INVALID_OBJECT_TYPE
-//
-// MessageText:
-//
-// Object type not valid for this operation.
-//
-#define TSS_E_INVALID_OBJECT_TYPE   (UINT32)(TSS_E_BASE + 0x101L)
-
-//
-// MessageId: TSS_E_NO_CONNECTION
-//
-// MessageText:
-//
-// Core Service connection doesn't exist.
-//
-#define TSS_E_NO_CONNECTION    (UINT32)(TSS_E_BASE + 0x102L)
- 
-//
-// MessageId: TSS_E_CONNECTION_FAILED
-//
-// MessageText:
-//
-// Core Service connection failed.
-//
-#define TSS_E_CONNECTION_FAILED   (UINT32)(TSS_E_BASE + 0x103L)
-
-//
-// MessageId: TSS_E_CONNECTION_BROKEN
-//
-// MessageText:
-//
-// Communication with Core Service failed.
-//
-#define TSS_E_CONNECTION_BROKEN   (UINT32)(TSS_E_BASE + 0x104L)
-
-//
-// MessageId: TSS_E_HASH_INVALID_ALG
-//
-// MessageText:
-//
-// Invalid hash algorithm.
-//
-#define TSS_E_HASH_INVALID_ALG   (UINT32)(TSS_E_BASE + 0x105L)
-
-//
-// MessageId: TSS_E_HASH_INVALID_LENGTH
-//
-// MessageText:
-//
-// Hash length is inconsistent with hash algorithm.
-//
-#define TSS_E_HASH_INVALID_LENGTH   (UINT32)(TSS_E_BASE + 0x106L)
-
-//
-// MessageId: TSS_E_HASH_NO_DATA
-//
-// MessageText:
-//
-// Hash object has no internal hash value.
-//
-#define TSS_E_HASH_NO_DATA    (UINT32)(TSS_E_BASE + 0x107L)
-
-
-//
-// MessageId: TSS_E_INVALID_ATTRIB_FLAG
-//
-// MessageText:
-//
-// Flag value for attrib-functions inconsistent.
-//
-#define TSS_E_INVALID_ATTRIB_FLAG   (UINT32)(TSS_E_BASE + 0x109L)
-
-//
-// MessageId: TSS_E_INVALID_ATTRIB_SUBFLAG
-//
-// MessageText:
-//
-// Subflag value for attrib-functions inconsistent.
-//
-#define TSS_E_INVALID_ATTRIB_SUBFLAG  (UINT32)(TSS_E_BASE + 0x10AL)
-
-//
-// MessageId: TSS_E_INVALID_ATTRIB_DATA
-//
-// MessageText:
-//
-// Data for attrib-functions invalid.
-//
-#define TSS_E_INVALID_ATTRIB_DATA   (UINT32)(TSS_E_BASE + 0x10BL)
-
-//
-// MessageId: TSS_E_INVALID_OBJECT_INITFLAG
-//
-// MessageText:
-//
-// Wrong flag information for object creation.
-// 
-// The alternate spelling is supported to be compatible with a typo
-// in the 1.1b header files.
-//
-#define TSS_E_INVALID_OBJECT_INIT_FLAG  (UINT32)(TSS_E_BASE + 0x10CL)
-#define TSS_E_INVALID_OBJECT_INITFLAG   TSS_E_INVALID_OBJECT_INIT_FLAG
- 
-//
-// MessageId: TSS_E_NO_PCRS_SET
-//
-// MessageText:
-//
-// No PCR register are selected or set.
-//
-#define TSS_E_NO_PCRS_SET    (UINT32)(TSS_E_BASE + 0x10DL)
-
-//
-// MessageId: TSS_E_KEY_NOT_LOADED
-//
-// MessageText:
-//
-// The addressed key is currently not loaded.
-//
-#define TSS_E_KEY_NOT_LOADED    (UINT32)(TSS_E_BASE + 0x10EL)
- 
-//
-// MessageId: TSS_E_KEY_NOT_SET
-//
-// MessageText:
-//
-// No key information is currently available.
-//
-#define TSS_E_KEY_NOT_SET    (UINT32)(TSS_E_BASE + 0x10FL)
-      
-//
-// MessageId: TSS_E_VALIDATION_FAILED
-//
-// MessageText:
-//
-// Internal validation of data failed.
-//
-#define TSS_E_VALIDATION_FAILED   (UINT32)(TSS_E_BASE + 0x110L)
-
-//
-// MessageId: TSS_E_TSP_AUTHREQUIRED
-//
-// MessageText:
-//
-// Authorization is required.
-//
-#define TSS_E_TSP_AUTHREQUIRED   (UINT32)(TSS_E_BASE + 0x111L)
-
-//
-// MessageId: TSS_E_TSP_AUTH2REQUIRED
-//
-// MessageText:
-//
-// Multiple authorization is required.
-//
-#define TSS_E_TSP_AUTH2REQUIRED   (UINT32)(TSS_E_BASE + 0x112L)
-
-//
-// MessageId: TSS_E_TSP_AUTHFAIL
-//
-// MessageText:
-//
-// Authorization failed.
-//
-#define TSS_E_TSP_AUTHFAIL    (UINT32)(TSS_E_BASE + 0x113L)
-
-//
-// MessageId: TSS_E_TSP_AUTH2FAIL
-//
-// MessageText:
-//
-// Multiple authorization failed.
-//
-#define TSS_E_TSP_AUTH2FAIL    (UINT32)(TSS_E_BASE + 0x114L)
- 
-//
-// MessageId: TSS_E_KEY_NO_MIGRATION_POLICY
-//
-// MessageText:
-//
-// There's no migration policy object set for the addressed key.
-//
-#define TSS_E_KEY_NO_MIGRATION_POLICY  (UINT32)(TSS_E_BASE + 0x115L) 
-
-//
-// MessageId: TSS_E_POLICY_NO_SECRET
-//
-// MessageText:
-//
-// No secret information is currently available for the addressed policy object.
-//
-#define TSS_E_POLICY_NO_SECRET   (UINT32)(TSS_E_BASE + 0x116L)
-
-//
-// MessageId: TSS_E_INVALID_OBJ_ACCESS
-//
-// MessageText:
-//
-// The operation failed due to an invalid object status.
-//
-#define TSS_E_INVALID_OBJ_ACCESS   (UINT32)(TSS_E_BASE + 0x117L)
-
-//
-// MessageId: TSS_E_INVALID_ENCSCHEME
-//
-// MessageText:
-//
-// 
-//
-#define TSS_E_INVALID_ENCSCHEME   (UINT32)(TSS_E_BASE + 0x118L)
-
-
-//
-// MessageId: TSS_E_INVALID_SIGSCHEME
-//
-// MessageText:
-//
-// 
-//
-#define TSS_E_INVALID_SIGSCHEME   (UINT32)(TSS_E_BASE + 0x119L)
-
-//
-// MessageId: TSS_E_ENC_INVALID_LENGTH
-//
-// MessageText:
-//
-// 
-//
-#define TSS_E_ENC_INVALID_LENGTH   (UINT32)(TSS_E_BASE + 0x120L)
-
-
-//
-// MessageId: TSS_E_ENC_NO_DATA
-//
-// MessageText:
-//
-// 
-//
-#define TSS_E_ENC_NO_DATA    (UINT32)(TSS_E_BASE + 0x121L)
-
-//
-// MessageId: TSS_E_ENC_INVALID_TYPE
-//
-// MessageText:
-//
-// 
-//
-#define TSS_E_ENC_INVALID_TYPE   (UINT32)(TSS_E_BASE + 0x122L)
-
-
-//
-// MessageId: TSS_E_INVALID_KEYUSAGE
-//
-// MessageText:
-//
-// 
-//
-#define TSS_E_INVALID_KEYUSAGE   (UINT32)(TSS_E_BASE + 0x123L)
-
-//
-// MessageId: TSS_E_VERIFICATION_FAILED
-//
-// MessageText:
-//
-// 
-//
-#define TSS_E_VERIFICATION_FAILED   (UINT32)(TSS_E_BASE + 0x124L)
-
-//
-// MessageId: TSS_E_HASH_NO_IDENTIFIER
-//
-// MessageText:
-//
-// Hash algorithm identifier not set.
-//
-#define TSS_E_HASH_NO_IDENTIFIER   (UINT32)(TSS_E_BASE + 0x125L)
-
-//
-// MessageId: TSS_E_INVALID_HANDLE
-//
-// MessageText:
-//
-//  An invalid handle
-//
-#define TSS_E_INVALID_HANDLE    (UINT32)(TSS_E_BASE + 0x126L)
-
-//
-// MessageId: TSS_E_SILENT_CONTEXT
-//
-// MessageText:
-//
-//  A silent context requires user input
-//
-#define TSS_E_SILENT_CONTEXT           (UINT32)(TSS_E_BASE + 0x127L)
-
-//
-// MessageId: TSS_E_EK_CHECKSUM
-//
-// MessageText:
-//
-// TSP is instructed to verify the EK checksum and it does not verify.
-//
-#define TSS_E_EK_CHECKSUM             (UINT32)(TSS_E_BASE + 0x128L)
-
-
-//
-// MessageId: TSS_E_DELGATION_NOTSET
-//
-// MessageText:
-//
-// The Policy object does not have a delegation blob set.
-//
-#define TSS_E_DELEGATION_NOTSET      (UINT32)(TSS_E_BASE + 0x129L)
-
-//
-// MessageId: TSS_E_DELFAMILY_NOTFOUND
-//
-// MessageText:
-//
-// The specified delegation family was not found
-//
-#define TSS_E_DELFAMILY_NOTFOUND       (UINT32)(TSS_E_BASE + 0x130L)
-
-//
-// MessageId: TSS_E_DELFAMILY_ROWEXISTS
-//
-// MessageText:
-//
-// The specified delegation family table row is already in use and
-// the command flags does not allow the TSS to overwrite the existing
-// entry.
-//
-#define TSS_E_DELFAMILY_ROWEXISTS    (UINT32)(TSS_E_BASE + 0x131L)
-
-//
-// MessageId: TSS_E_VERSION_MISMATCH
-//
-// MessageText:
-//
-// The specified delegation family table row is already in use and
-// the command flags does not allow the TSS to overwrite the existing
-// entry.
-//
-#define TSS_E_VERSION_MISMATCH       (UINT32)(TSS_E_BASE + 0x132L)
-
-//
-//  MessageId: TSS_E_DAA_AR_DECRYPTION_ERROR
-//
-//  Decryption of the encrypted pseudonym has failed, due to
-//  either a wrong secret key or a wrong decryption condition.
-//
-#define TSS_E_DAA_AR_DECRYPTION_ERROR             (UINT32)(TSS_E_BASE + 0x133L)
-
-//
-//  MessageId: TSS_E_DAA_AUTHENTICATION_ERROR
-//
-//  The TPM could not be authenticated by the DAA Issuer.
-//
-#define TSS_E_DAA_AUTHENTICATION_ERROR            (UINT32)(TSS_E_BASE + 0x134L)
-
-//
-//  MessageId: TSS_E_DAA_CHALLENGE_RESPONSE_ERROR
-//
-//  DAA Challenge response error.
-//
-#define TSS_E_DAA_CHALLENGE_RESPONSE_ERROR        (UINT32)(TSS_E_BASE + 0x135L)
-
-//
-//  MessageId: TSS_E_DAA_CREDENTIAL_PROOF_ERROR
-//
-//  Verification of the credential TSS_DAA_CRED_ISSUER issued by
-//  the DAA Issuer has failed.
-//
-#define TSS_E_DAA_CREDENTIAL_PROOF_ERROR          (UINT32)(TSS_E_BASE + 0x136L)
-
-//
-//  MessageId: TSS_E_DAA_CREDENTIAL_REQUEST_PROOF_ERROR
-//
-//  Verification of the platform's credential request
-//  TSS_DAA_CREDENTIAL_REQUEST has failed.
-//
-#define TSS_E_DAA_CREDENTIAL_REQUEST_PROOF_ERROR  (UINT32)(TSS_E_BASE + 0x137L)
-
-//
-//  MessageId: TSS_E_DAA_ISSUER_KEY_ERROR
-//
-//  DAA Issuer's authentication key chain could not be verified or
-//  is not correct.
-//
-#define TSS_E_DAA_ISSUER_KEY_ERROR                (UINT32)(TSS_E_BASE + 0x138L)
-
-//
-//  MessageId: TSS_E_DAA_PSEUDONYM_ERROR
-//
-//  While verifying the pseudonym of the TPM, the private key of the
-//  TPM was found on the rogue list.
-//
-#define TSS_E_DAA_PSEUDONYM_ERROR                 (UINT32)(TSS_E_BASE + 0x139L)
-
-//
-//  MessageId: TSS_E_INVALID_RESOURCE
-//
-//  Pointer to memory wrong.
-//
-#define TSS_E_INVALID_RESOURCE                    (UINT32)(TSS_E_BASE + 0x13AL)
-
-//
-//  MessageId: TSS_E_NV_AREA_EXIST
-//
-//  The NV area referenced already exists
-//
-#define TSS_E_NV_AREA_EXIST                       (UINT32)(TSS_E_BASE + 0x13BL)
-
-//
-//  MessageId: TSS_E_NV_AREA_NOT_EXIST
-//
-//  The NV area referenced doesn't exist
-//
-#define TSS_E_NV_AREA_NOT_EXIST                   (UINT32)(TSS_E_BASE + 0x13CL)
-
-//
-//  MessageId: TSS_E_TSP_TRANS_AUTHFAIL
-//
-//  The transport session authorization failed
-//
-#define TSS_E_TSP_TRANS_AUTHFAIL                  (UINT32)(TSS_E_BASE + 0x13DL)
-
-//
-//  MessageId: TSS_E_TSP_TRANS_AUTHREQUIRED
-//
-//  Authorization for transport is required
-//
-#define TSS_E_TSP_TRANS_AUTHREQUIRED              (UINT32)(TSS_E_BASE + 0x13EL)
-
-//
-//  MessageId: TSS_E_TSP_TRANS_NOT_EXCLUSIVE
-//
-//  A command was executed outside of an exclusive transport session.
-//
-#define TSS_E_TSP_TRANS_NOTEXCLUSIVE              (UINT32)(TSS_E_BASE + 0x13FL)
-
-//
-//  MessageId: TSS_E_TSP_TRANS_FAIL
-//
-//  Generic transport protection error.
-//
-#define TSS_E_TSP_TRANS_FAIL                     (UINT32)(TSS_E_BASE + 0x140L)
-
-//
-//  MessageId: TSS_E_TSP_TRANS_NO_PUBKEY
-//
-//  A command could not be executed through a logged transport session
-//  because the command used a key and the key's public key is not
-//  known to the TSP.
-//
-#define TSS_E_TSP_TRANS_NO_PUBKEY                (UINT32)(TSS_E_BASE + 0x141L)
-
-//
-//  MessageId: TSS_E_NO_ACTIVE_COUNTER
-//
-//  The TPM active counter has not been set yet.
-//
-#define TSS_E_NO_ACTIVE_COUNTER                  (UINT32)(TSS_E_BASE + 0x142L)
-
-
-#endif // __TSS_ERROR_H__
+/*++
+
+TSS error return codes 
+ 
+--*/
+
+#ifndef __TSS_ERROR_H__
+#define __TSS_ERROR_H__
+
+#include <tss/platform.h>
+
+//
+// error coding scheme for a Microsoft Windows platform -
+// refer to the TSS Specification Parts
+//
+//  Values are 32 bit values layed out as follows:
+//
+//   3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
+//   1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+//  +---+-+-+-----------------------+-------+-----------------------+
+//  |Lev|C|R|     Facility          | Layer |         Code          |
+//  +---+-+-+-----------------------+-------+-----------------------+
+//  | Platform specific coding      | TSS error coding system       |
+//  +---+-+-+-----------------------+-------+-----------------------+
+//
+//      Lev - is the Level code
+//
+//          00 - Success
+//          01 - Informational
+//          10 - Warning
+//          11 - Error
+//
+//      C - is the Customer code flag  (must actually be set)
+//
+//      R - is a reserved bit    (unused)
+//
+//      Facility - is the facility code: TCPA: proposal 0x028
+//
+//      Code - is the facility's status code
+//
+
+//
+// definitions for the code level information
+//
+#define TSS_LEVEL_SUCCESS  0x00     // code level success 
+#define TSS_LEVEL_INFO     0x40000000L    // code level information
+#define TSS_LEVEL_WARNING  0x80000000L    // code level warning
+#define TSS_LEVEL_ERROR    0xC0000000L    // code level error
+
+//
+// some defines for the platform specific information
+//
+#define FACILITY_TSS            0x28L     // facility number for TCPA return codes
+#define FACILITY_TSS_CODEPOS   (FACILITY_TSS << 16)  // shift the facility info to the code 
+                                                                        // position
+
+#define TSS_CUSTOM_CODEFLAG     0x20000000L    // bit position for the custom flag in 
+                                                                        // return code
+
+//
+//
+// TSS error return codes
+//
+//
+#ifndef TSS_E_BASE
+#define TSS_E_BASE    0x00000000L
+#endif // TSS_E_BASE
+#ifndef TSS_W_BASE
+#define TSS_W_BASE    0x00000000L
+#endif // TSS_W_BASE
+#ifndef TSS_I_BASE
+#define TSS_I_BASE    0x00000000L
+#endif // TSS_I_BASE
+
+//
+// basic error return codes common to all TSS Service Provider Interface methods
+// and returned by all TSS SW stack components
+//
+
+//
+// MessageId: TSS_SUCCESS
+//
+// MessageText:
+//
+//  Successful completion of the operation.
+//
+#define TSS_SUCCESS     (UINT32)(0x00000000L)
+
+//
+// MessageId: TSS_E_FAIL
+//
+// MessageText:
+//
+//  An internal error has been detected, but the source is unknown.
+//
+#define TSS_E_FAIL     (UINT32)(TSS_E_BASE + 0x002L)
+
+//
+// MessageId: TSS_E_BAD_PARAMETER
+//
+// MessageText:
+//
+// One or more parameter is bad.
+//
+#define TSS_E_BAD_PARAMETER    (UINT32)(TSS_E_BASE + 0x003L)
+
+//
+// MessageId: TSS_E_INTERNAL_ERROR
+//
+// MessageText:
+//
+//  An internal SW error has been detected.
+//
+#define TSS_E_INTERNAL_ERROR    (UINT32)(TSS_E_BASE + 0x004L)
+
+//
+// MessageId: TSS_E_OUTOFMEMORY
+//
+// MessageText:
+//
+// Ran out of memory.
+//
+#define TSS_E_OUTOFMEMORY    (UINT32)(TSS_E_BASE + 0x005L)
+
+//
+// MessageId: TSS_E_NOTIMPL
+//
+// MessageText:
+//
+// Not implemented.
+//
+#define TSS_E_NOTIMPL     (UINT32)(TSS_E_BASE + 0x006L)
+
+//
+// MessageId: TSS_E_KEY_ALREADY_REGISTERED
+//
+// MessageText:
+//
+//  Key is already registered
+//
+#define TSS_E_KEY_ALREADY_REGISTERED  (UINT32)(TSS_E_BASE + 0x008L)
+
+
+//
+// MessageId: TSS_E_TPM_UNEXPECTED
+//
+// MessageText:
+//
+//  An unexpected TPM error has occurred.
+//
+#define TSS_E_TPM_UNEXPECTED    (UINT32)(TSS_E_BASE + 0x010L)
+
+//
+// MessageId: TSS_E_COMM_FAILURE
+//
+// MessageText:
+//
+//  A communications error with the TPM has been detected.
+//
+#define TSS_E_COMM_FAILURE    (UINT32)(TSS_E_BASE + 0x011L)
+
+//
+// MessageId: TSS_E_TIMEOUT
+//
+// MessageText:
+//
+//  The operation has timed out.
+//
+#define TSS_E_TIMEOUT     (UINT32)(TSS_E_BASE + 0x012L)
+
+//
+// MessageId: TSS_E_TPM_UNSUPPORTED_FEATURE
+//
+// MessageText:
+//
+//  The TPM does not support the requested feature.
+//
+#define TSS_E_TPM_UNSUPPORTED_FEATURE  (UINT32)(TSS_E_BASE + 0x014L)
+
+//
+// MessageId: TSS_E_CANCELED
+//
+// MessageText:
+//
+//  The action was canceled by request.
+//
+#define TSS_E_CANCELED     (UINT32)(TSS_E_BASE + 0x016L)
+
+//
+// MessageId: TSS_E_PS_KEY_NOTFOUND
+//
+// MessageText:
+//
+// The key cannot be found in the persistent storage database.
+//
+#define TSS_E_PS_KEY_NOTFOUND    (UINT32)(TSS_E_BASE + 0x020L)
+//
+// MessageId: TSS_E_PS_KEY_EXISTS
+//
+// MessageText:
+//
+// The key already exists in the persistent storage database.
+//
+#define TSS_E_PS_KEY_EXISTS            (UINT32)(TSS_E_BASE + 0x021L)
+
+//
+// MessageId: TSS_E_PS_BAD_KEY_STATE
+//
+// MessageText:
+//
+// The key data set not valid in the persistent storage database.
+//
+#define TSS_E_PS_BAD_KEY_STATE         (UINT32)(TSS_E_BASE + 0x022L)
+
+
+//
+// error codes returned by specific TSS Service Provider Interface methods
+// offset TSS_TSPI_OFFSET
+//
+
+//
+// MessageId: TSS_E_INVALID_OBJECT_TYPE
+//
+// MessageText:
+//
+// Object type not valid for this operation.
+//
+#define TSS_E_INVALID_OBJECT_TYPE   (UINT32)(TSS_E_BASE + 0x101L)
+
+//
+// MessageId: TSS_E_NO_CONNECTION
+//
+// MessageText:
+//
+// Core Service connection doesn't exist.
+//
+#define TSS_E_NO_CONNECTION    (UINT32)(TSS_E_BASE + 0x102L)
+ 
+//
+// MessageId: TSS_E_CONNECTION_FAILED
+//
+// MessageText:
+//
+// Core Service connection failed.
+//
+#define TSS_E_CONNECTION_FAILED   (UINT32)(TSS_E_BASE + 0x103L)
+
+//
+// MessageId: TSS_E_CONNECTION_BROKEN
+//
+// MessageText:
+//
+// Communication with Core Service failed.
+//
+#define TSS_E_CONNECTION_BROKEN   (UINT32)(TSS_E_BASE + 0x104L)
+
+//
+// MessageId: TSS_E_HASH_INVALID_ALG
+//
+// MessageText:
+//
+// Invalid hash algorithm.
+//
+#define TSS_E_HASH_INVALID_ALG   (UINT32)(TSS_E_BASE + 0x105L)
+
+//
+// MessageId: TSS_E_HASH_INVALID_LENGTH
+//
+// MessageText:
+//
+// Hash length is inconsistent with hash algorithm.
+//
+#define TSS_E_HASH_INVALID_LENGTH   (UINT32)(TSS_E_BASE + 0x106L)
+
+//
+// MessageId: TSS_E_HASH_NO_DATA
+//
+// MessageText:
+//
+// Hash object has no internal hash value.
+//
+#define TSS_E_HASH_NO_DATA    (UINT32)(TSS_E_BASE + 0x107L)
+
+
+//
+// MessageId: TSS_E_INVALID_ATTRIB_FLAG
+//
+// MessageText:
+//
+// Flag value for attrib-functions inconsistent.
+//
+#define TSS_E_INVALID_ATTRIB_FLAG   (UINT32)(TSS_E_BASE + 0x109L)
+
+//
+// MessageId: TSS_E_INVALID_ATTRIB_SUBFLAG
+//
+// MessageText:
+//
+// Subflag value for attrib-functions inconsistent.
+//
+#define TSS_E_INVALID_ATTRIB_SUBFLAG  (UINT32)(TSS_E_BASE + 0x10AL)
+
+//
+// MessageId: TSS_E_INVALID_ATTRIB_DATA
+//
+// MessageText:
+//
+// Data for attrib-functions invalid.
+//
+#define TSS_E_INVALID_ATTRIB_DATA   (UINT32)(TSS_E_BASE + 0x10BL)
+
+//
+// MessageId: TSS_E_INVALID_OBJECT_INITFLAG
+//
+// MessageText:
+//
+// Wrong flag information for object creation.
+// 
+// The alternate spelling is supported to be compatible with a typo
+// in the 1.1b header files.
+//
+#define TSS_E_INVALID_OBJECT_INIT_FLAG  (UINT32)(TSS_E_BASE + 0x10CL)
+#define TSS_E_INVALID_OBJECT_INITFLAG   TSS_E_INVALID_OBJECT_INIT_FLAG
+ 
+//
+// MessageId: TSS_E_NO_PCRS_SET
+//
+// MessageText:
+//
+// No PCR register are selected or set.
+//
+#define TSS_E_NO_PCRS_SET    (UINT32)(TSS_E_BASE + 0x10DL)
+
+//
+// MessageId: TSS_E_KEY_NOT_LOADED
+//
+// MessageText:
+//
+// The addressed key is currently not loaded.
+//
+#define TSS_E_KEY_NOT_LOADED    (UINT32)(TSS_E_BASE + 0x10EL)
+ 
+//
+// MessageId: TSS_E_KEY_NOT_SET
+//
+// MessageText:
+//
+// No key information is currently available.
+//
+#define TSS_E_KEY_NOT_SET    (UINT32)(TSS_E_BASE + 0x10FL)
+      
+//
+// MessageId: TSS_E_VALIDATION_FAILED
+//
+// MessageText:
+//
+// Internal validation of data failed.
+//
+#define TSS_E_VALIDATION_FAILED   (UINT32)(TSS_E_BASE + 0x110L)
+
+//
+// MessageId: TSS_E_TSP_AUTHREQUIRED
+//
+// MessageText:
+//
+// Authorization is required.
+//
+#define TSS_E_TSP_AUTHREQUIRED   (UINT32)(TSS_E_BASE + 0x111L)
+
+//
+// MessageId: TSS_E_TSP_AUTH2REQUIRED
+//
+// MessageText:
+//
+// Multiple authorization is required.
+//
+#define TSS_E_TSP_AUTH2REQUIRED   (UINT32)(TSS_E_BASE + 0x112L)
+
+//
+// MessageId: TSS_E_TSP_AUTHFAIL
+//
+// MessageText:
+//
+// Authorization failed.
+//
+#define TSS_E_TSP_AUTHFAIL    (UINT32)(TSS_E_BASE + 0x113L)
+
+//
+// MessageId: TSS_E_TSP_AUTH2FAIL
+//
+// MessageText:
+//
+// Multiple authorization failed.
+//
+#define TSS_E_TSP_AUTH2FAIL    (UINT32)(TSS_E_BASE + 0x114L)
+ 
+//
+// MessageId: TSS_E_KEY_NO_MIGRATION_POLICY
+//
+// MessageText:
+//
+// There's no migration policy object set for the addressed key.
+//
+#define TSS_E_KEY_NO_MIGRATION_POLICY  (UINT32)(TSS_E_BASE + 0x115L) 
+
+//
+// MessageId: TSS_E_POLICY_NO_SECRET
+//
+// MessageText:
+//
+// No secret information is currently available for the addressed policy object.
+//
+#define TSS_E_POLICY_NO_SECRET   (UINT32)(TSS_E_BASE + 0x116L)
+
+//
+// MessageId: TSS_E_INVALID_OBJ_ACCESS
+//
+// MessageText:
+//
+// The operation failed due to an invalid object status.
+//
+#define TSS_E_INVALID_OBJ_ACCESS   (UINT32)(TSS_E_BASE + 0x117L)
+
+//
+// MessageId: TSS_E_INVALID_ENCSCHEME
+//
+// MessageText:
+//
+// 
+//
+#define TSS_E_INVALID_ENCSCHEME   (UINT32)(TSS_E_BASE + 0x118L)
+
+
+//
+// MessageId: TSS_E_INVALID_SIGSCHEME
+//
+// MessageText:
+//
+// 
+//
+#define TSS_E_INVALID_SIGSCHEME   (UINT32)(TSS_E_BASE + 0x119L)
+
+//
+// MessageId: TSS_E_ENC_INVALID_LENGTH
+//
+// MessageText:
+//
+// 
+//
+#define TSS_E_ENC_INVALID_LENGTH   (UINT32)(TSS_E_BASE + 0x120L)
+
+
+//
+// MessageId: TSS_E_ENC_NO_DATA
+//
+// MessageText:
+//
+// 
+//
+#define TSS_E_ENC_NO_DATA    (UINT32)(TSS_E_BASE + 0x121L)
+
+//
+// MessageId: TSS_E_ENC_INVALID_TYPE
+//
+// MessageText:
+//
+// 
+//
+#define TSS_E_ENC_INVALID_TYPE   (UINT32)(TSS_E_BASE + 0x122L)
+
+
+//
+// MessageId: TSS_E_INVALID_KEYUSAGE
+//
+// MessageText:
+//
+// 
+//
+#define TSS_E_INVALID_KEYUSAGE   (UINT32)(TSS_E_BASE + 0x123L)
+
+//
+// MessageId: TSS_E_VERIFICATION_FAILED
+//
+// MessageText:
+//
+// 
+//
+#define TSS_E_VERIFICATION_FAILED   (UINT32)(TSS_E_BASE + 0x124L)
+
+//
+// MessageId: TSS_E_HASH_NO_IDENTIFIER
+//
+// MessageText:
+//
+// Hash algorithm identifier not set.
+//
+#define TSS_E_HASH_NO_IDENTIFIER   (UINT32)(TSS_E_BASE + 0x125L)
+
+//
+// MessageId: TSS_E_INVALID_HANDLE
+//
+// MessageText:
+//
+//  An invalid handle
+//
+#define TSS_E_INVALID_HANDLE    (UINT32)(TSS_E_BASE + 0x126L)
+
+//
+// MessageId: TSS_E_SILENT_CONTEXT
+//
+// MessageText:
+//
+//  A silent context requires user input
+//
+#define TSS_E_SILENT_CONTEXT           (UINT32)(TSS_E_BASE + 0x127L)
+
+//
+// MessageId: TSS_E_EK_CHECKSUM
+//
+// MessageText:
+//
+// TSP is instructed to verify the EK checksum and it does not verify.
+//
+#define TSS_E_EK_CHECKSUM             (UINT32)(TSS_E_BASE + 0x128L)
+
+
+//
+// MessageId: TSS_E_DELGATION_NOTSET
+//
+// MessageText:
+//
+// The Policy object does not have a delegation blob set.
+//
+#define TSS_E_DELEGATION_NOTSET      (UINT32)(TSS_E_BASE + 0x129L)
+
+//
+// MessageId: TSS_E_DELFAMILY_NOTFOUND
+//
+// MessageText:
+//
+// The specified delegation family was not found
+//
+#define TSS_E_DELFAMILY_NOTFOUND       (UINT32)(TSS_E_BASE + 0x130L)
+
+//
+// MessageId: TSS_E_DELFAMILY_ROWEXISTS
+//
+// MessageText:
+//
+// The specified delegation family table row is already in use and
+// the command flags does not allow the TSS to overwrite the existing
+// entry.
+//
+#define TSS_E_DELFAMILY_ROWEXISTS    (UINT32)(TSS_E_BASE + 0x131L)
+
+//
+// MessageId: TSS_E_VERSION_MISMATCH
+//
+// MessageText:
+//
+// The specified delegation family table row is already in use and
+// the command flags does not allow the TSS to overwrite the existing
+// entry.
+//
+#define TSS_E_VERSION_MISMATCH       (UINT32)(TSS_E_BASE + 0x132L)
+
+//
+//  MessageId: TSS_E_DAA_AR_DECRYPTION_ERROR
+//
+//  Decryption of the encrypted pseudonym has failed, due to
+//  either a wrong secret key or a wrong decryption condition.
+//
+#define TSS_E_DAA_AR_DECRYPTION_ERROR             (UINT32)(TSS_E_BASE + 0x133L)
+
+//
+//  MessageId: TSS_E_DAA_AUTHENTICATION_ERROR
+//
+//  The TPM could not be authenticated by the DAA Issuer.
+//
+#define TSS_E_DAA_AUTHENTICATION_ERROR            (UINT32)(TSS_E_BASE + 0x134L)
+
+//
+//  MessageId: TSS_E_DAA_CHALLENGE_RESPONSE_ERROR
+//
+//  DAA Challenge response error.
+//
+#define TSS_E_DAA_CHALLENGE_RESPONSE_ERROR        (UINT32)(TSS_E_BASE + 0x135L)
+
+//
+//  MessageId: TSS_E_DAA_CREDENTIAL_PROOF_ERROR
+//
+//  Verification of the credential TSS_DAA_CRED_ISSUER issued by
+//  the DAA Issuer has failed.
+//
+#define TSS_E_DAA_CREDENTIAL_PROOF_ERROR          (UINT32)(TSS_E_BASE + 0x136L)
+
+//
+//  MessageId: TSS_E_DAA_CREDENTIAL_REQUEST_PROOF_ERROR
+//
+//  Verification of the platform's credential request
+//  TSS_DAA_CREDENTIAL_REQUEST has failed.
+//
+#define TSS_E_DAA_CREDENTIAL_REQUEST_PROOF_ERROR  (UINT32)(TSS_E_BASE + 0x137L)
+
+//
+//  MessageId: TSS_E_DAA_ISSUER_KEY_ERROR
+//
+//  DAA Issuer's authentication key chain could not be verified or
+//  is not correct.
+//
+#define TSS_E_DAA_ISSUER_KEY_ERROR                (UINT32)(TSS_E_BASE + 0x138L)
+
+//
+//  MessageId: TSS_E_DAA_PSEUDONYM_ERROR
+//
+//  While verifying the pseudonym of the TPM, the private key of the
+//  TPM was found on the rogue list.
+//
+#define TSS_E_DAA_PSEUDONYM_ERROR                 (UINT32)(TSS_E_BASE + 0x139L)
+
+//
+//  MessageId: TSS_E_INVALID_RESOURCE
+//
+//  Pointer to memory wrong.
+//
+#define TSS_E_INVALID_RESOURCE                    (UINT32)(TSS_E_BASE + 0x13AL)
+
+//
+//  MessageId: TSS_E_NV_AREA_EXIST
+//
+//  The NV area referenced already exists
+//
+#define TSS_E_NV_AREA_EXIST                       (UINT32)(TSS_E_BASE + 0x13BL)
+
+//
+//  MessageId: TSS_E_NV_AREA_NOT_EXIST
+//
+//  The NV area referenced doesn't exist
+//
+#define TSS_E_NV_AREA_NOT_EXIST                   (UINT32)(TSS_E_BASE + 0x13CL)
+
+//
+//  MessageId: TSS_E_TSP_TRANS_AUTHFAIL
+//
+//  The transport session authorization failed
+//
+#define TSS_E_TSP_TRANS_AUTHFAIL                  (UINT32)(TSS_E_BASE + 0x13DL)
+
+//
+//  MessageId: TSS_E_TSP_TRANS_AUTHREQUIRED
+//
+//  Authorization for transport is required
+//
+#define TSS_E_TSP_TRANS_AUTHREQUIRED              (UINT32)(TSS_E_BASE + 0x13EL)
+
+//
+//  MessageId: TSS_E_TSP_TRANS_NOT_EXCLUSIVE
+//
+//  A command was executed outside of an exclusive transport session.
+//
+#define TSS_E_TSP_TRANS_NOTEXCLUSIVE              (UINT32)(TSS_E_BASE + 0x13FL)
+
+//
+//  MessageId: TSS_E_TSP_TRANS_FAIL
+//
+//  Generic transport protection error.
+//
+#define TSS_E_TSP_TRANS_FAIL                     (UINT32)(TSS_E_BASE + 0x140L)
+
+//
+//  MessageId: TSS_E_TSP_TRANS_NO_PUBKEY
+//
+//  A command could not be executed through a logged transport session
+//  because the command used a key and the key's public key is not
+//  known to the TSP.
+//
+#define TSS_E_TSP_TRANS_NO_PUBKEY                (UINT32)(TSS_E_BASE + 0x141L)
+
+//
+//  MessageId: TSS_E_NO_ACTIVE_COUNTER
+//
+//  The TPM active counter has not been set yet.
+//
+#define TSS_E_NO_ACTIVE_COUNTER                  (UINT32)(TSS_E_BASE + 0x142L)
+
+
+#endif // __TSS_ERROR_H__
diff -ru trousers-0.3.8-orig/src/include/tss/tss_structs.h trousers-0.3.8/src/include/tss/tss_structs.h
--- trousers-0.3.8-orig/src/include/tss/tss_structs.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tss_structs.h	2012-02-14 20:35:05.919604411 +0000
@@ -1,653 +1,653 @@
-/*++
-
-TSS structures for TSS
-
-*/
-
-#ifndef __TSS_STRUCTS_H__
-#define __TSS_STRUCTS_H__
-
-#include <tss/platform.h>
-#include <tss/tss_typedef.h>
-#include <tss/tpm.h>
-
-typedef struct tdTSS_VERSION 
-{
-    BYTE   bMajor;
-    BYTE   bMinor;
-    BYTE   bRevMajor;
-    BYTE   bRevMinor;
-} TSS_VERSION;
-
-typedef struct tdTSS_PCR_EVENT 
-{
-    TSS_VERSION   versionInfo;
-    UINT32        ulPcrIndex;
-    TSS_EVENTTYPE eventType;
-    UINT32        ulPcrValueLength;
-#ifdef __midl
-    [size_is(ulPcrValueLength)] 
-#endif
-    BYTE*         rgbPcrValue;
-    UINT32        ulEventLength;
-#ifdef __midl
-    [size_is(ulEventLength)] 
-#endif 
-    BYTE*         rgbEvent;
-} TSS_PCR_EVENT;
-
-
-typedef struct tdTSS_EVENT_CERT
-{
-    TSS_VERSION       versionInfo;
-    UINT32    ulCertificateHashLength;
-#ifdef __midl
-    [size_is(ulCertificateHashLength)] 
-#endif
-    BYTE*     rgbCertificateHash;
-    UINT32    ulEntityDigestLength;
-#ifdef __midl
-    [size_is(ulEntityDigestLength)] 
-#endif
-    BYTE*     rgbentityDigest;
-    TSS_BOOL  fDigestChecked;
-    TSS_BOOL  fDigestVerified;
-    UINT32    ulIssuerLength;
-#ifdef __midl
-    [size_is(ulIssuerLength)]
-#endif
-    BYTE*     rgbIssuer;
-} TSS_EVENT_CERT;
-
-typedef struct tdTSS_UUID 
-{
-    UINT32  ulTimeLow;
-    UINT16  usTimeMid;
-    UINT16  usTimeHigh;
-    BYTE   bClockSeqHigh;
-    BYTE   bClockSeqLow;
-    BYTE   rgbNode[6];
-} TSS_UUID;
-
-typedef struct tdTSS_KM_KEYINFO 
-{
-    TSS_VERSION  versionInfo;
-    TSS_UUID     keyUUID;
-    TSS_UUID     parentKeyUUID;
-    BYTE         bAuthDataUsage;   // whether auth is needed to load child keys
-    TSS_BOOL     fIsLoaded;           // TRUE: actually loaded in TPM
-    UINT32       ulVendorDataLength;  // may be 0
-#ifdef __midl
-    [size_is(ulVendorDataLength)]
-#endif
-    BYTE        *rgbVendorData;       // may be NULL
-} TSS_KM_KEYINFO;
-
-
-typedef struct tdTSS_KM_KEYINFO2
-{
-    TSS_VERSION  versionInfo;
-    TSS_UUID     keyUUID;
-    TSS_UUID     parentKeyUUID;
-    BYTE         bAuthDataUsage;   // whether auth is needed to load child keys
-    TSS_FLAG     persistentStorageType;
-    TSS_FLAG     persistentStorageTypeParent;
-    TSS_BOOL     fIsLoaded;           // TRUE: actually loaded in TPM
-    UINT32       ulVendorDataLength;  // may be 0
-#ifdef __midl
-    [size_is(ulVendorDataLength)]
-#endif
-    BYTE        *rgbVendorData;       // may be NULL
-} TSS_KM_KEYINFO2;
-
-
-typedef struct tdTSS_NONCE
-{
-    BYTE  nonce[TPM_SHA1BASED_NONCE_LEN];
-} TSS_NONCE;
-
-
-typedef struct tdTSS_VALIDATION
-{ 
-    TSS_VERSION  versionInfo;
-    UINT32       ulExternalDataLength;
-#ifdef __midl
-    [size_is(ulExternalDataLength)]
-#endif
-    BYTE*        rgbExternalData;
-    UINT32       ulDataLength;
-#ifdef __midl
-    [size_is(ulDataLength)]
-#endif
-    BYTE*     rgbData;
-    UINT32    ulValidationDataLength;
-#ifdef __midl
-    [size_is(ulValidationDataLength)]
-#endif
-    BYTE*     rgbValidationData;
-} TSS_VALIDATION;
-
-
-typedef struct tdTSS_CALLBACK
-{
-    PVOID            callback;
-    PVOID            appData;
-    TSS_ALGORITHM_ID alg;
-} TSS_CALLBACK;
-
-
-typedef struct tdTSS_DAA_PK
-{
-    TSS_VERSION versionInfo;
-    UINT32      modulusLength;
-#ifdef __midl
-    [size_is(modulusLength)] 
-#endif
-    BYTE*       modulus;
-    UINT32      capitalSLength;
-#ifdef __midl
-    [size_is(capitalSLength)] 
-#endif
-    BYTE*       capitalS;
-    UINT32      capitalZLength;
-#ifdef __midl
-    [size_is(capitalZLength)] 
-#endif
-    BYTE*       capitalZ;
-    UINT32      capitalR0Length;
-#ifdef __midl
-    [size_is(capitalR0Length)] 
-#endif
-    BYTE*       capitalR0;
-    UINT32      capitalR1Length;
-#ifdef __midl
-    [size_is(capitalR1Length)] 
-#endif
-    BYTE*       capitalR1;
-    UINT32      gammaLength;
-#ifdef __midl
-    [size_is(gammaLength)] 
-#endif
-    BYTE*       gamma;
-    UINT32      capitalGammaLength;
-#ifdef __midl
-    [size_is(capitalGammaLength)] 
-#endif
-    BYTE*       capitalGamma;
-    UINT32      rhoLength;
-#ifdef __midl
-    [size_is(rhoLength)] 
-#endif
-    BYTE*       rho;
-    UINT32      capitalYLength;         // Length of first dimenstion
-    UINT32      capitalYLength2;        // Length of second dimension
-#ifdef __midl
-    [size_is(capitalYLength,capitalYLength2)] 
-#endif
-    BYTE**      capitalY;
-    UINT32      capitalYPlatformLength;
-    UINT32      issuerBaseNameLength;
-#ifdef __midl
-    [size_is(issuerBaseName)] 
-#endif
-    BYTE*       issuerBaseName;
-    UINT32      numPlatformAttributes;
-    UINT32      numIssuerAttributes;
-} TSS_DAA_PK;
-
-typedef struct tdTSS_DAA_PK_PROOF
-{
-    TSS_VERSION versionInfo;
-    UINT32      challengeLength;
-#ifdef __midl
-    [size_is(challengeLength)] 
-#endif
-    BYTE*       challenge;
-    UINT32      responseLength;         // Length of first dimension
-    UINT32      responseLength2;        // Length of second dimension
-#ifdef __midl
-    [size_is(responseLength,responseLength2)] 
-#endif
-    BYTE**      response;
-} TSS_DAA_PK_PROOF;
-
-typedef struct tdTSS_DAA_SK
-{
-    TSS_VERSION versionInfo;
-    UINT32      productPQprimeLength;
-#ifdef __midl
-    [size_is(productPQprimeLength)] 
-#endif
-    BYTE*       productPQprime;
-} TSS_DAA_SK;
-
-
-typedef struct tdTSS_DAA_KEY_PAIR
-{
-    TSS_VERSION versionInfo;
-    TSS_DAA_SK  secretKey;
-    TSS_DAA_PK  publicKey;
-} TSS_DAA_KEY_PAIR;
-
-typedef struct tdTSS_DAA_AR_PK
-{
-    TSS_VERSION versionInfo;
-    UINT32      etaLength;
-#ifdef __midl
-    [size_is(etaLength)] 
-#endif
-    BYTE*       eta;
-    UINT32      lambda1Length;
-#ifdef __midl
-    [size_is(lambda1Length)] 
-#endif
-    BYTE*       lambda1;
-    UINT32      lambda2Length;
-#ifdef __midl
-    [size_is(lambda2Length)] 
-#endif
-    BYTE*       lambda2;
-    UINT32      lambda3Length;
-#ifdef __midl
-    [size_is(lambda3Length)] 
-#endif
-    BYTE*       lambda3;
-} TSS_DAA_AR_PK;
-
-typedef struct tdTSS_DAA_AR_SK
-{
-    TSS_VERSION versionInfo;
-    UINT32      x0Length;
-#ifdef __midl
-    [size_is(x0Length)] 
-#endif
-    BYTE*       x0;
-    UINT32      x1Length;
-#ifdef __midl
-    [size_is(x1Length)] 
-#endif
-    BYTE*       x1;
-    UINT32      x2Length;
-#ifdef __midl
-    [size_is(x2Length)] 
-#endif
-    BYTE*       x2;
-    UINT32      x3Length;
-#ifdef __midl
-    [size_is(x3Length)] 
-#endif
-    BYTE*       x3;
-    UINT32      x4Length;
-#ifdef __midl
-    [size_is(x4Length)] 
-#endif
-    BYTE*       x4;
-    UINT32      x5Length;
-#ifdef __midl
-    [size_is(x5Length)] 
-#endif
-    BYTE*       x5;
-} TSS_DAA_AR_SK;
-
-typedef struct tdTSS_DAA_AR_KEY_PAIR
-{
-    TSS_VERSION   versionInfo;
-    TSS_DAA_AR_SK secretKey;
-    TSS_DAA_AR_PK publicKey;
-} TSS_DAA_AR_KEY_PAIR;
-
-typedef struct tdTSS_DAA_CRED_ISSUER
-{
-    TSS_VERSION versionInfo;
-    UINT32      capitalALength;
-#ifdef __midl
-    [size_is(capitalALength)] 
-#endif
-    BYTE*       capitalA;
-    UINT32      eLength;
-#ifdef __midl
-    [size_is(eLength)] 
-#endif
-    BYTE*       e;
-    UINT32      vPrimePrimeLength;
-#ifdef __midl
-    [size_is(vPrimePrimeLength)] 
-#endif
-    BYTE*       vPrimePrime;
-    UINT32      attributesIssuerLength;         // Length of first dimension
-    UINT32      attributesIssuerLength2;        // Length of second dimension
-#ifdef __midl
-    [size_is(attributesIssuerLength,attributesIssuerLength2)] 
-#endif
-    BYTE**      attributesIssuer;
-    UINT32      cPrimeLength;
-#ifdef __midl
-    [size_is(cPrimeLength)] 
-#endif
-    BYTE*       cPrime;
-    UINT32      sELength;
-#ifdef __midl
-    [size_is(sELength)] 
-#endif
-    BYTE*       sE;
-} TSS_DAA_CRED_ISSUER;
-
-typedef struct tdTSS_DAA_CREDENTIAL
-{
-    TSS_VERSION versionInfo;
-    UINT32      capitalALength;
-#ifdef __midl
-    [size_is(capitalALength)] 
-#endif
-    BYTE*       capitalA;
-    UINT32      exponentLength;
-#ifdef __midl
-    [size_is(exponentLength)] 
-#endif
-    BYTE*       exponent;
-    UINT32      vBar0Length;
-#ifdef __midl
-    [size_is(vBar0Length)] 
-#endif
-    BYTE*       vBar0;
-    UINT32      vBar1Length;
-#ifdef __midl
-    [size_is(vBar1Length)] 
-#endif
-    BYTE*       vBar1;
-    UINT32      attributesLength;       // Length of first dimension
-    UINT32      attributesLength2;      // Length of second dimension
-#ifdef __midl
-    [size_is(attributesLength,attributesLength2)] 
-#endif
-    BYTE**      attributes;
-    TSS_DAA_PK  issuerPK;
-    UINT32      tpmSpecificEncLength;
-#ifdef __midl
-    [size_is(tpmSpecificEncLength)]
-#endif
-    BYTE*       tpmSpecificEnc;
-    UINT32      daaCounter;
-} TSS_DAA_CREDENTIAL;
-
-typedef struct tdTSS_DAA_ATTRIB_COMMIT
-{
-    TSS_VERSION versionInfo;
-    UINT32      betaLength;
-#ifdef __midl
-    [size_is(betaLength)]
-#endif
-    BYTE*       beta;
-    UINT32      sMuLength;
-#ifdef __midl
-    [size_is(sMuLength)]
-#endif
-    BYTE*       sMu;
-} TSS_DAA_ATTRIB_COMMIT;
-
-typedef struct tdTSS_DAA_CREDENTIAL_REQUEST
-{
-    TSS_VERSION versionInfo;
-    UINT32      capitalULength;
-#ifdef __midl
-    [size_is(capitalULength)]
-#endif
-    BYTE*       capitalU;
-    UINT32      capitalNiLength;
-#ifdef __midl
-    [size_is(capitalNiLength)]
-#endif
-    BYTE*       capitalNi;
-    UINT32      authenticationProofLength;
-#ifdef __midl
-    [size_is(authenticationProofLength)]
-#endif
-    BYTE*       authenticationProof;
-    UINT32      challengeLength;
-#ifdef __midl
-    [size_is(challengeLength)]
-#endif
-    BYTE*       challenge;
-    UINT32      nonceTpmLength;
-#ifdef __midl
-    [size_is(nonceTpmLength)]
-#endif
-    BYTE*       nonceTpm;
-    UINT32      noncePlatformLength;
-#ifdef __midl
-    [size_is(noncePlatformLength)]
-#endif
-    BYTE*       noncePlatform;
-    UINT32      sF0Length;
-#ifdef __midl
-    [size_is(sF0Length)]
-#endif
-    BYTE*       sF0;
-    UINT32      sF1Length;
-#ifdef __midl
-    [size_is(sF1Length)]
-#endif
-    BYTE*       sF1;
-    UINT32      sVprimeLength;
-#ifdef __midl
-    [size_is(sVprimeLength)]
-#endif
-    BYTE*       sVprime;
-    UINT32      sVtildePrimeLength;
-#ifdef __midl
-    [size_is(sVtildePrimeLength)]
-#endif
-    BYTE*       sVtildePrime;
-    UINT32      sALength;       // Length of first dimension
-    UINT32      sALength2;      // Length of second dimension
-#ifdef __midl
-    [size_is(sALength,sALength2)]
-#endif
-    BYTE**      sA;
-    UINT32      attributeCommitmentsLength;
-    TSS_DAA_ATTRIB_COMMIT* attributeCommitments;
-} TSS_DAA_CREDENTIAL_REQUEST;
-
-typedef struct tdTSS_DAA_SELECTED_ATTRIB
-{
-    TSS_VERSION versionInfo;
-    UINT32      indicesListLength;
-#ifdef __midl
-    [size_is(indicesListLength)]
-#endif
-    TSS_BOOL*   indicesList;
-} TSS_DAA_SELECTED_ATTRIB;
-
-typedef struct tdTSS_DAA_PSEUDONYM
-{
-    TSS_VERSION versionInfo;
-    TSS_FLAG    payloadFlag;
-    UINT32      payloadLength;
-#ifdef __midl
-    [size_is(payloadLength)]
-#endif
-    BYTE*       payload;
-} TSS_DAA_PSEUDONYM;
-
-typedef struct tdTSS_DAA_PSEUDONYM_PLAIN
-{
-    TSS_VERSION versionInfo;
-    UINT32      capitalNvLength;
-#ifdef __midl
-    [size_is(capitalNvLength)]
-#endif
-    BYTE*       capitalNv;
-} TSS_DAA_PSEUDONYM_PLAIN;
-
-typedef struct tdTSS_DAA_PSEUDONYM_ENCRYPTED
-{
-    TSS_VERSION versionInfo;
-    UINT32      delta1Length;
-#ifdef __midl
-    [size_is(delta1Length)]
-#endif
-    BYTE*       delta1;
-    UINT32      delta2Length;
-#ifdef __midl
-    [size_is(delta2Length)]
-#endif
-    BYTE*       delta2;
-    UINT32      delta3Length;
-#ifdef __midl
-    [size_is(delta3Length)]
-#endif
-    BYTE*       delta3;
-    UINT32      delta4Length;
-#ifdef __midl
-    [size_is(delta4Length)]
-#endif
-    BYTE*       delta4;
-    UINT32      sTauLength;
-#ifdef __midl
-    [size_is(sTauLength)]
-#endif
-    BYTE*       sTau;
-} TSS_DAA_PSEUDONYM_ENCRYPTED;
-
-typedef struct tdTSS_DAA_SIGN_CALLBACK
-{
-    TSS_VERSION versionInfo;
-    TSS_HHASH   challenge;
-    TSS_FLAG    payloadFlag;
-    UINT32      payloadLength;
-#ifdef __midl
-    [size_is(payloadLength)]
-#endif
-    BYTE*       payload;
-} TSS_DAA_SIGN_CALLBACK;
-
-typedef struct tdTSS_DAA_SIGNATURE
-{
-    TSS_VERSION            versionInfo;
-    UINT32                 zetaLength;
-#ifdef __midl
-    [size_is(zetaLength)]
-#endif
-    BYTE*                  zeta;
-    UINT32                 capitalTLength;
-#ifdef __midl
-    [size_is(capitalTLength)]
-#endif
-    BYTE*                  capitalT;
-    UINT32                 challengeLength;
-#ifdef __midl
-    [size_is(challengeLength)]
-#endif
-    BYTE*                  challenge;
-    UINT32                 nonceTpmLength;
-#ifdef __midl
-    [size_is(nonceTpmLength)]
-#endif
-    BYTE*                  nonceTpm;
-    UINT32                 sVLength;
-#ifdef __midl
-    [size_is(sVLength)]
-#endif
-    BYTE*                  sV;
-    UINT32                 sF0Length;
-#ifdef __midl
-    [size_is(sF0Length)]
-#endif
-    BYTE*                  sF0;
-    UINT32                 sF1Length;
-#ifdef __midl
-    [size_is(sF1Length)]
-#endif
-    BYTE*                  sF1;
-    UINT32                 sELength;
-#ifdef __midl
-    [size_is(sELength)]
-#endif
-    BYTE*                  sE;
-    UINT32                 sALength;    // Length of first dimension
-    UINT32                 sALength2;   // Length of second dimension
-#ifdef __midl
-    [size_is(sALength,sALength2)]
-#endif
-    BYTE**                 sA;
-    UINT32                 attributeCommitmentsLength;
-#ifdef __midl
-    [size_is(attributeCommitmentsLength)]
-#endif
-    TSS_DAA_ATTRIB_COMMIT* attributeCommitments;
-    TSS_DAA_PSEUDONYM      signedPseudonym;
-    TSS_DAA_SIGN_CALLBACK  callbackResult;
-} TSS_DAA_SIGNATURE;
-
-typedef struct tdTSS_DAA_IDENTITY_PROOF
-{
-    TSS_VERSION versionInfo;
-    UINT32      endorsementLength;
-#ifdef __midl
-    [size_is(endorsementLength)]
-#endif
-    BYTE*       endorsementCredential;
-    UINT32      platformLength;
-#ifdef __midl
-    [size_is(platformLength)]
-#endif
-    BYTE*       platform;
-    UINT32      conformanceLength;
-#ifdef __midl
-    [size_is(conformanceLength)]
-#endif
-    BYTE*       conformance;
-} TSS_DAA_IDENTITY_PROOF;
-
-
-////////////////////////////////////////////////////////////////////
-
-typedef UINT32 TSS_FAMILY_ID;
-typedef BYTE   TSS_DELEGATION_LABEL;
-// Values are TSS_DELEGATIONTYPE_KEY or TSS_DELEGATIONTYPE_OWNER
-typedef UINT32 TSS_DELEGATION_TYPE;
-
-typedef struct tdTSS_PCR_INFO_SHORT
-{
-    UINT32               sizeOfSelect;
-#ifdef __midl
-    [size_is(sizeOfSelect)]
-#endif
-    BYTE                *selection;
-    BYTE                 localityAtRelease;
-    UINT32               sizeOfDigestAtRelease;
-#ifdef __midl
-    [size_is(sizeOfDigestAtRelease)]
-#endif
-    BYTE                *digestAtRelease;
-} TSS_PCR_INFO_SHORT;
-
-typedef struct tdTSS_FAMILY_TABLE_ENTRY
-{
-    TSS_FAMILY_ID        familyID;
-    TSS_DELEGATION_LABEL label;
-    UINT32               verificationCount;
-    TSS_BOOL             enabled;
-    TSS_BOOL             locked;
-} TSS_FAMILY_TABLE_ENTRY;
-
-typedef struct tdTSS_DELEGATION_TABLE_ENTRY
-{
-    UINT32               tableIndex;
-    TSS_DELEGATION_LABEL label;
-    TSS_PCR_INFO_SHORT   pcrInfo;
-    UINT32               per1;
-    UINT32               per2;
-    TSS_FAMILY_ID        familyID;
-    UINT32               verificationCount;
-} TSS_DELEGATION_TABLE_ENTRY;
-
-typedef struct tdTSS_PLATFORM_CLASS
-{
-    UINT32 platformClassSimpleIdentifier;
-    UINT32 platformClassURISize;
-    BYTE*  pPlatformClassURI;
-} TSS_PLATFORM_CLASS;
-
-#endif // __TSS_STRUCTS_H__
-
+/*++
+
+TSS structures for TSS
+
+*/
+
+#ifndef __TSS_STRUCTS_H__
+#define __TSS_STRUCTS_H__
+
+#include <tss/platform.h>
+#include <tss/tss_typedef.h>
+#include <tss/tpm.h>
+
+typedef struct tdTSS_VERSION 
+{
+    BYTE   bMajor;
+    BYTE   bMinor;
+    BYTE   bRevMajor;
+    BYTE   bRevMinor;
+} TSS_VERSION;
+
+typedef struct tdTSS_PCR_EVENT 
+{
+    TSS_VERSION   versionInfo;
+    UINT32        ulPcrIndex;
+    TSS_EVENTTYPE eventType;
+    UINT32        ulPcrValueLength;
+#ifdef __midl
+    [size_is(ulPcrValueLength)] 
+#endif
+    BYTE*         rgbPcrValue;
+    UINT32        ulEventLength;
+#ifdef __midl
+    [size_is(ulEventLength)] 
+#endif 
+    BYTE*         rgbEvent;
+} TSS_PCR_EVENT;
+
+
+typedef struct tdTSS_EVENT_CERT
+{
+    TSS_VERSION       versionInfo;
+    UINT32    ulCertificateHashLength;
+#ifdef __midl
+    [size_is(ulCertificateHashLength)] 
+#endif
+    BYTE*     rgbCertificateHash;
+    UINT32    ulEntityDigestLength;
+#ifdef __midl
+    [size_is(ulEntityDigestLength)] 
+#endif
+    BYTE*     rgbentityDigest;
+    TSS_BOOL  fDigestChecked;
+    TSS_BOOL  fDigestVerified;
+    UINT32    ulIssuerLength;
+#ifdef __midl
+    [size_is(ulIssuerLength)]
+#endif
+    BYTE*     rgbIssuer;
+} TSS_EVENT_CERT;
+
+typedef struct tdTSS_UUID 
+{
+    UINT32  ulTimeLow;
+    UINT16  usTimeMid;
+    UINT16  usTimeHigh;
+    BYTE   bClockSeqHigh;
+    BYTE   bClockSeqLow;
+    BYTE   rgbNode[6];
+} TSS_UUID;
+
+typedef struct tdTSS_KM_KEYINFO 
+{
+    TSS_VERSION  versionInfo;
+    TSS_UUID     keyUUID;
+    TSS_UUID     parentKeyUUID;
+    BYTE         bAuthDataUsage;   // whether auth is needed to load child keys
+    TSS_BOOL     fIsLoaded;           // TRUE: actually loaded in TPM
+    UINT32       ulVendorDataLength;  // may be 0
+#ifdef __midl
+    [size_is(ulVendorDataLength)]
+#endif
+    BYTE        *rgbVendorData;       // may be NULL
+} TSS_KM_KEYINFO;
+
+
+typedef struct tdTSS_KM_KEYINFO2
+{
+    TSS_VERSION  versionInfo;
+    TSS_UUID     keyUUID;
+    TSS_UUID     parentKeyUUID;
+    BYTE         bAuthDataUsage;   // whether auth is needed to load child keys
+    TSS_FLAG     persistentStorageType;
+    TSS_FLAG     persistentStorageTypeParent;
+    TSS_BOOL     fIsLoaded;           // TRUE: actually loaded in TPM
+    UINT32       ulVendorDataLength;  // may be 0
+#ifdef __midl
+    [size_is(ulVendorDataLength)]
+#endif
+    BYTE        *rgbVendorData;       // may be NULL
+} TSS_KM_KEYINFO2;
+
+
+typedef struct tdTSS_NONCE
+{
+    BYTE  nonce[TPM_SHA1BASED_NONCE_LEN];
+} TSS_NONCE;
+
+
+typedef struct tdTSS_VALIDATION
+{ 
+    TSS_VERSION  versionInfo;
+    UINT32       ulExternalDataLength;
+#ifdef __midl
+    [size_is(ulExternalDataLength)]
+#endif
+    BYTE*        rgbExternalData;
+    UINT32       ulDataLength;
+#ifdef __midl
+    [size_is(ulDataLength)]
+#endif
+    BYTE*     rgbData;
+    UINT32    ulValidationDataLength;
+#ifdef __midl
+    [size_is(ulValidationDataLength)]
+#endif
+    BYTE*     rgbValidationData;
+} TSS_VALIDATION;
+
+
+typedef struct tdTSS_CALLBACK
+{
+    PVOID            callback;
+    PVOID            appData;
+    TSS_ALGORITHM_ID alg;
+} TSS_CALLBACK;
+
+
+typedef struct tdTSS_DAA_PK
+{
+    TSS_VERSION versionInfo;
+    UINT32      modulusLength;
+#ifdef __midl
+    [size_is(modulusLength)] 
+#endif
+    BYTE*       modulus;
+    UINT32      capitalSLength;
+#ifdef __midl
+    [size_is(capitalSLength)] 
+#endif
+    BYTE*       capitalS;
+    UINT32      capitalZLength;
+#ifdef __midl
+    [size_is(capitalZLength)] 
+#endif
+    BYTE*       capitalZ;
+    UINT32      capitalR0Length;
+#ifdef __midl
+    [size_is(capitalR0Length)] 
+#endif
+    BYTE*       capitalR0;
+    UINT32      capitalR1Length;
+#ifdef __midl
+    [size_is(capitalR1Length)] 
+#endif
+    BYTE*       capitalR1;
+    UINT32      gammaLength;
+#ifdef __midl
+    [size_is(gammaLength)] 
+#endif
+    BYTE*       gamma;
+    UINT32      capitalGammaLength;
+#ifdef __midl
+    [size_is(capitalGammaLength)] 
+#endif
+    BYTE*       capitalGamma;
+    UINT32      rhoLength;
+#ifdef __midl
+    [size_is(rhoLength)] 
+#endif
+    BYTE*       rho;
+    UINT32      capitalYLength;         // Length of first dimenstion
+    UINT32      capitalYLength2;        // Length of second dimension
+#ifdef __midl
+    [size_is(capitalYLength,capitalYLength2)] 
+#endif
+    BYTE**      capitalY;
+    UINT32      capitalYPlatformLength;
+    UINT32      issuerBaseNameLength;
+#ifdef __midl
+    [size_is(issuerBaseName)] 
+#endif
+    BYTE*       issuerBaseName;
+    UINT32      numPlatformAttributes;
+    UINT32      numIssuerAttributes;
+} TSS_DAA_PK;
+
+typedef struct tdTSS_DAA_PK_PROOF
+{
+    TSS_VERSION versionInfo;
+    UINT32      challengeLength;
+#ifdef __midl
+    [size_is(challengeLength)] 
+#endif
+    BYTE*       challenge;
+    UINT32      responseLength;         // Length of first dimension
+    UINT32      responseLength2;        // Length of second dimension
+#ifdef __midl
+    [size_is(responseLength,responseLength2)] 
+#endif
+    BYTE**      response;
+} TSS_DAA_PK_PROOF;
+
+typedef struct tdTSS_DAA_SK
+{
+    TSS_VERSION versionInfo;
+    UINT32      productPQprimeLength;
+#ifdef __midl
+    [size_is(productPQprimeLength)] 
+#endif
+    BYTE*       productPQprime;
+} TSS_DAA_SK;
+
+
+typedef struct tdTSS_DAA_KEY_PAIR
+{
+    TSS_VERSION versionInfo;
+    TSS_DAA_SK  secretKey;
+    TSS_DAA_PK  publicKey;
+} TSS_DAA_KEY_PAIR;
+
+typedef struct tdTSS_DAA_AR_PK
+{
+    TSS_VERSION versionInfo;
+    UINT32      etaLength;
+#ifdef __midl
+    [size_is(etaLength)] 
+#endif
+    BYTE*       eta;
+    UINT32      lambda1Length;
+#ifdef __midl
+    [size_is(lambda1Length)] 
+#endif
+    BYTE*       lambda1;
+    UINT32      lambda2Length;
+#ifdef __midl
+    [size_is(lambda2Length)] 
+#endif
+    BYTE*       lambda2;
+    UINT32      lambda3Length;
+#ifdef __midl
+    [size_is(lambda3Length)] 
+#endif
+    BYTE*       lambda3;
+} TSS_DAA_AR_PK;
+
+typedef struct tdTSS_DAA_AR_SK
+{
+    TSS_VERSION versionInfo;
+    UINT32      x0Length;
+#ifdef __midl
+    [size_is(x0Length)] 
+#endif
+    BYTE*       x0;
+    UINT32      x1Length;
+#ifdef __midl
+    [size_is(x1Length)] 
+#endif
+    BYTE*       x1;
+    UINT32      x2Length;
+#ifdef __midl
+    [size_is(x2Length)] 
+#endif
+    BYTE*       x2;
+    UINT32      x3Length;
+#ifdef __midl
+    [size_is(x3Length)] 
+#endif
+    BYTE*       x3;
+    UINT32      x4Length;
+#ifdef __midl
+    [size_is(x4Length)] 
+#endif
+    BYTE*       x4;
+    UINT32      x5Length;
+#ifdef __midl
+    [size_is(x5Length)] 
+#endif
+    BYTE*       x5;
+} TSS_DAA_AR_SK;
+
+typedef struct tdTSS_DAA_AR_KEY_PAIR
+{
+    TSS_VERSION   versionInfo;
+    TSS_DAA_AR_SK secretKey;
+    TSS_DAA_AR_PK publicKey;
+} TSS_DAA_AR_KEY_PAIR;
+
+typedef struct tdTSS_DAA_CRED_ISSUER
+{
+    TSS_VERSION versionInfo;
+    UINT32      capitalALength;
+#ifdef __midl
+    [size_is(capitalALength)] 
+#endif
+    BYTE*       capitalA;
+    UINT32      eLength;
+#ifdef __midl
+    [size_is(eLength)] 
+#endif
+    BYTE*       e;
+    UINT32      vPrimePrimeLength;
+#ifdef __midl
+    [size_is(vPrimePrimeLength)] 
+#endif
+    BYTE*       vPrimePrime;
+    UINT32      attributesIssuerLength;         // Length of first dimension
+    UINT32      attributesIssuerLength2;        // Length of second dimension
+#ifdef __midl
+    [size_is(attributesIssuerLength,attributesIssuerLength2)] 
+#endif
+    BYTE**      attributesIssuer;
+    UINT32      cPrimeLength;
+#ifdef __midl
+    [size_is(cPrimeLength)] 
+#endif
+    BYTE*       cPrime;
+    UINT32      sELength;
+#ifdef __midl
+    [size_is(sELength)] 
+#endif
+    BYTE*       sE;
+} TSS_DAA_CRED_ISSUER;
+
+typedef struct tdTSS_DAA_CREDENTIAL
+{
+    TSS_VERSION versionInfo;
+    UINT32      capitalALength;
+#ifdef __midl
+    [size_is(capitalALength)] 
+#endif
+    BYTE*       capitalA;
+    UINT32      exponentLength;
+#ifdef __midl
+    [size_is(exponentLength)] 
+#endif
+    BYTE*       exponent;
+    UINT32      vBar0Length;
+#ifdef __midl
+    [size_is(vBar0Length)] 
+#endif
+    BYTE*       vBar0;
+    UINT32      vBar1Length;
+#ifdef __midl
+    [size_is(vBar1Length)] 
+#endif
+    BYTE*       vBar1;
+    UINT32      attributesLength;       // Length of first dimension
+    UINT32      attributesLength2;      // Length of second dimension
+#ifdef __midl
+    [size_is(attributesLength,attributesLength2)] 
+#endif
+    BYTE**      attributes;
+    TSS_DAA_PK  issuerPK;
+    UINT32      tpmSpecificEncLength;
+#ifdef __midl
+    [size_is(tpmSpecificEncLength)]
+#endif
+    BYTE*       tpmSpecificEnc;
+    UINT32      daaCounter;
+} TSS_DAA_CREDENTIAL;
+
+typedef struct tdTSS_DAA_ATTRIB_COMMIT
+{
+    TSS_VERSION versionInfo;
+    UINT32      betaLength;
+#ifdef __midl
+    [size_is(betaLength)]
+#endif
+    BYTE*       beta;
+    UINT32      sMuLength;
+#ifdef __midl
+    [size_is(sMuLength)]
+#endif
+    BYTE*       sMu;
+} TSS_DAA_ATTRIB_COMMIT;
+
+typedef struct tdTSS_DAA_CREDENTIAL_REQUEST
+{
+    TSS_VERSION versionInfo;
+    UINT32      capitalULength;
+#ifdef __midl
+    [size_is(capitalULength)]
+#endif
+    BYTE*       capitalU;
+    UINT32      capitalNiLength;
+#ifdef __midl
+    [size_is(capitalNiLength)]
+#endif
+    BYTE*       capitalNi;
+    UINT32      authenticationProofLength;
+#ifdef __midl
+    [size_is(authenticationProofLength)]
+#endif
+    BYTE*       authenticationProof;
+    UINT32      challengeLength;
+#ifdef __midl
+    [size_is(challengeLength)]
+#endif
+    BYTE*       challenge;
+    UINT32      nonceTpmLength;
+#ifdef __midl
+    [size_is(nonceTpmLength)]
+#endif
+    BYTE*       nonceTpm;
+    UINT32      noncePlatformLength;
+#ifdef __midl
+    [size_is(noncePlatformLength)]
+#endif
+    BYTE*       noncePlatform;
+    UINT32      sF0Length;
+#ifdef __midl
+    [size_is(sF0Length)]
+#endif
+    BYTE*       sF0;
+    UINT32      sF1Length;
+#ifdef __midl
+    [size_is(sF1Length)]
+#endif
+    BYTE*       sF1;
+    UINT32      sVprimeLength;
+#ifdef __midl
+    [size_is(sVprimeLength)]
+#endif
+    BYTE*       sVprime;
+    UINT32      sVtildePrimeLength;
+#ifdef __midl
+    [size_is(sVtildePrimeLength)]
+#endif
+    BYTE*       sVtildePrime;
+    UINT32      sALength;       // Length of first dimension
+    UINT32      sALength2;      // Length of second dimension
+#ifdef __midl
+    [size_is(sALength,sALength2)]
+#endif
+    BYTE**      sA;
+    UINT32      attributeCommitmentsLength;
+    TSS_DAA_ATTRIB_COMMIT* attributeCommitments;
+} TSS_DAA_CREDENTIAL_REQUEST;
+
+typedef struct tdTSS_DAA_SELECTED_ATTRIB
+{
+    TSS_VERSION versionInfo;
+    UINT32      indicesListLength;
+#ifdef __midl
+    [size_is(indicesListLength)]
+#endif
+    TSS_BOOL*   indicesList;
+} TSS_DAA_SELECTED_ATTRIB;
+
+typedef struct tdTSS_DAA_PSEUDONYM
+{
+    TSS_VERSION versionInfo;
+    TSS_FLAG    payloadFlag;
+    UINT32      payloadLength;
+#ifdef __midl
+    [size_is(payloadLength)]
+#endif
+    BYTE*       payload;
+} TSS_DAA_PSEUDONYM;
+
+typedef struct tdTSS_DAA_PSEUDONYM_PLAIN
+{
+    TSS_VERSION versionInfo;
+    UINT32      capitalNvLength;
+#ifdef __midl
+    [size_is(capitalNvLength)]
+#endif
+    BYTE*       capitalNv;
+} TSS_DAA_PSEUDONYM_PLAIN;
+
+typedef struct tdTSS_DAA_PSEUDONYM_ENCRYPTED
+{
+    TSS_VERSION versionInfo;
+    UINT32      delta1Length;
+#ifdef __midl
+    [size_is(delta1Length)]
+#endif
+    BYTE*       delta1;
+    UINT32      delta2Length;
+#ifdef __midl
+    [size_is(delta2Length)]
+#endif
+    BYTE*       delta2;
+    UINT32      delta3Length;
+#ifdef __midl
+    [size_is(delta3Length)]
+#endif
+    BYTE*       delta3;
+    UINT32      delta4Length;
+#ifdef __midl
+    [size_is(delta4Length)]
+#endif
+    BYTE*       delta4;
+    UINT32      sTauLength;
+#ifdef __midl
+    [size_is(sTauLength)]
+#endif
+    BYTE*       sTau;
+} TSS_DAA_PSEUDONYM_ENCRYPTED;
+
+typedef struct tdTSS_DAA_SIGN_CALLBACK
+{
+    TSS_VERSION versionInfo;
+    TSS_HHASH   challenge;
+    TSS_FLAG    payloadFlag;
+    UINT32      payloadLength;
+#ifdef __midl
+    [size_is(payloadLength)]
+#endif
+    BYTE*       payload;
+} TSS_DAA_SIGN_CALLBACK;
+
+typedef struct tdTSS_DAA_SIGNATURE
+{
+    TSS_VERSION            versionInfo;
+    UINT32                 zetaLength;
+#ifdef __midl
+    [size_is(zetaLength)]
+#endif
+    BYTE*                  zeta;
+    UINT32                 capitalTLength;
+#ifdef __midl
+    [size_is(capitalTLength)]
+#endif
+    BYTE*                  capitalT;
+    UINT32                 challengeLength;
+#ifdef __midl
+    [size_is(challengeLength)]
+#endif
+    BYTE*                  challenge;
+    UINT32                 nonceTpmLength;
+#ifdef __midl
+    [size_is(nonceTpmLength)]
+#endif
+    BYTE*                  nonceTpm;
+    UINT32                 sVLength;
+#ifdef __midl
+    [size_is(sVLength)]
+#endif
+    BYTE*                  sV;
+    UINT32                 sF0Length;
+#ifdef __midl
+    [size_is(sF0Length)]
+#endif
+    BYTE*                  sF0;
+    UINT32                 sF1Length;
+#ifdef __midl
+    [size_is(sF1Length)]
+#endif
+    BYTE*                  sF1;
+    UINT32                 sELength;
+#ifdef __midl
+    [size_is(sELength)]
+#endif
+    BYTE*                  sE;
+    UINT32                 sALength;    // Length of first dimension
+    UINT32                 sALength2;   // Length of second dimension
+#ifdef __midl
+    [size_is(sALength,sALength2)]
+#endif
+    BYTE**                 sA;
+    UINT32                 attributeCommitmentsLength;
+#ifdef __midl
+    [size_is(attributeCommitmentsLength)]
+#endif
+    TSS_DAA_ATTRIB_COMMIT* attributeCommitments;
+    TSS_DAA_PSEUDONYM      signedPseudonym;
+    TSS_DAA_SIGN_CALLBACK  callbackResult;
+} TSS_DAA_SIGNATURE;
+
+typedef struct tdTSS_DAA_IDENTITY_PROOF
+{
+    TSS_VERSION versionInfo;
+    UINT32      endorsementLength;
+#ifdef __midl
+    [size_is(endorsementLength)]
+#endif
+    BYTE*       endorsementCredential;
+    UINT32      platformLength;
+#ifdef __midl
+    [size_is(platformLength)]
+#endif
+    BYTE*       platform;
+    UINT32      conformanceLength;
+#ifdef __midl
+    [size_is(conformanceLength)]
+#endif
+    BYTE*       conformance;
+} TSS_DAA_IDENTITY_PROOF;
+
+
+////////////////////////////////////////////////////////////////////
+
+typedef UINT32 TSS_FAMILY_ID;
+typedef BYTE   TSS_DELEGATION_LABEL;
+// Values are TSS_DELEGATIONTYPE_KEY or TSS_DELEGATIONTYPE_OWNER
+typedef UINT32 TSS_DELEGATION_TYPE;
+
+typedef struct tdTSS_PCR_INFO_SHORT
+{
+    UINT32               sizeOfSelect;
+#ifdef __midl
+    [size_is(sizeOfSelect)]
+#endif
+    BYTE                *selection;
+    BYTE                 localityAtRelease;
+    UINT32               sizeOfDigestAtRelease;
+#ifdef __midl
+    [size_is(sizeOfDigestAtRelease)]
+#endif
+    BYTE                *digestAtRelease;
+} TSS_PCR_INFO_SHORT;
+
+typedef struct tdTSS_FAMILY_TABLE_ENTRY
+{
+    TSS_FAMILY_ID        familyID;
+    TSS_DELEGATION_LABEL label;
+    UINT32               verificationCount;
+    TSS_BOOL             enabled;
+    TSS_BOOL             locked;
+} TSS_FAMILY_TABLE_ENTRY;
+
+typedef struct tdTSS_DELEGATION_TABLE_ENTRY
+{
+    UINT32               tableIndex;
+    TSS_DELEGATION_LABEL label;
+    TSS_PCR_INFO_SHORT   pcrInfo;
+    UINT32               per1;
+    UINT32               per2;
+    TSS_FAMILY_ID        familyID;
+    UINT32               verificationCount;
+} TSS_DELEGATION_TABLE_ENTRY;
+
+typedef struct tdTSS_PLATFORM_CLASS
+{
+    UINT32 platformClassSimpleIdentifier;
+    UINT32 platformClassURISize;
+    BYTE*  pPlatformClassURI;
+} TSS_PLATFORM_CLASS;
+
+#endif // __TSS_STRUCTS_H__
+
diff -ru trousers-0.3.8-orig/src/include/tss/tss_typedef.h trousers-0.3.8/src/include/tss/tss_typedef.h
--- trousers-0.3.8-orig/src/include/tss/tss_typedef.h	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/include/tss/tss_typedef.h	2012-02-14 20:35:05.919842156 +0000
@@ -1,48 +1,48 @@
-/*++
-
-Global typedefs for TSS
- 
-*/
-
-#ifndef __TSS_TYPEDEF_H__
-#define __TSS_TYPEDEF_H__
-
-#include <tss/platform.h>
-
-//--------------------------------------------------------------------
-// definitions for TSS Service Provider (TSP)
-//
-typedef  UINT32  TSS_HANDLE;
-
-typedef  UINT32  TSS_FLAG;  // object attributes
-typedef  UINT32  TSS_RESULT;  // the return code from a TSS function
-
-typedef  UINT32          TSS_HOBJECT;     // basic object handle
-typedef  TSS_HOBJECT     TSS_HCONTEXT;    // context object handle
-typedef  TSS_HOBJECT     TSS_HPOLICY;     // policy object handle
-typedef  TSS_HOBJECT     TSS_HTPM;        // TPM object handle
-typedef  TSS_HOBJECT     TSS_HKEY;        // key object handle
-typedef  TSS_HOBJECT     TSS_HENCDATA;    // encrypted data object handle
-typedef  TSS_HOBJECT     TSS_HPCRS;       // PCR composite object handle
-typedef  TSS_HOBJECT     TSS_HHASH;       // hash object handle
-typedef  TSS_HOBJECT     TSS_HNVSTORE;    // NV storage object handle
-typedef  TSS_HOBJECT     TSS_HMIGDATA;    // migration data utility obj handle
-typedef  TSS_HOBJECT     TSS_HDELFAMILY;  // delegation family object handle
-typedef  TSS_HOBJECT     TSS_HDAA_CREDENTIAL; // daa credential
-typedef  TSS_HOBJECT     TSS_HDAA_ISSUER_KEY; // daa credential issuer keypair
-typedef  TSS_HOBJECT     TSS_HDAA_ARA_KEY;    // daa anonymity revocation
-                                              // authority keypair
-
-typedef UINT32  TSS_EVENTTYPE;
-typedef UINT16  TSS_MIGRATE_SCHEME;
-typedef UINT32  TSS_ALGORITHM_ID;
-typedef UINT32  TSS_KEY_USAGE_ID;
-typedef UINT16  TSS_KEY_ENC_SCHEME;
-typedef UINT16  TSS_KEY_SIG_SCHEME;
-typedef BYTE    TSS_KEY_AUTH_DATA_USAGE;
-typedef UINT32  TSS_CMK_DELEGATE;
-typedef UINT32  TSS_NV_INDEX;
-typedef UINT32  TSS_COUNTER_ID;
-
-#endif // __TSS_TYPEDEF_H__
-
+/*++
+
+Global typedefs for TSS
+ 
+*/
+
+#ifndef __TSS_TYPEDEF_H__
+#define __TSS_TYPEDEF_H__
+
+#include <tss/platform.h>
+
+//--------------------------------------------------------------------
+// definitions for TSS Service Provider (TSP)
+//
+typedef  UINT32  TSS_HANDLE;
+
+typedef  UINT32  TSS_FLAG;  // object attributes
+typedef  UINT32  TSS_RESULT;  // the return code from a TSS function
+
+typedef  UINT32          TSS_HOBJECT;     // basic object handle
+typedef  TSS_HOBJECT     TSS_HCONTEXT;    // context object handle
+typedef  TSS_HOBJECT     TSS_HPOLICY;     // policy object handle
+typedef  TSS_HOBJECT     TSS_HTPM;        // TPM object handle
+typedef  TSS_HOBJECT     TSS_HKEY;        // key object handle
+typedef  TSS_HOBJECT     TSS_HENCDATA;    // encrypted data object handle
+typedef  TSS_HOBJECT     TSS_HPCRS;       // PCR composite object handle
+typedef  TSS_HOBJECT     TSS_HHASH;       // hash object handle
+typedef  TSS_HOBJECT     TSS_HNVSTORE;    // NV storage object handle
+typedef  TSS_HOBJECT     TSS_HMIGDATA;    // migration data utility obj handle
+typedef  TSS_HOBJECT     TSS_HDELFAMILY;  // delegation family object handle
+typedef  TSS_HOBJECT     TSS_HDAA_CREDENTIAL; // daa credential
+typedef  TSS_HOBJECT     TSS_HDAA_ISSUER_KEY; // daa credential issuer keypair
+typedef  TSS_HOBJECT     TSS_HDAA_ARA_KEY;    // daa anonymity revocation
+                                              // authority keypair
+
+typedef UINT32  TSS_EVENTTYPE;
+typedef UINT16  TSS_MIGRATE_SCHEME;
+typedef UINT32  TSS_ALGORITHM_ID;
+typedef UINT32  TSS_KEY_USAGE_ID;
+typedef UINT16  TSS_KEY_ENC_SCHEME;
+typedef UINT16  TSS_KEY_SIG_SCHEME;
+typedef BYTE    TSS_KEY_AUTH_DATA_USAGE;
+typedef UINT32  TSS_CMK_DELEGATE;
+typedef UINT32  TSS_NV_INDEX;
+typedef UINT32  TSS_COUNTER_ID;
+
+#endif // __TSS_TYPEDEF_H__
+
diff -ru trousers-0.3.8-orig/src/Makefile.in trousers-0.3.8/src/Makefile.in
--- trousers-0.3.8-orig/src/Makefile.in	2011-12-24 06:19:32.000000000 +0000
+++ trousers-0.3.8/src/Makefile.in	2012-02-14 20:35:05.920364287 +0000
@@ -103,6 +103,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -112,8 +113,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -128,6 +127,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -144,9 +144,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -159,6 +156,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -191,7 +189,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/src/tcs/Makefile.in trousers-0.3.8/src/tcs/Makefile.in
--- trousers-0.3.8-orig/src/tcs/Makefile.in	2011-12-24 06:19:32.000000000 +0000
+++ trousers-0.3.8/src/tcs/Makefile.in	2012-02-14 20:35:05.921548772 +0000
@@ -285,6 +285,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -294,8 +295,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -310,6 +309,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -326,9 +326,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -341,6 +338,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -373,7 +371,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/src/tcs/rpc/tcstp/rpc_evlog.c trousers-0.3.8/src/tcs/rpc/tcstp/rpc_evlog.c
--- trousers-0.3.8-orig/src/tcs/rpc/tcstp/rpc_evlog.c	2010-09-10 19:50:27.000000000 +0000
+++ trousers-0.3.8/src/tcs/rpc/tcstp/rpc_evlog.c	2012-02-14 20:35:05.921799762 +0000
@@ -82,6 +82,7 @@
 		initData(&data->comm, 0);
 
 	data->comm.hdr.u.result = result;
+	(void)totalSize;
 
 	return TSS_SUCCESS;
 }
diff -ru trousers-0.3.8-orig/src/tcs/rpc/tcstp/rpc_ps.c trousers-0.3.8/src/tcs/rpc/tcstp/rpc_ps.c
--- trousers-0.3.8-orig/src/tcs/rpc/tcstp/rpc_ps.c	2011-05-17 17:09:00.000000000 +0000
+++ trousers-0.3.8/src/tcs/rpc/tcstp/rpc_ps.c	2012-02-14 20:35:05.922157934 +0000
@@ -26,6 +26,29 @@
 #include "tcs_utils.h"
 #include "rpc_tcstp_tcs.h"
 
+#ifdef SOLARIS
+#include <ucred.h>
+#include <errno.h>
+
+static TSS_RESULT
+verify_peer(struct tcsd_thread_data *data)
+{
+	ucred_t *uc = NULL;
+	if (getpeerucred(data->sock, &uc)) {
+		LogError("Failed to get peer credential (%s)",
+		    strerror(errno));
+		return TCSERR(TSS_E_TSP_AUTHFAIL);
+	}
+	if (ucred_geteuid(uc) != 0) {
+		LogError("Unauthorized attempt to modify a system key (%s)",
+		    strerror(errno));
+		ucred_free(uc);
+		return TCSERR(TSS_E_TSP_AUTHFAIL);
+	}
+	ucred_free(uc);
+	return (TSS_SUCCESS);
+}
+#endif
 
 TSS_RESULT
 tcs_wrap_RegisterKey(struct tcsd_thread_data *data)
@@ -38,6 +61,10 @@
 	UINT32 cVendorData;
 	BYTE *gbVendorData;
 	TSS_RESULT result;
+#ifdef SOLARIS
+	if ( (result = verify_peer(data)) != TSS_SUCCESS)
+		return (result);
+#endif
 
 	if (getData(TCSD_PACKET_TYPE_UINT32, 0, &hContext, 0, &data->comm))
 		return TCSERR(TSS_E_INTERNAL_ERROR);
@@ -99,6 +126,10 @@
 	TCS_CONTEXT_HANDLE hContext;
 	TSS_UUID uuid;
 	TSS_RESULT result;
+#ifdef SOLARIS
+	if ( (result = verify_peer(data)) != TSS_SUCCESS)
+		return (result);
+#endif
 
 	if (getData(TCSD_PACKET_TYPE_UINT32, 0, &hContext, 0, &data->comm))
 		return TCSERR(TSS_E_INTERNAL_ERROR);
diff -ru trousers-0.3.8-orig/src/tcs/rpc/tcstp/rpc.c trousers-0.3.8/src/tcs/rpc/tcstp/rpc.c
--- trousers-0.3.8-orig/src/tcs/rpc/tcstp/rpc.c	2010-06-09 20:18:45.000000000 +0000
+++ trousers-0.3.8/src/tcs/rpc/tcstp/rpc.c	2012-02-14 20:35:05.922751438 +0000
@@ -385,134 +385,134 @@
 typedef struct tdDispatchTable {
 	TSS_RESULT (*Func) (struct tcsd_thread_data *);
 	const char *name;
+	UINT32 ordinal;
 } DispatchTable;
 
 DispatchTable tcs_func_table[TCSD_MAX_NUM_ORDS] = {
-	{tcs_wrap_Error,"Error"},   /* 0 */
-	{tcs_wrap_OpenContext,"OpenContext"},
-	{tcs_wrap_CloseContext,"CloseContext"},
-	{tcs_wrap_Error,"Error"},
-	{tcs_wrap_TCSGetCapability,"TCSGetCapability"},
-	{tcs_wrap_RegisterKey,"RegisterKey"}, /* 5 */
-	{tcs_wrap_UnregisterKey,"UnregisterKey"},
-	{tcs_wrap_EnumRegisteredKeys,"EnumRegisteredKeys"},
-	{tcs_wrap_Error,"Error"},
-	{tcs_wrap_GetRegisteredKeyBlob,"GetRegisteredKeyBlob"},
-	{tcs_wrap_GetRegisteredKeyByPublicInfo,"GetRegisteredKeyByPublicInfo"}, /* 10 */
-	{tcs_wrap_LoadKeyByBlob,"LoadKeyByBlob"},
-	{tcs_wrap_LoadKeyByUUID,"LoadKeyByUUID"},
-	{tcs_wrap_EvictKey,"EvictKey"},
-	{tcs_wrap_CreateWrapKey,"CreateWrapKey"},
-	{tcs_wrap_GetPubkey,"GetPubkey"}, /* 15 */
-	{tcs_wrap_MakeIdentity,"MakeIdentity"},
-	{tcs_wrap_LogPcrEvent,"LogPcrEvent"},
-	{tcs_wrap_GetPcrEvent,"GetPcrEvent"},
-	{tcs_wrap_GetPcrEventsByPcr,"GetPcrEventsByPcr"},
-	{tcs_wrap_GetPcrEventLog,"GetPcrEventLog"}, /* 20 */
-	{tcs_wrap_SetOwnerInstall,"SetOwnerInstall"},
-	{tcs_wrap_TakeOwnership,"TakeOwnership"},
-	{tcs_wrap_OIAP,"OIAP"},
-	{tcs_wrap_OSAP,"OSAP"},
-	{tcs_wrap_ChangeAuth,"ChangeAuth"}, /* 25 */
-	{tcs_wrap_ChangeAuthOwner,"ChangeAuthOwner"},
-	{tcs_wrap_Error,"Error"},
-	{tcs_wrap_Error,"Error"},
-	{tcs_wrap_TerminateHandle,"TerminateHandle"},
-	{tcs_wrap_ActivateIdentity,"ActivateIdentity"}, /* 30 */
-	{tcs_wrap_Extend,"Extend"},
-	{tcs_wrap_PcrRead,"PcrRead"},
-	{tcs_wrap_Quote,"Quote"},
-	{tcs_wrap_DirWriteAuth,"DirWriteAuth"},
-	{tcs_wrap_DirRead,"DirRead"}, /* 35 */
-	{tcs_wrap_Seal,"Seal"},
-	{tcs_wrap_UnSeal,"UnSeal"},
-	{tcs_wrap_UnBind,"UnBind"},
-	{tcs_wrap_CreateMigrationBlob,"CreateMigrationBlob"},
-	{tcs_wrap_ConvertMigrationBlob,"ConvertMigrationBlob"}, /* 40 */
-	{tcs_wrap_AuthorizeMigrationKey,"AuthorizeMigrationKey"},
-	{tcs_wrap_CertifyKey,"CertifyKey"},
-	{tcs_wrap_Sign,"Sign"},
-	{tcs_wrap_GetRandom,"GetRandom"},
-	{tcs_wrap_StirRandom,"StirRandom"}, /* 45 */
-	{tcs_wrap_GetCapability,"GetCapability"},
-	{tcs_wrap_Error,"Error"},
-	{tcs_wrap_GetCapabilityOwner,"GetCapabilityOwner"},
-	{tcs_wrap_CreateEndorsementKeyPair,"CreateEndorsementKeyPair"},
-	{tcs_wrap_ReadPubek,"ReadPubek"}, /* 50 */
-	{tcs_wrap_DisablePubekRead,"DisablePubekRead"},
-	{tcs_wrap_OwnerReadPubek,"OwnerReadPubek"},
-	{tcs_wrap_SelfTestFull,"SelfTestFull"},
-	{tcs_wrap_CertifySelfTest,"CertifySelfTest"},
-	{tcs_wrap_Error,"Error"}, /* 55 */
-	{tcs_wrap_GetTestResult,"GetTestResult"},
-	{tcs_wrap_OwnerSetDisable,"OwnerSetDisable"},
-	{tcs_wrap_OwnerClear,"OwnerClear"},
-	{tcs_wrap_DisableOwnerClear,"DisableOwnerClear"},
-	{tcs_wrap_ForceClear,"ForceClear"}, /* 60 */
-	{tcs_wrap_DisableForceClear,"DisableForceClear"},
-	{tcs_wrap_PhysicalDisable,"PhysicalDisable"},
-	{tcs_wrap_PhysicalEnable,"PhysicalEnable"},
-	{tcs_wrap_PhysicalSetDeactivated,"PhysicalSetDeactivated"},
-	{tcs_wrap_SetTempDeactivated,"SetTempDeactivated"}, /* 65 */
-	{tcs_wrap_PhysicalPresence,"PhysicalPresence"},
-	{tcs_wrap_Error,"Error"},
-	{tcs_wrap_Error,"Error"},
-	{tcs_wrap_CreateMaintenanceArchive,"CreateMaintenanceArchive"},
-	{tcs_wrap_LoadMaintenanceArchive,"LoadMaintenanceArchive"}, /* 70 */
-	{tcs_wrap_KillMaintenanceFeature,"KillMaintenanceFeature"},
-	{tcs_wrap_LoadManuMaintPub,"LoadManuMaintPub"},
-	{tcs_wrap_ReadManuMaintPub,"ReadManuMaintPub"},
-	{tcs_wrap_DaaJoin,"DaaJoin"},
-	{tcs_wrap_DaaSign,"DaaSign"}, /* 75 */
-	{tcs_wrap_SetCapability,"SetCapability"},
-	{tcs_wrap_ResetLockValue,"ResetLockValue"},
-	{tcs_wrap_PcrReset,"PcrReset"},
-	{tcs_wrap_ReadCounter,"ReadCounter"},
-	{tcs_wrap_CreateCounter,"CreateCounter"}, /* 80 */
-	{tcs_wrap_IncrementCounter,"IncrementCounter"},
-	{tcs_wrap_ReleaseCounter,"ReleaseCounter"},
-	{tcs_wrap_ReleaseCounterOwner,"ReleaseCounterOwner"},
-	{tcs_wrap_ReadCurrentTicks,"ReadCurrentTicks"},
-	{tcs_wrap_TickStampBlob,"TicksStampBlob"}, /* 85 */
-	{tcs_wrap_GetCredential,"GetCredential"},
-	{tcs_wrap_NV_DefineOrReleaseSpace,"NVDefineOrReleaseSpace"},
-	{tcs_wrap_NV_WriteValue,"NVWriteValue"},
-	{tcs_wrap_NV_WriteValueAuth,"NVWriteValueAuth"},
-	{tcs_wrap_NV_ReadValue,"NVReadValue"}, /* 90 */
-	{tcs_wrap_NV_ReadValueAuth,"NVReadValueAuth"},
-	{tcs_wrap_EstablishTransport,"EstablishTransport"},
-	{tcs_wrap_ExecuteTransport,"ExecuteTransport"},
-	{tcs_wrap_ReleaseTransportSigned,"ReleaseTransportSigned"},
-	{tcs_wrap_SetOrdinalAuditStatus,"SetOrdinalAuditStatus"}, /* 95 */
-	{tcs_wrap_GetAuditDigest,"GetAuditDigest"},
-	{tcs_wrap_GetAuditDigestSigned,"GetAuditDigestSigned"},
-	{tcs_wrap_Sealx,"Sealx"},
-	{tcs_wrap_SetOperatorAuth,"SetOperatorAuth"},
-	{tcs_wrap_OwnerReadInternalPub,"OwnerReadInternalPub"}, /* 100 */
-	{tcs_wrap_EnumRegisteredKeys2,"EnumRegisteredKeys2"},
-	{tcs_wrap_SetTempDeactivated2,"SetTempDeactivated2"},
-	{tcs_wrap_Delegate_Manage,"Delegate_Manage"},
-	{tcs_wrap_Delegate_CreateKeyDelegation,"Delegate_CreateKeyDelegation"},
-	{tcs_wrap_Delegate_CreateOwnerDelegation,"Delegate_CreateOwnerDelegation"}, /* 105 */
-	{tcs_wrap_Delegate_LoadOwnerDelegation,"Delegate_LoadOwnerDelegation"},
-	{tcs_wrap_Delegate_ReadTable,"Delegate_ReadTable"},
-	{tcs_wrap_Delegate_UpdateVerificationCount,"Delegate_UpdateVerificationCount"},
-	{tcs_wrap_Delegate_VerifyDelegation,"Delegate_VerifyDelegation"},
-	{tcs_wrap_CreateRevocableEndorsementKeyPair,"CreateRevocableEndorsementKeyPair"}, /* 110 */
-	{tcs_wrap_RevokeEndorsementKeyPair,"RevokeEndorsementKeyPair"},
-	{tcs_wrap_Error,"Error - was MakeIdentity2"},
-	{tcs_wrap_Quote2,"Quote2"},
-	{tcs_wrap_CMK_SetRestrictions,"CMK_SetRestrictions"},
-	{tcs_wrap_CMK_ApproveMA,"CMK_ApproveMA"}, /* 115 */
-	{tcs_wrap_CMK_CreateKey,"CMK_CreateKey"},
-	{tcs_wrap_CMK_CreateTicket,"CMK_CreateTicket"},
-	{tcs_wrap_CMK_CreateBlob,"CMK_CreateBlob"},
-	{tcs_wrap_CMK_ConvertMigration,"CMK_ConvertMigration"},
-	{tcs_wrap_FlushSpecific,"FlushSpecific"}, /* 120 */
-	{tcs_wrap_KeyControlOwner, "KeyControlOwner"},
-	{tcs_wrap_DSAP, "DSAP"}
-};
-
+ 	{tcs_wrap_Error,"Error", 0},   /* 0 */
+ 	{tcs_wrap_OpenContext,"OpenContext", 0},
+ 	{tcs_wrap_CloseContext,"CloseContext", 0},
+ 	{tcs_wrap_Error,"Error", 0},
+ 	{tcs_wrap_TCSGetCapability,"TCSGetCapability", 0},
+ 	{tcs_wrap_RegisterKey,"RegisterKey", 0}, /* 5 */
+ 	{tcs_wrap_UnregisterKey,"UnregisterKey", 0},
+ 	{tcs_wrap_EnumRegisteredKeys,"EnumRegisteredKeys", 0},
+ 	{tcs_wrap_Error,"Error", 0},
+ 	{tcs_wrap_GetRegisteredKeyBlob,"GetRegisteredKeyBlob", 0},
+ 	{tcs_wrap_GetRegisteredKeyByPublicInfo,"GetRegisteredKeyByPublicInfo", 0}, /* 10 */
+ 	{tcs_wrap_LoadKeyByBlob,"LoadKeyByBlob", 0},
+ 	{tcs_wrap_LoadKeyByUUID,"LoadKeyByUUID", 0},
+ 	{tcs_wrap_EvictKey,"EvictKey", 0},
+ 	{tcs_wrap_CreateWrapKey,"CreateWrapKey", 0},
+ 	{tcs_wrap_GetPubkey,"GetPubkey", 0}, /* 15 */
+ 	{tcs_wrap_MakeIdentity,"MakeIdentity", 0},
+ 	{tcs_wrap_LogPcrEvent,"LogPcrEvent", 0},
+ 	{tcs_wrap_GetPcrEvent,"GetPcrEvent", 0},
+ 	{tcs_wrap_GetPcrEventsByPcr,"GetPcrEventsByPcr", 0},
+ 	{tcs_wrap_GetPcrEventLog,"GetPcrEventLog", 0}, /* 20 */
+ 	{tcs_wrap_SetOwnerInstall,"SetOwnerInstall", TPM_ORD_SetOwnerInstall},
+ 	{tcs_wrap_TakeOwnership,"TakeOwnership", TPM_ORD_TakeOwnership},
+ 	{tcs_wrap_OIAP,"OIAP", 0},
+ 	{tcs_wrap_OSAP,"OSAP", 0},
+ 	{tcs_wrap_ChangeAuth,"ChangeAuth", 0}, /* 25 */
+ 	{tcs_wrap_ChangeAuthOwner,"ChangeAuthOwner", 0},
+ 	{tcs_wrap_Error,"Error", 0},
+ 	{tcs_wrap_Error,"Error", 0},
+ 	{tcs_wrap_TerminateHandle,"TerminateHandle", 0},
+ 	{tcs_wrap_ActivateIdentity,"ActivateIdentity", 0}, /* 30 */
+ 	{tcs_wrap_Extend,"Extend", 0},
+ 	{tcs_wrap_PcrRead,"PcrRead", 0},
+ 	{tcs_wrap_Quote,"Quote", 0},
+ 	{tcs_wrap_DirWriteAuth,"DirWriteAuth", 0},
+ 	{tcs_wrap_DirRead,"DirRead", 0}, /* 35 */
+ 	{tcs_wrap_Seal,"Seal", 0},
+ 	{tcs_wrap_UnSeal,"UnSeal", 0},
+ 	{tcs_wrap_UnBind,"UnBind", 0},
+ 	{tcs_wrap_CreateMigrationBlob,"CreateMigrationBlob", 0},
+ 	{tcs_wrap_ConvertMigrationBlob,"ConvertMigrationBlob", 0}, /* 40 */
+ 	{tcs_wrap_AuthorizeMigrationKey,"AuthorizeMigrationKey", 0},
+ 	{tcs_wrap_CertifyKey,"CertifyKey", 0},
+ 	{tcs_wrap_Sign,"Sign", 0},
+ 	{tcs_wrap_GetRandom,"GetRandom", 0},
+ 	{tcs_wrap_StirRandom,"StirRandom", 0}, /* 45 */
+ 	{tcs_wrap_GetCapability,"GetCapability", 0},
+ 	{tcs_wrap_Error,"Error", 0},
+ 	{tcs_wrap_GetCapabilityOwner,"GetCapabilityOwner", 0},
+ 	{tcs_wrap_CreateEndorsementKeyPair,"CreateEndorsementKeyPair", 0},
+ 	{tcs_wrap_ReadPubek,"ReadPubek", 0}, /* 50 */
+ 	{tcs_wrap_DisablePubekRead,"DisablePubekRead", 0},
+ 	{tcs_wrap_OwnerReadPubek,"OwnerReadPubek", 0},
+ 	{tcs_wrap_SelfTestFull,"SelfTestFull", TPM_ORD_SelfTestFull},
+ 	{tcs_wrap_CertifySelfTest,"CertifySelfTest", TPM_ORD_CertifySelfTest},
+ 	{tcs_wrap_Error,"Error", 0}, /* 55 */
+ 	{tcs_wrap_GetTestResult,"GetTestResult", 0},
+ 	{tcs_wrap_OwnerSetDisable,"OwnerSetDisable", TPM_ORD_OwnerSetDisable},
+ 	{tcs_wrap_OwnerClear,"OwnerClear", TPM_ORD_OwnerClear},
+ 	{tcs_wrap_DisableOwnerClear,"DisableOwnerClear", TPM_ORD_DisableOwnerClear},
+ 	{tcs_wrap_ForceClear,"ForceClear", TPM_ORD_ForceClear}, /* 60 */
+ 	{tcs_wrap_DisableForceClear,"DisableForceClear", TPM_ORD_DisableForceClear},
+ 	{tcs_wrap_PhysicalDisable,"PhysicalDisable", TPM_ORD_PhysicalDisable},
+ 	{tcs_wrap_PhysicalEnable,"PhysicalEnable", TPM_ORD_PhysicalEnable},
+ 	{tcs_wrap_PhysicalSetDeactivated,"PhysicalSetDeactivated", TPM_ORD_PhysicalSetDeactivated},
+ 	{tcs_wrap_SetTempDeactivated,"SetTempDeactivated", TPM_ORD_SetTempDeactivated}, /* 65 */
+ 	{tcs_wrap_PhysicalPresence,"PhysicalPresence", TSC_ORD_PhysicalPresence},
+ 	{tcs_wrap_Error,"Error", 0},
+ 	{tcs_wrap_Error,"Error", 0},
+ 	{tcs_wrap_CreateMaintenanceArchive,"CreateMaintenanceArchive", 0},
+ 	{tcs_wrap_LoadMaintenanceArchive,"LoadMaintenanceArchive", 0}, /* 70 */
+ 	{tcs_wrap_KillMaintenanceFeature,"KillMaintenanceFeature", 0},
+ 	{tcs_wrap_LoadManuMaintPub,"LoadManuMaintPub", 0},
+ 	{tcs_wrap_ReadManuMaintPub,"ReadManuMaintPub", 0},
+ 	{tcs_wrap_DaaJoin,"DaaJoin", 0},
+ 	{tcs_wrap_DaaSign,"DaaSign", 0}, /* 75 */
+ 	{tcs_wrap_SetCapability,"SetCapability", 0},
+ 	{tcs_wrap_ResetLockValue,"ResetLockValue", TPM_ORD_ResetLockValue},
+ 	{tcs_wrap_PcrReset,"PcrReset", 0},
+ 	{tcs_wrap_ReadCounter,"ReadCounter", 0},
+ 	{tcs_wrap_CreateCounter,"CreateCounter", 0}, /* 80 */
+ 	{tcs_wrap_IncrementCounter,"IncrementCounter", 0},
+ 	{tcs_wrap_ReleaseCounter,"ReleaseCounter", 0},
+ 	{tcs_wrap_ReleaseCounterOwner,"ReleaseCounterOwner", 0},
+ 	{tcs_wrap_ReadCurrentTicks,"ReadCurrentTicks", 0},
+ 	{tcs_wrap_TickStampBlob,"TicksStampBlob", 0}, /* 85 */
+ 	{tcs_wrap_GetCredential,"GetCredential", 0},
+ 	{tcs_wrap_NV_DefineOrReleaseSpace,"NVDefineOrReleaseSpace", 0},
+ 	{tcs_wrap_NV_WriteValue,"NVWriteValue", 0},
+ 	{tcs_wrap_NV_WriteValueAuth,"NVWriteValueAuth", 0},
+ 	{tcs_wrap_NV_ReadValue,"NVReadValue", 0}, /* 90 */
+ 	{tcs_wrap_NV_ReadValueAuth,"NVReadValueAuth", 0},
+ 	{tcs_wrap_EstablishTransport,"EstablishTransport", 0},
+ 	{tcs_wrap_ExecuteTransport,"ExecuteTransport", 0},
+ 	{tcs_wrap_ReleaseTransportSigned,"ReleaseTransportSigned", 0},
+ 	{tcs_wrap_SetOrdinalAuditStatus,"SetOrdinalAuditStatus", 0}, /* 95 */
+ 	{tcs_wrap_GetAuditDigest,"GetAuditDigest", 0},
+ 	{tcs_wrap_GetAuditDigestSigned,"GetAuditDigestSigned", 0},
+ 	{tcs_wrap_Sealx,"Sealx", 0},
+ 	{tcs_wrap_SetOperatorAuth,"SetOperatorAuth", TPM_ORD_SetOperatorAuth},
+ 	{tcs_wrap_OwnerReadInternalPub,"OwnerReadInternalPub", 0}, /* 100 */
+ 	{tcs_wrap_EnumRegisteredKeys2,"EnumRegisteredKeys2", 0},
+ 	{tcs_wrap_SetTempDeactivated2,"SetTempDeactivated2", 0},
+ 	{tcs_wrap_Delegate_Manage,"Delegate_Manage", 0},
+ 	{tcs_wrap_Delegate_CreateKeyDelegation,"Delegate_CreateKeyDelegation", 0},
+ 	{tcs_wrap_Delegate_CreateOwnerDelegation,"Delegate_CreateOwnerDelegation", 0}, /* 105 */
+ 	{tcs_wrap_Delegate_LoadOwnerDelegation,"Delegate_LoadOwnerDelegation", 0},
+ 	{tcs_wrap_Delegate_ReadTable,"Delegate_ReadTable", 0},
+ 	{tcs_wrap_Delegate_UpdateVerificationCount,"Delegate_UpdateVerificationCount", 0},
+ 	{tcs_wrap_Delegate_VerifyDelegation,"Delegate_VerifyDelegation", 0},
+ 	{tcs_wrap_CreateRevocableEndorsementKeyPair,"CreateRevocableEndorsementKeyPair", 0}, /* 110 */
+ 	{tcs_wrap_RevokeEndorsementKeyPair,"RevokeEndorsementKeyPair", 0},
+	{tcs_wrap_Error,"Error - was MakeIdentity2", 0},
+ 	{tcs_wrap_Quote2,"Quote2", 0},
+ 	{tcs_wrap_CMK_SetRestrictions,"CMK_SetRestrictions", 0},
+ 	{tcs_wrap_CMK_ApproveMA,"CMK_ApproveMA", 0}, /* 115 */
+ 	{tcs_wrap_CMK_CreateKey,"CMK_CreateKey", 0},
+ 	{tcs_wrap_CMK_CreateTicket,"CMK_CreateTicket", 0},
+ 	{tcs_wrap_CMK_CreateBlob,"CMK_CreateBlob", 0},
+ 	{tcs_wrap_CMK_ConvertMigration,"CMK_ConvertMigration", 0},
+ 	{tcs_wrap_FlushSpecific,"FlushSpecific", 0}, /* 120 */
+ 	{tcs_wrap_KeyControlOwner, "KeyControlOwner", 0},
+ 	{tcs_wrap_DSAP, "DSAP", 0}
+  };
 int
 access_control(struct tcsd_thread_data *thread_data)
 {
@@ -562,11 +562,190 @@
 	return 1;
 }
 
+#if defined (SOLARIS)
+
+#include <ucred.h>
+#include <bsm/adt.h>
+#include <bsm/adt_event.h>
+
+static void
+audit_tpm(UINT32 cmd, struct tcsd_thread_data *data)
+{
+	adt_session_data_t *ah = NULL;
+	adt_event_data_t *event = NULL;
+	ucred_t *uc = NULL;
+	int adterr, msgid;
+	int adtstatus = ADT_FAILURE;
+
+	if (getpeerucred(data->sock, &uc)) {
+		LogError("Audit Failed - getpeerucred failed (%s)",
+		    strerror(errno));
+		return;
+	}
+	if (adt_start_session(&ah, NULL, ADT_USE_PROC_DATA) != 0) {
+		LogError("Audit Failed - adt_start_session failed (%s)",
+		    strerror(errno));
+		goto end;
+	}
+
+	if (adt_set_from_ucred(ah, uc, ADT_NEW) != 0) {
+		LogError("Audit Failed - adt_set_from_ucred failed (%s)",
+		    strerror(errno));
+		goto end;
+	}
+
+	/*
+	 * NOTE: It is important that the ordering of the
+	 * error message definitions in the adt.xml IDL from the
+	 * libbsm library source matches the numerical ordering of
+	 * the TPM_E_* error codes in /usr/include/tss/tpm_error.h
+	 */
+	if (data->comm.hdr.u.result == TSS_SUCCESS) {
+		adtstatus = ADT_SUCCESS;
+		adterr = ADT_SUCCESS;
+		/*
+		 * Use literal value here until the
+		 * build system is updated with latest adt_event.h
+		 * 4102 = ADT_TPM_E_NO_MSG (build 123).
+		 * Change this later.
+		 */
+		msgid = 4102;
+	} else if (data->comm.hdr.u.result & TPM_E_NON_FATAL) {
+		/*
+		 * NON_FATAL TPM errors are masked (0x800) so they are not in numerical
+		 * sequence with the rest of the TPM errors.
+		 */
+		msgid = ADT_TPM_E_RETRY +
+		    (data->comm.hdr.u.result - TPM_E_RETRY);
+		adterr = ADT_FAIL_VALUE_PROGRAM;
+	} else {
+		msgid = ADT_TPM_E_AUTHFAIL +
+		    (data->comm.hdr.u.result - TPM_E_AUTHFAIL);
+		adterr = ADT_FAIL_VALUE_PROGRAM;
+	}
+	switch(cmd) {
+		case TPM_ORD_CertifySelfTest:
+			event = adt_alloc_event(ah, ADT_tpm_certifyselftest);
+			if (event != NULL)
+				event->adt_tpm_certifyselftest.message = msgid;
+			break;
+		case TPM_ORD_OwnerClear:
+			event = adt_alloc_event(ah, ADT_tpm_ownerclear);
+			if (event != NULL)
+				event->adt_tpm_ownerclear.message = msgid;
+			break;
+		case TPM_ORD_ContinueSelfTest:
+			event = adt_alloc_event(ah, ADT_tpm_continueselftest);
+			if (event != NULL)
+				event->adt_tpm_continueselftest.message = msgid;
+			break;
+		case TPM_ORD_DisableForceClear:
+			event = adt_alloc_event(ah, ADT_tpm_disableforceclear);
+			if (event != NULL)
+				event->adt_tpm_disableforceclear.message = msgid;
+			break;
+		case TPM_ORD_DisableOwnerClear:
+			event = adt_alloc_event(ah, ADT_tpm_disableownerclear);
+			if (event != NULL)
+				event->adt_tpm_disableownerclear.message = msgid;
+			break;
+		case TPM_ORD_FieldUpgrade:
+			event = adt_alloc_event(ah, ADT_tpm_fieldupgrade);
+			if (event != NULL)
+				event->adt_tpm_fieldupgrade.message = msgid;
+			break;
+		case TPM_ORD_ForceClear:
+			event = adt_alloc_event(ah, ADT_tpm_forceclear);
+			if (event != NULL)
+				event->adt_tpm_forceclear.message = msgid;
+			break;
+		case TPM_ORD_OwnerSetDisable:
+			event = adt_alloc_event(ah, ADT_tpm_ownersetdisable);
+			if (event != NULL)
+				event->adt_tpm_ownersetdisable.message = msgid;
+			break;
+		case TPM_ORD_PhysicalEnable:
+			event = adt_alloc_event(ah, ADT_tpm_physicalenable);
+			if (event != NULL)
+				event->adt_tpm_physicalenable.message = msgid;
+			break;
+		case TPM_ORD_PhysicalDisable:
+			event = adt_alloc_event(ah, ADT_tpm_physicaldisable);
+			if (event != NULL)
+				event->adt_tpm_physicaldisable.message = msgid;
+			break;
+		case TPM_ORD_PhysicalSetDeactivated:
+			event = adt_alloc_event(ah, ADT_tpm_physicaldeactivate);
+			if (event != NULL)
+				event->adt_tpm_physicaldeactivate.message = msgid;
+			break;
+		case TSC_ORD_PhysicalPresence:
+			event = adt_alloc_event(ah, ADT_tpm_physicalpresence);
+			if (event != NULL)
+				event->adt_tpm_physicalpresence.message = msgid;
+			break;
+		case TPM_ORD_ResetLockValue:
+			event = adt_alloc_event(ah, ADT_tpm_resetlockvalue);
+			if (event != NULL)
+				event->adt_tpm_resetlockvalue.message = msgid;
+			break;
+		case TPM_ORD_SelfTestFull:
+			event = adt_alloc_event(ah, ADT_tpm_selftestfull);
+			if (event != NULL)
+				event->adt_tpm_selftestfull.message = msgid;
+			break;
+		case TPM_ORD_SetOperatorAuth:
+			event = adt_alloc_event(ah, ADT_tpm_setoperatorauth);
+			if (event != NULL)
+				event->adt_tpm_setoperatorauth.message = msgid;
+			break;
+		case TPM_ORD_SetOwnerInstall:
+			event = adt_alloc_event(ah, ADT_tpm_setownerinstall);
+			if (event != NULL)
+				event->adt_tpm_setownerinstall.message = msgid;
+			break;
+		case TPM_ORD_SetTempDeactivated:
+			event = adt_alloc_event(ah, ADT_tpm_settempdeactivated);
+			if (event != NULL)
+				event->adt_tpm_settempdeactivated.message = msgid;
+			break;
+		case TPM_ORD_TakeOwnership:
+			event = adt_alloc_event(ah, ADT_tpm_takeownership);
+			if (event != NULL)
+				event->adt_tpm_takeownership.message = msgid;
+			break;
+		default:
+			/* command not audited */
+			goto end;	
+	}
+	if (event == NULL) {
+		LogError("Audit Failed - Failed to allocate event (%s)",
+		    strerror(errno));
+		goto end;
+	}
+
+	if (adt_put_event(event, adtstatus, adterr)) {
+		LogError("Audit Failed - Failed to put audit event (%s)",
+		    strerror(errno));
+	}
+
+end:
+	ucred_free(uc);
+	adt_free_event(event);
+	(void) adt_end_session(ah);
+	
+	return;
+}
+#endif /* SOLARIS */
+
 TSS_RESULT
 dispatchCommand(struct tcsd_thread_data *data)
 {
 	UINT64 offset;
 	TSS_RESULT result;
+#if defined (SOLARIS)
+	UINT32 cmd;
+#endif
 
 	/* First, check the ordinal bounds */
 	if (data->comm.hdr.u.ordinal >= TCSD_MAX_NUM_ORDS) {
@@ -596,6 +775,9 @@
 	}
 
 	/* Now, dispatch */
+#if defined (SOLARIS)
+	cmd = tcs_func_table[data->comm.hdr.u.ordinal].ordinal;
+#endif
 	if ((result = tcs_func_table[data->comm.hdr.u.ordinal].Func(data)) == TSS_SUCCESS) {
 		/* set the comm buffer */
 		offset = 0;
@@ -607,6 +789,9 @@
 		LoadBlob_UINT32(&offset, data->comm.hdr.parm_size, data->comm.buf);
 		LoadBlob_UINT32(&offset, data->comm.hdr.parm_offset, data->comm.buf);
 	}
+#if defined (SOLARIS)
+	audit_tpm(cmd, data);
+#endif
 
 	return result;
 
diff -ru trousers-0.3.8-orig/src/tcs/tcs_caps.c trousers-0.3.8/src/tcs/tcs_caps.c
--- trousers-0.3.8-orig/src/tcs/tcs_caps.c	2010-06-09 20:20:44.000000000 +0000
+++ trousers-0.3.8/src/tcs/tcs_caps.c	2012-02-14 20:35:05.922976165 +0000
@@ -149,6 +149,7 @@
 {
 	TSS_RESULT result;
 	UINT32 subCap, rv = 0;
+	UINT32 manuf;
 
 	if ((result = get_current_version(&p->version)))
 		goto err;
@@ -181,8 +182,9 @@
 
 	UINT32ToArray(TPM_CAP_PROP_MANUFACTURER, (BYTE *)&subCap);
 	if ((result = get_cap_uint32(TCPA_CAP_PROPERTY, (BYTE *)&subCap, sizeof(UINT32),
-					(UINT32 *)&p->manufacturer)))
+					(UINT32 *)&manuf)))
 		goto err;
+	(void) memcpy(p->manufacturer, &manuf, sizeof (UINT32));
 
 	result = get_max_auths(&(p->num_auths));
 
diff -ru trousers-0.3.8-orig/src/tcsd/Makefile.in trousers-0.3.8/src/tcsd/Makefile.in
--- trousers-0.3.8-orig/src/tcsd/Makefile.in	2011-12-24 06:19:33.000000000 +0000
+++ trousers-0.3.8/src/tcsd/Makefile.in	2012-02-14 20:35:05.923402940 +0000
@@ -92,6 +92,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -101,8 +102,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -117,6 +116,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -133,9 +133,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -148,6 +145,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -180,7 +178,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/src/tcsd/svrside.c trousers-0.3.8/src/tcsd/svrside.c
--- trousers-0.3.8-orig/src/tcsd/svrside.c	2011-07-05 13:19:41.000000000 +0000
+++ trousers-0.3.8/src/tcsd/svrside.c	2012-02-14 20:35:05.923851550 +0000
@@ -27,6 +27,14 @@
 #include <arpa/inet.h>
 #include <errno.h>
 #include <getopt.h>
+#ifdef SOLARIS
+#include <priv.h>
+#include <fcntl.h>
+#endif
+#ifndef HAVE_DAEMON
+#include <fcntl.h>
+#endif
+
 #include "trousers/tss.h"
 #include "trousers_types.h"
 #include "tcs_tsp.h"
@@ -46,6 +54,11 @@
 int sd;
 char *tcsd_config_file = NULL;
 
+#ifdef SOLARIS
+static int
+get_event_log_from_kernel();
+#endif
+
 static void
 tcsd_shutdown(void)
 {
@@ -173,6 +186,10 @@
 		(void)req_mgr_final();
 		return result;
 	}
+#ifdef SOLARIS
+	/* Not fatal if this fails */
+	(void) get_event_log_from_kernel();
+#endif
 
 	result = owner_evict_init();
 	if (result != TSS_SUCCESS) {
@@ -212,6 +229,147 @@
 }
 
 
+#ifdef SOLARIS
+
+extern int get_device_fd();
+
+#define TPM_IOCTL_GETEVTABLE    1
+struct tpm_evtable_ioblk {
+	uint32_t	buflen;
+	caddr_t		buf;
+};
+
+static int
+store_eventlog(char *filename, struct tpm_evtable_ioblk *evlog)
+{
+	int fd;
+	int bytes = 0;
+
+	fd = open(filename, O_WRONLY | O_TRUNC | O_CREAT, 0600);
+	if (fd == -1) {
+		LogError("Error opening logfile %s: %s", filename,
+		    strerror(errno));
+		return (-1);
+	}
+	while ((uint32_t)bytes < evlog->buflen) {
+		int n;
+		n = write(fd, evlog->buf, evlog->buflen - bytes);
+		if (n == -1 && errno != EAGAIN) {
+			LogError("Error writing logfile %s: %s",
+			    filename, strerror(errno));
+			close(fd);
+			return (-1);
+		}
+		if (n != -1)
+			bytes += n;
+	}
+	close(fd);
+
+	return (0);
+}
+
+static int
+get_event_log_from_kernel()
+{
+	int fd = get_device_fd();
+	struct tpm_evtable_ioblk ioblk;
+
+	if (fd == -1)
+		return (-1);
+
+	(void) memset(&ioblk, 0, sizeof (ioblk));
+	if (ioctl(fd, TPM_IOCTL_GETEVTABLE, &ioblk)) {
+		LogDebug("Cannot get event log from kernel: %s",
+		    strerror(errno));
+		return (-1);
+	}
+	if (ioblk.buflen == 0)
+		return (0);
+
+	ioblk.buf = calloc(1, ioblk.buflen);
+	if (ioblk.buf == NULL) {
+		return (-1);
+	}
+	if (ioctl(fd, TPM_IOCTL_GETEVTABLE, &ioblk)) {
+		free(ioblk.buf);
+		LogDebug("Cannot get event log from kernel: %s",
+		    strerror(errno));
+		return (-1);
+	}
+
+	return (store_eventlog(tcsd_options.firmware_log_file, &ioblk));
+}
+/*
+ * For Solaris, make the tcsd privilege aware and drop
+ * risky privileges if they are not needed.
+ */
+static int
+drop_privs()
+{
+	priv_set_t *myprivs;
+	int rv;
+
+	/*
+	 * Drop unneeded privs such as fork/exec.
+	 *
+	 * Get "basic" privs and remove the ones we don't want.
+	 */
+	if ((myprivs = priv_str_to_set("basic", ",", NULL)) == NULL) {
+		LogError("priv_str_to_set failed: %s", strerror(errno));
+		return (1);
+	} else {
+		(void) priv_delset(myprivs, PRIV_PROC_EXEC);
+		(void) priv_delset(myprivs, PRIV_PROC_FORK);
+		(void) priv_delset(myprivs, PRIV_FILE_LINK_ANY);
+		(void) priv_delset(myprivs, PRIV_PROC_INFO);
+		(void) priv_delset(myprivs, PRIV_PROC_SESSION);
+		(void) priv_delset(myprivs, PRIV_PROC_SETID);
+
+		/* for auditing */
+		(void) priv_addset(myprivs, PRIV_PROC_AUDIT);
+
+		if ((rv = setppriv(PRIV_SET, PRIV_PERMITTED, myprivs)))
+			return (rv);
+		if ((rv = setppriv(PRIV_SET, PRIV_LIMIT, myprivs)))
+			return (rv);
+		if ((rv = setppriv(PRIV_SET, PRIV_INHERITABLE, myprivs)))
+			return (rv);
+
+		(void) priv_freeset(myprivs);
+	}
+	return (0);
+}
+#endif /* SOLARIS */
+
+#ifndef HAVE_DAEMON
+static int
+daemon(int nochdir, int noclose) {
+	int rv, fd;
+
+	switch (fork()) {
+		case -1:
+			return (-1);
+		case 0:
+			break;
+		default:
+		exit (0);
+	}
+
+	if (setsid() == -1)
+		return (-1);
+	if (!nochdir)
+		(void) chdir("/");
+	if (!noclose && (fd = open("/dev/null", O_RDWR, 0)) != -1) {
+		(void) dup2(fd, STDIN_FILENO);
+		(void) dup2(fd, STDOUT_FILENO);
+		(void) dup2(fd, STDERR_FILENO);
+		if (fd > 2)
+			(void)close (fd);
+	}
+	return (0);
+}
+#endif /* !HAVE_DAEMON */
+
 int
 main(int argc, char **argv)
 {
@@ -220,7 +378,6 @@
 	int newsd, c, option_index = 0;
 	unsigned client_len;
 	char *hostname = NULL;
-	struct passwd *pwd;
 	struct hostent *client_hostent = NULL;
 	struct option long_options[] = {
 		{"help", 0, NULL, 'h'},
@@ -228,6 +385,9 @@
 		{"config", 1, NULL, 'c'},
 		{0, 0, 0, 0}
 	};
+#ifdef SOLARIS
+	int rv;
+#endif
 
 	unsetenv("TCSD_USE_TCP_DEVICE");
 	while ((c = getopt_long(argc, argv, "fhec:", long_options, &option_index)) != -1) {
@@ -305,6 +465,11 @@
 			return -1;
 		}
 	}
+#ifdef SOLARIS
+	/* For Solaris, drop privileges for security. */
+	if ((rv = drop_privs()))
+		return (rv);
+#endif /* SOLARIS */
 
 	LogInfo("%s: TCSD up and running.", PACKAGE_STRING);
 	do {
diff -ru trousers-0.3.8-orig/src/tcsd/tcsd_threads.c trousers-0.3.8/src/tcsd/tcsd_threads.c
--- trousers-0.3.8-orig/src/tcsd/tcsd_threads.c	2010-09-10 19:50:27.000000000 +0000
+++ trousers-0.3.8/src/tcsd/tcsd_threads.c	2012-02-14 20:35:05.924064765 +0000
@@ -185,13 +185,13 @@
 
 	if ((rc = sigfillset(&thread_sigmask))) {
 		LogError("sigfillset failed: error=%d: %s", rc, strerror(rc));
-		LogError("worker thread %ld is exiting prematurely", THREAD_ID);
+		LogError("worker thread %ld is exiting prematurely", (long int)THREAD_ID);
 		THREAD_EXIT(NULL);
 	}
 
 	if ((rc = THREAD_SET_SIGNAL_MASK(SIG_BLOCK, &thread_sigmask, NULL))) {
 		LogError("Setting thread sigmask failed: error=%d: %s", rc, strerror(rc));
-		LogError("worker thread %ld is exiting prematurely", THREAD_ID);
+		LogError("worker thread %ld is exiting prematurely", (long int)THREAD_ID);
 		THREAD_EXIT(NULL);
 	}
 }
diff -ru trousers-0.3.8-orig/src/tddl/Makefile.in trousers-0.3.8/src/tddl/Makefile.in
--- trousers-0.3.8-orig/src/tddl/Makefile.in	2011-12-24 06:19:33.000000000 +0000
+++ trousers-0.3.8/src/tddl/Makefile.in	2012-02-14 20:35:05.924456235 +0000
@@ -107,6 +107,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -116,8 +117,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -132,6 +131,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -148,9 +148,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -163,6 +160,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -195,7 +193,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/src/tddl/tddl.c trousers-0.3.8/src/tddl/tddl.c
--- trousers-0.3.8-orig/src/tddl/tddl.c	2010-09-10 19:50:27.000000000 +0000
+++ trousers-0.3.8/src/tddl/tddl.c	2012-02-14 20:35:05.924814862 +0000
@@ -18,13 +18,17 @@
 
 #include "trousers/tss.h"
 #include "trousers_types.h"
+#ifndef SOLARIS
 #include "linux/tpm.h"
+#endif
 #include "tcslog.h"
 #include "tddl.h"
 
 struct tpm_device_node tpm_device_nodes[] = {
+#ifndef SOLARIS
 	{"/dev/tpm0", TDDL_UNDEF, TDDL_UNDEF},
 	{"/udev/tpm0", TDDL_UNDEF, TDDL_UNDEF},
+#endif
 	{"/dev/tpm", TDDL_UNDEF, TDDL_UNDEF},
 	{NULL, 0, 0}
 };
@@ -42,6 +46,13 @@
 #include <netdb.h>
 #include <fcntl.h>
 
+#ifdef SOLARIS
+int
+get_device_fd()
+{
+	return (opened_device->fd);
+}
+#endif
 
 int
 open_device()
@@ -63,7 +74,7 @@
 	 
 		
 		fd = socket(AF_INET, SOCK_STREAM, 0);
-		if (fd > 0) {
+		if (fd >= 0) {
 			struct hostent *host = gethostbyname(tcp_device_hostname);
 			if (host != NULL) {   
 				struct sockaddr_in addr;
@@ -105,12 +116,16 @@
 		/* tpm_device_paths is filled out in tddl.h */
 		for (i = 0; tpm_device_nodes[i].path != NULL; i++) {
 			errno = 0;
-			if ((fd = open(tpm_device_nodes[i].path, O_RDWR)) >= 0)
+			if ((fd = open(tpm_device_nodes[i].path, O_RDWR)) >= 0) {
 				break;
+			} else {
+				fprintf(stderr, "Error opening %s: %s\n",
+				    tpm_device_nodes[i].path, strerror(errno));
+			}
 		}
 	}
-	
-	if (fd > 0) {
+
+	if (fd >= 0) {
 		opened_device = &(tpm_device_nodes[i]);
 		tpm_device_nodes[i].fd = fd;
 	}
@@ -181,11 +196,13 @@
 			/* fall through */
 		case TDDL_TRANSMIT_IOCTL:
 			errno = 0;
+#ifndef SOLARIS
 			if ((sizeResult = ioctl(opened_device->fd, TPMIOC_TRANSMIT, txBuffer)) != -1) {
 				opened_device->transmit = TDDL_TRANSMIT_IOCTL;
 				break;
 			}
 			LogWarn("ioctl: (%d) %s", errno, strerror(errno));
+#endif
 			LogInfo("Falling back to Read/Write device support.");
 			/* fall through */
 		case TDDL_TRANSMIT_RW:
@@ -255,6 +272,7 @@
 
 TSS_RESULT Tddli_Cancel(void)
 {
+#ifndef SOLARIS
 	int rc;
 
 	if (opened_device->transmit == TDDL_TRANSMIT_IOCTL) {
@@ -270,4 +288,7 @@
 	} else {
 		return TDDLERR(TSS_E_NOTIMPL);
 	}
+#else
+	return TDDLERR(TSS_E_NOTIMPL);
+#endif /* SOLARIS */
 }
diff -ru trousers-0.3.8-orig/src/trspi/crypto/openssl/hash.c trousers-0.3.8/src/trspi/crypto/openssl/hash.c
--- trousers-0.3.8-orig/src/trspi/crypto/openssl/hash.c	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/trspi/crypto/openssl/hash.c	2012-02-14 20:35:05.925090127 +0000
@@ -56,45 +56,21 @@
 TSS_RESULT
 Trspi_Hash(UINT32 HashType, UINT32 BufSize, BYTE* Buf, BYTE* Digest)
 {
-	EVP_MD_CTX md_ctx;
-	unsigned int result_size;
-	int rv;
+	Trspi_HashCtx ctx;
+	TSS_RESULT rv;
 
-	switch (HashType) {
-		case TSS_HASH_SHA1:
-			rv = EVP_DigestInit(&md_ctx, EVP_sha1());
-			break;
-		default:
-			rv = TSPERR(TSS_E_BAD_PARAMETER);
-			goto out;
-			break;
-	}
+	rv = Trspi_HashInit(&ctx, HashType);
+	if (rv != TSS_SUCCESS)
+		return rv;
 
-	if (rv != EVP_SUCCESS) {
-		rv = TSPERR(TSS_E_INTERNAL_ERROR);
-		goto err;
-	}
-
-	rv = EVP_DigestUpdate(&md_ctx, Buf, BufSize);
-	if (rv != EVP_SUCCESS) {
-		rv = TSPERR(TSS_E_INTERNAL_ERROR);
-		goto err;
+	rv = Trspi_HashUpdate(&ctx, BufSize, Buf);
+	if (rv != TSS_SUCCESS) {
+		EVP_MD_CTX_destroy(ctx.ctx);
+		return rv;
 	}
+	rv = Trspi_HashFinal(&ctx, Digest);
 
-	result_size = EVP_MD_CTX_size(&md_ctx);
-	rv = EVP_DigestFinal(&md_ctx, Digest, &result_size);
-	if (rv != EVP_SUCCESS) {
-		rv = TSPERR(TSS_E_INTERNAL_ERROR);
-		goto err;
-	} else
-		rv = TSS_SUCCESS;
-
-	goto out;
-
-err:
-	DEBUG_print_openssl_errors();
-out:
-        return rv;
+	return (rv);
 }
 
 TSS_RESULT
@@ -112,7 +88,8 @@
 			break;
 	}
 
-	if ((ctx->ctx = malloc(sizeof(EVP_MD_CTX))) == NULL)
+	ctx->ctx = EVP_MD_CTX_create();
+	if (ctx->ctx == NULL)
 		return TSPERR(TSS_E_OUTOFMEMORY);
 
 	rv = EVP_DigestInit((EVP_MD_CTX *)ctx->ctx, (const EVP_MD *)md);
@@ -142,7 +119,7 @@
 	rv = EVP_DigestUpdate(ctx->ctx, data, size);
 	if (rv != EVP_SUCCESS) {
 		DEBUG_print_openssl_errors();
-		free(ctx->ctx);
+		EVP_MD_CTX_destroy(ctx->ctx);
 		ctx->ctx = NULL;
 		return TSPERR(TSS_E_INTERNAL_ERROR);
 	}
@@ -164,7 +141,7 @@
 	if (rv != EVP_SUCCESS)
 		return TSPERR(TSS_E_INTERNAL_ERROR);
 
-	free(ctx->ctx);
+	EVP_MD_CTX_destroy(ctx->ctx);
 	ctx->ctx = NULL;
 
 	return TSS_SUCCESS;
diff -ru trousers-0.3.8-orig/src/trspi/Makefile.in trousers-0.3.8/src/trspi/Makefile.in
--- trousers-0.3.8-orig/src/trspi/Makefile.in	2011-12-24 06:19:33.000000000 +0000
+++ trousers-0.3.8/src/trspi/Makefile.in	2012-02-14 20:35:05.925457025 +0000
@@ -95,6 +95,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -104,8 +105,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -120,6 +119,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -136,9 +136,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -151,6 +148,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -183,7 +181,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
diff -ru trousers-0.3.8-orig/src/tspi/Makefile.am trousers-0.3.8/src/tspi/Makefile.am
--- trousers-0.3.8-orig/src/tspi/Makefile.am	2011-12-24 06:16:22.000000000 +0000
+++ trousers-0.3.8/src/tspi/Makefile.am	2012-02-14 20:35:05.925666130 +0000
@@ -17,7 +17,7 @@
 # 5. If any interfaces have been added since the last public release, then increment age.
 # 6. If any interfaces have been removed since the last public release, then set age to 0.
 
-libtspi_la_LDFLAGS=-version-info 3:0:2 -lpthread @CRYPTOLIB@
+libtspi_la_LDFLAGS=$(LDARCHFLAG) -version-info 3:0:2 -lpthread @CRYPTOLIB@
 
 libtspi_la_CFLAGS=-I$(top_srcdir)/src/include -DAPPID=\"TSPI\" -DVAR_PREFIX=\"@localstatedir@\" -DETC_PREFIX=\"@sysconfdir@\"
 
@@ -217,7 +217,6 @@
 libtspi_la_SOURCES+=gtk/main.c gtk/support.c gtk/interface.c gtk/callbacks.c
 endif
 if OPENSSL_UI
-libtspi_la_LDFLAGS+=-lssl
 libtspi_la_SOURCES+=ssl_ui.c
 endif
 
diff -ru trousers-0.3.8-orig/src/tspi/Makefile.in trousers-0.3.8/src/tspi/Makefile.in
--- trousers-0.3.8-orig/src/tspi/Makefile.in	2011-12-24 06:19:33.000000000 +0000
+++ trousers-0.3.8/src/tspi/Makefile.in	2012-02-14 20:35:05.926795660 +0000
@@ -130,14 +130,13 @@
 @HAVE_GTK_TRUE@am__append_82 = @GTK_CFLAGS@
 @HAVE_GTK_TRUE@am__append_83 = @GTK_LIBS@
 @HAVE_GTK_TRUE@am__append_84 = gtk/main.c gtk/support.c gtk/interface.c gtk/callbacks.c
-@OPENSSL_UI_TRUE@am__append_85 = -lssl
-@OPENSSL_UI_TRUE@am__append_86 = ssl_ui.c
-@TSS_BUILD_NV_TRUE@am__append_87 = tspi_nv.c obj_nv.c tsp_nv.c rpc/@RPC@/rpc_nv.c
-@TSS_BUILD_NV_TRUE@am__append_88 = -DTSS_BUILD_NV
-@TSS_BUILD_DELEGATION_TRUE@am__append_89 = tspi_delegate.c tsp_delegate.c obj_delfamily.c rpc/@RPC@/rpc_delegate.c
-@TSS_BUILD_DELEGATION_TRUE@am__append_90 = -DTSS_BUILD_DELEGATION
-@TSS_BUILD_CMK_TRUE@am__append_91 = tspi_cmk.c obj_migdata.c rpc/@RPC@/rpc_cmk.c
-@TSS_BUILD_CMK_TRUE@am__append_92 = -DTSS_BUILD_CMK
+@OPENSSL_UI_TRUE@am__append_85 = ssl_ui.c
+@TSS_BUILD_NV_TRUE@am__append_86 = tspi_nv.c obj_nv.c tsp_nv.c rpc/@RPC@/rpc_nv.c
+@TSS_BUILD_NV_TRUE@am__append_87 = -DTSS_BUILD_NV
+@TSS_BUILD_DELEGATION_TRUE@am__append_88 = tspi_delegate.c tsp_delegate.c obj_delfamily.c rpc/@RPC@/rpc_delegate.c
+@TSS_BUILD_DELEGATION_TRUE@am__append_89 = -DTSS_BUILD_DELEGATION
+@TSS_BUILD_CMK_TRUE@am__append_90 = tspi_cmk.c obj_migdata.c rpc/@RPC@/rpc_cmk.c
+@TSS_BUILD_CMK_TRUE@am__append_91 = -DTSS_BUILD_CMK
 subdir = src/tspi
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -412,6 +411,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -421,8 +421,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -437,6 +435,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -453,9 +452,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -468,6 +464,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -500,7 +497,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
@@ -537,8 +533,8 @@
 #    current, and set revision to 0.
 # 5. If any interfaces have been added since the last public release, then increment age.
 # 6. If any interfaces have been removed since the last public release, then set age to 0.
-libtspi_la_LDFLAGS = -version-info 3:0:2 -lpthread @CRYPTOLIB@ \
-	$(am__append_83) $(am__append_85)
+libtspi_la_LDFLAGS = $(LDARCHFLAG) -version-info 3:0:2 -lpthread \
+	@CRYPTOLIB@ $(am__append_83)
 libtspi_la_CFLAGS = -I$(top_srcdir)/src/include -DAPPID=\"TSPI\" \
 	-DVAR_PREFIX=\"@localstatedir@\" -DETC_PREFIX=\"@sysconfdir@\" \
 	$(am__append_3) $(am__append_5) $(am__append_7) \
@@ -554,8 +550,8 @@
 	$(am__append_64) $(am__append_67) $(am__append_69) \
 	$(am__append_71) $(am__append_73) $(am__append_75) \
 	$(am__append_77) $(am__append_79) $(am__append_81) \
-	$(am__append_82) $(am__append_88) $(am__append_90) \
-	$(am__append_92)
+	$(am__append_82) $(am__append_87) $(am__append_89) \
+	$(am__append_91)
 libtspi_la_SOURCES = log.c spi_utils.c obj.c obj_policy.c tsp_policy.c \
 	obj_tpm.c obj_context.c tsp_context_mem.c tspi_context.c \
 	rpc/@RPC@/rpc_context.c rpc/tcs_api.c rpc/hosttable.c \
@@ -573,8 +569,8 @@
 	$(am__append_63) $(am__append_65) $(am__append_66) \
 	$(am__append_68) $(am__append_70) $(am__append_72) \
 	$(am__append_74) $(am__append_76) $(am__append_78) \
-	$(am__append_80) $(am__append_84) $(am__append_86) \
-	$(am__append_87) $(am__append_89) $(am__append_91)
+	$(am__append_80) $(am__append_84) $(am__append_85) \
+	$(am__append_86) $(am__append_88) $(am__append_90)
 all: all-am
 
 .SUFFIXES:
diff -ru trousers-0.3.8-orig/src/tspi/obj_delfamily.c trousers-0.3.8/src/tspi/obj_delfamily.c
--- trousers-0.3.8-orig/src/tspi/obj_delfamily.c	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/tspi/obj_delfamily.c	2012-02-14 20:35:05.927021390 +0000
@@ -110,6 +110,7 @@
 			break;
 		}
 	}
+	(void)prev;
 
 	pthread_mutex_unlock(&list->lock);
 }
diff -ru trousers-0.3.8-orig/src/tspi/obj_encdata.c trousers-0.3.8/src/tspi/obj_encdata.c
--- trousers-0.3.8-orig/src/tspi/obj_encdata.c	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/tspi/obj_encdata.c	2012-02-14 20:35:05.927224405 +0000
@@ -441,6 +441,7 @@
 		if (encdata->usagePolicy == hPolicy)
 			encdata->usagePolicy = NULL_HPOLICY;
 	}
+	(void)prev;
 
 	pthread_mutex_unlock(&list->lock);
 }
diff -ru trousers-0.3.8-orig/src/tspi/obj_nv.c trousers-0.3.8/src/tspi/obj_nv.c
--- trousers-0.3.8-orig/src/tspi/obj_nv.c	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/tspi/obj_nv.c	2012-02-14 20:35:05.927477101 +0000
@@ -469,6 +469,7 @@
 	pcrwrite_sizeOfSelect = Decode_UINT16(nv_data_public + offset);
 	offset = offset + sizeof(UINT16) + pcrread_sizeOfSelect + sizeof(TPM_LOCALITY_SELECTION);
 	memcpy(*data, nv_data_public + offset, sizeof(TPM_COMPOSITE_HASH));
+	(void)pcrwrite_sizeOfSelect;
 
 	return result;
 }
diff -ru trousers-0.3.8-orig/src/tspi/obj_rsakey.c trousers-0.3.8/src/tspi/obj_rsakey.c
--- trousers-0.3.8-orig/src/tspi/obj_rsakey.c	2011-12-06 16:54:46.000000000 +0000
+++ trousers-0.3.8/src/tspi/obj_rsakey.c	2012-02-14 20:35:05.927957122 +0000
@@ -1739,6 +1739,7 @@
 			return result;
 		}
 	}
+	(void)prev;
 
 	MUTEX_UNLOCK(list->lock);
 
@@ -1913,6 +1914,7 @@
 		if (rsakey->migPolicy == hPolicy)
 			rsakey->migPolicy = NULL_HPOLICY;
 	}
+	(void)prev;
 
 	MUTEX_UNLOCK(list->lock);
 }
diff -ru trousers-0.3.8-orig/src/tspi/obj_tpm.c trousers-0.3.8/src/tspi/obj_tpm.c
--- trousers-0.3.8-orig/src/tspi/obj_tpm.c	2010-01-28 16:27:51.000000000 +0000
+++ trousers-0.3.8/src/tspi/obj_tpm.c	2012-02-14 20:35:05.928171160 +0000
@@ -477,6 +477,7 @@
 			tpm->operatorPolicy = NULL_HPOLICY;
 #endif
 	}
+	(void)prev;
 
 	pthread_mutex_unlock(&list->lock);
 }
diff -ru trousers-0.3.8-orig/src/tspi/ps/tspps.c trousers-0.3.8/src/tspi/ps/tspps.c
--- trousers-0.3.8-orig/src/tspi/ps/tspps.c	2011-06-28 18:54:32.000000000 +0000
+++ trousers-0.3.8/src/tspi/ps/tspps.c	2012-02-14 20:35:05.928606383 +0000
@@ -22,6 +22,9 @@
 #include <fcntl.h>
 #include <limits.h>
 #include <netdb.h>
+#if defined (SOLARIS)
+#include <libgen.h>
+#endif
 #if defined (HAVE_BYTEORDER_H)
 #include <sys/byteorder.h>
 #elif defined(HTOLE_DEFINED)
@@ -60,9 +63,12 @@
 	TSS_RESULT result;
 	char *file_name = NULL, *home_dir = NULL;
 	struct passwd *pwp;
-#if (defined (__linux) || defined (linux) || defined(__GLIBC__))
+#if (defined (__linux) || defined (linux) || defined(__GLIBC__) || defined(SOLARIS))
 	struct passwd pw;
 #endif
+#ifdef SOLARIS
+	char pwbuf[PASSWD_BUFSIZE];
+#endif
 	struct stat stat_buf;
 	char buf[PASSWD_BUFSIZE];
 	uid_t euid;
@@ -84,9 +90,16 @@
          * in the user's home directory, which may be shared
          * by multiple systems.
          *
-         * The directory path on Solaris is /var/tpm/userps/[EUID]/
+         * The directory path on Solaris is /var/user[USERNAME]/tpm/userps
          */
-        rc = snprintf(buf, sizeof (buf), "%s/%d", TSS_USER_PS_DIR, euid);
+
+	pwp = getpwuid_r(euid, &pw, pwbuf, sizeof (pwbuf));
+	if (pwp != NULL) {
+		rc = snprintf(buf, sizeof (buf), "/var/user/%s/tpm/userps",
+		    pwp->pw_name);
+	} else {
+		return TSPERR(TSS_E_INTERNAL_ERROR);
+	}
 #else
 	setpwent();
 	while (1) {
@@ -132,7 +145,7 @@
 		if (errno == ENOENT) {
 			errno = 0;
 			/* Create the user's ps directory if it is not there. */
-			if ((rc = mkdir(buf, 0700)) == -1) {
+			if ((rc = mkdirp(buf, 0700)) == -1) {
 				LogDebugFn("USER PS: Error creating dir: %s: %s", buf,
 					   strerror(errno));
 				result = TSPERR(TSS_E_INTERNAL_ERROR);
@@ -147,8 +160,8 @@
 
 	/* Directory exists or has been created, return the path to the file */
 #if defined (SOLARIS)
-	rc = snprintf(buf, sizeof (buf), "%s/%d/%s", TSS_USER_PS_DIR, euid,
-		      TSS_USER_PS_FILE);
+	rc = snprintf(buf, sizeof (buf), "/var/user/%s/tpm/userps/%s",
+	    pwp->pw_name, TSS_USER_PS_FILE);
 #else
 	rc = snprintf(buf, sizeof (buf), "%s/%s/%s", home_dir, TSS_USER_PS_DIR,
 		      TSS_USER_PS_FILE);
diff -ru trousers-0.3.8-orig/src/tspi/rpc/hosttable.c trousers-0.3.8/src/tspi/rpc/hosttable.c
--- trousers-0.3.8-orig/src/tspi/rpc/hosttable.c	2010-11-17 15:51:57.000000000 +0000
+++ trousers-0.3.8/src/tspi/rpc/hosttable.c	2012-02-14 20:35:05.928829161 +0000
@@ -21,7 +21,7 @@
 
 struct host_table *ht = NULL;
 
-TSS_RESULT
+static TSS_RESULT
 host_table_init()
 {
 	ht = calloc(1, sizeof(struct host_table));
@@ -36,8 +36,7 @@
 }
 
 #ifdef SOLARIS
-#pragma init(_init)
-void _init(void)
+static void my_init(void)
 #else
 void __attribute__ ((constructor)) my_init(void)
 #endif
@@ -46,7 +45,7 @@
 	__tspi_obj_list_init();
 }
 
-void
+static void
 host_table_final()
 {
 	struct host_table_entry *hte, *next = NULL;
@@ -70,8 +69,7 @@
 }
 
 #ifdef SOLARIS
-#pragma fini(_fini)
-void _fini(void)
+static void my_fini(void)
 #else
 void __attribute__ ((destructor)) my_fini(void)
 #endif
@@ -79,6 +77,11 @@
 	host_table_final();
 }
 
+#ifdef SOLARIS
+#pragma init(my_init)
+#pragma fini(my_fini)
+#endif
+
 TSS_RESULT
 __tspi_add_table_entry(TSS_HCONTEXT tspContext, BYTE *host, int type, struct host_table_entry **ret)
 {
diff -ru trousers-0.3.8-orig/src/tspi/tspi_context.c trousers-0.3.8/src/tspi/tspi_context.c
--- trousers-0.3.8-orig/src/tspi/tspi_context.c	2011-02-21 16:24:44.000000000 +0000
+++ trousers-0.3.8/src/tspi/tspi_context.c	2012-02-14 20:35:05.929032643 +0000
@@ -27,6 +27,8 @@
 #include "tcsd.h"
 #include "obj.h"
 
+extern TSS_RESULT
+__tspi_freeTable(TSS_HCONTEXT tspContext);
 
 TSS_RESULT
 Tspi_Context_Create(TSS_HCONTEXT * phContext)	/* out */
@@ -57,6 +59,8 @@
 
 	Tspi_Context_FreeMemory(tspContext, NULL);
 
+	__tspi_freeTable(tspContext);
+
 	/* close the ps file */
 	PS_close();
 
diff -ru trousers-0.3.8-orig/tools/Makefile.in trousers-0.3.8/tools/Makefile.in
--- trousers-0.3.8-orig/tools/Makefile.in	2011-12-24 06:19:33.000000000 +0000
+++ trousers-0.3.8/tools/Makefile.in	2012-02-14 20:35:05.929351217 +0000
@@ -93,6 +93,7 @@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
+DLLTOOL = @DLLTOOL@
 DSYMUTIL = @DSYMUTIL@
 DUMPBIN = @DUMPBIN@
 ECHO_C = @ECHO_C@
@@ -102,8 +103,6 @@
 EXEEXT = @EXEEXT@
 FGREP = @FGREP@
 GREP = @GREP@
-GTK_CFLAGS = @GTK_CFLAGS@
-GTK_LIBS = @GTK_LIBS@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -118,6 +117,7 @@
 LN_S = @LN_S@
 LTLIBOBJS = @LTLIBOBJS@
 MAKEINFO = @MAKEINFO@
+MANIFEST_TOOL = @MANIFEST_TOOL@
 MKDIR_P = @MKDIR_P@
 NM = @NM@
 NMEDIT = @NMEDIT@
@@ -134,9 +134,6 @@
 PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
-PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 RANLIB = @RANLIB@
 RPC = @RPC@
 SED = @SED@
@@ -149,6 +146,7 @@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
+ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
@@ -181,7 +179,6 @@
 libexecdir = @libexecdir@
 localedir = @localedir@
 localstatedir = @localstatedir@
-lt_ECHO = @lt_ECHO@
 mandir = @mandir@
 mkdir_p = @mkdir_p@
 oldincludedir = @oldincludedir@
